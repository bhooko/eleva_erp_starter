{% extends "base.html" %}
{% block title %}Sales · Opportunity · {{ opportunity.title }}{% endblock %}
{% block content %}
<div class="mb-6 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
  <div>
    <p class="text-sm text-slate-400">Opportunity · {{ pipeline_config.label if pipeline_config else pipeline_key|capitalize }}</p>
    <h2 class="text-3xl font-semibold tracking-tight">{{ opportunity.title }}</h2>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-slate-400">
      {% if can_see_commercial %}
        <span class="inline-flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> {{ opportunity.display_amount }}</span>
      {% else %}
        <span class="inline-flex items-center gap-2 text-xs italic text-slate-300"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> Amount restricted</span>
      {% endif %}
      <span>Stage: {{ opportunity.stage }}</span>
      {% if opportunity.temperature %}
        {% set label, badge = opportunity.badge_variant %}
        <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ badge }}">{{ label or opportunity.temperature|capitalize }}</span>
      {% endif %}
      {% if open_design_tasks %}
        <span class="inline-flex items-center gap-2 rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-100 border border-amber-400/40">Waiting on Design</span>
      {% endif %}
    </div>
  </div>
  <div class="flex items-center gap-3">
    {% with default_pipeline_key=pipeline_key, opportunity_clients=clients, default_client_id=opportunity.client.id if opportunity.client else None %}
      {% include "sales/_opportunity_quick_create.html" %}
    {% endwith %}
    <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key=pipeline_key) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-800/80 bg-slate-900/70 text-sm text-slate-200 hover:bg-slate-800/80">Back to Pipeline</a>
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up">
  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1">
      <div class="text-xs uppercase tracking-wide text-slate-500">Opportunity Details</div>
      <dl class="mt-3 grid grid-cols-1 gap-x-10 gap-y-4 text-sm text-slate-300 sm:grid-cols-2">
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Stage</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.stage }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Amount</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if can_see_commercial %}
              {{ opportunity.display_amount }}
            {% else %}
              <span class="text-xs text-slate-500 italic">Restricted</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Probability</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.probability is not none %}
              {{ opportunity.probability }}%
            {% else %}
              —
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Expected Close</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.expected_close_date.strftime('%d %b %Y') if opportunity.expected_close_date else 'Not set' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Owner</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.owner.display_name if opportunity.owner else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Client</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.client %}
            <button
              type="button"
              class="inline-flex items-center gap-2 text-emerald-200 hover:underline focus:outline-none focus:ring-2 focus:ring-emerald-400/60 rounded"
              data-modal-open="clientDetailModal"
              data-client-id="{{ opportunity.client.id }}"
              data-client-name="{{ opportunity.client.display_name }}"
              data-client-email="{{ opportunity.client.email or '' }}"
              data-client-phone="{{ opportunity.client.phone or '' }}"
              data-client-description="{{ opportunity.client.description|default('', true)|e }}"
              data-client-modal-open
            >
              <span data-client-name>{{ opportunity.client.display_name }}</span>
              <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5H6.75A2.25 2.25 0 0 0 4.5 6.75v10.5A2.25 2.25 0 0 0 6.75 19.5h10.5a2.25 2.25 0 0 0 2.25-2.25V9.75L13.5 4.5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5v5.25H18.75"/></svg>
            </button>
            {% else %}
            <span data-client-name>Unassigned</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Related Project</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.related_project or '—' }}</dd>
        </div>
        {% set temperature_label, temperature_badge = opportunity.badge_variant %}
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Temperature</dt>
          <dd class="mt-1">
            {% if opportunity.temperature %}
              <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ temperature_badge }}">{{ temperature_label or opportunity.temperature|capitalize }}</span>
            {% else %}
              <span class="text-slate-400">Not set</span>
            {% endif %}
          </dd>
        </div>
      </dl>
    </div>
    <div class="flex items-start gap-2 md:flex-col">
      {% if opportunity.project_id %}
        <a href="{{ url_for('project_detail', project_id=opportunity.project_id) }}" class="inline-flex items-center gap-2 rounded-xl border border-blue-400/50 bg-blue-500/20 px-4 py-2 text-sm font-semibold text-blue-100 hover:bg-blue-500/30 btn-shimmer">View Project</a>
      {% else %}
        {% if opportunity.stage and opportunity.stage.lower() == 'closed won' and current_user.can_view_module('operations') %}
          <form action="{{ url_for('sales_opportunity_convert_to_project', opportunity_id=opportunity.id) }}" method="post" style="display: inline-block;">
            {{ csrf_field() }}
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/50 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Convert to Project</button>
          </form>
        {% endif %}
      {% endif %}
      <button type="button" data-modal-open="editOpportunityModal" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Edit Opportunity</button>
    </div>
  </div>
  <div class="mt-4 rounded-xl border border-slate-800/60 bg-slate-950/50 p-4">
    <p class="text-xs uppercase tracking-wide text-slate-500">Description</p>
    <p class="mt-2 whitespace-pre-line text-sm text-slate-300">{{ opportunity.description or 'No description added yet.' }}</p>
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 60ms;">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Design Tasks for this Opportunity</p>
      <p class="text-sm text-slate-300">Link design requests raised from this deal and track their progress.</p>
    </div>
    <button
      type="button"
      data-design-task-modal="salesDesignTaskModal"
      class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
    >
      + Create Sales Query Task
    </button>
  </div>
  <div class="mt-3 overflow-x-auto rounded-xl border border-slate-800/80 bg-slate-950/40">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-3 px-4">Task Type</th>
          <th class="py-3 px-4">Title</th>
          <th class="py-3 px-4">Assigned To</th>
          <th class="py-3 px-4">Status</th>
          <th class="py-3 px-4">Due Date</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800/70">
        {% for task in design_tasks %}
        <tr class="hover:bg-slate-900/60">
          <td class="py-3 px-4 font-semibold text-slate-200">{{ task.task_type.replace('_',' ').title() }}</td>
          <td class="py-3 px-4">
            <a href="{{ url_for('design_task_detail', task_id=task.id) }}" class="text-emerald-100 hover:text-emerald-200 font-semibold">{{ task.description or task.project_label }}</a>
            <div class="text-xs text-slate-500">ID #{{ task.id }}</div>
          </td>
          <td class="py-3 px-4">{{ task.assigned_to.display_name if task.assigned_to else 'Unassigned' }}</td>
          <td class="py-3 px-4">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs {{ 'bg-emerald-500/20 text-emerald-100 border border-emerald-400/40' if task.status == 'completed' else 'bg-amber-500/20 text-amber-100 border border-amber-400/40' if task.status in ['new','in_progress','waiting_info'] else 'bg-slate-800/70 text-slate-200 border border-slate-700' }}">{{ task.status.replace('_',' ').title() }}</span>
          </td>
          <td class="py-3 px-4">{{ task.due_date.strftime('%d %b %Y') if task.due_date else '—' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="py-4 px-4 text-center text-slate-500">No design tasks linked yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="mb-8 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-4 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 80ms;">
  <div class="text-xs uppercase tracking-wide text-slate-500 mb-3">Stage Progress</div>
  <div class="flex items-center gap-3 overflow-x-auto pb-1">
    {% for stage_option in stages %}
      {% set is_current = stage_option == opportunity.stage %}
      {% set is_complete = loop.index0 < current_stage_index %}
      {% set connector_state = 'is-complete' if loop.index0 < current_stage_index else ('is-progress' if loop.index0 == current_stage_index else '') %}
      <div class="flex items-center gap-3">
        <div class="flex flex-col items-center text-center">
          <div title="{{ stage_option }}" class="stage-node w-9 h-9 rounded-full flex items-center justify-center text-xs font-semibold {{ 'is-active' if is_current else '' }} {{ 'is-complete' if is_complete else '' }}">{{ loop.index }}</div>
          <span class="mt-2 text-xs stage-label {{ 'is-active' if is_current else '' }}">{{ stage_option }}</span>
        </div>
        {% if not loop.last %}
          <div class="stage-connector {{ connector_state }}"></div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="grid gap-6 xl:grid-cols-[1.2fr_1fr]">
  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 120ms;">
      <div class="px-6 pt-5">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <button type="button" data-tab="timeline" class="tab-trigger tab-active inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-emerald-100 transition">Timeline</button>
          <button type="button" data-tab="comments" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Comments</button>
          <button type="button" data-tab="files" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Files</button>
          <button type="button" data-tab="activities" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Activities</button>
          <button type="button" data-tab="items" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Items</button>
        </div>
      </div>
      <div class="px-6 py-6">
        <div data-tab-panel="timeline" class="motion-panel is-active">
          <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="mb-6 space-y-3">
            {{ csrf_field() }}
            <input type="hidden" name="form_action" value="add_note">
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-[1fr_auto]">
              <input type="text" name="note_title" placeholder="Add quick update" class="rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Add Note</button>
            </div>
            <textarea name="note_body" rows="3" placeholder="Meeting outcome, blockers or next steps." class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60"></textarea>
          </form>
          {% if activities %}
          <ol class="relative ml-3 space-y-6 border-l border-slate-800/80">
            {% for activity in activities %}
            <li class="ml-6">
              <span class="absolute -left-3 flex h-6 w-6 items-center justify-center rounded-full border border-emerald-400/40 bg-emerald-500/20 text-xs font-semibold text-emerald-200">•</span>
              <div class="rounded-xl border border-slate-800/80 bg-slate-900/80 px-4 py-3">
                <div class="flex items-center justify-between text-sm">
                  <p class="font-semibold text-slate-100">{{ activity.title }}</p>
                  <span class="text-xs text-slate-500">{{ activity.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% if activity.notes %}
                <p class="mt-2 text-sm text-slate-300 whitespace-pre-line">{{ activity.notes }}</p>
                {% endif %}
                {% if activity.actor %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">{{ 'Admin · ' if activity.actor.is_admin else 'User · ' }}{{ activity.actor.display_name }}</p>
                {% else %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">System</p>
                {% endif %}
              </div>
            </li>
            {% endfor %}
          </ol>
          {% else %}
          <div class="py-16 text-center text-slate-500">No updates yet. Start logging interactions.</div>
          {% endif %}
        </div>

        <div data-tab-panel="comments" class="motion-panel hidden">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Capture internal comments about this deal to keep the team aligned.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="add_comment">
              <textarea name="comment_body" rows="4" placeholder="Share an update with your team." class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required></textarea>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Comment</button>
              </div>
            </form>
            {% if comments %}
            <ul class="space-y-4">
              {% for comment in comments %}
              <li class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4">
                <p class="text-sm text-slate-200 whitespace-pre-line">{{ comment.body }}</p>
                <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
                  <span>{{ comment.author.display_name if comment.author else 'System' }}</span>
                  <span>{{ comment.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No comments added yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="files" class="motion-panel hidden">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Attach proposals, contracts or supporting documents for quick access.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" enctype="multipart/form-data" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="upload_file">
              <div class="rounded-xl border border-dashed border-slate-700 bg-slate-950/40 px-6 py-8 text-center">
                <input type="file" name="attachment" id="opportunityFileInput" class="hidden" required>
                <label for="opportunityFileInput" class="flex cursor-pointer flex-col items-center gap-3">
                  <svg class="h-10 w-10 text-slate-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13l3 3L22 6"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 10V3m0 0L8 7m4-4l4 4"/><path stroke-linecap="round" stroke-linejoin="round" d="M20 21H4a2 2 0 01-2-2V7a2 2 0 012-2h5"/></svg>
                  <p class="text-sm text-slate-400" data-file-label>Drag and drop files here or click to browse.</p>
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-800/80 px-3 py-1 text-xs text-slate-300">Choose a file</span>
                </label>
              </div>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Upload File</button>
              </div>
            </form>
            {% if files %}
            <ul class="divide-y divide-slate-800/80 rounded-xl border border-slate-800/80 bg-slate-950/40">
              {% for file in files %}
              <li class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
                <div>
                  <a href="{{ url_for('static', filename=file.stored_path) }}" class="font-medium text-slate-100 hover:text-emerald-100" download>{{ file.original_filename }}</a>
                  <div class="mt-1 text-xs text-slate-500">
                    Uploaded {{ file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}
                  </div>
                </div>
                <span class="text-xs text-slate-400">{{ file.display_size }}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No files uploaded yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="activities" class="motion-panel hidden">
          <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4">
            {{ csrf_field() }}
            <input type="hidden" name="form_action" value="schedule_activity">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Activity Type</label>
                <select name="activity_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  <option value="meeting">Meeting</option>
                  <option value="call">Call</option>
                  <option value="email">Email</option>
                </select>
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Subject</label>
                <input type="text" name="activity_subject" placeholder="Follow-up" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Date</label>
                <input type="date" name="activity_date" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Time</label>
                <input type="time" name="activity_time" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Reminder</label>
                <select name="reminder_option" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  {% for value, label in reminder_options %}
                  <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div>
              <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Notes</label>
              <textarea name="activity_notes" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add talking points or objectives."></textarea>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Schedule Activity</button>
            </div>
          </form>
          {% if scheduled_activities %}
          <div class="mt-6 space-y-4">
            {% for engagement in scheduled_activities %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4 card-hover-lift fade-in-up" style="--fade-delay: {{ 160 + loop.index0 * 40 }}ms;">
              <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
                <p class="font-semibold text-slate-100">{{ engagement.display_activity_type }}</p>
                <span class="text-xs text-slate-500">{{ engagement.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
              </div>
              {% if engagement.subject %}
              <p class="mt-2 text-sm text-emerald-100">{{ engagement.subject }}</p>
              {% endif %}
              <div class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-500 sm:grid-cols-2">
                <div>
                  <p class="uppercase tracking-wide text-xs text-slate-300">Scheduled</p>
                  <p class="text-sm text-slate-200">{{ engagement.display_schedule }}</p>
                </div>
                <div>
                  <p class="uppercase tracking-wide text-xs text-slate-300">Reminder</p>
                  <p class="text-sm text-slate-200">{{ engagement.display_reminder }}</p>
                </div>
              </div>
              {% if engagement.notes %}
              <p class="mt-3 text-sm text-slate-300 whitespace-pre-line">{{ engagement.notes }}</p>
              {% endif %}
              {% if engagement.created_by %}
              <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">Logged by {{ engagement.created_by.display_name }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="mt-6 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500 card-hover-lift fade-in-up" style="--fade-delay: 160ms;">No activities scheduled yet.</div>
          {% endif %}
        </div>

        <div data-tab-panel="items" class="motion-panel hidden">
          <div class="space-y-5">
            <p class="text-sm text-slate-300">Track solution components, services, or pricing packages tied to this opportunity.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-5 card-hover-lift fade-in-up" style="--fade-delay: 160ms;">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="add_item">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Details</label>
                <textarea name="item_details" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add specifications, scope, or notes."></textarea>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Lift Type</label>
                  <select name="item_lift_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                    <option value="">Select lift type</option>
                    {% for lift_type in lift_types %}
                    <option value="{{ lift_type }}">{{ lift_type }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Quantity</label>
                  <input type="number" name="item_quantity" min="0" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="1">
                </div>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Floors</label>
                  <input type="text" name="item_floors" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="G+5">
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Cabin Finish</label>
                  <input type="text" name="item_cabin_finish" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="SS / Designer">
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Door Type</label>
                  <input type="text" name="item_door_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Auto">
                </div>
              </div>
              <div class="sm:w-1/3">
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Structure</label>
                <select name="item_structure" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  <option value="no">No</option>
                  <option value="yes">Yes</option>
                </select>
              </div>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Add Item</button>
              </div>
            </form>
            {% if items %}
            <div class="space-y-4">
              {% for item in items %}
              <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4 card-hover-lift fade-in-up" style="--fade-delay: {{ 200 + loop.index0 * 40 }}ms;">
                <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
                  <p class="font-semibold text-slate-100">{{ item.lift_type or 'Lift Item' }}</p>
                  <span class="text-xs text-slate-500">{{ item.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% if item.details %}
                <p class="mt-2 text-sm text-slate-300 whitespace-pre-line">{{ item.details }}</p>
                {% endif %}
                <dl class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-500 sm:grid-cols-3">
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Lift Type</dt>
                    <dd class="text-sm text-slate-200">{{ item.lift_type or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Quantity</dt>
                    <dd class="text-sm text-slate-200">{{ item.quantity if item.quantity is not none else '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Floors</dt>
                    <dd class="text-sm text-slate-200">{{ item.floors or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Structure</dt>
                    <dd class="text-sm text-slate-200">{{ item.structure_label }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Cabin Finish</dt>
                    <dd class="text-sm text-slate-200">{{ item.cabin_finish or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-xs text-slate-300">Door Type</dt>
                    <dd class="text-sm text-slate-200">{{ item.door_type or '—' }}</dd>
                  </div>
                </dl>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500 card-hover-lift fade-in-up" style="--fade-delay: 200ms;">No items added yet.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 140ms;">
      <div class="flex items-start justify-between gap-3 px-6 py-4 border-b border-slate-800/80">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Linked Client Inputs &amp; Quotation</p>
          <p class="text-sm text-slate-300">Keep requirements and pricing visible while you work.</p>
        </div>
        <button type="button" class="rounded-full border border-slate-700 bg-slate-800/60 p-2 text-slate-300 hover:text-emerald-100" data-linked-toggle aria-label="Collapse linked documents">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
        </button>
      </div>
      <div class="space-y-5 px-6 py-5" data-linked-panel>
        {% if not client_requirement_forms and not quotation_files %}
        <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-5 text-center text-sm text-slate-400">
          <p class="font-medium text-slate-200">No client inputs or quotations linked yet.</p>
          <p class="mt-1 text-xs text-slate-500">Link the client form or upload your first quotation to keep everything in one place.</p>
          {% if can_manage_opportunity_docs %}
          <div class="mt-4 flex flex-wrap items-center justify-center gap-3">
            <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30" data-link-form-toggle>+ Link Client Requirements</button>
            <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-sky-400/40 bg-sky-500/20 px-3 py-2 text-sm font-semibold text-sky-100 hover:bg-sky-500/30" for="quotationUploadInput">+ Upload Quotation</label>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Client Requirements Form</p>
              <p class="text-sm text-slate-300">Linked to this opportunity and client.</p>
            </div>
            {% if can_manage_opportunity_docs %}
            <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30" data-link-form-toggle>+ Link Form</button>
            {% endif %}
          </div>
          {% if client_requirement_forms %}
          <div class="space-y-3">
            {% for form in client_requirement_forms %}
            <button type="button" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-left hover:border-emerald-400/40" data-crf-open data-crf-title="{{ form.template.name if form.template else 'Client Requirements Form' }}" data-crf-status="{{ form.status|replace('_',' ')|title }}" data-crf-version="V{{ form.version }}" data-crf-created="{{ form.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}" data-crf-author="{{ form.created_by_sales.display_name if form.created_by_sales else 'Unassigned' }}" data-crf-link="{{ url_for('sales_client_requirement_form_detail', form_id=form.id) }}">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="font-semibold text-slate-100">{{ form.template.name if form.template else 'Client Requirements Form' }}</p>
                  <p class="text-xs text-slate-500">Version {{ form.version }} · {{ form.status|replace('_',' ')|title }}</p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-800/70 px-3 py-1 text-xs text-slate-300">{{ form.created_at|format_india_datetime('%d %b %Y') }}</span>
              </div>
              <p class="mt-1 text-xs text-slate-400">Created by {{ form.created_by_sales.display_name if form.created_by_sales else 'System' }}</p>
            </button>
            {% endfor %}
          </div>
          {% else %}
          <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-400">No Client Requirements form linked yet.</div>
          {% endif %}

          {% if can_manage_opportunity_docs %}
          <div class="hidden rounded-xl border border-slate-800/80 bg-slate-950/60 p-4 space-y-4" data-link-form-panel>
            <div class="flex items-center justify-between gap-3">
              <p class="text-sm font-semibold text-slate-100">Link or create a Client Requirements form</p>
              <button type="button" class="text-xs text-slate-400 hover:text-emerald-100" data-link-form-toggle>Close</button>
            </div>
            <form method="post" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="link_client_requirement">
              <input type="hidden" name="link_mode" value="existing">
              <label class="block text-xs uppercase tracking-wide text-slate-400">Link existing form (same client)</label>
              <select name="existing_form_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                <option value="">Select a form</option>
                {% for form in available_client_forms %}
                <option value="{{ form.id }}">Form #{{ form.id }} · {{ form.template.name if form.template else 'Client Requirements' }} · Updated {{ form.updated_at|format_india_datetime('%d %b %Y') }}</option>
                {% endfor %}
              </select>
              {% if not available_client_forms %}
              <p class="text-xs text-slate-500">No other forms found for this client yet.</p>
              {% endif %}
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Link Selected</button>
              </div>
            </form>
            <form method="post" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="link_client_requirement">
              <input type="hidden" name="link_mode" value="new">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Or create new draft</p>
                  <p class="text-sm text-slate-300">Prefills client, opportunity and owner.</p>
                </div>
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100">Create Draft</button>
              </div>
            </form>
          </div>
          {% endif %}
        </div>

        <div class="space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Quotation Files</p>
              <p class="text-sm text-slate-300">Latest version appears first.</p>
            </div>
            {% if can_manage_opportunity_docs %}
            <form method="post" enctype="multipart/form-data" class="shrink-0">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="upload_quotation">
              <input type="file" name="quotation_file" id="quotationUploadInput" class="hidden" data-auto-submit-file>
              <label for="quotationUploadInput" class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-sky-400/40 bg-sky-500/20 px-3 py-2 text-xs font-semibold text-sky-100 hover:bg-sky-500/30">Upload New Version</label>
            </form>
            {% endif %}
          </div>
          {% if quotation_files %}
          <ul class="divide-y divide-slate-800/80 rounded-xl border border-slate-800/80 bg-slate-950/40">
            {% for file in quotation_files %}
            {% set ext = file.original_filename.split('.')[-1].lower() if '.' in file.original_filename else '' %}
            <li class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-800/70 text-slate-200">
                  {% if ext in ['pdf'] %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 4h8l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 12h4M12 16h2M8 12h.01"/></svg>
                  {% elif ext in ['xls','xlsx','csv'] %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7a2 2 0 0 1 2-2h8l4 4v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M9 17l6-6M9 11l6 6"/></svg>
                  {% else %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M14 3v4a1 1 0 0 0 1 1h4"/></svg>
                  {% endif %}
                </div>
                <div>
                  <p class="font-semibold text-slate-100">{{ file.original_filename }}</p>
                  <p class="text-xs text-slate-500">Uploaded {{ file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}</p>
                </div>
              </div>
              <div class="text-right text-sm text-slate-300">
                <div class="inline-flex items-center gap-2 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-100">V{{ file.computed_version or (quotation_files|length - loop.index0) }}</div>
                <a href="{{ url_for('static', filename=file.stored_path) }}" class="mt-2 inline-flex items-center gap-2 text-sky-200 hover:text-sky-100" target="_blank" rel="noopener">Preview / Download</a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-400">No quotation uploaded yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 160ms;">
      <div class="px-6 py-4 border-b border-slate-800/80">
        <h3 class="text-lg font-semibold">Snapshot</h3>
      </div>
      <dl class="grid grid-cols-1 gap-4 px-6 py-5 text-sm text-slate-300">
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Client</dt>
          <dd>
            {% if opportunity.client %}
            <button
              type="button"
              class="inline-flex items-center gap-2 text-emerald-200 hover:underline focus:outline-none focus:ring-2 focus:ring-emerald-400/60 rounded"
              data-modal-open="clientDetailModal"
              data-client-id="{{ opportunity.client.id }}"
              data-client-name="{{ opportunity.client.display_name }}"
              data-client-email="{{ opportunity.client.email or '' }}"
              data-client-phone="{{ opportunity.client.phone or '' }}"
              data-client-description="{{ opportunity.client.description|default('', true)|e }}"
              data-client-modal-open
            >
              <span data-client-name>{{ opportunity.client.display_name }}</span>
              <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5H6.75A2.25 2.25 0 0 0 4.5 6.75v10.5A2.25 2.25 0 0 0 6.75 19.5h10.5a2.25 2.25 0 0 0 2.25-2.25V9.75L13.5 4.5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5v5.25H18.75"/></svg>
            </button>
            {% else %}
            <span data-client-name>Unassigned</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Owner</dt>
          <dd>{{ opportunity.owner.display_name if opportunity.owner else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Expected Close</dt>
          <dd>{{ opportunity.expected_close_date.strftime('%d %b %Y') if opportunity.expected_close_date else 'Not set' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Probability</dt>
          <dd>
            {% if opportunity.probability is not none %}
              {{ opportunity.probability }}%
            {% else %}
              —
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Last Updated</dt>
          <dd>{{ opportunity.updated_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</dd>
        </div>
      </dl>
    </div>
  </div>
</div>

<div id="clientRequirementModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="w-full max-w-lg rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Client Requirements Form</p>
        <h3 class="text-lg font-semibold text-slate-100" data-crf-modal-title>Client Requirements</h3>
      </div>
      <button type="button" class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" data-crf-close aria-label="Close requirements modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="space-y-3 px-6 py-5 text-sm text-slate-300">
      <p class="text-xs uppercase tracking-wide text-slate-500">Status</p>
      <p class="rounded-lg bg-slate-800/60 px-3 py-2 font-semibold text-slate-100" data-crf-modal-status>Draft</p>
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Version</p>
          <p class="font-semibold text-slate-100" data-crf-modal-version>—</p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Created</p>
          <p class="font-semibold text-slate-100" data-crf-modal-created>—</p>
        </div>
      </div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Created By</p>
      <p class="rounded-lg bg-slate-800/60 px-3 py-2 font-semibold text-slate-100" data-crf-modal-author>—</p>
    </div>
    <div class="flex items-center justify-between gap-3 border-t border-slate-800/80 px-6 py-4">
      <p class="text-xs text-slate-500">Opens the full form in a new tab.</p>
      <a href="#" target="_blank" rel="noopener" data-crf-modal-link class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Open Form</a>
    </div>
  </div>
</div>

{% if opportunity.client %}
<div
  id="clientDetailModal"
  data-modal-id="clientDetailModal"
  data-client-id="{{ opportunity.client.id }}"
  data-client-name="{{ opportunity.client.display_name }}"
  data-client-email="{{ opportunity.client.email or '' }}"
  data-client-phone="{{ opportunity.client.phone or '' }}"
  data-client-description="{{ opportunity.client.description|default('', true)|e }}"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur"
>
  <div class="relative w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Client</p>
        <h3 class="text-lg font-semibold text-slate-100" data-client-name-display>{{ opportunity.client.display_name }}</h3>
      </div>
      <button
        type="button"
        class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100"
        data-modal-close="clientDetailModal"
        aria-label="Close client modal"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="space-y-4 px-6 py-5">
      <div class="space-y-3" data-client-view>
        <dl class="grid grid-cols-1 gap-3 text-sm text-slate-300">
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Email</dt>
            <dd data-client-email-display>{{ opportunity.client.email or 'Not provided' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Phone</dt>
            <dd data-client-phone-display>{{ opportunity.client.phone or 'Not provided' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Notes</dt>
            <dd class="whitespace-pre-line" data-client-description-display>{{ opportunity.client.description or 'No notes added yet.' }}</dd>
          </div>
        </dl>
      </div>

      {% if current_user.can_view_module('sales') %}
      <form
        id="clientInlineForm"
        class="hidden space-y-3"
        method="post"
        action="{{ url_for('sales_client_inline_update', client_id=opportunity.client.id) }}"
      >
        {{ csrf_field() }}
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Client Name</label>
            <input
              type="text"
              name="display_name"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
              required
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Email</label>
            <input
              type="email"
              name="email"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Phone</label>
            <input
              type="text"
              name="phone"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Notes</label>
            <textarea
              name="description"
              rows="2"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            ></textarea>
          </div>
        </div>
        <p class="hidden text-sm text-rose-300" data-client-error></p>
      </form>
      {% endif %}

      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        {% if current_user.can_view_module('sales') %}
        <button
          type="button"
          class="hidden items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:text-emerald-100"
          data-client-edit-cancel
        >
          Cancel
        </button>
        <button
          type="submit"
          form="clientInlineForm"
          class="hidden items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
          data-client-save
        >
          Save
        </button>
        <button
          type="button"
          class="items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
          data-client-edit-toggle
        >
          Edit
        </button>
        {% endif %}
        <button
          type="button"
          class="items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:text-emerald-100"
          data-modal-close="clientDetailModal"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div id="editOpportunityModal" data-modal-id="editOpportunityModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="relative w-full max-w-3xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <h3 class="text-lg font-semibold text-slate-100">Edit Opportunity</h3>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close edit opportunity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="update">
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Title</label>
        <input type="text" name="title" value="{{ opportunity.title }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Stage</label>
          <select name="stage" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            {% for stage_option in stages %}
            <option value="{{ stage_option }}" {% if stage_option == opportunity.stage %}selected{% endif %}>{{ stage_option }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Temperature</label>
          <select name="temperature" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">None</option>
            {% for value, label in temperature_choices %}
            <option value="{{ value }}" {% if opportunity.temperature == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        {% if can_see_commercial %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <input type="text" name="amount" value="{{ opportunity.amount if opportunity.amount is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
          </div>
        {% else %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <p class="text-sm text-slate-500 italic">Restricted</p>
          </div>
        {% endif %}
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Probability (%)</label>
          <input type="number" name="probability" value="{{ opportunity.probability if opportunity.probability is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" min="0" max="100">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Expected Close Date</label>
          <input type="date" name="expected_close_date" value="{{ opportunity.expected_close_date.isoformat() if opportunity.expected_close_date else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Related Project</label>
          <input type="text" name="related_project" value="{{ opportunity.related_project or '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Project / Site">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Client</label>
          <select name="client_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Select client</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if opportunity.client and opportunity.client.id == client.id %}selected{% endif %}>{{ client.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Owner</label>
          <select name="owner_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Unassigned</option>
            {% for owner in owners %}
            <option value="{{ owner.id }}" {% if opportunity.owner and opportunity.owner.id == owner.id %}selected{% endif %}>{{ owner.display_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Description</label>
        <textarea name="description" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">{{ opportunity.description or '' }}</textarea>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Opportunity</button>
      </div>
    </form>
  </div>
</div>

{% with
  modal_id='salesDesignTaskModal',
  modal_title='Create Sales Query Task',
  submit_label='Create Task',
  projects=design_projects,
  users=design_users,
  default_task_type='sales_query',
  default_origin_type='sales',
  default_origin_id=opportunity.id,
  default_origin_reference=opportunity.title,
  default_project_id=opportunity.project_id,
  default_project_name=opportunity.related_project or opportunity.title,
  default_description=opportunity.title,
  show_origin_fields=False,
  default_priority='medium'
%}
  {% include 'partials/design_task_modal.html' %}
{% endwith %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabTriggers = Array.from(document.querySelectorAll('.tab-trigger'));
    const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));
    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const activeClasses = ['bg-emerald-500/20', 'border-emerald-400/40', 'text-emerald-100'];
    const inactiveClasses = ['bg-transparent', 'border-transparent', 'text-slate-300'];

    function setActiveTab(tab) {
      tabTriggers.forEach((trigger) => {
        const isActive = trigger.dataset.tab === tab;
        trigger.classList.toggle('tab-active', isActive);
        if (isActive) {
          inactiveClasses.forEach((cls) => trigger.classList.remove(cls));
          activeClasses.forEach((cls) => trigger.classList.add(cls));
        } else {
          activeClasses.forEach((cls) => trigger.classList.remove(cls));
          inactiveClasses.forEach((cls) => trigger.classList.add(cls));
        }
      });

      tabPanels.forEach((panel) => {
        const isActive = panel.dataset.tabPanel === tab;
        if (isActive) {
          panel.classList.remove('hidden');
          requestAnimationFrame(() => {
            panel.classList.add('is-active');
          });
        } else {
          panel.classList.remove('is-active');
          if (panel.classList.contains('hidden')) {
            return;
          }
          if (prefersReducedMotion) {
            panel.classList.add('hidden');
            return;
          }
          const handleTransition = (event) => {
            if (event.target !== panel || event.propertyName !== 'opacity') {
              return;
            }
            if (panel.classList.contains('is-active')) {
              return;
            }
            panel.classList.add('hidden');
          };
          panel.addEventListener('transitionend', handleTransition, { once: true });
        }
      });
    }

    const defaultTab = document.querySelector('.tab-trigger.tab-active');
    if (defaultTab) {
      setActiveTab(defaultTab.dataset.tab);
    }

    tabTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => setActiveTab(trigger.dataset.tab));
    });

    const clientModal = document.getElementById('clientDetailModal');
    const clientForm = document.getElementById('clientInlineForm');
    const clientNameTargets = document.querySelectorAll('[data-client-name]');
    const clientNameDisplay = clientModal?.querySelector('[data-client-name-display]');
    const clientEmailDisplay = clientModal?.querySelector('[data-client-email-display]');
    const clientPhoneDisplay = clientModal?.querySelector('[data-client-phone-display]');
    const clientDescriptionDisplay = clientModal?.querySelector('[data-client-description-display]');
    const clientError = clientModal?.querySelector('[data-client-error]');
    const clientEditToggle = clientModal?.querySelector('[data-client-edit-toggle]');
    const clientEditCancel = clientModal?.querySelector('[data-client-edit-cancel]');
    const clientSaveButton = clientModal?.querySelector('[data-client-save]');
    const clientViewSection = clientModal?.querySelector('[data-client-view]');

    function toggleModal(modalId, open) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      if (open) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('overflow-hidden');
      } else {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    const linkedPanel = document.querySelector('[data-linked-panel]');
    const linkedToggle = document.querySelector('[data-linked-toggle]');
    if (linkedPanel && linkedToggle) {
      linkedToggle.addEventListener('click', () => {
        linkedPanel.classList.toggle('hidden');
        linkedToggle.classList.toggle('rotate-180');
      });
    }

    const linkFormPanel = document.querySelector('[data-link-form-panel]');
    const linkFormToggles = document.querySelectorAll('[data-link-form-toggle]');
    linkFormToggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        if (!linkFormPanel) return;
        linkFormPanel.classList.toggle('hidden');
      });
    });

    document.querySelectorAll('[data-auto-submit-file]').forEach((input) => {
      input.addEventListener('change', () => {
        if (input.files && input.files.length > 0) {
          input.closest('form')?.submit();
        }
      });
    });

    const crfModal = document.getElementById('clientRequirementModal');
    const crfTitle = crfModal?.querySelector('[data-crf-modal-title]');
    const crfStatus = crfModal?.querySelector('[data-crf-modal-status]');
    const crfVersion = crfModal?.querySelector('[data-crf-modal-version]');
    const crfCreated = crfModal?.querySelector('[data-crf-modal-created]');
    const crfAuthor = crfModal?.querySelector('[data-crf-modal-author]');
    const crfLink = crfModal?.querySelector('[data-crf-modal-link]');

    document.querySelectorAll('[data-crf-open]').forEach((button) => {
      button.addEventListener('click', () => {
        if (!crfModal) return;
        if (crfTitle) crfTitle.textContent = button.dataset.crfTitle || 'Client Requirements';
        if (crfStatus) crfStatus.textContent = button.dataset.crfStatus || 'Draft';
        if (crfVersion) crfVersion.textContent = button.dataset.crfVersion || '—';
        if (crfCreated) crfCreated.textContent = button.dataset.crfCreated || '—';
        if (crfAuthor) crfAuthor.textContent = button.dataset.crfAuthor || '—';
        if (crfLink) crfLink.href = button.dataset.crfLink || '#';
        toggleModal('clientRequirementModal', true);
      });
    });

    crfModal?.querySelectorAll('[data-crf-close]').forEach((closeButton) => {
      closeButton.addEventListener('click', () => toggleModal('clientRequirementModal', false));
    });

    function syncClientFields() {
      if (!clientModal) return;
      const { clientName, clientEmail, clientPhone, clientDescription } = clientModal.dataset;
      const nameValue = clientName || 'Unassigned';
      const emailValue = clientEmail || 'Not provided';
      const phoneValue = clientPhone || 'Not provided';
      const descriptionValue = clientDescription || 'No notes added yet.';

      if (clientNameDisplay) clientNameDisplay.textContent = nameValue;
      if (clientEmailDisplay) clientEmailDisplay.textContent = emailValue;
      if (clientPhoneDisplay) clientPhoneDisplay.textContent = phoneValue;
      if (clientDescriptionDisplay) clientDescriptionDisplay.textContent = descriptionValue;

      clientNameTargets.forEach((target) => {
        target.textContent = nameValue;
      });

      if (clientForm) {
        const nameInput = clientForm.querySelector('input[name="display_name"]');
        const emailInput = clientForm.querySelector('input[name="email"]');
        const phoneInput = clientForm.querySelector('input[name="phone"]');
        const descriptionInput = clientForm.querySelector('textarea[name="description"]');
        if (nameInput) nameInput.value = clientName || '';
        if (emailInput) emailInput.value = clientEmail || '';
        if (phoneInput) phoneInput.value = clientPhone || '';
        if (descriptionInput) descriptionInput.value = clientDescription || '';
      }
    }

    function showClientView() {
      if (!clientModal) return;
      syncClientFields();
      clientForm?.classList.add('hidden');
      clientViewSection?.classList.remove('hidden');
      clientError?.classList.add('hidden');
      if (clientError) clientError.textContent = '';
      clientSaveButton?.classList.add('hidden');
      clientEditCancel?.classList.add('hidden');
      clientEditToggle?.classList.remove('hidden');
    }

    function showClientEdit() {
      if (!clientModal) return;
      syncClientFields();
      clientViewSection?.classList.add('hidden');
      clientForm?.classList.remove('hidden');
      clientError?.classList.add('hidden');
      clientSaveButton?.classList.remove('hidden');
      clientEditCancel?.classList.remove('hidden');
      clientEditToggle?.classList.add('hidden');
      const firstEditable = clientForm?.querySelector('input, textarea');
      if (firstEditable) firstEditable.focus();
    }

    function updateClientModalFromSource(source) {
      if (!clientModal || !source?.dataset) return;
      const { clientId, clientName, clientEmail, clientPhone, clientDescription } = source.dataset;
      if (clientId) clientModal.dataset.clientId = clientId;
      if (clientName !== undefined) clientModal.dataset.clientName = clientName;
      if (clientEmail !== undefined) clientModal.dataset.clientEmail = clientEmail;
      if (clientPhone !== undefined) clientModal.dataset.clientPhone = clientPhone;
      if (clientDescription !== undefined) clientModal.dataset.clientDescription = clientDescription;
    }

    document.querySelectorAll('[data-modal-open]').forEach((button) => {
      button.addEventListener('click', () => {
        if (button.dataset.modalOpen === 'clientDetailModal') {
          updateClientModalFromSource(button);
          showClientView();
        }
        toggleModal(button.dataset.modalOpen, true);
      });
    });

    document.querySelectorAll('[data-modal-close]').forEach((button) => {
      const targetId = button.dataset.modalClose || button.closest('[data-modal-id]')?.dataset.modalId || 'editOpportunityModal';
      button.addEventListener('click', () => toggleModal(targetId, false));
    });

    document.querySelectorAll('[data-modal-id]').forEach((modal) => {
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          toggleModal(modal.dataset.modalId || modal.id, false);
        }
      });
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        document.querySelectorAll('[data-modal-id].flex').forEach((modal) => {
          toggleModal(modal.dataset.modalId || modal.id, false);
        });
      }
    });

    if (clientEditToggle && clientModal) {
      clientEditToggle.addEventListener('click', () => showClientEdit());
    }

    if (clientEditCancel) {
      clientEditCancel.addEventListener('click', () => showClientView());
    }

    if (clientForm) {
      clientForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!clientForm.action) return;
        if (clientError) {
          clientError.textContent = '';
          clientError.classList.add('hidden');
        }
        const formData = new FormData(clientForm);
        fetch(clientForm.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success || !data.client) {
              throw new Error(data.message || 'Could not update client.');
            }
            if (clientModal) {
              clientModal.dataset.clientName = data.client.display_name || '';
              clientModal.dataset.clientEmail = data.client.email || '';
              clientModal.dataset.clientPhone = data.client.phone || '';
              clientModal.dataset.clientDescription = data.client.description || '';
            }
            syncClientFields();
            showClientView();
          })
          .catch((error) => {
            if (clientError) {
              clientError.textContent = error.message || 'Unable to update client right now.';
              clientError.classList.remove('hidden');
            }
          });
      });
    }

    const fileInput = document.getElementById('opportunityFileInput');
    const fileLabel = document.querySelector('[data-file-label]');
    if (fileInput && fileLabel) {
      fileInput.addEventListener('change', () => {
        const fileName = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
        fileLabel.textContent = fileName || 'Drag and drop files here or click to browse.';
      });
    }
  });
</script>
{% endblock %}
