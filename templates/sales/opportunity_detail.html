{% extends "base.html" %}
{% block title %}Sales · Opportunity · {{ opportunity.title }}{% endblock %}
{% block content %}
<div class="mb-6 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
  <div>
    <p class="text-sm text-slate-400">Opportunity · {{ pipeline_config.label if pipeline_config else pipeline_key|capitalize }}</p>
    <h2 class="text-3xl font-semibold tracking-tight">{{ opportunity.title }}</h2>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-slate-400">
      {% if can_see_commercial %}
        <span class="inline-flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> {{ opportunity.display_amount }}</span>
      {% else %}
        <span class="inline-flex items-center gap-2 text-xs italic text-slate-300"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> Amount restricted</span>
      {% endif %}
      <span>Stage: {{ opportunity.stage }}</span>
      {% if opportunity.temperature %}
        {% set label, badge = opportunity.badge_variant %}
        <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ badge }}">{{ label or opportunity.temperature|capitalize }}</span>
      {% endif %}
      {% if open_design_tasks %}
        <span class="inline-flex items-center gap-2 rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-100 border border-amber-400/40">Waiting on Design</span>
      {% endif %}
    </div>
  </div>
  <div class="flex items-center gap-3">
    {% with default_pipeline_key=pipeline_key, opportunity_clients=clients, default_client_id=opportunity.client.id if opportunity.client else None %}
      {% include "sales/_opportunity_quick_create.html" %}
    {% endwith %}
    <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key=pipeline_key) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-800/80 bg-slate-900/70 text-sm text-slate-200 hover:bg-slate-800/80">Back to Pipeline</a>
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-4 shadow-xl card-hover-lift fade-in-up">
  <div class="text-xs uppercase tracking-wide text-slate-500 mb-3">Stage Progress</div>
  <div class="flex items-center gap-3 overflow-x-auto pb-1">
    {% for stage_option in stages %}
      {% set is_current = stage_option == opportunity.stage %}
      {% set is_complete = loop.index0 < current_stage_index %}
      {% set connector_state = 'is-complete' if loop.index0 < current_stage_index else ('is-progress' if loop.index0 == current_stage_index else '') %}
      <div class="flex items-center gap-3">
        <div class="flex flex-col items-center text-center">
          <div title="{{ stage_option }}" class="stage-node w-9 h-9 rounded-full flex items-center justify-center text-xs font-semibold {{ 'is-active' if is_current else '' }} {{ 'is-complete' if is_complete else '' }}">{{ loop.index }}</div>
          <span class="mt-2 text-xs stage-label {{ 'is-active' if is_current else '' }}">{{ stage_option }}</span>
        </div>
        {% if not loop.last %}
          <div class="stage-connector {{ connector_state }}"></div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 40ms;">
  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1">
      <div class="text-xs uppercase tracking-wide text-slate-500">Opportunity Details</div>
      <dl class="mt-3 grid grid-cols-1 gap-x-10 gap-y-4 text-sm text-slate-300 sm:grid-cols-2">
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Stage</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.stage }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Amount</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if can_see_commercial %}
              {{ opportunity.display_amount }}
            {% else %}
              <span class="text-xs text-slate-500 italic">Restricted</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Probability</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.probability is not none %}
              {{ opportunity.probability }}%
            {% else %}
              —
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Expected Close</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.expected_close_date.strftime('%d %b %Y') if opportunity.expected_close_date else 'Not set' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Owner</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.owner.display_name if opportunity.owner else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Client</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.client %}
            <button
              type="button"
              class="inline-flex items-center gap-2 text-emerald-200 hover:underline focus:outline-none focus:ring-2 focus:ring-emerald-400/60 rounded"
              data-modal-open="clientDetailModal"
              data-client-id="{{ opportunity.client.id }}"
              data-client-modal-open
            >
              <span data-client-name>{{ opportunity.client.display_name }}</span>
              <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5H6.75A2.25 2.25 0 0 0 4.5 6.75v10.5A2.25 2.25 0 0 0 6.75 19.5h10.5a2.25 2.25 0 0 0 2.25-2.25V9.75L13.5 4.5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5v5.25H18.75"/></svg>
            </button>
            {% else %}
            <span data-client-name>Unassigned</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Related Project</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.related_project or '—' }}</dd>
        </div>
        {% set temperature_label, temperature_badge = opportunity.badge_variant %}
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Temperature</dt>
          <dd class="mt-1">
            {% if opportunity.temperature %}
              <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ temperature_badge }}">{{ temperature_label or opportunity.temperature|capitalize }}</span>
            {% else %}
              <span class="text-slate-400">Not set</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Final Quotation</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if final_quotation_file %}
              <a href="{{ url_for('static', filename=final_quotation_file.stored_path) }}" class="text-emerald-200 hover:underline" target="_blank" rel="noopener">
                {{ final_quotation_file.original_filename }}
              </a>
            {% else %}
              <span class="text-slate-400">Not selected</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Final Client Requirements Form</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if final_crf %}
              <a href="{{ url_for('sales_client_requirement_form_detail', form_id=final_crf.id) }}" class="text-emerald-200 hover:underline">
                V{{ final_crf.version }} · {{ final_crf.status|replace('_',' ')|title }}
              </a>
            {% else %}
              <span class="text-slate-400">Not selected</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Closed On</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.closed_at %}
              {{ opportunity.closed_at|format_india_datetime('%d %b %Y, %I:%M %p') }}
            {% else %}
              <span class="text-slate-400">Open</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Closed Status</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.closed_status %}
              {{ opportunity.closed_status|capitalize }}
            {% else %}
              <span class="text-slate-400">Not closed</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Lost Reason</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.closed_status == 'lost' and opportunity.closed_reason %}
              {{ opportunity.closed_reason }}
            {% elif opportunity.closed_status == 'lost' %}
              <span class="text-slate-400">No reason captured</span>
            {% else %}
              <span class="text-slate-400">Not applicable</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Created On</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.created_at|format_india_datetime('%d %b %Y, %I:%M %p') if opportunity.created_at else '—' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Last Updated</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.updated_at|format_india_datetime('%d %b %Y, %I:%M %p') if opportunity.updated_at else '—' }}</dd>
        </div>
      </dl>
    </div>
    <div class="flex flex-col items-start gap-2 md:flex-col md:items-start">
      {% if opportunity.project_id %}
        <a href="{{ url_for('project_detail', project_id=opportunity.project_id) }}" class="inline-flex items-center gap-2 rounded-xl border border-blue-400/50 bg-blue-500/20 px-4 py-2 text-sm font-semibold text-blue-100 hover:bg-blue-500/30 btn-shimmer">View Project</a>
      {% else %}
        {% if opportunity.stage and opportunity.stage.lower() == 'closed won' and current_user.can_view_module('operations') %}
          <form action="{{ url_for('sales_opportunity_convert_to_project', opportunity_id=opportunity.id) }}" method="post" style="display: inline-block;">
            {{ csrf_field() }}
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/50 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Convert to Project</button>
          </form>
        {% endif %}
      {% endif %}
      <button type="button" data-modal-open="closeOpportunityModal" class="inline-flex items-center gap-2 rounded-xl border border-amber-400/50 bg-amber-500/20 px-4 py-2 text-sm font-semibold text-amber-100 hover:bg-amber-500/30 btn-shimmer">Close Opportunity</button>
      <button type="button" data-modal-open="editOpportunityModal" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Edit Opportunity</button>
    </div>
  </div>
  <div class="mt-4 rounded-xl border border-slate-800/60 bg-slate-950/50 p-4">
    <p class="text-xs uppercase tracking-wide text-slate-500">Description</p>
    <p class="mt-2 whitespace-pre-line text-sm text-slate-300">{{ opportunity.description or 'No description added yet.' }}</p>
  </div>
</div>

<div id="items-section" class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 70ms;">
  <div class="flex flex-wrap items-start justify-between gap-3 border-b border-slate-800/80 px-6 py-4">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Items</p>
      <p class="text-sm text-slate-300">Items linked to this opportunity.</p>
    </div>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
      data-item-create
    >
      + Add Item
    </button>
  </div>
  <div class="px-6 py-5">
    {% if items %}
      <div class="overflow-hidden rounded-xl border border-slate-800/80 bg-slate-950/40">
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="sticky top-0 z-10 bg-slate-900/80 backdrop-blur">
              <tr class="text-left text-slate-500">
                <th class="py-3 px-4">Type</th>
                <th class="py-3 px-4">Floors</th>
                <th class="py-3 px-4">Cabin Finish</th>
                <th class="py-3 px-4">Door Type</th>
                <th class="py-3 px-4">Structure Required</th>
                <th class="py-3 px-4">Qty</th>
                <th class="py-3 px-4">Item Value</th>
                <th class="py-3 px-4">Details</th>
                <th class="py-3 px-4 text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800/70">
              {% for item in items %}
              <tr class="transition duration-200 hover:bg-slate-900/60 fade-slide-row">
                <td class="py-3 px-4 text-slate-200">{{ item.lift_type or '—' }}</td>
                <td class="py-3 px-4 text-slate-200">{{ item.floors or '—' }}</td>
                <td class="py-3 px-4 text-slate-200">{{ item.cabin_finish or '—' }}</td>
                <td class="py-3 px-4 text-slate-200">{{ item.door_type or '—' }}</td>
                <td class="py-3 px-4 font-semibold text-slate-100">{{ item.structure_label }}</td>
                <td class="py-3 px-4 text-slate-200">{{ item.quantity or '—' }}</td>
                <td class="py-3 px-4 text-slate-200">
                  {% if item.item_value is not none and item.item_value != '' %}
                    {{ '{:,.2f}'.format(item.item_value) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="py-3 px-4 max-w-xs">
                  {% if item.details %}
                    <span class="line-clamp-2" title="{{ item.details }}">{{ item.details }}</span>
                  {% else %}
                    <span class="text-slate-500">—</span>
                  {% endif %}
                </td>
                <td class="py-3 px-4 text-right">
                  <div class="flex justify-end gap-2">
                    <button
                      type="button"
                      class="inline-flex items-center gap-1 rounded-lg border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100"
                      data-item-edit
                      data-item-id="{{ item.id }}"
                      data-item-structure="{{ 'true' if item.structure_required else 'false' }}"
                      data-item-lift-type="{{ item.lift_type or '' }}"
                      data-item-door-type="{{ item.door_type or '' }}"
                      data-item-floors="{{ item.floors or '' }}"
                      data-item-quantity="{{ item.quantity or 1 }}"
                      data-item-cabin-finish="{{ item.cabin_finish or '' }}"
                      data-item-details="{{ item.details or '' }}"
                      data-item-value="{{ item.item_value if item.item_value is not none else '' }}"
                    >
                      Edit
                    </button>
                    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="inline" onsubmit="return confirm('Delete this item?');">
                      {{ csrf_field() }}
                      <input type="hidden" name="form_action" value="delete_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button type="submit" class="inline-flex items-center gap-1 rounded-lg border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-200 hover:bg-rose-500/10">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-400">
        <p class="font-medium text-slate-200">No items added yet.</p>
        <p class="mt-1 text-xs text-slate-500">Use the Add Item button to capture the scope for this opportunity.</p>
      </div>
    {% endif %}
  </div>
</div>

<div id="activities" class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 90ms;">
  <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Activities</p>
      <p class="text-sm text-slate-300">Create, log, or close follow-ups linked to this opportunity.</p>
    </div>
    <div class="flex flex-wrap gap-3">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
        data-activity-create
      >
        + Create Activity
      </button>
    </div>
  </div>
  <div class="mt-4 space-y-4">
    <div class="rounded-xl border border-slate-800/80 bg-slate-950/40">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800/70">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Open / Upcoming</p>
          <p class="text-xs text-slate-500">Activities that still need to be logged or cancelled.</p>
        </div>
      </div>
      {% if open_engagements %}
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-950/60 text-left text-slate-500">
            <tr>
              <th class="py-3 px-4">Type</th>
              <th class="py-3 px-4">Subject</th>
              <th class="py-3 px-4">Date</th>
              <th class="py-3 px-4">Time</th>
              <th class="py-3 px-4">Reminder</th>
              <th class="py-3 px-4">Status</th>
              <th class="py-3 px-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/70">
            {% for engagement in open_engagements %}
            {% set has_time = engagement.scheduled_for and (engagement.scheduled_for.time().hour or engagement.scheduled_for.time().minute) %}
            {% set overdue = engagement.is_overdue %}
            <tr class="transition duration-200 hover:bg-slate-900/60 fade-slide-row">
              <td class="py-3 px-4 font-semibold text-slate-200">{{ engagement.display_activity_type }}</td>
              <td class="py-3 px-4 text-slate-200">
                <div class="flex flex-col gap-1">
                  <span class="font-semibold">{{ engagement.subject or '—' }}</span>
                  {% if engagement.notes %}
                    <span class="text-xs text-slate-500 line-clamp-2">{{ engagement.notes }}</span>
                  {% endif %}
                </div>
              </td>
              <td class="py-3 px-4 text-slate-200">{{ engagement.scheduled_for.strftime('%d %b %Y') if engagement.scheduled_for else '—' }}</td>
              <td class="py-3 px-4 text-slate-200">{{ engagement.scheduled_for.strftime('%I:%M %p') if has_time else '—' }}</td>
              <td class="py-3 px-4 text-slate-200">{{ engagement.display_reminder }}</td>
              <td class="py-3 px-4">
                <div class="flex flex-col gap-1">
                  <span class="inline-flex items-center gap-2 rounded-full border border-amber-400/50 bg-amber-500/10 px-3 py-1 text-xs font-semibold text-amber-100">Open</span>
                  {% if overdue %}
                    <span class="inline-flex items-center gap-2 rounded-full border border-rose-500/50 bg-rose-500/10 px-3 py-1 text-[11px] font-semibold text-rose-100">Overdue</span>
                  {% endif %}
                </div>
              </td>
              <td class="py-3 px-4 text-right">
                <div class="flex justify-end gap-2">
                  <button
                    type="button"
                    class="inline-flex items-center gap-1 rounded-lg border border-emerald-400/50 px-3 py-1 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/10"
                    data-activity-log
                    data-activity-id="{{ engagement.id }}"
                    data-activity-type="{{ engagement.activity_type or 'meeting' }}"
                    data-activity-subject="{{ (engagement.subject or '') | e }}"
                    data-activity-date="{{ engagement.scheduled_for.date().isoformat() if engagement.scheduled_for else '' }}"
                    data-activity-time="{{ engagement.scheduled_for.strftime('%H:%M') if has_time else '' }}"
                  >
                    Log / Close
                  </button>
                  <button
                    type="button"
                    class="inline-flex items-center gap-1 rounded-lg border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100"
                    data-activity-edit
                    data-activity-id="{{ engagement.id }}"
                    data-activity-type="{{ engagement.activity_type or 'meeting' }}"
                    data-activity-subject="{{ (engagement.subject or '') | e }}"
                    data-activity-date="{{ engagement.scheduled_for.date().isoformat() if engagement.scheduled_for else '' }}"
                    data-activity-time="{{ engagement.scheduled_for.strftime('%H:%M') if has_time else '' }}"
                    data-activity-reminder="{{ engagement.reminder_option or '' }}"
                    data-activity-notes="{{ (engagement.notes or '') | e }}"
                  >
                    Edit
                  </button>
                  <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="inline" onsubmit="return confirm('Cancel this activity?');">
                    {{ csrf_field() }}
                    <input type="hidden" name="form_action" value="cancel_activity">
                    <input type="hidden" name="engagement_id" value="{{ engagement.id }}">
                    <input type="hidden" name="cancel_reason" value="">
                    <button type="submit" class="inline-flex items-center gap-1 rounded-lg border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-200 hover:bg-rose-500/10">Cancel</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="px-4 py-5 text-center text-sm text-slate-400">
        <p class="font-medium text-slate-200">No open activities yet.</p>
        <p class="mt-1 text-xs text-slate-500">Log calls, meetings, WhatsApp follow-ups, and next steps.</p>
      </div>
      {% endif %}
    </div>

    <details class="group rounded-xl border border-slate-800/80 bg-slate-950/40">
      <summary class="flex cursor-pointer items-center justify-between px-4 py-3 text-slate-300 hover:text-emerald-100">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Logged / Completed</p>
          <p class="text-xs text-slate-500">Closed or cancelled activities (collapsed by default).</p>
        </div>
        <svg class="h-4 w-4 text-slate-500 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25 12 15.75 4.5 8.25"/>
        </svg>
      </summary>
      <div class="border-t border-slate-800/70">
        {% if logged_engagements %}
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-950/60 text-left text-slate-500">
              <tr>
                <th class="py-3 px-4">Type</th>
                <th class="py-3 px-4">Subject</th>
                <th class="py-3 px-4">Date</th>
                <th class="py-3 px-4">Time</th>
                <th class="py-3 px-4">Reminder</th>
                <th class="py-3 px-4">Status</th>
                <th class="py-3 px-4 text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800/70">
              {% for engagement in logged_engagements %}
              {% set has_time = engagement.scheduled_for and (engagement.scheduled_for.time().hour or engagement.scheduled_for.time().minute) %}
              {% set status = (engagement.status or 'open').lower() %}
              {% set status_class = 'border-emerald-400/50 bg-emerald-500/10 text-emerald-100' if status == 'done' else 'border-slate-500/50 bg-slate-500/10 text-slate-100' %}
              <tr class="transition duration-200 hover:bg-slate-900/60 fade-slide-row">
                <td class="py-3 px-4 font-semibold text-slate-200">{{ engagement.display_activity_type }}</td>
                <td class="py-3 px-4 text-slate-200">
                  <div class="flex flex-col gap-1">
                    <span class="font-semibold">{{ engagement.subject or '—' }}</span>
                    {% if engagement.notes %}
                      <span class="text-xs text-slate-500 line-clamp-2">{{ engagement.notes }}</span>
                    {% endif %}
                  </div>
                </td>
                <td class="py-3 px-4 text-slate-200">{{ engagement.scheduled_for.strftime('%d %b %Y') if engagement.scheduled_for else '—' }}</td>
                <td class="py-3 px-4 text-slate-200">{{ engagement.scheduled_for.strftime('%I:%M %p') if has_time else '—' }}</td>
                <td class="py-3 px-4 text-slate-200">{{ engagement.display_reminder }}</td>
                <td class="py-3 px-4">
                  <div class="flex flex-col gap-1 text-xs text-slate-200">
                    <span class="inline-flex items-center gap-2 rounded-full border {{ status_class }} px-3 py-1 text-[11px] font-semibold uppercase tracking-wide">{{ engagement.display_status }}</span>
                    {% if engagement.display_outcome %}
                      <span class="text-emerald-100">Outcome: {{ engagement.display_outcome }}</span>
                    {% endif %}
                    {% if engagement.log_details %}
                      <span class="text-slate-400">Notes: {{ engagement.log_details }}</span>
                    {% endif %}
                    {% if engagement.completed_by or engagement.completed_at %}
                      <span class="text-[11px] text-slate-500">
                        {{ 'By ' ~ (engagement.completed_by.display_name if engagement.completed_by else '—') }}{% if engagement.completed_at %}, {{ engagement.completed_at.strftime('%d %b %Y, %I:%M %p') }}{% endif %}
                      </span>
                    {% endif %}
                  </div>
                </td>
                <td class="py-3 px-4 text-right">
                  <div class="flex justify-end gap-2">
                    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="inline" onsubmit="return confirm('Delete this activity?');">
                      {{ csrf_field() }}
                      <input type="hidden" name="form_action" value="delete_activity">
                      <input type="hidden" name="engagement_id" value="{{ engagement.id }}">
                      <button type="submit" class="inline-flex items-center gap-1 rounded-lg border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-200 hover:bg-rose-500/10">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="px-4 py-5 text-center text-sm text-slate-400">
          <p class="font-medium text-slate-200">No completed activities yet.</p>
          <p class="mt-1 text-xs text-slate-500">Logged items will show here after you close them.</p>
        </div>
        {% endif %}
      </div>
    </details>
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 90ms;">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Design Tasks for this Opportunity</p>
      <p class="text-sm text-slate-300">Link design requests raised from this deal and track their progress.</p>
    </div>
    <button
      type="button"
      data-design-task-modal="salesDesignTaskModal"
      class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
    >
      + Create Sales Query Task
    </button>
  </div>
  <div class="mt-3 overflow-x-auto rounded-xl border border-slate-800/80 bg-slate-950/40">
    <table class="w-full text-sm">
      <thead class="sticky top-0 bg-slate-950/60 backdrop-blur">
        <tr class="text-left text-slate-500">
          <th class="py-3 px-4">Task Type</th>
          <th class="py-3 px-4">Title</th>
          <th class="py-3 px-4">Assigned To</th>
          <th class="py-3 px-4">Status</th>
          <th class="py-3 px-4">Due Date</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800/70">
        {% for task in design_tasks %}
        <tr class="hover:bg-slate-900/60 transition">
          <td class="py-3 px-4 font-semibold text-slate-200">{{ task.task_type.replace('_',' ').title() }}</td>
          <td class="py-3 px-4">
            <a href="{{ url_for('design_task_detail', task_id=task.id) }}" class="text-emerald-100 hover:text-emerald-200 font-semibold">{{ task.description or task.project_label }}</a>
            <div class="text-xs text-slate-500">ID #{{ task.id }}</div>
          </td>
          <td class="py-3 px-4">{{ task.assigned_to.display_name if task.assigned_to else 'Unassigned' }}</td>
          <td class="py-3 px-4">
            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs {{ 'bg-emerald-500/20 text-emerald-100 border border-emerald-400/40' if task.status == 'completed' else 'bg-amber-500/20 text-amber-100 border border-amber-400/40' if task.status in ['new','in_progress','waiting_info'] else 'bg-slate-800/70 text-slate-200 border border-slate-700' }}">{{ task.status.replace('_',' ').title() }}</span>
          </td>
          <td class="py-3 px-4">{{ task.due_date.strftime('%d %b %Y') if task.due_date else '—' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="py-4 px-4 text-center text-slate-500">No design tasks linked yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid gap-6 xl:grid-cols-[1.2fr_1fr]">
  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 120ms;">
      <div class="px-6 pt-5">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <button type="button" data-tab="comments" class="tab-trigger tab-active inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-emerald-100 transition">Comments</button>
          <button type="button" data-tab="files" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Files</button>
          <button type="button" data-tab="timeline" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Timeline</button>
        </div>
      </div>
      <div class="px-6 py-6">
        <div data-tab-panel="comments" class="motion-panel is-active">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Capture internal comments about this deal to keep the team aligned.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="add_comment">
              <textarea name="comment_body" rows="4" placeholder="Share an update with your team." class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required></textarea>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Comment</button>
              </div>
            </form>
            {% if comments %}
            <ul class="space-y-4">
              {% for comment in comments %}
              <li class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4">
                <p class="text-sm text-slate-200 whitespace-pre-line">{{ comment.body }}</p>
                <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
                  <span>{{ comment.author.display_name if comment.author else 'System' }}</span>
                  <span>{{ comment.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No comments added yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="files" class="motion-panel hidden">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Attach proposals, contracts or supporting documents for quick access.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" enctype="multipart/form-data" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="upload_file">
              <div class="rounded-xl border border-dashed border-slate-700 bg-slate-950/40 px-6 py-8 text-center">
                <input type="file" name="attachment" id="opportunityFileInput" class="hidden" required>
                <label for="opportunityFileInput" class="flex cursor-pointer flex-col items-center gap-3">
                  <svg class="h-10 w-10 text-slate-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13l3 3L22 6"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 10V3m0 0L8 7m4-4l4 4"/><path stroke-linecap="round" stroke-linejoin="round" d="M20 21H4a2 2 0 01-2-2V7a2 2 0 012-2h5"/></svg>
                  <p class="text-sm text-slate-400" data-file-label>Drag and drop files here or click to browse.</p>
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-800/80 px-3 py-1 text-xs text-slate-300">Choose a file</span>
                </label>
              </div>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Upload File</button>
              </div>
            </form>
            {% if files %}
            <ul class="divide-y divide-slate-800/80 rounded-xl border border-slate-800/80 bg-slate-950/40">
              {% for file in files %}
              <li class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
                <div>
                  <a href="{{ url_for('static', filename=file.stored_path) }}" class="font-medium text-slate-100 hover:text-emerald-100" download>{{ file.original_filename }}</a>
                  <div class="mt-1 text-xs text-slate-500">
                    Uploaded {{ file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}
                  </div>
                </div>
                <span class="text-xs text-slate-400">{{ file.display_size }}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No files uploaded yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="timeline" class="motion-panel hidden">
          <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="mb-6 space-y-3">
            {{ csrf_field() }}
            <input type="hidden" name="form_action" value="add_note">
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-[1fr_auto]">
              <input type="text" name="note_title" placeholder="Add quick update" class="rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Add Note</button>
            </div>
            <textarea name="note_body" rows="3" placeholder="Meeting outcome, blockers or next steps." class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60"></textarea>
          </form>
          {% if activities %}
          <ol class="relative ml-3 space-y-6 border-l border-slate-800/80">
            {% for activity in activities %}
            <li class="ml-6">
              <span class="absolute -left-3 flex h-6 w-6 items-center justify-center rounded-full border border-emerald-400/40 bg-emerald-500/20 text-xs font-semibold text-emerald-200">•</span>
              <div class="rounded-xl border border-slate-800/80 bg-slate-900/80 px-4 py-3">
                <div class="flex items-center justify-between text-sm">
                  <p class="font-semibold text-slate-100">{{ activity.title }}</p>
                  <span class="text-xs text-slate-500">{{ activity.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% if activity.notes %}
                <p class="mt-2 text-sm text-slate-300 whitespace-pre-line">{{ activity.notes }}</p>
                {% endif %}
                {% if activity.actor %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">{{ 'Admin · ' if activity.actor.is_admin else 'User · ' }}{{ activity.actor.display_name }}</p>
                {% else %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">System</p>
                {% endif %}
              </div>
            </li>
            {% endfor %}
          </ol>
          {% else %}
          <div class="py-16 text-center text-slate-500">No updates yet. Start logging interactions.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 110ms;">
      <div class="flex items-start justify-between gap-3 px-6 py-4 border-b border-slate-800/80">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Quotation Requests</p>
          <p class="text-sm text-slate-300">Track items, CRFs and negotiation per request.</p>
        </div>
        {% if can_manage_opportunity_docs %}
        <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30" data-modal-open="createQuotationRequestModal">+ Create Quotation Request</button>
        {% endif %}
      </div>
      <div class="px-6 py-5 space-y-3">
        {% if quotation_requests %}
        <div class="space-y-3">
          {% for request in quotation_requests %}
          <div class="rounded-xl border border-slate-800/80 bg-slate-950/50">
            <div class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
              <div>
                <p class="font-semibold text-slate-100">Request #{{ request.id }}</p>
                <p class="text-xs text-slate-500">Created {{ request.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if request.requested_by %} · {{ request.requested_by.display_name }}{% endif %}</p>
                {% if request.notes %}
                <p class="mt-1 text-xs text-slate-400">Notes: {{ request.notes }}</p>
                {% endif %}
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-800/80 px-3 py-1 text-xs font-semibold text-slate-200">{{ request.item_count }} item{{ 's' if request.item_count != 1 else '' }}</span>
                <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-100">{{ request.status_label }}</span>
                {% if request.linked_crf %}
                <span class="inline-flex items-center gap-1 rounded-full bg-sky-500/20 px-3 py-1 text-xs font-semibold text-sky-100">CRF V{{ request.linked_crf.version }}{% if request.linked_crf.template %} · {{ request.linked_crf.template.name }}{% endif %}</span>
                {% endif %}
                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100" data-request-toggle>View</button>
              </div>
            </div>
            <div class="hidden border-t border-slate-800/80 px-4 py-3 space-y-3" data-request-panel>
              <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                {% set types = request.items | map(attribute='opportunity_item') | map(attribute='lift_type') | list %}
                <span class="font-semibold text-slate-200">Item types:</span>
                {% if types %}
                  {% for lift_type in types %}
                  <span class="rounded-full bg-slate-800/70 px-2 py-1">{{ lift_type or 'Not set' }}</span>
                  {% endfor %}
                {% else %}
                  <span>No items linked.</span>
                {% endif %}
              </div>
              <div class="space-y-2">
                <p class="text-xs uppercase tracking-wide text-slate-500">Actions</p>
                {% if can_manage_opportunity_docs %}
                <div class="flex flex-wrap gap-2">
                  <form method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="form_action" value="update_quotation_request_status">
                    <input type="hidden" name="quotation_request_id" value="{{ request.id }}">
                    <input type="hidden" name="target_status" value="in_progress">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-100 hover:bg-amber-500/30">Mark In Progress</button>
                  </form>
                  <form method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="form_action" value="update_quotation_request_status">
                    <input type="hidden" name="quotation_request_id" value="{{ request.id }}">
                    <input type="hidden" name="target_status" value="shared">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-sky-400/40 bg-sky-500/20 px-3 py-1 text-xs font-semibold text-sky-100 hover:bg-sky-500/30">Mark Shared</button>
                  </form>
                  <form method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="form_action" value="update_quotation_request_status">
                    <input type="hidden" name="quotation_request_id" value="{{ request.id }}">
                    <input type="hidden" name="target_status" value="revised">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-500/20 px-3 py-1 text-xs font-semibold text-rose-100 hover:bg-rose-500/30">Request Revision</button>
                  </form>
                  <form method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="form_action" value="update_quotation_request_status">
                    <input type="hidden" name="quotation_request_id" value="{{ request.id }}">
                    <input type="hidden" name="target_status" value="finalized">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Finalize</button>
                  </form>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100" data-negotiation-open data-request-id="{{ request.id }}">Request Discount / Negotiation</button>
                </div>
                {% else %}
                <p class="text-xs text-slate-500">Only the opportunity owner can update requests.</p>
                {% endif %}
              </div>
              <div class="space-y-2">
                <p class="text-xs uppercase tracking-wide text-slate-500">Linked Items</p>
                <ul class="space-y-1 text-sm text-slate-200">
                  {% for link in request.items %}
                  <li class="flex items-center gap-2">
                    <span class="rounded-full bg-slate-800/70 px-2 py-1 text-xs text-slate-300">#{{ link.opportunity_item.id }}</span>
                    <span>{{ link.opportunity_item.details or link.opportunity_item.lift_type or 'Item' }}</span>
                    <span class="text-xs text-slate-500">Qty: {{ link.opportunity_item.quantity or 1 }}</span>
                  </li>
                  {% endfor %}
                </ul>
              </div>
              <div class="space-y-2">
                <p class="text-xs uppercase tracking-wide text-slate-500">Quotation Files</p>
                {% if request.files %}
                <ul class="space-y-2 text-sm text-slate-200">
                  {% for file in request.files %}
                  <li class="flex items-center justify-between gap-2 rounded-lg bg-slate-900/70 px-3 py-2">
                    <div>
                      <p class="font-semibold">{{ file.original_filename }}</p>
                      <p class="text-xs text-slate-500">Uploaded {{ file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}</p>
                    </div>
                    <a href="{{ url_for('static', filename=file.stored_path) }}" class="text-xs text-sky-200 hover:text-sky-100" target="_blank" rel="noopener">Preview</a>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="text-sm text-slate-400">No quotation files linked yet.</p>
                {% endif %}
              </div>
              {% if request.negotiation_logs %}
              <div class="space-y-2">
                <p class="text-xs uppercase tracking-wide text-slate-500">Negotiation / Discount Logs</p>
                <ul class="space-y-2 text-sm text-slate-200">
                  {% for log in request.negotiation_logs %}
                  <li class="rounded-lg bg-slate-900/70 px-3 py-2">
                    <div class="flex items-center justify-between text-xs text-slate-400">
                      <span>{{ log.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</span>
                      {% if log.created_by %}<span>{{ log.created_by.display_name }}</span>{% endif %}
                    </div>
                    {% if log.reason %}<p class="mt-1 text-slate-200">{{ log.reason }}</p>{% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-5 text-center text-sm text-slate-400">
          <p class="font-medium text-slate-200">No quotation requests created yet.</p>
          {% if can_manage_opportunity_docs %}
          <p class="mt-1 text-xs text-slate-500">Create a request to tie items, CRF and uploads together.</p>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 140ms;">
      <div class="flex items-start justify-between gap-3 px-6 py-4 border-b border-slate-800/80">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Linked Client Inputs &amp; Quotation</p>
          <p class="text-sm text-slate-300">Keep requirements and pricing visible while you work.</p>
        </div>
        <button type="button" class="rounded-full border border-slate-700 bg-slate-800/60 p-2 text-slate-300 hover:text-emerald-100" data-linked-toggle aria-label="Collapse linked documents">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>
        </button>
      </div>
      <div class="space-y-5 px-6 py-5" data-linked-panel>
        {% if not client_requirement_forms and not quotation_files %}
        <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-5 text-center text-sm text-slate-400">
          <p class="font-medium text-slate-200">No client inputs or quotations linked yet.</p>
          <p class="mt-1 text-xs text-slate-500">Link the client form or upload your first quotation to keep everything in one place.</p>
          {% if can_manage_opportunity_docs %}
          <div class="mt-4 flex flex-wrap items-center justify-center gap-3">
            <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30" data-link-form-toggle>+ Link Client Requirements</button>
            <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-sky-400/40 bg-sky-500/20 px-3 py-2 text-sm font-semibold text-sky-100 hover:bg-sky-500/30" for="quotationUploadInput">+ Upload Quotation</label>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Client Requirements Form</p>
              <p class="text-sm text-slate-300">Linked to this opportunity and client.</p>
            </div>
            {% if can_manage_opportunity_docs %}
            <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30" data-link-form-toggle>+ Link Form</button>
            {% endif %}
          </div>
          {% if client_requirement_forms %}
          <div class="space-y-3">
            {% for form in client_requirement_forms %}
            <button type="button" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-left hover:border-emerald-400/40" data-crf-open data-crf-title="{{ form.template.name if form.template else 'Client Requirements Form' }}" data-crf-status="{{ form.status|replace('_',' ')|title }}" data-crf-version="V{{ form.version }}" data-crf-created="{{ form.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}" data-crf-author="{{ form.created_by_sales.display_name if form.created_by_sales else 'Unassigned' }}" data-crf-link="{{ url_for('sales_client_requirement_form_detail', form_id=form.id) }}">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="font-semibold text-slate-100">{{ form.template.name if form.template else 'Client Requirements Form' }}</p>
                  <p class="text-xs text-slate-500">Version {{ form.version }} · {{ form.status|replace('_',' ')|title }}</p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-800/70 px-3 py-1 text-xs text-slate-300">{{ form.created_at|format_india_datetime('%d %b %Y') }}</span>
              </div>
              <p class="mt-1 text-xs text-slate-400">Created by {{ form.created_by_sales.display_name if form.created_by_sales else 'System' }}</p>
            </button>
            {% endfor %}
          </div>
          {% else %}
          <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-400">No Client Requirements form linked yet.</div>
          {% endif %}

          {% if can_manage_opportunity_docs %}
          <div class="hidden rounded-xl border border-slate-800/80 bg-slate-950/60 p-4 space-y-4" data-link-form-panel>
            <div class="flex items-center justify-between gap-3">
              <p class="text-sm font-semibold text-slate-100">Link or create a Client Requirements form</p>
              <button type="button" class="text-xs text-slate-400 hover:text-emerald-100" data-link-form-toggle>Close</button>
            </div>
            <form method="post" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="link_client_requirement">
              <input type="hidden" name="link_mode" value="existing">
              <label class="block text-xs uppercase tracking-wide text-slate-400">Link existing form (same client)</label>
              <select name="existing_form_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                <option value="">Select a form</option>
                {% for form in available_client_forms %}
                <option value="{{ form.id }}">Form #{{ form.id }} · {{ form.template.name if form.template else 'Client Requirements' }} · Updated {{ form.updated_at|format_india_datetime('%d %b %Y') }}</option>
                {% endfor %}
              </select>
              {% if not available_client_forms %}
              <p class="text-xs text-slate-500">No other forms found for this client yet.</p>
              {% endif %}
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Link Selected</button>
              </div>
            </form>
            <form method="post" class="space-y-3">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="link_client_requirement">
              <input type="hidden" name="link_mode" value="new">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Or create new draft</p>
                  <p class="text-sm text-slate-300">Prefills client, opportunity and owner.</p>
                </div>
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100">Create Draft</button>
              </div>
            </form>
          </div>
          {% endif %}
        </div>

        <div class="space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Quotation Files</p>
              <p class="text-sm text-slate-300">Latest version appears first.</p>
            </div>
            {% if can_manage_opportunity_docs %}
            <form method="post" enctype="multipart/form-data" class="shrink-0">
              {{ csrf_field() }}
              <input type="hidden" name="form_action" value="upload_quotation">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <select name="quotation_request_id" class="rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400/60">
                  <option value="">Link to request (optional)</option>
                  {% for request in quotation_requests %}
                  <option value="{{ request.id }}">Request #{{ request.id }} · {{ request.status_label }}</option>
                  {% endfor %}
                </select>
              <input type="file" name="quotation_file" id="quotationUploadInput" class="hidden" data-auto-submit-file>
              <label for="quotationUploadInput" class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-sky-400/40 bg-sky-500/20 px-3 py-2 text-xs font-semibold text-sky-100 hover:bg-sky-500/30">Upload New Version</label>
              </div>
            </form>
            {% endif %}
          </div>
          {% if quotation_files %}
          <ul class="divide-y divide-slate-800/80 rounded-xl border border-slate-800/80 bg-slate-950/40">
            {% for file in quotation_files %}
            {% set ext = file.original_filename.split('.')[-1].lower() if '.' in file.original_filename else '' %}
            <li class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-800/70 text-slate-200">
                  {% if ext in ['pdf'] %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 4h8l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 12h4M12 16h2M8 12h.01"/></svg>
                  {% elif ext in ['xls','xlsx','csv'] %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7a2 2 0 0 1 2-2h8l4 4v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M9 17l6-6M9 11l6 6"/></svg>
                  {% else %}
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M14 3v4a1 1 0 0 0 1 1h4"/></svg>
                  {% endif %}
                </div>
                <div>
                  <p class="font-semibold text-slate-100">{{ file.original_filename }}</p>
                  <p class="text-xs text-slate-500">Uploaded {{ file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}</p>
                </div>
              </div>
              <div class="text-right text-sm text-slate-300">
                <div class="inline-flex items-center gap-2 rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-100">V{{ file.computed_version or (quotation_files|length - loop.index0) }}</div>
                <a href="{{ url_for('static', filename=file.stored_path) }}" class="mt-2 inline-flex items-center gap-2 text-sky-200 hover:text-sky-100" target="_blank" rel="noopener">Preview / Download</a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="rounded-xl border border-dashed border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-400">No quotation uploaded yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div id="clientRequirementModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-lg rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Client Requirements Form</p>
        <h3 class="text-lg font-semibold text-slate-100" data-crf-modal-title>Client Requirements</h3>
      </div>
      <button type="button" class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" data-crf-close aria-label="Close requirements modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="space-y-3 px-6 py-5 text-sm text-slate-300">
      <p class="text-xs uppercase tracking-wide text-slate-500">Status</p>
      <p class="rounded-lg bg-slate-800/60 px-3 py-2 font-semibold text-slate-100" data-crf-modal-status>Draft</p>
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Version</p>
          <p class="font-semibold text-slate-100" data-crf-modal-version>—</p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Created</p>
          <p class="font-semibold text-slate-100" data-crf-modal-created>—</p>
        </div>
      </div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Created By</p>
      <p class="rounded-lg bg-slate-800/60 px-3 py-2 font-semibold text-slate-100" data-crf-modal-author>—</p>
    </div>
    <div class="flex items-center justify-between gap-3 border-t border-slate-800/80 px-6 py-4">
      <p class="text-xs text-slate-500">Opens the full form in a new tab.</p>
      <a href="#" target="_blank" rel="noopener" data-crf-modal-link class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Open Form</a>
    </div>
  </div>
</div>

{% if opportunity.client %}
<div
  id="clientDetailModal"
  data-modal-id="clientDetailModal"
  data-client-id="{{ opportunity.client.id }}"
  class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur"
>
  <div class="modal-panel relative w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Client</p>
        <h3 class="text-lg font-semibold text-slate-100" data-client-name-display>{{ opportunity.client.display_name }}</h3>
      </div>
      <button
        type="button"
        class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100"
        data-modal-close="clientDetailModal"
        aria-label="Close client modal"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="space-y-4 px-6 py-5">
      <div class="hidden rounded-xl border border-emerald-400/30 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-100" data-client-loading>
        Loading client details...
      </div>
      <div class="hidden rounded-xl border border-rose-400/30 bg-rose-500/10 px-4 py-3 text-sm text-rose-100" data-client-missing>
        Client record not found. Please check Sales → Clients.
      </div>
      <div class="space-y-3" data-client-view>
        <dl class="grid grid-cols-1 gap-3 text-sm text-slate-300">
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Client Name</dt>
            <dd class="font-semibold text-slate-100" data-client-name-display>{{ opportunity.client.display_name }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Contact Person</dt>
            <dd data-client-contact-display>Not provided</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Phone / Mobile</dt>
            <dd data-client-phone-display>{{ opportunity.client.phone or 'Not provided' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Email</dt>
            <dd data-client-email-display>{{ opportunity.client.email or 'Not provided' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Address</dt>
            <dd data-client-address-display>Not provided</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">City / State</dt>
            <dd data-client-city-state-display>Not provided</dd>
          </div>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-500">GST</dt>
              <dd data-client-gst-display>Not provided</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-500">PAN</dt>
              <dd data-client-pan-display>Not provided</dd>
            </div>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Created Date</dt>
            <dd data-client-created-display>{{ opportunity.client.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500">Remarks / Notes</dt>
            <dd class="whitespace-pre-line" data-client-description-display>{{ opportunity.client.description or 'No notes added yet.' }}</dd>
          </div>
        </dl>
      </div>

      {% if current_user.can_view_module('sales') %}
      <form
        id="clientInlineForm"
        class="hidden space-y-3"
        method="post"
        action="{{ url_for('sales_client_inline_update', client_id=opportunity.client.id) }}"
      >
        {{ csrf_field() }}
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Client Name</label>
            <input
              type="text"
              name="display_name"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
              required
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Email</label>
            <input
              type="email"
              name="email"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Phone</label>
            <input
              type="text"
              name="phone"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Notes</label>
            <textarea
              name="description"
              rows="2"
              class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
            ></textarea>
          </div>
        </div>
        <p class="hidden text-sm text-rose-300" data-client-error></p>
      </form>
      {% endif %}

      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        {% if current_user.can_view_module('sales') %}
        <button
          type="button"
          class="hidden items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:text-emerald-100"
          data-client-edit-cancel
        >
          Cancel
        </button>
        <button
          type="submit"
          form="clientInlineForm"
          class="hidden items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
          data-client-save
        >
          Save
        </button>
        <button
          type="button"
          class="hidden items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer"
          data-client-edit-toggle
        >
          Edit
        </button>
        {% endif %}
        <button
          type="button"
          class="items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:text-emerald-100"
          data-modal-close="clientDetailModal"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div id="closeOpportunityModal" data-modal-id="closeOpportunityModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel relative w-full max-w-4xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <h3 class="text-lg font-semibold text-slate-100">Close Opportunity</h3>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close close opportunity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_close', opportunity_id=opportunity.id) }}" enctype="multipart/form-data" class="space-y-4 px-6 py-5">
      {{ csrf_field() }}
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-800/80 bg-slate-950/60 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500">Outcome</p>
          <div class="mt-3 flex flex-col gap-2 md:flex-row">
            <label class="flex items-center gap-2 text-sm font-semibold text-emerald-100">
              <input type="radio" name="closing_outcome" value="won" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-500" data-close-outcome {% if opportunity.closed_status == 'won' or opportunity.stage|lower == 'closed won' %}checked{% endif %}>
              Closed Won
            </label>
            <label class="flex items-center gap-2 text-sm font-semibold text-amber-100">
              <input type="radio" name="closing_outcome" value="lost" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-amber-500 focus:ring-amber-500" data-close-outcome {% if opportunity.closed_status == 'lost' or opportunity.stage|lower == 'closed lost' %}checked{% endif %}>
              Closed Lost
            </label>
          </div>
          <div class="mt-3 space-y-2" data-lost-reason>
            <label class="text-xs uppercase tracking-wide text-slate-500">Reason for Lost (optional)</label>
            <textarea name="lost_reason" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400/60" placeholder="Capture the reason the deal was lost">{{ opportunity.closed_reason or '' }}</textarea>
          </div>
        </div>
        <div class="rounded-xl border border-slate-800/80 bg-slate-950/60 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500">Final Client Requirements Form</p>
          <p class="mt-1 text-xs text-slate-500">Confirmed versions appear first.</p>
          <select name="final_crf_id" class="mt-3 w-full rounded-xl border border-slate-800/80 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="" disabled {% if not final_crf %}selected{% endif %}>Select final CRF</option>
            {% for form in final_crf_options %}
              <option value="{{ form.id }}" {% if final_crf and final_crf.id == form.id %}selected{% endif %}>V{{ form.version }} · {{ form.status|replace('_',' ')|title }} · {{ form.template.name if form.template else 'CRF' }}</option>
            {% endfor %}
          </select>
          {% if not final_crf_options %}
            <p class="mt-2 text-xs text-rose-300">No Client Requirements Forms available for this opportunity.</p>
          {% endif %}
        </div>
      </div>

      <div class="rounded-xl border border-slate-800/80 bg-slate-950/60 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-500">Select Final Quotation</p>
            <p class="text-xs text-slate-500">Pick the latest shared file or upload the final version.</p>
          </div>
          <span class="rounded-full border border-slate-800/70 bg-slate-900 px-2 py-1 text-[11px] text-slate-400">Required</span>
        </div>
        <div class="mt-3 space-y-3">
          <label class="flex items-center gap-2 text-sm font-semibold text-emerald-100">
            <input type="radio" name="final_quotation_mode" value="existing" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-500" data-quotation-mode {% if final_quotation_options %}checked{% endif %}>
            Use existing quotation
          </label>
          <div class="rounded-xl border border-slate-800/80 bg-slate-900/60 p-3 space-y-2" data-quotation-existing>
            {% if final_quotation_options %}
              <select name="final_quotation_file_id" class="w-full rounded-lg border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                {% for option in final_quotation_options %}
                  {% set file = option.file %}
                  {% set request = option.request %}
                  <option value="{{ file.id }}" {% if final_quotation_file and final_quotation_file.id == file.id %}selected{% endif %}>
                    {{ file.original_filename }}{% if file.computed_version %} · V{{ file.computed_version }}{% endif %}{% if request %} · Request #{{ request.id }}{% endif %}
                  </option>
                {% endfor %}
              </select>
            {% else %}
              <p class="text-sm text-slate-400">No quotations uploaded yet.</p>
            {% endif %}
          </div>
          <label class="flex items-center gap-2 text-sm font-semibold text-emerald-100">
            <input type="radio" name="final_quotation_mode" value="upload" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-500" data-quotation-mode {% if not final_quotation_options %}checked{% endif %}>
            Upload final quotation
          </label>
          <div class="rounded-xl border border-slate-800/80 bg-slate-900/60 p-3 space-y-2 hidden" data-quotation-upload>
            <label class="text-xs uppercase tracking-wide text-slate-500">Upload file</label>
            <input type="file" name="final_quotation_upload" accept=".pdf,.doc,.docx,.xls,.xlsx,image/*" class="block w-full text-sm text-slate-100" data-final-quotation-input>
            <label class="text-xs uppercase tracking-wide text-slate-500">Link to quotation request (optional)</label>
            <select name="final_quotation_request_id" class="w-full rounded-lg border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              <option value="">Do not link</option>
              {% for request in quotation_requests %}
                <option value="{{ request.id }}">Request #{{ request.id }} · {{ request.status_label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-800/80 bg-slate-950/60 p-4" data-project-section>
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Projects</p>
              <p class="text-xs text-slate-500">Closed Won will create one project per item.</p>
            </div>
            <label class="flex items-center gap-2 text-sm font-semibold text-emerald-100">
              <input type="checkbox" name="create_projects_per_item" value="1" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-500" checked>
              Create 1 project per item
            </label>
          </div>
          <div class="mt-3 space-y-2">
            {% if items %}
              {% for item in items %}
                <div class="rounded-lg border border-slate-800/70 bg-slate-900/70 px-3 py-2 text-sm text-slate-200">
                  <div class="font-semibold">{{ item.lift_type or 'Item ' ~ loop.index }}</div>
                  <div class="text-xs text-slate-400">{{ item.details or 'No details added' }}</div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-sm text-slate-400">No items added. A single project will be created.</p>
            {% endif %}
          </div>
        </div>
        {% if linked_ticket %}
        <div class="rounded-xl border border-slate-800/80 bg-slate-950/60 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500">Linked Support Ticket</p>
          <div class="mt-2 flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-slate-100">{{ linked_ticket.id }}</p>
              <p class="text-xs text-slate-400">{{ linked_ticket.subject or 'Support ticket' }}</p>
              <p class="text-xs text-slate-500">Current status: {{ linked_ticket.status }}</p>
            </div>
            <label class="flex items-center gap-2 text-sm font-semibold text-emerald-100">
              <input type="checkbox" name="close_linked_ticket" value="1" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-500 focus:ring-emerald-500" checked>
              Close ticket with outcome
            </label>
          </div>
          <div class="mt-3 space-y-2">
            <label class="text-xs uppercase tracking-wide text-slate-500">Ticket closing note</label>
            <textarea name="ticket_close_notes" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add a note for the ticket timeline">{{ opportunity.closed_reason or '' }}</textarea>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:text-emerald-100" data-modal-close="closeOpportunityModal">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">
          Save &amp; Close
        </button>
      </div>
    </form>
  </div>
</div>

<div id="editOpportunityModal" data-modal-id="editOpportunityModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel relative w-full max-w-3xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <h3 class="text-lg font-semibold text-slate-100">Edit Opportunity</h3>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close edit opportunity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="update">
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Title</label>
        <input type="text" name="title" value="{{ opportunity.title }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Stage</label>
          <select name="stage" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            {% for stage_option in stages %}
            <option value="{{ stage_option }}" {% if stage_option == opportunity.stage %}selected{% endif %}>{{ stage_option }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Temperature</label>
          <select name="temperature" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">None</option>
            {% for value, label in temperature_choices %}
            <option value="{{ value }}" {% if opportunity.temperature == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        {% if can_see_commercial %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <input type="text" name="amount" value="{{ opportunity.amount if opportunity.amount is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
          </div>
        {% else %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <p class="text-sm text-slate-500 italic">Restricted</p>
          </div>
        {% endif %}
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Probability (%)</label>
          <input type="number" name="probability" value="{{ opportunity.probability if opportunity.probability is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" min="0" max="100">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Expected Close Date</label>
          <input type="date" name="expected_close_date" value="{{ opportunity.expected_close_date.isoformat() if opportunity.expected_close_date else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Related Project</label>
          <input type="text" name="related_project" value="{{ opportunity.related_project or '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Project / Site">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Client</label>
          <select name="client_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Select client</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if opportunity.client and opportunity.client.id == client.id %}selected{% endif %}>{{ client.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Owner</label>
          <select name="owner_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Unassigned</option>
            {% for owner in owners %}
            <option value="{{ owner.id }}" {% if opportunity.owner and opportunity.owner.id == owner.id %}selected{% endif %}>{{ owner.display_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Description</label>
        <textarea name="description" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">{{ opportunity.description or '' }}</textarea>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Opportunity</button>
      </div>
    </form>
  </div>
</div>

<div id="opportunityItemModal" data-modal-id="opportunityItemModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Opportunity Item</p>
        <h3 class="text-lg font-semibold text-slate-100" data-item-modal-title>Add Item</h3>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close item modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5" id="itemModalForm">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="create_item" data-item-form-action>
      <input type="hidden" name="item_id" value="" data-item-id-field>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Lift Type</label>
        <input type="text" name="lift_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Machine roomless / Gearless">
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Floors</label>
          <input type="text" name="floors" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="G+3 / B+G+10">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Cabin Finish</label>
          <input type="text" name="cabin_finish" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="SS Hairline / M.S. Powdercoat">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Door Type</label>
          <input type="text" name="door_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Manual / Automatic">
        </div>
        <label class="flex items-center gap-3 rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100">
          <input type="checkbox" name="structure_required" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-400 focus:ring-emerald-400/60">
          <span class="text-xs uppercase tracking-wide text-slate-300">Structure Required</span>
        </label>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Quantity</label>
          <input type="number" name="item_quantity" min="1" value="1" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Item Value <span class="text-slate-600">(Optional)</span></label>
          <input type="number" name="item_value" min="0" step="0.01" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="0.00">
        </div>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Details</label>
        <textarea name="details" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Scope, customizations, exclusions..."></textarea>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer" data-item-submit>Save Item</button>
      </div>
    </form>
  </div>
</div>

<div id="activityModal" data-modal-id="activityModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Activities</p>
        <h3 class="text-lg font-semibold text-slate-100" data-activity-modal-title>Create Activity</h3>
        <p class="text-xs text-slate-500">Log calls, meetings, and follow-ups.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close activity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5" id="activityForm">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="schedule_activity" data-activity-form-action>
      <input type="hidden" name="engagement_id" value="" data-activity-id>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Activity Type</label>
          <select name="activity_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="call">Call</option>
            <option value="meeting">Meeting</option>
            <option value="site_visit">Site Visit</option>
            <option value="email">Email</option>
            <option value="whatsapp">WhatsApp</option>
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Subject</label>
          <input type="text" name="activity_subject" placeholder="Follow-up" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Date</label>
          <input type="date" name="activity_date" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Time</label>
          <input type="time" name="activity_time" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Reminder</label>
          <select name="reminder_option" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            {% for value, label in reminder_options %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Notes</label>
        <textarea name="activity_notes" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add talking points or objectives."></textarea>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer" data-activity-submit>Save Activity</button>
      </div>
    </form>
  </div>
</div>

<div id="logActivityModal" data-modal-id="logActivityModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Log Activity</p>
        <h3 class="text-lg font-semibold text-slate-100">Close Activity</h3>
        <p class="text-xs text-slate-500" data-log-activity-schedule>Update the outcome and notes.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close log activity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5" id="logActivityForm">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="log_activity">
      <input type="hidden" name="engagement_id" value="" data-log-activity-id>
      <div class="rounded-lg border border-slate-800/70 bg-slate-950/60 px-3 py-2 text-sm text-slate-200">
        <p class="text-xs uppercase tracking-wide text-slate-500">Activity</p>
        <p class="font-semibold text-emerald-100" data-log-activity-subject>—</p>
        <p class="text-xs text-slate-500" data-log-activity-type>—</p>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Outcome</label>
        <select name="outcome" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required>
          <option value="">Select outcome</option>
          {% for value, label in activity_outcomes %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Details <span class="text-slate-500">(optional)</span></label>
        <textarea name="log_details" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="What happened, next steps, or notes."></textarea>
      </div>
      <div class="rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-3 space-y-3" data-next-action-container>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Next Action <span class="text-slate-400">(optional)</span></p>
          <p class="text-xs text-slate-500">Create the follow-up immediately after closing this activity.</p>
        </div>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div class="space-y-2" data-next-action-field>
            <label class="text-xs uppercase tracking-wide text-slate-400">Next Action Type</label>
            <select name="next_action_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" data-next-action-type>
              <option value="">None</option>
              <option value="meeting">Meeting</option>
              <option value="site_visit">Site Visit</option>
              <option value="call">Call</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="email">Email</option>
              <option value="callback">Callback</option>
            </select>
          </div>
          <div class="space-y-2" data-next-action-field>
            <label class="text-xs uppercase tracking-wide text-slate-400">Subject</label>
            <input type="text" name="next_action_subject" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Follow-up discussion" data-next-action-subject>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div class="space-y-2" data-next-action-field>
            <label class="text-xs uppercase tracking-wide text-slate-400">Date</label>
            <input type="date" name="next_action_date" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60" data-next-action-date>
          </div>
          <div class="space-y-2" data-next-action-field>
            <label class="text-xs uppercase tracking-wide text-slate-400">Time</label>
            <input type="time" name="next_action_time" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60" data-next-action-time>
          </div>
          <div class="space-y-2" data-next-action-field>
            <label class="text-xs uppercase tracking-wide text-slate-400">Reminder</label>
            <select name="next_action_reminder" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" data-next-action-reminder>
              {% for value, label in reminder_options %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="space-y-2" data-next-action-field>
          <label class="text-xs uppercase tracking-wide text-slate-400">Planning Notes <span class="text-slate-500">(optional)</span></label>
          <textarea name="next_action_notes" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Agenda, prep items, or notes for the next step." data-next-action-notes></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer" data-log-activity-submit>Log &amp; Close</button>
      </div>
    </form>
  </div>
</div>

<div id="createQuotationRequestModal" data-modal-id="createQuotationRequestModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-2xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Quotation Request</p>
        <h3 class="text-lg font-semibold text-slate-100">Create Request</h3>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close create request modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="create_quotation_request">
      <div>
        <p class="mb-2 text-xs uppercase tracking-wide text-slate-400">Select Items</p>
        <div class="space-y-2 rounded-xl border border-slate-800/80 bg-slate-950/70 p-3 max-h-56 overflow-y-auto">
          {% for item in items %}
          <label class="flex items-start gap-3 rounded-lg border border-transparent px-2 py-1 hover:border-emerald-400/40">
            <input type="checkbox" name="quotation_request_items" value="{{ item.id }}" class="mt-1 h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-400 focus:ring-emerald-400/60">
            <div>
              <p class="text-sm font-semibold text-slate-100">#{{ item.id }} · {{ item.details or item.lift_type or 'Opportunity Item' }}</p>
              <p class="text-xs text-slate-500">Qty: {{ item.quantity or 1 }}{% if item.lift_type %} · {{ item.lift_type }}{% endif %}{% if item.cabin_finish %} · {{ item.cabin_finish }}{% endif %}</p>
            </div>
          </label>
          {% endfor %}
          {% if not items %}
          <p class="text-sm text-slate-400">Add items to this opportunity to create a request.</p>
          {% endif %}
        </div>
      </div>
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Linked CRF</label>
          <select name="linked_crf_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Select form (optional)</option>
            {% for form in client_requirement_forms %}
            <option value="{{ form.id }}">CRF #{{ form.id }} · V{{ form.version }}{% if form.template %} · {{ form.template.name }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Notes</label>
          <textarea name="quotation_request_notes" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Delivery timelines, discounts, special asks..."></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer" {% if not items %}disabled{% endif %}>Create Request</button>
      </div>
    </form>
  </div>
</div>

<div id="negotiationModal" data-modal-id="negotiationModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="modal-panel w-full max-w-xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Negotiation / Discount</p>
        <h3 class="text-lg font-semibold text-slate-100">Request Negotiation</h3>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close negotiation modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5">
      {{ csrf_field() }}
      <input type="hidden" name="form_action" value="quotation_request_negotiation">
      <input type="hidden" name="quotation_request_id" value="" data-negotiation-request>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Reason / Details</label>
        <textarea name="negotiation_reason" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Discount requested, scope change, competition pricing..."></textarea>
      </div>
      <label class="flex items-center gap-3 rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100">
        <input type="checkbox" name="move_to_negotiation" class="h-4 w-4 rounded border-slate-700 bg-slate-900 text-emerald-400 focus:ring-emerald-400/60" checked>
        <span class="text-xs uppercase tracking-wide text-slate-300">Move opportunity stage to Negotiation</span>
      </label>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Negotiation Log</button>
      </div>
    </form>
  </div>
</div>

{% with
  modal_id='salesDesignTaskModal',
  modal_title='Create Sales Query Task',
  submit_label='Create Task',
  projects=design_projects,
  users=design_users,
  default_task_type='sales_query',
  default_origin_type='sales',
  default_origin_id=opportunity.id,
  default_origin_reference=opportunity.title,
  default_project_id=opportunity.project_id,
  default_project_name=opportunity.related_project or opportunity.title,
  default_description=opportunity.title,
  show_origin_fields=False,
  default_priority='medium'
%}
  {% include 'partials/design_task_modal.html' %}
{% endwith %}

<style>
  .modal-backdrop {
    opacity: 0;
    transition: opacity 200ms ease, visibility 200ms ease;
  }

  .modal-backdrop.is-open {
    opacity: 1;
  }

  .modal-panel {
    transform: translateY(12px);
    opacity: 0;
    transition: opacity 220ms ease, transform 220ms ease;
  }

  .modal-backdrop.is-open .modal-panel {
    transform: translateY(0);
    opacity: 1;
  }

  @keyframes fadeSlideIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-slide-row {
    animation: fadeSlideIn 260ms ease;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabTriggers = Array.from(document.querySelectorAll('.tab-trigger'));
    const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));
    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const activeClasses = ['bg-emerald-500/20', 'border-emerald-400/40', 'text-emerald-100'];
    const inactiveClasses = ['bg-transparent', 'border-transparent', 'text-slate-300'];

    function setActiveTab(tab) {
      tabTriggers.forEach((trigger) => {
        const isActive = trigger.dataset.tab === tab;
        trigger.classList.toggle('tab-active', isActive);
        if (isActive) {
          inactiveClasses.forEach((cls) => trigger.classList.remove(cls));
          activeClasses.forEach((cls) => trigger.classList.add(cls));
        } else {
          activeClasses.forEach((cls) => trigger.classList.remove(cls));
          inactiveClasses.forEach((cls) => trigger.classList.add(cls));
        }
      });

      tabPanels.forEach((panel) => {
        const isActive = panel.dataset.tabPanel === tab;
        if (isActive) {
          panel.classList.remove('hidden');
          requestAnimationFrame(() => {
            panel.classList.add('is-active');
          });
        } else {
          panel.classList.remove('is-active');
          if (panel.classList.contains('hidden')) {
            return;
          }
          if (prefersReducedMotion) {
            panel.classList.add('hidden');
            return;
          }
          const handleTransition = (event) => {
            if (event.target !== panel || event.propertyName !== 'opacity') {
              return;
            }
            if (panel.classList.contains('is-active')) {
              return;
            }
            panel.classList.add('hidden');
          };
          panel.addEventListener('transitionend', handleTransition, { once: true });
        }
      });
    }

    const defaultTab = document.querySelector('.tab-trigger.tab-active');
    if (defaultTab) {
      setActiveTab(defaultTab.dataset.tab);
    }

    tabTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => setActiveTab(trigger.dataset.tab));
    });

    const clientModal = document.getElementById('clientDetailModal');
    const clientForm = document.getElementById('clientInlineForm');
    const clientNameTargets = document.querySelectorAll('[data-client-name]');
    const clientNameDisplay = clientModal?.querySelector('[data-client-name-display]');
    const clientContactDisplay = clientModal?.querySelector('[data-client-contact-display]');
    const clientEmailDisplay = clientModal?.querySelector('[data-client-email-display]');
    const clientPhoneDisplay = clientModal?.querySelector('[data-client-phone-display]');
    const clientAddressDisplay = clientModal?.querySelector('[data-client-address-display]');
    const clientCityStateDisplay = clientModal?.querySelector('[data-client-city-state-display]');
    const clientGstDisplay = clientModal?.querySelector('[data-client-gst-display]');
    const clientPanDisplay = clientModal?.querySelector('[data-client-pan-display]');
    const clientCreatedDisplay = clientModal?.querySelector('[data-client-created-display]');
    const clientDescriptionDisplay = clientModal?.querySelector('[data-client-description-display]');
    const clientError = clientModal?.querySelector('[data-client-error]');
    const clientEditToggle = clientModal?.querySelector('[data-client-edit-toggle]');
    const clientEditCancel = clientModal?.querySelector('[data-client-edit-cancel]');
    const clientSaveButton = clientModal?.querySelector('[data-client-save]');
    const clientViewSection = clientModal?.querySelector('[data-client-view]');
    const clientLoading = clientModal?.querySelector('[data-client-loading]');
    const clientMissing = clientModal?.querySelector('[data-client-missing]');

    function toggleModal(modalId, open) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      if (open) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        requestAnimationFrame(() => modal.classList.add('is-open'));
        document.body.classList.add('overflow-hidden');
      } else {
        modal.classList.remove('is-open');
        const handleClose = (event) => {
          if (event.target !== modal) return;
          modal.classList.remove('flex');
          modal.classList.add('hidden');
          modal.removeEventListener('transitionend', handleClose);
        };
        modal.addEventListener('transitionend', handleClose, { once: true });
        setTimeout(() => {
          if (!modal.classList.contains('is-open')) {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
          }
        }, 260);
        document.body.classList.remove('overflow-hidden');
      }
    }

    const linkedPanel = document.querySelector('[data-linked-panel]');
    const linkedToggle = document.querySelector('[data-linked-toggle]');
    if (linkedPanel && linkedToggle) {
      linkedToggle.addEventListener('click', () => {
        linkedPanel.classList.toggle('hidden');
        linkedToggle.classList.toggle('rotate-180');
      });
    }

    const linkFormPanel = document.querySelector('[data-link-form-panel]');
    const linkFormToggles = document.querySelectorAll('[data-link-form-toggle]');
    linkFormToggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        if (!linkFormPanel) return;
        linkFormPanel.classList.toggle('hidden');
      });
    });

    document.querySelectorAll('[data-auto-submit-file]').forEach((input) => {
      input.addEventListener('change', () => {
        if (input.files && input.files.length > 0) {
          input.closest('form')?.submit();
        }
      });
    });

    document.querySelectorAll('[data-request-toggle]').forEach((button) => {
      const container = button.closest('.rounded-xl');
      const panel = container?.querySelector('[data-request-panel]');
      if (!panel) return;
      button.addEventListener('click', () => {
        panel.classList.toggle('hidden');
      });
    });

    const negotiationModal = document.getElementById('negotiationModal');
    const negotiationRequestField = negotiationModal?.querySelector('[data-negotiation-request]');
    document.querySelectorAll('[data-negotiation-open]').forEach((button) => {
      button.addEventListener('click', () => {
        if (negotiationRequestField) {
          negotiationRequestField.value = button.dataset.requestId || '';
        }
        toggleModal('negotiationModal', true);
      });
    });

    const itemModal = document.getElementById('opportunityItemModal');
    const itemForm = document.getElementById('itemModalForm');
    const itemTitle = itemModal?.querySelector('[data-item-modal-title]');
    const itemActionField = itemModal?.querySelector('[data-item-form-action]');
    const itemIdField = itemModal?.querySelector('[data-item-id-field]');
    const itemStructureInput = itemModal?.querySelector('input[name="structure_required"]');
    const itemLiftTypeInput = itemModal?.querySelector('input[name="lift_type"]');
    const itemDoorTypeInput = itemModal?.querySelector('input[name="door_type"]');
    const itemFloorsInput = itemModal?.querySelector('input[name="floors"]');
    const itemQtyInput = itemModal?.querySelector('input[name="item_quantity"]');
    const itemCabinFinishInput = itemModal?.querySelector('input[name="cabin_finish"]');
    const itemValueInput = itemModal?.querySelector('input[name="item_value"]');
    const itemDetailsInput = itemModal?.querySelector('textarea[name="details"]');

    function openItemModal(mode = 'create', data = {}) {
      if (!itemModal || !itemForm) return;
      const isEdit = mode === 'edit';
      if (itemTitle) itemTitle.textContent = isEdit ? 'Edit Item' : 'Add Item';
      if (itemActionField) itemActionField.value = isEdit ? 'update_item' : 'create_item';
      if (itemIdField) itemIdField.value = isEdit ? data.id || '' : '';
      if (itemStructureInput) itemStructureInput.checked = data.structure === 'true';
      if (itemLiftTypeInput) itemLiftTypeInput.value = data.liftType || '';
      if (itemDoorTypeInput) itemDoorTypeInput.value = data.doorType || '';
      if (itemFloorsInput) itemFloorsInput.value = data.floors || '';
      if (itemQtyInput) itemQtyInput.value = data.quantity || 1;
      if (itemCabinFinishInput) itemCabinFinishInput.value = data.cabinFinish || '';
      if (itemValueInput) itemValueInput.value = data.value !== undefined ? data.value : '';
      if (itemDetailsInput) itemDetailsInput.value = data.details || '';
      toggleModal('opportunityItemModal', true);
      itemLiftTypeInput?.focus();
    }

    document.querySelector('[data-item-create]')?.addEventListener('click', () => openItemModal('create'));

    document.querySelectorAll('[data-item-edit]').forEach((button) => {
      button.addEventListener('click', () => {
        openItemModal('edit', {
          id: button.dataset.itemId,
          structure: button.dataset.itemStructure,
          liftType: button.dataset.itemLiftType,
          doorType: button.dataset.itemDoorType,
          floors: button.dataset.itemFloors,
          quantity: button.dataset.itemQuantity,
          cabinFinish: button.dataset.itemCabinFinish,
          details: button.dataset.itemDetails,
          value: button.dataset.itemValue,
        });
      });
    });

    const activityModal = document.getElementById('activityModal');
    const activityForm = document.getElementById('activityForm');
    const activityTitle = activityModal?.querySelector('[data-activity-modal-title]');
    const activityActionField = activityModal?.querySelector('[data-activity-form-action]');
    const activityIdField = activityModal?.querySelector('[data-activity-id]');
    const activityTypeInput = activityModal?.querySelector('select[name="activity_type"]');
    const activitySubjectInput = activityModal?.querySelector('input[name="activity_subject"]');
    const activityDateInput = activityModal?.querySelector('input[name="activity_date"]');
    const activityTimeInput = activityModal?.querySelector('input[name="activity_time"]');
    const activityReminderInput = activityModal?.querySelector('select[name="reminder_option"]');
    const activityNotesInput = activityModal?.querySelector('textarea[name="activity_notes"]');
    const activitySubmitButton = activityModal?.querySelector('[data-activity-submit]');
    const activityTypeLabels = {
      call: 'Call',
      meeting: 'Meeting',
      site_visit: 'Site Visit',
      email: 'Email',
      whatsapp: 'WhatsApp',
      callback: 'Callback',
    };

    function openActivityModal(mode = 'create', data = {}) {
      if (!activityModal || !activityForm) return;
      const isEdit = mode === 'edit';
      if (activityTitle) activityTitle.textContent = isEdit ? 'Edit Activity' : 'Create Activity';
      if (activitySubmitButton) activitySubmitButton.textContent = isEdit ? 'Save Activity' : 'Create Activity';
      if (activityActionField) activityActionField.value = isEdit ? 'update_activity' : 'schedule_activity';
      if (activityIdField) activityIdField.value = isEdit ? data.id || '' : '';
      if (activityTypeInput) activityTypeInput.value = data.type || 'meeting';
      if (activitySubjectInput) activitySubjectInput.value = data.subject || '';
      if (activityDateInput) activityDateInput.value = data.date || '';
      if (activityTimeInput) activityTimeInput.value = data.time || '';
      if (activityReminderInput) activityReminderInput.value = data.reminder || '';
      if (activityNotesInput) activityNotesInput.value = data.notes || '';
      toggleModal('activityModal', true);
      activityTypeInput?.focus();
    }

    document.querySelectorAll('[data-activity-create]').forEach((button) => {
      button.addEventListener('click', () => openActivityModal('create'));
    });

    document.querySelectorAll('[data-activity-edit]').forEach((button) => {
      button.addEventListener('click', () => {
        const {
          activityId,
          activityType,
          activitySubject,
          activityDate,
          activityTime,
          activityReminder,
          activityNotes,
        } = button.dataset;
        openActivityModal('edit', {
          id: activityId,
          type: activityType,
          subject: activitySubject,
          date: activityDate,
          time: activityTime,
          reminder: activityReminder,
          notes: activityNotes,
        });
      });
    });

    const logActivityModal = document.getElementById('logActivityModal');
    const logActivityForm = document.getElementById('logActivityForm');
    const logActivityIdField = logActivityModal?.querySelector('[data-log-activity-id]');
    const logActivitySubject = logActivityModal?.querySelector('[data-log-activity-subject]');
    const logActivityType = logActivityModal?.querySelector('[data-log-activity-type]');
    const logActivitySchedule = logActivityModal?.querySelector('[data-log-activity-schedule]');
    const logOutcomeInput = logActivityModal?.querySelector('select[name="outcome"]');
    const logDetailsInput = logActivityModal?.querySelector('textarea[name="log_details"]');
    const nextActionTypeInput = logActivityModal?.querySelector('select[name="next_action_type"]');
    const nextActionSubjectInput = logActivityModal?.querySelector('input[name="next_action_subject"]');
    const nextActionDateInput = logActivityModal?.querySelector('input[name="next_action_date"]');
    const nextActionTimeInput = logActivityModal?.querySelector('input[name="next_action_time"]');
    const nextActionReminderInput = logActivityModal?.querySelector('select[name="next_action_reminder"]');
    const nextActionNotesInput = logActivityModal?.querySelector('textarea[name="next_action_notes"]');
    const nextActionFields = [
      nextActionSubjectInput,
      nextActionDateInput,
      nextActionTimeInput,
      nextActionReminderInput,
      nextActionNotesInput,
    ];

    function setNextActionFieldsEnabled(hasType) {
      nextActionFields.forEach((input) => {
        if (!input) return;
        input.disabled = !hasType;
        const wrapper = input.closest('[data-next-action-field]');
        if (wrapper) {
          wrapper.classList.toggle('opacity-50', !hasType);
        }
      });
    }

    function setNextActionSubjectFromType(typeLabel) {
      if (!nextActionSubjectInput) return;
      const allowAutofill = nextActionSubjectInput.dataset.autofill !== 'false';
      if (!allowAutofill && nextActionSubjectInput.value.trim() !== '') return;
      const baseText = (logActivitySubject?.textContent || '').trim() || typeLabel || 'Next action';
      nextActionSubjectInput.value = `Follow-up: ${baseText}`;
      nextActionSubjectInput.dataset.autofill = 'true';
    }

    function resetNextActionFields() {
      if (nextActionTypeInput) nextActionTypeInput.value = '';
      if (nextActionSubjectInput) {
        nextActionSubjectInput.value = '';
        nextActionSubjectInput.dataset.autofill = 'true';
      }
      if (nextActionDateInput) nextActionDateInput.value = '';
      if (nextActionTimeInput) nextActionTimeInput.value = '';
      if (nextActionReminderInput) nextActionReminderInput.value = '';
      if (nextActionNotesInput) nextActionNotesInput.value = '';
      setNextActionFieldsEnabled(false);
    }

    function handleNextActionTypeChange() {
      const hasType = Boolean(nextActionTypeInput?.value);
      setNextActionFieldsEnabled(hasType);
      if (hasType && nextActionTypeInput) {
        const selectedLabel =
          activityTypeLabels[nextActionTypeInput.value] ||
          nextActionTypeInput.options[nextActionTypeInput.selectedIndex]?.text ||
          'Next action';
        setNextActionSubjectFromType(selectedLabel);
      }
    }

    function openLogActivityModal(data = {}) {
      if (!logActivityModal || !logActivityForm) return;
      if (logActivityIdField) logActivityIdField.value = data.id || '';
      if (logActivitySubject) logActivitySubject.textContent = data.subject || 'Activity';
      if (logActivityType) logActivityType.textContent = data.typeLabel || data.type || '—';
      if (logActivitySchedule) logActivitySchedule.textContent = data.schedule || 'Schedule not set';
      if (logOutcomeInput) logOutcomeInput.value = data.outcome || '';
      if (logDetailsInput) logDetailsInput.value = data.details || '';
      resetNextActionFields();
      toggleModal('logActivityModal', true);
      logOutcomeInput?.focus();
    }

    document.querySelectorAll('[data-activity-log]').forEach((button) => {
      button.addEventListener('click', () => {
        const { activityId, activitySubject, activityType, activityDate, activityTime } = button.dataset;
        const typeLabel = activityTypeLabels[activityType] || (activityType || 'Activity').replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        const scheduleLabel = activityDate
          ? `${activityDate}${activityTime ? ` @ ${activityTime}` : ''}`
          : 'Schedule not set';
        openLogActivityModal({
          id: activityId,
          subject: activitySubject || 'Activity',
          type: activityType,
          typeLabel,
          schedule: scheduleLabel,
        });
      });
    });

    nextActionTypeInput?.addEventListener('change', handleNextActionTypeChange);
    nextActionSubjectInput?.addEventListener('input', () => {
      if (nextActionSubjectInput) {
        nextActionSubjectInput.dataset.autofill = 'false';
      }
    });
    setNextActionFieldsEnabled(Boolean(nextActionTypeInput?.value));

    const crfModal = document.getElementById('clientRequirementModal');
    const crfTitle = crfModal?.querySelector('[data-crf-modal-title]');
    const crfStatus = crfModal?.querySelector('[data-crf-modal-status]');
    const crfVersion = crfModal?.querySelector('[data-crf-modal-version]');
    const crfCreated = crfModal?.querySelector('[data-crf-modal-created]');
    const crfAuthor = crfModal?.querySelector('[data-crf-modal-author]');
    const crfLink = crfModal?.querySelector('[data-crf-modal-link]');

    document.querySelectorAll('[data-crf-open]').forEach((button) => {
      button.addEventListener('click', () => {
        if (!crfModal) return;
        if (crfTitle) crfTitle.textContent = button.dataset.crfTitle || 'Client Requirements';
        if (crfStatus) crfStatus.textContent = button.dataset.crfStatus || 'Draft';
        if (crfVersion) crfVersion.textContent = button.dataset.crfVersion || '—';
        if (crfCreated) crfCreated.textContent = button.dataset.crfCreated || '—';
        if (crfAuthor) crfAuthor.textContent = button.dataset.crfAuthor || '—';
        if (crfLink) crfLink.href = button.dataset.crfLink || '#';
        toggleModal('clientRequirementModal', true);
      });
    });

    crfModal?.querySelectorAll('[data-crf-close]').forEach((closeButton) => {
      closeButton.addEventListener('click', () => toggleModal('clientRequirementModal', false));
    });

    function formatCityState(city, state) {
      if (city && state) return `${city}, ${state}`;
      return city || state || '';
    }

    function syncClientFields() {
      if (!clientModal) return;
      const {
        clientName,
        clientContact,
        clientEmail,
        clientPhone,
        clientAddress,
        clientCity,
        clientState,
        clientGst,
        clientPan,
        clientCreated,
        clientDescription,
      } = clientModal.dataset;
      const nameValue = clientName || 'Unassigned';
      const emailValue = clientEmail || 'Not provided';
      const phoneValue = clientPhone || 'Not provided';
      const descriptionValue = clientDescription || 'No notes added yet.';
      const contactValue = clientContact || 'Not provided';
      const addressValue = clientAddress || 'Not provided';
      const cityStateValue = formatCityState(clientCity, clientState) || 'Not provided';
      const gstValue = clientGst || 'Not provided';
      const panValue = clientPan || 'Not provided';
      const createdValue = clientCreated
        ? new Date(clientCreated).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })
        : 'Not available';

      if (clientNameDisplay) clientNameDisplay.textContent = nameValue;
      if (clientContactDisplay) clientContactDisplay.textContent = contactValue;
      if (clientEmailDisplay) clientEmailDisplay.textContent = emailValue;
      if (clientPhoneDisplay) clientPhoneDisplay.textContent = phoneValue;
      if (clientAddressDisplay) clientAddressDisplay.textContent = addressValue;
      if (clientCityStateDisplay) clientCityStateDisplay.textContent = cityStateValue;
      if (clientGstDisplay) clientGstDisplay.textContent = gstValue;
      if (clientPanDisplay) clientPanDisplay.textContent = panValue;
      if (clientCreatedDisplay) clientCreatedDisplay.textContent = createdValue;
      if (clientDescriptionDisplay) clientDescriptionDisplay.textContent = descriptionValue;

      clientNameTargets.forEach((target) => {
        target.textContent = nameValue;
      });

      if (clientForm) {
        const nameInput = clientForm.querySelector('input[name="display_name"]');
        const emailInput = clientForm.querySelector('input[name="email"]');
        const phoneInput = clientForm.querySelector('input[name="phone"]');
        const descriptionInput = clientForm.querySelector('textarea[name="description"]');
        if (nameInput) nameInput.value = clientName || '';
        if (emailInput) emailInput.value = clientEmail || '';
        if (phoneInput) phoneInput.value = clientPhone || '';
        if (descriptionInput) descriptionInput.value = clientDescription || '';
      }
    }

    function showClientView() {
      if (!clientModal) return;
      syncClientFields();
      hideClientMissing();
      clientForm?.classList.add('hidden');
      clientViewSection?.classList.remove('hidden');
      clientError?.classList.add('hidden');
      if (clientError) clientError.textContent = '';
      clientSaveButton?.classList.add('hidden');
      clientEditCancel?.classList.add('hidden');
      clientEditToggle?.classList.remove('hidden');
    }

    function showClientEdit() {
      if (!clientModal) return;
      syncClientFields();
      clientViewSection?.classList.add('hidden');
      clientForm?.classList.remove('hidden');
      clientError?.classList.add('hidden');
      clientSaveButton?.classList.remove('hidden');
      clientEditCancel?.classList.remove('hidden');
      clientEditToggle?.classList.add('hidden');
      const firstEditable = clientForm?.querySelector('input, textarea');
      if (firstEditable) firstEditable.focus();
    }

    function updateClientModalFromSource(source) {
      if (!clientModal || !source?.dataset) return;
      const { clientId } = source.dataset;
      if (clientId) clientModal.dataset.clientId = clientId;
    }

    function setClientLoading(isLoading) {
      if (!clientModal) return;
      if (clientLoading) {
        clientLoading.classList.toggle('hidden', !isLoading);
      }
      if (clientViewSection) {
        clientViewSection.classList.toggle('opacity-50', Boolean(isLoading));
      }
    }

    function showClientMissing(message) {
      if (clientMissing) {
        clientMissing.textContent = message || 'Client record not found. Please check Sales → Clients.';
        clientMissing.classList.remove('hidden');
      }
      clientViewSection?.classList.add('hidden');
    }

    function hideClientMissing() {
      clientMissing?.classList.add('hidden');
      clientViewSection?.classList.remove('hidden');
    }

    function applyClientData(clientData) {
      if (!clientModal || !clientData) return;
      clientModal.dataset.clientName = clientData.display_name || '';
      clientModal.dataset.clientContact = clientData.contact_person || '';
      clientModal.dataset.clientEmail = clientData.email || '';
      clientModal.dataset.clientPhone = clientData.phone || clientData.mobile || '';
      clientModal.dataset.clientAddress = clientData.address || '';
      clientModal.dataset.clientCity = clientData.city || '';
      clientModal.dataset.clientState = clientData.state || '';
      clientModal.dataset.clientGst = clientData.gst || '';
      clientModal.dataset.clientPan = clientData.pan || '';
      clientModal.dataset.clientCreated = clientData.created_at || '';
      clientModal.dataset.clientDescription = clientData.remarks || clientData.description || '';
    }

    async function loadClientDetails(clientId) {
      if (!clientId || !clientModal) return;
      setClientLoading(true);
      hideClientMissing();
      try {
        const response = await fetch(`/sales/clients/${clientId}/summary`, {
          headers: { Accept: 'application/json' },
        });

        if (response.status === 404) {
          showClientMissing();
          return;
        }

        const data = await response.json();
        if (!response.ok || !data.success || !data.client) {
          throw new Error(data.message || 'Unable to load client details.');
        }

        applyClientData(data.client);
        showClientView();
      } catch (error) {
        console.error('Unable to load client details', error);
        showClientMissing(error.message || 'Unable to load client details.');
      } finally {
        setClientLoading(false);
      }
    }

    document.querySelectorAll('[data-modal-open]').forEach((button) => {
      button.addEventListener('click', () => {
        if (button.dataset.modalOpen === 'clientDetailModal') {
          updateClientModalFromSource(button);
          loadClientDetails(button.dataset.clientId);
        }
        toggleModal(button.dataset.modalOpen, true);
      });
    });

    document.querySelectorAll('[data-modal-close]').forEach((button) => {
      const targetId = button.dataset.modalClose || button.closest('[data-modal-id]')?.dataset.modalId || 'editOpportunityModal';
      button.addEventListener('click', () => toggleModal(targetId, false));
    });

    document.querySelectorAll('[data-modal-id]').forEach((modal) => {
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          toggleModal(modal.dataset.modalId || modal.id, false);
        }
      });
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        document.querySelectorAll('[data-modal-id].flex').forEach((modal) => {
          toggleModal(modal.dataset.modalId || modal.id, false);
        });
      }
    });

    if (clientEditToggle && clientModal) {
      clientEditToggle.addEventListener('click', () => showClientEdit());
    }

    if (clientEditCancel) {
      clientEditCancel.addEventListener('click', () => showClientView());
    }

    if (clientForm) {
      clientForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!clientForm.action) return;
        if (clientError) {
          clientError.textContent = '';
          clientError.classList.add('hidden');
        }
        const formData = new FormData(clientForm);
        fetch(clientForm.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success || !data.client) {
              throw new Error(data.message || 'Could not update client.');
            }
            if (clientModal) {
              clientModal.dataset.clientName = data.client.display_name || '';
              clientModal.dataset.clientEmail = data.client.email || '';
              clientModal.dataset.clientPhone = data.client.phone || '';
              clientModal.dataset.clientDescription = data.client.description || '';
            }
            syncClientFields();
            showClientView();
        })
          .catch((error) => {
            if (clientError) {
              clientError.textContent = error.message || 'Unable to update client right now.';
              clientError.classList.remove('hidden');
            }
          });
      });
    }

    const closeModal = document.getElementById('closeOpportunityModal');
    if (closeModal) {
      const outcomeInputs = closeModal.querySelectorAll('[data-close-outcome]');
      const lostReasonBlock = closeModal.querySelector('[data-lost-reason]');
      const projectSection = closeModal.querySelector('[data-project-section]');
      const quotationModeInputs = closeModal.querySelectorAll('[data-quotation-mode]');
      const quotationExisting = closeModal.querySelector('[data-quotation-existing]');
      const quotationUpload = closeModal.querySelector('[data-quotation-upload]');
      const quotationExistingSelect = closeModal.querySelector('select[name="final_quotation_file_id"]');
      const quotationUploadInput = closeModal.querySelector('[data-final-quotation-input]');

      function syncOutcomeFields() {
        const selected = Array.from(outcomeInputs).find((input) => input.checked)?.value || 'won';
        const isLost = selected === 'lost';
        const isWon = selected === 'won';
        if (lostReasonBlock) {
          lostReasonBlock.classList.toggle('hidden', !isLost);
        }
        if (projectSection) {
          projectSection.classList.toggle('hidden', !isWon);
          projectSection.classList.toggle('opacity-50', !isWon);
        }
      }

      function syncQuotationMode() {
        const selected = Array.from(quotationModeInputs).find((input) => input.checked)?.value || 'existing';
        const usingExisting = selected === 'existing';
        if (quotationExisting) {
          quotationExisting.classList.toggle('hidden', !usingExisting);
        }
        if (quotationUpload) {
          quotationUpload.classList.toggle('hidden', usingExisting);
        }
        if (quotationExistingSelect) {
          quotationExistingSelect.disabled = !usingExisting;
          quotationExistingSelect.required = usingExisting;
        }
        if (quotationUploadInput) {
          quotationUploadInput.disabled = usingExisting;
          quotationUploadInput.required = !usingExisting;
        }
      }

      outcomeInputs.forEach((input) => input.addEventListener('change', syncOutcomeFields));
      quotationModeInputs.forEach((input) => input.addEventListener('change', syncQuotationMode));

      const hasExistingQuotes = Boolean(quotationExistingSelect && quotationExistingSelect.options.length > 0);
      if (!hasExistingQuotes) {
        const uploadRadio = Array.from(quotationModeInputs).find((input) => input.value === 'upload');
        if (uploadRadio) uploadRadio.checked = true;
      }

      syncOutcomeFields();
      syncQuotationMode();
    }

    const fileInput = document.getElementById('opportunityFileInput');
    const fileLabel = document.querySelector('[data-file-label]');
    if (fileInput && fileLabel) {
      fileInput.addEventListener('change', () => {
        const fileName = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
        fileLabel.textContent = fileName || 'Drag and drop files here or click to browse.';
      });
    }
  });
</script>
{% endblock %}
