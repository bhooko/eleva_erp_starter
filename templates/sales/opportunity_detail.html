{% extends "base.html" %}
{% block title %}Sales · Opportunity · {{ opportunity.title }}{% endblock %}
{% block content %}
<div class="mb-6 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
  <div>
    <p class="text-sm text-slate-400">Opportunity · {{ pipeline_config.label if pipeline_config else pipeline_key|capitalize }}</p>
    <h2 class="text-3xl font-semibold tracking-tight">{{ opportunity.title }}</h2>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-slate-400">
      {% if can_see_commercial %}
        <span class="inline-flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> {{ opportunity.display_amount }}</span>
      {% else %}
        <span class="inline-flex items-center gap-2 text-[11px] italic text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7l9-4 9 4-9 4-9-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 10l-9 4-9-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 13l9 4 9-4"/></svg> Amount restricted</span>
      {% endif %}
      <span>Stage: {{ opportunity.stage }}</span>
      {% if opportunity.temperature %}
        {% set label, badge = opportunity.badge_variant %}
        <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ badge }}">{{ label or opportunity.temperature|capitalize }}</span>
      {% endif %}
    </div>
  </div>
  <div class="flex items-center gap-3">
    {% with default_pipeline_key=pipeline_key, opportunity_clients=clients, default_client_id=opportunity.client.id if opportunity.client else None %}
      {% include "sales/_opportunity_quick_create.html" %}
    {% endwith %}
    <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key=pipeline_key) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-800/80 bg-slate-900/70 text-sm text-slate-200 hover:bg-slate-800/80">Back to Pipeline</a>
  </div>
</div>

<div class="mb-6 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-5 shadow-xl card-hover-lift fade-in-up">
  <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="flex-1">
      <div class="text-xs uppercase tracking-wide text-slate-500">Opportunity Details</div>
      <dl class="mt-3 grid grid-cols-1 gap-x-10 gap-y-4 text-sm text-slate-300 sm:grid-cols-2">
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Stage</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.stage }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Amount</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if can_see_commercial %}
              {{ opportunity.display_amount }}
            {% else %}
              <span class="text-xs text-slate-500 italic">Restricted</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Probability</dt>
          <dd class="mt-1 font-medium text-slate-100">
            {% if opportunity.probability is not none %}
              {{ opportunity.probability }}%
            {% else %}
              —
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Expected Close</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.expected_close_date.strftime('%d %b %Y') if opportunity.expected_close_date else 'Not set' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Owner</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.owner.display_name if opportunity.owner else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Client</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.client.display_name if opportunity.client else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Related Project</dt>
          <dd class="mt-1 font-medium text-slate-100">{{ opportunity.related_project or '—' }}</dd>
        </div>
        {% set temperature_label, temperature_badge = opportunity.badge_variant %}
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Temperature</dt>
          <dd class="mt-1">
            {% if opportunity.temperature %}
              <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ temperature_badge }}">{{ temperature_label or opportunity.temperature|capitalize }}</span>
            {% else %}
              <span class="text-slate-400">Not set</span>
            {% endif %}
          </dd>
        </div>
      </dl>
    </div>
    <div class="flex items-start gap-2 md:flex-col">
      {% if opportunity.project_id %}
        <a href="{{ url_for('project_detail', project_id=opportunity.project_id) }}" class="inline-flex items-center gap-2 rounded-xl border border-blue-400/50 bg-blue-500/20 px-4 py-2 text-sm font-semibold text-blue-100 hover:bg-blue-500/30 btn-shimmer">View Project</a>
      {% else %}
        {% if opportunity.stage and opportunity.stage.lower() == 'closed won' and current_user.can_view_module('operations') %}
          <form action="{{ url_for('sales_opportunity_convert_to_project', opportunity_id=opportunity.id) }}" method="post" style="display: inline-block;">
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/50 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Convert to Project</button>
          </form>
        {% endif %}
      {% endif %}
      <button type="button" data-modal-open="editOpportunityModal" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Edit Opportunity</button>
    </div>
  </div>
  <div class="mt-4 rounded-xl border border-slate-800/60 bg-slate-950/50 p-4">
    <p class="text-xs uppercase tracking-wide text-slate-500">Description</p>
    <p class="mt-2 whitespace-pre-line text-sm text-slate-300">{{ opportunity.description or 'No description added yet.' }}</p>
  </div>
</div>

<div class="mb-8 bg-slate-900/60 border border-slate-800/80 rounded-2xl px-6 py-4 shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 80ms;">
  <div class="text-xs uppercase tracking-wide text-slate-500 mb-3">Stage Progress</div>
  <div class="flex items-center gap-3 overflow-x-auto pb-1">
    {% for stage_option in stages %}
      {% set is_current = stage_option == opportunity.stage %}
      {% set is_complete = loop.index0 < current_stage_index %}
      {% set connector_state = 'is-complete' if loop.index0 < current_stage_index else ('is-progress' if loop.index0 == current_stage_index else '') %}
      <div class="flex items-center gap-3">
        <div class="flex flex-col items-center text-center">
          <div title="{{ stage_option }}" class="stage-node w-9 h-9 rounded-full flex items-center justify-center text-xs font-semibold {{ 'is-active' if is_current else '' }} {{ 'is-complete' if is_complete else '' }}">{{ loop.index }}</div>
          <span class="mt-2 text-[11px] stage-label {{ 'is-active' if is_current else '' }}">{{ stage_option }}</span>
        </div>
        {% if not loop.last %}
          <div class="stage-connector {{ connector_state }}"></div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="grid gap-6 xl:grid-cols-[1.2fr_1fr]">
  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 120ms;">
      <div class="px-6 pt-5">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <button type="button" data-tab="timeline" class="tab-trigger tab-active inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-emerald-100 transition">Timeline</button>
          <button type="button" data-tab="comments" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Comments</button>
          <button type="button" data-tab="files" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Files</button>
          <button type="button" data-tab="activities" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Activities</button>
          <button type="button" data-tab="items" class="tab-trigger inline-flex items-center gap-2 rounded-xl border border-transparent bg-transparent px-4 py-2 text-sm font-semibold text-slate-300 transition hover:text-emerald-100">Items</button>
        </div>
      </div>
      <div class="px-6 py-6">
        <div data-tab-panel="timeline" class="motion-panel is-active">
          <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="mb-6 space-y-3">
            <input type="hidden" name="form_action" value="add_note">
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-[1fr_auto]">
              <input type="text" name="note_title" placeholder="Add quick update" class="rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Add Note</button>
            </div>
            <textarea name="note_body" rows="3" placeholder="Meeting outcome, blockers or next steps." class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60"></textarea>
          </form>
          {% if activities %}
          <ol class="relative ml-3 space-y-6 border-l border-slate-800/80">
            {% for activity in activities %}
            <li class="ml-6">
              <span class="absolute -left-3 flex h-6 w-6 items-center justify-center rounded-full border border-emerald-400/40 bg-emerald-500/20 text-xs font-semibold text-emerald-200">•</span>
              <div class="rounded-xl border border-slate-800/80 bg-slate-900/80 px-4 py-3">
                <div class="flex items-center justify-between text-sm">
                  <p class="font-semibold text-slate-100">{{ activity.title }}</p>
                  <span class="text-xs text-slate-500">{{ activity.created_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% if activity.notes %}
                <p class="mt-2 text-sm text-slate-300 whitespace-pre-line">{{ activity.notes }}</p>
                {% endif %}
                {% if activity.actor %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">{{ 'Admin · ' if activity.actor.is_admin else 'User · ' }}{{ activity.actor.display_name }}</p>
                {% else %}
                <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">System</p>
                {% endif %}
              </div>
            </li>
            {% endfor %}
          </ol>
          {% else %}
          <div class="py-16 text-center text-slate-500">No updates yet. Start logging interactions.</div>
          {% endif %}
        </div>

        <div data-tab-panel="comments" class="motion-panel hidden">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Capture internal comments about this deal to keep the team aligned.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-3">
              <input type="hidden" name="form_action" value="add_comment">
              <textarea name="comment_body" rows="4" placeholder="Share an update with your team." class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required></textarea>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Comment</button>
              </div>
            </form>
            {% if comments %}
            <ul class="space-y-4">
              {% for comment in comments %}
              <li class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4">
                <p class="text-sm text-slate-200 whitespace-pre-line">{{ comment.body }}</p>
                <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
                  <span>{{ comment.author.display_name if comment.author else 'System' }}</span>
                  <span>{{ comment.created_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No comments added yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="files" class="motion-panel hidden">
          <div class="space-y-4">
            <p class="text-sm text-slate-300">Attach proposals, contracts or supporting documents for quick access.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" enctype="multipart/form-data" class="space-y-3">
              <input type="hidden" name="form_action" value="upload_file">
              <div class="rounded-xl border border-dashed border-slate-700 bg-slate-950/40 px-6 py-8 text-center">
                <input type="file" name="attachment" id="opportunityFileInput" class="hidden" required>
                <label for="opportunityFileInput" class="flex cursor-pointer flex-col items-center gap-3">
                  <svg class="h-10 w-10 text-slate-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13l3 3L22 6"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 10V3m0 0L8 7m4-4l4 4"/><path stroke-linecap="round" stroke-linejoin="round" d="M20 21H4a2 2 0 01-2-2V7a2 2 0 012-2h5"/></svg>
                  <p class="text-sm text-slate-400" data-file-label>Drag and drop files here or click to browse.</p>
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-800/80 px-3 py-1 text-xs text-slate-300">Choose a file</span>
                </label>
              </div>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Upload File</button>
              </div>
            </form>
            {% if files %}
            <ul class="divide-y divide-slate-800/80 rounded-xl border border-slate-800/80 bg-slate-950/40">
              {% for file in files %}
              <li class="flex flex-wrap items-center justify-between gap-3 px-4 py-3">
                <div>
                  <a href="{{ url_for('static', filename=file.stored_path) }}" class="font-medium text-slate-100 hover:text-emerald-100" download>{{ file.original_filename }}</a>
                  <div class="mt-1 text-xs text-slate-500">
                    Uploaded {{ file.created_at.strftime('%d %b %Y, %I:%M %p') }}{% if file.uploaded_by %} · {{ file.uploaded_by.display_name }}{% endif %}
                  </div>
                </div>
                <span class="text-xs text-slate-400">{{ file.display_size }}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500">No files uploaded yet.</div>
            {% endif %}
          </div>
        </div>

        <div data-tab-panel="activities" class="motion-panel hidden">
          <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4">
            <input type="hidden" name="form_action" value="schedule_activity">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Activity Type</label>
                <select name="activity_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  <option value="meeting">Meeting</option>
                  <option value="call">Call</option>
                  <option value="email">Email</option>
                </select>
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Subject</label>
                <input type="text" name="activity_subject" placeholder="Follow-up" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Date</label>
                <input type="date" name="activity_date" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Time</label>
                <input type="time" name="activity_time" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              </div>
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Reminder</label>
                <select name="reminder_option" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  {% for value, label in reminder_options %}
                  <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div>
              <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Notes</label>
              <textarea name="activity_notes" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add talking points or objectives."></textarea>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Schedule Activity</button>
            </div>
          </form>
          {% if scheduled_activities %}
          <div class="mt-6 space-y-4">
            {% for engagement in scheduled_activities %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4 card-hover-lift fade-in-up" style="--fade-delay: {{ 160 + loop.index0 * 40 }}ms;">
              <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
                <p class="font-semibold text-slate-100">{{ engagement.display_activity_type }}</p>
                <span class="text-xs text-slate-500">{{ engagement.created_at.strftime('%d %b %Y, %I:%M %p') }}</span>
              </div>
              {% if engagement.subject %}
              <p class="mt-2 text-sm text-emerald-100">{{ engagement.subject }}</p>
              {% endif %}
              <div class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-500 sm:grid-cols-2">
                <div>
                  <p class="uppercase tracking-wide text-[11px] text-slate-500">Scheduled</p>
                  <p class="text-sm text-slate-200">{{ engagement.display_schedule }}</p>
                </div>
                <div>
                  <p class="uppercase tracking-wide text-[11px] text-slate-500">Reminder</p>
                  <p class="text-sm text-slate-200">{{ engagement.display_reminder }}</p>
                </div>
              </div>
              {% if engagement.notes %}
              <p class="mt-3 text-sm text-slate-300 whitespace-pre-line">{{ engagement.notes }}</p>
              {% endif %}
              {% if engagement.created_by %}
              <p class="mt-3 text-xs uppercase tracking-wide text-slate-500">Logged by {{ engagement.created_by.display_name }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="mt-6 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500 card-hover-lift fade-in-up" style="--fade-delay: 160ms;">No activities scheduled yet.</div>
          {% endif %}
        </div>

        <div data-tab-panel="items" class="motion-panel hidden">
          <div class="space-y-5">
            <p class="text-sm text-slate-300">Track solution components, services, or pricing packages tied to this opportunity.</p>
            <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-5 card-hover-lift fade-in-up" style="--fade-delay: 160ms;">
              <input type="hidden" name="form_action" value="add_item">
              <div>
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Details</label>
                <textarea name="item_details" rows="3" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Add specifications, scope, or notes."></textarea>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Lift Type</label>
                  <select name="item_lift_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                    <option value="">Select lift type</option>
                    {% for lift_type in lift_types %}
                    <option value="{{ lift_type }}">{{ lift_type }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Quantity</label>
                  <input type="number" name="item_quantity" min="0" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="1">
                </div>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Floors</label>
                  <input type="text" name="item_floors" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="G+5">
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Cabin Finish</label>
                  <input type="text" name="item_cabin_finish" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="SS / Designer">
                </div>
                <div>
                  <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Door Type</label>
                  <input type="text" name="item_door_type" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Auto">
                </div>
              </div>
              <div class="sm:w-1/3">
                <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Structure</label>
                <select name="item_structure" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
                  <option value="no">No</option>
                  <option value="yes">Yes</option>
                </select>
              </div>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Add Item</button>
              </div>
            </form>
            {% if items %}
            <div class="space-y-4">
              {% for item in items %}
              <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 px-4 py-4 card-hover-lift fade-in-up" style="--fade-delay: {{ 200 + loop.index0 * 40 }}ms;">
                <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
                  <p class="font-semibold text-slate-100">{{ item.lift_type or 'Lift Item' }}</p>
                  <span class="text-xs text-slate-500">{{ item.created_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% if item.details %}
                <p class="mt-2 text-sm text-slate-300 whitespace-pre-line">{{ item.details }}</p>
                {% endif %}
                <dl class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-500 sm:grid-cols-3">
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Lift Type</dt>
                    <dd class="text-sm text-slate-200">{{ item.lift_type or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Quantity</dt>
                    <dd class="text-sm text-slate-200">{{ item.quantity if item.quantity is not none else '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Floors</dt>
                    <dd class="text-sm text-slate-200">{{ item.floors or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Structure</dt>
                    <dd class="text-sm text-slate-200">{{ item.structure_label }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Cabin Finish</dt>
                    <dd class="text-sm text-slate-200">{{ item.cabin_finish or '—' }}</dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-[11px] text-slate-500">Door Type</dt>
                    <dd class="text-sm text-slate-200">{{ item.door_type or '—' }}</dd>
                  </div>
                </dl>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-6 text-center text-sm text-slate-500 card-hover-lift fade-in-up" style="--fade-delay: 200ms;">No items added yet.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-6">
    <div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl card-hover-lift fade-in-up" style="--fade-delay: 160ms;">
      <div class="px-6 py-4 border-b border-slate-800/80">
        <h3 class="text-lg font-semibold">Snapshot</h3>
      </div>
      <dl class="grid grid-cols-1 gap-4 px-6 py-5 text-sm text-slate-300">
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Client</dt>
          <dd>{{ opportunity.client.display_name if opportunity.client else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Owner</dt>
          <dd>{{ opportunity.owner.display_name if opportunity.owner else 'Unassigned' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Expected Close</dt>
          <dd>{{ opportunity.expected_close_date.strftime('%d %b %Y') if opportunity.expected_close_date else 'Not set' }}</dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Probability</dt>
          <dd>
            {% if opportunity.probability is not none %}
              {{ opportunity.probability }}%
            {% else %}
              —
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="text-xs uppercase tracking-wide text-slate-500">Last Updated</dt>
          <dd>{{ opportunity.updated_at.strftime('%d %b %Y, %I:%M %p') }}</dd>
        </div>
      </dl>
    </div>
  </div>
</div>

<div id="editOpportunityModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur">
  <div class="relative w-full max-w-3xl rounded-2xl border border-slate-800/80 bg-slate-900 shadow-2xl">
    <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
      <h3 class="text-lg font-semibold text-slate-100">Edit Opportunity</h3>
      <button type="button" data-modal-close class="rounded-full border border-slate-700 bg-slate-800/80 p-2 text-slate-300 hover:text-emerald-100" aria-label="Close edit opportunity modal">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('sales_opportunity_detail', opportunity_id=opportunity.id) }}" class="space-y-4 px-6 py-5">
      <input type="hidden" name="form_action" value="update">
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Title</label>
        <input type="text" name="title" value="{{ opportunity.title }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" required>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Stage</label>
          <select name="stage" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            {% for stage_option in stages %}
            <option value="{{ stage_option }}" {% if stage_option == opportunity.stage %}selected{% endif %}>{{ stage_option }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Temperature</label>
          <select name="temperature" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">None</option>
            {% for value, label in temperature_choices %}
            <option value="{{ value }}" {% if opportunity.temperature == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        {% if can_see_commercial %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <input type="text" name="amount" value="{{ opportunity.amount if opportunity.amount is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
          </div>
        {% else %}
          <div>
            <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Amount</label>
            <p class="text-sm text-slate-500 italic">Restricted</p>
          </div>
        {% endif %}
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Probability (%)</label>
          <input type="number" name="probability" value="{{ opportunity.probability if opportunity.probability is not none else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" min="0" max="100">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Expected Close Date</label>
          <input type="date" name="expected_close_date" value="{{ opportunity.expected_close_date.isoformat() if opportunity.expected_close_date else '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Related Project</label>
          <input type="text" name="related_project" value="{{ opportunity.related_project or '' }}" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60" placeholder="Project / Site">
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Client</label>
          <select name="client_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Select client</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if opportunity.client and opportunity.client.id == client.id %}selected{% endif %}>{{ client.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Owner</label>
          <select name="owner_id" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
            <option value="">Unassigned</option>
            {% for owner in owners %}
            <option value="{{ owner.id }}" {% if opportunity.owner and opportunity.owner.id == owner.id %}selected{% endif %}>{{ owner.display_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="mb-2 block text-xs uppercase tracking-wide text-slate-400">Description</label>
        <textarea name="description" rows="4" class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">{{ opportunity.description or '' }}</textarea>
      </div>
      <div class="flex justify-end gap-3 border-t border-slate-800/80 pt-4">
        <button type="button" data-modal-close class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm text-slate-300 hover:border-slate-500 hover:text-emerald-100">Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 btn-shimmer">Save Opportunity</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabTriggers = Array.from(document.querySelectorAll('.tab-trigger'));
    const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));
    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const activeClasses = ['bg-emerald-500/20', 'border-emerald-400/40', 'text-emerald-100'];
    const inactiveClasses = ['bg-transparent', 'border-transparent', 'text-slate-300'];

    function setActiveTab(tab) {
      tabTriggers.forEach((trigger) => {
        const isActive = trigger.dataset.tab === tab;
        trigger.classList.toggle('tab-active', isActive);
        if (isActive) {
          inactiveClasses.forEach((cls) => trigger.classList.remove(cls));
          activeClasses.forEach((cls) => trigger.classList.add(cls));
        } else {
          activeClasses.forEach((cls) => trigger.classList.remove(cls));
          inactiveClasses.forEach((cls) => trigger.classList.add(cls));
        }
      });

      tabPanels.forEach((panel) => {
        const isActive = panel.dataset.tabPanel === tab;
        if (isActive) {
          panel.classList.remove('hidden');
          requestAnimationFrame(() => {
            panel.classList.add('is-active');
          });
        } else {
          panel.classList.remove('is-active');
          if (panel.classList.contains('hidden')) {
            return;
          }
          if (prefersReducedMotion) {
            panel.classList.add('hidden');
            return;
          }
          const handleTransition = (event) => {
            if (event.target !== panel || event.propertyName !== 'opacity') {
              return;
            }
            if (panel.classList.contains('is-active')) {
              return;
            }
            panel.classList.add('hidden');
          };
          panel.addEventListener('transitionend', handleTransition, { once: true });
        }
      });
    }

    const defaultTab = document.querySelector('.tab-trigger.tab-active');
    if (defaultTab) {
      setActiveTab(defaultTab.dataset.tab);
    }

    tabTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => setActiveTab(trigger.dataset.tab));
    });

    function toggleModal(modalId, open) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      if (open) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('overflow-hidden');
      } else {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    document.querySelectorAll('[data-modal-open]').forEach((button) => {
      button.addEventListener('click', () => toggleModal(button.dataset.modalOpen, true));
    });

    document.querySelectorAll('#editOpportunityModal [data-modal-close]').forEach((button) => {
      button.addEventListener('click', () => toggleModal('editOpportunityModal', false));
    });

    document.getElementById('editOpportunityModal')?.addEventListener('click', (event) => {
      if (event.target === event.currentTarget) {
        toggleModal('editOpportunityModal', false);
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && document.getElementById('editOpportunityModal')?.classList.contains('flex')) {
        toggleModal('editOpportunityModal', false);
      }
    });

    const fileInput = document.getElementById('opportunityFileInput');
    const fileLabel = document.querySelector('[data-file-label]');
    if (fileInput && fileLabel) {
      fileInput.addEventListener('change', () => {
        const fileName = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
        fileLabel.textContent = fileName || 'Drag and drop files here or click to browse.';
      });
    }
  });
</script>
{% endblock %}
