{% extends "base.html" %}
{% block title %}Sales · Clients{% endblock %}
{% block content %}
<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
  <div>
    <p class="text-sm text-slate-400">Sales Workspace</p>
    <h2 class="text-3xl font-semibold tracking-tight">Clients</h2>
  </div>
  <div class="flex flex-wrap items-center gap-2">
    <a
      href="{{ url_for('sales_clients_export') }}"
      class="px-4 py-2 rounded-xl border border-slate-800/70 bg-slate-900/70 text-xs text-slate-200 hover:bg-slate-800/70"
    >
      Export
    </a>
    <button type="button" data-open-client-upload class="px-4 py-2 rounded-xl border border-slate-800/70 bg-slate-900/70 text-xs text-slate-200 hover:bg-slate-800/70">Upload</button>
    <button type="button" data-open-client-modal class="px-4 py-2 rounded-xl bg-emerald-500/20 text-emerald-200 border border-emerald-400/40 hover:bg-emerald-500/30">Add Client</button>
  </div>
</div>

<div class="bg-slate-900/60 border border-slate-800/80 rounded-2xl shadow-xl overflow-hidden">
  <div class="px-6 py-4 border-b border-slate-800/80 flex items-center justify-between">
    <h3 class="text-lg font-semibold">All Clients</h3>
    <span class="text-xs text-slate-400">{{ clients|length }} records</span>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-800/80">
      <thead class="bg-slate-900/70">
        <tr class="text-left text-xs uppercase tracking-wide text-slate-400">
          <th class="px-6 py-3">Name</th>
          <th class="px-6 py-3">Company</th>
          <th class="px-6 py-3">Email</th>
          <th class="px-6 py-3">Email Opt-Out</th>
          <th class="px-6 py-3">Owner</th>
          <th class="px-6 py-3">Lifecycle Stage</th>
          <th class="px-6 py-3">Phone</th>
          <th class="px-6 py-3 text-center">Open Pipelines</th>
          <th class="px-6 py-3">Created</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800/60 text-sm">
        {% for client in clients %}
        <tr class="hover:bg-slate-800/60">
          <td class="px-6 py-4">
            <a href="{{ url_for('sales_client_detail', client_id=client.id) }}" class="font-semibold text-emerald-200 hover:underline">
              {{ client.display_name }}
            </a>
            <div class="text-xs text-slate-400">{{ client.category or 'Individual' }}</div>
          </td>
          <td class="px-6 py-4">{{ client.company_name or '—' }}</td>
          <td class="px-6 py-4">{{ client.email or '—' }}</td>
          <td class="px-6 py-4">{{ client.email_opt_out_label }}</td>
          <td class="px-6 py-4">{{ client.owner.display_name if client.owner else 'Unassigned' }}</td>
          <td class="px-6 py-4">{{ client.lifecycle_stage or '—' }}</td>
          <td class="px-6 py-4">{{ client.phone or '—' }}</td>
          <td class="px-6 py-4 text-center font-semibold">{{ client.open_opportunity_count }}</td>
          <td class="px-6 py-4 text-xs text-slate-400">{{ client.created_at.strftime('%b %d, %Y') }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="px-6 py-16 text-center text-slate-500">No clients yet. Add one using the button above.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div id="clientModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-close-client-modal></div>
  <div class="relative mx-auto mt-16 w-full max-w-2xl px-4">
    <div class="rounded-2xl border border-slate-800/80 bg-slate-950/95 shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800/80">
        <div>
          <h3 class="text-lg font-semibold">Create Client</h3>
          <p class="text-xs text-slate-400">Capture new contacts for your pipelines.</p>
        </div>
        <button type="button" class="text-slate-400 hover:text-slate-200" data-close-client-modal>&times;</button>
      </div>
      <form method="post" action="{{ url_for('sales_clients_create') }}" class="px-6 py-5 space-y-4" id="clientModalForm">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Client Name <span class="text-rose-400">*</span></label>
          <input type="text" name="display_name" required class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Company</label>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <select name="company_id" id="clientCompanySelect" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400/60">
              <option value="">Select</option>
              {% for company in companies %}
              <option value="{{ company.id }}" data-blacklisted="{{ 'true' if company.blacklisted else 'false' }}">{{ company.display_label }}</option>
              {% endfor %}
            </select>
            <button type="button" class="px-4 py-2 rounded-xl border border-slate-800/80 text-xs text-slate-200 hover:bg-slate-800/70" data-open-company-modal data-company-target="#clientCompanySelect">New Company</button>
          </div>
          <input type="hidden" name="company_name" id="clientCompanyName" />
          <p class="mt-2 hidden rounded-xl border border-slate-200/40 bg-black px-3 py-2 text-xs font-semibold text-rose-300" data-company-warning>Company Blacklisted</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Email</label>
            <input type="email" name="email" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2">
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Phone</label>
            <input type="text" name="phone" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2">
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Email Opt-Out</label>
            <select name="email_opt_out" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Category</label>
            <select name="category" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2">
              <option value="Individual">Individual</option>
              <option value="Company">Company</option>
            </select>
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Lifecycle Stage</label>
            <select name="lifecycle_stage" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2">
              {% for stage in lifecycle_options %}
              <option value="{{ stage }}" {% if loop.first %}selected{% endif %}>{{ stage }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Notes</label>
          <textarea name="description" rows="3" class="w-full rounded-xl bg-slate-950/70 border border-slate-800/80 px-3 py-2"></textarea>
        </div>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="px-4 py-2 rounded-xl border border-slate-800/80 text-slate-300 hover:text-white" data-close-client-modal>Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-400/40 text-emerald-100 font-semibold hover:bg-emerald-500/30">Save Client</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include "sales/_company_modal.html" %}

<div id="clientUploadModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-close-client-upload></div>
  <div class="relative mx-auto mt-16 w-full max-w-2xl px-4">
    <form method="post" action="{{ url_for('sales_clients_upload') }}" enctype="multipart/form-data" class="rounded-2xl border border-slate-800/80 bg-slate-950/95 shadow-2xl" id="clientUploadForm">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800/80">
        <div>
          <h3 class="text-lg font-semibold">Bulk upload clients</h3>
          <p class="text-xs text-slate-400">Import client records before linking opportunities.</p>
        </div>
        <button type="button" class="text-slate-400 hover:text-slate-200" data-close-client-upload>&times;</button>
      </div>
      <div class="space-y-5 px-6 py-5 text-sm text-slate-200">
        <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 p-4">
          <h4 class="text-sm font-semibold text-slate-100">Template</h4>
          <p class="mt-1 text-xs text-slate-400">Download the sheet, update client information and upload it back.</p>
          <a
            href="{{ url_for('sales_clients_upload_template') }}"
            class="mt-3 inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20"
            target="_blank"
            rel="noopener"
          >
            Download template
          </a>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-slate-100">Before you upload</h4>
          <ul class="mt-2 space-y-2 text-xs text-slate-400">
            <li>• Display Name is required for every row.</li>
            <li>• Owner Email should match a user with Sales access.</li>
            <li>• Lifecycle Stage must be one of: {{ lifecycle_options|join(', ') }}.</li>
          </ul>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Upload file</label>
          <input type="file" name="client_upload_file" accept=".xlsx,.csv" required class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-slate-100" />
        </div>
      </div>
      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-slate-800/80">
        <button type="button" class="rounded-xl border border-slate-800/80 px-4 py-2 text-xs text-slate-300 hover:text-white" data-close-client-upload>Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Import clients</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const modal = document.getElementById('clientModal');
      const openButton = document.querySelector('[data-open-client-modal]');
      const form = document.getElementById('clientModalForm');
      const companySelect = document.getElementById('clientCompanySelect');
      const companyNameInput = document.getElementById('clientCompanyName');
      const companyWarning = document.querySelector('[data-company-warning]');
      const companyModal = document.getElementById('companyModal');
      const companyForm = companyModal ? companyModal.querySelector('[data-company-form]') : null;
      let activeCompanySelect = companySelect;
      if (!modal || !openButton) {
        return;
      }

      const focusFirstInput = () => {
        const firstInput = modal.querySelector('input, select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      };

      const openModal = () => {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        focusFirstInput();
      };

      const closeModal = () => {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      };

      openButton.addEventListener('click', openModal);

      modal.querySelectorAll('[data-close-client-modal]').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          closeModal();
        });
      });

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });

      if (form) {
        form.addEventListener('submit', () => {
          closeModal();
        });
      }

      const updateCompanyState = (selectEl) => {
        if (!selectEl) return;
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        if (companyNameInput) {
          companyNameInput.value = selectedOption ? (selectedOption.textContent || '').trim() : '';
        }
        if (companyWarning) {
          const isBlacklisted = selectedOption && selectedOption.dataset.blacklisted === 'true';
          companyWarning.classList.toggle('hidden', !isBlacklisted);
        }
      };

      if (companySelect) {
        updateCompanyState(companySelect);
        companySelect.addEventListener('change', () => updateCompanyState(companySelect));
      }

      const openCompanyModal = (selectEl) => {
        activeCompanySelect = selectEl || companySelect;
        if (!companyModal) return;
        companyModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        const nameInput = companyModal.querySelector('input[name="company_name"]');
        if (nameInput) {
          nameInput.focus();
        }
      };

      const closeCompanyModal = () => {
        if (!companyModal) return;
        companyModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      };

      if (companyModal) {
        companyModal.querySelectorAll('[data-close-company-modal]').forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            closeCompanyModal();
          });
        });

        companyModal.addEventListener('click', (event) => {
          if (event.target === companyModal) {
            closeCompanyModal();
          }
        });

        document.querySelectorAll('[data-open-company-modal]').forEach((button) => {
          button.addEventListener('click', () => {
            const targetSelector = button.getAttribute('data-company-target');
            const targetSelect = targetSelector ? document.querySelector(targetSelector) : companySelect;
            openCompanyModal(targetSelect);
          });
        });
      }

      if (companyForm) {
        const errorTarget = companyForm.querySelector('[data-company-error]');
        companyForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (errorTarget) {
            errorTarget.classList.add('hidden');
            errorTarget.textContent = '';
          }
          const submitButton = companyForm.querySelector('[data-submit-company]');
          if (submitButton) submitButton.disabled = true;
          try {
            const response = await fetch(companyForm.action, { method: 'POST', body: new FormData(companyForm) });
            const data = await response.json();
            if (!data.success) {
              throw new Error(data.message || 'Could not save company');
            }
            const selectEl = activeCompanySelect || companySelect;
            if (selectEl && data.company) {
              let option = Array.from(selectEl.options).find((opt) => opt.value === String(data.company.id));
              if (!option) {
                option = document.createElement('option');
                selectEl.appendChild(option);
              }
              option.value = data.company.id;
              option.textContent = data.company.name;
              option.dataset.blacklisted = data.company.blacklisted ? 'true' : 'false';
              selectEl.value = String(data.company.id);
              selectEl.dispatchEvent(new Event('change'));
            }
            companyForm.reset();
            closeCompanyModal();
          } catch (error) {
            if (errorTarget) {
              errorTarget.textContent = error.message || 'Could not save company';
              errorTarget.classList.remove('hidden');
            }
          } finally {
            if (submitButton) submitButton.disabled = false;
          }
        });
      }

      const uploadModal = document.getElementById('clientUploadModal');
      const uploadForm = document.getElementById('clientUploadForm');
      const uploadButtons = document.querySelectorAll('[data-open-client-upload]');
      if (uploadModal && uploadButtons.length) {
        const closeUploadButtons = uploadModal.querySelectorAll('[data-close-client-upload]');
        const openUploadModal = () => {
          uploadModal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          const input = uploadModal.querySelector('input[type="file"]');
          if (input) {
            input.focus();
          }
        };
        const closeUploadModal = () => {
          uploadModal.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        };

        uploadButtons.forEach((button) => {
          button.addEventListener('click', openUploadModal);
        });

        closeUploadButtons.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            closeUploadModal();
          });
        });

        uploadModal.addEventListener('click', (event) => {
          if (event.target === uploadModal) {
            closeUploadModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !uploadModal.classList.contains('hidden')) {
            closeUploadModal();
          }
        });

        if (uploadForm) {
          uploadForm.addEventListener('submit', () => {
            closeUploadModal();
          });
        }
      }
    })();
  </script>
{% endblock %}
