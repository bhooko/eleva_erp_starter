{% extends "base.html" %}
{% block title %}Sales · Opportunities · {{ pipeline_config.label }}{% endblock %}
{% block content %}
<div class="mb-6 space-y-4">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-sm text-slate-400">Sales Pipeline</p>
      <div class="flex flex-wrap items-center gap-3">
        <h2 class="text-3xl font-semibold tracking-tight">{{ pipeline_config.label }} Opportunities</h2>
        <span class="text-xs text-slate-500 border border-slate-800/80 rounded-lg px-3 py-1">{{ stages|length }} stages</span>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <a
        href="{{ url_for('sales_opportunities_export', pipeline_key=pipeline_key) }}"
        class="inline-flex items-center gap-2 rounded-xl border border-slate-800/70 bg-slate-900/70 px-4 py-2 text-xs text-slate-200 hover:bg-slate-800/70"
      >
        Export
      </a>
      <button
        type="button"
        data-open-opportunity-upload
        class="inline-flex items-center gap-2 rounded-xl border border-slate-800/70 bg-slate-900/70 px-4 py-2 text-xs text-slate-200 hover:bg-slate-800/70"
      >
        Upload
      </button>
      {% with default_pipeline_key=pipeline_key, opportunity_clients=clients, opportunity_owners=owners %}
        {% include "sales/_opportunity_quick_create.html" %}
      {% endwith %}
    </div>
  </div>
  <div class="flex flex-wrap items-center gap-2 text-sm">
    {% for key, cfg in pipeline_map.items() %}
    <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key=key) }}" class="px-3 py-1.5 rounded-xl border {{ 'border-emerald-400/40 bg-emerald-500/20 text-emerald-100' if key==pipeline_key else 'border-slate-800/80 bg-slate-900/70 text-slate-300 hover:bg-slate-800/70' }}">{{ cfg.label }}</a>
    {% endfor %}
  </div>
</div>

<div class="bg-slate-900/40 rounded-2xl border border-slate-800/80 shadow-xl overflow-hidden">
  <div class="px-6 py-4 border-b border-slate-800/80 flex items-center justify-between">
    <h3 class="text-lg font-semibold">Pipeline View</h3>
    <span class="text-xs text-slate-400">{{ total_opportunities }} deals</span>
  </div>
  <div class="overflow-x-auto">
    <div class="w-full grid gap-3 px-5 py-5" style="grid-template-columns: repeat({{ stages|length }}, minmax(0, 1fr));" data-pipeline-board>
        {% for stage in stages %}
        {% set deal_count = grouped.get(stage, [])|length %}
        <div class="bg-slate-950/60 border border-slate-800/80 rounded-2xl flex flex-col transition duration-150" data-stage-column data-stage="{{ stage }}">
          <div class="px-3 py-2.5 border-b border-slate-800/80">
            <div class="space-y-1">
              <p class="text-sm font-semibold text-slate-100">{{ stage }}</p>
              <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                <span data-stage-count data-stage="{{ stage }}" data-count="{{ deal_count }}">{{ '1 deal' if deal_count == 1 else deal_count ~ ' deals' }}</span>
                {% if can_see_commercial %}
                  <span data-stage-total data-stage="{{ stage }}" data-total="{{ stage_totals_raw.get(stage, 0) or 0 }}" data-currency="{{ stage_currencies.get(stage, '₹') }}">Value {{ stage_totals.get(stage, '₹0.00') }}</span>
                {% else %}
                  <span class="text-slate-600">Value restricted</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="p-3 space-y-3 min-h-[120px]" data-stage-cards>
            {% for opp in grouped.get(stage, []) %}
            <div class="bg-slate-900/80 border border-slate-800/80 rounded-xl shadow-inner p-3 flex flex-col gap-1 cursor-grab" data-opportunity-card data-opportunity-id="{{ opp.id }}" data-stage="{{ opp.stage }}" data-stage-url="{{ url_for('sales_opportunity_stage', opportunity_id=opp.id) }}" data-amount="{{ '%.2f' % opp.amount if can_see_commercial and opp.amount is not none else '0' }}" data-currency="{{ opp.currency or '₹' if can_see_commercial else '' }}" data-has-project="{{ 'true' if opp.project_id else 'false' }}" data-convert-url="{{ url_for('sales_opportunity_convert_to_project', opportunity_id=opp.id) if current_user.can_view_module('operations') else '' }}">
              <a href="{{ url_for('sales_opportunity_detail', opportunity_id=opp.id) }}" class="block text-sm font-semibold text-emerald-200 hover:underline truncate" title="{{ opp.title }}">{{ opp.title }}</a>
              <span class="text-xs text-slate-400 truncate" title="{{ opp.client.display_name if opp.client else 'No client' }}">{{ opp.client.display_name if opp.client else 'No client' }}</span>
              {% if can_see_commercial %}
                <span class="text-xs text-slate-300">{{ opp.display_amount }}</span>
              {% else %}
                <span class="text-xs text-slate-300 italic">Amount restricted</span>
              {% endif %}
              {% if opp.temperature %}
              {% set label, badge = opp.badge_variant %}
              <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs {{ badge }} w-fit">{{ label or opp.temperature|capitalize }}</span>
              {% elif opp.expected_close_date %}
              <span class="text-xs text-slate-300">Close {{ opp.expected_close_date.strftime('%d %b') }}</span>
              {% else %}
              <span class="text-xs text-slate-300">Status unavailable</span>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          <div class="text-xs text-slate-500 bg-slate-900/40 border border-dashed border-slate-800/80 rounded-xl p-3 m-3 {{ 'hidden' if deal_count > 0 else '' }}" data-empty-message>No deals in this stage.</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div id="opportunityUploadModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-close-opportunity-upload></div>
  <div class="relative mx-auto mt-16 w-full max-w-2xl px-4">
    <form method="post" action="{{ url_for('sales_opportunities_upload') }}" enctype="multipart/form-data" class="rounded-2xl border border-slate-800/80 bg-slate-950/95 shadow-2xl">
      <input type="hidden" name="pipeline" value="{{ pipeline_key }}" />
      <div class="flex items-center justify-between gap-4 px-6 py-4 border-b border-slate-800/80">
        <div>
          <h3 class="text-lg font-semibold">Bulk upload opportunities</h3>
          <p class="text-xs text-slate-400">Import pipeline deals for the {{ pipeline_config.label }} board.</p>
        </div>
        <button type="button" class="text-slate-400 hover:text-slate-200" data-close-opportunity-upload>&times;</button>
      </div>
      <div class="space-y-5 px-6 py-5 text-sm text-slate-200">
        <div class="rounded-xl border border-slate-800/80 bg-slate-900/70 p-4">
          <h4 class="text-sm font-semibold text-slate-100">Template</h4>
          <p class="mt-1 text-xs text-slate-400">Download the spreadsheet, fill one row per opportunity and upload it back.</p>
          <a
            href="{{ url_for('sales_opportunities_upload_template', pipeline_key=pipeline_key) }}"
            class="mt-3 inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20"
            target="_blank"
            rel="noopener"
          >
            Download template
          </a>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-slate-100">Before you upload</h4>
          <ul class="mt-2 space-y-2 text-xs text-slate-400">
            <li>• Title is mandatory for every opportunity row.</li>
            <li>• Pipeline defaults to {{ pipeline_key|capitalize }}; provide another key to import into a different board.</li>
            <li>• Stage must match one of: {{ stages|join(', ') }}.</li>
            <li>• Owner Email should belong to a user with Sales access.</li>
          </ul>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Upload file</label>
          <input type="file" name="opportunity_upload_file" accept=".xlsx,.csv" required class="w-full rounded-xl border border-slate-800/80 bg-slate-950/70 px-3 py-2 text-slate-100" />
        </div>
      </div>
      <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-slate-800/80">
        <button type="button" class="rounded-xl border border-slate-800/80 px-4 py-2 text-xs text-slate-300 hover:text-white" data-close-opportunity-upload>Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Import opportunities</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/opportunity_board.js') }}"></script>
  <script>
    (function () {
      const modal = document.getElementById('opportunityUploadModal');
      if (!modal) {
        return;
      }

      const openButtons = document.querySelectorAll('[data-open-opportunity-upload]');
      const closeButtons = modal.querySelectorAll('[data-close-opportunity-upload]');

      const openModal = () => {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      };

      const closeModal = () => {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      };

      openButtons.forEach((button) => {
        button.addEventListener('click', openModal);
      });

      closeButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          closeModal();
        });
      });

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
    })();
  </script>
{% endblock %}
