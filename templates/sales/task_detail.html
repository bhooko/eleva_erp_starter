{% extends "base.html" %}
{% block title %}Sales · Task Details{% endblock %}
{% block content %}
<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
  <div>
    <p class="text-sm text-slate-400">Sales Workspace</p>
    <h2 class="text-3xl font-semibold tracking-tight">{{ task.title }}</h2>
    <p class="text-xs text-slate-400">Task details and context.</p>
  </div>
  <div class="flex items-center gap-3">
    <a href="{{ category_url }}" class="inline-flex items-center gap-2 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100">← Back to Tasks</a>
    {% if not task.is_completed %}
    <form method="post" class="shrink-0">
      {{ csrf_field() }}
      <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500/20 border border-emerald-400/40 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30">Mark complete</button>
    </form>
    {% else %}
    <span class="inline-flex items-center gap-2 rounded-xl bg-emerald-500/10 border border-emerald-400/30 px-4 py-2 text-sm font-semibold text-emerald-100">Completed</span>
    {% endif %}
  </div>
</div>

<div class="grid gap-6 lg:grid-cols-3">
  <div class="lg:col-span-2 space-y-4">
    <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5">
      <h3 class="text-lg font-semibold text-slate-100 mb-2">Overview</h3>
      <p class="text-sm text-slate-200">{{ task.description or 'No description provided.' }}</p>
      <div class="mt-4 flex flex-wrap gap-3 text-xs text-slate-300">
        <span class="inline-flex items-center rounded-lg bg-slate-800/70 border border-slate-700/70 px-3 py-1">{{ task.category_label }}</span>
        <span class="inline-flex items-center rounded-lg bg-slate-800/70 border border-slate-700/70 px-3 py-1">Status: {{ task.status or 'Pending' }}</span>
        <span class="inline-flex items-center rounded-lg bg-slate-800/70 border border-slate-700/70 px-3 py-1">Due {{ task.due_date.strftime('%d %b %Y') if task.due_date else '—' }}</span>
      </div>
    </div>
    {% if task.opportunity %}
    <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5 flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Opportunity</p>
        <p class="text-base font-semibold text-slate-100">{{ task.opportunity.title }}</p>
        {% if task.opportunity.client %}
        <p class="text-sm text-slate-400">{{ task.opportunity.client.display_name }}</p>
        {% endif %}
      </div>
      <a href="{{ url_for('sales_opportunity_detail', opportunity_id=task.opportunity.id) }}" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 px-3 py-2 text-sm text-emerald-100 hover:bg-emerald-500/20">View</a>
    </div>
    <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Opportunity Docs</p>
          <p class="text-sm text-slate-300">Quick links to requirements and pricing files.</p>
        </div>
      </div>
      <div class="mt-4 space-y-3">
        <div class="flex items-start justify-between gap-3 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-3">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-400">Client Requirements Form</p>
            {% if client_requirement_form %}
            <p class="text-sm font-medium text-slate-100">Version {{ client_requirement_form.version }} · {{ client_requirement_form.status|replace('_', ' ')|title }}</p>
            <p class="text-xs text-slate-500">Updated {{ client_requirement_form.updated_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</p>
            {% else %}
            <p class="text-sm text-slate-300">No form linked yet.</p>
            {% endif %}
          </div>
          {% if client_requirement_form %}
          <a href="{{ url_for('sales_client_requirement_form_detail', form_id=client_requirement_form.id) }}" class="inline-flex items-center gap-2 rounded-lg border border-emerald-400/40 px-3 py-1 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/20">Open</a>
          {% endif %}
        </div>
        <div class="flex items-start justify-between gap-3 rounded-xl border border-slate-800/80 bg-slate-950/40 px-4 py-3">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-400">Quotation File</p>
            {% if latest_quotation_file %}
            <p class="text-sm font-medium text-slate-100 truncate max-w-md">{{ latest_quotation_file.original_filename }}</p>
            <p class="text-xs text-slate-500">Uploaded {{ latest_quotation_file.created_at|format_india_datetime('%d %b %Y, %I:%M %p') }}</p>
            {% else %}
            <p class="text-sm text-slate-300">No quotation uploaded yet.</p>
            {% endif %}
          </div>
          {% if latest_quotation_file %}
          <a href="{{ url_for('static', filename=latest_quotation_file.stored_path) }}" class="inline-flex items-center gap-2 rounded-lg border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200 hover:border-emerald-400/40 hover:text-emerald-100" download>Download</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% elif task.client %}
    <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5 flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Client</p>
        <p class="text-base font-semibold text-slate-100">{{ task.client.display_name }}</p>
      </div>
      <a href="{{ url_for('sales_client_detail', client_id=task.client.id) }}" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 px-3 py-2 text-sm text-emerald-100 hover:bg-emerald-500/20">View</a>
    </div>
    {% endif %}
  </div>
    <div class="space-y-4">
      <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5">
        <p class="text-xs uppercase tracking-wide text-slate-400">Related</p>
        <p class="text-sm text-slate-200">{{ task.related_display }}</p>
        <p class="text-xs text-slate-500 mt-1">Owner: {{ task.owner_display }}</p>
        <p class="text-xs text-slate-500">Assigned to: {{ task.assignee_display }}</p>
      </div>
    <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 shadow-xl p-5 text-sm text-slate-300">
      <p class="text-xs uppercase tracking-wide text-slate-400 mb-2">Created</p>
      <p>{{ task.created_at|format_india_datetime('%d %b %Y, %H:%M %Z') if task.created_at else '—' }}</p>
      {% if task.completed_at %}
      <p class="mt-3 text-xs uppercase tracking-wide text-slate-400 mb-1">Completed</p>
      <p>{{ task.completed_at|format_india_datetime('%d %b %Y, %H:%M %Z') }}</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
