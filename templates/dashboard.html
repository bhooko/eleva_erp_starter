{% extends "base.html" %}
{% set view_mode = page_mode or 'dashboard' %}

{% macro render_dashboard_cards(modules, empty_text) %}
  {% set cards = namespace(count=0) %}
  <div class="space-y-4" data-filter-scope>
    <div class="flex flex-wrap items-center gap-2 mb-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 mr-1">Show</span>
      <button
        type="button"
        class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200"
        data-filter-value="all"
      >
        All
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200"
        data-filter-value="overdue"
      >
        Overdue
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200"
        data-filter-value="today"
      >
        Today
      </button>
      <button
        type="button"
        class="px-3 py-1 rounded-full text-sm border border-slate-700 bg-slate-900/60 text-slate-200"
        data-filter-value="upcoming"
      >
        Next 7 days
      </button>
    </div>

    <div class="space-y-4">
      {% for module in modules %}
        {% set items = module['items'] or [] %}
        {% if items %}
          {% set cards.count = cards.count + items|length %}
          {% set variants = namespace(values=[]) %}
          {% for item in items %}
            {% set _ = variants.values.append(item.due_variant or 'none') %}
          {% endfor %}
          <section
            class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4 space-y-3 shadow-sm"
            data-variants="{{ variants.values | unique | join(',') }}"
            data-filter-section
          >
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="flex items-center gap-2">
                  <h2 class="text-sm font-semibold text-slate-100">{{ module['module'] }}</h2>
                  {% if module.summary %}
                    <div class="flex items-center gap-2 text-sm text-slate-400">
                      {% if module.summary.overdue %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-rose-500/10 text-rose-200 px-2 py-0.5 border border-rose-500/30">
                          {{ module.summary.overdue }} overdue
                        </span>
                      {% endif %}
                      {% if module.summary.today %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/10 text-amber-200 px-2 py-0.5 border border-amber-500/30">
                          {{ module.summary.today }} today
                        </span>
                      {% endif %}
                      {% if module.summary.upcoming %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 text-emerald-200 px-2 py-0.5 border border-emerald-500/30">
                          {{ module.summary.upcoming }} upcoming
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
                {% if module.description %}
                  <p class="text-xs text-slate-400">{{ module.description }}</p>
                {% endif %}
              </div>
              <div class="text-xs uppercase tracking-wide text-slate-400 flex items-center gap-1">
                {{ items|length }} item{{ 's' if items|length != 1 else '' }}
              </div>
            </div>

            <div class="grid gap-2">
              {% for item in items %}
                <div
                  class="flex items-start justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/60 px-3 py-2 hover:border-slate-700 hover:shadow-lg hover:shadow-black/20 transition"
                  data-due-variant="{{ item.due_variant or 'none' }}"
                  data-filter-item
                >
                  <div class="space-y-1 min-w-0">
                    <div class="flex items-center gap-2 text-xs text-slate-400 uppercase tracking-wide">
                      <span class="px-2 py-0.5 rounded-lg bg-slate-800/70 border border-slate-700/70 text-slate-200">{{ module['module'] }}</span>
                      {% if item.identifier %}
                        <span class="font-mono text-slate-500">{{ item.identifier }}</span>
                      {% endif %}
                    </div>
                    <div class="text-sm font-semibold text-slate-100 leading-tight">
                      {% if item.url %}
                        <a href="{{ item.url }}" class="hover:underline">{{ item.title }}</a>
                      {% else %}
                        {{ item.title }}
                      {% endif %}
                    </div>
                    {% if item.subtitle %}
                      <div class="text-xs text-slate-400">{{ item.subtitle }}</div>
                    {% endif %}
                    {% if item.description %}
                      <p class="text-xs text-slate-500">{{ item.description }}</p>
                    {% endif %}
                    {% if item.metadata %}
                      <div class="flex flex-wrap gap-2 text-xs uppercase tracking-wide">
                        {% for badge in item.metadata %}
                          {% if badge is mapping %}
                            <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60 text-slate-300">
                              {{ badge.label }}: {{ badge.value }}
                            </span>
                          {% else %}
                            <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60 text-slate-300">{{ badge }}</span>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex flex-col items-end gap-1 shrink-0 text-right">
                    {% if item.due_display %}
                      <span class="text-xs px-2 py-0.5 rounded-full {{ item.due_class }}">
                        {{ item.due_display }}
                      </span>
                    {% endif %}
                    {% if item.status %}
                      <span class="text-xs px-2 py-0.5 rounded-full {{ item.status_class }}">{{ item.status }}</span>
                    {% endif %}
                    {% if item.secondary_url %}
                      <a
                        href="{{ item.secondary_url }}"
                        class="mt-1 inline-flex items-center justify-center px-2.5 py-1 text-sm font-semibold rounded-lg border border-slate-700/70 bg-slate-900/60 hover:bg-slate-800/60 transition"
                      >{{ item.secondary_label }}</a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      {% endfor %}
    </div>

    {% if cards.count == 0 %}
      <div class="rounded-2xl bg-slate-900/60 border border-slate-800 shadow-inner shadow-black/20 p-6 text-sm text-slate-300">
        {{ empty_text }}
      </div>
    {% endif %}
  </div>
{% endmacro %}

{% block title %}Eleva ERP â€“ {{ 'Project Tasks' if view_mode == 'projects' else 'Dashboard' }}{% endblock %}

{% block content %}
<div class="space-y-6" data-dashboard-tabs data-default-tab="my">
  <div class="rounded-2xl bg-slate-900/60 border border-slate-800 shadow-inner shadow-black/20 p-6 flex flex-wrap items-start gap-6 card-hover-lift fade-in-up">
    <div>
      <h2 class="text-lg font-semibold text-slate-100">
        {% if view_mode == 'projects' %}
          <span data-tab-label="my">Pending Project Tasks for {{ viewing_user.display_name }}</span>
          <span data-tab-label="team" class="hidden">Team Project Tasks for {{ viewing_user.display_name }}</span>
          <span data-tab-label="created" class="hidden">Items You Assigned</span>
        {% else %}
          <span data-tab-label="my">Pending Work for {{ viewing_user.display_name }}</span>
          <span data-tab-label="team" class="hidden">Team Workload for {{ viewing_user.display_name }}</span>
          <span data-tab-label="created" class="hidden">Items You Assigned</span>
        {% endif %}
      </h2>
      <p class="text-sm text-slate-400 mt-1">
        {% if view_mode == 'projects' %}
          <span data-tab-description="my">Focus on the project execution items that still need your attention.</span>
          <span data-tab-description="team" class="hidden">See open project and QC work owned by your direct and indirect reports.</span>
          <span data-tab-description="created" class="hidden">Tasks and activities you created for others to complete.</span>
        {% else %}
          <span data-tab-description="my">Only tasks and activities that are still pending across Sales, Projects, and QC modules.</span>
          <span data-tab-description="team" class="hidden">Everything pending across your team's assignments in Sales, Projects, and QC.</span>
          <span data-tab-description="created" class="hidden">Tasks and activities you created for others to complete.</span>
        {% endif %}
      </p>
      {% if current_user.is_admin and viewing_user.id != current_user.id %}
        <p class="text-xs text-emerald-300/80 mt-2">Administrator view â€“ showing {{ viewing_user.username }}'s workload.</p>
      {% endif %}
    </div>
    <div class="ml-auto text-right">
      <div
        class="text-4xl font-bold text-emerald-400"
        data-tab-count-display
        data-my-count="{{ pending_total|default(0) }}"
        data-team-count="{{ team_pending_total|default(0) }}"
        data-created-count="{{ created_by_total|default(0) }}"
      >
        {{ pending_total|default(0) }}
      </div>
      <div class="text-xs uppercase tracking-wide text-slate-400">Pending Items</div>
    </div>
  </div>

  <div class="flex items-center gap-3 border-b border-slate-800/80 pb-2" role="tablist" aria-label="Dashboard scope selector">
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-semibold tracking-wide uppercase border border-transparent text-slate-400 hover:text-slate-200 transition"
      data-tab-target="my"
      role="tab"
      aria-selected="false"
      aria-controls="dashboard-panel-my"
      id="dashboard-tab-my"
    >
      <span>My Dash</span>
      <span
        class="inline-flex items-center justify-center rounded-full bg-slate-800/70 text-slate-200 h-7 min-w-[1.75rem] px-2"
        data-tab-count="my"
      >{{ pending_total|default(0) }}</span>
    </button>
    {% if view_mode != 'projects' %}
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-semibold tracking-wide uppercase border border-transparent text-slate-400 hover:text-slate-200 transition"
        data-tab-target="created"
        role="tab"
        aria-selected="false"
        aria-controls="dashboard-panel-created"
        id="dashboard-tab-created"
      >
        <span>Assigned by Me</span>
        <span
          class="inline-flex items-center justify-center rounded-full bg-slate-800/70 text-slate-200 h-7 min-w-[1.75rem] px-2"
          data-tab-count="created"
        >{{ created_by_total|default(0) }}</span>
      </button>
    {% endif %}
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-semibold tracking-wide uppercase border border-transparent text-slate-400 hover:text-slate-200 transition"
      data-tab-target="team"
      role="tab"
      aria-selected="false"
      aria-controls="dashboard-panel-team"
      id="dashboard-tab-team"
    >
      <span>Team Dash</span>
      <span
        class="inline-flex items-center justify-center rounded-full bg-slate-800/70 text-slate-200 h-7 min-w-[1.75rem] px-2"
        data-tab-count="team"
      >{{ team_pending_total|default(0) }}</span>
    </button>
  </div>

  <div id="dashboard-panel-my" data-tab-panel="my" role="tabpanel" aria-labelledby="dashboard-tab-my">
    {{ render_dashboard_cards(pending_modules or [], "Nothing pending â€” time for a coffee? â˜•") }}
  </div>

  {% if view_mode != 'projects' %}
    <div id="dashboard-panel-created" data-tab-panel="created" role="tabpanel" aria-labelledby="dashboard-tab-created" class="hidden">
      {{ render_dashboard_cards(created_by_modules or [], "No items assigned by you are pending.") }}
    </div>
  {% endif %}

  <div id="dashboard-panel-team" data-tab-panel="team" role="tabpanel" aria-labelledby="dashboard-tab-team" class="hidden">
    {% if team_members %}
      {{ render_dashboard_cards(team_pending_modules or [], "Your team has no pending work right now. ðŸŽ‰") }}
    {% else %}
      <div class="rounded-2xl bg-slate-900/60 border border-slate-800 shadow-inner shadow-black/20 p-6 text-sm text-slate-300">
        No team members are currently reporting to you.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('[data-dashboard-tabs]').forEach(function (root) {
        const buttons = root.querySelectorAll('[data-tab-target]');
        const panels = root.querySelectorAll('[data-tab-panel]');
        if (!buttons.length || !panels.length) {
          return;
        }

        const tabTargets = Array.from(buttons).map((btn) => btn.dataset.tabTarget).filter(Boolean);

        const countDisplay = root.querySelector('[data-tab-count-display]');
        const labelTargets = root.querySelectorAll('[data-tab-label]');
        const descriptionTargets = root.querySelectorAll('[data-tab-description]');
        const badgeTargets = root.querySelectorAll('[data-tab-count]');

        function activate(target) {
          const normalized = tabTargets.includes(target) ? target : tabTargets[0] || 'my';

          buttons.forEach(function (button) {
            const isActive = button.dataset.tabTarget === normalized;
            button.classList.toggle('bg-slate-800/80', isActive);
            button.classList.toggle('text-slate-100', isActive);
            button.classList.toggle('border-slate-700', isActive);
            button.classList.toggle('text-slate-400', !isActive);
            button.classList.toggle('border-transparent', !isActive);
            button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          });

          panels.forEach(function (panel) {
            const isActive = panel.dataset.tabPanel === normalized;
            panel.classList.toggle('hidden', !isActive);
          });

          labelTargets.forEach(function (label) {
            const isActive = label.dataset.tabLabel === normalized;
            label.classList.toggle('hidden', !isActive);
          });

          descriptionTargets.forEach(function (description) {
            const isActive = description.dataset.tabDescription === normalized;
            description.classList.toggle('hidden', !isActive);
          });

          badgeTargets.forEach(function (badge) {
            const isActive = badge.dataset.tabCount === normalized;
            badge.classList.toggle('bg-emerald-500/80', isActive);
            badge.classList.toggle('text-slate-900', isActive);
            badge.classList.toggle('bg-slate-800/70', !isActive);
            badge.classList.toggle('text-slate-200', !isActive);
          });

          if (countDisplay) {
            const datasetKey = `${normalized}Count`;
            const value = countDisplay.dataset[datasetKey] || '0';
            countDisplay.textContent = value;
          }
        }

        const initial = root.dataset.defaultTab || (buttons[0] && buttons[0].dataset.tabTarget) || 'my';
        activate(initial);

        buttons.forEach(function (button) {
          button.addEventListener('click', function () {
            activate(button.dataset.tabTarget || 'my');
          });
        });
      });

      document.querySelectorAll('[data-filter-scope]').forEach(function (scope) {
        const buttons = scope.querySelectorAll('[data-filter-value]');
        const sections = scope.querySelectorAll('[data-filter-section]');
        const items = scope.querySelectorAll('[data-filter-item]');
        const activeClassMap = {
          all: ['bg-slate-200', 'text-slate-900', 'border-slate-200', 'font-semibold'],
          overdue: ['bg-rose-200/80', 'text-rose-900', 'border-rose-200', 'font-semibold'],
          today: ['bg-amber-200/80', 'text-amber-900', 'border-amber-200', 'font-semibold'],
          upcoming: ['bg-emerald-200/80', 'text-emerald-900', 'border-emerald-200', 'font-semibold'],
        };
        const allActiveClasses = Array.from(new Set(Object.values(activeClassMap).flat()));

        function applyFilter(filter) {
          const normalized = filter || 'all';

          sections.forEach(function (section) {
            const variants = (section.dataset.variants || '').split(',').filter(Boolean);
            const show = normalized === 'all' || variants.includes(normalized);
            section.classList.toggle('hidden', !show);
          });

          items.forEach(function (item) {
            const variant = item.dataset.dueVariant || 'none';
            const show = normalized === 'all' || variant === normalized;
            item.classList.toggle('hidden', !show);
          });

          buttons.forEach(function (button) {
            const value = button.dataset.filterValue || 'all';
            const isActive = value === normalized;
            button.classList.remove(...allActiveClasses);
            if (isActive) {
              button.classList.add(...(activeClassMap[value] || activeClassMap.all));
            }
          });
        }

        const defaultFilter = 'all';
        applyFilter(defaultFilter);

        buttons.forEach(function (button) {
          button.addEventListener('click', function () {
            applyFilter(button.dataset.filterValue || 'all');
          });
        });
      });
    });
  </script>
{% endblock %}
