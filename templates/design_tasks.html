{% extends "base.html" %}
{% block title %}Design Tasks Â· Eleva ERP{% endblock %}

{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Design</p>
      <h1 class="text-2xl font-semibold">Design Tasks</h1>
      <p class="text-sm text-slate-600">Track requests across stages on a Kanban board.</p>
    </div>
    <button
      type="button"
      data-design-task-modal="designTaskModal"
      class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition"
    >
      <span class="text-lg">+</span> New Task
    </button>
  </div>

  <div id="kanbanBoard">
    {% include "partials/design_tasks_board.html" %}
  </div>
</div>

{% with
  modal_id='designTaskModal',
  modal_title='Create design task',
  submit_label='Create',
  projects=projects,
  users=users,
  default_origin_type='manual',
  default_priority='medium'
%}
  {% include 'partials/design_task_modal.html' %}
{% endwith %}

<script>
  const canMove = {{ 'true' if can_move_cards else 'false' }};
  const statusLabels = {{ statuses|tojson }};
  const kanbanBoard = document.getElementById('kanbanBoard');
  let isDragging = false;

  function formatStatusLabel(status){
    if (statusLabels[status]) return statusLabels[status];
    return status
      .split('_')
      .map((word)=> word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  function updateCardStatus(card, status){
    if (!card) return;
    card.dataset.status = status;
    const badge = card.querySelector('[data-status-label]');
    if (badge){
      badge.textContent = formatStatusLabel(status);
    }
  }

  function initDragAndDrop(){
    if (!canMove || !kanbanBoard) return;
    let dragged = null;
    const dropzones = kanbanBoard.querySelectorAll('.dropzone');
    if (!dropzones.length){
      kanbanBoard.querySelectorAll('[draggable="true"]').forEach(card => {
        card.setAttribute('draggable', 'false');
      });
      return;
    }
    const cardsGrid = kanbanBoard.querySelector('[data-cards-grid]');
    kanbanBoard.querySelectorAll('[draggable="true"]').forEach(card => {
      card.addEventListener('dragstart', ()=>{
        dragged = card;
        isDragging = true;
        setTimeout(()=>card.classList.add('opacity-50'), 0);
      });
      card.addEventListener('dragend', ()=>{
        card.classList.remove('opacity-50');
        dragged = null;
        isDragging = false;
      });
    });
    dropzones.forEach(zone => {
      zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('ring','ring-orange-200');});
      zone.addEventListener('dragleave', ()=> zone.classList.remove('ring','ring-orange-200'));
      zone.addEventListener('drop', (e)=>{
        e.preventDefault();
        zone.classList.remove('ring','ring-orange-200');
        if(!dragged) return;
        const status = zone.dataset.status;
        if (cardsGrid){
          cardsGrid.prepend(dragged);
        }
        updateCardStatus(dragged, status);
        fetch(`/design/tasks/${dragged.dataset.taskId}/status`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({status})
        }).finally(()=>{ isDragging = false; });
      });
    });
  }

  function refreshBoard(){
    if (isDragging || !kanbanBoard) return;
    fetch('/design/tasks/json')
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data && data.html){
          kanbanBoard.innerHTML = data.html;
          initDragAndDrop();
        }
      })
      .catch(()=>{});
  }

  initDragAndDrop();
  setInterval(refreshBoard, 15000);
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden) refreshBoard();
  });
</script>
{% endblock %}
