{% extends "base.html" %}
{% block title %}Design Tasks Â· Eleva ERP{% endblock %}

{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Design</p>
      <h1 class="text-2xl font-semibold">Design Tasks</h1>
      <p class="text-sm text-slate-600">Open tasks in a card list view.</p>
    </div>
    <button
      type="button"
      data-design-task-modal="designTaskModal"
      class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition"
    >
      <span class="text-lg">+</span> New Task
    </button>
  </div>

  {% include "partials/design_tasks_board.html" %}
</div>

{% with
  modal_id='designTaskModal',
  modal_title='Create design task',
  submit_label='Create',
  projects=projects,
  users=users,
  show_origin_fields=False,
  default_priority='medium'
%}
  {% include 'partials/design_task_modal.html' %}
{% endwith %}

<script>
  async function postTaskStatus(taskId, status){
    const response = await fetch(`/design/tasks/${taskId}/update_status`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
      body: JSON.stringify({status})
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.ok){
      throw new Error(data.message || 'Unable to update task status.');
    }
    return data;
  }

  function initStatusControls(){
    document.querySelectorAll('[data-status-select]').forEach(select => {
      select.addEventListener('click', (event) => event.stopPropagation());
      select.addEventListener('mousedown', (event) => event.stopPropagation());
      select.addEventListener('change', async (event) => {
        event.stopPropagation();
        const taskId = select.dataset.taskId;
        const nextStatus = select.value;
        const card = select.closest('[data-task-id]');
        const previousStatus = select.dataset.currentStatus || card?.dataset.status || nextStatus;

        if (!taskId || !card || previousStatus === nextStatus) return;

        select.disabled = true;
        select.dataset.currentStatus = nextStatus;

        try {
          const data = await postTaskStatus(taskId, nextStatus);
          const persistedStatus = data.status;
          select.value = persistedStatus;
          select.dataset.currentStatus = persistedStatus;
          const badge = card.querySelector('[data-status-label]');
          if (badge) badge.textContent = persistedStatus;
        } catch (error) {
          select.value = previousStatus;
          select.dataset.currentStatus = previousStatus;
          window.alert(error.message || 'Unable to update task status. Please try again.');
        } finally {
          select.disabled = false;
        }
      });
    });
  }
  initStatusControls();
</script>
{% endblock %}
