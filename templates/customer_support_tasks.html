{% extends "base.html" %}
{% block title %}Customer Support · Tasks & Tickets{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-500">Customer Support</p>
      <h1 class="mt-1 text-2xl font-semibold text-slate-100">Tasks &amp; tickets</h1>
      <p class="mt-2 max-w-2xl text-sm text-slate-400">Log conversations in seconds, triage priority and move tickets forward with clear context for the entire team.</p>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <button type="button" id="open-add-ticket" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-400/30 transition">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        <span>Add ticket</span>
      </button>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60">
    <div class="flex flex-col gap-3 border-b border-slate-800/60 px-6 py-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Ticket queue</h2>
        <p class="text-sm text-slate-400">Sorted by SLA deadline (soonest first). Use the view action to open the full timeline.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2" data-ticket-filter-group>
        <button type="button" class="rounded-xl border border-slate-700/70 px-3 py-1.5 text-xs text-slate-300 hover:bg-slate-800/70" data-ticket-filter="all">All</button>
        <button type="button" class="rounded-xl border border-rose-500/40 bg-rose-500/10 px-3 py-1.5 text-xs text-rose-200" data-ticket-filter="open" data-ticket-filter-values="open">Open</button>
        <button type="button" class="rounded-xl border border-amber-500/40 bg-amber-500/10 px-3 py-1.5 text-xs text-amber-200" data-ticket-filter="in-progress" data-ticket-filter-values="in-progress">In progress</button>
        <button type="button" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-1.5 text-xs text-emerald-200" data-ticket-filter="closed-resolved" data-ticket-filter-values="resolved,closed">Resolved / Closed</button>
      </div>
    </div>
    <div class="space-y-4 px-4 py-4 sm:px-6">
      {% for ticket in tickets %}
        {% set ticket_status_slug = ticket.status.lower().replace(' ', '-') %}
        {% set has_open_tasks = ticket_open_task_map.get(ticket.id, False) %}
        <div class="flex flex-col gap-3 rounded-2xl border border-slate-800/60 bg-slate-900/70 px-5 py-4 transition hover:bg-slate-800/50" data-ticket-row data-ticket-status="{{ ticket_status_slug }}">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm font-semibold text-slate-100">{{ ticket.id }} · {{ ticket.subject }}</div>
            <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
              <span class="rounded-full bg-slate-900/60 px-3 py-1 text-[11px] text-slate-300">Due {{ ticket._sla_due_display }}</span>
              <span class="text-[11px] text-slate-500">Updated {{ (ticket.updated_at or ticket.created_at).strftime('%d %b %H:%M') }}</span>
              <span class="rounded-full border border-slate-700/70 bg-slate-900/60 px-3 py-1 text-xs text-emerald-200" data-sla-countdown data-sla-deadline="{{ ticket._sla_due_iso }}">Calculating…</span>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-xs text-slate-400">
            <span class="rounded-full bg-slate-800/80 px-3 py-1">{{ ticket.category }}</span>
            <span class="rounded-full bg-slate-800/80 px-3 py-1">{{ ticket.priority }} priority</span>
            <span class="rounded-full bg-slate-800/80 px-3 py-1">{{ ticket.status }}</span>
            {% if ticket.customer %}
              <span class="rounded-full bg-slate-800/80 px-3 py-1">{{ ticket.customer }}</span>
            {% endif %}
            {% if ticket.linked_entities %}
              <div class="flex flex-wrap items-center gap-2">
                {% for entity in ticket.linked_entities %}
                  <a href="{{ entity.url }}" class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-[11px] font-semibold text-emerald-100 hover:bg-emerald-400/20" target="_blank" rel="noopener">
                    <span>{{ entity.label }}:</span>
                    <span>{{ entity.name }}</span>
                  </a>
                {% endfor %}
              </div>
            {% endif %}
            <span>Owner: {{ ticket.assignee }}</span>
            <div class="ml-auto flex items-center gap-2">
              {% if ticket.status not in ['Resolved', 'Closed'] %}
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-emerald-400/50 bg-emerald-400/15 px-3 py-1.5 font-semibold text-emerald-100 hover:bg-emerald-400/25" data-mark-resolved data-ticket-id="{{ ticket.id }}" data-ticket-subject="{{ ticket.subject }}" data-ticket-summary="{{ ticket.id }}{% if ticket.subject %} · {{ ticket.subject }}{% endif %}" data-ticket-has-open-tasks="{{ 'true' if has_open_tasks else 'false' }}">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                  <span>Mark resolved</span>
                </button>
              {% endif %}
              <a href="{{ url_for('customer_support_tasks', ticket=ticket.id) }}" class="inline-flex items-center gap-2 rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-1.5 font-semibold text-emerald-100 hover:bg-emerald-400/30 text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-9A2.25 2.25 0 002.25 5.25v13.5A2.25 2.25 0 004.5 21h9a2.25 2.25 0 002.25-2.25V15M9.75 9l10.5-6v18l-10.5-6z" />
                </svg>
                <span>View</span>
              </a>
            </div>
          </div>
        </div>
      {% else %}
        <div class="px-2 py-10 text-center text-sm text-slate-400 sm:px-6">No tickets logged.</div>
      {% endfor %}
      {% if tickets %}
        <div class="hidden px-2 py-6 text-center text-sm text-slate-400 sm:px-6" data-ticket-empty-state>No tickets match this filter.</div>
      {% endif %}
    </div>
  </div>
</div>

<div id="add-ticket-modal" data-modal class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/70 p-4">
  <div class="relative flex max-h-full w-full max-w-4xl flex-col overflow-hidden rounded-2xl border border-slate-800/60 bg-slate-950/90 shadow-xl shadow-black/40">
    <div class="flex items-center justify-between border-b border-slate-800/60 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Add ticket</h2>
        <p class="text-xs text-slate-500">Capture call or query details in one pass.</p>
      </div>
      <div class="flex items-center gap-3">
        <button type="button" class="rounded-full border border-slate-700/70 bg-slate-900/80 p-2 text-slate-400 hover:text-slate-200" data-close-modal="add-ticket" aria-label="Close add ticket form">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    <div class="overflow-y-auto px-6 py-5">
      <form class="grid gap-5" method="post" action="{{ url_for('customer_support_tasks') }}" enctype="multipart/form-data">
        <input type="hidden" name="form_name" value="create_ticket">
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Contact person</label>
            <input name="contact_name" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Caller name" />
          </div>
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Phone</label>
            <input name="contact_phone" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="+91-98765-43210" />
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Email</label>
            <input name="contact_email" type="email" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="name@example.com" />
          </div>
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Location</label>
            <input name="location" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Site or branch location" />
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Category</label>
            <select name="category" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" data-ticket-category required>
              <option value="" selected disabled>Select category</option>
              {% for category in support_categories %}
                <option value="{{ category.id }}" data-category-label="{{ category.label }}">{{ category.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div data-channel-field>
            <label class="text-xs uppercase tracking-wide text-slate-500">Channel</label>
            <div class="mt-1 grid grid-cols-3 gap-2">
              {% for channel in channels %}
                <label class="flex cursor-pointer flex-col items-center gap-1 rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-xs text-slate-300 hover:border-emerald-400/60" data-channel-option>
                  <input type="radio" name="channel" value="{{ channel.id }}" class="sr-only" required>
                  <span class="text-base">{{ channel.icon }}</span>
                  <span>{{ channel.label }}</span>
                </label>
              {% endfor %}
            </div>
            <p class="mt-2 hidden text-xs text-rose-300" data-channel-error>Select a ticket channel to continue.</p>
          </div>
        </div>
        <div class="hidden rounded-xl border border-emerald-400/30 bg-emerald-500/5 p-4" data-sales-lead-section>
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-emerald-300" data-sales-lead-label>Sales – New installation</p>
              <p class="text-sm text-slate-200">Convert this ticket into a sales enquiry and route it to the right owner.</p>
            </div>
            <label class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-sm font-semibold text-emerald-100">
              <input type="checkbox" name="create_sales_lead" value="1" class="rounded border-emerald-400/60 bg-emerald-900/60" data-sales-lead-toggle>
              <span>Create sales enquiry</span>
            </label>
          </div>
          <div class="mt-3 grid gap-3 sm:grid-cols-2" data-sales-lead-fields>
            <div>
              <label class="text-xs uppercase tracking-wide text-slate-400">Assign owner</label>
              <select name="sales_lead_owner_id" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none">
                <option value="">Unassigned (defaults to you)</option>
                {% for user in active_sales_users %}
                  <option value="{{ user.id }}">{{ user.display_name }}</option>
                {% endfor %}
              </select>
              <p class="mt-1 text-[11px] text-slate-500">We will still create the enquiry even if no owner is chosen.</p>
            </div>
            <div class="rounded-lg border border-emerald-400/30 bg-emerald-500/5 px-3 py-2 text-xs text-emerald-100">
              <p class="font-semibold">What happens?</p>
              <p class="mt-1 text-emerald-100/80">A new lead is created in the sales pipeline with this ticket's subject and customer details.</p>
            </div>
          </div>
        </div>
        <div class="hidden rounded-xl border border-slate-800/60 bg-slate-900/60 p-4 text-sm text-slate-200" data-amc-site-field>
          <label class="text-xs uppercase tracking-wide text-slate-500">AMC lift</label>
          <select name="amc_site" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" data-amc-site-select>
            <option value="" selected disabled>Select lift</option>
            {% for lift in amc_lifts %}
              <option
                value="{{ lift.id }}"
                data-customer-name="{{ lift.customer_name|default('', true) }}"
                data-customer-code="{{ lift.customer_code|default('', true) }}"
                data-client="{{ lift.client|default('', true) }}"
                data-amc-status="{{ lift.amc_status|default('', true) }}"
              >
                {{ lift.label }}{% if lift.customer_name %} · {{ lift.customer_name }}{% elif lift.customer_code %} · {{ lift.customer_code }}{% endif %}{% if lift.amc_status %} · AMC {{ lift.amc_status }}{% endif %}
              </option>
            {% endfor %}
          </select>
          <input type="hidden" name="linked_lift_id" data-linked-lift-input />
          <p class="mt-2 text-[11px] text-slate-500">Only required for Support – AMC tickets.</p>
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Customer name</label>
          <input name="customer" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Customer or site" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Ticket summary</label>
          <textarea name="subject" rows="3" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Describe the customer issue" required></textarea>
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Ticket remarks</label>
          <textarea name="remarks" rows="3" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Add detailed notes or follow-up context"></textarea>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">SLA Priority</label>
            <select name="sla_priority" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" required>
              <option value="" selected disabled>Select SLA priority</option>
              {% for sla in sla_presets %}
                <option value="{{ sla.id }}">{{ sla.label }} · {{ sla.first_response_hours }}h / {{ sla.resolution_hours }}h</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Assign to</label>
            <select name="assignee" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" data-category-source="create-ticket">
              <option value="">Unassigned</option>
              {% if active_support_users %}
                {% for user in active_support_users %}
                  <option value="{{ user.id }}" data-position-id="{{ user.position_id or '' }}">{{ user.display_name }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No ERP users available</option>
              {% endif %}
            </select>
          </div>
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Due/SLA date</label>
          <input name="due_datetime" type="datetime-local" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Attachments</label>
          <div class="mt-1 flex flex-col items-center justify-center gap-3 rounded-xl border border-dashed border-slate-700 bg-slate-900/60 px-4 py-6 text-center text-sm text-slate-400 transition hover:border-emerald-400/60" data-attachment-dropzone tabindex="0" role="button" aria-label="Upload ticket attachments">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-8 w-8 text-slate-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <p data-attachment-instructions>Drop files or click to browse images &amp; videos</p>
            <ul class="hidden w-full text-left text-xs text-slate-300" data-attachment-preview></ul>
            <input name="attachments" type="file" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" class="hidden" data-attachment-input>
          </div>
          <p class="mt-1 text-[11px] text-slate-500">Images, videos or documents up to 200&nbsp;MB each.</p>
        </div>
        <div class="flex items-center justify-end gap-3">
          <button type="reset" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/70">Reset</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-400/30 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
            <span>Create ticket</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="linked-task-modal" data-modal data-open-on-load="{{ 'true' if open_linked_task_modal else 'false' }}" class="fixed inset-0 z-[60] hidden items-center justify-center bg-slate-950/70 p-4">
  <div class="relative flex max-h-full w-full max-w-2xl flex-col overflow-hidden rounded-2xl border border-slate-800/60 bg-slate-950/90 shadow-xl shadow-black/40">
    <div class="flex items-center justify-between border-b border-slate-800/60 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Create linked task</h2>
        <p class="text-xs text-slate-500">Capture a follow-up action directly from this ticket.</p>
      </div>
      <button type="button" class="rounded-full border border-slate-700/70 bg-slate-900/80 p-2 text-slate-400 hover:text-slate-200" data-close-modal="linked-task" aria-label="Close linked task form">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="overflow-y-auto px-6 py-5">
      <form class="grid gap-5" method="post" action="{{ url_for('customer_support_create_linked_task') }}">
        <input type="hidden" name="ticket_id" value="{{ selected_ticket.id if selected_ticket else '' }}">
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Task title</label>
          <input name="title" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="E.g. Schedule technician visit" required />
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-slate-500">Details</label>
          <textarea name="details" rows="3" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Outline the work to be completed"></textarea>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Assign to</label>
            <select name="assignee" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" data-category-source="linked-task">
                <option value="">Unassigned</option>
              {% for user in active_support_users %}
                <option value="{{ user.id }}" data-position-id="{{ user.position_id or '' }}">{{ user.display_name }}</option>
              {% endfor %}
            </select>
            <p class="mt-1 text-[11px] text-slate-500">Only active portal users appear in this list.</p>
          </div>
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Due date</label>
            <input type="date" name="due_date" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Category</label>
            <select name="category" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none">
              {% for category in support_categories %}
                <option value="{{ category.id }}">{{ category.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="text-xs uppercase tracking-wide text-slate-500">Priority</label>
              <select name="priority" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none">
                {% for option in priority_options %}
                  <option value="{{ option }}">{{ option }}</option>
                {% endfor %}
              </select>
          </div>
        </div>
        <div class="flex items-center justify-end gap-3">
          <button type="reset" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/70">Reset</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-400/30 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
              <span>Create linked task</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if selected_ticket %}
  <div id="ticket-detail-modal" data-modal data-open-on-load="{{ 'true' if open_ticket_modal else 'false' }}" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/70 p-4">
    <div class="relative flex max-h-full w-full max-w-5xl flex-col overflow-hidden rounded-2xl border border-slate-800/60 bg-slate-950/90 shadow-xl shadow-black/40">
      <div class="flex items-center justify-between border-b border-slate-800/60 px-6 py-4">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Ticket</p>
          <h2 class="text-xl font-semibold text-slate-100">{{ selected_ticket.subject }}</h2>
          <p class="text-sm text-slate-400">
            {{ selected_ticket.customer }}
            {% if selected_ticket.contact_name %} · {{ selected_ticket.contact_name }}{% endif %}
            {% if selected_ticket.contact_phone %} · {{ selected_ticket.contact_phone }}{% endif %}
            {% if selected_ticket.contact_email %} · {{ selected_ticket.contact_email }}{% endif %}
            {% if selected_ticket.location %} · {{ selected_ticket.location }}{% endif %}
          </p>
          {% if selected_ticket.amc_site %}
            <p class="mt-1 text-xs text-slate-500">AMC site · {{ selected_ticket.amc_site.label }}{% if selected_ticket.amc_site.client %} · {{ selected_ticket.amc_site.client }}{% endif %}</p>
          {% endif %}
          {% if selected_ticket.linked_entities %}
            <div class="mt-3">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-400">Linked records</h3>
              <ul class="mt-1 space-y-1 text-sm text-slate-300">
                {% for entity in selected_ticket.linked_entities %}
                  <li>
                    <a href="{{ entity.url }}" class="text-emerald-200 hover:text-emerald-100" target="_blank" rel="noopener">{{ entity.label }} · {{ entity.name }}</a>
                    {% if entity.description %}
                      <span class="text-xs text-slate-500">· {{ entity.description }}</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {% if selected_ticket.remarks %}
            <p class="mt-2 text-sm text-slate-300 leading-relaxed">{{ selected_ticket.remarks }}</p>
          {% endif %}
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <span class="rounded-full border border-slate-700/70 bg-slate-800/70 px-3 py-1 text-xs text-slate-300">Created {{ selected_ticket.created_at.strftime('%d %b %Y %H:%M') }}</span>
          <span class="rounded-full border border-slate-700/70 bg-slate-800/70 px-3 py-1 text-xs text-slate-300">Updated {{ (selected_ticket.updated_at or selected_ticket.created_at).strftime('%d %b %Y %H:%M') }}</span>
          {% if current_user.is_admin %}
            <form method="post" action="{{ url_for('customer_support_delete_ticket', ticket_id=selected_ticket.id) }}" onsubmit="return confirm('Delete this ticket permanently?');">
              <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-rose-500/50 bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-200 hover:bg-rose-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673A2.25 2.25 0 0 1 15.916 21.75H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                <span>Delete ticket</span>
              </button>
            </form>
          {% endif %}
          <button type="button" class="rounded-full border border-slate-700/70 bg-slate-900/80 p-2 text-slate-400 hover:text-slate-200" data-close-modal="ticket-detail" aria-label="Close ticket details">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto px-6 py-5">
        <div class="grid gap-4 md:grid-cols-2">
          <form method="post" action="{{ url_for('customer_support_update_ticket', ticket_id=selected_ticket.id) }}" class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-4" data-ticket-status-form data-original-status="{{ selected_ticket.status }}" data-has-open-tasks="{{ 'true' if has_open_linked_tasks else 'false' }}" data-ticket-id="{{ selected_ticket.id }}" data-ticket-subject="{{ selected_ticket.subject }}">
            <h3 class="text-sm font-semibold text-slate-200">Status &amp; ownership</h3>
            <input type="hidden" name="closing_comment" value="" data-closing-comment-input>
            <div class="mt-3 space-y-3 text-sm text-slate-300">
              <div class="flex items-center justify-between gap-3">
                <span>Status</span>
                <select name="status" class="rounded-xl border border-slate-700 bg-slate-800 px-3 py-1 text-xs">
                  {% for status in status_options %}
                    <option value="{{ status }}" {{ 'selected' if status == selected_ticket.status else '' }}>{{ status }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex items-center justify-between gap-3">
                <span>Priority</span>
                <select name="priority" class="rounded-xl border border-slate-700 bg-slate-800 px-3 py-1 text-xs">
                  {% for option in priority_options %}
                    <option value="{{ option }}" {{ 'selected' if option == selected_ticket.priority else '' }}>{{ option }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex items-center justify-between gap-3">
                <span>Assignee</span>
                <select name="assignee" class="w-40 rounded-xl border border-slate-700 bg-slate-800 px-3 py-1 text-xs" data-fixed-category="{{ selected_ticket.category }}">
                <option value="" {{ 'selected' if (selected_ticket.get('assignee_user_id') is none and (selected_ticket.assignee or 'Unassigned') == 'Unassigned') else '' }}>Unassigned</option>
                {% for user in active_support_users %}
                  <option value="{{ user.id }}" data-position-id="{{ user.position_id or '' }}" {{ 'selected' if user.id == selected_ticket.get('assignee_user_id') else '' }}>{{ user.display_name }}</option>
                {% endfor %}
                {% if selected_ticket.assignee and selected_ticket.assignee not in ['Unassigned', ''] and selected_ticket.get('assignee_user_id') is none %}
                  <option value="{{ selected_ticket.assignee }}" selected>{{ selected_ticket.assignee }} (not in ERP)</option>
                {% endif %}
                </select>
              </div>
              <div class="flex items-center justify-between gap-3">
                <span>SLA timer</span>
                <span class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs text-emerald-100">{{ selected_ticket.sla.first_response_hours }}h response · {{ selected_ticket.sla.resolution_hours }}h resolution</span>
              </div>
            </div>
            <p class="mt-3 text-xs text-amber-400 hidden" data-open-tasks-warning>
              Linked tasks are still open. Resolve them before marking this ticket as resolved or closed.
            </p>
            <div class="mt-4 flex justify-end">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-3 py-1.5 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
                <span>Save changes</span>
              </button>
            </div>
          </form>
          <div class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-4">
            <h3 class="text-sm font-semibold text-slate-200">Ticket context</h3>
            <div class="mt-3 space-y-3 text-sm text-slate-300">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Category</p>
                <p class="mt-0.5 text-slate-100">{{ selected_ticket.category }}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Channel</p>
                <p class="mt-0.5 text-slate-100">{{ selected_ticket.channel }}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Priority</p>
                <p class="mt-0.5 text-slate-100">{{ selected_ticket.priority }}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Location</p>
                <p class="mt-0.5 text-slate-100">{{ selected_ticket.get('location') or 'Not specified' }}</p>
              </div>
              {% if selected_ticket.amc_site %}
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-500">AMC site</p>
                  <p class="mt-0.5 text-slate-100">{{ selected_ticket.amc_site.label }}{% if selected_ticket.amc_site.client %} · {{ selected_ticket.amc_site.client }}{% endif %}</p>
                </div>
              {% endif %}
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">Due by</p>
                <p class="mt-0.5 text-slate-100">
                  {% set due_date = selected_ticket.get('due_at') or selected_ticket.get('_sla_due_at') %}
                  {% if due_date %}
                    {{ due_date.strftime('%d %b %Y %H:%M') }}
                  {% else %}
                    Not scheduled
                  {% endif %}
                </p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">SLA commitment</p>
                <p class="mt-0.5 text-slate-100">{{ selected_ticket.sla.first_response_hours }}h response · {{ selected_ticket.sla.resolution_hours }}h resolution</p>
              </div>
              {% if selected_ticket.remarks %}
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-500">Ticket remarks</p>
                  <p class="mt-0.5 leading-relaxed text-slate-300">{{ selected_ticket.remarks }}</p>
                </div>
              {% endif %}
            </div>
            {% if ticket_first_update %}
              <div class="mt-4 rounded-xl border border-slate-800/70 bg-slate-900/80 p-3">
                <p class="text-xs uppercase tracking-wide text-slate-500">First comment</p>
                <p class="mt-1 text-sm text-slate-300">{{ ticket_first_update.comment or ticket_first_update.detail or 'No description captured yet.' }}</p>
                <p class="mt-2 text-xs text-slate-500">
                  {% if ticket_first_update.actor %}
                    {{ ticket_first_update.actor }}
                  {% else %}
                    System
                  {% endif %}
                  {% if ticket_first_update.timestamp %}
                    · {{ ticket_first_update.timestamp.strftime('%d %b %Y · %I:%M %p') }}
                  {% endif %}
                </p>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="mt-6 grid gap-4 md:grid-cols-2">
          <div class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-4">
            <h3 class="text-sm font-semibold text-slate-200">Attachments</h3>
            {% if attachments %}
              <div class="mt-3 grid gap-3 sm:grid-cols-2">
                {% for file in attachments %}
                  <a href="{{ file.url }}" target="_blank" rel="noreferrer" class="group flex flex-col gap-2 rounded-xl border border-slate-800/70 bg-slate-900/70 p-3 text-sm text-slate-300 hover:border-emerald-400/50">
                    <span class="text-xs uppercase tracking-wide text-slate-500">{{ file.type }}</span>
                    <span class="font-medium text-slate-100 group-hover:text-emerald-100">{{ file.label }}</span>
                    <span class="text-xs text-slate-500">Open gallery item</span>
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <p class="mt-3 text-sm text-slate-400">No attachments available yet.</p>
            {% endif %}
          </div>
          <div class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-4">
            <div class="flex items-start justify-between gap-2">
              <h3 class="text-sm font-semibold text-slate-200">Linked tasks</h3>
              <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-1 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30" data-open-linked-task>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                </svg>
                <span>Create linked task</span>
              </button>
            </div>
            {% if linked_tasks %}
              <div class="mt-3 space-y-3 text-sm text-slate-300">
                {% for task in linked_tasks %}
                  <div class="rounded-xl border border-slate-800/70 bg-slate-900/70 p-3">
                    <div class="flex items-center justify-between">
                      <span class="font-semibold text-slate-100">{{ task.id }}</span>
                      <span class="text-xs text-slate-500">
                        {% if task.due_date %}
                          Due {{ task.due_date.strftime('%d %b') }}
                        {% else %}
                          No due date
                        {% endif %}
                      </span>
                    </div>
                    <p class="mt-1 text-slate-300">{{ task.title }}</p>
                    <p class="mt-1 text-xs text-slate-500">Assignee: {{ task.assignee }} · Status: {{ task.status }}{% if task.priority %} · Priority: {{ task.priority }}{% endif %}</p>
                    {% if task.details %}
                      <p class="mt-1 text-xs text-slate-400">{{ task.details }}</p>
                    {% endif %}
                    <button type="button" class="mt-3 inline-flex items-center gap-2 rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-1 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">View task</button>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="mt-3 text-sm text-slate-400">No tasks linked yet. Use the button above to spin up a follow-on task.</p>
            {% endif %}
          </div>
        </div>

        <div class="mt-6">
          <form method="post" action="{{ url_for('customer_support_post_update', ticket_id=selected_ticket.id) }}" enctype="multipart/form-data" class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-4">
            <h3 class="text-sm font-semibold text-slate-200">Comments</h3>
            <textarea name="comment" rows="4" class="mt-3 w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100" placeholder="Internal comments stay within the team. Use @mentions to notify."></textarea>
            <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-400">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" name="is_external" value="1" class="rounded border border-slate-600 bg-slate-900 text-emerald-500 focus:ring-emerald-400">
                <span>Mark as external update</span>
              </label>
              <p class="basis-full text-[11px] text-slate-500 sm:basis-auto sm:flex-1">
                External notes are sent to the customer. Leave this unchecked to keep the update internal-only.
              </p>
              <label for="ticket-update-attachments" class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-700/70 px-3 py-1.5 text-emerald-100 hover:border-emerald-400/60 hover:text-emerald-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                </svg>
                <span>Add attachments</span>
              </label>
              <input id="ticket-update-attachments" name="attachments" type="file" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" class="sr-only">
              <span class="text-slate-500">Images, videos or documents up to 200&nbsp;MB each.</span>
              <button type="submit" class="ml-auto inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-3 py-1.5 font-semibold text-emerald-100 hover:bg-emerald-400/30">Post update</button>
            </div>
          </form>
        </div>

        <div class="mt-6">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <h3 class="text-lg font-semibold text-slate-100">Activity timeline</h3>
            <p class="text-xs uppercase tracking-wide text-slate-500">Most recent first</p>
          </div>
          <ol class="mt-4 space-y-5 border-l border-slate-800/60 pl-5">
            {% for entry in timeline %}
              <li class="relative">
                <span class="absolute -left-2.5 top-1.5 h-2.5 w-2.5 rounded-full bg-emerald-400"></span>
                <div class="flex flex-col gap-1 rounded-xl border border-slate-800/60 bg-slate-900/70 p-4">
                  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                    <div class="text-sm font-semibold text-slate-100">{{ entry.label }}</div>
                    <div class="text-xs text-slate-500">{{ entry.timestamp.strftime('%d %b %Y · %I:%M %p') }}</div>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                    <span class="rounded-full bg-slate-800/70 px-2 py-1">{{ entry.actor_label or entry.actor }}</span>
                    <span class="rounded-full bg-slate-800/70 px-2 py-1">{{ entry.type|capitalize }}</span>
                    <span class="rounded-full bg-slate-800/70 px-2 py-1">{{ entry.visibility|capitalize }} note</span>
                  </div>
                  {% if entry.detail %}
                    <p class="text-sm text-slate-300">{{ entry.detail }}</p>
                  {% endif %}
                  {% if entry.comment %}
                    <p class="text-sm text-slate-300">{{ entry.comment }}</p>
                  {% endif %}
                </div>
              </li>
            {% else %}
              <li class="text-sm text-slate-400">No timeline entries available.</li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>
  </div>

{% endif %}

<form method="post" class="hidden" data-quick-resolve-form data-resolve-url-template="{{ url_for('customer_support_mark_ticket_resolved', ticket_id='__TICKET_ID__') }}">
  <input type="hidden" name="closing_comment" data-quick-resolve-comment>
</form>

<div id="closing-remarks-modal" data-modal class="fixed inset-0 z-[55] hidden items-center justify-center bg-slate-950/70 p-4">
  <div class="relative flex w-full max-w-lg flex-col overflow-hidden rounded-2xl border border-slate-800/60 bg-slate-950/90 shadow-xl shadow-black/40">
    <div class="flex items-center justify-between border-b border-slate-800/60 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Add closing remarks</h2>
        <p class="text-xs text-slate-500">Summarise the resolution before you mark the ticket as resolved or closed.</p>
        <p class="hidden pt-1 text-xs text-emerald-300" data-closing-ticket-hint></p>
      </div>
      <button type="button" class="rounded-full border border-slate-700/70 bg-slate-900/80 p-2 text-slate-400 hover:text-slate-200" data-close-modal="closing-remarks" aria-label="Cancel closing remarks">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="space-y-4 px-6 py-5">
      <textarea rows="4" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Describe what changed, who was informed and any follow-ups." data-closing-remarks-textarea></textarea>
      <p class="hidden text-sm text-rose-400" data-closing-error>Please add your closing remarks to proceed.</p>
    </div>
    <div class="flex items-center justify-end gap-3 border-t border-slate-800/60 bg-slate-900/70 px-6 py-4">
      <button type="button" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/70" data-cancel-closing>Cancel</button>
      <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-400/30" data-submit-closing>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
        <span>Save &amp; continue</span>
      </button>
    </div>
  </div>
</div>

<div id="open-tasks-warning-modal" data-modal class="fixed inset-0 z-[56] hidden items-center justify-center bg-slate-950/70 p-4">
  <div class="relative flex w-full max-w-lg flex-col overflow-hidden rounded-2xl border border-slate-800/60 bg-slate-950/90 shadow-xl shadow-black/40">
    <div class="flex items-center justify-between border-b border-slate-800/60 px-6 py-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Linked tasks still open</h2>
        <p class="text-xs text-slate-500">Resolve or close all linked tasks before completing this ticket.</p>
      </div>
      <button type="button" class="rounded-full border border-slate-700/70 bg-slate-900/80 p-2 text-slate-400 hover:text-slate-200" data-close-modal="open-tasks-warning" aria-label="Dismiss warning">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="space-y-4 px-6 py-5">
      <p class="text-sm text-slate-300" data-open-tasks-message>This ticket still has linked tasks in progress. Resolve them before completing the ticket.</p>
      <p class="text-xs text-slate-500">Update the linked tasks to Done, Resolved or Closed, then try again.</p>
    </div>
    <div class="flex items-center justify-end gap-3 border-t border-slate-800/60 bg-slate-900/70 px-6 py-4">
      <button type="button" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/70" data-close-modal="open-tasks-warning">Okay</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const body = document.body;

      const assigneeWhitelist = {{ (assignee_whitelist or {}) | tojson }};
      const categoryAssignments = {{ (category_assignments or {}) | tojson }};

      function getAllowedPositions(categoryId) {
        const positions = categoryAssignments?.[categoryId] || [];
        return Array.isArray(positions)
          ? positions.map((value) => parseInt(value, 10)).filter((value) => !Number.isNaN(value))
          : [];
      }

      function getAllowedUsers(categoryId) {
        const allowed = assigneeWhitelist?.[categoryId] || [];
        return Array.isArray(allowed)
          ? allowed.map((value) => parseInt(value, 10)).filter((value) => !Number.isNaN(value))
          : [];
      }

      function applyAssigneeFilter(select, categoryId) {
        if (!select) return;
        const allowedUsers = getAllowedUsers(categoryId);
        const allowedPositions = getAllowedPositions(categoryId);
        Array.from(select.options).forEach((option) => {
          if (!option.value) {
            option.disabled = false;
            option.hidden = false;
            return;
          }

          const userId = parseInt(option.value, 10);
          const positionId = parseInt(option.dataset.positionId || '', 10);
          const userAllowed = Number.isNaN(userId) ? true : !allowedUsers.length || allowedUsers.includes(userId);
          const positionAllowed = Number.isNaN(positionId) ? true : !allowedPositions.length || allowedPositions.includes(positionId);
          const isAllowed = userAllowed && positionAllowed;
          option.disabled = !isAllowed;
          option.hidden = !isAllowed;
        });

        if (select.value) {
          const current = select.options[select.selectedIndex];
          if (current && current.disabled) {
            select.value = '';
          }
        }
      }

      const mainCategorySelect = document.querySelector('[data-ticket-category]');
      const createAssigneeSelects = Array.from(document.querySelectorAll('[data-category-source="create-ticket"]'));

      function refreshCreateAssignees() {
        const categoryId = mainCategorySelect ? mainCategorySelect.value : '';
        createAssigneeSelects.forEach((select) => applyAssigneeFilter(select, categoryId));
      }

      if (mainCategorySelect) {
        refreshCreateAssignees();
        mainCategorySelect.addEventListener('change', refreshCreateAssignees);
      }

      document.querySelectorAll('[data-category-source="linked-task"]').forEach((select) => {
        const form = select.closest('form');
        const categorySelect = form ? form.querySelector('select[name="category"]') : null;

        const updateLinkedAssignees = () => applyAssigneeFilter(select, categorySelect ? categorySelect.value : '');
        updateLinkedAssignees();

        if (categorySelect) {
          categorySelect.addEventListener('change', updateLinkedAssignees);
        }
      });

      document.querySelectorAll('[data-fixed-category]').forEach((select) => {
        applyAssigneeFilter(select, select.dataset.fixedCategory || '');
      });

      function updateBodyScroll() {
        const anyOpen = Array.from(document.querySelectorAll('[data-modal]')).some((modal) => !modal.classList.contains('hidden'));
        body.classList.toggle('overflow-hidden', anyOpen);
      }

      function openModal(modal) {
        if (!modal) {
          return;
        }
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.add('flex');
        });
        updateBodyScroll();
      }

      function closeModal(modal) {
        if (!modal) {
          return;
        }
        modal.classList.remove('flex');
        modal.classList.add('hidden');
        updateBodyScroll();
        modal.dispatchEvent(new CustomEvent('modal:closed'));
      }

      function setupModal({ trigger, modalId, closeSelectors }) {
        const modal = document.getElementById(modalId);
        if (!modal) {
          return;
        }

        const selectors = Array.isArray(closeSelectors) ? closeSelectors.filter(Boolean) : [];
        const closeButtons = selectors.length ? Array.from(modal.querySelectorAll(selectors.join(','))) : [];

        if (trigger) {
          trigger.addEventListener('click', () => openModal(modal));
        }

        closeButtons.forEach((button) => {
          button.addEventListener('click', () => closeModal(modal));
        });

        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal(modal);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal(modal);
          }
        });

        return modal;
      }

      const addTicketTrigger = document.getElementById('open-add-ticket');
      const addTicketModal = setupModal({
        trigger: addTicketTrigger,
        modalId: 'add-ticket-modal',
        closeSelectors: ['[data-close-modal="add-ticket"]']
      });

      const ticketDetailModal = setupModal({
        trigger: null,
        modalId: 'ticket-detail-modal',
        closeSelectors: ['[data-close-modal="ticket-detail"]']
      });

      const linkedTaskModal = setupModal({
        trigger: null,
        modalId: 'linked-task-modal',
        closeSelectors: ['[data-close-modal="linked-task"]']
      });

      const closingRemarksModal = setupModal({
        trigger: null,
        modalId: 'closing-remarks-modal',
        closeSelectors: ['[data-close-modal="closing-remarks"]']
      });

      const openTasksWarningModal = setupModal({
        trigger: null,
        modalId: 'open-tasks-warning-modal',
        closeSelectors: ['[data-close-modal="open-tasks-warning"]']
      });

      const linkedTaskButtons = Array.from(document.querySelectorAll('[data-open-linked-task]'));
      if (linkedTaskModal && linkedTaskButtons.length) {
        linkedTaskButtons.forEach((button) => {
          button.addEventListener('click', () => openModal(linkedTaskModal));
        });
      }

      const closingTextarea = closingRemarksModal ? closingRemarksModal.querySelector('[data-closing-remarks-textarea]') : null;
      const closingError = closingRemarksModal ? closingRemarksModal.querySelector('[data-closing-error]') : null;
      const closingTicketHint = closingRemarksModal ? closingRemarksModal.querySelector('[data-closing-ticket-hint]') : null;
      const cancelClosingButton = closingRemarksModal ? closingRemarksModal.querySelector('[data-cancel-closing]') : null;
      const confirmClosingButton = closingRemarksModal ? closingRemarksModal.querySelector('[data-submit-closing]') : null;
      let closingContext = null;

      const resetClosingModalState = () => {
        if (closingTextarea) {
          closingTextarea.value = '';
        }
        if (closingError) {
          closingError.classList.add('hidden');
        }
        if (closingTicketHint) {
          closingTicketHint.textContent = '';
          closingTicketHint.classList.add('hidden');
        }
        closingContext = null;
      };

      const showClosingModal = (context = {}) => {
        if (!closingRemarksModal || !closingTextarea) {
          return;
        }
        closingContext = {
          onConfirm: typeof context.onConfirm === 'function' ? context.onConfirm : null,
          onCancel: typeof context.onCancel === 'function' ? context.onCancel : null,
          confirmed: false,
        };
        const initialComment = context.initialComment || '';
        closingTextarea.value = initialComment;
        if (closingError) {
          closingError.classList.add('hidden');
        }
        if (closingTicketHint) {
          const ticketSummary = context.ticketSummary || '';
          if (ticketSummary) {
            closingTicketHint.textContent = `Ticket ${ticketSummary}`;
            closingTicketHint.classList.remove('hidden');
          } else {
            closingTicketHint.textContent = '';
            closingTicketHint.classList.add('hidden');
          }
        }
        openModal(closingRemarksModal);
        window.setTimeout(() => closingTextarea.focus(), 0);
      };

      if (closingRemarksModal) {
        closingRemarksModal.addEventListener('modal:closed', () => {
          if (closingContext && !closingContext.confirmed && typeof closingContext.onCancel === 'function') {
            closingContext.onCancel();
          }
          resetClosingModalState();
        });
      }

      if (cancelClosingButton) {
        cancelClosingButton.addEventListener('click', () => {
          if (closingRemarksModal) {
            closeModal(closingRemarksModal);
          }
        });
      }

      if (confirmClosingButton && closingTextarea) {
        confirmClosingButton.addEventListener('click', () => {
          if (!closingContext) {
            if (closingRemarksModal) {
              closeModal(closingRemarksModal);
            }
            return;
          }
          const value = closingTextarea.value ? closingTextarea.value.trim() : '';
          if (!value) {
            if (closingError) {
              closingError.classList.remove('hidden');
            }
            closingTextarea.focus();
            return;
          }
          if (closingError) {
            closingError.classList.add('hidden');
          }
          closingContext.confirmed = true;
          if (closingContext.onConfirm) {
            closingContext.onConfirm(value);
          }
          if (closingRemarksModal) {
            closeModal(closingRemarksModal);
          }
        });
      }

      const openTasksWarningMessage = openTasksWarningModal ? openTasksWarningModal.querySelector('[data-open-tasks-message]') : null;
      const showOpenTasksWarning = (context = {}) => {
        if (!openTasksWarningModal) {
          return;
        }
        if (openTasksWarningMessage) {
          const ticketSummary = context.ticketSummary || '';
          if (ticketSummary) {
            openTasksWarningMessage.textContent = `Ticket ${ticketSummary} still has linked tasks in progress. Resolve them before completing the ticket.`;
          } else {
            openTasksWarningMessage.textContent = 'This ticket still has linked tasks in progress. Resolve them before completing the ticket.';
          }
        }
        openModal(openTasksWarningModal);
      };

      const addTicketForm = document.querySelector('#add-ticket-modal form');

      const channelField = document.querySelector('[data-channel-field]');
      const channelErrorMessage = channelField ? channelField.querySelector('[data-channel-error]') : null;
      const channelOptions = Array.from(document.querySelectorAll('[data-channel-option] input[type="radio"]'));
      if (channelOptions.length) {
        const refreshChannelState = () => {
          let hasSelection = false;
          channelOptions.forEach((input) => {
            const container = input.closest('[data-channel-option]');
            if (!container) {
              return;
            }
            const isChecked = input.checked;
            hasSelection = hasSelection || isChecked;
            container.classList.toggle('border-emerald-400/60', isChecked);
            container.classList.toggle('bg-emerald-500/10', isChecked);
            container.classList.toggle('ring-1', isChecked);
            container.classList.toggle('ring-emerald-400/60', isChecked);
            container.setAttribute('aria-pressed', isChecked ? 'true' : 'false');
          });

          if (hasSelection) {
            if (channelField) {
              channelField.classList.remove('ring-1', 'ring-rose-500/60');
            }
            if (channelErrorMessage) {
              channelErrorMessage.classList.add('hidden');
            }
          }
        };

        channelOptions.forEach((input) => {
          input.addEventListener('change', refreshChannelState);
          const container = input.closest('[data-channel-option]');
          if (container) {
            container.addEventListener('click', () => {
              if (!input.checked) {
                input.checked = true;
                input.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          }
        });

        refreshChannelState();

        if (addTicketForm) {
          addTicketForm.addEventListener('reset', () => {
            window.setTimeout(() => {
              if (channelField) {
                channelField.classList.remove('ring-1', 'ring-rose-500/60');
              }
              if (channelErrorMessage) {
                channelErrorMessage.classList.add('hidden');
              }
              refreshChannelState();
            }, 0);
          });

          addTicketForm.addEventListener('submit', (event) => {
            const hasChannelSelection = channelOptions.some((input) => input.checked);
            if (!hasChannelSelection) {
              event.preventDefault();
              if (channelField) {
                channelField.classList.add('ring-1', 'ring-rose-500/60');
                channelField.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              if (channelErrorMessage) {
                channelErrorMessage.classList.remove('hidden');
              }
              const firstOption = channelOptions[0];
              if (firstOption && typeof firstOption.focus === 'function') {
                firstOption.focus();
              }
            } else {
              if (channelField) {
                channelField.classList.remove('ring-1', 'ring-rose-500/60');
              }
              if (channelErrorMessage) {
                channelErrorMessage.classList.add('hidden');
              }
            }
          });
        }
      }

      const categorySelect = document.querySelector('[data-ticket-category]');
      const amcSiteField = document.querySelector('[data-amc-site-field]');
      const amcSiteSelect = amcSiteField ? amcSiteField.querySelector('[data-amc-site-select]') : null;
      const customerNameInput = addTicketForm ? addTicketForm.querySelector('input[name="customer"]') : null;
      const linkedLiftInput = addTicketForm ? addTicketForm.querySelector('[data-linked-lift-input]') : null;
      const slaPrioritySelect = addTicketForm ? addTicketForm.querySelector('select[name="sla_priority"]') : null;
      const salesLeadSection = document.querySelector('[data-sales-lead-section]');
      const salesLeadToggle = salesLeadSection ? salesLeadSection.querySelector('[data-sales-lead-toggle]') : null;
      const salesLeadFields = salesLeadSection ? salesLeadSection.querySelector('[data-sales-lead-fields]') : null;
      const salesLeadLabel = salesLeadSection ? salesLeadSection.querySelector('[data-sales-lead-label]') : null;

      const salesLeadCategoryValues = ['sales-ni', 'sales-amc'];
      const updateCustomerRequirement = () => {
        if (!customerNameInput) {
          return;
        }
        customerNameInput.removeAttribute('required');
      };

      const setSalesLeadFieldsEnabled = (enabled) => {
        if (!salesLeadFields) {
          return;
        }
        const controls = Array.from(salesLeadFields.querySelectorAll('select, input, textarea, button'));
        controls.forEach((control) => {
          if (enabled) {
            control.removeAttribute('disabled');
          } else {
            control.setAttribute('disabled', 'disabled');
          }
        });
        salesLeadFields.classList.toggle('opacity-60', !enabled);
      };

      const refreshSalesLeadVisibility = () => {
        const categoryValue = (categorySelect && categorySelect.value ? categorySelect.value : '').toLowerCase();
        const matchesSalesLead = salesLeadCategoryValues.includes(categoryValue);
        if (salesLeadSection) {
          salesLeadSection.classList.toggle('hidden', !matchesSalesLead);
        }
        if (salesLeadLabel) {
          const selectedOption = categorySelect ? categorySelect.options[categorySelect.selectedIndex] : null;
          const selectedLabel = selectedOption
            ? selectedOption.getAttribute('data-category-label') || selectedOption.textContent
            : '';
          salesLeadLabel.textContent = selectedLabel || 'Sales enquiry';
        }
        const enableFields = matchesSalesLead && salesLeadToggle && salesLeadToggle.checked;
        setSalesLeadFieldsEnabled(enableFields);
      };

      const criticalSlaCategories = ['sales-ni', 'sales-amc', 'support-amc'];
      let slaPriorityManuallySelected = false;

      const setDefaultSlaPriority = () => {
        if (!slaPrioritySelect) {
          return;
        }
        const categoryValue = (categorySelect && categorySelect.value ? categorySelect.value : '').toLowerCase();
        const defaultValue = criticalSlaCategories.includes(categoryValue) ? 'critical' : 'standard';
        const hasOption = Array.from(slaPrioritySelect.options).some((option) => option.value === defaultValue);
        if (!slaPriorityManuallySelected && hasOption) {
          slaPrioritySelect.value = defaultValue;
        }
      };

      if (slaPrioritySelect) {
        slaPrioritySelect.addEventListener('change', () => {
          slaPriorityManuallySelected = true;
        });
      }

      const syncCustomerNameForAmcSelection = () => {
        if (!amcSiteSelect || !customerNameInput) {
          return;
        }
        if (!amcSiteSelect.value) {
          if (linkedLiftInput) {
            linkedLiftInput.value = '';
          }
          return;
        }
        const selectedOption = amcSiteSelect.options[amcSiteSelect.selectedIndex];
        if (!selectedOption) {
          return;
        }
        if (linkedLiftInput) {
          linkedLiftInput.value = selectedOption.value;
        }
        const linkedCustomer =
          selectedOption.getAttribute('data-customer-name') ||
          selectedOption.getAttribute('data-client') ||
          selectedOption.getAttribute('data-customer-code');
        if (linkedCustomer) {
          customerNameInput.value = linkedCustomer;
        }
      };

      const refreshAmcSiteVisibility = () => {
        if (!amcSiteField) {
          return;
        }
        const value = (categorySelect && categorySelect.value ? categorySelect.value : '').toLowerCase();
        const isSupportAmc = value === 'support-amc';
        amcSiteField.classList.toggle('hidden', !isSupportAmc);
        if (amcSiteSelect) {
          if (isSupportAmc) {
            amcSiteSelect.removeAttribute('disabled');
            amcSiteSelect.setAttribute('required', 'required');
          } else {
            amcSiteSelect.setAttribute('disabled', 'disabled');
            amcSiteSelect.removeAttribute('required');
            amcSiteSelect.value = '';
            if (linkedLiftInput) {
              linkedLiftInput.value = '';
            }
          }
        }
        updateCustomerRequirement();
      };

      if (categorySelect) {
        categorySelect.addEventListener('change', () => {
          refreshAmcSiteVisibility();
          updateCustomerRequirement();
          refreshSalesLeadVisibility();
          slaPriorityManuallySelected = false;
          setDefaultSlaPriority();
        });
      }
      refreshAmcSiteVisibility();
      updateCustomerRequirement();
      syncCustomerNameForAmcSelection();
      refreshSalesLeadVisibility();
      setDefaultSlaPriority();

      if (salesLeadToggle) {
        salesLeadToggle.addEventListener('change', refreshSalesLeadVisibility);
      }

      if (amcSiteSelect) {
        amcSiteSelect.addEventListener('change', syncCustomerNameForAmcSelection);
      }

      if (addTicketForm) {
        addTicketForm.addEventListener('reset', () => {
          window.setTimeout(() => {
            if (amcSiteSelect) {
              amcSiteSelect.value = '';
            }
            if (linkedLiftInput) {
              linkedLiftInput.value = '';
            }
            refreshAmcSiteVisibility();
            updateCustomerRequirement();
            if (salesLeadToggle) {
              salesLeadToggle.checked = false;
            }
            if (salesLeadFields) {
              const leadSelect = salesLeadFields.querySelector('select[name="sales_lead_owner_id"]');
              if (leadSelect) {
                leadSelect.value = '';
              }
            }
            refreshSalesLeadVisibility();
            slaPriorityManuallySelected = false;
            setDefaultSlaPriority();
          }, 0);
        });
      }

      const attachmentZones = Array.from(document.querySelectorAll('[data-attachment-dropzone]'));
      if (attachmentZones.length) {
        const formatDefaultInstruction = () => 'Drop files or click to browse images & videos';

        attachmentZones.forEach((zone) => {
          const input = zone.querySelector('[data-attachment-input]');
          const instructions = zone.querySelector('[data-attachment-instructions]');
          const previewList = zone.querySelector('[data-attachment-preview]');
          if (!input) {
            return;
          }

          const resetPreview = () => {
            if (previewList) {
              previewList.innerHTML = '';
              previewList.classList.add('hidden');
            }
            if (instructions) {
              instructions.textContent = formatDefaultInstruction();
            }
          };

          const updatePreview = (fileList) => {
            const files = Array.from(fileList || input.files || []);
            if (!previewList) {
              if (instructions) {
                instructions.textContent = files.length
                  ? `${files.length} file${files.length === 1 ? '' : 's'} selected`
                  : formatDefaultInstruction();
              }
              return;
            }

            previewList.innerHTML = '';
            if (!files.length) {
              previewList.classList.add('hidden');
              if (instructions) {
                instructions.textContent = formatDefaultInstruction();
              }
              return;
            }

            files.forEach((file) => {
              const item = document.createElement('li');
              item.textContent = file.name;
              previewList.appendChild(item);
            });
            previewList.classList.remove('hidden');
            if (instructions) {
              instructions.textContent = `${files.length} file${files.length === 1 ? '' : 's'} selected`;
            }
          };

          zone.addEventListener('click', (event) => {
            if (event.target !== input) {
              input.click();
            }
          });

          zone.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              input.click();
            }
          });

          zone.addEventListener('dragover', (event) => {
            event.preventDefault();
            zone.classList.add('border-emerald-400/60');
            zone.classList.add('bg-slate-900/80');
          });

          zone.addEventListener('dragleave', (event) => {
            event.preventDefault();
            zone.classList.remove('border-emerald-400/60');
            zone.classList.remove('bg-slate-900/80');
          });

          zone.addEventListener('drop', (event) => {
            event.preventDefault();
            zone.classList.remove('border-emerald-400/60');
            zone.classList.remove('bg-slate-900/80');
            if (!event.dataTransfer || !event.dataTransfer.files || !event.dataTransfer.files.length) {
              return;
            }

            const droppedFiles = event.dataTransfer.files;
            if (typeof DataTransfer !== 'undefined') {
              const dataTransfer = new DataTransfer();
              Array.from(droppedFiles).forEach((file) => dataTransfer.items.add(file));
              input.files = dataTransfer.files;
              updatePreview(dataTransfer.files);
            } else {
              input.files = droppedFiles;
              updatePreview(droppedFiles);
            }
          });

          input.addEventListener('change', () => updatePreview());

          if (addTicketForm) {
            addTicketForm.addEventListener('reset', () => {
              window.setTimeout(() => {
                input.value = '';
                resetPreview();
              }, 0);
            });
          }
        });
      }

      const filterButtons = Array.from(document.querySelectorAll('[data-ticket-filter]'));
      const ticketRows = Array.from(document.querySelectorAll('[data-ticket-row]'));
      const emptyState = document.querySelector('[data-ticket-empty-state]');

      if (filterButtons.length && ticketRows.length) {
        const activateFilterButton = (activeButton) => {
          filterButtons.forEach((button) => {
            const isActive = button === activeButton;
            button.classList.toggle('ring-1', isActive);
            button.classList.toggle('ring-emerald-400/60', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
        };

        const applyFilterFromButton = (button) => {
          if (!button) {
            return;
          }

          const filterKey = (button.dataset.ticketFilter || '').toLowerCase();
          const valueAttr = button.dataset.ticketFilterValues || '';
          let allowedStatuses = null;

          if (filterKey !== 'all') {
            const parsed = valueAttr
              .split(',')
              .map((value) => value.trim().toLowerCase())
              .filter((value) => value.length > 0);
            allowedStatuses = parsed.length ? parsed : [filterKey];
          }

          let visibleCount = 0;
          ticketRows.forEach((row) => {
            const status = (row.dataset.ticketStatus || '').toLowerCase();
            const shouldShow = !allowedStatuses ? true : allowedStatuses.includes(status);
            row.classList.toggle('hidden', !shouldShow);
            if (shouldShow) {
              visibleCount += 1;
            }
          });

          if (emptyState) {
            emptyState.classList.toggle('hidden', visibleCount !== 0);
          }

          activateFilterButton(button);
        };

        filterButtons.forEach((button) => {
          button.addEventListener('click', () => applyFilterFromButton(button));
        });

        const defaultButton =
          filterButtons.find((button) => (button.dataset.ticketFilter || '').toLowerCase() === 'open') ||
          filterButtons.find((button) => (button.dataset.ticketFilter || '').toLowerCase() === 'all') ||
          filterButtons[0];

        applyFilterFromButton(defaultButton);
      }

      const countdownBadges = Array.from(document.querySelectorAll('[data-sla-countdown]'));
      if (countdownBadges.length) {
        const formatDuration = (milliseconds) => {
          const totalSeconds = Math.max(0, Math.floor(Math.abs(milliseconds) / 1000));
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          if (hours > 0) {
            return `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
          }
          return `${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
        };

        const updateCountdowns = () => {
          const now = Date.now();
          countdownBadges.forEach((badge) => {
            const deadlineIso = badge.dataset.slaDeadline || '';
            const row = badge.closest('[data-ticket-row]');
            const status = (row && row.dataset.ticketStatus ? row.dataset.ticketStatus : '').toLowerCase();
            const isClosed = ['resolved', 'closed'].includes(status);

            if (isClosed) {
              badge.textContent = 'Completed';
              badge.classList.remove('text-emerald-200');
              badge.classList.remove('text-rose-200');
              badge.classList.add('text-slate-300');
              if (row) {
                row.classList.remove('border-rose-500/60');
                row.classList.add('border-slate-800/60');
                row.classList.remove('bg-rose-500/10');
                row.classList.add('bg-slate-900/70');
              }
              return;
            }

            if (!deadlineIso) {
              badge.textContent = 'No SLA deadline';
              badge.classList.remove('text-rose-200');
              badge.classList.remove('text-slate-300');
              badge.classList.add('text-emerald-200');
              if (row) {
                row.classList.remove('border-rose-500/60');
                row.classList.add('border-slate-800/60');
                row.classList.remove('bg-rose-500/10');
                row.classList.add('bg-slate-900/70');
              }
              return;
            }

            const deadline = new Date(deadlineIso);
            if (Number.isNaN(deadline.getTime())) {
              badge.textContent = 'No SLA deadline';
              badge.classList.remove('text-rose-200');
              badge.classList.remove('text-slate-300');
              badge.classList.add('text-emerald-200');
              if (row) {
                row.classList.remove('border-rose-500/60');
                row.classList.add('border-slate-800/60');
                row.classList.remove('bg-rose-500/10');
                row.classList.add('bg-slate-900/70');
              }
              return;
            }

            const diff = deadline.getTime() - now;
            const isOverdue = diff <= 0;
            const isUrgent = diff > 0 && diff <= 60 * 60 * 1000;

            if (isOverdue) {
              if (Math.abs(diff) < 1000) {
                badge.textContent = 'Due now';
              } else {
                badge.textContent = `Overdue by ${formatDuration(diff)}`;
              }
            } else if (diff <= 10 * 1000) {
              badge.textContent = 'Due now';
            } else {
              badge.textContent = `${formatDuration(diff)} remaining`;
            }

            badge.classList.toggle('text-emerald-200', !isUrgent && !isOverdue);
            badge.classList.toggle('text-rose-200', isUrgent || isOverdue);
            badge.classList.toggle('text-slate-300', false);

            if (row) {
              row.classList.toggle('border-rose-500/60', isUrgent || isOverdue);
              row.classList.toggle('border-slate-800/60', !(isUrgent || isOverdue));
              row.classList.toggle('bg-rose-500/10', isOverdue);
              row.classList.toggle('bg-slate-900/70', !isOverdue);
            }
          });
        };

        updateCountdowns();
        window.setInterval(updateCountdowns, 1000);
      }

      const quickResolveForm = document.querySelector('[data-quick-resolve-form]');
      const quickResolveCommentInput = quickResolveForm ? quickResolveForm.querySelector('[data-quick-resolve-comment]') : null;
      const resolveUrlTemplate = quickResolveForm ? quickResolveForm.dataset.resolveUrlTemplate || '' : '';
      const markResolvedButtons = Array.from(document.querySelectorAll('[data-mark-resolved]'));
      if (markResolvedButtons.length) {
        markResolvedButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const ticketId = button.dataset.ticketId || '';
            if (!ticketId || !resolveUrlTemplate || !quickResolveForm || !quickResolveCommentInput) {
              return;
            }
            const ticketSummary = button.dataset.ticketSummary || '';
            const hasOpenTasks = (button.dataset.ticketHasOpenTasks || 'false').toLowerCase() === 'true';
            if (hasOpenTasks) {
              showOpenTasksWarning({ ticketSummary });
              return;
            }
            const initialComment = quickResolveCommentInput.value || '';
            showClosingModal({
              ticketSummary,
              initialComment,
              onConfirm: (value) => {
                quickResolveCommentInput.value = value;
                const action = resolveUrlTemplate.replace('__TICKET_ID__', encodeURIComponent(ticketId));
                quickResolveForm.setAttribute('action', action);
                quickResolveForm.requestSubmit();
              },
              onCancel: () => {
                quickResolveCommentInput.value = '';
              },
            });
          });
        });
      }

      const statusForm = document.querySelector('[data-ticket-status-form]');
      if (statusForm) {
        const statusSelect = statusForm.querySelector('select[name="status"]');
        const closingCommentInput = statusForm.querySelector('[data-closing-comment-input]');
        const warningBanner = statusForm.querySelector('[data-open-tasks-warning]');
        const hasOpenTasks = (statusForm.dataset.hasOpenTasks || 'false').toLowerCase() === 'true';
        const originalStatusValue = statusForm.dataset.originalStatus || '';
        const ticketId = statusForm.dataset.ticketId || '';
        const ticketSubject = statusForm.dataset.ticketSubject || '';
        const ticketSummaryParts = [ticketId, ticketSubject].filter((value) => value && value.length);
        const ticketSummary = ticketSummaryParts.join(' · ');

        statusForm.dataset.closingConfirmed = statusForm.dataset.closingConfirmed || 'false';

        statusForm.addEventListener('submit', (event) => {
          if (!statusSelect) {
            return;
          }

          const selectedStatus = (statusSelect.value || '').toLowerCase();
          const originalStatus = (originalStatusValue || '').toLowerCase();
          const requiresClosing = ['resolved', 'closed'].includes(selectedStatus) && selectedStatus !== originalStatus;
          const closingConfirmed = statusForm.dataset.closingConfirmed === 'true';

          if (requiresClosing && !closingConfirmed) {
            event.preventDefault();

            if (hasOpenTasks) {
              if (warningBanner) {
                warningBanner.classList.remove('hidden');
              }
              if (statusSelect.value !== originalStatusValue) {
                statusSelect.value = originalStatusValue;
              }
              showOpenTasksWarning({ ticketSummary });
              return;
            }

            const initialComment = closingCommentInput && closingCommentInput.value ? closingCommentInput.value : '';
            showClosingModal({
              ticketSummary,
              initialComment,
              onConfirm: (value) => {
                if (closingCommentInput) {
                  closingCommentInput.value = value;
                }
                statusForm.dataset.closingConfirmed = 'true';
                statusForm.requestSubmit();
              },
              onCancel: () => {
                statusForm.dataset.closingConfirmed = 'false';
                if (statusSelect && statusSelect.value !== originalStatusValue) {
                  statusSelect.value = originalStatusValue;
                }
              },
            });
            return;
          }

          if (closingConfirmed) {
            statusForm.dataset.closingConfirmed = 'false';
          }
        });
      }

      if (ticketDetailModal && ticketDetailModal.dataset.openOnLoad === 'true') {
        openModal(ticketDetailModal);
      }

      if (linkedTaskModal && linkedTaskModal.dataset.openOnLoad === 'true') {
        openModal(linkedTaskModal);
      }
    });
  </script>
{% endblock %}
