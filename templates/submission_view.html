{% extends "base.html" %}
{% block content %}
<div class="p-6 rounded-2xl bg-slate-900 border border-slate-800">
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-bold">Submission #{{ sub.id }}</h2>
    <div class="text-sm text-slate-400">{{ sub.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
  </div>
  <div class="mt-4 grid lg:grid-cols-[2fr_1fr] gap-6">
    <div class="space-y-4">
      <div>
        <h3 class="font-semibold mb-3">Checklist</h3>
        {% if data_sectioned and data %}
          <div class="space-y-4">
            {% for section_name, entries in data.items() %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4 space-y-3">
                {% if section_name %}
                  <div class="flex items-center gap-2 text-sm font-semibold text-slate-100">
                    <div class="w-1.5 h-5 rounded-full bg-emerald-500/60"></div>
                    {{ section_name }}
                  </div>
                {% endif %}
                <div class="space-y-3">
                  {% for entry in entries %}
                    {% set entry_type = entry.get('type') %}
                    {% if entry_type == 'table' and entry.get('table') %}
                      {% set table = entry.get('table') %}
                      {% set rows = table.get('rows', []) %}
                      {% set columns = table.get('columns', []) %}
                      {% set values = table.get('values', []) %}
                      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 space-y-3">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                          <div>
                            <div class="text-sm font-medium text-slate-100">{{ entry.label }}</div>
                            <p class="text-xs text-slate-400 mt-1">Recorded measurements</p>
                          </div>
                          {% if table.get('reference_image') %}
                            <img src="{{ table.get('reference_image') }}" alt="Reference for {{ entry.label }}" class="w-32 h-32 object-cover rounded-lg border border-slate-800">
                          {% endif %}
                        </div>
                        <div class="overflow-auto">
                          <table class="min-w-[300px] w-full text-xs border border-slate-800">
                            <thead class="bg-slate-950/60">
                              <tr>
                                <th class="px-3 py-2 text-left border-b border-slate-800">&nbsp;</th>
                                {% for col in columns %}
                                  <th class="px-3 py-2 text-left border-b border-slate-800">{{ col }}</th>
                                {% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for row_label in rows %}
                                {% set r_index = loop.index0 %}
                                <tr class="border-t border-slate-800">
                                  <th class="px-3 py-2 text-left font-medium text-slate-200 border-r border-slate-800">{{ row_label }}</th>
                                  {% for col in columns %}
                                    {% set c_index = loop.index0 %}
                                    {% set row_values = values[r_index] if values|length > r_index else [] %}
                                    {% set cell = row_values[c_index] if row_values and row_values|length > c_index else '' %}
                                    <td class="px-3 py-2 text-slate-200 border-r border-slate-800 last:border-r-0">{{ cell or '—' }}</td>
                                  {% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    {% else %}
                      {% set status = (entry.value|string)|trim %}
                      {% set is_ng = status|lower == 'ng' %}
                      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-3 space-y-2">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                          <div>
                            <div class="text-sm font-medium text-slate-100">{{ entry.label }}</div>
                            <div class="mt-1 text-xs">
                              <span class="px-2 py-0.5 rounded-lg border {{ 'border-rose-500/40 bg-rose-500/15 text-rose-200' if is_ng else 'border-emerald-500/30 bg-emerald-500/10 text-emerald-200' }}">{{ status or '—' }}</span>
                            </div>
                          </div>
                          {% if entry.photos %}
                            <div class="flex flex-wrap gap-2">
                              {% for photo_path in entry.photos %}
                                <img src="/{{ photo_path }}" alt="{{ entry.label }} photo" class="w-16 h-16 rounded-lg object-cover border border-slate-800">
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                        {% if entry.remark %}
                          <div class="text-xs text-slate-300 bg-slate-900/80 border border-slate-800 rounded-lg px-3 py-2">
                            <span class="font-medium text-slate-200">Remark:</span> {{ entry.remark }}
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% elif data is mapping %}
        <div class="space-y-3">
          {% for k, v in data.items() %}
            {% if v is mapping and v.get('type') == 'table' %}
              <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 space-y-3">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium text-slate-100">{{ k }}</div>
                    <p class="text-xs text-slate-400 mt-1">Recorded measurements</p>
                  </div>
                  {% if v.get('reference_image') %}
                    <img src="{{ v.get('reference_image') }}" alt="Reference for {{ k }}" class="w-32 h-32 object-cover rounded-lg border border-slate-800">
                  {% endif %}
                </div>
                {% set rows = v.get('rows', []) %}
                {% set columns = v.get('columns', []) %}
                {% set values = v.get('values', []) %}
                <div class="overflow-auto">
                  <table class="min-w-[300px] w-full text-xs border border-slate-800">
                    <thead class="bg-slate-950/60">
                      <tr>
                        <th class="px-3 py-2 text-left border-b border-slate-800">&nbsp;</th>
                        {% for col in columns %}
                          <th class="px-3 py-2 text-left border-b border-slate-800">{{ col }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for row_label in rows %}
                        {% set r_index = loop.index0 %}
                        <tr class="border-t border-slate-800">
                          <th class="px-3 py-2 text-left font-medium text-slate-200 border-r border-slate-800">{{ row_label }}</th>
                          {% for col in columns %}
                            {% set c_index = loop.index0 %}
                            {% set row_values = values[r_index] if values|length > r_index else [] %}
                            {% set cell = row_values[c_index] if row_values and row_values|length > c_index else '' %}
                            <td class="px-3 py-2 text-slate-200 border-r border-slate-800 last:border-r-0">{{ cell or '—' }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% else %}
              <div class="flex justify-between gap-4 text-sm">
                <span class="text-slate-400">{{ k }}</span>
                <span class="text-slate-200">{{ v }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        {% else %}
          <p class="text-sm text-slate-400">No checklist values recorded.</p>
        {% endif %}
      </div>
    </div>
    <div class="space-y-4">
      <div>
        <h3 class="font-semibold mb-2">All Photos</h3>
        {% if photos %}
          <div class="grid grid-cols-3 gap-2">
            {% for p in photos %}
              <img src="/{{ p }}" class="w-full h-24 object-cover rounded-lg border border-slate-800" alt="Submission photo {{ loop.index }}">
            {% endfor %}
          </div>
        {% else %}
          <p class="text-xs text-slate-500">No photos uploaded.</p>
        {% endif %}
      </div>
      <div>
        <h3 class="font-semibold mb-2">Videos</h3>
        {% if videos %}
          <div class="space-y-2">
            {% for v in videos %}
              <video src="/{{ v }}" controls class="w-full rounded-lg border border-slate-800"></video>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-xs text-slate-500">No videos uploaded.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
