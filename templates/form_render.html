{% extends "base.html" %}
{% block content %}
{% set preview_mode = preview_only|default(False) %}
{% set form_data = preserved_data or {} %}
<div class="p-6 rounded-2xl bg-slate-900 border border-slate-800" data-form-preview="{{ 'true' if preview_mode else 'false' }}">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div>
      <h2 class="text-xl font-semibold">{{ fs.name }}</h2>
      <p class="text-xs text-slate-400">Tap the camera icon for photo evidence and the note icon for quick remarks.</p>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <a href="{{ back_url or url_for('forms_list') }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-700 bg-slate-800/70 text-sm text-slate-200 hover:bg-slate-700/70" data-back-button>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        <span>Back</span>
      </a>
      {% if not preview_mode %}
        <button type="button" id="save-progress-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-emerald-400/50 bg-emerald-500/10 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/20">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12l5 5L20 7" />
          </svg>
          <span>Save progress</span>
        </button>
      {% endif %}
      {% if preview_mode %}
        <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-emerald-400/60 bg-emerald-500/10 text-emerald-200 text-xs font-semibold">Preview only</span>
      {% endif %}
    </div>
  </div>

  {% if resubmission_notice|default(False) %}
    <div class="mb-6 rounded-xl border border-amber-400/40 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
      Only the checklist items marked <span class="font-semibold">Not OK</span> in the last submission are available to resubmit for this task.
    </div>
  {% endif %}

  {% if preview_mode %}
    <div class="space-y-2 text-sm text-slate-400 mb-4">
      <p>All inputs are disabled in preview mode. Use <span class="font-semibold text-emerald-200">New Submission</span> to fill this form.</p>
    </div>
  {% endif %}

  {% if preview_mode %}
    <div class="space-y-6">
  {% else %}
    <form method="post" enctype="multipart/form-data" class="space-y-6" data-track-unsaved>
  {% endif %}
    {% if sections %}
      <div class="space-y-6">
        {% for block in sections %}
          {% set outer_index = loop.index0 %}
          <div class="space-y-4">
            {% if block.section %}
              <div class="flex items-center gap-3">
                <div class="w-1.5 h-6 rounded-full bg-emerald-500/60"></div>
                <h3 class="text-lg font-semibold text-slate-100">{{ block.section }}</h3>
              </div>
            {% endif %}

            <div class="space-y-3">
              {% for field in block.get("items", []) %}
                {% set field_index = loop.index0 %}
                {% set field_name = 'field__%d__%d' % (outer_index, field_index) %}
                {% set remark_name = 'remark__%d__%d' % (outer_index, field_index) %}
                {% set photo_name = 'photo__%d__%d' % (outer_index, field_index) %}
                {% set remark_block_id = 'remark-block__%d__%d' % (outer_index, field_index) %}
                {% set remark_value = form_data.get(remark_name, '') %}
                <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-inner shadow-black/10">
                  {% if field.type == 'table' %}
                    <div class="space-y-4">
                      <div class="flex flex-col md:flex-row md:items-start md:gap-4">
                        <div class="md:w-1/3 space-y-3">
                          <p class="text-sm font-medium text-slate-100 flex items-center gap-2">
                            {{ field.label }}
                            {% if field.required %}<span class="text-rose-400">*</span>{% endif %}
                          </p>
                          {% if field.reference_image %}
                            <img src="{{ field.reference_image }}" alt="Reference for {{ field.label }}" class="w-full max-w-[180px] rounded-lg border border-slate-800 object-cover">
                          {% endif %}
                          <p class="text-[11px] text-slate-500">Enter values for each measurement cell.</p>
                        </div>
                        <div class="flex-1 overflow-auto">
                          {% set rows = field.rows or [] %}
                          {% set columns = field.columns or [] %}
                          <table class="min-w-[360px] w-full text-xs border border-slate-800">
                            <thead class="bg-slate-950/60">
                              <tr>
                                <th class="px-3 py-2 text-left border-b border-slate-800">&nbsp;</th>
                                {% for col in columns %}
                                  <th class="px-3 py-2 text-left border-b border-slate-800">{{ col }}</th>
                                {% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for row_label in rows %}
                                {% set r_index = loop.index0 %}
                                <tr class="border-t border-slate-800">
                                  <th class="px-3 py-2 text-left font-medium text-slate-200 border-r border-slate-800">{{ row_label }}</th>
                                  {% for col in columns %}
                                    {% set c_index = loop.index0 %}
                                    <td class="px-3 py-2 border-r border-slate-800 last:border-r-0">
                                      <input type="text" name="table__{{ outer_index }}__{{ field_index }}__{{ r_index }}__{{ c_index }}" value="{{ form_data.get('table__%d__%d__%d__%d' % (outer_index, field_index, r_index, c_index), '') }}" class="w-full px-2 py-1.5 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 text-slate-100" {% if field.required and not preview_mode %}required{% endif %} {% if preview_mode %}disabled{% endif %}>
                                    </td>
                                  {% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="flex flex-col md:flex-row md:items-center md:gap-4">
                      <div class="md:w-1/3">
                        <p class="text-sm font-medium text-slate-100 flex items-center gap-2">
                          {{ field.label }}
                          {% if field.required %}<span class="text-rose-400">*</span>{% endif %}
                        </p>
                        {% if field.type == 'select' and field.photo_required_if_ng %}
                          <p class="text-[11px] text-amber-400 mt-1">Photo needed when Not OK is selected.</p>
                        {% endif %}
                      </div>
                      <div class="flex-1 w-full">
                        {% if field.type == 'text' %}
                          <input name="{{ field_name }}" value="{{ form_data.get(field_name, '') }}" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" {% if field.required and not preview_mode %}required{% endif %} {% if preview_mode %}disabled{% endif %}>
                        {% elif field.type == 'textarea' %}
                          <textarea name="{{ field_name }}" rows="2" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" {% if field.required and not preview_mode %}required{% endif %} {% if preview_mode %}disabled{% endif %}>{{ form_data.get(field_name, '') }}</textarea>
                        {% else %}
                          <select name="{{ field_name }}" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" {% if field.required and not preview_mode %}required{% endif %} {% if preview_mode %}disabled{% endif %}>
                            <option value="" {% if not form_data.get(field_name) %}selected{% endif %}>-- Select --</option>
                            {% for opt in field.options %}
                              <option value="{{ opt }}" {% if form_data.get(field_name) == opt %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                          </select>
                        {% endif %}
                      </div>
                      <div class="flex items-center gap-2 mt-3 md:mt-0">
                        {% if field.allow_photo %}
                          <button type="button" class="photo-trigger inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-700 bg-slate-800/70 hover:bg-slate-700/70 transition {% if preview_mode %}opacity-60 cursor-not-allowed{% endif %}" data-target="{{ photo_name }}" title="Attach photos" {% if preview_mode %}disabled aria-disabled="true"{% endif %}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                              <path d="M5 4h3l1-1h6l1 1h3a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2zm7 13a4 4 0 100-8 4 4 0 000 8z" />
                            </svg>
                          </button>
                          <input type="file" name="{{ photo_name }}" id="{{ photo_name }}" class="sr-only" accept="image/*" multiple {% if preview_mode %}disabled{% endif %}>
                        {% endif %}
                        {% if field.allow_remark %}
                          <button type="button" class="remark-trigger inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-700 bg-slate-800/70 hover:bg-slate-700/70 transition{{ ' bg-emerald-500/20 border-emerald-400/70' if remark_value else '' }} {% if preview_mode %}opacity-60 cursor-not-allowed{% endif %}" data-target="{{ remark_block_id }}" title="Add remark" {% if preview_mode %}disabled aria-disabled="true"{% endif %}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                              <path d="M4 4h16a2 2 0 012 2v10a2 2 0 01-2 2h-5l-4 4v-4H4a2 2 0 01-2-2V6a2 2 0 012-2z" />
                            </svg>
                          </button>
                        {% endif %}
                      </div>
                    </div>
                    {% if field.allow_remark %}
                      <div id="{{ remark_block_id }}" class="{% if not remark_value %}hidden {% endif %}mt-3">
                        <label class="block text-xs text-slate-400 mb-1">Remark</label>
                        <textarea name="{{ remark_name }}" rows="2" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" {% if preview_mode %}disabled{% endif %}>{{ remark_value }}</textarea>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-slate-400">This form does not have any configured items yet.</p>
    {% endif %}

    {% if not preview_mode %}
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Supporting Photos (optional)</label>
          <input type="file" name="photos" multiple accept="image/*" class="w-full text-sm">
        </div>
        <div>
          <label class="block text-sm mb-1">Videos (optional, multiple)</label>
          <input type="file" name="videos" multiple accept="video/*" class="w-full text-sm">
        </div>
      </div>

      <div class="flex flex-wrap justify-end gap-2">
        <button type="button" id="save-progress-footer" class="px-4 py-2 rounded-xl border border-slate-700 bg-slate-800/80 text-sm text-slate-200 hover:bg-slate-700/70">Save progress</button>
        <button class="px-5 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 border border-emerald-500/60 shadow shadow-black/20 transition">Submit</button>
      </div>
    {% endif %}

  {% if preview_mode %}
    </div>
  {% else %}
    </form>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const previewMode = document.querySelector('[data-form-preview="true"]') !== null;
    const draftKey = '{{ draft_key|default("") }}';
    const formEl = document.querySelector('[data-track-unsaved]');
    let isDirty = false;

    if (!previewMode) {
      document.querySelectorAll('.photo-trigger').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.dataset.target);
          if (target) {
            target.click();
          }
        });
      });
    }

    document.querySelectorAll('.remark-trigger').forEach(btn => {
      if (previewMode) return;
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        const isHidden = target.classList.toggle('hidden');
        btn.classList.toggle('bg-emerald-500/20', !isHidden);
        btn.classList.toggle('border-emerald-400/70', !isHidden);
      });
    });

    if (!previewMode) {
      document.querySelectorAll('input[type="file"]').forEach(input => {
        const trigger = document.querySelector(`.photo-trigger[data-target="${input.id}"]`);
        if (!trigger) return;
        input.addEventListener('change', () => {
          const hasFiles = input.files && input.files.length > 0;
          trigger.classList.toggle('bg-emerald-500/20', hasFiles);
          trigger.classList.toggle('border-emerald-400/70', hasFiles);
        });
      });

      const persistableFields = () => {
        if (!formEl) return [];
        return Array.from(formEl.querySelectorAll('input, textarea, select')).filter(el => el.name && el.type !== 'file');
      };

      const saveDraft = () => {
        if (!draftKey || !formEl) return;
        const payload = {};
        persistableFields().forEach(el => {
          payload[el.name] = el.value;
        });
        try {
          localStorage.setItem(draftKey, JSON.stringify(payload));
          isDirty = false;
          alert('Progress saved to this browser.');
        } catch (error) {
          console.warn('Unable to save draft', error);
        }
      };

      const loadDraft = () => {
        if (!draftKey || !formEl) return;
        const raw = localStorage.getItem(draftKey);
        if (!raw) return;
        try {
          const saved = JSON.parse(raw);
          persistableFields().forEach(el => {
            if (!(el.name in saved)) return;
            el.value = saved[el.name];
            if (el.name.startsWith('remark__') && saved[el.name]) {
              const remarkBlock = el.closest('div[id^="remark-block__"]');
              if (remarkBlock) {
                remarkBlock.classList.remove('hidden');
                const toggleBtn = document.querySelector(`[data-target="${remarkBlock.id}"]`);
                if (toggleBtn) {
                  toggleBtn.classList.add('bg-emerald-500/20', 'border-emerald-400/70');
                }
              }
            }
          });
          isDirty = false;
        } catch (error) {
          console.warn('Unable to restore draft', error);
        }
      };

      loadDraft();

      persistableFields().forEach(el => {
        el.addEventListener('input', () => { isDirty = true; });
        el.addEventListener('change', () => { isDirty = true; });
      });

      const saveButtons = [
        document.getElementById('save-progress-btn'),
        document.getElementById('save-progress-footer')
      ].filter(Boolean);
      saveButtons.forEach(btn => btn.addEventListener('click', saveDraft));

      if (formEl) {
        formEl.addEventListener('submit', () => {
          isDirty = false;
          if (draftKey) {
            localStorage.removeItem(draftKey);
          }
        });

        window.addEventListener('beforeunload', (event) => {
          if (!isDirty) return;
          event.preventDefault();
          event.returnValue = '';
        });
      }

      const backButton = document.querySelector('[data-back-button]');
      if (backButton) {
        backButton.addEventListener('click', (event) => {
          if (isDirty && !confirm('You have unsaved changes. Leave this form without saving?')) {
            event.preventDefault();
          }
        });
      }
    }
  });
</script>
{% endblock %}
