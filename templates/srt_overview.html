{% extends "base.html" %}
{% block title %}Eleva ERP – SRT Overview{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
  <div class="rounded-2xl bg-slate-800/70 border border-slate-700/70 p-5">
    <p class="text-sm text-slate-400">Pending SRT Tasks</p>
    <p class="text-3xl font-semibold text-white mt-2">{{ summary.total_pending }}</p>
    <p class="text-xs text-slate-500 mt-3">Includes all open and in-progress SRT activities.</p>
  </div>
  <div class="rounded-2xl bg-slate-800/70 border border-slate-700/70 p-5">
    <p class="text-sm text-slate-400">High Priority</p>
    <p class="text-3xl font-semibold text-rose-300 mt-2">{{ summary.high_priority }}</p>
    <p class="text-xs text-slate-500 mt-3">Tasks flagged high priority and still pending closure.</p>
  </div>
  <div class="rounded-2xl bg-slate-800/70 border border-slate-700/70 p-5">
    <p class="text-sm text-slate-400">Due in 7 Days</p>
    <p class="text-3xl font-semibold text-amber-300 mt-2">{{ summary.due_this_week }}</p>
    <p class="text-xs text-slate-500 mt-3">Upcoming deadlines within the next week.</p>
  </div>
  <div class="rounded-2xl bg-slate-800/70 border border-slate-700/70 p-5">
    <p class="text-sm text-slate-400">Oldest Task Age</p>
    <p class="text-3xl font-semibold text-sky-300 mt-2">{{ summary.oldest_age }}<span class="text-base font-medium"> days</span></p>
    <p class="text-xs text-slate-500 mt-3">Age calculated from creation date of oldest open task.</p>
  </div>
</div>

<div class="rounded-2xl bg-slate-900/60 border border-slate-800/60">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 px-6 py-4 border-b border-slate-800/70">
    <div>
      <h2 class="text-xl font-semibold text-white">SRT Taskboard</h2>
      <p class="text-sm text-slate-400">Monitor outstanding service recovery tasks across active client sites.</p>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <a href="{{ url_for('srt_overview') }}"
         class="px-3 py-1.5 rounded-full border border-slate-700/70 text-sm {{ 'bg-slate-800 text-white' if status_filter in ['all', ''] else 'text-slate-300 hover:bg-slate-800/80' }}">All</a>
      <a href="{{ url_for('srt_overview', status='pending') }}"
         class="px-3 py-1.5 rounded-full border border-slate-700/70 text-sm {{ 'bg-slate-800 text-white' if status_filter in ['pending', 'open'] else 'text-slate-300 hover:bg-slate-800/80' }}">Pending</a>
      <a href="{{ url_for('srt_overview', status='in-progress') }}"
         class="px-3 py-1.5 rounded-full border border-slate-700/70 text-sm {{ 'bg-slate-800 text-white' if status_filter in ['in-progress', 'in_progress'] else 'text-slate-300 hover:bg-slate-800/80' }}">In Progress</a>
      <a href="{{ url_for('srt_overview', status='closed') }}"
         class="px-3 py-1.5 rounded-full border border-slate-700/70 text-sm {{ 'bg-slate-800 text-white' if status_filter in ['closed', 'completed'] else 'text-slate-300 hover:bg-slate-800/80' }}">Closed</a>
      <button type="button"
              class="ml-0 md:ml-3 inline-flex items-center gap-2 rounded-full border border-emerald-500/40 bg-emerald-500/20 px-3 py-1.5 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 transition"
              data-srt-overview-open>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        <span>Add SRT task</span>
      </button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-800/70">
      <thead class="bg-slate-900/80">
        <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-400">
          <th class="px-6 py-3">Task ID</th>
          <th class="px-6 py-3">Site</th>
          <th class="px-6 py-3">Summary</th>
          <th class="px-6 py-3">Priority</th>
          <th class="px-6 py-3">Status</th>
          <th class="px-6 py-3">Due Date</th>
          <th class="px-6 py-3">Due In</th>
          <th class="px-6 py-3">Owner</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800/60">
        {% if tasks %}
          {% for task in tasks %}
            <tr class="text-sm text-slate-200">
              <td class="px-6 py-4 font-medium">{{ task.id }}</td>
              <td class="px-6 py-4">
                <div class="font-medium text-white">{{ task.site }}</div>
                <div class="text-xs text-slate-400">SRT Age: {{ task.age_days }} days</div>
              </td>
              <td class="px-6 py-4 text-slate-300">{{ task.summary }}</td>
              <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-rose-500/20 text-rose-300' if task.priority == 'High' else 'bg-amber-400/20 text-amber-200' if task.priority == 'Medium' else 'bg-emerald-500/20 text-emerald-200' }}">{{ task.priority }}</span>
              </td>
              <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-sky-500/20 text-sky-200' if task.status == 'In Progress' else 'bg-emerald-500/20 text-emerald-200' if task.status == 'Closed' else 'bg-slate-500/20 text-slate-200' }}">{{ task.status }}</span>
              </td>
              <td class="px-6 py-4">{{ task.due_date.strftime('%d %b %Y') if task.due_date }}</td>
              <td class="px-6 py-4">
                {% if task.due_in is not none %}
                  {% if task.due_in < 0 %}
                    <span class="text-rose-300">Overdue {{ task.due_in | abs }}d</span>
                  {% elif task.due_in == 0 %}
                    <span class="text-amber-300">Due today</span>
                  {% else %}
                    <span class="text-emerald-300">Due in {{ task.due_in }}d</span>
                  {% endif %}
                {% else %}
                  <span class="text-slate-400">—</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-slate-300">{{ task.owner }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="px-6 py-6 text-center text-slate-400 text-sm">No tasks found for the selected filter.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% set overview_redirect = url_for('srt_overview', status=status_filter) if status_filter not in ['all', ''] else url_for('srt_overview') %}

<div id="srt-overview-task-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 p-4 backdrop-blur-sm">
  <div class="w-full max-w-xl rounded-2xl border border-slate-800 bg-slate-900/90 shadow-2xl shadow-black/40">
    <div class="flex items-center justify-between gap-3 border-b border-slate-800 px-6 py-4">
      <div>
        <h3 class="text-lg font-semibold text-slate-100">Add SRT task</h3>
        <p class="text-xs text-slate-400">Create a follow-up item directly from the taskboard view.</p>
      </div>
      <button type="button" class="rounded-xl border border-slate-700/70 bg-slate-800/70 p-2 text-slate-300 hover:text-white transition" data-srt-overview-close aria-label="Close add task modal">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form method="post" action="{{ url_for('srt_task_create') }}" class="px-6 py-5 space-y-4">
      <input type="hidden" name="redirect_to" value="{{ overview_redirect }}" />
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Site</label>
          <select name="site_name" required class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm" data-srt-site-select>
            <option value="" disabled selected>Select site</option>
            {% for site in site_options %}
              <option value="{{ site.name }}">{{ site.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Priority</label>
          <select name="priority" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Task summary</label>
        <input name="summary" required class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm" placeholder="Eg. Close loop on client safety observation" data-srt-autofocus />
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Owner</label>
          <select name="owner" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm">
            <option value="">Unassigned</option>
            {% for member in team_members %}
              <option value="{{ member }}">{{ member }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Due date</label>
          <input type="date" name="due_date" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm" />
        </div>
      </div>
      <div class="flex items-center justify-end gap-3">
        <button type="button" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:text-white transition" data-srt-overview-close>Cancel</button>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          <span>Create task</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('srt-overview-task-modal');
    if (!modal) {
      return;
    }

    const openButtons = document.querySelectorAll('[data-srt-overview-open]');
    const closeButtons = modal.querySelectorAll('[data-srt-overview-close]');
    const summaryField = modal.querySelector('[data-srt-autofocus]');

    const openModal = () => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (summaryField) {
        setTimeout(() => summaryField.focus(), 50);
      }
    };

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    openButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        openModal();
      });
    });

    closeButtons.forEach((button) => {
      button.addEventListener('click', () => {
        closeModal();
      });
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modal.classList.contains('flex')) {
        closeModal();
      }
    });
  });
</script>
{% endblock %}
