{% extends "base.html" %}
{% block title %}Design Task {{ task.id }} · Eleva ERP{% endblock %}

{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Design Task · {{ task.task_type.replace('_',' ').title() }}</p>
      <h1 class="text-2xl font-semibold">{{ task.description or task.project_label }}</h1>
      {% set can_update_status = current_user.is_admin or 'design' in (current_user.role or '').lower() %}
      {% set status_styles = {
        'Pending Inputs': 'bg-slate-500 text-white',
        'Drawing': 'bg-blue-500 text-white',
        'In Drawing': 'bg-indigo-500 text-white',
        'Sent for Approval': 'bg-amber-500 text-slate-900',
        'Approved': 'bg-emerald-500 text-white',
        'Revision Needed': 'bg-rose-500 text-white',
        'Finalized': 'bg-teal-600 text-white',
        'In Preparation': 'bg-blue-500 text-white',
        'Revised': 'bg-rose-500 text-white'
      } %}
      <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
        {% if task.project_id %}
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-slate-100 text-slate-700">Project: {{ task.project_label }}</span>
        {% else %}
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-red-100 text-red-700">Unlinked project</span>
        {% endif %}
        <div class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-slate-100 text-slate-700">
          <span class="uppercase text-[10px] tracking-wide text-slate-500">Status</span>
          <span
            data-status-pill
            class="px-2 py-0.5 rounded-full text-xs font-semibold {{ status_styles.get(task.status, 'bg-slate-500 text-white') }}"
          >
            {{ task.status }}
          </span>
          {% if task.has_pending_inputs %}
          <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">Inputs pending</span>
          {% endif %}
          {% if can_update_status %}
          <label class="sr-only" for="taskStatusSelect">Update status</label>
          <select
            id="taskStatusSelect"
            class="design-task-status-select rounded-md px-2 py-1 text-xs"
            data-task-status-select
            data-task-id="{{ task.id }}"
            data-current-status="{{ task.status }}"
          >
            {% for status in task_status_options %}
            <option value="{{ status }}" {% if status == task.status %}selected{% endif %}>
              {{ status }}
            </option>
            {% endfor %}
          </select>
          {% endif %}
        </div>
        {% if task.origin_type %}
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-slate-900 text-white">Origin: {{ task.origin_type.title() }} {% if task.origin_reference %}· {{ task.origin_reference }}{% endif %}</span>
        {% endif %}
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button
        type="button"
        data-modal-target="editDesignTaskModal"
        class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50"
      >
        Edit Task
      </button>
      {% if task.task_type == 'sales_query' or task.origin_type == 'sales' %}
      <button id="openClarificationModal" class="px-4 py-2 rounded-xl border border-orange-200 text-orange-700 bg-orange-50 hover:bg-orange-100">Request Clarification from Sales</button>
      {% endif %}
      <a href="{{ url_for('design_tasks') }}" class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50">Back to board</a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2 space-y-4">
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase text-slate-500">Task summary</p>
            <h2 class="text-lg font-semibold">{{ task.description or 'No description yet' }}</h2>
          </div>
          <div class="flex items-center gap-2">
            <span
              data-status-summary
              class="px-3 py-1 rounded-full text-sm font-semibold {{ status_styles.get(task.status, 'bg-slate-500 text-white') }}"
            >
              {{ task.status }}
            </span>
            {% if task.has_pending_inputs %}
            <span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">Inputs pending</span>
            {% endif %}
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-slate-600">
          <div class="p-3 bg-slate-50 rounded-xl">Priority: <strong>{{ task.priority.title() }}</strong></div>
          <div class="p-3 bg-slate-50 rounded-xl">Due: <strong>{{ task.due_date or '—' }}</strong></div>
          <div class="p-3 bg-slate-50 rounded-xl">Designer: <strong>{{ task.assigned_to.display_name if task.assigned_to else 'Unassigned' }}</strong></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase text-slate-500">Drawings</p>
            <h2 class="text-lg font-semibold">Drawing packages</h2>
          </div>
          <button
            type="button"
            data-modal-target="newDrawingModal"
            class="px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition"
          >
            + Upload new drawing
          </button>
        </div>
        {% if not task.project_id %}
        <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
          This task is unlinked to a project. Link it to keep drawings organized.
        </div>
        {% endif %}
        <div class="space-y-4">
          {% for type_option in drawing_type_options %}
          {% set drawings_for_type = drawings_by_type.get(type_option.value, []) %}
          <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-800">{{ type_option.label }}</h3>
              <span class="text-xs text-slate-500">{{ drawings_for_type|length }} drawings</span>
            </div>
            <div class="mt-3 space-y-3">
              {% for drawing in drawings_for_type %}
              {% set latest_revision = latest_revisions.get(drawing.id) %}
              {% set last_updated = latest_revision.created_at if latest_revision and latest_revision.created_at else drawing.updated_at %}
              <div class="rounded-xl border border-slate-200 bg-white p-3">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <div>
                    <p class="text-sm font-semibold">{{ drawing.name }}</p>
                    <p class="text-xs text-slate-500">Current v{{ drawing.current_version_number }}</p>
                    <p class="text-xs text-slate-500">Last updated {{ last_updated|format_india_datetime('%d %b %Y, %I:%M %p') if last_updated else '—' }}</p>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="px-2 py-1 rounded-lg text-xs bg-slate-100 text-slate-700">{{ drawing.status }}</span>
                      <form method="POST" class="flex items-center gap-1">
                        {{ csrf_field() }}
                        <input type="hidden" name="action" value="update_drawing_status" />
                        <input type="hidden" name="drawing_id" value="{{ drawing.id }}" />
                        <select name="status" class="rounded-lg border-slate-200 text-xs">
                          {% for status in drawing_status_options %}
                          <option value="{{ status }}" {% if drawing.status == status %}selected{% endif %}>{{ status }}</option>
                          {% endfor %}
                        </select>
                        <button type="submit" class="px-2 py-1 rounded-lg border text-xs">Update</button>
                      </form>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      <button
                        type="button"
                        data-revision-modal="revisionUploadModal"
                        data-drawing-id="{{ drawing.id }}"
                        data-drawing-name="{{ drawing.name }}"
                        class="px-3 py-1.5 rounded-lg border border-slate-200 text-xs hover:bg-slate-50"
                      >
                        Upload revision
                      </button>
                      {% if latest_revision %}
                      <a
                        href="{{ url_for('static', filename='uploads/' ~ latest_revision.file_name) }}"
                        class="px-3 py-1.5 rounded-lg border border-slate-200 text-xs hover:bg-slate-50"
                        download
                      >
                        Download latest
                      </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="mt-3 max-h-48 overflow-y-auto space-y-2 border-t border-slate-100 pt-3">
                  {% set sorted_revisions = drawing.revisions|sort(attribute='version_number', reverse=True) %}
                  {% for rev in sorted_revisions %}
                  <div class="flex items-start gap-3 text-xs text-slate-600">
                    <div class="px-2 py-1 bg-slate-100 rounded-lg text-slate-700">v{{ rev.version_number }}</div>
                    <div class="flex-1">
                      <p class="text-sm font-semibold text-slate-800">{{ rev.change_reason or 'Uploaded revision' }}</p>
                      <p class="text-xs text-slate-500">
                        {{ rev.created_at|format_india_datetime('%d %b %Y, %I:%M %p') if rev.created_at else '' }}
                        · {{ rev.changed_by.display_name if rev.changed_by else 'Design' }}
                      </p>
                      <a href="{{ url_for('static', filename='uploads/' ~ rev.file_name) }}" class="text-orange-600 text-xs" download>Download</a>
                    </div>
                  </div>
                  {% else %}
                  <p class="text-xs text-slate-500">No revisions yet.</p>
                  {% endfor %}
                </div>
              </div>
              {% else %}
              <p class="text-sm text-slate-500">No drawings in this category.</p>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase text-slate-500">Bill of Materials</p>
            <h2 class="text-lg font-semibold">BOM Packages</h2>
          </div>
          <div class="flex items-center gap-2">
            {% if bom and can_edit_bom %}
            <button
              type="button"
              class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm hover:bg-slate-50"
              onclick="toggleBomDuplicateModal('{{ bom.id }}', true)"
            >
              Duplicate BOM
            </button>
            {% endif %}
            {% if can_edit_bom %}
            <button
              type="button"
              data-modal-target="addBomPackageModal"
              class="px-4 py-2 rounded-xl btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition"
            >
              + Add Package
            </button>
            {% endif %}
          </div>
        </div>
        {% if not bom %}
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
          No BOM yet. Create a package to start capturing items for this design task.
        </div>
        {% endif %}
        <div class="space-y-4">
          {% for package in bom_packages %}
          {% set package_template = bom_template_map.get(package.bom_template_id) %}
          {% set package_inputs = package_input_values.get(package.id, {}) %}
          <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-base font-semibold text-slate-900">{{ package.name }}</h3>
                  {% if package.status == 'final' %}
                  <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Final</span>
                  {% else %}
                  <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">Draft</span>
                  {% endif %}
                </div>
                <p class="text-xs text-slate-500">
                  Template: {{ package_template.name if package_template else 'Not selected' }}
                </p>
                {% set spec_summary = bom_package_spec_summary.get(package.id, {'total': 0, 'missing': 0}) %}
                <p class="text-xs mt-1 {% if spec_summary.missing %}text-rose-600{% else %}text-emerald-600{% endif %}">
                  Technical contract readiness: {{ spec_summary.total - spec_summary.missing }}/{{ spec_summary.total }} lines have Specification.
                </p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <a
                  href="#package-items-{{ package.id }}"
                  class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm hover:bg-white"
                >
                  Edit Items
                </a>
                <button
                  type="button"
                  class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm hover:bg-white"
                  onclick="document.getElementById('package-config-{{ package.id }}')?.setAttribute('open', 'true')"
                >
                  Configure / Generate
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-slate-400 cursor-not-allowed"
                  title="Export will be available soon."
                  disabled
                >
                  Export
                </button>
                {% if can_edit_bom %}
                  {% if package.status == 'final' %}
                  <form method="POST">
                    {{ csrf_field() }}
                    <input type="hidden" name="bom_package_id" value="{{ package.id }}" />
                    <button
                      type="submit"
                      name="action"
                      value="unlock_bom_package"
                      class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-orange-600 hover:bg-white"
                      onclick="return confirm('Unlock this package to allow edits and regeneration?')"
                    >
                      Unlock
                    </button>
                  </form>
                  {% else %}
                  <form method="POST">
                    {{ csrf_field() }}
                    <input type="hidden" name="bom_package_id" value="{{ package.id }}" />
                    <button
                      type="submit"
                      name="action"
                      value="finalize_bom_package"
                      class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm text-emerald-700 hover:bg-white"
                      onclick="return confirm('Finalize this package? Regeneration will be locked until unlocked.')"
                    >
                      Finalize
                    </button>
                  </form>
                  {% endif %}
                {% endif %}
              </div>
            </div>

            <details id="package-config-{{ package.id }}" class="mt-4 rounded-xl border border-slate-200 bg-white p-4">
              <summary class="cursor-pointer text-sm font-semibold text-slate-700">Configure & Generate</summary>
              <div class="mt-4 space-y-4">
                <form method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  {{ csrf_field() }}
                  <input type="hidden" name="bom_package_id" value="{{ package.id }}" />
                  <label class="space-y-1">
                    <span class="text-sm text-slate-600">Package name</span>
                    <input type="text" name="package_name" class="w-full rounded-lg border-slate-200" value="{{ package.name }}" />
                  </label>
                  <label class="space-y-1 md:col-span-2">
                    <span class="text-sm text-slate-600">BOM Template</span>
                    <select name="bom_template_id" class="w-full rounded-lg border-slate-200">
                      <option value="">Select template</option>
                      {% for template in bom_template_options %}
                      <option value="{{ template.id }}" {% if package.bom_template_id == template.id %}selected{% endif %}>
                        {{ template.name }} ({{ template.lift_type }})
                      </option>
                      {% endfor %}
                    </select>
                  </label>
                  <div class="md:col-span-3 flex justify-end">
                    <button
                      type="submit"
                      name="action"
                      value="update_bom_package"
                      class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50"
                      {% if package.status == 'final' %}disabled title="Unlock the package to edit."{% endif %}
                    >
                      Save settings
                    </button>
                  </div>
                </form>

                <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                  <h4 class="text-sm font-semibold text-slate-700">Template Inputs</h4>
                  {% if package_template %}
                  <form method="POST" class="mt-3 space-y-3">
                    {{ csrf_field() }}
                    <input type="hidden" name="bom_package_id" value="{{ package.id }}" />
                    <input type="hidden" name="bom_template_id" value="{{ package_template.id }}" />
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      {% for input in package_template.inputs %}
                      {% set input_value = package_inputs.get(input.input_key, input.default_value) %}
                      <label class="space-y-1">
                        <span class="text-sm text-slate-600">{{ input.label }}{% if input.unit %} ({{ input.unit }}){% endif %}</span>
                        {% if input.data_type == 'boolean' %}
                        <select name="input_{{ package.id }}_{{ input.input_key }}" class="w-full rounded-lg border-slate-200">
                          <option value="true" {% if input_value in [True, 'true', 'True', 1, '1'] %}selected{% endif %}>Yes</option>
                          <option value="false" {% if input_value in [False, 'false', 'False', 0, '0', None, ''] %}selected{% endif %}>No</option>
                        </select>
                        {% elif input.data_type in ['integer', 'number'] %}
                        <input
                          type="number"
                          step="{% if input.data_type == 'integer' %}1{% else %}0.01{% endif %}"
                          name="input_{{ package.id }}_{{ input.input_key }}"
                          class="w-full rounded-lg border-slate-200"
                          value="{{ input_value }}"
                          {% if input.required %}required{% endif %}
                        />
                        {% else %}
                        <input
                          type="text"
                          name="input_{{ package.id }}_{{ input.input_key }}"
                          class="w-full rounded-lg border-slate-200"
                          value="{{ input_value }}"
                          {% if input.required %}required{% endif %}
                        />
                        {% endif %}
                      </label>
                      {% else %}
                      <p class="text-sm text-slate-500 md:col-span-3">No inputs configured for this template.</p>
                      {% endfor %}
                    </div>
                    <div class="flex flex-wrap items-center justify-end gap-2">
                      <button
                        type="submit"
                        name="action"
                        value="validate_bom_package"
                        class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-white"
                      >
                        Run Validation
                      </button>
                      <button
                        type="submit"
                        name="action"
                        value="generate_bom_package"
                        class="px-4 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition"
                        {% if package.status == 'final' %}disabled title="Unlock the package to regenerate."{% endif %}
                      >
                        {% if package.generated_at %}Regenerate{% else %}Generate{% endif %}
                      </button>
                    </div>
                    {% if package.generated_at %}
                    <p class="text-xs text-slate-500">
                      Last generated {{ package.generated_at|format_india_datetime('%d %b %Y, %I:%M %p') }} by
                      {{ package.generated_by.display_name if package.generated_by else 'System' }}.
                    </p>
                    {% endif %}
                  </form>
                  {% else %}
                  <p class="text-sm text-slate-500 mt-2">Select a template to load inputs for generation.</p>
                  {% endif %}
                </div>
              </div>
            </details>

            <div id="package-items-{{ package.id }}" class="mt-5 space-y-3">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-sm font-semibold text-slate-700">Items in {{ package.name }}</h4>
                <input
                  type="search"
                  data-package-search="{{ package.id }}"
                  class="rounded-lg border-slate-200 text-sm px-3 py-2"
                  placeholder="Search items..."
                />
              </div>
              {% if can_edit_bom %}
              <form method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 bg-white border border-slate-200 rounded-xl p-3">
                {{ csrf_field() }}
                <input type="hidden" name="action" value="add_bom_item" />
                <input type="hidden" name="bom_package_id" value="{{ package.id }}" />
                <label class="space-y-1">
                  <span class="text-sm">Part Class</span>
                  <select name="part_class_id" class="w-full rounded-lg border-slate-200" data-part-class-select>
                    <option value="">Select</option>
                    {% for part in part_classes %}
                    <option value="{{ part.id }}">{{ part.name }}</option>
                    {% endfor %}
                  </select>
                </label>
                <label class="space-y-1">
                  <span class="text-sm">Item Name / Description</span>
                  <input type="text" name="item_code" class="w-full rounded-lg border-slate-200" required />
                </label>
                <label class="space-y-1 lg:col-span-2">
                  <span class="text-sm font-semibold text-rose-700">Specification *</span>
                  <textarea name="specification" rows="2" class="w-full rounded-lg border-rose-300 bg-rose-50/60 text-slate-900" placeholder="Designer-owned technical specification" required></textarea>
                </label>
                <label class="space-y-1">
                  <span class="text-sm">Unit</span>
                  <input type="text" name="unit" class="w-full rounded-lg border-slate-200" placeholder="nos / set" />
                </label>
                <label class="space-y-1">
                  <span class="text-sm">Qty</span>
                  <input type="number" step="0.01" name="quantity_required" class="w-full rounded-lg border-slate-200" value="1" />
                </label>
                <label class="space-y-1">
                  <span class="text-sm font-semibold text-sky-700">Stage</span>
                  <input type="text" name="stage" class="w-full rounded-lg border-sky-300 bg-sky-50/60 text-slate-900" placeholder="Stage 1 / Electrical" />
                </label>
                <label class="space-y-1 lg:col-span-2">
                  <span class="text-sm font-semibold text-violet-700">Section</span>
                  <input type="text" name="section_title" class="w-full rounded-lg border-violet-300 bg-violet-50/60 text-slate-900" placeholder="Car Bracket Kit" />
                </label>
                <label class="space-y-1 lg:col-span-2">
                  <span class="text-sm font-semibold text-emerald-700">Suggested Part</span>
                  <select name="suggested_part_id" class="w-full rounded-lg border-emerald-300 bg-emerald-50/60 text-slate-900" data-suggested-part-select>
                    <option value="">— None —</option>
                    {% for part in parts %}
                    <option value="{{ part.id }}">{{ part.name }}{% if part.uom or part.purchase_uom %} ({{ part.uom or part.purchase_uom }}){% endif %}</option>
                    {% endfor %}
                  </select>
                  <p class="text-[11px] text-emerald-800">Suggested from Part Class. Specification on BOM line is authoritative.</p>
                </label>
                <label class="space-y-1 lg:col-span-2">
                  <span class="text-sm">Remarks</span>
                  <input type="text" name="remarks" class="w-full rounded-lg border-slate-200" />
                </label>
                <div class="lg:col-span-4 flex justify-end">
                  <button type="submit" class="px-4 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Add item</button>
                </div>
              </form>
              {% endif %}
              <div class="overflow-x-auto">
                <table class="w-full text-sm" data-package-table="{{ package.id }}">
                  <thead>
                    <tr class="text-left text-slate-500">
                      <th class="py-2">Part Class</th>
                      <th class="py-2">Item Name / Description</th>
                      <th class="py-2 text-sky-700">Stage</th>
                      <th class="py-2 text-violet-700">Section</th>
                      <th class="py-2 text-rose-700">Specification *</th>
                      <th class="py-2">Unit</th>
                      <th class="py-2">Qty</th>
                      <th class="py-2 text-emerald-700">Suggested Part</th>
                      <th class="py-2">Remarks</th>
                      <th class="py-2">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    {% for item in bom_items_by_package.get(package.id, []) %}
                    {% set row_label = (item.item_code or '') ~ ' ' ~ (item.specification or item.description or '') %}
                    {% set form_id = 'bom-item-' ~ item.id %}
                    {% set pending_req = pending_spec_requests_by_line.get(item.id) %}
                    {% set latest_req = latest_spec_requests_by_line.get(item.id) %}
                    {% if can_edit_bom %}
                    <form id="{{ form_id }}" method="POST" class="hidden">
                      {{ csrf_field() }}
                      <input type="hidden" name="item_id" value="{{ item.id }}" />
                    </form>
                    {% endif %}
                    <tr data-search-text="{{ row_label|lower }}">
                      <td class="py-2">
                        {% if can_edit_bom %}
                          <select form="{{ form_id }}" name="part_class_id" class="rounded-lg border-slate-200 text-xs" data-part-class-select>
                            <option value="">—</option>
                            {% for part in part_classes %}
                            <option value="{{ part.id }}" {% if item.part_class_id == part.id %}selected{% endif %}>{{ part.name }}</option>
                            {% endfor %}
                          </select>
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="text" name="item_code" value="{{ item.item_code }}" class="w-40 rounded-lg border-slate-200 text-xs" />
                          {% if item.is_generated %}
                          <span class="ml-1 text-[10px] px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">Generated</span>
                          {% endif %}
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="text" name="stage" value="{{ item.stage or '' }}" class="w-28 rounded-lg border-sky-300 bg-sky-50/60 text-xs text-slate-900" />
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="text" name="section_title" value="{{ item.section_title or item.category or '' }}" class="w-36 rounded-lg border-violet-300 bg-violet-50/60 text-xs text-slate-900" />
                      </td>
                      <td class="py-2 space-y-1">
                          <textarea form="{{ form_id }}" name="specification" rows="2" class="w-52 rounded-lg border-rose-300 bg-rose-50/60 text-xs text-slate-900" required>{{ item.specification or item.description or '' }}</textarea>
                          {% if pending_req %}
                          <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] bg-amber-100 text-amber-800">Spec Change Requested</span>
                          <div class="text-[10px] text-amber-900 bg-amber-50 border border-amber-200 rounded p-1 max-w-56">
                            <p><span class="font-semibold">Reason:</span> {{ pending_req.reason }}</p>
                            {% if pending_req.suggested_alternative %}
                            <p><span class="font-semibold">Suggestion:</span> {{ pending_req.suggested_alternative }}</p>
                            {% endif %}
                          </div>
                          {% elif latest_req %}
                          <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] {% if latest_req.status == 'Approved' %}bg-emerald-100 text-emerald-800{% else %}bg-rose-100 text-rose-700{% endif %}">Latest Request: {{ latest_req.status }}</span>
                          {% endif %}
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="text" name="unit" value="{{ item.unit }}" class="w-20 rounded-lg border-slate-200 text-xs" />
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="number" step="0.01" name="quantity_required" value="{{ item.quantity_required }}" class="w-20 rounded-lg border-slate-200 text-xs" />
                      </td>
                      <td class="py-2">
                          <select form="{{ form_id }}" name="suggested_part_id" class="w-48 rounded-lg border-emerald-300 bg-emerald-50/60 text-xs text-slate-900" data-suggested-part-select>
                            <option value="">— None —</option>
                            {% for part in parts %}
                            <option value="{{ part.id }}" {% if item.suggested_part_id == part.id %}selected{% endif %}>{{ part.name }}{% if part.uom or part.purchase_uom %} ({{ part.uom or part.purchase_uom }}){% endif %}</option>
                            {% endfor %}
                          </select>
                          <p class="mt-1 text-[10px] text-emerald-800">Suggested from Part Class. Specification on BOM line is authoritative.</p>
                      </td>
                      <td class="py-2">
                          <input form="{{ form_id }}" type="text" name="remarks" value="{{ item.remarks }}" class="w-32 rounded-lg border-slate-200 text-xs" />
                      </td>
                      <td class="py-2">
                          <div class="flex flex-col items-start gap-2">
                            <div class="flex items-center gap-2">
                              <button form="{{ form_id }}" type="submit" name="action" value="update_bom_item" class="px-2 py-1 rounded border text-xs">Save</button>
                              {% if pending_req and is_design_user %}
                              <button form="{{ form_id }}" type="submit" name="action" value="approve_spec_change" class="px-2 py-1 rounded border border-emerald-300 text-emerald-700 text-xs">Approve + Save</button>
                              {% endif %}
                              <button
                                form="{{ form_id }}"
                                type="submit"
                                name="action"
                                value="delete_bom_item"
                                class="px-2 py-1 rounded border border-rose-200 text-xs text-rose-600"
                                onclick="return confirm('Delete this item?')"
                              >
                                Delete
                              </button>
                            </div>
                            {% if pending_req and is_design_user %}
                            <div class="flex items-center gap-2">
                              <input form="{{ form_id }}" type="text" name="resolution_notes" class="w-44 rounded border border-slate-200 text-[10px] px-2 py-1" placeholder="Rejection note (optional)" />
                              <button form="{{ form_id }}" type="submit" name="action" value="reject_spec_change" class="px-2 py-1 rounded border border-rose-300 text-rose-700 text-xs">Reject</button>
                            </div>
                            {% endif %}
                          </div>
                      </td>
                        {% else %}
                        {{ item.part_class.name if item.part_class else '—' }}
                      </td>
                      <td class="py-2">{{ item.item_code }}</td>
                      <td class="py-2">{{ item.stage or '—' }}</td>
                      <td class="py-2">{{ item.section_title or item.category or '—' }}</td>
                      <td class="py-2">{{ item.specification or item.description or '—' }}</td>
                      <td class="py-2">{{ item.unit }}</td>
                      <td class="py-2">{{ item.quantity_required }}</td>
                      <td class="py-2">{% if item.suggested_part_id %}{% set sp = parts|selectattr("id", "equalto", item.suggested_part_id)|first %}{{ sp.name if sp else "—" }}{% else %}—{% endif %}</td>
                      <td class="py-2">{{ item.remarks }}</td>
                      <td class="py-2">—</td>
                      {% endif %}
                    </tr>
                    {% else %}
                    <tr><td colspan="10" class="py-3 text-slate-500">No items in this package yet.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% else %}
          <p class="text-sm text-slate-500">No BOM packages added yet.</p>
          {% endfor %}
        </div>

        {% if all_bom_items %}
        <div class="mt-6 border-t border-slate-200 pt-4 space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div>
              <p class="text-xs uppercase text-slate-500">Cross-check</p>
              <h3 class="text-sm font-semibold text-slate-700">All items across packages</h3>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <select id="allItemsPackageFilter" class="rounded-lg border-slate-200 text-sm">
                <option value="">All Packages</option>
                {% for package in bom_packages %}
                <option value="{{ package.id }}">{{ package.name }}</option>
                {% endfor %}
              </select>
              <select id="allItemsPartClassFilter" class="rounded-lg border-slate-200 text-sm">
                <option value="">All Part Classes</option>
                {% for part in part_classes %}
                <option value="{{ part.id }}">{{ part.name }}</option>
                {% endfor %}
              </select>
              <input id="allItemsSearch" type="search" class="rounded-lg border-slate-200 text-sm px-3 py-2" placeholder="Search items..." />
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="allItemsTable">
              <thead>
                <tr class="text-left text-slate-500">
                  <th class="py-2">Package</th>
                  <th class="py-2">Part Class</th>
                  <th class="py-2">Item</th>
                  <th class="py-2 text-sky-700">Stage</th>
                  <th class="py-2 text-violet-700">Section</th>
                  <th class="py-2 text-rose-700">Specification</th>
                  <th class="py-2">Qty</th>
                  <th class="py-2">Unit</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                {% for entry in all_bom_items %}
                {% set item = entry.item %}
                {% set package = entry.package %}
                {% set search_text = (item.item_code or '') ~ ' ' ~ (item.specification or item.description or '') ~ ' ' ~ (item.section_title or item.category or '') %}
                <tr
                  data-package-id="{{ package.id }}"
                  data-part-class-id="{{ item.part_class_id or '' }}"
                  data-search-text="{{ search_text|lower }}"
                >
                  <td class="py-2 font-semibold">{{ package.name }}</td>
                  <td class="py-2">{{ item.part_class.name if item.part_class else '—' }}</td>
                  <td class="py-2">{{ item.item_code }}</td>
                  <td class="py-2">{{ item.stage or '—' }}</td>
                  <td class="py-2">{{ item.section_title or item.category or '—' }}</td>
                  <td class="py-2">{{ item.specification or item.description or '—' }}</td>
                  <td class="py-2">{{ item.quantity_required }}</td>
                  <td class="py-2">{{ item.unit }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% if bom and can_edit_bom %}
        <div
          id="duplicateBomModal{{ bom.id }}"
          class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/60 backdrop-blur"
        >
          <div
            class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden"
            onclick="event.stopPropagation()"
          >
            <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
              <div>
                <p class="text-xs text-slate-500 uppercase">Duplicate BOM</p>
                <h2 class="text-lg font-semibold">Send BOM to another project/site</h2>
              </div>
              <button class="text-slate-500" type="button" onclick="toggleBomDuplicateModal('{{ bom.id }}', false)">✕</button>
            </div>
            <form method="POST" action="{{ url_for('duplicate_bom', bom_id=bom.id) }}" class="p-5 space-y-4">
              {{ csrf_field() }}
              <input type="hidden" name="redirect_url" value="{{ request.path }}" />
              <label class="space-y-1 block">
                <span class="text-sm text-slate-600">Target Project / Site</span>
                <select name="target_reference" required class="w-full rounded-lg border-slate-200">
                  <option value="">Select where to duplicate</option>
                  {% if drawing_site_options %}
                  <optgroup label="Drawing Sites">
                    {% for option in drawing_site_options %}
                    <option value="drawing_site:{{ option.id }}">
                      {{ option.project_no or option.client_name or 'Drawing Site' }}{% if option.site_location %} · {{ option.site_location }}{% endif %}
                    </option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                  {% if project_options %}
                  <optgroup label="Projects">
                    {% for project in project_options %}
                    <option value="project:{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                </select>
              </label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="space-y-1 block">
                  <span class="text-sm text-slate-600">Target Lift Identifier (optional)</span>
                  <input
                    type="text"
                    name="target_lift_identifier"
                    class="w-full rounded-lg border-slate-200"
                    placeholder="Lift-2"
                  />
                </label>
                <label class="space-y-1 block">
                  <span class="text-sm text-slate-600">New BOM name or code (optional)</span>
                  <input
                    type="text"
                    name="new_bom_name"
                    class="w-full rounded-lg border-slate-200"
                    placeholder="{{ bom.bom_name }} (Copy)"
                  />
                </label>
              </div>
              <div class="flex items-center justify-end gap-3 pt-2">
                <button type="button" class="px-4 py-2 rounded-lg border" onclick="toggleBomDuplicateModal('{{ bom.id }}', false)">Cancel</button>
                <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Duplicate BOM</button>
              </div>
            </form>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="space-y-4">
      {% if related_drawing_sites %}
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">Drawing Site Records</h3>
        <p class="text-sm text-slate-600 mb-2">Jump to the site repository for BOM and drawing versions.</p>
        <div class="space-y-2">
          {% for site in related_drawing_sites %}
          <a href="{{ url_for('design_drawing_site_detail', site_id=site.id) }}" class="block px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50">
            <p class="font-semibold">{{ site.project_no or site.client_name or 'Drawing Site' }}</p>
            <p class="text-xs text-slate-500">{{ site.client_name or 'Client' }} · {{ site.site_location or 'Location' }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">Comments</h3>
        <form method="POST" class="space-y-2">
          {{ csrf_field() }}
          <input type="hidden" name="action" value="comment" />
          <textarea name="body" rows="3" class="w-full rounded-lg border-slate-200" placeholder="Sales ↔ Design notes"></textarea>
          <button type="submit" class="w-full px-4 py-2 rounded-lg btn-primary btn-shimmer hover:shadow-lg hover:scale-[1.01] transition">Add comment</button>
        </form>
        <div class="mt-3 space-y-2">
          {% for comment in task.comments|sort(attribute='created_at', reverse=True) %}
          <div class="p-2 bg-slate-50 rounded-lg text-sm">
            <p class="font-semibold">{{ comment.author.display_name if comment.author else 'Design' }} <span class="text-xs text-slate-500">{{ comment.created_at|format_india_datetime('%d %b %Y %I:%M %p') if comment.created_at else '' }}</span></p>
            <p class="text-slate-600">{{ comment.body }}</p>
          </div>
          {% else %}
          <p class="text-sm text-slate-500">No comments yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div id="editDesignTaskModal" data-modal class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur" data-modal-overlay></div>
  <div class="relative bg-white w-full max-w-3xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
      <div>
        <p class="text-xs text-slate-500 uppercase">Edit task</p>
        <h2 class="text-lg font-semibold">Update design task</h2>
      </div>
      <button class="text-slate-500" type="button" data-close-modal>✕</button>
    </div>
    <form method="POST" class="p-5 space-y-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="update_task" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Task title</span>
          <input type="text" name="title" class="w-full rounded-lg border-slate-200" value="{{ task.description or task.project_label }}" required />
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Priority</span>
          <select name="priority" class="w-full rounded-lg border-slate-200">
            <option value="low" {% if task.priority == 'low' %}selected{% endif %}>Low</option>
            <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>Medium</option>
            <option value="high" {% if task.priority == 'high' %}selected{% endif %}>High</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Due date</span>
          <input type="date" name="due_date" class="w-full rounded-lg border-slate-200" value="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}" />
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Designer</span>
          <select name="assigned_to_user_id" class="w-full rounded-lg border-slate-200">
            <option value="">Unassigned</option>
            {% for user in users %}
            <option value="{{ user.id }}" {% if task.assigned_to_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Status</span>
          <select name="task_status" class="w-full rounded-lg border-slate-200">
            {% for status in task_status_options %}
            <option value="{{ status }}" {% if task.status == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </label>
        {% if can_link_project %}
        <label class="space-y-1 md:col-span-2">
          <span class="text-sm text-slate-600">Project link</span>
          <select name="project_id" class="w-full rounded-lg border-slate-200">
            <option value="">Unlinked</option>
            {% for project in project_options %}
            <option value="{{ project.id }}" {% if task.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
            {% endfor %}
          </select>
        </label>
        {% endif %}
      </div>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-lg border" data-close-modal>Cancel</button>
        <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Save changes</button>
      </div>
    </form>
  </div>
</div>

<div id="newDrawingModal" data-modal class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur" data-modal-overlay></div>
  <div class="relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
      <div>
        <p class="text-xs text-slate-500 uppercase">New drawing</p>
        <h2 class="text-lg font-semibold">Upload a new drawing</h2>
      </div>
      <button class="text-slate-500" type="button" data-close-modal>✕</button>
    </div>
    <form method="POST" enctype="multipart/form-data" class="p-5 space-y-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="upload_new_drawing" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="space-y-1 md:col-span-2">
          <span class="text-sm text-slate-600">Drawing name</span>
          <input type="text" name="drawing_name" class="w-full rounded-lg border-slate-200" placeholder="Lift GA Drawing" required />
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">Drawing type</span>
          <select name="drawing_type" class="w-full rounded-lg border-slate-200">
            {% for option in drawing_type_options %}
            <option value="{{ option.value }}">{{ option.label }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-slate-600">File</span>
          <input type="file" name="drawing_file" class="w-full text-sm" required />
        </label>
        <label class="space-y-1 md:col-span-2">
          <span class="text-sm text-slate-600">Notes / reason</span>
          <input type="text" name="change_reason" class="w-full rounded-lg border-slate-200" placeholder="Initial issue for review" />
        </label>
      </div>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-lg border" data-close-modal>Cancel</button>
        <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Upload</button>
      </div>
    </form>
  </div>
</div>

<div id="revisionUploadModal" data-modal class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur" data-modal-overlay></div>
  <div class="relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
      <div>
        <p class="text-xs text-slate-500 uppercase">Upload revision</p>
        <h2 class="text-lg font-semibold">Add revision for <span data-revision-name>Drawing</span></h2>
      </div>
      <button class="text-slate-500" type="button" data-close-modal>✕</button>
    </div>
    <form method="POST" enctype="multipart/form-data" class="p-5 space-y-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="upload_revision" />
      <input type="hidden" name="drawing_id" value="" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="space-y-1 md:col-span-2">
          <span class="text-sm text-slate-600">Revision file</span>
          <input type="file" name="revision_file" class="w-full text-sm" required />
        </label>
        <label class="space-y-1 md:col-span-2">
          <span class="text-sm text-slate-600">Notes / reason</span>
          <input type="text" name="change_reason" class="w-full rounded-lg border-slate-200" placeholder="Updated shaft details" />
        </label>
      </div>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-lg border" data-close-modal>Cancel</button>
        <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Upload revision</button>
      </div>
    </form>
  </div>
</div>

<div id="clarificationModal" class="fixed inset-0 z-40 hidden items-center justify-center">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur" onclick="toggleClarification(false)"></div>
  <div class="relative bg-white w-full max-w-xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
      <div>
        <p class="text-xs text-slate-500 uppercase">Sales Clarification</p>
        <h2 class="text-lg font-semibold">Request clarification</h2>
      </div>
      <button class="text-slate-500" type="button" onclick="toggleClarification(false)">✕</button>
    </div>
    <form method="POST" class="p-5 space-y-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="clarification" />
      <label class="space-y-1 block">
        <span class="text-sm text-slate-600">Clarification details</span>
        <textarea name="clarification_body" rows="4" class="w-full rounded-lg border-slate-200" placeholder="Provide specific questions or missing information" required></textarea>
      </label>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-lg border" onclick="toggleClarification(false)">Cancel</button>
        <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Send request</button>
      </div>
    </form>
  </div>
</div>

<div id="addBomPackageModal" data-modal class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur" data-modal-overlay></div>
  <div class="relative bg-white w-full max-w-xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
      <div>
        <p class="text-xs text-slate-500 uppercase">BOM Package</p>
        <h2 class="text-lg font-semibold">Create BOM package</h2>
      </div>
      <button class="text-slate-500" type="button" data-close-modal>✕</button>
    </div>
    <form method="POST" class="p-5 space-y-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="create_bom_package" />
      <label class="space-y-1 block">
        <span class="text-sm text-slate-600">Package Name</span>
        <input type="text" name="package_name" class="w-full rounded-lg border-slate-200" placeholder="Main Lift BOM" required />
      </label>
      <label class="space-y-1 block">
        <span class="text-sm text-slate-600">BOM Template (optional)</span>
        <select name="bom_template_id" class="w-full rounded-lg border-slate-200">
          <option value="">Select template</option>
          {% for template in bom_template_options %}
          <option value="{{ template.id }}">{{ template.name }} ({{ template.lift_type }})</option>
          {% endfor %}
        </select>
      </label>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-lg border" data-close-modal>Cancel</button>
        <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Create Package</button>
      </div>
    </form>
  </div>
</div>

<script>
  const partClassPrimaryParts = {{ part_class_primary_parts|tojson }};
  const modals = document.querySelectorAll('[data-modal]');
  const toggleModal = (modal, state) => {
    if (!modal) return;
    const shouldShow = state !== false;
    modal.classList.toggle('hidden', !shouldShow);
    modal.classList.toggle('flex', shouldShow);
  };

  modals.forEach(modal => {
    modal.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => toggleModal(modal, false));
    });
    modal.querySelectorAll('[data-modal-overlay]').forEach(overlay => {
      overlay.addEventListener('click', () => toggleModal(modal, false));
    });
  });

  document.querySelectorAll('[data-modal-target]').forEach(trigger => {
    trigger.addEventListener('click', event => {
      event.preventDefault();
      const target = document.getElementById(trigger.dataset.modalTarget);
      toggleModal(target, true);
    });
  });

  const revisionModal = document.getElementById('revisionUploadModal');
  const revisionName = revisionModal?.querySelector('[data-revision-name]');
  const revisionInput = revisionModal?.querySelector('input[name="drawing_id"]');
  document.querySelectorAll('[data-revision-modal]').forEach(trigger => {
    trigger.addEventListener('click', event => {
      event.preventDefault();
      if (!revisionModal) return;
      if (revisionInput) {
        revisionInput.value = trigger.dataset.drawingId || '';
      }
      if (revisionName) {
        revisionName.textContent = trigger.dataset.drawingName || 'Drawing';
      }
      toggleModal(revisionModal, true);
    });
  });

  const clarificationModal = document.getElementById('clarificationModal');
  function toggleClarification(state){
    if(!clarificationModal) return;
    clarificationModal.classList.toggle('hidden', state === false);
    clarificationModal.classList.toggle('flex', state !== false);
  }
  const openClarificationBtn = document.getElementById('openClarificationModal');
  if (openClarificationBtn){
    openClarificationBtn.addEventListener('click', ()=>toggleClarification(true));
  }

  function toggleBomDuplicateModal(id, state){
    const modal = document.getElementById(`duplicateBomModal${id}`);
    if(!modal) return;
    const shouldShow = state !== false;
    modal.classList.toggle('hidden', !shouldShow);
    modal.classList.toggle('flex', shouldShow);
  }

  document.querySelectorAll('[data-package-search]').forEach(input => {
    input.addEventListener('input', event => {
      const searchValue = event.target.value.toLowerCase();
      const packageId = event.target.dataset.packageSearch;
      const table = document.querySelector(`[data-package-table="${packageId}"]`);
      if (!table) return;
      table.querySelectorAll('tbody tr[data-search-text]').forEach(row => {
        const haystack = row.dataset.searchText || '';
        row.classList.toggle('hidden', searchValue && !haystack.includes(searchValue));
      });
    });
  });


  const syncSuggestedPartFromClass = (partClassSelect) => {
    const container = partClassSelect.closest('form') || partClassSelect.closest('tr') || document;
    const suggestedSelect = container.querySelector('[data-suggested-part-select]');
    if (!suggestedSelect) return;
    const selectedClassId = partClassSelect.value || '';
    const suggestedPartId = partClassPrimaryParts[selectedClassId] || null;
    if (suggestedPartId && !suggestedSelect.value) {
      suggestedSelect.value = String(suggestedPartId);
    }
  };

  document.querySelectorAll('[data-part-class-select]').forEach(select => {
    select.addEventListener('change', () => syncSuggestedPartFromClass(select));
    syncSuggestedPartFromClass(select);
  });

  const allItemsTable = document.getElementById('allItemsTable');
  const allItemsPackageFilter = document.getElementById('allItemsPackageFilter');
  const allItemsPartClassFilter = document.getElementById('allItemsPartClassFilter');
  const allItemsSearch = document.getElementById('allItemsSearch');

  function filterAllItems(){
    if (!allItemsTable) return;
    const packageValue = allItemsPackageFilter ? allItemsPackageFilter.value : '';
    const partClassValue = allItemsPartClassFilter ? allItemsPartClassFilter.value : '';
    const searchValue = allItemsSearch ? allItemsSearch.value.toLowerCase() : '';
    allItemsTable.querySelectorAll('tbody tr').forEach(row => {
      const matchesPackage = !packageValue || row.dataset.packageId === packageValue;
      const matchesPartClass = !partClassValue || row.dataset.partClassId === partClassValue;
      const searchText = row.dataset.searchText || '';
      const matchesSearch = !searchValue || searchText.includes(searchValue);
      row.classList.toggle('hidden', !(matchesPackage && matchesPartClass && matchesSearch));
    });
  }

  [allItemsPackageFilter, allItemsPartClassFilter, allItemsSearch].forEach(control => {
    if (!control) return;
    control.addEventListener('input', filterAllItems);
    control.addEventListener('change', filterAllItems);
  });

  const detailStatusSelect = document.querySelector('[data-task-status-select]');
  const detailStatusPill = document.querySelector('[data-status-pill]');
  const detailStatusSummary = document.querySelector('[data-status-summary]');
  const statusStyles = {
    'Pending Inputs': 'bg-slate-500 text-white',
    Drawing: 'bg-blue-500 text-white',
    'In Drawing': 'bg-indigo-500 text-white',
    'Sent for Approval': 'bg-amber-500 text-slate-900',
    Approved: 'bg-emerald-500 text-white',
    'Revision Needed': 'bg-rose-500 text-white',
    Finalized: 'bg-teal-600 text-white',
    'In Preparation': 'bg-blue-500 text-white',
    Revised: 'bg-rose-500 text-white'
  };

  function formatStatusLabel(status){
    return status || '';
  }

  function updateDetailStatus(status){
    const label = formatStatusLabel(status);
    const styleClass = statusStyles[status] || 'bg-slate-500 text-white';
    if (detailStatusPill){
      detailStatusPill.textContent = label;
      detailStatusPill.className = `px-2 py-0.5 rounded-full text-xs font-semibold ${styleClass}`;
    }
    if (detailStatusSummary){
      detailStatusSummary.textContent = label;
      detailStatusSummary.className = `px-3 py-1 rounded-full text-sm font-semibold ${styleClass}`;
    }
  }

  function showDetailStatusError(message){
    window.alert(message || 'Unable to update task status. Please try again.');
  }

  async function postDetailTaskStatus(taskId, status){
    const response = await fetch(`/design/tasks/${taskId}/update_status`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
      body: JSON.stringify({status})
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.ok){
      throw new Error(data.message || 'Unable to update task status.');
    }
    return data;
  }

  if (detailStatusSelect){
    detailStatusSelect.addEventListener('change', async () => {
      const taskId = detailStatusSelect.dataset.taskId;
      const nextStatus = detailStatusSelect.value;
      const previousStatus = detailStatusSelect.dataset.currentStatus || nextStatus;
      if (!taskId || previousStatus === nextStatus) return;

      detailStatusSelect.dataset.currentStatus = nextStatus;
      updateDetailStatus(nextStatus);
      detailStatusSelect.disabled = true;
      try {
        const data = await postDetailTaskStatus(taskId, nextStatus);
        detailStatusSelect.value = data.status;
        detailStatusSelect.dataset.currentStatus = data.status;
        updateDetailStatus(data.status);
      } catch (error) {
        detailStatusSelect.dataset.currentStatus = previousStatus;
        detailStatusSelect.value = previousStatus;
        updateDetailStatus(previousStatus);
        showDetailStatusError(error.message);
      } finally {
        detailStatusSelect.disabled = false;
      }
    });
  }
</script>
{% endblock %}
