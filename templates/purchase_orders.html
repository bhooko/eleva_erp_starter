{% extends "base.html" %}
{% block title %}Purchase Orders · Eleva ERP{% endblock %}
{% block content %}
<style>
  .po-part-dropdown {
    position: fixed;
    z-index: 10000;
    max-height: 18rem;
    overflow-y: auto;
    border-radius: 0.75rem;
    border: 1px solid #E5E7EB;
    background: #FFFFFF;
    color: #111827;
    box-shadow: 0 18px 48px rgba(15, 23, 42, 0.2);
    font-size: 0.875rem;
    line-height: 1.4;
  }

  .po-part-dropdown__item {
    display: flex;
    width: 100%;
    flex-direction: column;
    gap: 2px;
    padding: 10px 12px;
    text-align: left;
    background: transparent;
    color: inherit;
    cursor: pointer;
    border: none;
  }

  .po-part-dropdown__item:hover,
  .po-part-dropdown__item:focus,
  .po-part-dropdown__item.is-active {
    background: #F1F5F9;
    color: #0F172A;
    outline: none;
  }

  .po-part-dropdown__name {
    font-weight: 600;
    color: inherit;
  }

  .po-part-dropdown__meta {
    font-size: 0.75rem;
    color: #64748B;
  }

  .po-part-dropdown__empty {
    padding: 10px 12px;
    color: #64748B;
  }

  html[data-theme="eleva-signature"] .po-part-dropdown,
  html[data-theme="metallic-elevate"] .po-part-dropdown {
    background: #111827;
    color: #E5E7EB;
    border-color: #273244;
    box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
  }

  html[data-theme="eleva-signature"] .po-part-dropdown__item:hover,
  html[data-theme="eleva-signature"] .po-part-dropdown__item:focus,
  html[data-theme="eleva-signature"] .po-part-dropdown__item.is-active,
  html[data-theme="metallic-elevate"] .po-part-dropdown__item:hover,
  html[data-theme="metallic-elevate"] .po-part-dropdown__item:focus,
  html[data-theme="metallic-elevate"] .po-part-dropdown__item.is-active {
    background: #1F2937;
    color: #FFFFFF;
  }

  html[data-theme="eleva-signature"] .po-part-dropdown__meta,
  html[data-theme="metallic-elevate"] .po-part-dropdown__meta,
  html[data-theme="eleva-signature"] .po-part-dropdown__empty,
  html[data-theme="metallic-elevate"] .po-part-dropdown__empty {
    color: #9CA3AF;
  }
</style>
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Purchase</p>
      <h1 class="text-2xl font-semibold">Purchase Orders</h1>
      <p class="text-sm text-slate-600">Browse existing POs and add new ones from the modal.</p>
      <p class="text-xs text-slate-500 mt-1">This is an Eleva ERP Purchase Order workspace. All new purchasing must be done here. Odoo POs are only for historical reference.</p>
    </div>
    <div class="flex items-center gap-3">
      <label for="new-po" class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">+ New PO</label>
      <a href="{{ url_for('purchase_odoo_history') }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50">Historical POs (Odoo)</a>
    </div>
  </div>

  <input type="checkbox" id="new-po" class="hidden peer" />
  <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('new-po').checked=false;"></div>
  <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
    <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95 flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
        <div>
          <p class="text-xs text-slate-500 uppercase">Purchase</p>
          <h2 class="text-lg font-semibold">Create purchase order</h2>
          <p class="text-xs text-slate-500">This is an Eleva ERP Purchase Order. All new purchasing must be done here. Odoo POs are only for historical reference.</p>
        </div>
        <button class="text-slate-500" onclick="document.getElementById('new-po').checked=false;">✕</button>
      </div>
      <form method="POST" class="flex flex-col flex-1 min-h-0" id="purchase-order-form">
        {{ csrf_field() }}
        <div class="flex-1 min-h-0 overflow-y-auto p-5 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="space-y-1">
              <span class="text-sm">PO Number</span>
              <input type="text" name="po_number" class="w-full rounded-lg border-slate-200 h-10 px-3" placeholder="auto" />
            </label>
            <label class="space-y-1">
              <span class="text-sm">Project</span>
              <select name="project_id" class="w-full rounded-lg border-slate-200 h-10 px-3">
                <option value="">—</option>
                {% for project in projects %}<option value="{{ project.id }}">{{ project.name }}</option>{% endfor %}
              </select>
            </label>
            <label class="space-y-1">
              <span class="text-sm">Vendor</span>
              <select name="vendor_id" class="w-full rounded-lg border-slate-200 h-10 px-3">
                <option value="">—</option>
                {% for vendor in vendors %}<option value="{{ vendor.id }}">{{ vendor.name }}</option>{% endfor %}
              </select>
            </label>
            <label class="space-y-1">
              <span class="text-sm">PO Date</span>
              <input type="date" name="po_date" class="w-full rounded-lg border-slate-200 h-10 px-3" />
            </label>
            <label class="space-y-1">
              <span class="text-sm">Expected delivery</span>
              <input type="date" name="expected_delivery" class="w-full rounded-lg border-slate-200 h-10 px-3" />
            </label>
            <label class="space-y-1 md:col-span-3">
              <span class="text-sm">Linked BOM</span>
              <select name="bom_id" class="w-full rounded-lg border-slate-200 h-10 px-3">
                <option value="">—</option>
                {% for bom in bom_options %}
                <option value="{{ bom.id }}">{{ bom.bom_name }} (ID {{ bom.id }})</option>
                {% endfor %}
              </select>
            </label>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs uppercase text-slate-500">Items</p>
                <h3 class="text-base font-semibold">Line items</h3>
              </div>
              <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs hover:shadow-lg hover:scale-[1.02] transition" data-add-item>+ Add Item</button>
            </div>
            <div class="overflow-auto bg-slate-50 border border-slate-200 rounded-xl" data-items-wrapper>
              <table class="min-w-full text-sm">
                <thead class="text-left text-slate-500 sticky top-0 bg-slate-50 z-10">
                  <tr>
                    <th class="py-2 px-3 min-w-[260px]">Part name</th>
                    <th class="py-2 px-3 min-w-[220px]">Description</th>
                    <th class="py-2 px-3 min-w-[90px]">Qty</th>
                    <th class="py-2 px-3 min-w-[110px]">Unit</th>
                    <th class="py-2 px-3 min-w-[120px]">Unit price</th>
                    <th class="py-2 px-3 min-w-[120px] text-right">Line total</th>
                    <th class="py-2 px-3 min-w-[90px]"></th>
                  </tr>
                </thead>
                <tbody class="divide-y" data-items-body>
                  <tr class="po-item-row transition-colors duration-150 hover:bg-slate-100/70">
                    <td class="py-2 px-3 min-w-[260px]">
                      <div class="relative">
                        <input type="text" name="part_name[]" class="w-full rounded-lg border-slate-200 h-10 px-3" data-part-name autocomplete="off" />
                        <input type="hidden" name="part_id[]" data-part-id />
                        <input type="hidden" name="item_code[]" data-item-code />
                      </div>
                    </td>
                    <td class="py-2 px-3 min-w-[220px]">
                      <input type="text" name="description[]" class="w-full rounded-lg border-slate-200 h-10 px-3" />
                    </td>
                    <td class="py-2 px-3 min-w-[90px]">
                      <input type="number" step="0.01" min="0" name="quantity_ordered[]" class="w-full rounded-lg border-slate-200 h-10 px-3" value="1" />
                    </td>
                    <td class="py-2 px-3 min-w-[110px]">
                      <input type="text" name="unit[]" class="w-full rounded-lg border-slate-200 h-10 px-3" placeholder="nos" />
                    </td>
                    <td class="py-2 px-3 min-w-[120px]">
                      <input type="number" step="0.01" min="0" name="unit_price[]" class="w-full rounded-lg border-slate-200 h-10 px-3" />
                    </td>
                    <td class="py-2 px-3 min-w-[120px] text-right">
                      <span class="line-total font-semibold text-slate-700">0.00</span>
                    </td>
                    <td class="py-2 px-3 min-w-[90px] text-right">
                      <button type="button" class="inline-flex h-8 w-8 items-center justify-center rounded-md text-rose-600 transition duration-150 hover:bg-rose-50 hover:text-rose-700 hover:scale-105 disabled:cursor-not-allowed disabled:opacity-40 disabled:hover:scale-100 disabled:hover:bg-transparent" data-remove-item aria-label="Remove line item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M8 6V4h8v2m-1 0v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6m3 4v8m4-8v8" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <label class="space-y-1 block">
            <span class="text-sm">Notes</span>
            <textarea name="notes" rows="2" class="w-full rounded-lg border-slate-200 px-3 py-2"></textarea>
          </label>
        </div>
        <div class="px-5 py-4 border-t border-slate-200 bg-gradient-to-t from-white via-white to-slate-50">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 text-sm">
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="px-4 py-2 rounded-lg bg-slate-900 text-white shadow">
                Subtotal: <span data-subtotal>0.00</span>
              </div>
              <div class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700">
                Grand total: <span data-grand-total>0.00</span>
              </div>
            </div>
            <button type="submit" class="px-5 py-2 bg-slate-900 text-white rounded-lg hover:shadow-lg hover:scale-[1.02] transition">Save PO</button>
          </div>
          <input type="hidden" name="subtotal_amount" value="0" />
          <input type="hidden" name="grand_total_amount" value="0" />
        </div>
      </form>
    </div>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-3 px-4">PO Number</th>
          <th class="py-3 px-4">Source</th>
          <th class="py-3 px-4">Vendor</th>
          <th class="py-3 px-4">Project</th>
          <th class="py-3 px-4">BOM</th>
          <th class="py-3 px-4">Status</th>
          <th class="py-3 px-4">PO Date</th>
          <th class="py-3 px-4">Expected</th>
          <th class="py-3 px-4">Items</th>
          <th class="py-3 px-4">Notes</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for po in pos %}
        <tr>
          <td class="py-3 px-4 font-semibold text-slate-800">
            <a href="{{ url_for('purchase_order_detail_view', po_id=po.id) }}" class="hover:underline">{{ po.po_number }}</a>
          </td>
          <td class="py-3 px-4"><span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">{{ (po.origin or 'erp')|upper }}</span></td>
          <td class="py-3 px-4">{{ po.vendor.name if po.vendor else 'No vendor' }}</td>
          <td class="py-3 px-4">{{ po.project.name if po.project else 'General' }}</td>
          <td class="py-3 px-4 text-slate-700">
            {% if po.bom %}<div class="text-xs text-slate-500">{{ po.bom.bom_name }} (ID {{ po.bom.id }})</div>{% else %}<div class="text-xs text-slate-500">No BOM link</div>{% endif %}
          </td>
          <td class="py-3 px-4"><span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">{{ po.status|title }}</span></td>
          <td class="py-3 px-4">{{ po.po_date or po.order_date or '—' }}</td>
          <td class="py-3 px-4">{{ po.expected_delivery or po.expected_delivery_date or '—' }}</td>
          <td class="py-3 px-4">{{ po.items|length }} item(s)</td>
          <td class="py-3 px-4 text-slate-600">{{ po.notes or '—' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="10" class="py-4 px-4 text-slate-500">No purchase orders yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<template id="po-item-row-template">
  <tr class="po-item-row transition-colors duration-150 hover:bg-slate-100/70">
    <td class="py-2 px-3 min-w-[260px]">
      <div class="relative">
        <input type="text" name="part_name[]" class="w-full rounded-lg border-slate-200 h-10 px-3" data-part-name autocomplete="off" />
        <input type="hidden" name="part_id[]" data-part-id />
        <input type="hidden" name="item_code[]" data-item-code />
      </div>
    </td>
    <td class="py-2 px-3 min-w-[220px]">
      <input type="text" name="description[]" class="w-full rounded-lg border-slate-200 h-10 px-3" />
    </td>
    <td class="py-2 px-3 min-w-[90px]">
      <input type="number" step="0.01" min="0" name="quantity_ordered[]" class="w-full rounded-lg border-slate-200 h-10 px-3" value="1" />
    </td>
    <td class="py-2 px-3 min-w-[110px]">
      <input type="text" name="unit[]" class="w-full rounded-lg border-slate-200 h-10 px-3" placeholder="nos" />
    </td>
    <td class="py-2 px-3 min-w-[120px]">
      <input type="number" step="0.01" min="0" name="unit_price[]" class="w-full rounded-lg border-slate-200 h-10 px-3" />
    </td>
    <td class="py-2 px-3 min-w-[120px] text-right">
      <span class="line-total font-semibold text-slate-700">0.00</span>
    </td>
    <td class="py-2 px-3 min-w-[90px] text-right">
      <button type="button" class="inline-flex h-8 w-8 items-center justify-center rounded-md text-rose-600 transition duration-150 hover:bg-rose-50 hover:text-rose-700 hover:scale-105 disabled:cursor-not-allowed disabled:opacity-40 disabled:hover:scale-100 disabled:hover:bg-transparent" data-remove-item aria-label="Remove line item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M8 6V4h8v2m-1 0v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6m3 4v8m4-8v8" />
        </svg>
      </button>
    </td>
  </tr>
</template>

<script>
  (() => {
    const modalToggle = document.getElementById('new-po');
    const form = document.getElementById('purchase-order-form');
    if (!form) {
      return;
    }

    const poDateInput = form.querySelector('[name="po_date"]');
    const expectedInput = form.querySelector('[name="expected_delivery"]');
    const itemsBody = form.querySelector('[data-items-body]');
    const itemsWrapper = form.querySelector('[data-items-wrapper]');
    const addItemButton = form.querySelector('[data-add-item]');
    const template = document.getElementById('po-item-row-template');
    const subtotalDisplay = form.querySelector('[data-subtotal]');
    const grandTotalDisplay = form.querySelector('[data-grand-total]');
    const subtotalInput = form.querySelector('[name="subtotal_amount"]');
    const grandTotalInput = form.querySelector('[name="grand_total_amount"]');
    const partSearchEndpoint = '/api/parts/search';
    const partSearchLimit = 20;

    let lastAutoExpected = '';
    let autoUpdateExpected = true;
    let partSearchTimer = null;
    let activePartInput = null;
    let activePartResults = [];
    let activePartIndex = -1;
    let partRequestCounter = 0;

    const partDropdown = document.createElement('div');
    partDropdown.className = 'po-part-dropdown hidden';
    document.body.appendChild(partDropdown);

    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const addDays = (dateString, days) => {
      const parts = dateString.split('-').map((part) => parseInt(part, 10));
      if (parts.length !== 3 || parts.some((part) => Number.isNaN(part))) {
        return '';
      }
      const date = new Date(parts[0], parts[1] - 1, parts[2]);
      date.setDate(date.getDate() + days);
      return formatDate(date);
    };

    const syncExpectedDelivery = (force) => {
      if (!poDateInput || !expectedInput || !poDateInput.value) {
        return;
      }
      const nextExpected = addDays(poDateInput.value, 15);
      if (!nextExpected) {
        return;
      }
      if (force || autoUpdateExpected) {
        expectedInput.value = nextExpected;
        lastAutoExpected = nextExpected;
        autoUpdateExpected = true;
      }
    };

    const initializeDates = () => {
      if (!poDateInput || !expectedInput) {
        return;
      }
      if (!poDateInput.value) {
        poDateInput.value = formatDate(new Date());
      }
      const computedExpected = addDays(poDateInput.value, 15);
      if (!expectedInput.value) {
        expectedInput.value = computedExpected;
        lastAutoExpected = computedExpected;
        autoUpdateExpected = true;
      } else {
        lastAutoExpected = computedExpected;
        autoUpdateExpected = expectedInput.value === lastAutoExpected;
      }
    };

    const parseNumber = (value) => {
      const parsed = parseFloat(value);
      return Number.isNaN(parsed) ? 0 : parsed;
    };

    const updateRowTotal = (row) => {
      const qtyInput = row.querySelector('[name="quantity_ordered[]"]');
      const priceInput = row.querySelector('[name="unit_price[]"]');
      const totalEl = row.querySelector('.line-total');
      const quantity = parseNumber(qtyInput ? qtyInput.value : 0);
      const unitPrice = parseNumber(priceInput ? priceInput.value : 0);
      const lineTotal = quantity * unitPrice;
      if (totalEl) {
        totalEl.textContent = lineTotal.toFixed(2);
      }
      return lineTotal;
    };

    const updateTotals = () => {
      if (!itemsBody) {
        return;
      }
      let subtotal = 0;
      itemsBody.querySelectorAll('.po-item-row').forEach((row) => {
        subtotal += updateRowTotal(row);
      });
      const totalValue = subtotal.toFixed(2);
      if (subtotalDisplay) {
        subtotalDisplay.textContent = totalValue;
      }
      if (grandTotalDisplay) {
        grandTotalDisplay.textContent = totalValue;
      }
      if (subtotalInput) {
        subtotalInput.value = totalValue;
      }
      if (grandTotalInput) {
        grandTotalInput.value = totalValue;
      }
    };

    const closePartDropdown = () => {
      partDropdown.classList.add('hidden');
      partDropdown.innerHTML = '';
      activePartInput = null;
      activePartResults = [];
      activePartIndex = -1;
    };

    const positionPartDropdown = (input) => {
      if (!input) {
        return;
      }
      const rect = input.getBoundingClientRect();
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      const dropdownHeight = Math.min(288, activePartResults.length * 52 + 24);
      const spaceBelow = viewportHeight - rect.bottom;
      const openAbove = spaceBelow < dropdownHeight && rect.top > spaceBelow;
      partDropdown.style.width = `${rect.width}px`;
      partDropdown.style.left = `${rect.left}px`;
      if (openAbove) {
        partDropdown.style.top = `${rect.top - dropdownHeight}px`;
      } else {
        partDropdown.style.top = `${rect.bottom + 6}px`;
      }
    };

    const highlightActiveOption = () => {
      const options = Array.from(partDropdown.querySelectorAll('[data-part-option]'));
      options.forEach((option, index) => {
        if (index === activePartIndex) {
          option.classList.add('is-active');
        } else {
          option.classList.remove('is-active');
        }
      });
    };

    const applyPartSelection = (part, input) => {
      if (!input) {
        return;
      }
      const row = input.closest('.po-item-row');
      input.value = part.name;
      if (row) {
        row.dataset.selectedPartId = part.id ? String(part.id) : '';
      }
      const partIdInput = row ? row.querySelector('[data-part-id]') : null;
      const itemCodeInput = row ? row.querySelector('[data-item-code]') : null;
      const descriptionInput = row ? row.querySelector('[name="description[]"]') : null;
      const unitInput = row ? row.querySelector('[name="unit[]"]') : null;

      if (partIdInput) {
        partIdInput.value = part.id || '';
      }
      if (itemCodeInput) {
        itemCodeInput.value = part.item_code || '';
      }
      const hasDescriptionEdit = row && row.dataset.descriptionEdited === 'true';
      const hasUnitEdit = row && row.dataset.unitEdited === 'true';
      if (descriptionInput && part.description && !hasDescriptionEdit) {
        descriptionInput.value = part.description;
        if (row) {
          row.dataset.descriptionEdited = 'false';
        }
      }
      if (unitInput && part.unit && !hasUnitEdit) {
        unitInput.value = part.unit;
        if (row) {
          row.dataset.unitEdited = 'false';
        }
      }
      if (row) {
        row.dataset.partNameFilled = input.value.trim() ? 'true' : 'false';
      }
      closePartDropdown();
      updateTotals();
    };

    const renderPartDropdown = (parts, input) => {
      partDropdown.innerHTML = '';
      if (!parts.length) {
        const emptyState = document.createElement('div');
        emptyState.className = 'po-part-dropdown__empty';
        emptyState.textContent = 'No matching parts found.';
        partDropdown.appendChild(emptyState);
      } else {
        parts.forEach((part, index) => {
          const option = document.createElement('button');
          option.type = 'button';
          option.dataset.partOption = 'true';
          option.dataset.partIndex = String(index);
          option.className = 'po-part-dropdown__item';
          const nameEl = document.createElement('span');
          nameEl.className = 'po-part-dropdown__name';
          const primaryName = part.name || part.item_code || part.description || 'Unnamed part';
          nameEl.textContent = primaryName;
          const metaEl = document.createElement('span');
          metaEl.className = 'po-part-dropdown__meta';
          const metaBits = [];
          if (part.description && part.description !== primaryName) {
            metaBits.push(part.description);
          }
          if (part.unit) {
            metaBits.push(`Unit: ${part.unit}`);
          }
          metaEl.textContent = metaBits.join(' · ') || 'No extra details';
          option.appendChild(nameEl);
          option.appendChild(metaEl);
          option.addEventListener('mousedown', (event) => {
            event.preventDefault();
            applyPartSelection(part, input);
          });
          option.addEventListener('mouseenter', () => {
            activePartIndex = index;
            highlightActiveOption();
          });
          partDropdown.appendChild(option);
        });
      }
      activePartIndex = -1;
      activePartInput = input;
      activePartResults = parts;
      positionPartDropdown(input);
      partDropdown.classList.remove('hidden');
    };

    const fetchPartMatches = async (query, input) => {
      const currentRequest = ++partRequestCounter;
      const url = `${partSearchEndpoint}?q=${encodeURIComponent(query)}&limit=${partSearchLimit}`;
      try {
        const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
          throw new Error('Failed to fetch parts');
        }
        const data = await response.json();
        if (currentRequest !== partRequestCounter) {
          return;
        }
        if (activePartInput !== input) {
          activePartInput = input;
        }
        renderPartDropdown(Array.isArray(data) ? data : [], input);
      } catch (error) {
        if (currentRequest !== partRequestCounter) {
          return;
        }
        renderPartDropdown([], input);
      }
    };

    const handlePartInput = (input, { clearSelection = true } = {}) => {
      if (!input) {
        return;
      }
      const row = input.closest('.po-item-row');
      const partIdInput = row ? row.querySelector('[data-part-id]') : null;
      const itemCodeInput = row ? row.querySelector('[data-item-code]') : null;
      if (clearSelection) {
        if (partIdInput) {
          partIdInput.value = '';
        }
        if (itemCodeInput) {
          itemCodeInput.value = '';
        }
      }
      const query = input.value.trim();
      if (!query) {
        closePartDropdown();
        if (row) {
          row.dataset.partNameFilled = 'false';
          row.dataset.selectedPartId = '';
          row.dataset.descriptionEdited = 'false';
          row.dataset.unitEdited = 'false';
        }
        return;
      }
      if (row) {
        row.dataset.partNameFilled = 'true';
      }
      if (partSearchTimer) {
        clearTimeout(partSearchTimer);
      }
      partSearchTimer = setTimeout(() => {
        fetchPartMatches(query, input);
      }, 200);
    };

    const initializeRowState = (row) => {
      if (!row) {
        return;
      }
      const partNameInput = row.querySelector('[data-part-name]');
      if (partNameInput) {
        row.dataset.partNameFilled = partNameInput.value.trim() ? 'true' : 'false';
      }
    };

    const updateRemoveButtons = () => {
      if (!itemsBody) {
        return;
      }
      const rows = Array.from(itemsBody.querySelectorAll('.po-item-row'));
      const disableRemove = rows.length <= 1;
      rows.forEach((row) => {
        const removeButton = row.querySelector('[data-remove-item]');
        if (removeButton) {
          removeButton.disabled = disableRemove;
        }
      });
    };

    const scrollToNewRow = () => {
      if (!itemsWrapper) {
        return;
      }
      requestAnimationFrame(() => {
        itemsWrapper.scrollTo({
          top: itemsWrapper.scrollHeight,
          behavior: 'smooth',
        });
      });
    };

    const addRow = () => {
      if (!template || !itemsBody) {
        return;
      }
      const row = template.content.firstElementChild.cloneNode(true);
      itemsBody.appendChild(row);
      initializeRowState(row);
      updateTotals();
      updateRemoveButtons();
      scrollToNewRow();
    };

    const removeRow = (button) => {
      if (!itemsBody) {
        return;
      }
      const row = button.closest('.po-item-row');
      if (!row) {
        return;
      }
      if (itemsBody.querySelectorAll('.po-item-row').length <= 1) {
        row.querySelectorAll('input').forEach((input) => {
          if (input.type === 'number') {
            input.value = input.name === 'quantity_ordered[]' ? '1' : '';
          } else {
            input.value = '';
          }
        });
      } else {
        row.remove();
      }
      updateTotals();
      updateRemoveButtons();
    };

    form.addEventListener('input', (event) => {
      if (!event.target) {
        return;
      }
      const row = event.target.closest('.po-item-row');
      if (row) {
        updateTotals();
      }
      if (row && event.target.matches('[name="description[]"]')) {
        row.dataset.descriptionEdited = 'true';
      }
      if (row && event.target.matches('[name="unit[]"]')) {
        row.dataset.unitEdited = 'true';
      }
      if (event.target.matches('[data-part-name]')) {
        handlePartInput(event.target);
        const lastRow = itemsBody ? itemsBody.querySelector('.po-item-row:last-child') : null;
        if (lastRow && row === lastRow) {
          const inputValue = event.target.value.trim();
          if (inputValue && row.dataset.partNameFilled !== 'true') {
            row.dataset.partNameFilled = 'true';
            addRow();
          } else if (!inputValue) {
            row.dataset.partNameFilled = 'false';
          }
        }
      }
    });

    form.addEventListener('focusin', (event) => {
      if (!event.target || !event.target.matches('[data-part-name]')) {
        return;
      }
      const query = event.target.value.trim();
      if (query) {
        handlePartInput(event.target, { clearSelection: false });
      }
    });

    form.addEventListener('keydown', (event) => {
      if (!event.target || !event.target.matches('[data-part-name]')) {
        return;
      }
      if (partDropdown.classList.contains('hidden')) {
        return;
      }
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        activePartIndex = Math.min(activePartIndex + 1, activePartResults.length - 1);
        highlightActiveOption();
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        activePartIndex = Math.max(activePartIndex - 1, 0);
        highlightActiveOption();
      } else if (event.key === 'Enter') {
        if (activePartIndex >= 0 && activePartResults[activePartIndex]) {
          event.preventDefault();
          applyPartSelection(activePartResults[activePartIndex], event.target);
        }
      } else if (event.key === 'Escape') {
        event.preventDefault();
        closePartDropdown();
      }
    });

    form.addEventListener('click', (event) => {
      const removeButton = event.target.closest('[data-remove-item]');
      if (removeButton) {
        event.preventDefault();
        removeRow(removeButton);
      }
    });

    document.addEventListener('click', (event) => {
      if (partDropdown.classList.contains('hidden')) {
        return;
      }
      if (event.target === activePartInput || partDropdown.contains(event.target)) {
        return;
      }
      closePartDropdown();
    });

    window.addEventListener('resize', () => {
      if (!partDropdown.classList.contains('hidden')) {
        positionPartDropdown(activePartInput);
      }
    });

    if (itemsWrapper) {
      itemsWrapper.addEventListener('scroll', () => {
        if (!partDropdown.classList.contains('hidden')) {
          positionPartDropdown(activePartInput);
        }
      });
    }

    if (addItemButton) {
      addItemButton.addEventListener('click', () => {
        addRow();
      });
    }

    if (expectedInput) {
      expectedInput.addEventListener('input', () => {
        autoUpdateExpected = expectedInput.value === lastAutoExpected;
      });
    }

    if (poDateInput) {
      poDateInput.addEventListener('change', () => {
        syncExpectedDelivery(false);
      });
    }

    if (modalToggle) {
      modalToggle.addEventListener('change', () => {
        if (modalToggle.checked) {
          initializeDates();
          updateTotals();
          updateRemoveButtons();
        }
      });
    }

    updateTotals();
    updateRemoveButtons();
    if (itemsBody) {
      itemsBody.querySelectorAll('.po-item-row').forEach((row) => {
        initializeRowState(row);
      });
    }
  })();
</script>
{% endblock %}
