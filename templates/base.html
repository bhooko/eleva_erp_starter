<!DOCTYPE html>
<html lang="en" data-theme="warm-modern">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Eleva ERP{% endblock %}</title>

  <script>
    (function () {
      try {
        const saved = localStorage.getItem('eleva:theme');
        const theme = saved || 'warm-modern';
        document.documentElement.setAttribute('data-theme', theme);
      } catch (error) {
        document.documentElement.setAttribute('data-theme', 'warm-modern');
      }
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      color-scheme: dark;
      --color-base: #111827;
      --color-base-rgb: 17, 24, 39;
      --color-card: #1F2937;
      --color-card-rgb: 31, 41, 55;
      --color-primary: #FB923C;
      --color-primary-rgb: 251, 146, 60;
      --color-secondary: #FACC15;
      --color-secondary-rgb: 250, 204, 21;
      --color-neutral: #374151;
      --color-neutral-rgb: 55, 65, 81;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --accent-success: #22C55E;
      --accent-warning: #FBBF24;
      --accent-error: #F87171;
      --border-subtle: #2D333B;
      --stage-cold: #2563EB;
      --stage-warm: #FB923C;
      --stage-success: #22C55E;
      --stage-glow: rgba(59, 130, 246, 0.45);
    }

    html[data-theme="eleva-signature"] {
      --color-base: #0F141A;
      --color-base-rgb: 15, 20, 26;
      --color-card: #1C2128;
      --color-card-rgb: 28, 33, 40;
      --color-primary: #007AFF;
      --color-primary-rgb: 0, 122, 255;
      --color-secondary: #39C0ED;
      --color-secondary-rgb: 57, 192, 237;
      --color-neutral: #2D333B;
      --color-neutral-rgb: 45, 51, 59;
      --text-primary: #E5E7EB;
      --text-secondary: #9CA3AF;
      --accent-success: #00C58E;
      --accent-warning: #FBBF24;
      --accent-error: #F87171;
      --border-subtle: #2D333B;
      --stage-cold: #39C0ED;
      --stage-warm: #007AFF;
      --stage-success: #00C58E;
      --stage-glow: rgba(0, 122, 255, 0.45);
    }

    html[data-theme="metallic-elevate"] {
      --color-base: #121212;
      --color-base-rgb: 18, 18, 18;
      --color-card: #1A1F24;
      --color-card-rgb: 26, 31, 36;
      --color-primary: #A9B1B7;
      --color-primary-rgb: 169, 177, 183;
      --color-secondary: #3B82F6;
      --color-secondary-rgb: 59, 130, 246;
      --color-neutral: #2B3036;
      --color-neutral-rgb: 43, 48, 54;
      --text-primary: #F5F6F7;
      --text-secondary: #9CA3AF;
      --accent-success: #14B8A6;
      --accent-warning: #00E0E0;
      --accent-error: #EF4444;
      --border-subtle: #2F343A;
      --stage-cold: #3B82F6;
      --stage-warm: #00E0E0;
      --stage-success: #14B8A6;
      --stage-glow: rgba(59, 130, 246, 0.45);
    }

    html[data-theme="warm-modern"] {
      --color-base: #111827;
      --color-base-rgb: 17, 24, 39;
      --color-card: #1F2937;
      --color-card-rgb: 31, 41, 55;
      --color-primary: #FB923C;
      --color-primary-rgb: 251, 146, 60;
      --color-secondary: #FACC15;
      --color-secondary-rgb: 250, 204, 21;
      --color-neutral: #374151;
      --color-neutral-rgb: 55, 65, 81;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --accent-success: #22C55E;
      --accent-warning: #FBBF24;
      --accent-error: #F87171;
      --border-subtle: #2D333B;
      --stage-cold: #2563EB;
      --stage-warm: #FB923C;
      --stage-success: #22C55E;
      --stage-glow: rgba(59, 130, 246, 0.45);
    }

    html, body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background-color: var(--color-base);
      color: var(--text-primary);
      transition: background-color 220ms ease, color 220ms ease;
    }
    a { color: var(--color-secondary); transition: color 180ms ease; }
    a:hover { color: var(--color-primary); }
    .animate-slide { transition: all 220ms cubic-bezier(.2,.8,.2,1); }

    .sidebar { width: 280px; }
    .sidebar.collapsed { width: 78px; }

    .sidebar-collapsed .label { opacity: 0; transform: translateX(-8px); pointer-events: none; }
    .sidebar-expanded .label { opacity: 1; transform: translateX(0); }

    .nav-item { border-radius: 12px; transition: background-color 160ms ease, outline-color 160ms ease; }
    .nav-item:hover { background: rgba(var(--color-neutral-rgb), 0.45); }
    .nav-item.active {
      background: rgba(var(--color-primary-rgb), 0.18);
      outline: 1px solid rgba(var(--color-primary-rgb), 0.35);
      color: var(--text-primary);
    }

    /* Core backgrounds */
    .bg-slate-950 { background-color: var(--color-base) !important; }
    .bg-slate-950\/30 { background-color: rgba(var(--color-base-rgb), 0.3) !important; }
    .bg-slate-950\/40 { background-color: rgba(var(--color-base-rgb), 0.4) !important; }
    .bg-slate-950\/50 { background-color: rgba(var(--color-base-rgb), 0.5) !important; }
    .bg-slate-950\/60 { background-color: rgba(var(--color-base-rgb), 0.6) !important; }
    .bg-slate-950\/70 { background-color: rgba(var(--color-base-rgb), 0.7) !important; }
    .bg-slate-950\/80 { background-color: rgba(var(--color-base-rgb), 0.8) !important; }
    .bg-slate-950\/95 { background-color: rgba(var(--color-base-rgb), 0.95) !important; }
    .supports-\[backdrop-filter\]\:bg-slate-950\/40 { background-color: rgba(var(--color-base-rgb), 0.4) !important; }

    .bg-slate-900 { background-color: var(--color-card) !important; }
    .bg-slate-900\/40 { background-color: rgba(var(--color-card-rgb), 0.4) !important; }
    .bg-slate-900\/50 { background-color: rgba(var(--color-card-rgb), 0.5) !important; }
    .bg-slate-900\/60 { background-color: rgba(var(--color-card-rgb), 0.6) !important; }
    .bg-slate-900\/70 { background-color: rgba(var(--color-card-rgb), 0.7) !important; }
    .bg-slate-900\/80 { background-color: rgba(var(--color-card-rgb), 0.8) !important; }
    .bg-slate-900\/90 { background-color: rgba(var(--color-card-rgb), 0.9) !important; }
    .bg-slate-900\/95 { background-color: rgba(var(--color-card-rgb), 0.95) !important; }
    .supports-\[backdrop-filter\]\:bg-slate-900\/50 { background-color: rgba(var(--color-card-rgb), 0.5) !important; }

    .bg-slate-800 { background-color: var(--color-neutral) !important; }
    .bg-slate-800\/40 { background-color: rgba(var(--color-neutral-rgb), 0.4) !important; }
    .bg-slate-800\/50 { background-color: rgba(var(--color-neutral-rgb), 0.5) !important; }
    .bg-slate-800\/60 { background-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .bg-slate-800\/70 { background-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .bg-slate-800\/80 { background-color: rgba(var(--color-neutral-rgb), 0.8) !important; }

    .bg-slate-700 { background-color: rgba(var(--color-neutral-rgb), 0.85) !important; }
    .bg-slate-700\/60 { background-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .bg-slate-700\/70 { background-color: rgba(var(--color-neutral-rgb), 0.7) !important; }

    /* Borders and outlines */
    .border-slate-800 { border-color: var(--color-neutral) !important; }
    .border-slate-800\/60 { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .border-slate-800\/80 { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }
    .border-slate-700 { border-color: var(--color-neutral) !important; }
    .border-slate-700\/40 { border-color: rgba(var(--color-neutral-rgb), 0.4) !important; }
    .border-slate-700\/60 { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .border-slate-700\/70 { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .border-slate-700\/80 { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }
    .border-slate-600 { border-color: rgba(var(--color-neutral-rgb), 0.9) !important; }
    .border-slate-500 { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }

    .divide-slate-800 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .divide-slate-800\/60 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .divide-slate-800\/80 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }

    /* Typography */
    .text-slate-50,
    .text-slate-100,
    .text-slate-200 { color: var(--text-primary) !important; }
    .text-slate-300,
    .text-slate-400,
    .text-slate-500 { color: var(--text-secondary) !important; }
    .text-slate-600,
    .text-slate-700 { color: rgba(209, 213, 219, 0.75) !important; }

    /* Accent remapping */
    .bg-emerald-600,
    .bg-emerald-500 { background-color: var(--color-primary) !important; }
    .bg-emerald-500\/10 { background-color: rgba(var(--color-primary-rgb), 0.1) !important; }
    .bg-emerald-500\/20 { background-color: rgba(var(--color-primary-rgb), 0.2) !important; }
    .bg-emerald-500\/30 { background-color: rgba(var(--color-primary-rgb), 0.3) !important; }
    .bg-emerald-500\/60,
    .bg-emerald-400\/60 { background-color: rgba(var(--color-primary-rgb), 0.6) !important; }
    .hover\:bg-emerald-500:hover { background-color: var(--color-secondary) !important; }

    .border-emerald-500,
    .border-emerald-400 { border-color: var(--color-primary) !important; }
    .border-emerald-500\/60,
    .border-emerald-400\/60 { border-color: rgba(var(--color-primary-rgb), 0.6) !important; }
    .border-emerald-500\/40,
    .border-emerald-400\/40 { border-color: rgba(var(--color-primary-rgb), 0.4) !important; }
    .border-emerald-500\/30,
    .border-emerald-400\/30 { border-color: rgba(var(--color-primary-rgb), 0.3) !important; }
    .border-emerald-400\/70 { border-color: rgba(var(--color-primary-rgb), 0.7) !important; }

    .text-emerald-400,
    .text-emerald-300,
    .text-emerald-200,
    .text-emerald-100 { color: var(--color-secondary) !important; }
    .text-emerald-300\/80,
    .text-emerald-100\/80 { color: rgba(var(--color-secondary-rgb), 0.8) !important; }
    .hover\:text-emerald-300:hover,
    .hover\:text-emerald-200:hover,
    .hover\:text-emerald-100:hover { color: var(--color-secondary) !important; }

    .focus\:ring-emerald-500\/50:focus,
    .focus\:ring-emerald-500\/40:focus { --tw-ring-color: rgba(var(--color-primary-rgb), 0.5) !important; }
    .focus\:ring-emerald-400\/60:focus { --tw-ring-color: rgba(var(--color-primary-rgb), 0.6) !important; }

    .focus\:border-emerald-400:focus { border-color: var(--color-primary) !important; }
    .accent-emerald-500 { accent-color: var(--color-primary) !important; }
    .ring-emerald-500,
    .ring-emerald-400 { --tw-ring-color: rgba(var(--color-primary-rgb), 0.45) !important; }

    .bg-emerald-400 { background-color: var(--color-primary) !important; }
    .bg-emerald-400\/60 { background-color: rgba(var(--color-primary-rgb), 0.6) !important; }

    .hover\:bg-emerald-500\/10:hover { background-color: rgba(var(--color-primary-rgb), 0.1) !important; }
    .hover\:bg-emerald-500\/20:hover { background-color: rgba(var(--color-primary-rgb), 0.2) !important; }
    .hover\:bg-emerald-500\/30:hover { background-color: rgba(var(--color-primary-rgb), 0.3) !important; }

    .hover\:border-emerald-400\/40:hover { border-color: rgba(var(--color-primary-rgb), 0.4) !important; }
    .hover\:border-slate-500:hover { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }

    .sidebar-menu { overflow: auto; }

    .tooltip { position: relative; }
    .tooltip:hover .tooltip-content { opacity: 1; transform: translateY(0); }
    .tooltip-content {
      position: absolute; left: 100%; top: 50%; transform: translateY(-50%) translateY(4px);
      background: rgba(var(--color-base-rgb), 0.95); color: var(--text-secondary); padding: 6px 10px; border-radius: 8px;
      white-space: nowrap; margin-left: 8px; font-size: 12px; opacity: 0; pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
      border: 1px solid rgba(var(--color-neutral-rgb), 0.6);
    }

    .card-hover-lift {
      transition: transform 220ms cubic-bezier(.2,.8,.2,1), box-shadow 260ms ease;
      will-change: transform, box-shadow;
    }
    .card-hover-lift:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
    }

    .fade-in-up {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeInUp 420ms cubic-bezier(.2,.8,.2,1) forwards;
      animation-delay: var(--fade-delay, 0ms);
    }

    .btn-shimmer {
      position: relative;
      overflow: hidden;
      isolation: isolate;
      transition: transform 160ms ease, box-shadow 220ms ease;
    }
    .btn-shimmer::after {
      content: "";
      position: absolute;
      inset: -120% 0;
      background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.65) 45%, transparent 100%);
      transform: translateX(-120%);
      transition: transform 600ms ease;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .btn-shimmer:hover,
    .btn-shimmer:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(var(--color-primary-rgb), 0.35);
    }
    .btn-shimmer:hover::after,
    .btn-shimmer:focus-visible::after {
      transform: translateX(120%);
    }

    .stage-node {
      position: relative;
      transition: transform 200ms ease, box-shadow 240ms ease, border-color 220ms ease, background-color 220ms ease;
      border: 2px solid rgba(var(--color-neutral-rgb), 0.7);
      background: rgba(var(--color-card-rgb), 0.55);
      color: var(--text-secondary);
      will-change: transform, box-shadow;
    }
    .stage-node:hover { transform: translateY(-3px); }
    .stage-node.is-complete {
      background: rgba(var(--color-primary-rgb), 0.18);
      border-color: rgba(var(--color-primary-rgb), 0.6);
      color: var(--text-primary);
    }
    .stage-node.is-active {
      background: rgba(var(--color-secondary-rgb), 0.2);
      border-color: rgba(var(--color-secondary-rgb), 0.75);
      color: var(--text-primary);
      box-shadow: 0 0 0 0 var(--stage-glow), 0 0 18px var(--stage-glow);
      animation: stagePulse 2600ms ease-in-out infinite;
    }
    .stage-node.is-active::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px var(--stage-glow);
      opacity: 0.85;
      pointer-events: none;
    }

    .stage-label {
      color: var(--text-secondary);
      transition: color 180ms ease;
    }
    .stage-label.is-active {
      color: var(--text-primary);
      font-weight: 600;
    }

    .stage-connector {
      position: relative;
      width: 3rem;
      height: 4px;
      border-radius: 999px;
      background: rgba(var(--color-neutral-rgb), 0.35);
      overflow: hidden;
    }
    .stage-connector::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--stage-cold), var(--stage-warm), var(--stage-success));
      transform: translateX(-110%);
      opacity: 0;
      transition: transform 520ms ease, opacity 520ms ease;
    }
    .stage-connector.is-complete::before {
      transform: translateX(0);
      opacity: 1;
    }
    .stage-connector.is-progress::before {
      transform: translateX(-40%);
      opacity: 1;
    }

    @keyframes stagePulse {
      0%, 100% { box-shadow: 0 0 0 0 var(--stage-glow), 0 0 18px var(--stage-glow); }
      50% { box-shadow: 0 0 0 6px rgba(0, 0, 0, 0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      .fade-in-up { animation: none; opacity: 1; transform: none; }
      .card-hover-lift:hover { transform: none; box-shadow: none; }
      .btn-shimmer { transition: none; }
      .btn-shimmer::after { display: none; }
      .stage-node { animation: none; }
      .stage-connector::before { transition: none; }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">

  <!-- Fixed top header -->
  <header class="sticky top-0 z-30 border-b border-slate-800/60 bg-slate-950/70 backdrop-blur supports-[backdrop-filter]:bg-slate-950/40">
    <div class="max-w-full px-4 sm:px-6 py-3 flex items-center gap-3">
      <!-- Brand: logo + version text -->
      <div class="flex items-center gap-3 min-w-[160px]">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Eleva" class="w-9 h-9 rounded-lg shadow">
        <div class="text-sm leading-tight text-slate-200 font-semibold">Eleva ERP v1.0.0</div>
      </div>

      <!-- Back button -->
      <a href="{{ request.referrer or url_for('dashboard') }}"
         class="ml-2 inline-flex items-center gap-2 text-slate-300 hover:text-white px-3 py-2 rounded-xl bg-slate-800/50 hover:bg-slate-700/60 border border-slate-700/60 animate-slide">
        <span>&larr;</span><span class="hidden sm:inline">Back</span>
      </a>

      <!-- Spacer + user -->
      <div class="ml-auto flex items-center gap-3">
        {% if current_user.is_authenticated %}
          <div class="hidden sm:block text-right">
            <div class="text-sm font-semibold text-slate-100">{{ current_user.display_name }}</div>
            <div class="text-xs text-slate-400">{{ current_user.role or 'Member' }}</div>
          </div>
          <a href="{{ url_for('profile') }}"
             class="group relative block w-10 h-10 rounded-full border border-slate-700/70 bg-slate-800/60 overflow-hidden focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
             title="Open profile">
            <span class="sr-only">Open profile settings</span>
            <img src="{{ url_for('static', filename=current_user.display_picture) if current_user.display_picture else url_for('static', filename='default-avatar.svg') }}"
                 alt="{{ current_user.display_name }}"
                 class="w-full h-full object-cover transition-transform duration-150 group-hover:scale-105">
          </a>
        {% else %}
          <a href="{{ url_for('login') }}" class="text-sm text-slate-300 underline">Login</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div id="app" class="min-h-[calc(100vh-56px)] grid grid-cols-[auto_1fr]">

    <!-- Sidebar -->
    <aside id="sidebar"
           class="sidebar animate-slide bg-slate-900/70 backdrop-blur supports-[backdrop-filter]:bg-slate-900/50 sticky top-[56px] h-[calc(100vh-56px)] border-r border-slate-800/60 shadow-xl shadow-black/20 flex flex-col">
      <!-- Collapse button slot -->
      <div class="sticky top-0 z-20 px-3 pt-3 pb-2 bg-transparent">
        <button id="collapseBtn"
                class="tooltip group inline-flex items-center justify-center w-10 h-10 rounded-xl bg-slate-800/70 hover:bg-slate-700/70 border border-slate-700/70 animate-slide"
                aria-label="Collapse sidebar" type="button">
          <svg id="collapseIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
               class="w-5 h-5 transition-transform duration-200">
            <path fill-rule="evenodd"
                  d="M19.5 12a.75.75 0 01-.75.75H9.31l2.22 2.22a.75.75 0 01-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5a.75.75 0 111.06 1.06L9.31 11.25h9.44c.414 0 .75.336.75.75z"
                  clip-rule="evenodd" />
          </svg>
          <span class="tooltip-content">Collapse</span>
        </button>
        <div class="mt-3 h-2 rounded-xl" style="background-image: linear-gradient(to right, rgba(251,146,60,0.3), rgba(250,204,21,0.2), transparent);"></div>
      </div>

      <!-- Menu list -->
      <nav class="sidebar-menu px-3 pb-4 space-y-2 flex-1 overflow-auto">
        <a href="{{ url_for('dashboard') }}"
           class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint == 'dashboard' else '' }}">
          <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 10l8-6 8 6v10h-6v-6H10v6H4z" />
            </svg>
          </span>
          <span class="label text-[15px] flex-1">Dashboard</span>
        </a>

        {% set sales_endpoints = [
          'sales_home','sales_clients','sales_clients_create','sales_client_detail',
          'sales_opportunities_pipeline','sales_opportunities_create','sales_opportunity_detail','sales_opportunity_stage'
        ] %}
        {% set sales_parent_active = request.endpoint in sales_endpoints %}
        <div class="space-y-1">
          <div class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if sales_parent_active else '' }}">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 4h16v2H4zm1 4h14v2H5zm-1 4h16v6H4zm2 2v2h12v-2z"/>
              </svg>
            </span>
            <span class="label text-[15px] flex-1">Sales</span>
          </div>
          <div class="pl-12 space-y-1">
            <a href="{{ url_for('sales_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_home' else '' }}">
              <span class="label">Sales Overview</span>
            </a>
            <div class="space-y-1">
              <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key='lift') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['sales_opportunities_pipeline','sales_opportunity_detail'] else '' }}">
                <span class="label">Opportunities</span>
              </a>
              <div class="pl-8 space-y-1">
                <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key='lift') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_opportunities_pipeline' and request.view_args and request.view_args.get('pipeline_key') == 'lift' else '' }}">
                  <span class="label">Lift</span>
                </a>
                <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key='amc') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_opportunities_pipeline' and request.view_args and request.view_args.get('pipeline_key') == 'amc' else '' }}">
                  <span class="label">AMC</span>
                </a>
                <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key='parking') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_opportunities_pipeline' and request.view_args and request.view_args.get('pipeline_key') == 'parking' else '' }}">
                  <span class="label">Parking System</span>
                </a>
              </div>
            </div>
            <a href="{{ url_for('sales_clients') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['sales_clients','sales_client_detail'] else '' }}">
              <span class="label">Clients</span>
            </a>
          </div>
        </div>

        {% set project_endpoints = ['projects_pending','projects_list','project_detail','project_task_create','project_templates','project_template_detail'] %}
        <div class="space-y-1">
          <a href="{{ url_for('projects_pending') }}"
             class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint in project_endpoints else '' }}">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 4h16v2H4zm2 4h12v2H6zm-2 4h16v10H4z" />
              </svg>
            </span>
            <span class="label text-[15px] flex-1">Projects</span>
          </a>
          <div class="pl-12 space-y-1">
            <a href="{{ url_for('projects_pending') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'projects_pending' else '' }}">
              <span class="label">Projects Overview</span>
            </a>
            <a href="{{ url_for('projects_list') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['projects_list','project_detail'] else '' }}">
              <span class="label">All Projects</span>
            </a>
            <a href="{{ url_for('project_templates') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['project_templates','project_template_detail'] else '' }}">
              <span class="label">Project Templates</span>
            </a>
          </div>
        </div>

        {% set qc_endpoints = [
          'qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign',
          'qc_recent_submissions','forms_list','forms_edit','form_render','submission_view','forms_new','forms_fill'
        ] %}
        {% set qc_parent_active = request.endpoint in qc_endpoints %}
        <div class="space-y-1">
          <div class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if qc_parent_active else '' }}">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V6l-6-4z"/>
              </svg>
            </span>
            <span class="label text-[15px] flex-1">QC</span>
          </div>
          <div class="pl-12 space-y-1">
            <a href="{{ url_for('qc_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign'] else '' }}">
              <span class="label">Tasks</span>
            </a>
            <a href="{{ url_for('forms_list') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['forms_list','forms_edit','forms_new','forms_fill'] else '' }}">
              <span class="label">Form Templates</span>
            </a>
            <a href="{{ url_for('qc_recent_submissions') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['submission_view','qc_recent_submissions'] else '' }}">
              <span class="label">Recent Submissions</span>
            </a>
          </div>
        </div>
      </nav>

      <div class="px-3 pb-4 space-y-2 border-t border-slate-800/60 pt-4">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('settings') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide {{ 'active' if request.endpoint in ['settings','admin_users'] else '' }}">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 00.12-.64l-1.92-3.32a.5.5 0 00-.6-.22l-2.39.96a7.042 7.042 0 00-1.63-.94l-.36-2.54A.5.5 0 0014.4 2h-3.8a.5.5 0 00-.5.42l-.36 2.54c-.59.23-1.14.54-1.63.94l-2.39-.96a.5.5 0 00-.6.22L3.3 8.48a.5.5 0 00.12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 00-.12.64l1.92 3.32c.14.24.44.34.7.22l2.39-.96c.49.4 1.04.72 1.63.94l.36 2.54c.04.26.25.42.5.42h3.8c.25 0 .46-.16.5-.42l.36-2.54c.59-.23 1.14-.54 1.63-.94l2.39.96c.26.12.56.02.7-.22l1.92-3.32a.5.5 0 00-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1112 8a3.5 3.5 0 010 7.5z"/>
              </svg>
            </span>
            <span class="label">Settings</span>
          </a>
          <a href="{{ url_for('logout') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
              </svg>
            </span>
            <span class="label">Logout</span>
          </a>
        {% else %}
          <a href="{{ url_for('login') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 17v-3H3v-4h7V7l5 5-5 5zm9-14h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
              </svg>
            </span>
            <span class="label">Login</span>
          </a>
        {% endif %}
      </div>
    </aside>

    <!-- Main content -->
    <main class="min-h-[calc(100vh-56px)]">
      <section class="p-5">
        <!-- Dynamic Section Heading (aligned left) -->
        {% set endpoint = request.endpoint or '' %}
        {% if endpoint == 'dashboard' %}
          {% set section_title = 'Dashboard' %}
        {% elif endpoint in ['projects_pending','projects_list','project_detail','project_templates','project_template_detail'] %}
          {% set section_title = 'Projects' %}
        {% elif endpoint in ['forms_list','forms_edit','submission_view'] %}
          {% set section_title = 'QC' %}
        {% elif endpoint in ['forms_new','form_new','forms_create','form_render'] %}
          {% set section_title = 'QC - New form' %}
        {% elif endpoint in ['sales_home','sales_clients','sales_client_detail','sales_opportunities_pipeline','sales_opportunity_detail'] %}
          {% set section_title = 'Sales' %}
        {% elif endpoint in ['settings'] %}
          {% set section_title = 'Settings' %}
        {% elif endpoint in ['admin_users'] %}
          {% set section_title = 'Admin' %}
        {% else %}
          {% set section_title = 'Eleva ERP' %}
        {% endif %}

        {% block section_header %}
        <h1 class="text-2xl font-semibold mb-4 tracking-tight">{{ section_title }}</h1>
        {% endblock %}

        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <script>
    (function () {
      const applyTheme = (theme) => {
        if (!theme) {
          return;
        }
        document.documentElement.setAttribute('data-theme', theme);
        try {
          localStorage.setItem('eleva:theme', theme);
        } catch (error) {
          // Ignore storage issues (private mode, etc.).
        }
      };

      window.elevaTheme = {
        setTheme: applyTheme,
        getTheme: () => document.documentElement.getAttribute('data-theme') || 'warm-modern',
      };

      document.addEventListener('eleva:apply-theme', (event) => {
        if (event && event.detail && event.detail.theme) {
          applyTheme(event.detail.theme);
        }
      });
    })();
  </script>

  <script>
    (function () {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('collapseBtn');
      const icon = document.getElementById('collapseIcon');
      const header = document.querySelector('header');

      function syncOffsets() {
        const h = header.getBoundingClientRect().height;
        sidebar.style.top = h + 'px';
        sidebar.style.height = `calc(100vh - ${h}px)`;
        const menu = sidebar.querySelector('.sidebar-menu');
        if (menu) menu.style.removeProperty('height');
      }
      window.addEventListener('resize', syncOffsets);
      window.addEventListener('load', syncOffsets);
      setTimeout(syncOffsets, 0);

      const saved = localStorage.getItem('eleva.sidebar');
      const setState = (collapsed) => {
        sidebar.classList.toggle('collapsed', collapsed);
        sidebar.classList.toggle('sidebar-collapsed', collapsed);
        sidebar.classList.toggle('sidebar-expanded', !collapsed);
        icon.style.transform = collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      };
      setState(saved === 'collapsed');

      btn.addEventListener('click', function () {
        const collapsed = !sidebar.classList.contains('collapsed');
        setState(collapsed);
        localStorage.setItem('eleva.sidebar', collapsed ? 'collapsed' : 'expanded');
      });
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const toggles = document.querySelectorAll('[data-form-toggle]');
      toggles.forEach((button) => {
        const targetId = button.getAttribute('data-target');
        const content = targetId ? document.getElementById(targetId) : null;
        if (!content) {
          return;
        }

        const labelEl = button.querySelector('[data-toggle-label]');
        const iconEl = button.querySelector('[data-toggle-icon]');
        const openLabel = button.dataset.openLabel || 'Open form';
        const closeLabel = button.dataset.closeLabel || 'Hide form';
        const initialOpen = button.dataset.initialState === 'open';

        const setState = (open) => {
          if (open) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
          button.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (labelEl) {
            labelEl.textContent = open ? closeLabel : openLabel;
          } else {
            button.textContent = open ? closeLabel : openLabel;
          }
          if (iconEl) {
            iconEl.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
          }
        };

        setState(initialOpen);

        button.addEventListener('click', () => {
          const isOpen = content.classList.contains('hidden');
          setState(isOpen);
          if (isOpen) {
            const focusable = content.querySelector('input, select, textarea, button');
            if (focusable) {
              focusable.focus({ preventScroll: false });
            }
          }
        });
      });
    });
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
