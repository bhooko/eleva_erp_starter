{% macro csrf_field() -%}
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{%- endmacro %}

<!DOCTYPE html>
<html lang="en" data-theme="warm-modern">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Eleva ERP{% endblock %}</title>

  <script>
    (function () {
      try {
        const saved = localStorage.getItem('eleva:theme');
        const theme = saved || 'warm-modern';
        document.documentElement.setAttribute('data-theme', theme);
      } catch (error) {
        document.documentElement.setAttribute('data-theme', 'warm-modern');
      }
    })();
  </script>

  <script>
    (function () {
      const THEME_ORDER = ['warm-modern', 'metallic-elevate', 'eleva-signature', 'india'];
      const THEME_KEY = 'eleva:theme';
      const AUTOCYCLE_KEY = 'eleva:theme_autocycle';
      const RESTORE_THEME_KEY = 'eleva:theme_autocycle_restore_theme';
      const DEFAULT_THEME = 'warm-modern';
      const INTERVAL_MS = 3000;

      const applyTheme = (themeName) => {
        const targetTheme = THEME_ORDER.includes(themeName) ? themeName : DEFAULT_THEME;
        document.documentElement.setAttribute('data-theme', targetTheme);
        localStorage.setItem(THEME_KEY, targetTheme);
      };

      const getCurrentTheme = () => {
        const savedTheme = localStorage.getItem(THEME_KEY);
        const activeTheme = savedTheme || document.documentElement.getAttribute('data-theme') || DEFAULT_THEME;
        return THEME_ORDER.includes(activeTheme) ? activeTheme : DEFAULT_THEME;
      };

      const getNextTheme = () => {
        const currentTheme = getCurrentTheme();
        const currentIndex = THEME_ORDER.indexOf(currentTheme);
        const nextIndex = currentIndex >= 0 ? (currentIndex + 1) % THEME_ORDER.length : 0;
        return THEME_ORDER[nextIndex];
      };

      const stopCycle = () => {
        if (window.__elevaThemeCycleTimer) {
          clearInterval(window.__elevaThemeCycleTimer);
          window.__elevaThemeCycleTimer = null;
        }
      };

      const setToggleUiState = (enabled) => {
        const toggle = document.getElementById('autoThemeToggle');
        if (!toggle) {
          return;
        }

        const knob = document.getElementById('autoThemeToggleKnob');
        toggle.setAttribute('aria-checked', enabled ? 'true' : 'false');
        toggle.classList.toggle('bg-emerald-500/90', enabled);
        toggle.classList.toggle('border-emerald-300/80', enabled);
        toggle.classList.toggle('bg-slate-700/70', !enabled);
        toggle.classList.toggle('border-slate-600/80', !enabled);

        if (knob) {
          knob.classList.toggle('translate-x-5', enabled);
          knob.classList.toggle('translate-x-0.5', !enabled);
        }
      };

      const startCycle = () => {
        stopCycle();
        window.__elevaThemeCycleTimer = setInterval(() => {
          const nextTheme = getNextTheme();
          applyTheme(nextTheme);
        }, INTERVAL_MS);
      };

      const setAutoCycleEnabled = (enabled) => {
        const isEnabled = localStorage.getItem(AUTOCYCLE_KEY) === '1';

        if (enabled) {
          if (!isEnabled) {
            localStorage.setItem(RESTORE_THEME_KEY, getCurrentTheme());
          }
          localStorage.setItem(AUTOCYCLE_KEY, '1');
          startCycle();
        } else {
          localStorage.setItem(AUTOCYCLE_KEY, '0');
          stopCycle();
          const restoreTheme = localStorage.getItem(RESTORE_THEME_KEY) || DEFAULT_THEME;
          applyTheme(restoreTheme);
        }

        setToggleUiState(enabled);
      };

      window.__elevaSetThemeAutoCycle = setAutoCycleEnabled;

      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('autoThemeToggle');
        const autoCycleEnabled = localStorage.getItem(AUTOCYCLE_KEY) === '1';
        setToggleUiState(autoCycleEnabled);

        if (autoCycleEnabled) {
          startCycle();
        }

        if (toggle) {
          toggle.addEventListener('click', () => {
            const currentlyEnabled = localStorage.getItem(AUTOCYCLE_KEY) === '1';
            setAutoCycleEnabled(!currentlyEnabled);
          });
        }
      });
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      color-scheme: light;
      --color-base: #F3F4F6;
      --color-base-rgb: 243, 244, 246;
      --color-card: #FFFFFF;
      --color-card-rgb: 255, 255, 255;
      --color-primary: #FB923C;
      --color-primary-rgb: 251, 146, 60;
      --color-secondary: #FACC15;
      --color-secondary-rgb: 250, 204, 21;
      --color-neutral: #6B7280;
      --color-neutral-rgb: 107, 114, 128;
      --color-surface-2: #E5E7EB;
      --color-surface-2-rgb: 229, 231, 235;
      --text-primary: #111827;
      --text-secondary: #4B5563;
      --text-muted-contrast: #64748B;
      --text-muted-soft: #94A3B8;
      --text-muted: #64748B;
      --text-dim: #94A3B8;
      --accent-success: #22C55E;
      --accent-success-rgb: 34, 197, 94;
      --accent-warning: #FBBF24;
      --accent-warning-rgb: 251, 191, 36;
      --accent-error: #F87171;
      --accent-error-rgb: 248, 113, 113;
      --border-subtle: #E5E7EB;
      --stage-cold: #2563EB;
      --stage-cold-rgb: 37, 99, 235;
      --stage-warm: #FB923C;
      --stage-warm-rgb: 251, 146, 60;
      --stage-success: #22C55E;
      --stage-success-rgb: 34, 197, 94;
      --stage-glow: rgba(59, 130, 246, 0.45);
      --header-height: 56px;
      --bg-app: var(--color-base);
      --bg-app-rgb: var(--color-base-rgb);
      --bg-surface: var(--color-card);
      --bg-surface-rgb: var(--color-card-rgb);
      --bg-surface-2: var(--color-surface-2);
      --bg-surface-2-rgb: var(--color-surface-2-rgb);
      --text-main: var(--text-primary);
      --text-muted: var(--text-secondary);
      --accent-blue: var(--color-primary);
      --accent-blue-rgb: var(--color-primary-rgb);
      --btn-primary-text: #111827;
    }

    html[data-theme="eleva-signature"],
    [data-theme-preview="eleva-signature"] {
      color-scheme: dark;
      --color-base: #0A1018;
      --color-base-rgb: 10, 16, 24;
      --color-card: #1A2533;
      --color-card-rgb: 26, 37, 51;
      --color-primary: #60A5FA;
      --color-primary-rgb: 96, 165, 250;
      --color-secondary: #22D3EE;
      --color-secondary-rgb: 34, 211, 238;
      --color-neutral: #202835;
      --color-neutral-rgb: 32, 40, 53;
      --color-surface-2: #243243;
      --color-surface-2-rgb: 36, 50, 67;
      --text-primary: #F3F7FC;
      --text-secondary: #D2DDEA;
      --text-muted-contrast: #CBD5E1;
      --text-muted-soft: #E2E8F0;
      --text-muted: #B8C6D8;
      --text-dim: #94A6BB;
      --accent-success: #34D399;
      --accent-success-rgb: 52, 211, 153;
      --accent-warning: #F59E0B;
      --accent-warning-rgb: 245, 158, 11;
      --accent-error: #F87171;
      --accent-error-rgb: 248, 113, 113;
      --border-subtle: #44566B;
      --stage-cold: #39C0ED;
      --stage-cold-rgb: 57, 192, 237;
      --stage-warm: #007AFF;
      --stage-warm-rgb: 0, 122, 255;
      --stage-success: #00C58E;
      --stage-success-rgb: 0, 197, 142;
      --stage-glow: rgba(0, 122, 255, 0.45);
      --btn-primary-text: #F8FAFC;
    }

    html[data-theme="metallic-elevate"],
    [data-theme-preview="metallic-elevate"] {
      color-scheme: light;
      --color-base: #EFF4FF;
      --color-base-rgb: 239, 244, 255;
      --color-card: rgba(255, 255, 255, 0.9);
      --color-card-rgb: 255, 255, 255;
      --color-primary: #7C3AED;
      --color-primary-rgb: 124, 58, 237;
      --color-secondary: #6D28D9;
      --color-secondary-rgb: 109, 40, 217;
      --color-neutral: #D7E1F2;
      --color-neutral-rgb: 215, 225, 242;
      --color-surface-2: #E2EAF8;
      --color-surface-2-rgb: 226, 234, 248;
      --text-primary: #0B1220;
      --text-secondary: #1F2937;
      --text-muted-contrast: #334155;
      --text-muted-soft: #3F4F66;
      --text-muted: #334155;
      --text-dim: #475569;
      --accent-success: #16A34A;
      --accent-success-rgb: 22, 163, 74;
      --accent-warning: #D97706;
      --accent-warning-rgb: 217, 119, 6;
      --accent-error: #DC2626;
      --accent-error-rgb: 220, 38, 38;
      --border-subtle: rgba(148, 163, 184, 0.55);
      --stage-cold: #0284C7;
      --stage-cold-rgb: 2, 132, 199;
      --stage-warm: #7C3AED;
      --stage-warm-rgb: 124, 58, 237;
      --stage-success: #16A34A;
      --stage-success-rgb: 22, 163, 74;
      --stage-glow: rgba(124, 58, 237, 0.35);
      --btn-primary-text: #F8FAFC;
    }

    html[data-theme="metallic-elevate"] body {
      background:
        radial-gradient(42rem 34rem at 8% -10%, rgba(56, 189, 248, 0.24), transparent 62%),
        radial-gradient(36rem 32rem at 92% 8%, rgba(167, 139, 250, 0.25), transparent 58%),
        radial-gradient(34rem 28rem at 18% 90%, rgba(196, 181, 253, 0.22), transparent 62%),
        linear-gradient(145deg, #f7f9ff 0%, #edf4ff 46%, #e9f2ff 100%);
      background-attachment: fixed;
    }

    html[data-theme="metallic-elevate"] .bg-white,
    html[data-theme="metallic-elevate"] .bg-slate-50,
    html[data-theme="metallic-elevate"] .bg-slate-100,
    html[data-theme="metallic-elevate"] .bg-slate-900,
    html[data-theme="metallic-elevate"] .bg-slate-900\/40,
    html[data-theme="metallic-elevate"] .bg-slate-900\/50,
    html[data-theme="metallic-elevate"] .bg-slate-900\/60,
    html[data-theme="metallic-elevate"] .bg-slate-900\/70,
    html[data-theme="metallic-elevate"] .bg-slate-900\/80,
    html[data-theme="metallic-elevate"] .bg-slate-900\/90,
    html[data-theme="metallic-elevate"] .bg-slate-900\/95 {
      background-color: rgba(255, 255, 255, 0.88) !important;
      backdrop-filter: blur(14px) saturate(130%);
      -webkit-backdrop-filter: blur(14px) saturate(130%);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      border-color: rgba(148, 163, 184, 0.58) !important;
    }

    html[data-theme="metallic-elevate"] .bg-slate-800,
    html[data-theme="metallic-elevate"] .bg-slate-800\/60,
    html[data-theme="metallic-elevate"] .bg-slate-800\/70,
    html[data-theme="metallic-elevate"] .bg-slate-800\/80,
    html[data-theme="metallic-elevate"] .bg-slate-800\/90 {
      background-color: rgba(226, 234, 248, 0.92) !important;
      border-color: rgba(148, 163, 184, 0.6) !important;
    }

    html[data-theme="metallic-elevate"] .text-emerald-300\/80,
    html[data-theme="metallic-elevate"] .text-emerald-100\/80 {
      color: #1f2937 !important;
    }

    html[data-theme="metallic-elevate"] .fixed.inset-0 .bg-slate-900,
    html[data-theme="metallic-elevate"] [role="dialog"].bg-slate-900,
    html[data-theme="metallic-elevate"] [role="dialog"].bg-white {
      backdrop-filter: blur(20px) saturate(140%);
      -webkit-backdrop-filter: blur(20px) saturate(140%);
    }

    html[data-theme="warm-modern"],
    [data-theme-preview="warm-modern"] {
      color-scheme: light;
      --color-base: #F4F6FA;
      --color-base-rgb: 244, 246, 250;
      --color-card: #FFFFFF;
      --color-card-rgb: 255, 255, 255;
      --color-primary: #1565C0;
      --color-primary-rgb: 21, 101, 192;
      --color-secondary: #6D4C41;
      --color-secondary-rgb: 109, 76, 65;
      --color-neutral: #64748B;
      --color-neutral-rgb: 100, 116, 139;
      --color-surface-2: #EEF2F7;
      --color-surface-2-rgb: 238, 242, 247;
      --text-primary: #0F172A;
      --text-secondary: #1E293B;
      --text-muted-contrast: #334155;
      --text-muted-soft: #475569;
      --text-muted: #334155;
      --text-dim: #64748B;
      --accent-success: #2E7D32;
      --accent-success-rgb: 46, 125, 50;
      --accent-warning: #B45309;
      --accent-warning-rgb: 180, 83, 9;
      --accent-error: #B3261E;
      --accent-error-rgb: 179, 38, 30;
      --border-subtle: #CBD5E1;
      --stage-cold: #1565C0;
      --stage-cold-rgb: 21, 101, 192;
      --stage-warm: #7C3E10;
      --stage-warm-rgb: 124, 62, 16;
      --stage-success: #2E7D32;
      --stage-success-rgb: 46, 125, 50;
      --stage-glow: rgba(21, 101, 192, 0.34);
      --btn-primary-text: #F8FAFC;
    }

    html[data-theme="warm-modern"] body {
      background:
        radial-gradient(34rem 26rem at 10% -10%, rgba(21, 101, 192, 0.08), transparent 62%),
        radial-gradient(36rem 28rem at 90% 8%, rgba(109, 76, 65, 0.08), transparent 60%),
        linear-gradient(180deg, #f7f9fc 0%, #f4f6fa 100%);
      background-attachment: fixed;
    }

    html[data-theme="warm-modern"] .bg-white,
    html[data-theme="warm-modern"] .bg-slate-50,
    html[data-theme="warm-modern"] .bg-slate-100,
    html[data-theme="warm-modern"] .bg-slate-900,
    html[data-theme="warm-modern"] .bg-slate-900\/40,
    html[data-theme="warm-modern"] .bg-slate-900\/50,
    html[data-theme="warm-modern"] .bg-slate-900\/60,
    html[data-theme="warm-modern"] .bg-slate-900\/70,
    html[data-theme="warm-modern"] .bg-slate-900\/80,
    html[data-theme="warm-modern"] .bg-slate-900\/90,
    html[data-theme="warm-modern"] .bg-slate-900\/95 {
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08), 0 8px 20px rgba(15, 23, 42, 0.06);
      border-color: rgba(148, 163, 184, 0.55) !important;
    }

    html[data-theme="warm-modern"] .table-wrapper {
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12), 0 10px 24px rgba(15, 23, 42, 0.08);
    }

    html[data-theme="warm-modern"] .table-wrapper thead th,
    html[data-theme="warm-modern"] .table-sticky thead th,
    html[data-theme="warm-modern"] .table-enhanced thead th {
      background: #F1F5F9;
      color: #0F172A;
      box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.75);
    }

    html[data-theme="warm-modern"] .table-wrapper th,
    html[data-theme="warm-modern"] .table-wrapper td,
    html[data-theme="warm-modern"] .table-sticky th,
    html[data-theme="warm-modern"] .table-sticky td,
    html[data-theme="warm-modern"] .table-enhanced tbody tr {
      border-bottom-color: rgba(148, 163, 184, 0.55);
      color: #0F172A;
    }

    html[data-theme="warm-modern"] .table-wrapper tbody tr:hover,
    html[data-theme="warm-modern"] .table-sticky tbody tr:hover,
    html[data-theme="warm-modern"] .table-enhanced tbody tr:hover {
      background-color: rgba(21, 101, 192, 0.09);
    }

    html[data-theme="warm-modern"] .collapsible-card {
      border-color: rgba(148, 163, 184, 0.55);
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12), 0 12px 26px rgba(15, 23, 42, 0.1);
    }

    html[data-theme="warm-modern"] .btn-primary {
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.2), 0 4px 10px rgba(21, 101, 192, 0.24);
    }

    html[data-theme="warm-modern"] .btn-primary:hover {
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.2), 0 8px 16px rgba(21, 101, 192, 0.3);
    }

    html[data-theme="warm-modern"] .btn-secondary {
      background: #FFFFFF;
      border-color: rgba(148, 163, 184, 0.68);
      color: #0F172A;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    html[data-theme="warm-modern"] .btn-secondary:hover {
      background: #F8FAFC;
      border-color: rgba(100, 116, 139, 0.75);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
    }

    html[data-theme="india"],
    [data-theme-preview="india"] {
      color-scheme: light;
      --color-base: #FFF8ED;
      --color-base-rgb: 255, 248, 237;
      --color-card: #FFFFFF;
      --color-card-rgb: 255, 255, 255;
      --color-primary: #FF9933;
      --color-primary-rgb: 255, 153, 51;
      --color-secondary: #138808;
      --color-secondary-rgb: 19, 136, 8;
      --color-neutral: #C7D2FE;
      --color-neutral-rgb: 199, 210, 254;
      --color-surface-2: #F3EDE2;
      --color-surface-2-rgb: 243, 237, 226;
      --text-primary: #0B3D91;
      --text-secondary: #334155;
      --text-muted-contrast: #64748B;
      --text-muted-soft: #94A3B8;
      --text-muted: #64748B;
      --text-dim: #94A3B8;
      --accent-success: #2BA84A;
      --accent-success-rgb: 43, 168, 74;
      --accent-warning: #F97316;
      --accent-warning-rgb: 249, 115, 22;
      --accent-error: #E11D48;
      --accent-error-rgb: 225, 29, 72;
      --border-subtle: #E2E8F0;
      --stage-cold: #0B3D91;
      --stage-cold-rgb: 11, 61, 145;
      --stage-warm: #FF9933;
      --stage-warm-rgb: 255, 153, 51;
      --stage-success: #138808;
      --stage-success-rgb: 19, 136, 8;
      --stage-glow: rgba(11, 61, 145, 0.28);
      --btn-primary-text: #111827;
    }

    html, body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background-color: var(--color-base);
      color: var(--text-primary);
      transition: background-color 220ms ease, color 220ms ease;
      overflow: hidden;
    }
    a { color: var(--color-secondary); transition: color 180ms ease; }
    a:hover { color: var(--color-primary); }
    .animate-slide { transition: all 220ms cubic-bezier(.2,.8,.2,1); }
    .text-muted-contrast { color: var(--text-muted-contrast); }
    .text-muted-soft { color: var(--text-muted-soft); }
    .design-task-card {
      background-color: var(--bg-surface);
      border-color: var(--border-subtle);
      color: var(--text-main);
    }
    .design-task-title { color: var(--text-main); }
    .design-task-type {
      background-color: rgba(148, 163, 184, 0.16);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted-contrast);
    }
    .design-task-pill {
      background-color: rgba(var(--color-neutral-rgb), 0.28);
      border: 1px solid rgba(var(--color-neutral-rgb), 0.45);
      color: var(--text-muted-contrast);
    }
    .design-task-status-select {
      background-color: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
    }
    .design-task-status-select:focus-visible {
      outline: 2px solid rgba(var(--stage-warm-rgb), 0.45);
      outline-offset: 2px;
    }

    #app {
      --sidebar-expanded-width: 280px;
      --sidebar-collapsed-width: 78px;
      --sidebar-width: var(--sidebar-expanded-width);
      display: grid;
      grid-template-columns: var(--sidebar-width) minmax(0, 1fr);
      transition: grid-template-columns 260ms cubic-bezier(.2,.8,.2,1);
      height: calc(100vh - var(--header-height));
    }

    #app.sidebar-is-collapsed {
      --sidebar-width: var(--sidebar-collapsed-width);
    }

    .sidebar {
      width: var(--sidebar-width);
      transition: width 260ms cubic-bezier(.2,.8,.2,1),
                  padding 220ms cubic-bezier(.2,.8,.2,1),
                  box-shadow 220ms ease;
      transform: translateX(0);
    }
    .sidebar.collapsed { width: var(--sidebar-collapsed-width); }
    .sidebar.sidebar-animate-expand {
      animation: sidebarExpand 260ms cubic-bezier(.2,.8,.2,1);
    }
    .sidebar.sidebar-animate-collapse {
      animation: sidebarCollapse 260ms cubic-bezier(.2,.8,.2,1);
    }

    .sidebar-collapsed .label { opacity: 0; transform: translateX(-8px); pointer-events: none; }
    .sidebar-expanded .label { opacity: 1; transform: translateX(0); }

    .nav-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      transition: background-color 160ms ease, outline-color 160ms ease, transform 200ms ease;
      isolation: isolate;
    }
    .nav-item::before {
      content: "";
      position: absolute;
      inset: 6px auto 6px 0;
      width: 4px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(var(--color-primary-rgb), 0.9), rgba(var(--color-secondary-rgb), 0.65));
      transform: scaleY(0);
      transform-origin: top;
      transition: transform 260ms cubic-bezier(.2,.8,.2,1), opacity 260ms ease;
      opacity: 0;
      box-shadow: 0 0 14px rgba(var(--color-primary-rgb), 0.5);
      pointer-events: none;
      z-index: 2;
    }
    .nav-item::after {
      content: "";
      position: absolute;
      inset: -120% -40%;
      background: radial-gradient(circle at center, rgba(var(--color-primary-rgb), 0.35) 0%, transparent 65%);
      opacity: 0;
      transform: scale(0.6);
      transition: opacity 260ms ease, transform 320ms cubic-bezier(.2,.8,.2,1);
      pointer-events: none;
    }
    .nav-item:hover,
    .nav-item:focus-visible {
      background: rgba(var(--color-neutral-rgb), 0.6);
      transform: translateY(-1px);
    }
    .nav-item:hover::after,
    .nav-item:focus-visible::after {
      opacity: 1;
      transform: scale(1.1);
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(var(--color-primary-rgb), 0.3), rgba(var(--color-secondary-rgb), 0.18));
      outline: 1px solid rgba(var(--color-primary-rgb), 0.5);
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px rgba(var(--color-primary-rgb), 0.25), 0 0 24px rgba(var(--color-primary-rgb), 0.2);
    }
    .nav-item.active::before {
      opacity: 1;
      transform: scaleY(1);
    }
    .nav-item > span:first-child,
    .nav-item .nav-icon {
      transition: transform 220ms cubic-bezier(.2,.8,.2,1);
    }
    .nav-item:hover > span:first-child,
    .nav-item:focus-visible > span:first-child,
    .nav-item:hover .nav-icon,
    .nav-item:focus-visible .nav-icon {
      transform: translateY(-2px);
    }

    .clickable-text {
      color: #e5e7eb;
      cursor: pointer;
    }
    .clickable-text:hover {
      color: #ffffff;
      text-decoration: underline;
    }

    .bg-app { background-color: var(--bg-app) !important; }
    .bg-surface { background-color: var(--bg-surface) !important; }
    .bg-surface-2 { background-color: var(--bg-surface-2) !important; }

    /* Core backgrounds */
    .bg-slate-950 { background-color: var(--color-base) !important; }
    .bg-slate-950\/30 { background-color: rgba(var(--color-base-rgb), 0.3) !important; }
    .bg-slate-950\/40 { background-color: rgba(var(--color-base-rgb), 0.4) !important; }
    .bg-slate-950\/50 { background-color: rgba(var(--color-base-rgb), 0.5) !important; }
    .bg-slate-950\/60 { background-color: rgba(var(--color-base-rgb), 0.6) !important; }
    .bg-slate-950\/70 { background-color: rgba(var(--color-base-rgb), 0.7) !important; }
    .bg-slate-950\/80 { background-color: rgba(var(--color-base-rgb), 0.8) !important; }
    .bg-slate-950\/95 { background-color: rgba(var(--color-base-rgb), 0.95) !important; }
    .supports-\[backdrop-filter\]\:bg-slate-950\/40 { background-color: rgba(var(--color-base-rgb), 0.4) !important; }

    .bg-white { background-color: var(--color-card) !important; }
    .bg-slate-50 { background-color: var(--color-card) !important; }
    .bg-slate-100 { background-color: rgba(var(--color-card-rgb), 0.96) !important; }

    .bg-slate-900 { background-color: var(--color-card) !important; }
    .bg-slate-900\/40 { background-color: rgba(var(--color-card-rgb), 0.4) !important; }
    .bg-slate-900\/50 { background-color: rgba(var(--color-card-rgb), 0.5) !important; }
    .bg-slate-900\/60 { background-color: rgba(var(--color-card-rgb), 0.6) !important; }
    .bg-slate-900\/70 { background-color: rgba(var(--color-card-rgb), 0.7) !important; }
    .bg-slate-900\/80 { background-color: rgba(var(--color-card-rgb), 0.8) !important; }
    .bg-slate-900\/90 { background-color: rgba(var(--color-card-rgb), 0.9) !important; }
    .bg-slate-900\/95 { background-color: rgba(var(--color-card-rgb), 0.95) !important; }
    .supports-\[backdrop-filter\]\:bg-slate-900\/50 { background-color: rgba(var(--color-card-rgb), 0.5) !important; }

    .bg-slate-800 { background-color: var(--color-neutral) !important; }
    .bg-slate-800\/40 { background-color: rgba(var(--color-neutral-rgb), 0.4) !important; }
    .bg-slate-800\/50 { background-color: rgba(var(--color-neutral-rgb), 0.5) !important; }
    .bg-slate-800\/60 { background-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .bg-slate-800\/70 { background-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .bg-slate-800\/80 { background-color: rgba(var(--color-neutral-rgb), 0.8) !important; }

    .bg-slate-700 { background-color: rgba(var(--color-neutral-rgb), 0.85) !important; }
    .bg-slate-700\/60 { background-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .bg-slate-700\/70 { background-color: rgba(var(--color-neutral-rgb), 0.7) !important; }

    /* Theme-aware utility backgrounds */
    .bg-slate-50,
    .bg-gray-50,
    .bg-zinc-50,
    .bg-neutral-50,
    .bg-slate-100,
    .bg-gray-100,
    .bg-zinc-100,
    .bg-neutral-100,
    .bg-slate-200,
    .bg-gray-200,
    .bg-zinc-200,
    .bg-neutral-200 {
      background-color: var(--color-card) !important;
    }
    .bg-slate-300,
    .bg-gray-300,
    .bg-zinc-300,
    .bg-neutral-300,
    .bg-slate-400,
    .bg-gray-400,
    .bg-zinc-400,
    .bg-neutral-400 {
      background-color: var(--color-surface-2) !important;
    }
    .bg-slate-500,
    .bg-gray-500,
    .bg-zinc-500,
    .bg-neutral-500,
    .bg-slate-600,
    .bg-gray-600,
    .bg-zinc-600,
    .bg-neutral-600,
    .bg-slate-700,
    .bg-gray-700,
    .bg-zinc-700,
    .bg-neutral-700 {
      background-color: var(--color-neutral) !important;
    }
    .bg-slate-800,
    .bg-gray-800,
    .bg-zinc-800,
    .bg-neutral-800,
    .bg-slate-900,
    .bg-gray-900,
    .bg-zinc-900,
    .bg-neutral-900 {
      background-color: var(--color-base) !important;
    }

    /* Borders and outlines */
    .border-subtle { border-color: var(--border-subtle) !important; }
    .border-slate-800 { border-color: var(--color-neutral) !important; }
    .border-slate-800\/60 { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .border-slate-800\/80 { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }
    .border-slate-700 { border-color: var(--color-neutral) !important; }
    .border-slate-700\/40 { border-color: rgba(var(--color-neutral-rgb), 0.4) !important; }
    .border-slate-700\/60 { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .border-slate-700\/70 { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .border-slate-700\/80 { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }
    .border-slate-200 { border-color: var(--border-subtle) !important; }
    .border-slate-600 { border-color: rgba(var(--color-neutral-rgb), 0.9) !important; }
    .border-slate-500 { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }

    .divide-slate-800 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.7) !important; }
    .divide-slate-800\/60 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }
    .divide-slate-800\/80 > :not([hidden]) ~ :not([hidden]) { border-color: rgba(var(--color-neutral-rgb), 0.8) !important; }

    .border-slate-50,
    .border-gray-50,
    .border-zinc-50,
    .border-neutral-50,
    .border-slate-100,
    .border-gray-100,
    .border-zinc-100,
    .border-neutral-100,
    .border-slate-200,
    .border-gray-200,
    .border-zinc-200,
    .border-neutral-200 {
      border-color: var(--border-subtle) !important;
    }
    .border-slate-300,
    .border-gray-300,
    .border-zinc-300,
    .border-neutral-300,
    .border-slate-400,
    .border-gray-400,
    .border-zinc-400,
    .border-neutral-400,
    .border-slate-500,
    .border-gray-500,
    .border-zinc-500,
    .border-neutral-500 {
      border-color: rgba(var(--color-neutral-rgb), 0.6) !important;
    }
    .border-slate-600,
    .border-gray-600,
    .border-zinc-600,
    .border-neutral-600,
    .border-slate-700,
    .border-gray-700,
    .border-zinc-700,
    .border-neutral-700,
    .border-slate-800,
    .border-gray-800,
    .border-zinc-800,
    .border-neutral-800,
    .border-slate-900,
    .border-gray-900,
    .border-zinc-900,
    .border-neutral-900 {
      border-color: rgba(var(--color-neutral-rgb), 0.85) !important;
    }

    /* Typography */
    .text-slate-50,
    .text-slate-100,
    .text-slate-200 { color: var(--text-primary) !important; }
    .text-slate-300,
    .text-slate-400,
    .text-slate-500 { color: var(--text-secondary) !important; }
    .text-slate-600,
    .text-slate-700 { color: var(--text-secondary) !important; }

    .text-slate-50,
    .text-gray-50,
    .text-zinc-50,
    .text-neutral-50,
    .text-slate-100,
    .text-gray-100,
    .text-zinc-100,
    .text-neutral-100,
    .text-slate-200,
    .text-gray-200,
    .text-zinc-200,
    .text-neutral-200,
    .text-slate-700,
    .text-gray-700,
    .text-zinc-700,
    .text-neutral-700,
    .text-slate-800,
    .text-gray-800,
    .text-zinc-800,
    .text-neutral-800,
    .text-slate-900,
    .text-gray-900,
    .text-zinc-900,
    .text-neutral-900 {
      color: var(--text-primary) !important;
    }
    .text-slate-300,
    .text-gray-300,
    .text-zinc-300,
    .text-neutral-300 {
      color: var(--text-dim) !important;
    }
    .text-slate-400,
    .text-gray-400,
    .text-zinc-400,
    .text-neutral-400 {
      color: var(--text-muted) !important;
    }
    .text-slate-500,
    .text-gray-500,
    .text-zinc-500,
    .text-neutral-500,
    .text-slate-600,
    .text-gray-600,
    .text-zinc-600,
    .text-neutral-600 {
      color: var(--text-secondary) !important;
    }

    .text-main { color: var(--text-main) !important; }
    .text-muted { color: var(--text-muted) !important; }

    .text-theme-primary { color: var(--text-primary) !important; }
    .text-theme-secondary { color: var(--text-secondary) !important; }

    /* Accent remapping */
    .bg-emerald-600,
    .bg-emerald-500 { background-color: var(--color-primary) !important; }
    .bg-emerald-500\/10 { background-color: rgba(var(--color-primary-rgb), 0.1) !important; }
    .bg-emerald-500\/20 { background-color: rgba(var(--color-primary-rgb), 0.2) !important; }
    .bg-emerald-500\/30 { background-color: rgba(var(--color-primary-rgb), 0.3) !important; }
    .bg-emerald-500\/60,
    .bg-emerald-400\/60 { background-color: rgba(var(--color-primary-rgb), 0.6) !important; }
    .hover\:bg-emerald-500:hover { background-color: var(--color-secondary) !important; }

    .border-emerald-500,
    .border-emerald-400 { border-color: var(--color-primary) !important; }
    .border-emerald-500\/60,
    .border-emerald-400\/60 { border-color: rgba(var(--color-primary-rgb), 0.6) !important; }
    .border-emerald-500\/40,
    .border-emerald-400\/40 { border-color: rgba(var(--color-primary-rgb), 0.4) !important; }
    .border-emerald-500\/30,
    .border-emerald-400\/30 { border-color: rgba(var(--color-primary-rgb), 0.3) !important; }
    .border-emerald-400\/70 { border-color: rgba(var(--color-primary-rgb), 0.7) !important; }

    .text-emerald-400,
    .text-emerald-300,
    .text-emerald-200,
    .text-emerald-100 { color: var(--color-secondary) !important; }
    .text-emerald-300\/80,
    .text-emerald-100\/80 { color: rgba(var(--color-secondary-rgb), 0.8) !important; }
    .hover\:text-emerald-300:hover,
    .hover\:text-emerald-200:hover,
    .hover\:text-emerald-100:hover { color: var(--color-secondary) !important; }

    .btn-primary {
      background: var(--accent-blue);
      color: var(--btn-primary-text);
      border: 1px solid rgba(var(--accent-blue-rgb), 0.4);
      box-shadow: 0 8px 20px rgba(var(--accent-blue-rgb), 0.2);
      transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms ease;
    }
    .btn-primary:hover {
      background: rgba(var(--accent-blue-rgb), 0.9);
      box-shadow: 0 10px 24px rgba(var(--accent-blue-rgb), 0.3);
      transform: translateY(-1px);
    }
    .btn-primary:active {
      background: rgba(var(--accent-blue-rgb), 0.8);
      transform: translateY(0);
      box-shadow: 0 6px 16px rgba(var(--accent-blue-rgb), 0.2);
    }
    .btn-primary:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(var(--accent-blue-rgb), 0.35);
    }
    .btn-primary:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(var(--bg-surface-2-rgb), 0.45);
      color: var(--text-main);
      border: 1px solid rgba(var(--bg-surface-2-rgb), 0.7);
      transition: background-color 160ms ease, border-color 160ms ease, transform 160ms ease, box-shadow 160ms ease;
    }
    .btn-secondary:hover {
      background: rgba(var(--bg-surface-2-rgb), 0.65);
      border-color: rgba(var(--bg-surface-2-rgb), 0.9);
      box-shadow: 0 8px 18px rgba(var(--bg-surface-2-rgb), 0.25);
      transform: translateY(-1px);
    }
    .btn-secondary:active {
      background: rgba(var(--bg-surface-2-rgb), 0.7);
      transform: translateY(0);
      box-shadow: none;
    }
    .btn-secondary:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(var(--accent-blue-rgb), 0.3);
    }

    /* Metallic Elevate: enforce readable flash/alert banners only for this theme */
    html[data-theme="metallic-elevate"] .flash-messages .flash-message,
    html[data-theme="metallic-elevate"] .alert,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message,
    body[data-theme="metallic-elevate"] .alert,
    body.theme-metallic-elevate .flash-messages .flash-message,
    body.theme-metallic-elevate .alert {
      font-weight: 600;
      text-shadow: none;
      filter: none;
      backdrop-filter: none;
      mix-blend-mode: normal;
      opacity: 1 !important;
    }

    html[data-theme="metallic-elevate"] .flash-messages .flash-message a,
    html[data-theme="metallic-elevate"] .alert a,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message a,
    body[data-theme="metallic-elevate"] .alert a,
    body.theme-metallic-elevate .flash-messages .flash-message a,
    body.theme-metallic-elevate .alert a {
      color: inherit;
      text-decoration-color: currentColor;
    }

    html[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-danger,
    html[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-error,
    html[data-theme="metallic-elevate"] .alert.alert-danger,
    html[data-theme="metallic-elevate"] .alert.alert-error,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-danger,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-error,
    body[data-theme="metallic-elevate"] .alert.alert-danger,
    body[data-theme="metallic-elevate"] .alert.alert-error,
    body.theme-metallic-elevate .flash-messages .flash-message.alert-danger,
    body.theme-metallic-elevate .flash-messages .flash-message.alert-error,
    body.theme-metallic-elevate .alert.alert-danger,
    body.theme-metallic-elevate .alert.alert-error {
      color: #7a0f0f !important;
      background: rgba(220, 53, 69, 0.18) !important;
      border-color: rgba(220, 53, 69, 0.55) !important;
    }

    html[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-warning,
    html[data-theme="metallic-elevate"] .alert.alert-warning,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-warning,
    body[data-theme="metallic-elevate"] .alert.alert-warning,
    body.theme-metallic-elevate .flash-messages .flash-message.alert-warning,
    body.theme-metallic-elevate .alert.alert-warning {
      color: #5a3a00 !important;
      background: rgba(255, 193, 7, 0.2) !important;
      border-color: rgba(255, 193, 7, 0.58) !important;
    }

    html[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-success,
    html[data-theme="metallic-elevate"] .alert.alert-success,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-success,
    body[data-theme="metallic-elevate"] .alert.alert-success,
    body.theme-metallic-elevate .flash-messages .flash-message.alert-success,
    body.theme-metallic-elevate .alert.alert-success {
      color: #0f5132 !important;
      background: rgba(25, 135, 84, 0.2) !important;
      border-color: rgba(25, 135, 84, 0.55) !important;
    }

    html[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-info,
    html[data-theme="metallic-elevate"] .alert.alert-info,
    body[data-theme="metallic-elevate"] .flash-messages .flash-message.alert-info,
    body[data-theme="metallic-elevate"] .alert.alert-info,
    body.theme-metallic-elevate .flash-messages .flash-message.alert-info,
    body.theme-metallic-elevate .alert.alert-info {
      color: #084298 !important;
      background: rgba(13, 110, 253, 0.2) !important;
      border-color: rgba(13, 110, 253, 0.55) !important;
    }

    .focus\:ring-emerald-500\/50:focus,
    .focus\:ring-emerald-500\/40:focus { --tw-ring-color: rgba(var(--color-primary-rgb), 0.5) !important; }
    .focus\:ring-emerald-400\/60:focus { --tw-ring-color: rgba(var(--color-primary-rgb), 0.6) !important; }

    .focus\:border-emerald-400:focus { border-color: var(--color-primary) !important; }
    .accent-emerald-500 { accent-color: var(--color-primary) !important; }
    .ring-emerald-500,
    .ring-emerald-400 { --tw-ring-color: rgba(var(--color-primary-rgb), 0.45) !important; }

    .bg-emerald-400 { background-color: var(--color-primary) !important; }
    .bg-emerald-400\/60 { background-color: rgba(var(--color-primary-rgb), 0.6) !important; }

    .hover\:bg-emerald-500\/10:hover { background-color: rgba(var(--color-primary-rgb), 0.1) !important; }
    .hover\:bg-emerald-500\/20:hover { background-color: rgba(var(--color-primary-rgb), 0.2) !important; }
    .hover\:bg-emerald-500\/30:hover { background-color: rgba(var(--color-primary-rgb), 0.3) !important; }

    .hover\:border-emerald-400\/40:hover { border-color: rgba(var(--color-primary-rgb), 0.4) !important; }
    .hover\:border-slate-500:hover { border-color: rgba(var(--color-neutral-rgb), 0.6) !important; }

    .bg-amber-500,
    .bg-amber-400 { background-color: var(--accent-warning) !important; }
    .bg-amber-400\/10,
    .bg-amber-500\/10 { background-color: rgba(var(--accent-warning-rgb), 0.1) !important; }
    .bg-amber-500\/15 { background-color: rgba(var(--accent-warning-rgb), 0.15) !important; }
    .bg-amber-400\/40,
    .bg-amber-500\/40 { background-color: rgba(var(--accent-warning-rgb), 0.4) !important; }

    .border-amber-500,
    .border-amber-400 { border-color: var(--accent-warning) !important; }
    .border-amber-400\/40,
    .border-amber-500\/40 { border-color: rgba(var(--accent-warning-rgb), 0.4) !important; }
    .border-amber-400\/60,
    .border-amber-500\/60 { border-color: rgba(var(--accent-warning-rgb), 0.6) !important; }

    .text-amber-400,
    .text-amber-300,
    .text-amber-200 { color: var(--accent-warning) !important; }
    .hover\:text-amber-400:hover,
    .hover\:text-amber-300:hover,
    .hover\:text-amber-200:hover { color: var(--accent-warning) !important; }

    .bg-sky-500,
    .bg-sky-400 { background-color: var(--stage-cold) !important; }
    .bg-sky-500\/10,
    .bg-sky-400\/10 { background-color: rgba(var(--stage-cold-rgb), 0.1) !important; }
    .bg-sky-500\/15,
    .bg-sky-400\/15 { background-color: rgba(var(--stage-cold-rgb), 0.15) !important; }

    .border-sky-500,
    .border-sky-400 { border-color: var(--stage-cold) !important; }
    .border-sky-500\/40,
    .border-sky-400\/40 { border-color: rgba(var(--stage-cold-rgb), 0.4) !important; }

    .text-sky-400,
    .text-sky-300,
    .text-sky-200 { color: var(--stage-cold) !important; }

    .sidebar-menu {
      overflow: auto;
      scrollbar-width: none;
      scrollbar-color: transparent transparent;
      transition: scrollbar-color 180ms ease;
    }
    .sidebar-menu:hover,
    .sidebar-menu:focus-within {
      scrollbar-width: thin;
      scrollbar-color: #374151 transparent;
    }
    .sidebar-menu::-webkit-scrollbar {
      width: 0;
      height: 0;
      transition: width 200ms ease;
    }
    .sidebar-menu:hover::-webkit-scrollbar,
    .sidebar-menu:focus-within::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .sidebar-menu::-webkit-scrollbar-track {
      background: #1F2937;
      border-radius: 10px;
    }
    .sidebar-menu::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 10px;
    }
    .sidebar-menu::-webkit-scrollbar-thumb:hover {
      background: #4B5563;
    }

    main {
      height: calc(100vh - var(--header-height));
      overflow-y: auto;
      position: relative;
      scrollbar-gutter: stable;
    }

    .elev-card {
      --card-padding: 1.5rem;
      border-radius: 20px;
      border: 1px solid rgba(var(--color-neutral-rgb), 0.35);
      background: rgba(var(--color-card-rgb), 0.65);
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(18px);
    }

    .fade-in {
      animation: fadeIn 600ms ease-in both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: linear-gradient(180deg, rgba(var(--color-card-rgb), 0.95), rgba(var(--color-card-rgb), 0.85));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(var(--color-neutral-rgb), 0.35);
    }

    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: calc(100vh - var(--header-height) - 140px);
      padding-bottom: 1.25rem;
      box-sizing: border-box;
      overscroll-behavior: auto;
      border-radius: 14px;
      border: 1px solid rgba(var(--color-neutral-rgb), 0.28);
      background: rgba(var(--color-card-rgb), 0.6);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02),
                  0 12px 28px rgba(15, 23, 42, 0.18);
      scrollbar-gutter: stable;
    }
    .table-wrapper table,
    .table-sticky {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }
    .table-wrapper thead th,
    .table-sticky thead th,
    .table-enhanced thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(var(--color-card-rgb), 0.98), rgba(var(--color-card-rgb), 0.92));
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.18);
    }
    .table-wrapper th,
    .table-wrapper td,
    .table-sticky th,
    .table-sticky td,
    .table-enhanced tbody tr {
      border-bottom: 1px solid rgba(var(--color-neutral-rgb), 0.22);
    }
    .table-wrapper tbody tr:hover,
    .table-sticky tbody tr:hover,
    .table-enhanced tbody tr:hover {
      background-color: rgba(var(--color-primary-rgb), 0.05);
      transition: background 200ms ease;
    }

    /* Improved table text contrast for dark themes */
    html[data-theme="eleva-signature"] table th {
      color: #f3f4f6 !important;
      font-weight: 600 !important;
    }
    html[data-theme="eleva-signature"] table td {
      color: #e5e7eb !important;
    }

    html[data-theme="metallic-elevate"] table th {
      color: #0f172a !important;
      font-weight: 600 !important;
    }
    html[data-theme="metallic-elevate"] table td {
      color: #1e293b !important;
    }

    /* FORM FIELDS IN ELEVA DARK THEMES */
    html[data-theme="eleva-signature"] input,
    html[data-theme="eleva-signature"] select,
    html[data-theme="eleva-signature"] textarea {
      background-color: #111827 !important;   /* dark field */
      color: #e5e7eb !important;              /* light text */
      border: 1px solid #374151 !important;
    }

    html[data-theme="metallic-elevate"] input,
    html[data-theme="metallic-elevate"] select,
    html[data-theme="metallic-elevate"] textarea {
      background-color: rgba(255, 255, 255, 0.82) !important;
      color: #0f172a !important;
      border: 1px solid rgba(148, 163, 184, 0.58) !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    html[data-theme="metallic-elevate"] input:focus,
    html[data-theme="metallic-elevate"] select:focus,
    html[data-theme="metallic-elevate"] textarea:focus {
      border-color: rgba(var(--color-primary-rgb), 0.75) !important;
      box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.22) !important;
      outline: none;
    }

    /* Placeholder styling */
    html[data-theme="eleva-signature"] input::placeholder,
    html[data-theme="eleva-signature"] textarea::placeholder {
      color: #6b7280 !important;              /* softer gray */
    }

    html[data-theme="metallic-elevate"] input::placeholder,
    html[data-theme="metallic-elevate"] textarea::placeholder {
      color: #475569 !important;
      opacity: 1;
    }

    /* Disabled + Readonly fields */
    html[data-theme="eleva-signature"] input[disabled],
    html[data-theme="eleva-signature"] textarea[disabled],
    html[data-theme="eleva-signature"] select[disabled],
    html[data-theme="eleva-signature"] input[readonly],
    html[data-theme="eleva-signature"] textarea[readonly],
    html[data-theme="eleva-signature"] select[readonly] {
      opacity: 1 !important;
      background-color: #1f2937 !important;   /* slightly lighter dark */
      color: #9ca3af !important;              /* readable muted text */
      cursor: not-allowed;
    }

    html[data-theme="metallic-elevate"] input[disabled],
    html[data-theme="metallic-elevate"] textarea[disabled],
    html[data-theme="metallic-elevate"] select[disabled],
    html[data-theme="metallic-elevate"] input[readonly],
    html[data-theme="metallic-elevate"] textarea[readonly],
    html[data-theme="metallic-elevate"] select[readonly] {
      opacity: 1 !important;
      background-color: rgba(248, 250, 252, 0.9) !important;
      color: #475569 !important;
      border-color: rgba(148, 163, 184, 0.5) !important;
      cursor: not-allowed;
    }

    html[data-theme="eleva-signature"] select option {
      background-color: #111827 !important;
      color: #e5e7eb !important;
    }

    html[data-theme="metallic-elevate"] select option {
      background-color: #ffffff !important;
      color: #0f172a !important;
    }

    html[data-theme="warm-modern"] input,
    html[data-theme="warm-modern"] select,
    html[data-theme="warm-modern"] textarea {
      background-color: #ffffff !important;
      color: #0f172a !important;
      border: 1px solid #94a3b8 !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    html[data-theme="warm-modern"] input:focus,
    html[data-theme="warm-modern"] select:focus,
    html[data-theme="warm-modern"] textarea:focus {
      border-color: rgba(var(--color-primary-rgb), 0.92) !important;
      box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.3), 0 1px 2px rgba(15, 23, 42, 0.08) !important;
      outline: none;
    }

    html[data-theme="warm-modern"] input::placeholder,
    html[data-theme="warm-modern"] textarea::placeholder {
      color: #475569 !important;
      opacity: 1;
    }

    html[data-theme="warm-modern"] input[disabled],
    html[data-theme="warm-modern"] textarea[disabled],
    html[data-theme="warm-modern"] select[disabled],
    html[data-theme="warm-modern"] input[readonly],
    html[data-theme="warm-modern"] textarea[readonly],
    html[data-theme="warm-modern"] select[readonly] {
      opacity: 1 !important;
      background-color: #e2e8f0 !important;
      color: #334155 !important;
      border-color: #94a3b8 !important;
      cursor: not-allowed;
    }

    html[data-theme="warm-modern"] select option {
      background-color: #ffffff !important;
      color: #0f172a !important;
    }

    .collapsible-card {
      overflow: hidden;
      border-radius: 18px;
      border: 1px solid rgba(var(--color-neutral-rgb), 0.3);
      background: rgba(var(--color-card-rgb), 0.55);
      padding: 1.25rem;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    @keyframes sidebarExpand {
      0% { transform: translateX(-18px); opacity: 0.85; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes sidebarCollapse {
      0% { transform: translateX(0); opacity: 1; }
      60% { transform: translateX(-18px); opacity: 0.9; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .tooltip { position: relative; }
    .tooltip:hover .tooltip-content { opacity: 1; transform: translateY(0); }
    .tooltip-content {
      position: absolute; left: 100%; top: 50%; transform: translateY(-50%) translateY(4px);
      background: rgba(var(--color-base-rgb), 0.95); color: var(--text-secondary); padding: 6px 10px; border-radius: 8px;
      white-space: nowrap; margin-left: 8px; font-size: 12px; opacity: 0; pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
      border: 1px solid rgba(var(--color-neutral-rgb), 0.6);
    }

    .card-hover-lift {
      transition: transform 220ms cubic-bezier(.2,.8,.2,1), box-shadow 260ms ease;
      will-change: transform, box-shadow;
    }
    .card-hover-lift:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
    }

    .fade-in-up {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 420ms cubic-bezier(.2,.8,.2,1), transform 420ms cubic-bezier(.2,.8,.2,1);
      transition-delay: var(--fade-delay, 0ms);
    }
    .fade-in-up.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .btn-shimmer {
      position: relative;
      overflow: hidden;
      isolation: isolate;
      transition: transform 160ms ease, box-shadow 220ms ease;
    }
    .btn-shimmer::before,
    .btn-shimmer::after {
      content: "";
      position: absolute;
      inset: -30% -40%;
      pointer-events: none;
    }
    .btn-shimmer::before {
      background: radial-gradient(circle at center, rgba(var(--color-primary-rgb), 0.4) 0%, transparent 65%);
      opacity: 0;
      transform: scale(0.6);
      transition: opacity 260ms ease, transform 260ms ease;
      mix-blend-mode: screen;
    }
    .btn-shimmer::after {
      background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.65) 45%, transparent 100%);
      transform: translateX(-120%);
      transition: transform 600ms ease;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .btn-shimmer:hover,
    .btn-shimmer:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(var(--color-primary-rgb), 0.35);
    }
    .btn-shimmer:hover::before,
    .btn-shimmer:focus-visible::before {
      opacity: 0.65;
      transform: scale(1);
    }
    .btn-shimmer:hover::after,
    .btn-shimmer:focus-visible::after {
      transform: translateX(120%);
    }

    .stage-node {
      position: relative;
      transition: transform 200ms ease, box-shadow 240ms ease, border-color 220ms ease, background-color 220ms ease;
      border: 2px solid rgba(var(--color-neutral-rgb), 0.7);
      background: rgba(var(--color-card-rgb), 0.55);
      color: var(--text-secondary);
      will-change: transform, box-shadow;
    }
    .stage-node:hover { transform: translateY(-3px); }
    .stage-node.is-complete {
      background: rgba(var(--color-primary-rgb), 0.18);
      border-color: rgba(var(--color-primary-rgb), 0.6);
      color: var(--text-primary);
    }
    .stage-node.is-active {
      background: rgba(var(--color-secondary-rgb), 0.2);
      border-color: rgba(var(--color-secondary-rgb), 0.75);
      color: var(--text-primary);
      box-shadow: 0 0 0 0 var(--stage-glow), 0 0 18px var(--stage-glow);
      animation: stagePulse 2600ms ease-in-out infinite;
    }
    .stage-node.is-active::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px var(--stage-glow);
      opacity: 0.85;
      pointer-events: none;
    }

    .stage-label {
      color: var(--text-secondary);
      transition: color 180ms ease;
    }
    .stage-label.is-active {
      color: var(--text-primary);
      font-weight: 600;
    }

    .stage-connector {
      position: relative;
      width: 3rem;
      height: 4px;
      border-radius: 999px;
      background: rgba(var(--color-neutral-rgb), 0.35);
      overflow: hidden;
    }
    .stage-connector::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--stage-cold), var(--stage-warm), var(--stage-success));
      opacity: 0;
      background-size: 220% 100%;
      transform: translateX(-120%);
      transition: transform 520ms ease, opacity 320ms ease;
    }
    .stage-connector.is-complete::before,
    .stage-connector.is-progress::before {
      opacity: 1;
      animation: connectorFlow 3600ms linear infinite;
    }
    .stage-connector.is-complete::before {
      transform: translateX(0);
    }
    .stage-connector.is-progress::before {
      transform: translateX(-40%);
    }

    @keyframes stagePulse {
      0%, 100% { box-shadow: 0 0 0 0 var(--stage-glow), 0 0 18px var(--stage-glow); }
      50% { box-shadow: 0 0 0 6px rgba(0, 0, 0, 0); }
    }

    .collapsible,
    .motion-panel {
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 220ms cubic-bezier(.2,.8,.2,1), transform 220ms cubic-bezier(.2,.8,.2,1);
    }
    .collapsible.collapsible-visible,
    .motion-panel.is-active {
      opacity: 1;
      transform: translateY(0);
    }

    @keyframes connectorFlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    @media (prefers-reduced-motion: reduce) {
      .fade-in-up { transition: none; opacity: 1; transform: none; }
      .fade-in { animation: none; }
      .collapsible,
      .motion-panel { transition: none; opacity: 1; transform: none; }
      .card-hover-lift:hover { transform: none; box-shadow: none; }
      .btn-shimmer { transition: none; }
      .btn-shimmer::before,
      .btn-shimmer::after { display: none; }
      .stage-node { animation: none; }
      .stage-connector::before { transition: none; animation: none; }
    }

    .modal-dialog {
      padding: 0;
      border: none;
      background: transparent;
    }

    .modal-dialog::backdrop {
      backdrop-filter: blur(6px);
      background: rgba(15, 23, 42, 0.55);
    }

    .modal-dialog.open {
      display: flex;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      z-index: 50;
    }

    .modal-dialog.open > * {
      margin: auto;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">

  <!-- Fixed top header -->
  <header class="sticky top-0 z-30 border-b border-slate-800/60 bg-slate-950/70 backdrop-blur supports-[backdrop-filter]:bg-slate-950/40">
    <div class="max-w-full px-4 sm:px-6 py-3 flex items-center gap-3">
      <!-- Brand: logo + version text -->
      <div class="flex items-center gap-3 min-w-[160px]">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Eleva" class="w-9 h-9 rounded-lg shadow">
        <div class="text-sm leading-tight text-slate-200 font-semibold">Eleva ERP v1.0.0</div>
      </div>

      <!-- Back button -->
      <a href="{{ request.referrer or url_for('dashboard') }}"
         class="ml-2 inline-flex items-center gap-2 text-slate-300 hover:text-white px-3 py-2 rounded-xl bg-slate-800/50 hover:bg-slate-700/60 border border-slate-700/60 animate-slide">
        <span>&larr;</span><span class="hidden sm:inline">Back</span>
      </a>

      <!-- Spacer + user -->
      <div class="ml-auto flex items-center gap-3">
        <div class="inline-flex items-center gap-2 rounded-xl border border-slate-700/70 bg-slate-800/60 px-3 py-2">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-300">Auto Theme</span>
          <button
            type="button"
            id="autoThemeToggle"
            role="switch"
            aria-checked="false"
            class="relative inline-flex h-6 w-11 items-center rounded-full border border-slate-600/80 bg-slate-700/70 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-400/60"
          >
            <span
              id="autoThemeToggleKnob"
              class="pointer-events-none inline-block h-5 w-5 translate-x-0.5 transform rounded-full bg-white shadow transition-transform duration-200"
            ></span>
          </button>
        </div>
        {% if current_user.is_authenticated %}
          <div class="relative" id="notificationWrapper">
            <button type="button" id="notificationToggle" class="relative inline-flex items-center justify-center w-10 h-10 rounded-xl bg-slate-800/60 border border-slate-700/70 text-slate-200 hover:bg-slate-700/60">
              <span aria-hidden="true"></span>
              {% if unread_notification_count %}
              <span id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-red-500 text-[10px] font-semibold flex items-center justify-center text-white shadow">
                {{ unread_notification_count if unread_notification_count < 10 else '9+' }}
              </span>
              {% endif %}
              <span class="sr-only">Open notifications</span>
            </button>
            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-slate-900 text-slate-100 border border-slate-800/70 rounded-xl shadow-xl overflow-hidden">
              <div class="px-4 py-3 border-b border-slate-800/70 flex items-center justify-between">
                <p class="text-sm font-semibold">Notifications</p>
                <span class="text-xs text-slate-400">Last 10</span>
              </div>
              <div class="max-h-80 overflow-y-auto divide-y divide-slate-800/60">
                {% for notification in recent_notifications %}
                  <a href="{{ notification.link_url or '#' }}" data-notification-link class="block px-4 py-3 hover:bg-slate-800/80 {{ 'bg-slate-800/60' if not notification.is_read else '' }}">
                    <p class="text-sm font-semibold">{{ notification.message }}</p>
                    <p class="text-xs text-slate-400 mt-1">{{ notification.created_display }}</p>
                  </a>
                {% else %}
                  <p class="px-4 py-3 text-sm text-slate-400">You're all caught up.</p>
                {% endfor %}
              </div>
              <div class="px-4 py-2 border-t border-slate-800/70 bg-slate-900/60">
                <a href="{{ url_for('notifications_list') }}" class="text-xs font-semibold text-emerald-400 hover:text-emerald-300">View all notifications</a>
              </div>
            </div>
          </div>
          <div class="hidden sm:block text-right">
            <div class="text-sm font-semibold text-slate-100">{{ current_user.display_name }}</div>
            <div class="text-xs text-slate-400">{{ current_user.role or 'Member' }}</div>
          </div>
          <form method="post"
                action="{{ url_for('switch_user') }}"
                class="relative">
            {{ csrf_field() }}
            <label for="user-switcher" class="sr-only">Switch user</label>
            <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}">
            <select id="user-switcher"
                    name="user_id"
                    class="block min-w-[160px] appearance-none rounded-xl border border-slate-700/70 bg-slate-800/60 px-3 py-2 text-xs font-medium text-slate-200 shadow-inner focus:border-emerald-400/70 focus:outline-none focus:ring-2 focus:ring-emerald-400/40 sm:text-sm"
                    onchange="this.form.submit()"
                    title="Switch to another user">
              {% for user in switchable_users %}
                <option value="{{ user.id }}" {% if user.id == current_user.id %}selected{% endif %}>
                  {{ user.display_name }}{% if user.role %}  {{ user.role }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </form>
          <a href="{{ url_for('profile') }}"
             class="group relative block w-10 h-10 rounded-full border border-slate-700/70 bg-slate-800/60 overflow-hidden focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
             title="Open profile">
            <span class="sr-only">Open profile settings</span>
            <img src="{{ url_for('static', filename=current_user.display_picture) if current_user.display_picture else url_for('static', filename='default-avatar.svg') }}"
                 alt="{{ current_user.display_name }}"
                 class="w-full h-full object-cover transition-transform duration-150 group-hover:scale-105">
          </a>
        {% else %}
          <a href="{{ url_for('login') }}" class="text-sm text-slate-300 underline">Login</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div id="app" class="min-h-[calc(100vh-56px)] grid grid-cols-[auto_1fr]">

    <!-- Sidebar -->
    <aside id="sidebar"
           class="sidebar animate-slide bg-slate-900/70 backdrop-blur supports-[backdrop-filter]:bg-slate-900/50 sticky top-[56px] h-[calc(100vh-56px)] border-r border-slate-800/60 shadow-xl shadow-black/20 flex flex-col">
      <!-- Collapse button slot -->
      <div class="sticky top-0 z-20 px-3 pt-3 pb-2 bg-transparent">
        <button id="collapseBtn"
                class="tooltip group inline-flex items-center justify-center w-10 h-10 rounded-xl bg-slate-800/70 hover:bg-slate-700/70 border border-slate-700/70 animate-slide"
                aria-label="Collapse sidebar" type="button">
          <svg id="collapseIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
               class="w-5 h-5 transition-transform duration-200">
            <path fill-rule="evenodd"
                  d="M19.5 12a.75.75 0 01-.75.75H9.31l2.22 2.22a.75.75 0 01-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5a.75.75 0 111.06 1.06L9.31 11.25h9.44c.414 0 .75.336.75.75z"
                  clip-rule="evenodd" />
          </svg>
          <span class="tooltip-content">Collapse</span>
        </button>
        <div class="mt-3 h-2 rounded-xl" style="background-image: linear-gradient(to right, rgba(251,146,60,0.3), rgba(250,204,21,0.2), transparent);"></div>
      </div>

      <!-- Menu list -->
      <nav class="sidebar-menu px-3 pb-4 space-y-2 flex-1 overflow-auto">
        <a href="{{ url_for('dashboard') }}"
           class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint == 'dashboard' else '' }}">
          <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 10l8-6 8 6v10h-6v-6H10v6H4z" />
            </svg>
          </span>
          <span class="label text-[15px] flex-1">Dashboard</span>
        </a>

        {% if current_user.is_authenticated and current_user.can_view_module('customer_support') %}
          {% set cs_endpoints = ['customer_support_overview','customer_support_tasks','customer_support_calls','customer_support_sarv_test','customer_support_home','customer_support_settings'] %}
          {% set cs_parent_active = request.endpoint in cs_endpoints %}
          <div class="space-y-1">
            <a href="{{ url_for('customer_support_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if cs_parent_active else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M5 4a3 3 0 013-3h8a3 3 0 013 3v3h1a1 1 0 011 1v5.382a1 1 0 01-.276.69l-6.724 7.39a1 1 0 01-1.448 0l-6.724-7.39A1 1 0 013 13.382V8a1 1 0 011-1h1V4zM9 4v3h6V4H9z"/>
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Customer Support</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('customer_support_tasks') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'customer_support_tasks' else '' }}">
                <span class="label">Tasks &amp; Tickets</span>
              </a>
              <a href="{{ url_for('customer_support_calls') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'customer_support_calls' else '' }}">
                <span class="label">Call History</span>
              </a>
              <a href="{{ url_for('customer_support_sarv_test') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'customer_support_sarv_test' else '' }}">
                <span class="label">SARV test</span>
              </a>
              {% if current_user.is_admin %}
                <a href="{{ url_for('customer_support_settings') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'customer_support_settings' else '' }}">
                  <span class="label">CS Settings</span>
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.can_view_module('service') %}
          {% set service_endpoints = [
            'service_home','service_overview','service_tasks','service_customers','service_lifts','service_complaints','service_contracts','service_parts_materials','service_preventive_maintenance','service_automations','service_settings'
          ] %}
          {% set service_parent_active = request.endpoint in service_endpoints %}
          <div class="space-y-1">
            <a href="{{ url_for('service_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if service_parent_active else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2a5 5 0 00-5 5v1H6a2 2 0 00-2 2v3h16V10a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 5a3 3 0 016 0v1H9V7zm-5 9v2a2 2 0 002 2h12a2 2 0 002-2v-2H4z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Service</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('service_tasks') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_tasks' else '' }}">
                <span class="label">Service Tasks</span>
              </a>
                <a href="{{ url_for('service_customers') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_customers' else '' }}">
                  <span class="label">Customers</span>
              </a>
              <a href="{{ url_for('service_lifts') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_lifts' else '' }}">
                <span class="label">Lifts</span>
              </a>
              <a href="{{ url_for('service_complaints') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_complaints' else '' }}">
                <span class="label">All complaints</span>
              </a>
              <a href="{{ url_for('service_contracts') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_contracts' else '' }}">
                <span class="label">Contracts</span>
              </a>
              <a href="{{ url_for('service_parts_materials') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_parts_materials' else '' }}">
                <span class="label">Parts &amp; Materials</span>
              </a>
              <a href="{{ url_for('service_preventive_maintenance') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_preventive_maintenance' else '' }}">
                <span class="label">Preventive Planner</span>
              </a>
              <a href="{{ url_for('service_automations') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_automations' else '' }}">
                <span class="label">Automations</span>
              </a>
              {% if current_user.is_admin %}
                <a href="{{ url_for('service_settings') }}"
                   class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'service_settings' else '' }}">
                  <span class="label">Service Settings</span>
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.can_view_module('sales') %}
          {% set sales_endpoints = [
            'sales_home','sales_clients','sales_clients_create','sales_client_detail',
            'sales_opportunities_pipeline','sales_opportunities_create','sales_opportunity_detail','sales_opportunity_stage',
            'sales_tasks','sales_task_toggle','sales_settings'
          ] %}
          {% set sales_parent_active = request.endpoint in sales_endpoints %}
          <div class="space-y-1">
            <a href="{{ url_for('sales_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if sales_parent_active else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M4 4h16v2H4zm1 4h14v2H5zm-1 4h16v6H4zm2 2v2h12v-2z"/>
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Sales</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('sales_tasks') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_tasks' else '' }}">
                <span class="label">Sales Tasks</span>
              </a>
              <a href="{{ url_for('sales_opportunities_pipeline', pipeline_key='lift') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['sales_opportunities_pipeline','sales_opportunity_detail'] else '' }}">
                <span class="label">Opportunities</span>
              </a>
              <a href="{{ url_for('sales_clients') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['sales_clients','sales_client_detail'] else '' }}">
                <span class="label">Clients</span>
              </a>
              <a href="{{ url_for('sales_settings') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'sales_settings' else '' }}">
                <span class="label">Sales Settings</span>
              </a>
            </div>
          </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.can_view_module('operations') %}
          {% set project_endpoints = ['projects_pending','projects_list','project_detail','project_task_create','project_templates','project_template_detail','ni_settings'] %}
          <div class="space-y-1">
            <a href="{{ url_for('projects_pending') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint in project_endpoints else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M4 4h16v2H4zm2 4h12v2H6zm-2 4h16v10H4z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">New Installation</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('projects_list') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['projects_list','project_detail'] else '' }}">
                <span class="label">All Projects</span>
              </a>
              <a href="{{ url_for('ni_settings') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['ni_settings','project_templates','project_template_detail'] else '' }}">
                <span class="label">NI Settings</span>
              </a>
            </div>
          </div>
        {% endif %}

        {% if current_user.is_authenticated %}
          {% set role_key = (current_user.role or '').lower() %}
          {% set design_visible = current_user.is_admin or 'design' in role_key %}
          {% set purchase_visible = current_user.is_admin or 'purchase' in role_key %}
          {% set store_visible = current_user.is_admin or 'store' in role_key %}

          {% if design_visible %}
          {% set design_endpoints = ['design_overview','design_tasks','design_task_detail','design_drawing_history','design_drawing_history_upload','design_bom_templates','design_bom_template_edit','part_classes'] %}
          <div class="space-y-1">
            <a href="{{ url_for('design_overview') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint in design_endpoints else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 4h18v2H3zm2 4h14v2H5zm-2 4h18v2H3zm2 4h14v2H5z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Design</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('design_tasks') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'design_tasks' else '' }}">
                <span class="label">Design Tasks</span>
              </a>
              <a href="{{ url_for('design_drawing_history') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'design_drawing_history' else '' }}">
                <span class="label">Drawing History</span>
              </a>
              <a href="{{ url_for('design_bom_templates') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['design_bom_templates','design_bom_template_edit'] else '' }}">
                <span class="label">BOM Templates</span>
              </a>
              <a href="{{ url_for('part_classes') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'part_classes' else '' }}">
                <span class="label">Part Classes</span>
              </a>
            </div>
          </div>
          {% endif %}

          {% if purchase_visible %}
          {% set purchase_endpoints = ['purchase_orders','purchase_reports','purchase_parts','purchase_vendors','purchase_procurement_stages','generate_po_from_bom','purchase_odoo_history'] %}
          <div class="space-y-1">
            <a href="{{ url_for('purchase_orders') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint in purchase_endpoints else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M4 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Purchase</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('purchase_orders') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_orders' else '' }}">
                <span class="label">Purchase Orders</span>
              </a>
              <a href="{{ url_for('purchase_parts') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_parts' else '' }}">
                <span class="label">Parts</span>
              </a>
              <a href="{{ url_for('purchase_vendors') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_vendors' else '' }}">
                <span class="label">Vendors</span>
              </a>
              <a href="{{ url_for('purchase_procurement_stages') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_procurement_stages' else '' }}">
                <span class="label">Procurement Stages</span>
              </a>
              <a href="{{ url_for('purchase_reports') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_reports' else '' }}">
                <span class="label">PO Reports / Analysis</span>
              </a>
              <a href="{{ url_for('purchase_odoo_history') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'purchase_odoo_history' else '' }}">
                <span class="label">Historical POs (Odoo Import)</span>
              </a>
            </div>
          </div>
          {% endif %}

          {% if store_visible %}
          {% set store_endpoints = ['store_receive','store_inventory','store_dispatch','store_delivery_orders','create_delivery_order','delivery_order_detail','inventory_item_movements','adjust_inventory_item','inventory_snapshot'] %}
          <div class="space-y-1">
            <a href="{{ url_for('store_inventory') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if request.endpoint in store_endpoints else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M4 5h16l-1 14H5z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">Store</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('store_receive') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'store_receive' else '' }}">
                <span class="label">Receive Material</span>
              </a>
              <a href="{{ url_for('store_inventory') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['store_inventory','inventory_item_movements','adjust_inventory_item','inventory_snapshot'] else '' }}">
                <span class="label">Inventory Overview</span>
              </a>
              <a href="{{ url_for('store_delivery_orders') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['store_delivery_orders','create_delivery_order','delivery_order_detail'] else '' }}">
                <span class="label">Delivery Orders</span>
              </a>
              <a href="{{ url_for('store_dispatch') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'store_dispatch' else '' }}">
                <span class="label">Delivery Challan</span>
              </a>
            </div>
          </div>
          {% endif %}
        {% endif %}

        {% if current_user.is_authenticated and current_user.can_view_module('srt') %}
          {% set srt_endpoints = ['srt_overview','srt_settings','srt_form_templates','srt_sites'] %}
          {% set srt_parent_active = request.endpoint in srt_endpoints %}
          <div class="space-y-1">
            <a href="{{ url_for('srt_overview') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if srt_parent_active else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M4 4h16v2H4zm1 4h14v2H5zm-1 4h16v6H4zm2 2v2h12v-2z" />
                </svg>
              </span>
              <span class="label text-[15px] flex-1">SRT</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('srt_sites') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'srt_sites' else '' }}">
                <span class="label">SRT Sites</span>
              </a>
              <a href="{{ url_for('srt_settings') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['srt_settings','srt_form_templates'] else '' }}">
                <span class="label">SRT Settings</span>
              </a>
            </div>
          </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.can_view_module('qc') %}
          {% set qc_endpoints = [
            'qc_overview','qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign',
            'qc_recent_submissions','forms_list','forms_edit','form_render','submission_view','forms_new','forms_fill',
            'qc_settings'
          ] %}
          {% set qc_parent_active = request.endpoint in qc_endpoints %}
          {% set qc_tasks_active = request.endpoint in ['qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign'] or (request.endpoint == 'forms_fill' and request.args.get('work_id')) %}
          <div class="space-y-1">
            <a href="{{ url_for('qc_overview') }}"
               class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if qc_parent_active else '' }}">
              <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V6l-6-4z"/>
                </svg>
              </span>
              <span class="label text-[15px] flex-1">QC</span>
            </a>
            <div class="pl-12 space-y-1">
              <a href="{{ url_for('qc_home') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if qc_tasks_active else ''}}">
                <span class="label">Tasks</span>
              </a>
              <a href="{{ url_for('qc_settings') }}"
                 class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint == 'qc_settings' else '' }}">
                <span class="label">QC Settings</span>
              </a>
            </div>
          </div>
        {% endif %}
      </nav>

      <div class="px-3 pb-4 space-y-2 border-t border-slate-800/60 pt-4">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('settings') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide {{ 'active' if request.endpoint in ['settings','admin_users'] else '' }}">
            <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 00.12-.64l-1.92-3.32a.5.5 0 00-.6-.22l-2.39.96a7.042 7.042 0 00-1.63-.94l-.36-2.54A.5.5 0 0014.4 2h-3.8a.5.5 0 00-.5.42l-.36 2.54c-.59.23-1.14.54-1.63.94l-2.39-.96a.5.5 0 00-.6.22L3.3 8.48a.5.5 0 00.12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 00-.12.64l1.92 3.32c.14.24.44.34.7.22l2.39-.96c.49.4 1.04.72 1.63.94l.36 2.54c.04.26.25.42.5.42h3.8c.25 0 .46-.16.5-.42l.36-2.54c.59-.23 1.14-.54 1.63-.94l2.39.96c.26.12.56.02.7-.22l1.92-3.32a.5.5 0 00-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1112 8a3.5 3.5 0 010 7.5z"/>
              </svg>
            </span>
            <span class="label">Settings</span>
          </a>
          <a href="{{ url_for('logout') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide">
            <span class="nav-icon inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
              </svg>
            </span>
            <span class="label">Logout</span>
          </a>
        {% else %}
          <a href="{{ url_for('login') }}"
             class="nav-item flex items-center gap-3 px-3 py-2 animate-slide">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 17v-3H3v-4h7V7l5 5-5 5zm9-14h-8v2h8v14h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
              </svg>
            </span>
            <span class="label">Login</span>
          </a>
        {% endif %}
      </div>
    </aside>

    <!-- Main content -->
    <main class="min-h-[calc(100vh-56px)]">
      <section class="p-5">
        <!-- Dynamic Section Heading (aligned left) -->
        {% set endpoint = request.endpoint or '' %}
        {% if endpoint == 'dashboard' %}
          {% set section_title = 'Dashboard' %}
          {% elif endpoint in ['projects_pending','projects_list','project_detail','project_templates','project_template_detail','ni_settings'] %}
            {% if endpoint == 'ni_settings' %}
              {% set section_title = 'NI Settings' %}
            {% else %}
              {% set section_title = 'Projects' %}
            {% endif %}
        {% elif endpoint in ['qc_overview','qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign','qc_recent_submissions','forms_list','forms_edit','submission_view'] %}
          {% set section_title = 'QC' %}
        {% elif endpoint in ['forms_new','form_new','forms_create','form_render'] %}
          {% set section_title = 'QC - New form' %}
        {% elif endpoint in ['qc_settings'] %}
          {% set section_title = 'QC Settings' %}
        {% elif endpoint in ['customer_support_overview','customer_support_tasks','customer_support_calls','customer_support_sarv_test','customer_support_home'] %}
          {% set section_title = 'Customer Support' %}
        {% elif endpoint in ['service_home','service_overview','service_tasks','service_customers','service_lifts','service_complaints','service_contracts','service_parts_materials','service_preventive_maintenance','service_automations'] %}
          {% set section_title = 'Service' %}
        {% elif endpoint in ['srt_overview','srt_form_templates','srt_settings','srt_sites'] %}
          {% if endpoint in ['srt_form_templates','srt_settings'] %}
            {% set section_title = 'SRT  Settings' %}
          {% elif endpoint == 'srt_sites' %}
            {% set section_title = 'SRT  Sites' %}
          {% else %}
            {% set section_title = 'SRT' %}
          {% endif %}
          {% elif endpoint in ['sales_home','sales_clients','sales_client_detail','sales_opportunities_pipeline','sales_opportunity_detail','sales_settings'] %}
            {% if endpoint == 'sales_settings' %}
              {% set section_title = 'Sales Settings' %}
            {% else %}
              {% set section_title = 'Sales' %}
            {% endif %}
        {% elif endpoint in ['settings'] %}
          {% set section_title = 'Settings' %}
        {% elif endpoint in ['admin_users'] %}
          {% set section_title = 'Admin' %}
        {% else %}
          {% set section_title = 'Eleva ERP' %}
        {% endif %}

        {% block section_header %}
        <h1 class="text-2xl font-semibold mb-4 tracking-tight">{{ section_title }}</h1>
        {% endblock %}

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages mb-5 space-y-3">
              {% for category, message in messages %}
                {% if category in ['success', 'ok'] %}
                  {% set tone_classes = 'border-emerald-400/40 bg-emerald-500/10 text-emerald-100' %}
                  {% set alert_class = 'alert-success' %}
                {% elif category in ['error', 'danger'] %}
                  {% set tone_classes = 'border-rose-500/50 bg-rose-500/10 text-rose-100' %}
                  {% set alert_class = 'alert-danger alert-error' %}
                {% elif category in ['warning'] %}
                  {% set tone_classes = 'border-amber-400/60 bg-amber-500/10 text-amber-100' %}
                  {% set alert_class = 'alert-warning' %}
                {% else %}
                  {% set tone_classes = 'border-slate-700/60 bg-slate-800/60 text-slate-200' %}
                  {% set alert_class = 'alert-info' %}
                {% endif %}
                <div class="flash-message alert {{ alert_class }} rounded-xl border px-4 py-3 text-sm font-medium shadow-sm {{ tone_classes }}">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <script>
    (function () {
      const applyTheme = (theme) => {
        if (!theme) {
          return;
        }
        document.documentElement.setAttribute('data-theme', theme);
        try {
          localStorage.setItem('eleva:theme', theme);
        } catch (error) {
          // Ignore storage issues (private mode, etc.).
        }
      };

      window.elevaTheme = {
        setTheme: applyTheme,
        getTheme: () => document.documentElement.getAttribute('data-theme') || 'warm-modern',
      };

      document.addEventListener('eleva:apply-theme', (event) => {
        if (event && event.detail && event.detail.theme) {
          applyTheme(event.detail.theme);
        }
      });
    })();
  </script>

  <script>
    (function () {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('collapseBtn');
      const icon = document.getElementById('collapseIcon');
      const header = document.querySelector('header');
      const appShell = document.getElementById('app');
      const menu = sidebar ? sidebar.querySelector('.sidebar-menu') : null;
      const scrollKey = 'eleva.sidebar.scrollTop';

      const restoreScroll = () => {
        if (!menu) {
          return;
        }
        try {
          const saved = localStorage.getItem(scrollKey);
          if (saved !== null) {
            const value = parseInt(saved, 10);
            if (!Number.isNaN(value)) {
              menu.scrollTop = value;
            }
          }
        } catch (error) {
          // Ignore storage errors (private mode, etc.).
        }
      };

      const scheduleScrollSave = (() => {
        if (!menu) {
          return () => {};
        }
        let frameId = null;
        const save = () => {
          frameId = null;
          try {
            localStorage.setItem(scrollKey, String(menu.scrollTop));
          } catch (error) {
            // Ignore storage errors.
          }
        };
        return () => {
          if (frameId) {
            cancelAnimationFrame(frameId);
          }
          frameId = requestAnimationFrame(save);
        };
      })();

      function syncOffsets() {
        const h = header ? header.getBoundingClientRect().height : 56;
        if (sidebar) {
          sidebar.style.top = h + 'px';
          sidebar.style.height = `calc(100vh - ${h}px)`;
        }
        document.documentElement.style.setProperty('--header-height', `${h}px`);
        if (menu) menu.style.removeProperty('height');
      }
      window.addEventListener('resize', syncOffsets);
      window.addEventListener('load', syncOffsets);
      setTimeout(syncOffsets, 0);

      const saved = localStorage.getItem('eleva.sidebar');
      const animationClasses = ['sidebar-animate-expand', 'sidebar-animate-collapse'];
      const setState = (collapsed, { animate = false } = {}) => {
        if (!sidebar) {
          return;
        }
        sidebar.classList.toggle('collapsed', collapsed);
        sidebar.classList.toggle('sidebar-collapsed', collapsed);
        sidebar.classList.toggle('sidebar-expanded', !collapsed);
        if (icon) {
          icon.style.transform = collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        if (appShell) {
          appShell.classList.toggle('sidebar-is-collapsed', collapsed);
          appShell.style.setProperty('--sidebar-width', collapsed ? '78px' : '280px');
        }
        if (menu) {
          requestAnimationFrame(restoreScroll);
        }
        if (animate) {
          const animationClass = collapsed ? animationClasses[1] : animationClasses[0];
          sidebar.classList.remove(...animationClasses);
          void sidebar.offsetWidth;
          sidebar.classList.add(animationClass);
          sidebar.addEventListener('animationend', () => {
            sidebar.classList.remove(animationClass);
          }, { once: true });
        }
      };
      setState(saved === 'collapsed');

      if (menu) {
        restoreScroll();
        menu.addEventListener('scroll', scheduleScrollSave, { passive: true });
        window.addEventListener('beforeunload', scheduleScrollSave, { passive: true });
        window.addEventListener('pagehide', scheduleScrollSave, { passive: true });
      }

      if (btn) {
        btn.addEventListener('click', function () {
          const collapsed = !sidebar.classList.contains('collapsed');
          setState(collapsed, { animate: true });
          localStorage.setItem('eleva.sidebar', collapsed ? 'collapsed' : 'expanded');
        });
      }
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const toggles = document.querySelectorAll('[data-form-toggle]');
      toggles.forEach((button) => {
        const targetId = button.getAttribute('data-target');
        const content = targetId ? document.getElementById(targetId) : null;
        if (!content) {
          return;
        }

        content.classList.add('collapsible');

        const labelEl = button.querySelector('[data-toggle-label]');
        const iconEl = button.querySelector('[data-toggle-icon]');
        const openLabel = button.dataset.openLabel || 'Open form';
        const closeLabel = button.dataset.closeLabel || 'Hide form';
        const initialOpen = button.dataset.initialState === 'open';

        const showContent = () => {
          content.classList.remove('hidden');
          requestAnimationFrame(() => {
            content.classList.add('collapsible-visible');
          });
        };

        const hideContent = () => {
          if (content.classList.contains('hidden')) {
            return;
          }
          content.classList.remove('collapsible-visible');
          const handleTransitionEnd = (event) => {
            if (event.target !== content || event.propertyName !== 'opacity') {
              return;
            }
            if (content.classList.contains('collapsible-visible')) {
              return;
            }
            content.classList.add('hidden');
          };
          if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            content.classList.add('hidden');
          } else {
            content.addEventListener('transitionend', handleTransitionEnd, { once: true });
          }
        };

        const setState = (open) => {
          if (open) {
            showContent();
          } else {
            hideContent();
          }
          button.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (labelEl) {
            labelEl.textContent = open ? closeLabel : openLabel;
          } else {
            button.textContent = open ? closeLabel : openLabel;
          }
          if (iconEl) {
            iconEl.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
          }
        };

        setState(initialOpen);

        button.addEventListener('click', () => {
          const isOpen = content.classList.contains('hidden');
          setState(isOpen);
          if (isOpen) {
            const focusable = content.querySelector('input, select, textarea, button');
            if (focusable) {
              focusable.focus({ preventScroll: false });
            }
          }
        });
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const applySticky = (scope = document) => {
        const tables = Array.from(scope.querySelectorAll('table'));

        tables.forEach((table) => {
          if (!table || table.dataset.stickyReady === 'true') {
            return;
          }

          const parent = table.parentElement;
          if (!parent) {
            return;
          }

          const prepareWrapper = (wrapper) => {
            if (!wrapper.classList.contains('table-wrapper')) {
              wrapper.classList.add('table-wrapper');
            }
            table.classList.add('table-sticky');
            table.dataset.stickyReady = 'true';
          };

          if (parent.classList.contains('table-wrapper')) {
            prepareWrapper(parent);
            return;
          }

          if (parent.children.length === 1 && !['BODY', 'HTML'].includes(parent.tagName)) {
            prepareWrapper(parent);
            return;
          }

          const wrapper = document.createElement('div');
          wrapper.className = 'table-wrapper';
          parent.insertBefore(wrapper, table);
          wrapper.appendChild(table);
          prepareWrapper(wrapper);
        });
      };

      applySticky();

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              applySticky(node);
            }
          });
        });
      });

      observer.observe(document.body, { childList: true, subtree: true });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const notificationToggle = document.getElementById('notificationToggle');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const notificationWrapper = document.getElementById('notificationWrapper');
      const notificationBadge = document.getElementById('notificationBadge');
      const csrfToken = '{{ csrf_token() }}';

      const markRead = () => {
        if (!notificationBadge) {
          return;
        }
        notificationBadge.classList.add('hidden');
        fetch('/notifications/mark-read', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
          },
        }).catch(() => {});
      };

      if (notificationToggle && notificationDropdown && notificationWrapper) {
        notificationToggle.addEventListener('click', (event) => {
          event.stopPropagation();
          notificationDropdown.classList.toggle('hidden');
          if (!notificationDropdown.classList.contains('hidden')) {
            markRead();
          }
        });

        document.addEventListener('click', (event) => {
          if (!notificationWrapper.contains(event.target)) {
            notificationDropdown.classList.add('hidden');
          }
        });

        notificationDropdown.querySelectorAll('[data-notification-link]').forEach((link) => {
          link.addEventListener('click', () => markRead());
        });
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const animated = Array.from(document.querySelectorAll('.fade-in-up'));
      if (!animated.length) {
        return;
      }

      const reveal = (element) => {
        element.classList.add('is-visible');
      };

      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              reveal(entry.target);
              obs.unobserve(entry.target);
            }
          });
        }, {
          threshold: 0.15,
          rootMargin: '0px 0px -40px 0px',
        });

        animated.forEach((element) => observer.observe(element));
      } else {
        animated.forEach(reveal);
      }
    });
  </script>
  <script>
    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' || event.defaultPrevented || event.isComposing) {
        return;
      }

      const target = event.target;
      if (!(target instanceof HTMLInputElement)) {
        return;
      }

      const inputType = (target.type || '').toLowerCase();
      if (['file', 'button', 'submit', 'reset', 'checkbox', 'radio'].includes(inputType)) {
        return;
      }

      const form = target.closest('form');
      if (!form) {
        return;
      }

      const primarySubmit = form.querySelector('.primary-submit[type="submit"]:not([disabled])');
      const fallbackSubmit = form.querySelector('button[type="submit"]:not([disabled]), input[type="submit"]:not([disabled])');
      const submitTarget = primarySubmit || fallbackSubmit;

      if (!submitTarget) {
        event.preventDefault();
        return;
      }

      event.preventDefault();
      submitTarget.click();
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
