<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Eleva ERP{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .animate-slide { transition: all 220ms cubic-bezier(.2,.8,.2,1); }

    .sidebar { width: 280px; }
    .sidebar.collapsed { width: 78px; }

    .sidebar-collapsed .label { opacity: 0; transform: translateX(-8px); pointer-events: none; }
    .sidebar-expanded .label { opacity: 1; transform: translateX(0); }

    .nav-item { border-radius: 12px; }
    .nav-item:hover { background: rgba(255,255,255,0.06); }
    .nav-item.active { background: rgba(60,195,120,0.16); outline: 1px solid rgba(60,195,120,0.25); }

    .sidebar-menu { overflow: auto; }

    .tooltip { position: relative; }
    .tooltip:hover .tooltip-content { opacity: 1; transform: translateY(0); }
    .tooltip-content {
      position: absolute; left: 100%; top: 50%; transform: translateY(-50%) translateY(4px);
      background: rgba(15,23,42,0.95); color: #e5e7eb; padding: 6px 10px; border-radius: 8px;
      white-space: nowrap; margin-left: 8px; font-size: 12px; opacity: 0; pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
      border: 1px solid rgba(148,163,184,0.2);
    }

    .status-timeline { animation: fadeInUp 280ms ease both; }
    .status-node {
      transition: transform 180ms ease, box-shadow 220ms ease, border-color 220ms ease, background-color 220ms ease;
      will-change: transform, box-shadow;
    }
    .status-node:hover { transform: translateY(-3px); }
    .status-node.is-current { animation: statusPulse 2400ms ease-in-out infinite; }

    .status-connector {
      overflow: hidden;
      border-radius: 999px;
      background: rgba(71,85,105,0.5);
    }
    .status-connector-fill {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(52,211,153,0.25), rgba(16,185,129,0.85));
      transform-origin: left center;
      opacity: 0;
    }
    .status-connector-fill.is-active { animation: connectorGrow 520ms ease forwards; }
    .status-connector-fill.is-partial { animation: connectorPartial 520ms ease forwards; }

    @keyframes statusPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.35); }
      50% { box-shadow: 0 0 0 12px rgba(16,185,129,0); }
    }

    @keyframes connectorGrow {
      from { transform: scaleX(0); opacity: 0; }
      to { transform: scaleX(1); opacity: 1; }
    }

    @keyframes connectorPartial {
      from { transform: scaleX(0); opacity: 0; }
      to { transform: scaleX(0.45); opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">

  <!-- Fixed top header -->
  <header class="sticky top-0 z-30 border-b border-slate-800/60 bg-slate-950/70 backdrop-blur supports-[backdrop-filter]:bg-slate-950/40">
    <div class="max-w-full px-4 sm:px-6 py-3 flex items-center gap-3">
      <!-- Brand: logo + version text -->
      <div class="flex items-center gap-3 min-w-[160px]">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Eleva" class="w-9 h-9 rounded-lg shadow">
        <div class="text-sm leading-tight text-slate-200 font-semibold">Eleva ERP v1.0.0</div>
      </div>

      <!-- Back button -->
      <a href="{{ request.referrer or url_for('dashboard') }}"
         class="ml-2 inline-flex items-center gap-2 text-slate-300 hover:text-white px-3 py-2 rounded-xl bg-slate-800/50 hover:bg-slate-700/60 border border-slate-700/60 animate-slide">
        <span>&larr;</span><span class="hidden sm:inline">Back</span>
      </a>

      <!-- Spacer + user -->
      <div class="ml-auto text-sm text-slate-400">
        {% if session.get('user') %}
          Logged in as <span class="font-medium text-slate-200">{{ session['user'] }}</span>
        {% else %}
          <a href="{{ url_for('login') }}" class="underline">Login</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div id="app" class="min-h-[calc(100vh-56px)] grid grid-cols-[auto_1fr]">

    <!-- Sidebar -->
    <aside id="sidebar"
           class="sidebar animate-slide bg-slate-900/70 backdrop-blur supports-[backdrop-filter]:bg-slate-900/50 sticky top-[56px] h-[calc(100vh-56px)] border-r border-slate-800/60 shadow-xl shadow-black/20">
      <!-- Collapse button slot -->
      <div class="sticky top-0 z-20 px-3 pt-3 pb-2 bg-transparent">
        <button id="collapseBtn"
                class="tooltip group inline-flex items-center justify-center w-10 h-10 rounded-xl bg-slate-800/70 hover:bg-slate-700/70 border border-slate-700/70 animate-slide"
                aria-label="Collapse sidebar" type="button">
          <svg id="collapseIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
               class="w-5 h-5 transition-transform duration-200">
            <path fill-rule="evenodd"
                  d="M19.5 12a.75.75 0 01-.75.75H9.31l2.22 2.22a.75.75 0 01-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5a.75.75 0 111.06 1.06L9.31 11.25h9.44c.414 0 .75.336.75.75z"
                  clip-rule="evenodd" />
          </svg>
          <span class="tooltip-content">Collapse</span>
        </button>
        <div class="mt-3 h-2 rounded-xl bg-gradient-to-r from-emerald-400/30 via-emerald-200/20 to-transparent"></div>
      </div>

      <!-- Menu list -->
      <nav class="sidebar-menu px-3 pb-4 space-y-2 h-[calc(100vh-56px-64px)]">
        <a href="{{ url_for('dashboard') }}"
           class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {% if request.endpoint == 'dashboard' %}active{% endif %}">
          <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
          </span>
          <span class="label text-[15px]">Dashboard</span>
        </a>

        {% set qc_endpoints = [
          'qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign',
          'qc_recent_submissions','forms_list','forms_edit','form_render','submission_view','forms_new','forms_fill'
        ] %}
        {% set qc_parent_active = request.endpoint in qc_endpoints %}
        <div class="space-y-1">
          <div class="nav-item flex items-center gap-3 px-3 py-3 animate-slide {{ 'active' if qc_parent_active else '' }}">
            <span class="inline-flex w-8 h-8 items-center justify-center rounded-lg bg-slate-800/70 border border-slate-700/70">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V6l-6-4z"/>
              </svg>
            </span>
            <span class="label text-[15px] flex-1">QC</span>
          </div>
          <div class="pl-12 space-y-1">
            <a href="{{ url_for('qc_home') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['qc_home','qc_work_detail','qc_work_status','qc_work_comment','qc_work_assign'] else '' }}">
              <span class="label">Tasks</span>
            </a>
            <a href="{{ url_for('forms_list') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['forms_list','forms_edit','forms_new','forms_fill'] else '' }}">
              <span class="label">Form Templates</span>
            </a>
            <a href="{{ url_for('qc_recent_submissions') }}"
               class="nav-item flex items-center gap-3 px-3 py-2 text-sm animate-slide {{ 'active' if request.endpoint in ['submission_view','qc_recent_submissions'] else '' }}">
              <span class="label">Recent Submissions</span>
            </a>
          </div>
        </div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="min-h-[calc(100vh-56px)]">
      <section class="p-5">
        <!-- Dynamic Section Heading (aligned left) -->
        {% set endpoint = request.endpoint or '' %}
        {% if endpoint == 'dashboard' %}
          {% set section_title = 'Dashboard' %}
        {% elif endpoint in ['forms_list','forms_edit','submission_view'] %}
          {% set section_title = 'QC' %}
        {% elif endpoint in ['forms_new','form_new','forms_create','form_render'] %}
          {% set section_title = 'QC - New form' %}
        {% else %}
          {% set section_title = 'Eleva ERP' %}
        {% endif %}

        <h1 class="text-2xl font-semibold mb-4 tracking-tight">{{ section_title }}</h1>

        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <script>
    (function () {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('collapseBtn');
      const icon = document.getElementById('collapseIcon');
      const header = document.querySelector('header');

      function syncOffsets() {
        const h = header.getBoundingClientRect().height;
        sidebar.style.top = h + 'px';
        sidebar.style.height = `calc(100vh - ${h}px)`;
        const menu = sidebar.querySelector('.sidebar-menu');
        if (menu) menu.style.height = `calc(100vh - ${h}px - 64px)`;
      }
      window.addEventListener('resize', syncOffsets);
      window.addEventListener('load', syncOffsets);
      setTimeout(syncOffsets, 0);

      const saved = localStorage.getItem('eleva.sidebar');
      const setState = (collapsed) => {
        sidebar.classList.toggle('collapsed', collapsed);
        sidebar.classList.toggle('sidebar-collapsed', collapsed);
        sidebar.classList.toggle('sidebar-expanded', !collapsed);
        icon.style.transform = collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      };
      setState(saved === 'collapsed');

      btn.addEventListener('click', function () {
        const collapsed = !sidebar.classList.contains('collapsed');
        setState(collapsed);
        localStorage.setItem('eleva.sidebar', collapsed ? 'collapsed' : 'expanded');
      });
    })();
  </script>
</body>
</html>
