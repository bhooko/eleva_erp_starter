{% extends "base.html" %}
{% block title %}Sales Settings · Eleva ERP{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 px-6 py-5 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-start gap-4">
      <div class="space-y-2">
        <p class="text-xs uppercase tracking-wide text-amber-300">Sales</p>
        <h1 class="text-2xl font-semibold text-slate-100">Sales Settings</h1>
        <p class="text-sm text-slate-400">Configure the Client Requirements form templates used across opportunities and lifts.</p>
      </div>
      <div class="ml-auto flex items-center gap-3 text-sm text-slate-300">
        <div class="rounded-xl border border-slate-700/60 bg-slate-800/70 px-4 py-3 text-left">
          <p class="text-xs uppercase tracking-wide text-slate-400">Templates</p>
          <p class="text-lg font-semibold text-theme-primary">{{ templates|length }}</p>
        </div>
        <div class="rounded-xl border border-slate-700/60 bg-slate-800/70 px-4 py-3 text-left">
          <p class="text-xs uppercase tracking-wide text-slate-400">Primary template</p>
          <p class="text-sm font-semibold text-emerald-200">{{ primary_template.name if primary_template else 'Not set' }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 overflow-hidden">
    <div class="border-b border-slate-800/60 flex items-center gap-2 px-4 py-3 text-sm">
      <button type="button" class="px-4 py-2 rounded-xl border transition {{ 'bg-slate-800 text-white border-slate-700' if active_tab == 'form-templates' else 'text-slate-300 border-transparent hover:bg-slate-800/70' }}">Form Templates</button>
    </div>

    <div class="p-6 space-y-4" data-tab-panel="form-templates">
      <div class="flex flex-wrap items-center gap-3">
        <div>
          <h2 class="text-xl font-semibold text-theme-primary">Client Requirements form templates</h2>
          <p class="text-sm text-slate-400 mt-1">Manage the reusable layouts Sales and Design use when collecting lift requirements.</p>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button type="button"
                  class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-sm font-medium text-emerald-100 hover:bg-emerald-500/30 transition"
                  data-template-open="create">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
            </svg>
            <span>Add template</span>
          </button>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800/60 bg-slate-950/50 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-800/70 text-sm">
            <thead class="bg-slate-900/90 text-xs uppercase tracking-wide text-slate-200">
              <tr>
                <th class="px-6 py-3 text-left">Template</th>
                <th class="px-6 py-3 text-left">Slug</th>
                <th class="px-6 py-3 text-left">Primary</th>
                <th class="px-6 py-3 text-left">Active</th>
                <th class="px-6 py-3 text-left">Last updated</th>
                <th class="px-6 py-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800/60 text-slate-200">
              {% if templates %}
                {% for template in templates %}
                  <tr class="hover:bg-slate-800/40">
                    <td class="px-6 py-4">
                      <div class="font-semibold text-theme-primary">{{ template.name }}</div>
                      <div class="text-xs text-slate-400 mt-1">Type: {{ template.type }}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-300">{{ template.slug }}</td>
                    <td class="px-6 py-4">
                      {% if template.is_primary and template.is_active %}
                        <span class="inline-flex items-center rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-semibold text-emerald-100">Primary</span>
                      {% else %}
                        <span class="inline-flex items-center rounded-full bg-slate-600/20 px-2 py-1 text-xs font-semibold text-slate-200">Secondary</span>
                      {% endif %}
                    </td>
                    <td class="px-6 py-4">
                      {% if template.is_active %}
                        <span class="inline-flex items-center rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-semibold text-emerald-100">Active</span>
                      {% else %}
                        <span class="inline-flex items-center rounded-full bg-rose-500/20 px-2 py-1 text-xs font-semibold text-rose-100">Inactive</span>
                      {% endif %}
                    </td>
                    <td class="px-6 py-4 text-slate-300">{{ template.updated_at.strftime('%d %b %Y') if template.updated_at else '—' }}</td>
                    <td class="px-6 py-4">
                      <div class="flex flex-wrap items-center gap-2">
                        <button type="button"
                                class="inline-flex items-center justify-center rounded-xl border border-slate-700/70 p-2.5 text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100 transition"
                                title="Edit template"
                                aria-label="Edit template"
                                data-template-open="edit"
                                data-template-id="{{ template.id }}"
                                data-template-name="{{ template.name }}"
                                data-template-slug="{{ template.slug }}"
                                data-template-primary="{{ 'true' if template.is_primary else 'false' }}"
                                data-template-active="{{ 'true' if template.is_active else 'false' }}"
                                data-template-schema='{{ template.parsed_schema|tojson|replace("'", "&#39;") }}'>
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.651 1.65a1.125 1.125 0 010 1.59L8.71 17.54a2.25 2.25 0 01-.948.566l-3.422 1.027a.562.562 0 01-.693-.693l1.027-3.422a2.25 2.25 0 01.566-.948l9.804-9.804a1.125 1.125 0 011.59 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 19.5h-6" />
                          </svg>
                          <span class="sr-only">Edit</span>
                        </button>
                        <form method="post" class="inline" onsubmit="return confirm('Set this template as primary?');">
                          {{ csrf_field() }}
                          <input type="hidden" name="action" value="set_primary">
                          <input type="hidden" name="template_id" value="{{ template.id }}">
                          <button type="submit" class="inline-flex items-center justify-center rounded-xl border border-amber-400/40 p-2.5 text-amber-100 hover:bg-amber-500/10 transition" title="Set as primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6l-2.598 4.5H6.5L12 3l5.5 7.5h-2.902L12 6z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18l-2.598-4.5H6.5L12 21l5.5-7.5h-2.902L12 18z" />
                            </svg>
                            <span class="sr-only">Set primary</span>
                          </button>
                        </form>
                        <form method="post" class="inline">
                          {{ csrf_field() }}
                          <input type="hidden" name="action" value="toggle_active">
                          <input type="hidden" name="template_id" value="{{ template.id }}">
                          <input type="hidden" name="desired_state" value="{{ '0' if template.is_active else '1' }}">
                          {% if template.is_active %}
                            <button type="submit" class="inline-flex items-center justify-center rounded-xl border border-rose-500/40 p-2.5 text-rose-100 hover:bg-rose-500/10 transition" title="Deactivate template">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                              </svg>
                              <span class="sr-only">Deactivate</span>
                            </button>
                          {% else %}
                            <button type="submit" class="inline-flex items-center justify-center rounded-xl border border-emerald-500/40 p-2.5 text-emerald-100 hover:bg-emerald-500/10 transition" title="Activate template">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                              </svg>
                              <span class="sr-only">Activate</span>
                            </button>
                          {% endif %}
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="px-6 py-6 text-center text-slate-400">No Client Requirements templates found.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="fixed inset-0 z-40 hidden items-center justify-center p-4" data-template-modal>
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-template-dismiss></div>
  <div class="relative w-full max-w-4xl max-h-[90vh] overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/95 shadow-2xl shadow-black/40 flex flex-col">
    <form method="post" class="flex-1 flex flex-col min-h-0" data-template-form>
      {{ csrf_field() }}
      <input type="hidden" name="action" value="create">
      <input type="hidden" name="template_id" value="">
      <div class="border-b border-slate-800 px-6 py-4 flex items-start gap-3">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-slate-100" data-template-title>New Client Requirements template</h3>
          <p class="text-xs text-slate-400 mt-1" data-template-subtitle>Update labels, options, and required flags in JSON form. A default schema is preloaded for convenience.</p>
        </div>
        <button type="button" class="rounded-xl border border-slate-700/70 bg-slate-800/70 p-2 text-slate-300 hover:text-white transition" data-template-dismiss aria-label="Close template editor">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto px-6 py-5 space-y-5">
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Template name</label>
            <input name="name" required class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="Eg. Client Requirements – Standard">
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Slug</label>
            <input name="slug" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="client-requirements-standard">
            <p class="text-xs text-slate-500 mt-1">Automatically generated if left blank.</p>
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="inline-flex items-center gap-2 text-sm text-slate-200">
            <input type="checkbox" name="is_primary" class="rounded border-slate-700 bg-slate-800 text-emerald-500 focus:ring-emerald-500/50">
            <span>Mark as primary</span>
          </label>
          <label class="inline-flex items-center gap-2 text-sm text-slate-200">
            <input type="checkbox" name="is_active" class="rounded border-slate-700 bg-slate-800 text-emerald-500 focus:ring-emerald-500/50" checked>
            <span>Active</span>
          </label>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Schema JSON</label>
          <textarea name="schema_json" rows="14" class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-3 text-sm font-mono text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="Paste JSON here">{{ default_crf_schema }}</textarea>
          <p class="text-xs text-slate-500 mt-2">Keep the existing section IDs when updating labels/options so saved responses remain compatible.</p>
        </div>
      </div>
      <div class="border-t border-slate-800 px-6 py-4 flex flex-wrap items-center gap-3">
        <button type="button" class="px-4 py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-200 hover:text-white transition" data-template-dismiss>Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-xl border border-emerald-500/40 bg-emerald-500/20 text-emerald-100 font-semibold hover:bg-emerald-500/30 transition">Save template</button>
      </div>
    </form>
  </div>
</div>

<script>
  (() => {
    const modal = document.querySelector('[data-template-modal]');
    if (!modal) return;

    const form = modal.querySelector('[data-template-form]');
    const nameInput = form.querySelector('input[name="name"]');
    const slugInput = form.querySelector('input[name="slug"]');
    const templateIdInput = form.querySelector('input[name="template_id"]');
    const isPrimaryInput = form.querySelector('input[name="is_primary"]');
    const isActiveInput = form.querySelector('input[name="is_active"]');
    const schemaInput = form.querySelector('textarea[name="schema_json"]');
    const titleEl = modal.querySelector('[data-template-title]');
    const subtitleEl = modal.querySelector('[data-template-subtitle]');

    const openModal = () => {
      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    };
    const closeModal = () => {
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    };

    modal.querySelectorAll('[data-template-dismiss]').forEach(btn => {
      btn.addEventListener('click', closeModal);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    document.querySelectorAll('[data-template-open]').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-template-open');
        form.reset();
        schemaInput.value = `{{ default_crf_schema | replace('`', '\\`') }}`;
        if (mode === 'edit') {
          form.querySelector('input[name="action"]').value = 'update';
          templateIdInput.value = btn.dataset.templateId || '';
          nameInput.value = btn.dataset.templateName || '';
          slugInput.value = btn.dataset.templateSlug || '';
          isPrimaryInput.checked = btn.dataset.templatePrimary === 'true';
          isActiveInput.checked = btn.dataset.templateActive === 'true';
          const schemaRaw = btn.dataset.templateSchema || '{}';
          try {
            const parsed = JSON.parse(schemaRaw);
            schemaInput.value = JSON.stringify(parsed, null, 2);
          } catch (error) {
            schemaInput.value = schemaRaw;
          }
          titleEl.textContent = 'Edit Client Requirements template';
          subtitleEl.textContent = 'Adjust labels and options, then save to update the template in Sales and Design flows.';
        } else {
          form.querySelector('input[name="action"]').value = 'create';
          templateIdInput.value = '';
          isPrimaryInput.checked = false;
          isActiveInput.checked = true;
          titleEl.textContent = 'New Client Requirements template';
          subtitleEl.textContent = 'Start from the default schema and tailor fields for your sales/design workflow.';
        }
        openModal();
      });
    });
  })();
</script>
{% endblock %}
