{% extends "base.html" %}
{% block title %}Eleva ERP – SRT Form Templates{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 px-6 py-5 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-center gap-3">
      <div>
        <h2 class="text-xl font-semibold text-theme-primary">SRT Form Templates</h2>
        <p class="text-sm text-slate-400 mt-1">Design reusable SRT checklists, mirroring QC layouts with guided images and flexible item types.</p>
      </div>
      <div class="ml-auto flex items-center gap-3">
        <button type="button"
                class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-sm font-medium text-emerald-100 hover:bg-emerald-500/30 transition"
                data-designer-open="create">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
          </svg>
          <span>Add template</span>
        </button>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/60 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-800/70 text-sm">
        <thead class="bg-slate-900/90 text-[11px] uppercase tracking-wide text-slate-200">
          <tr>
            <th class="px-6 py-3 text-left">Template</th>
            <th class="px-6 py-3 text-left">Category</th>
            <th class="px-6 py-3 text-left">Last updated</th>
            <th class="px-6 py-3 text-left">Usage</th>
            <th class="px-6 py-3 text-left">Description</th>
            <th class="px-6 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800/60 text-slate-200">
          {% for template in templates %}
            <tr class="hover:bg-slate-800/40">
              <td class="px-6 py-4">
                <div class="font-semibold text-theme-primary">{{ template.name }}</div>
                <div class="text-xs text-slate-400 mt-1">ID: {{ template.id }}</div>
                {% set items_count = template.schema|map(attribute='items')|map('length')|sum %}
                <div class="text-xs text-slate-500 mt-1">
                  {{ template.schema|length }} section{{ 's' if template.schema|length != 1 else '' }} ·
                  {{ items_count }} check{{ 's' if items_count != 1 else '' }}
                </div>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full bg-slate-500/20 px-2 py-1 text-xs font-semibold text-slate-100">{{ template.category }}</span>
              </td>
              <td class="px-6 py-4">{{ template.last_updated.strftime('%d %b %Y') }}</td>
              <td class="px-6 py-4">
                <span class="text-emerald-300 font-semibold">{{ template.usage_count }}</span>
                <span class="text-xs text-slate-400"> submissions</span>
              </td>
              <td class="px-6 py-4 text-slate-300 leading-relaxed">{{ template.description or '—' }}</td>
              <td class="px-6 py-4">
                <div class="flex flex-wrap items-center gap-2">
                  <button type="button"
                          class="inline-flex items-center justify-center rounded-xl border border-slate-700/70 p-2.5 text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100 transition"
                          data-designer-open="edit"
                          data-template-id="{{ template.id }}"
                          data-template-name="{{ template.name }}"
                          data-template-category="{{ template.category }}"
                          data-template-usage="{{ template.usage_count }}"
                          data-template-updated-label="{{ template.last_updated.strftime('%d %b %Y') }}"
                          data-template-description="{{ template.description|e }}"
                          data-template-schema='{{ template.schema|tojson|replace("'", "&#39;") }}'
                          title="Edit template"
                          aria-label="Edit template">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.651 1.65a1.125 1.125 0 010 1.59L8.71 17.54a2.25 2.25 0 01-.948.566l-3.422 1.027a.562.562 0 01-.693-.693l1.027-3.422a2.25 2.25 0 01.566-.948l9.804-9.804a1.125 1.125 0 011.59 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 19.5h-6" />
                    </svg>
                    <span class="sr-only">Edit</span>
                  </button>
                  <button type="button"
                          class="inline-flex items-center justify-center rounded-xl border border-slate-700/70 p-2.5 text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100 transition"
                          data-designer-open="duplicate"
                          data-template-id="{{ template.id }}"
                          data-template-name="{{ template.name }}"
                          data-template-category="{{ template.category }}"
                          data-template-usage="{{ template.usage_count }}"
                          data-template-updated-label="{{ template.last_updated.strftime('%d %b %Y') }}"
                          data-template-description="{{ template.description|e }}"
                          data-template-schema='{{ template.schema|tojson|replace("'", "&#39;") }}'
                          title="Duplicate template"
                          aria-label="Duplicate template">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 6.75A2.25 2.25 0 017.5 4.5h9.75a.75.75 0 01.75.75V15a2.25 2.25 0 01-2.25 2.25H8.25a.75.75 0 00-.75.75V18A2.25 2.25 0 015.25 15.75V6.75z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 19.5h9.75a2.25 2.25 0 002.25-2.25V8.25" />
                    </svg>
                    <span class="sr-only">Duplicate</span>
                  </button>
                  <button type="button"
                          class="inline-flex items-center justify-center rounded-xl border border-slate-700/70 p-2.5 text-slate-200 hover:border-emerald-400/50 hover:text-emerald-100 transition"
                          data-preview-open
                          data-template-name="{{ template.name }}"
                          data-template-category="{{ template.category }}"
                          data-template-updated-label="{{ template.last_updated.strftime('%d %b %Y') }}"
                          data-template-description="{{ template.description|e }}"
                          data-template-schema='{{ template.schema|tojson|replace("'", "&#39;") }}'
                          title="Preview template"
                          aria-label="Preview template">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="sr-only">Preview</span>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<input type="file" accept="image/*" class="hidden" data-designer-file-picker>

<div class="fixed inset-0 z-50 hidden items-center justify-center p-4" data-srt-designer>
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-designer-close></div>
  <div class="relative w-full max-w-5xl max-h-[92vh] overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/95 shadow-2xl shadow-black/40 flex flex-col min-h-0">
    <form method="post" class="flex-1 flex flex-col min-h-0" data-designer-form>
      <input type="hidden" name="action" value="create">
      <input type="hidden" name="template_id" value="">
      <input type="hidden" name="schema_json" value="">
      <div class="border-b border-slate-800 px-6 py-4 flex items-start gap-3">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-slate-100" data-designer-title>New SRT template</h3>
          <p class="text-xs text-slate-400 mt-1" data-designer-subtitle>Build sections, add checklist items and attach reference images for technicians.</p>
        </div>
        <button type="button" class="rounded-xl border border-slate-700/70 bg-slate-800/70 p-2 text-slate-300 hover:text-white transition" data-designer-close aria-label="Close designer">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto px-6 py-5 space-y-6 min-h-0">
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Template name</label>
            <input name="name" required class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="Eg. SRT - Safety Walkthrough">
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Category</label>
            <input name="category" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="Eg. Safety">
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Usage count</label>
            <input type="number" min="0" name="usage_count" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="0">
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 px-4 py-3">
            <p class="text-xs uppercase tracking-wide text-slate-400">Last updated</p>
            <p class="text-sm font-semibold text-slate-200 mt-1" data-designer-last-updated>—</p>
            <p class="text-sm text-slate-300 leading-relaxed mt-2">This timestamp is set automatically whenever you create or save changes to the template.</p>
          </div>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
          <textarea name="description" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40" placeholder="Summarise the focus of this checklist."></textarea>
        </div>
        <div class="space-y-3">
          <div class="flex flex-wrap items-center gap-3">
            <h4 class="text-sm font-semibold text-slate-200">Checklist builder</h4>
            <div class="flex flex-wrap items-center gap-2 text-xs">
              <button type="button" class="px-3 py-1.5 rounded-xl border border-emerald-500/60 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-200 transition" data-designer-copy>Copy JSON</button>
              <button type="button" class="px-3 py-1.5 rounded-xl border border-sky-500/60 bg-sky-500/10 hover:bg-sky-500/20 text-sky-200 transition" data-designer-download>Download JSON</button>
              <span class="text-xs text-slate-400" data-designer-feedback></span>
            </div>
          </div>
          <div class="space-y-4" data-designer-builder></div>
          <details class="bg-slate-900/60 border border-slate-800 rounded-2xl p-3">
            <summary class="text-xs text-slate-400 cursor-pointer">Preview JSON</summary>
            <pre class="mt-2 text-xs leading-5 text-emerald-100/80 whitespace-pre-wrap" data-designer-preview></pre>
          </details>
        </div>
      </div>
      <div class="border-t border-slate-800 px-6 py-4 flex flex-wrap items-center gap-3">
        <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-sm font-medium text-rose-200 hover:bg-rose-500/20 transition hidden" data-designer-delete>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.166L18.16 19.673A2.25 2.25 0 0 1 15.917 21H8.083a2.25 2.25 0 0 1-2.244-2.327L5.772 5.79m12.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .563c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.398m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.02-2.09 2.2v.917m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
          <span>Delete template</span>
        </button>
        <div class="flex items-center gap-3 ml-auto">
          <button type="button" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm text-slate-300 hover:text-white transition" data-designer-close>Cancel</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/30 transition" data-designer-submit>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          <span data-designer-submit-label>Save template</span>
        </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="fixed inset-0 z-40 hidden items-center justify-center p-4" data-srt-preview>
  <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" data-preview-close></div>
  <div class="relative w-full max-w-4xl max-h-[92vh] overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/95 shadow-2xl shadow-black/40 flex flex-col min-h-0">
    <div class="border-b border-slate-800 px-6 py-4 flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
      <div class="space-y-1">
        <h3 class="text-lg font-semibold text-slate-100" data-preview-title>Template preview</h3>
        <p class="text-sm text-slate-300" data-preview-description>—</p>
        <p class="text-xs uppercase tracking-wide text-slate-500" data-preview-meta></p>
      </div>
      <button type="button" class="self-start rounded-xl border border-slate-700/70 bg-slate-800/70 p-2 text-slate-300 hover:text-white transition" data-preview-close aria-label="Close preview">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto px-6 py-5 space-y-6" data-preview-body>
      <p class="text-sm text-slate-400">Select a template to see its structure.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const designerOverlay = document.querySelector('[data-srt-designer]');
    const previewOverlay = document.querySelector('[data-srt-preview]');
    const previewBody = previewOverlay ? previewOverlay.querySelector('[data-preview-body]') : null;
    const previewTitle = previewOverlay ? previewOverlay.querySelector('[data-preview-title]') : null;
    const previewDescription = previewOverlay ? previewOverlay.querySelector('[data-preview-description]') : null;
    const previewMeta = previewOverlay ? previewOverlay.querySelector('[data-preview-meta]') : null;
    const previewEmptyState = '<p class="text-sm text-slate-400">Select a template to see its structure.</p>';
    const filePicker = document.querySelector('[data-designer-file-picker]');
    if (!designerOverlay) {
      return;
    }

    const form = designerOverlay.querySelector('[data-designer-form]');
    const builderEl = designerOverlay.querySelector('[data-designer-builder]');
    const hiddenInput = form.querySelector('input[name="schema_json"]');
    const titleEl = designerOverlay.querySelector('[data-designer-title]');
    const subtitleEl = designerOverlay.querySelector('[data-designer-subtitle]');
    const feedbackEl = designerOverlay.querySelector('[data-designer-feedback]');
    const previewEl = designerOverlay.querySelector('[data-designer-preview]');
    const submitLabel = designerOverlay.querySelector('[data-designer-submit-label]');
    const deleteButton = designerOverlay.querySelector('[data-designer-delete]');
    const actionInput = form.querySelector('input[name="action"]');
    const copyBtn = designerOverlay.querySelector('[data-designer-copy]');
    const downloadBtn = designerOverlay.querySelector('[data-designer-download]');
    const lastUpdatedDisplay = designerOverlay.querySelector('[data-designer-last-updated]');

    let mode = 'create';
    let schema = [];
    let pendingImageTarget = null;

    const escapeHtml = (value) => String(value ?? '').replace(/[&<>"']/g, (ch) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[ch]);

    const placeholderSections = new WeakSet();
    const placeholderItems = new WeakSet();

    const defaultItem = () => {
      const item = {
        label: 'New Checklist Item',
        type: 'select',
        options: ['OK', 'Not OK', 'Need Client Input'],
        required: true,
        allow_photo: true,
        allow_remark: true,
        photo_required_if_ng: false,
        display_image: ''
      };
      placeholderItems.add(item);
      return item;
    };

    const defaultTable = () => {
      const item = {
        label: 'New Table',
        type: 'table',
        required: true,
        rows: ['Row 1', 'Row 2'],
        columns: ['Column 1', 'Column 2'],
        display_image: ''
      };
      placeholderItems.add(item);
      return item;
    };

    const defaultSection = () => {
      const section = {
        section: 'New Section',
        display_image: '',
        items: [defaultItem()]
      };
      placeholderSections.add(section);
      return section;
    };

    const normaliseItem = (raw) => {
      const kind = String(raw && raw.type ? raw.type : 'select').toLowerCase();
      if (kind === 'table') {
        const rows = Array.isArray(raw?.rows) ? raw.rows : [];
        const columns = Array.isArray(raw?.columns) ? raw.columns : [];
        return {
          label: String(raw?.label ?? ''),
          type: 'table',
          required: Boolean(raw?.required),
          rows: rows.map((row) => String(row).trim()).filter(Boolean).length ? rows.map((row) => String(row).trim()).filter(Boolean) : ['Row 1', 'Row 2'],
          columns: columns.map((col) => String(col).trim()).filter(Boolean).length ? columns.map((col) => String(col).trim()).filter(Boolean) : ['Column 1', 'Column 2'],
          display_image: String(raw?.display_image ?? '')
        };
      }

      const allowed = ['select', 'text', 'textarea'];
      const type = allowed.includes(kind) ? kind : 'select';
      let options = [];
      if (type === 'select') {
        const opts = Array.isArray(raw?.options) ? raw.options : [];
        options = opts.map((opt) => String(opt).trim()).filter(Boolean);
        if (!options.length) {
          options = ['OK', 'Not OK', 'Need Client Input'];
        }
      }

      const allowPhoto = raw?.allow_photo !== undefined ? Boolean(raw.allow_photo) : type === 'select';
      const photoRequired = allowPhoto && type === 'select' ? Boolean(raw?.photo_required_if_ng) : false;

      return {
        label: String(raw?.label ?? ''),
        type,
        options,
        required: Boolean(raw?.required ?? type === 'select'),
        allow_photo: allowPhoto,
        allow_remark: Boolean(raw?.allow_remark ?? type !== 'text'),
        photo_required_if_ng: photoRequired,
        display_image: String(raw?.display_image ?? '')
      };
    };

    const normaliseSection = (rawSection) => {
      const section = String(rawSection?.section ?? '');
      const displayImage = String(rawSection?.display_image ?? '');
      const rawItems = Array.isArray(rawSection?.items) ? rawSection.items : [];
      const items = rawItems.length ? rawItems.map(normaliseItem) : [defaultItem()];
      return {
        section,
        display_image: displayImage,
        items
      };
    };

    const normaliseSchema = (rawSchema) => {
      if (!Array.isArray(rawSchema)) {
        return [defaultSection()];
      }
      const cleaned = rawSchema
        .map((section) => normaliseSection(section))
        .filter(Boolean);
      return cleaned.length ? cleaned : [defaultSection()];
    };

    const getSerializedSchema = () => JSON.stringify(schema, null, 2);

    const updateHidden = () => {
      const payload = getSerializedSchema();
      hiddenInput.value = payload;
      if (previewEl) {
        previewEl.textContent = payload;
      }
    };

    const showFeedback = (message, tone = 'muted') => {
      if (!feedbackEl) {
        return;
      }
      feedbackEl.textContent = message;
      feedbackEl.classList.remove('text-emerald-300', 'text-rose-300', 'text-slate-400');
      if (tone === 'success') {
        feedbackEl.classList.add('text-emerald-300');
      } else if (tone === 'error') {
        feedbackEl.classList.add('text-rose-300');
      } else {
        feedbackEl.classList.add('text-slate-400');
      }
      if (message) {
        setTimeout(() => {
          if (feedbackEl.textContent === message) {
            feedbackEl.textContent = '';
            feedbackEl.classList.remove('text-emerald-300', 'text-rose-300');
            feedbackEl.classList.add('text-slate-400');
          }
        }, 4000);
      }
    };

    const renderImageControls = (scope, sectionIndex, itemIndex, value) => {
      const baseAttrs = `data-scope="${scope}" data-section="${sectionIndex}"${itemIndex !== null ? ` data-item="${itemIndex}"` : ''}`;
      const preview = value
        ? `<div class="rounded-xl border border-slate-700/70 bg-slate-800/70 p-2"><img src="${escapeHtml(value)}" alt="${scope === 'section' ? 'Section' : 'Item'} display" class="max-h-32 rounded-lg object-cover"></div>`
        : `<div class="rounded-xl border border-dashed border-slate-700/70 bg-slate-900/50 px-3 py-4 text-xs text-slate-500 text-center">No image selected</div>`;
      const clearButton = value
        ? `<button type="button" class="px-3 py-1.5 text-xs rounded-xl border border-rose-500/60 bg-rose-500/10 hover:bg-rose-500/20 text-rose-200 transition" data-action="clear-image" ${baseAttrs}>Remove</button>`
        : '';
      return `
        <div class="space-y-2">
          <label class="block text-xs text-slate-400">Display image</label>
          ${preview}
          <div class="flex flex-wrap items-center gap-2">
            <input type="text" class="flex-1 min-w-[200px] px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" value="${escapeHtml(value)}" placeholder="Paste URL or data URI" ${baseAttrs} data-field="display_image">
            <button type="button" class="px-3 py-1.5 text-xs rounded-xl border border-emerald-500/60 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-200 transition" data-action="upload-image" ${baseAttrs}>Upload</button>
            ${clearButton}
          </div>
          <p class="text-xs text-slate-300">Shown beside the ${scope === 'section' ? 'section heading' : 'check item'} during checklist entry.</p>
        </div>
      `;
    };

    const render = () => {
      const sectionsMarkup = schema.map((section, sectionIndex) => {
        const removeSectionDisabled = schema.length === 1;
        const sectionImageControls = renderImageControls('section', sectionIndex, null, section.display_image || '');
        const sectionSuggestion = 'New Section';
        const sectionIsPlaceholder = placeholderSections.has(section) && (!section.section || section.section === sectionSuggestion);
        const sectionInputValue = sectionIsPlaceholder ? sectionSuggestion : section.section;
        const itemsMarkup = section.items.map((item, itemIndex) => {
          const removeItemDisabled = section.items.length === 1 && schema.length === 1;
          const isTable = item.type === 'table';
          const optionsBlock = !isTable && item.type === 'select'
            ? `<div>
                <label class="block text-xs text-slate-400 mb-1">Options <span class="text-slate-500">(one per line)</span></label>
                <textarea rows="2" class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="options">${escapeHtml(item.options.join('\n'))}</textarea>
              </div>`
            : '';

          const togglesBlock = isTable
            ? `<div class="flex flex-wrap gap-3 text-xs text-slate-300">
                <label class="inline-flex items-center gap-2 bg-slate-800/60 px-3 py-1.5 rounded-xl border border-slate-700/60">
                  <input type="checkbox" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="required" ${item.required ? 'checked' : ''}>
                  <span>All cells required</span>
                </label>
              </div>`
            : `<div class="flex flex-wrap gap-3 text-xs text-slate-300">
                <label class="inline-flex items-center gap-2 bg-slate-800/60 px-3 py-1.5 rounded-xl border border-slate-700/60">
                  <input type="checkbox" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="required" ${item.required ? 'checked' : ''}>
                  <span>Required</span>
                </label>
                <label class="inline-flex items-center gap-2 bg-slate-800/60 px-3 py-1.5 rounded-xl border border-slate-700/60">
                  <input type="checkbox" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="allow_photo" ${item.allow_photo ? 'checked' : ''}>
                  <span>Allow photo</span>
                </label>
                <label class="inline-flex items-center gap-2 bg-slate-800/60 px-3 py-1.5 rounded-xl border border-slate-700/60 ${item.allow_photo && item.type === 'select' ? '' : 'opacity-40'}">
                  <input type="checkbox" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="photo_required_if_ng" ${item.photo_required_if_ng && item.allow_photo && item.type === 'select' ? 'checked' : ''} ${item.allow_photo && item.type === 'select' ? '' : 'disabled'}>
                  <span>Photo required if Not OK is selected</span>
                </label>
                <label class="inline-flex items-center gap-2 bg-slate-800/60 px-3 py-1.5 rounded-xl border border-slate-700/60">
                  <input type="checkbox" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="allow_remark" ${item.allow_remark ? 'checked' : ''}>
                  <span>Allow remark</span>
                </label>
              </div>`;

          const rowsText = Array.isArray(item.rows) ? item.rows.join('\n') : '';
          const columnsText = Array.isArray(item.columns) ? item.columns.join('\n') : '';
          const itemSuggestion = isTable ? 'New Table' : 'New Checklist Item';
          const itemIsPlaceholder = placeholderItems.has(item) && (!item.label || item.label === itemSuggestion);
          const itemInputValue = itemIsPlaceholder ? itemSuggestion : item.label;

          const tableExtras = isTable
            ? `<div class="space-y-3">
                <div class="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs text-slate-400 mb-1">Row labels <span class="text-slate-500">(one per line)</span></label>
                    <textarea rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="rows">${escapeHtml(rowsText)}</textarea>
                  </div>
                  <div>
                    <label class="block text-xs text-slate-400 mb-1">Column labels <span class="text-slate-500">(one per line)</span></label>
                    <textarea rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="columns">${escapeHtml(columnsText)}</textarea>
                  </div>
                </div>
              </div>`
            : '';

          const typeSelect = `
            <select class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="type">
              <option value="select" ${item.type === 'select' ? 'selected' : ''}>Choice list</option>
              <option value="text" ${item.type === 'text' ? 'selected' : ''}>Short text</option>
              <option value="textarea" ${item.type === 'textarea' ? 'selected' : ''}>Long text</option>
              <option value="table" ${item.type === 'table' ? 'selected' : ''}>Table grid</option>
            </select>
          `;

          const imageControls = renderImageControls('item', sectionIndex, itemIndex, item.display_image || '');

          return `
            <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4 space-y-3">
              <div class="grid md:grid-cols-[minmax(0,1fr)_180px] gap-4">
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs text-slate-400 mb-1">Check label</label>
                    <input type="text" class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" value="${escapeHtml(itemInputValue)}" maxlength="160" data-scope="item" data-section="${sectionIndex}" data-item="${itemIndex}" data-field="label"${itemIsPlaceholder ? ` data-suggestion="${itemSuggestion}"` : ''}>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-xs text-slate-400 mb-1">Field type</label>
                      ${typeSelect}
                    </div>
                    <div class="sm:text-right flex sm:justify-end items-center">
                      <button type="button" class="px-3 py-2 text-xs rounded-xl border border-slate-700/60 bg-slate-800/60 hover:bg-slate-700/60 transition ${removeItemDisabled ? 'opacity-50 cursor-not-allowed' : ''}" data-action="remove-item" data-section="${sectionIndex}" data-item="${itemIndex}" ${removeItemDisabled ? 'disabled' : ''}>Remove</button>
                    </div>
                  </div>
                  ${togglesBlock}
                  ${optionsBlock}
                  ${tableExtras}
                  ${imageControls}
                </div>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
              <div class="flex-1 space-y-3">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Section name</label>
                  <input type="text" class="w-full px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-emerald-500/40" value="${escapeHtml(sectionInputValue)}" placeholder="Eg. Machine Room" data-scope="section" data-section="${sectionIndex}" data-field="section" maxlength="160"${sectionIsPlaceholder ? ` data-suggestion="${sectionSuggestion}"` : ''}>
                  <p class="text-xs text-slate-300 mt-1">Leave blank to hide this heading when the checklist is rendered.</p>
                </div>
                ${sectionImageControls}
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <button type="button" class="px-3 py-2 text-xs rounded-xl border border-sky-500/60 bg-sky-500/10 hover:bg-sky-500/20 text-sky-200 transition" data-action="add-table" data-section="${sectionIndex}">+ Add table</button>
                <button type="button" class="px-3 py-2 text-xs rounded-xl border border-slate-700/60 bg-slate-800/60 hover:bg-slate-700/60 transition ${removeSectionDisabled ? 'opacity-50 cursor-not-allowed' : ''}" data-action="remove-section" data-section="${sectionIndex}" ${removeSectionDisabled ? 'disabled' : ''}>Remove section</button>
              </div>
            </div>
            <div class="space-y-4">
              ${itemsMarkup}
              <div>
                <button type="button" class="px-3 py-2 text-xs rounded-xl border border-emerald-500/60 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-300 transition" data-action="add-item" data-section="${sectionIndex}">+ Add check</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      builderEl.innerHTML = `${sectionsMarkup}
        <div class="pt-3">
          <button type="button" class="px-4 py-2 text-sm rounded-xl border border-emerald-500/60 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-300 transition" data-action="add-section">+ Add section</button>
        </div>`;
    };

    const openDesigner = (config) => {
      const duplicateMode = config.mode === 'duplicate';
      mode = config.mode === 'edit' ? 'edit' : 'create';
      if (previewOverlay && previewOverlay.classList.contains('flex')) {
        previewOverlay.classList.add('hidden');
        previewOverlay.classList.remove('flex');
        if (previewBody) {
          previewBody.innerHTML = previewEmptyState;
        }
      }
      form.reset();
      schema = normaliseSchema(config.schema);
      render();
      updateHidden();

      if (actionInput) {
        actionInput.value = mode === 'edit' ? 'update' : 'create';
      }
      const idField = form.querySelector('input[name="template_id"]');
      if (idField) {
        idField.value = mode === 'edit' ? config.templateId || '' : '';
      }

      const nameField = form.querySelector('input[name="name"]');
      if (nameField) {
        if (mode === 'edit') {
          nameField.value = config.name || '';
        } else if (duplicateMode && config.name) {
          nameField.value = `${config.name} (Copy)`;
        } else {
          nameField.value = config.name || '';
        }
      }

      const categoryField = form.querySelector('input[name="category"]');
      if (categoryField) {
        categoryField.value = duplicateMode || mode === 'edit' ? (config.category || '') : '';
      }

      const usageField = form.querySelector('input[name="usage_count"]');
      if (usageField) {
        usageField.value = mode === 'edit' ? (config.usageCount || '') : '';
      }

      const descriptionField = form.querySelector('textarea[name="description"]');
      if (descriptionField) {
        if (mode === 'edit' || duplicateMode) {
          descriptionField.value = config.description || '';
        } else {
          descriptionField.value = '';
        }
      }

      if (lastUpdatedDisplay) {
        if (mode === 'edit') {
          lastUpdatedDisplay.textContent = config.lastUpdatedLabel || 'Will update on save';
        } else {
          lastUpdatedDisplay.textContent = 'Will be set on save';
        }
      }

      if (titleEl) {
        if (mode === 'edit') {
          titleEl.textContent = 'Edit SRT template';
        } else if (duplicateMode) {
          titleEl.textContent = 'Duplicate SRT template';
        } else {
          titleEl.textContent = 'New SRT template';
        }
      }
      if (subtitleEl) {
        if (mode === 'edit') {
          subtitleEl.textContent = 'Update metadata, sections and checklist items. Images will refresh automatically when changed.';
        } else if (duplicateMode) {
          subtitleEl.textContent = 'Create a copy of an existing template. Adjust the name and checklist items before saving.';
        } else {
          subtitleEl.textContent = 'Build sections, add checklist items and attach reference images for technicians.';
        }
      }
      if (submitLabel) {
        if (mode === 'edit') {
          submitLabel.textContent = 'Update template';
        } else if (duplicateMode) {
          submitLabel.textContent = 'Create duplicate';
        } else {
          submitLabel.textContent = 'Save template';
        }
      }
      if (deleteButton) {
        if (mode === 'edit') {
          deleteButton.classList.remove('hidden');
          deleteButton.disabled = false;
        } else {
          deleteButton.classList.add('hidden');
        }
      }

      designerOverlay.classList.remove('hidden');
      designerOverlay.classList.add('flex');
      const firstInput = form.querySelector('input[name="name"]');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 80);
      }
    };

    const closeDesigner = () => {
      designerOverlay.classList.add('hidden');
      designerOverlay.classList.remove('flex');
      pendingImageTarget = null;
      showFeedback('', 'muted');
    };

    document.querySelectorAll('[data-designer-open]').forEach((button) => {
      button.addEventListener('click', () => {
        const modeAttr = button.getAttribute('data-designer-open');
        const schemaAttr = button.getAttribute('data-template-schema');
        let parsedSchema = [];
        if (schemaAttr) {
          try {
            parsedSchema = JSON.parse(schemaAttr);
          } catch (err) {
            parsedSchema = [];
          }
        }
        let modeValue = 'create';
        if (modeAttr === 'edit') {
          modeValue = 'edit';
        } else if (modeAttr === 'duplicate') {
          modeValue = 'duplicate';
        }
        openDesigner({
          mode: modeValue,
          templateId: button.getAttribute('data-template-id') || '',
          name: button.getAttribute('data-template-name') || '',
          category: button.getAttribute('data-template-category') || '',
          lastUpdatedLabel: button.getAttribute('data-template-updated-label') || '',
          usageCount: button.getAttribute('data-template-usage') || '',
          description: button.getAttribute('data-template-description') || '',
          schema: parsedSchema
        });
      });
    });

    designerOverlay.querySelectorAll('[data-designer-close]').forEach((button) => {
      button.addEventListener('click', closeDesigner);
    });

    designerOverlay.addEventListener('click', (event) => {
      if (event.target.closest('[data-designer-close]')) {
        closeDesigner();
      }
    });

    if (deleteButton) {
      deleteButton.addEventListener('click', () => {
        if (mode !== 'edit' || !actionInput) {
          return;
        }
        const nameField = form.querySelector('input[name="name"]');
        const templateName = nameField && nameField.value.trim() ? nameField.value.trim() : 'this template';
        const confirmed = window.confirm(`Delete template "${templateName}"? This action cannot be undone.`);
        if (!confirmed) {
          actionInput.value = 'update';
          return;
        }
        actionInput.value = 'delete';
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      });
    }

    builderEl.addEventListener('click', (event) => {
      const actionEl = event.target.closest('[data-action]');
      if (!actionEl) {
        return;
      }
      const action = actionEl.dataset.action;
      if (action === 'add-section') {
        schema.push(defaultSection());
        render();
        updateHidden();
      } else if (action === 'add-item') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        schema[sectionIdx].items.push(defaultItem());
        render();
        updateHidden();
      } else if (action === 'add-table') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        schema[sectionIdx].items.push(defaultTable());
        render();
        updateHidden();
      } else if (action === 'remove-section') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        if (schema.length === 1) {
          return;
        }
        schema.splice(sectionIdx, 1);
        if (!schema.length) {
          schema.push(defaultSection());
        }
        render();
        updateHidden();
      } else if (action === 'remove-item') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        const itemIdx = Number(actionEl.dataset.item || 0);
        const items = schema[sectionIdx].items;
        if (items.length === 1) {
          if (schema.length === 1) {
            return;
          }
          items.splice(itemIdx, 1);
          if (!items.length) {
            items.push(defaultItem());
          }
        } else {
          items.splice(itemIdx, 1);
        }
        render();
        updateHidden();
      } else if (action === 'upload-image') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        const itemIdx = actionEl.dataset.item !== undefined ? Number(actionEl.dataset.item) : null;
        pendingImageTarget = { scope: actionEl.dataset.scope, sectionIdx, itemIdx };
        if (filePicker) {
          filePicker.value = '';
          filePicker.click();
        }
      } else if (action === 'clear-image') {
        const sectionIdx = Number(actionEl.dataset.section || 0);
        const itemIdx = actionEl.dataset.item !== undefined ? Number(actionEl.dataset.item) : null;
        if (actionEl.dataset.scope === 'section') {
          schema[sectionIdx].display_image = '';
        } else if (actionEl.dataset.scope === 'item') {
          const item = schema[sectionIdx].items[itemIdx];
          if (item) {
            item.display_image = '';
          }
        }
        render();
        updateHidden();
      }
    });

    builderEl.addEventListener('focusin', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement) || !target.dataset) {
        return;
      }
      const suggestion = target.getAttribute('data-suggestion');
      if (!suggestion || target.value !== suggestion) {
        return;
      }
      const scope = target.dataset.scope;
      const field = target.dataset.field;
      if (!scope || !field) {
        return;
      }
      const sectionIdx = Number(target.dataset.section || 0);
      if (scope === 'section' && field === 'section') {
        const section = schema[sectionIdx];
        if (section) {
          section.section = '';
          placeholderSections.delete(section);
        }
      } else if (scope === 'item' && field === 'label') {
        const itemIdx = Number(target.dataset.item || 0);
        const item = schema[sectionIdx]?.items?.[itemIdx];
        if (item) {
          item.label = '';
          placeholderItems.delete(item);
        }
      }
      target.value = '';
      target.removeAttribute('data-suggestion');
      updateHidden();
    });

    builderEl.addEventListener('input', (event) => {
      const scope = event.target.dataset.scope;
      const field = event.target.dataset.field;
      if (!scope || !field) {
        return;
      }
      const sectionIdx = Number(event.target.dataset.section || 0);
      if (scope === 'section') {
        if (field === 'section') {
          schema[sectionIdx].section = event.target.value;
          if (placeholderSections.has(schema[sectionIdx]) && event.target.value !== 'New Section') {
            placeholderSections.delete(schema[sectionIdx]);
          }
        } else if (field === 'display_image') {
          schema[sectionIdx].display_image = event.target.value.trim();
        }
        updateHidden();
        return;
      }

      const itemIdx = Number(event.target.dataset.item || 0);
      const item = schema[sectionIdx].items[itemIdx];
      if (!item) {
        return;
      }

      if (field === 'label') {
        item.label = event.target.value;
        if (placeholderItems.has(item) && event.target.value !== (item.type === 'table' ? 'New Table' : 'New Checklist Item')) {
          placeholderItems.delete(item);
        }
      } else if (field === 'options') {
        item.options = event.target.value.split('\n').map((value) => value.trim()).filter(Boolean);
        if (!item.options.length) {
          item.options = ['OK', 'Not OK', 'Need Client Input'];
        }
      } else if (field === 'display_image') {
        item.display_image = event.target.value.trim();
      } else if (field === 'rows') {
        item.rows = event.target.value.split('\n').map((value) => value.trim()).filter(Boolean);
        if (!item.rows.length) {
          item.rows = ['Row 1', 'Row 2'];
        }
      } else if (field === 'columns') {
        item.columns = event.target.value.split('\n').map((value) => value.trim()).filter(Boolean);
        if (!item.columns.length) {
          item.columns = ['Column 1', 'Column 2'];
        }
      }
      updateHidden();
    });

    builderEl.addEventListener('change', (event) => {
      const scope = event.target.dataset.scope;
      const field = event.target.dataset.field;
      if (scope !== 'item' || !field) {
        return;
      }
      const sectionIdx = Number(event.target.dataset.section || 0);
      const itemIdx = Number(event.target.dataset.item || 0);
      const item = schema[sectionIdx].items[itemIdx];
      if (!item) {
        return;
      }
      let requiresRender = false;
      if (field === 'type') {
        const newType = event.target.value;
        if (newType === 'table') {
          const defaults = defaultTable();
          item.type = 'table';
          item.options = [];
          item.allow_photo = false;
          item.allow_remark = false;
          item.photo_required_if_ng = false;
          item.rows = Array.isArray(item.rows) && item.rows.length ? item.rows : defaults.rows.slice();
          item.columns = Array.isArray(item.columns) && item.columns.length ? item.columns : defaults.columns.slice();
        } else {
          const allowed = ['select', 'text', 'textarea'];
          item.type = allowed.includes(newType) ? newType : 'select';
          if (item.type === 'select') {
            if (!item.options || !item.options.length) {
              item.options = ['OK', 'Not OK', 'Need Client Input'];
            }
            if (typeof item.allow_photo !== 'boolean') {
              item.allow_photo = true;
            }
          } else {
            item.options = [];
            item.photo_required_if_ng = false;
          }
          if (item.type !== 'select') {
            item.allow_photo = Boolean(item.allow_photo && item.type !== 'table');
          }
          item.rows = [];
          item.columns = [];
        }
        requiresRender = true;
      } else if (field === 'required') {
        item.required = event.target.checked;
      } else if (field === 'allow_photo') {
        item.allow_photo = event.target.checked;
        if (!item.allow_photo) {
          item.photo_required_if_ng = false;
        }
        requiresRender = true;
      } else if (field === 'photo_required_if_ng') {
        item.photo_required_if_ng = event.target.checked;
      } else if (field === 'allow_remark') {
        item.allow_remark = event.target.checked;
      }
      if (requiresRender) {
        render();
      }
      updateHidden();
    });

    if (filePicker) {
      filePicker.addEventListener('change', (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file || !pendingImageTarget) {
          pendingImageTarget = null;
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          if (pendingImageTarget.scope === 'section') {
            schema[pendingImageTarget.sectionIdx].display_image = dataUrl;
          } else if (pendingImageTarget.scope === 'item') {
            const item = schema[pendingImageTarget.sectionIdx].items[pendingImageTarget.itemIdx];
            if (item) {
              item.display_image = dataUrl;
            }
          }
          pendingImageTarget = null;
          render();
          updateHidden();
          showFeedback('Image attached successfully.', 'success');
        };
        reader.onerror = () => {
          showFeedback('Unable to read the selected image.', 'error');
          pendingImageTarget = null;
        };
        reader.readAsDataURL(file);
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const payload = getSerializedSchema();
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(payload);
            showFeedback('Schema copied to clipboard.', 'success');
            return;
          }
          throw new Error('Clipboard API unavailable');
        } catch (err) {
          try {
            const tempArea = document.createElement('textarea');
            tempArea.value = payload;
            tempArea.setAttribute('readonly', '');
            tempArea.style.position = 'absolute';
            tempArea.style.left = '-9999px';
            document.body.appendChild(tempArea);
            tempArea.select();
            const copied = document.execCommand('copy');
            document.body.removeChild(tempArea);
            if (copied) {
              showFeedback('Schema copied to clipboard.', 'success');
            } else {
              throw new Error('Copy failed');
            }
          } catch (fallbackErr) {
            console.warn('Copy failed', fallbackErr);
            showFeedback('Copy failed. Download the JSON instead.', 'error');
          }
        }
      });
    }

    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        const payload = getSerializedSchema();
        try {
          const blob = new Blob([payload], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const formName = form.querySelector('input[name="name"]').value || 'srt-template';
          const filename = formName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'srt-template';
          link.href = url;
          link.download = `${filename}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showFeedback('Downloaded schema JSON.', 'success');
        } catch (err) {
          console.error('Download failed', err);
          showFeedback('Download failed. Please try again.', 'error');
        }
      });
    }

    const renderPreviewItem = (item) => {
      if (!item || typeof item !== 'object') {
        return '';
      }

      if (item.type === 'table') {
        const rows = Array.isArray(item.rows) && item.rows.length ? item.rows : ['Row 1', 'Row 2'];
        const columns = Array.isArray(item.columns) && item.columns.length ? item.columns : ['Column 1', 'Column 2'];
        const headerCells = columns
          .map((col) => `<th class="px-3 py-2 border-b border-slate-800 text-left">${escapeHtml(col)}</th>`)
          .join('');
        const bodyRows = rows
          .map((row) => {
            const cells = columns
              .map(() => '<td class="px-3 py-2 border-t border-slate-800 text-slate-500">—</td>')
              .join('');
            return `<tr><th class="px-3 py-2 border-t border-r border-slate-800 text-left font-medium text-slate-200">${escapeHtml(row)}</th>${cells}</tr>`;
          })
          .join('');
        const badges = [];
        if (item.required) {
          badges.push('<span class="rounded-full bg-slate-800/80 px-2 py-1">All cells required</span>');
        }
        const badgesMarkup = badges.join('');
        const itemImage = item.display_image
          ? `<div class="md:w-40 shrink-0"><img src="${escapeHtml(item.display_image)}" alt="Reference for ${escapeHtml(item.label || 'table grid')}" class="w-full rounded-xl border border-slate-800 object-cover"></div>`
          : '';
        return `
          <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
            <div class="flex flex-col md:flex-row md:items-start md:gap-4">
              <div class="flex-1 space-y-3">
                <div>
                  <p class="text-sm font-semibold text-slate-100 flex items-center gap-2">
                    ${escapeHtml(item.label || 'Table grid')}
                    ${item.required ? '<span class="text-rose-400">*</span>' : ''}
                  </p>
                  ${badgesMarkup ? `<div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-wide text-slate-300">${badgesMarkup}</div>` : ''}
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-800">
                  <table class="min-w-[320px] w-full text-left text-xs text-slate-200">
                    <thead class="bg-slate-950/40">
                      <tr>
                        <th class="px-3 py-2 border-b border-slate-800">Row</th>
                        ${headerCells}
                      </tr>
                    </thead>
                    <tbody>
                      ${bodyRows}
                    </tbody>
                  </table>
                </div>
              </div>
              ${itemImage}
            </div>
          </div>
        `;
      }

      const typeLabels = {
        select: 'Choice list',
        text: 'Short text',
        textarea: 'Long text',
      };
      const typeLabel = typeLabels[item.type] || 'Choice list';
      const badges = [];
      if (item.required) {
        badges.push('<span class="rounded-full bg-slate-800/80 px-2 py-1">Required</span>');
      }
      if (item.allow_photo) {
        badges.push(
          `<span class="rounded-full bg-slate-800/80 px-2 py-1">${item.photo_required_if_ng ? 'Photo required on Not OK' : 'Photo allowed'}</span>`
        );
      }
      if (item.allow_remark) {
        badges.push('<span class="rounded-full bg-slate-800/80 px-2 py-1">Remarks allowed</span>');
      }
      const badgesMarkup = badges.join('');

      let bodyContent = '';
      if (item.type === 'select') {
        const options = Array.isArray(item.options) && item.options.length
          ? item.options
          : ['OK', 'Not OK', 'Need Client Input'];
        const optionMarkup = options
          .map((opt) => `<li class="px-3 py-1 rounded-lg border border-slate-700/60 bg-slate-800/70 text-xs text-slate-200">${escapeHtml(opt)}</li>`)
          .join('');
        bodyContent = `<div><p class="text-xs text-slate-400 mb-1">Options</p><div class="flex flex-wrap gap-2">${optionMarkup}</div></div>`;
      } else if (item.type === 'text') {
        bodyContent = '<p class="text-xs text-slate-400">Technicians will enter a short, single-line response.</p>';
      } else {
        bodyContent = '<p class="text-xs text-slate-400">Technicians will enter a longer note across multiple lines.</p>';
      }

      const itemImage = item.display_image
        ? `<div class="md:w-40 shrink-0"><img src="${escapeHtml(item.display_image)}" alt="Reference for ${escapeHtml(item.label || 'check item')}" class="w-full rounded-xl border border-slate-800 object-cover"></div>`
        : '';

      return `
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
          <div class="flex flex-col md:flex-row md:items-start md:gap-4">
            <div class="flex-1 space-y-3">
              <div>
                <p class="text-sm font-semibold text-slate-100 flex items-center gap-2">
                  ${escapeHtml(item.label || 'Checklist item')}
                  ${item.required ? '<span class="text-rose-400">*</span>' : ''}
                </p>
                <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-wide text-slate-300">
                  <span class="rounded-full bg-slate-800/80 px-2 py-1">${escapeHtml(typeLabel)}</span>
                  ${badgesMarkup}
                </div>
              </div>
              ${bodyContent}
            </div>
            ${itemImage}
          </div>
        </div>
      `;
    };

    const renderPreviewSections = (sections) => {
      if (!Array.isArray(sections) || !sections.length) {
        return '<p class="text-sm text-slate-400">No sections configured yet.</p>';
      }
      return sections
        .map((section) => {
          const heading = section.section
            ? `<div class="flex items-center gap-3"><div class="w-1.5 h-6 rounded-full bg-emerald-500/60"></div><h4 class="text-sm font-semibold text-slate-100">${escapeHtml(section.section)}</h4></div>`
            : '';
          const sectionImage = section.display_image
            ? `<div class="rounded-xl border border-slate-800/70 bg-slate-900/50 p-3"><img src="${escapeHtml(section.display_image)}" alt="Section reference" class="w-full max-w-xs rounded-lg object-cover"></div>`
            : '';
          const headerMarkup = heading || sectionImage
            ? `<div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4"><div class="space-y-3 flex-1">${heading}${sectionImage ? sectionImage : ''}</div></div>`
            : '';
          const itemsMarkup = Array.isArray(section.items) && section.items.length
            ? section.items.map((item) => renderPreviewItem(item)).join('')
            : '<p class="text-sm text-slate-400">No checklist items in this section yet.</p>';
          return `
            <section class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
              ${headerMarkup}
              <div class="space-y-4">
                ${itemsMarkup}
              </div>
            </section>
          `;
        })
        .join('');
    };

    const closePreview = () => {
      if (!previewOverlay) {
        return;
      }
      previewOverlay.classList.add('hidden');
      previewOverlay.classList.remove('flex');
      if (previewBody) {
        previewBody.innerHTML = previewEmptyState;
      }
    };

    const openPreview = (config) => {
      if (!previewOverlay) {
        return;
      }
      const normalised = normaliseSchema(config.schema);
      if (previewTitle) {
        previewTitle.textContent = config.name?.trim() ? config.name.trim() : 'Untitled template';
      }
      if (previewDescription) {
        const desc = config.description?.trim();
        previewDescription.textContent = desc ? desc : 'No description provided.';
      }
      if (previewMeta) {
        const metaParts = [];
        const categoryLabel = config.category?.trim();
        const updatedLabel = config.lastUpdatedLabel?.trim();
        if (categoryLabel) {
          metaParts.push(`Category: ${categoryLabel}`);
        }
        if (updatedLabel) {
          metaParts.push(`Last updated: ${updatedLabel}`);
        }
        previewMeta.textContent = metaParts.join(' • ');
      }
      if (previewBody) {
        previewBody.innerHTML = renderPreviewSections(normalised);
      }
      previewOverlay.classList.remove('hidden');
      previewOverlay.classList.add('flex');
    };

    if (previewOverlay) {
      previewOverlay.querySelectorAll('[data-preview-close]').forEach((button) => {
        button.addEventListener('click', closePreview);
      });
    }

    document.querySelectorAll('[data-preview-open]').forEach((button) => {
      button.addEventListener('click', () => {
        const schemaAttr = button.getAttribute('data-template-schema');
        let parsedSchema = [];
        if (schemaAttr) {
          try {
            parsedSchema = JSON.parse(schemaAttr);
          } catch (err) {
            parsedSchema = [];
          }
        }
        openPreview({
          name: button.getAttribute('data-template-name') || '',
          category: button.getAttribute('data-template-category') || '',
          description: button.getAttribute('data-template-description') || '',
          lastUpdatedLabel: button.getAttribute('data-template-updated-label') || '',
          schema: parsedSchema,
        });
      });
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') {
        return;
      }
      if (previewOverlay && previewOverlay.classList.contains('flex')) {
        closePreview();
        return;
      }
      if (designerOverlay.classList.contains('flex')) {
        closeDesigner();
      }
    });

    form.addEventListener('submit', () => {
      updateHidden();
    });
  });
</script>
{% endblock %}
