{% extends "base.html" %}
{% block title %}Eleva ERP – Lift {{ lift.lift_code }}{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400"><a href="{{ url_for('service_lifts') }}" class="text-emerald-200 hover:text-emerald-100">Lifts</a> · Overview</p>
      <h1 class="text-2xl font-semibold text-theme-primary">Lift {{ lift.lift_code }}</h1>
      <p class="text-sm text-slate-400">{{ lift.lift_type or 'Type not set' }} · {{ lift.capacity_display or 'Capacity not set' }}</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('service_lifts') }}" class="rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Back to lifts</a>
      <a href="{{ url_for('service_contract_new', lift_id=lift.id) }}" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">Create AMC contract</a>
      {% if current_user.is_admin %}
        <form method="post" action="{{ url_for('service_lift_delete', lift_id=lift.id) }}" class="inline-flex" onsubmit="return confirm('Delete lift {{ lift.lift_code }}? This action cannot be undone.');">
          {{ csrf_field() }}
          <input type="hidden" name="next" value="{{ url_for('service_lifts') }}" />
          <button type="submit" class="rounded-xl border border-rose-500/50 bg-rose-500/10 px-3 py-2 text-xs font-semibold text-rose-200 transition hover:bg-rose-500/20">Delete lift</button>
        </form>
      {% endif %}
    </div>
  </header>

  <div class="space-y-6">
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Lift · {{ lift.lift_code }}</p>
          <h2 class="text-xl font-semibold text-theme-primary">
            {% if payload.site_lines %}
              {{ payload.site_lines[0] }}
            {% else %}
              {{ lift.site_address_line1 or 'Site details unavailable' }}
            {% endif %}
          </h2>
          {% if lift.external_lift_id %}
            <div class="mt-2 text-xs text-slate-400">
              <div>External ID: {{ lift.external_lift_id }}</div>
            </div>
          {% endif %}
        </div>
        <div class="flex flex-col items-end gap-2 text-right text-xs text-slate-400">
          <div><span class="font-semibold text-slate-100">Status:</span> <span class="text-emerald-200">{{ lift.status or 'Not captured' }}</span></div>
          <div><span class="font-semibold text-slate-100">AMC status:</span> <span class="text-emerald-200">{{ payload.amc.status }}</span></div>
          {% if payload.is_under_warranty %}
            <div class="rounded-xl border border-cyan-400/40 bg-cyan-400/10 px-3 py-1 text-xs font-semibold text-cyan-200">Under warranty</div>
          {% endif %}
          {% if payload.preferred_service_summary %}
            <div class="rounded-xl border border-amber-400/40 bg-amber-400/10 px-3 py-1 text-xs font-semibold text-amber-200">Preferred PM: {{ payload.preferred_service_summary }}</div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold text-theme-primary">Lift lifetime value</h2>
          <p class="text-xs text-slate-400">Revenue, cost and breakdown highlights.</p>
        </div>
      </div>
      <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 text-sm shadow-sm">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">
            Next AMC / preventive visit
          </p>

          {% if lift.next_amc_date %}
            <p class="mt-1 text-lg font-semibold text-slate-100">
              {{ lift.next_amc_date.strftime("%d %b %Y") }}
            </p>
            <p class="mt-1 text-xs text-slate-400">
              Status:
              {% if lift.amc_due_status == "overdue" %}
                <span class="inline-flex items-center rounded-full bg-rose-500/15 px-2 py-0.5 text-xs font-medium text-rose-300">
                  Overdue
                </span>
              {% elif lift.amc_due_status == "due_today" %}
                <span class="inline-flex items-center rounded-full bg-amber-500/15 px-2 py-0.5 text-xs font-medium text-amber-300">
                  Due today
                </span>
              {% elif lift.amc_due_status == "due_this_week" %}
                <span class="inline-flex items-center rounded-full bg-sky-500/15 px-2 py-0.5 text-xs font-medium text-sky-300">
                  Due this week
                </span>
              {% else %}
                <span class="inline-flex items-center rounded-full bg-emerald-500/15 px-2 py-0.5 text-xs font-medium text-emerald-300">
                  Upcoming
                </span>
              {% endif %}
            </p>
          {% else %}
            <p class="mt-1 text-sm text-slate-400">
              No upcoming preventive visit is scheduled for this lift.
            </p>
          {% endif %}

          <div class="mt-3">
            <a href="{{ url_for('service_preventive_maintenance') }}"
               class="inline-flex items-center text-xs text-emerald-300 hover:text-emerald-200 transition">
              Open preventive planner &rarr;
            </a>
          </div>
        </div>

        {% if can_see_commercial %}
          {% for metric in payload.lifetime_metrics %}
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-400">{{ metric.label }}</p>
              <p class="mt-2 text-lg font-semibold text-emerald-200">{{ metric.display }}</p>
            </div>
          {% else %}
            <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No lifetime metrics captured yet.</p>
          {% endfor %}
        {% else %}
          <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">Commercial details are restricted.</p>
        {% endif %}
      </div>
    </section>

    

    <div class="grid gap-6 lg:grid-cols-2">
      <section id="service-schedule" class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">Lift summary details</h2>
            <button type="button" data-modal-open="lift-summary" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Edit lift summary</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <dl class="grid gap-4 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Lift code / ID</dt>
              <dd class="text-sm text-slate-100">{{ lift.lift_code }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">External lift ID</dt>
              <dd class="text-sm text-slate-100">{{ payload.external_lift_id }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Customer name</dt>
              <dd class="text-sm text-slate-100">{{ lift.customer.company_name if lift.customer else '—' }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Customer code</dt>
              <dd class="text-sm text-slate-100">{{ payload.customer_code }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Site name</dt>
              <dd class="text-sm text-slate-100">{{ payload.site_lines[0] if payload.site_lines else '—' }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Building / Villa no.</dt>
              <dd class="text-sm text-slate-100">{{ payload.building_villa_number }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Building name / road</dt>
              <dd class="text-sm text-slate-100">{{ payload.site_address_line2 }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">City</dt>
              <dd class="text-sm text-slate-100">{{ payload.city }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">State</dt>
              <dd class="text-sm text-slate-100">{{ payload.state }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Pincode</dt>
              <dd class="text-sm text-slate-100">{{ payload.pincode }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Geo location</dt>
              <dd class="text-sm text-slate-100">{{ payload.geo_location }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Completion date</dt>
              <dd class="text-sm text-slate-100">{{ payload.install_date_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Handover date</dt>
              <dd class="text-sm text-slate-100">{{ payload.commissioned_date_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Warranty start</dt>
              <dd class="text-sm text-slate-100">{{ payload.warranty_start_date_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Warranty end</dt>
              <dd class="text-sm text-slate-100">{{ payload.warranty_end_date_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Warranty expiry (legacy)</dt>
              <dd class="text-sm text-slate-100">{{ payload.warranty_expiry_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">QR code</dt>
              <dd class="text-sm text-slate-100">
                {% if payload.qr_code_url %}
                  <a href="{{ payload.qr_code_url }}" class="font-semibold text-emerald-200 hover:text-emerald-100" target="_blank" rel="noopener">Open QR code</a>
                {% else %}
                  —
                {% endif %}
              </dd>
            </div>
          </dl>
        </div>
      </section>
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">Lift specifications</h2>
            <button type="button" data-modal-open="lift-specs" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Edit lift specifications</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <dl class="grid gap-4 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Type</dt>
              <dd class="text-sm text-slate-100">{{ lift.lift_type or '—' }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Brand</dt>
              <dd class="text-sm text-slate-100">{{ lift.lift_brand or '—' }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Floors served</dt>
              <dd class="text-sm text-slate-100">{{ payload.floors_served }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Capacity (persons / kg)</dt>
              <dd class="text-sm text-slate-100">{{ payload.capacity_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Speed</dt>
              <dd class="text-sm text-slate-100">{{ payload.speed_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Door type</dt>
              <dd class="text-sm text-slate-100">{{ payload.door_type }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Door finish</dt>
              <dd class="text-sm text-slate-100">{{ payload.door_finish }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Cabin finish</dt>
              <dd class="text-sm text-slate-100">{{ payload.cabin_finish }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Machine type</dt>
              <dd class="text-sm text-slate-100">{{ payload.machine_type }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Machine brand</dt>
              <dd class="text-sm text-slate-100">{{ payload.machine_brand }}</dd>
            </div>
            <div class="sm:col-span-2">
              <dt class="text-xs uppercase tracking-wide text-slate-400">Machine details</dt>
              <dd class="text-sm text-slate-100">{{ payload.machine_details_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Power supply</dt>
              <dd class="text-sm text-slate-100">{{ payload.power_supply }}</dd>
            </div>
            <div class="sm:col-span-2">
              <dt class="text-xs uppercase tracking-wide text-slate-400">Lift remarks</dt>
              <dd class="text-sm text-slate-300 whitespace-pre-line">{{ lift.remarks or 'No remarks added yet.' }}</dd>
            </div>
          </dl>
        </div>
      </section>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">AMC details</h2>
            <button type="button" data-modal-open="lift-amc" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Edit AMC details</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <dl class="grid gap-4 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Status</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.status }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">AMC type</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.type }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">AMC duration</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.duration_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Contract</dt>
              <dd class="text-sm text-slate-100">
                {% if payload.amc.contract %}
                  <a href="{{ payload.amc.contract.url }}" class="font-semibold text-emerald-200 hover:text-emerald-100" target="_blank" rel="noopener">{{ payload.amc.contract.id }}</a>
                  <div class="text-xs text-slate-400">{{ payload.amc.contract.type or '—' }}{% if payload.amc.contract.coverage %} · {{ payload.amc.contract.coverage }}{% endif %}</div>
                {% else %}
                  —
                {% endif %}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">AMC start</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.start_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">AMC end</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.end_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Contract value</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.contract_value_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Payment terms</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.payment_terms }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Route</dt>
              <dd class="text-sm text-slate-100">{{ payload.route_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Services per year</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.services_per_year }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Pending services</dt>
              <dd class="text-sm text-slate-100">{{ payload.amc.pending_services_count }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Preferred PM date</dt>
              <dd class="text-sm text-slate-100">{{ payload.preferred_service_date_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Preferred PM day</dt>
              <dd class="text-sm text-slate-100">{{ payload.preferred_service_day_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Preferred PM time</dt>
              <dd class="text-sm text-slate-100">{{ payload.preferred_service_time_display }}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">Last service date</dt>
              <dd class="text-sm text-slate-100">{{ payload.last_service_date_display }}</dd>
            </div>
            <div class="sm:col-span-2">
              <dt class="text-xs uppercase tracking-wide text-slate-400">Service remarks</dt>
              <dd class="text-sm text-slate-300 whitespace-pre-line">{{ payload.service_notes or 'No service remarks added yet.' }}</dd>
            </div>
          </dl>
        </div>
      </section>
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">AMC contact details</h2>
            <button type="button" data-modal-open="lift-contacts" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Edit AMC contacts</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <div class="flex-1 overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800 text-sm">
              <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
                <tr>
                  <th class="px-4 py-2 text-left">Name</th>
                  <th class="px-4 py-2 text-left">Designation</th>
                  <th class="px-4 py-2 text-left">Contact no.</th>
                  <th class="px-4 py-2 text-left">Email</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800/80 text-slate-200">
                {% for contact in payload.amc.contacts %}
                  <tr>
                    <td class="px-4 py-2">{{ contact.name }}</td>
                    <td class="px-4 py-2">{{ contact.designation }}</td>
                    <td class="px-4 py-2">{{ contact.phone }}</td>
                    <td class="px-4 py-2">{{ contact.email }}</td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="4" class="px-4 py-4 text-center text-sm text-slate-400">No AMC contacts captured yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-theme-primary">Service schedule</h2>
              <p class="text-xs text-slate-400">Planned preventive visits for the current AMC period.</p>
            </div>
            <button
              type="button"
              data-modal-open="lift-service-schedule"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 transition hover:bg-slate-800/70"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                <path d="M10.75 3.5a.75.75 0 0 0-1.5 0V9.25H3.5a.75.75 0 0 0 0 1.5H9.25V16.5a.75.75 0 0 0 1.5 0V10.75H16.5a.75.75 0 0 0 0-1.5H10.75V3.5Z" />
              </svg>
              Edit schedule
            </button>
          </div>
          <div class="flex-1 overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800 text-sm">
              <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
                <tr>
                  <th class="px-4 py-2 text-left">Service date</th>
                  <th class="px-4 py-2 text-left">Route</th>
                  <th class="px-4 py-2 text-left">Status</th>
                  <th class="px-4 py-2 text-left">Service slip</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800/80 text-slate-200">
                {% if payload.service_schedule %}
                  {% for visit in payload.service_schedule %}
                    <tr>
                      <td class="px-4 py-2 font-semibold text-slate-100">{{ visit.date_display }}</td>
                      <td class="px-4 py-2 text-sm">
                        <span class="text-xs text-slate-400">{{ visit.route_display }}</span>
                      </td>
                      <td class="px-4 py-2">
                        {% set badge_class = 'border border-slate-700/70 bg-slate-800/60 text-slate-200' %}
                        {% if visit.status_key == 'completed' %}
                          {% set badge_class = 'border border-emerald-400/40 bg-emerald-400/10 text-emerald-200' %}
                        {% elif visit.status_key == 'overdue' %}
                          {% set badge_class = 'border border-rose-400/40 bg-rose-400/10 text-rose-200' %}
                        {% endif %}
                        <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold {{ badge_class }}">{{ visit.status_display }}</span>
                      </td>
                      <td class="px-4 py-2">
                        {% if visit.slip_url %}
                          <a
                            href="{{ visit.slip_url }}"
                            target="_blank"
                            rel="noopener"
                            class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 bg-slate-800/60 text-slate-300 transition hover:text-emerald-200"
                            title="Download service report"
                          >
                            <span class="sr-only">Download service report</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke="currentColor" class="h-4 w-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v11m0 0 4-4m-4 4-4-4M5 15v4h14v-4" />
                            </svg>
                          </a>
                        {% else %}
                          <span class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-800 bg-slate-900/70 text-slate-500" style="opacity: 0.35; cursor: not-allowed; pointer-events: none;" title="Service report will be available soon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.7" stroke="currentColor" class="h-4 w-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v11m0 0 4-4m-4 4-4-4M5 15v4h14v-4" />
                            </svg>
                          </span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="4" class="px-4 py-6 text-center text-sm text-slate-400">No service visits planned for this AMC period yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">Breakdown Summary</h2>
          </div>
          <div class="flex-1 overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800 text-sm">
              <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
                <tr>
                  <th class="px-4 py-2 text-left">Date</th>
                  <th class="px-4 py-2 text-left">Breakdown type</th>
                  <th class="px-4 py-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800/80 text-slate-200">
                {% if payload.breakdown_summary %}
                  {% for summary in payload.breakdown_summary %}
                    {% set status_key = summary.status_key or summary.status|lower|replace(' ', '_') %}
                    {% set badge_class = 'border border-slate-700/70 bg-slate-800/60 text-slate-200' %}
                    {% if status_key == 'fixed' %}
                      {% set badge_class = 'border border-emerald-400/40 bg-emerald-400/10 text-emerald-200' %}
                    {% elif status_key in ['in_progress', 'in-progress'] %}
                      {% set badge_class = 'border border-amber-400/40 bg-amber-400/10 text-amber-200' %}
                    {% elif status_key == 'open' %}
                      {% set badge_class = 'border border-rose-400/40 bg-rose-400/10 text-rose-200' %}
                    {% elif status_key == 'accounts_clearance' %}
                      {% set badge_class = 'border border-sky-400/40 bg-sky-400/10 text-sky-200' %}
                    {% endif %}
                    <tr
                      data-breakdown-entry
                      data-breakdown-date="{{ summary.date_display }}"
                      data-breakdown-date-iso="{{ summary.date_iso }}"
                      data-breakdown-type="{{ summary.type|e }}"
                      data-breakdown-status="{{ summary.status|e }}"
                      data-breakdown-status-key="{{ status_key }}"
                      data-breakdown-description="{{ summary.description|e }}"
                      data-breakdown-reference="{{ summary.call_reference|e }}"
                      data-breakdown-reported-by="{{ (summary.reported_by or '')|e }}"
                      tabindex="0"
                      class="cursor-pointer transition hover:bg-slate-800/40 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400/60 focus-visible:ring-offset-0"
                    >
                      <td class="px-4 py-2 font-semibold text-slate-100">{{ summary.date_display }}</td>
                      <td class="px-4 py-2">{{ summary.type }}</td>
                      <td class="px-4 py-2">
                        <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold {{ badge_class }}">{{ summary.status or '—' }}</span>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="3" class="px-4 py-6 text-center text-sm text-slate-400">No breakdown updates recorded yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">Comments</h2>
            <button type="button" data-modal-open="lift-comments" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Add comment</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <div class="flex-1 space-y-3 overflow-y-auto pr-1">
            {% if comments %}
              <ul class="space-y-3">
                {% for comment in comments %}
                  <li class="space-y-2 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                      <span class="text-sm font-semibold text-slate-100">{{ comment.author_name }}</span>
                      <span class="text-xs text-slate-400">{{ comment.created_display }}</span>
                    </div>
                    <p class="text-sm text-slate-200 whitespace-pre-line">{{ comment.body }}</p>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No comments recorded yet.</p>
            {% endif %}
          </div>
        </div>
      </section>
      <section class="h-full rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex h-full flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-theme-primary">Attachments</h2>
            <button type="button" data-modal-open="lift-attachments" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
              <span class="sr-only">Upload attachment</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
              </svg>
            </button>
          </div>
          <div class="flex-1 space-y-3 overflow-y-auto pr-1">
            {% if attachments %}
              <ul class="space-y-3 text-sm text-slate-200">
                {% for attachment in attachments %}
                  <li class="space-y-2 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                      <a href="{{ url_for('static', filename=attachment.stored_path) }}" class="font-semibold text-emerald-200 hover:text-emerald-100" target="_blank" rel="noopener">{{ attachment.display_label }}</a>
                      <span class="text-xs text-slate-400">{{ attachment.uploaded_display }}</span>
                    </div>
                    <div class="text-xs text-slate-400">
                      {{ attachment.display_size }}
                      {% if attachment.uploaded_by %}
                        · Uploaded by {{ attachment.uploaded_by.display_name }}
                      {% endif %}
                    </div>
                    {% if attachment.description %}
                      <p class="text-sm text-slate-300">{{ attachment.description }}</p>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No attachments uploaded yet.</p>
            {% endif %}
          </div>
        </div>
      </section>
    </div>

    <section class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-theme-primary">Timeline</h2>
        <button type="button" data-modal-open="lift-timeline" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400 hover:text-emerald-200">
          <span class="sr-only">Add timeline entry</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25a2 2 0 0 1-.878.506l-3.464.866a.75.75 0 0 1-.91-.91l.866-3.464a2 2 0 0 1 .506-.878l8.25-8.25Zm1.414 1.414L6.75 13.25a.5.5 0 0 0-.127.223l-.43 1.722 1.722-.43a.5.5 0 0 0 .223-.127l8.25-8.25a1 1 0 0 0-1.414-1.414ZM4 17a.75.75 0 0 1 0-1.5h12a.75.75 0 0 1 0 1.5H4Z" />
          </svg>
        </button>
      </div>
      <ul class="space-y-3">
        {% for entry in payload.timeline %}
          <li class="rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
            <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
              <div class="flex flex-wrap items-center gap-2">
                <span class="rounded-full border border-slate-700/70 bg-slate-800/70 px-2 py-0.5 text-xs uppercase tracking-wide text-slate-400">{{ entry.category }}</span>
                <span class="text-sm font-semibold text-slate-100">{{ entry.title }}</span>
                {% if entry.actor_label or entry.actor_name %}
                  <span class="rounded-full bg-slate-800/70 px-2 py-1 text-xs text-slate-300">{{ entry.actor_label or entry.actor_name }}</span>
                {% endif %}
              </div>
              <span class="text-xs text-slate-400 sm:pt-1">{{ entry.date_display }}</span>
            </div>
            {% if entry.detail %}
              <p class="mt-2 text-sm text-slate-300">{{ entry.detail }}</p>
            {% endif %}
          </li>
        {% else %}
          <li class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No activity has been recorded for this lift yet.</li>
        {% endfor %}
      </ul>
    </section>
  </div>
</div>
<dialog id="liftSummaryModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="w-full max-w-4xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit lift summary</h2>
        <p class="text-xs text-slate-400">Update customer linkage, site information and warranty milestones.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="summary" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift code</span>
        <input value="{{ lift.lift_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">External lift ID</span>
        <input name="external_lift_id" value="{{ lift.external_lift_id or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
        <input name="customer_code" value="{{ lift.customer_code or '' }}" list="customerCodeOptions" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Search customer code" />
        <datalist id="customerCodeOptions">
          {% for customer in customers %}
            <option value="{{ customer.customer_code }}" label="{{ customer.company_name }}"></option>
          {% endfor %}
        </datalist>
        <p class="text-xs text-slate-300">Type to select a linked customer by code.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building / Villa no.</span>
        <input name="building_villa_number" value="{{ lift.building_villa_number or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building name, road, area</span>
        <input name="site_address_line2" value="{{ lift.site_address_line2 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="city" value="{{ lift.city or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="state" value="{{ lift.state or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="pincode" value="{{ lift.pincode or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Geo location</span>
        <input name="geo_location" value="{{ lift.geo_location or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. 15.4969, 73.8278" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Completion date</span>
        <input type="date" name="install_date" value="{{ lift.install_date.isoformat() if lift.install_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Warranty start date</span>
        <input type="date" name="warranty_start_date" value="{{ lift.warranty_start_date.isoformat() if lift.warranty_start_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Warranty end date</span>
        <input type="date" name="warranty_end_date" value="{{ lift.warranty_end_date.isoformat() if lift.warranty_end_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Warranty expiry</span>
        <input type="date" name="warranty_expiry" value="{{ lift.warranty_expiry.isoformat() if lift.warranty_expiry else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">QR code URL</span>
        <input type="url" name="qr_code_url" value="{{ lift.qr_code_url or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save summary</button>
    </div>
  </form>
</dialog>
<dialog id="liftSpecsModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="w-full max-w-4xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit lift specifications</h2>
        <p class="text-xs text-slate-400">Maintain technical specifications that service teams depend on.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="specifications" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift type</span>
        <select name="lift_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift type</option>
          {% for option in dropdown_options.get('lift_type', LIFT_TYPE_OPTIONS) %}
            {% set option_value = option.value if option.value is defined else option %}
            <option value="{{ option_value }}" {% if lift.lift_type and lift.lift_type|lower == option_value|lower %}selected{% endif %}>{{ option.label if option.label is defined else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift brand</span>
        <input name="lift_brand" value="{{ lift.lift_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. Schindler" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Floors served</span>
        <input name="building_floors" value="{{ lift.building_floors or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (persons)</span>
        <input name="capacity_persons" value="{{ lift.capacity_persons or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (kg)</span>
        <input name="capacity_kg" value="{{ lift.capacity_kg or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Speed (m/s)</span>
        <input name="speed_mps" value="{{ '%.2f'|format(lift.speed_mps) if lift.speed_mps is not none else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. 1.0" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door type</span>
        <select name="door_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door type</option>
          {% for option in dropdown_options.get('door_type', DOOR_TYPE_OPTIONS) %}
            {% set option_value = option.value if option.value is defined else option %}
            <option value="{{ option_value }}" {% if lift.door_type and lift.door_type|lower == option_value|lower %}selected{% endif %}>{{ option.label if option.label is defined else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door finish</span>
        <select name="door_finish" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door finish</option>
          {% for option in dropdown_options.get('door_finish', DOOR_FINISH_OPTIONS) %}
            {% set option_value = option.value if option.value is defined else option %}
            <option value="{{ option_value }}" {% if lift.door_finish and lift.door_finish|lower == option_value|lower %}selected{% endif %}>{{ option.label if option.label is defined else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Cabin finish</span>
        <input name="cabin_finish" value="{{ lift.cabin_finish or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine type</span>
        <select name="machine_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select machine type</option>
          {% for option in dropdown_options.get('machine_type', MACHINE_TYPE_OPTIONS) %}
            {% set option_value = option.value if option.value is defined else option %}
            <option value="{{ option_value }}" {% if lift.machine_type and lift.machine_type|lower == option_value|lower %}selected{% endif %}>{{ option.label if option.label is defined else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine brand</span>
        <input name="machine_brand" value="{{ lift.machine_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Controller brand</span>
        <input name="controller_brand" value="{{ lift.controller_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Power supply</span>
        <select name="power_supply" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select power supply</option>
          {% for option in dropdown_options.get('power_supply', POWER_SUPPLY_OPTIONS) %}
            {% set option_value = option.value if option.value is defined else option %}
            <option value="{{ option_value }}" {% if lift.power_supply and lift.power_supply|lower == option_value|lower %}selected{% endif %}>{{ option.label if option.label is defined else option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift remarks</span>
        <textarea name="remarks" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Add installation notes or reminders">{{ lift.remarks or '' }}</textarea>
      </label>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save specifications</button>
    </div>
  </form>
</dialog>
<dialog id="liftAmcModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="w-full max-w-4xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit AMC details</h2>
        <p class="text-xs text-slate-400">Control maintenance cadence, routing and key service preferences.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="amc_details" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC status</span>
        {% set amc_status_value = lift.amc_status or '' %}
        <select name="amc_status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select AMC status</option>
          {% for option in AMC_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if amc_status_value and amc_status_value|lower == option|lower %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Route</span>
        <select name="route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select route</option>
          {% for route in service_routes %}
            {% set option_value = route.state %}
            <option value="{{ option_value }}" {% if lift.route and lift.route|lower == option_value|lower %}selected{% endif %}>{{ route.display_name }}</option>
          {% endfor %}
        </select>
        {% if not service_routes %}
          <p class="text-xs text-slate-300">Add routes from Service → Service Settings to see them here.</p>
        {% endif %}
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC start date</span>
        <input type="date" name="amc_start" id="liftAmcStartDetail" value="{{ lift.amc_start.isoformat() if lift.amc_start else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC duration</span>
        {% set amc_duration_value = lift.amc_duration_key or '' %}
        <select name="amc_duration_key" id="liftAmcDurationDetail" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select duration</option>
          {% for value, label in amc_duration_choices %}
            {% if value %}
              <option value="{{ value }}" {% if amc_duration_value and amc_duration_value == value %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC end date</span>
        <input type="date" name="amc_end" id="liftAmcEndDetail" value="{{ lift.amc_end.isoformat() if lift.amc_end else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" readonly />
        <p class="text-xs text-slate-300">Auto-calculated using start date and duration.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC contract</span>
        {% set selected_contract = lift.amc_contract_id or '' %}
        <select name="amc_contract_id" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">No contract linked</option>
          {% for contract in service_contracts %}
            <option value="{{ contract.id }}" {% if selected_contract and selected_contract|lower == contract.id|lower %}selected{% endif %}>{{ contract.id }} · {{ contract.type }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift status</span>
        {% set lift_status_value = lift.status or '' %}
        <select name="status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift status</option>
          {% for option in LIFT_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if lift_status_value and lift_status_value|lower == option|lower %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Last service date</span>
        <input type="date" name="last_service_date" value="{{ lift.last_service_date.isoformat() if lift.last_service_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred PM date</span>
        {% if lift.preferred_service_date and lift.preferred_service_date.year == 2000 and lift.preferred_service_date.month == 1 %}
          {% set preferred_service_date_day = "%02d" % lift.preferred_service_date.day %}
        {% else %}
          {% set preferred_service_date_day = '' %}
        {% endif %}
        <select name="preferred_service_date" id="liftPreferredServiceDateDetail" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Any date</option>
          <option value="monthly" {% if preferred_service_date_day %}selected{% endif %}>Specific day each month</option>
        </select>
        <div id="preferredServiceDateSpecificDetail" class="{% if not preferred_service_date_day %}hidden{% endif %}">
          <input type="number" min="1" max="30" name="preferred_service_date_day" value="{{ preferred_service_date_day }}" class="mt-2 w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Day of month (1-30)" />
        </div>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred PM days</span>
        {% set selected_days = lift.preferred_service_days %}
        <select name="preferred_service_days" id="liftPreferredServiceDaysDetail" multiple size="5" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          {% for key, label in service_day_options %}
            <option value="{{ key }}" {% if key in selected_days %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred PM time</span>
        <input type="time" id="liftPreferredServiceTimeDetail" name="preferred_service_time" value="{{ lift.preferred_service_time.strftime('%H:%M') if lift.preferred_service_time else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        <label class="inline-flex items-center gap-2 text-xs text-slate-300">
          <input type="checkbox" id="liftAnyTimeDetail" class="rounded border-slate-600 bg-slate-800" {% if not lift.preferred_service_time %}checked{% endif %} />
          Any time
        </label>
      </label>
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Service remarks</span>
        <textarea name="service_notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Capture AMC scope notes, escalations or commitments">{{ lift.notes or '' }}</textarea>
      </label>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save AMC details</button>
    </div>
  </form>
</dialog>
<dialog id="liftServiceScheduleModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" enctype="multipart/form-data" class="w-full max-w-5xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit service schedule</h2>
        <p class="text-xs text-slate-400">Adjust visit dates, assigned routes, service details and signed slips for this AMC period.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="service_schedule" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="space-y-3">
      <div class="rounded-xl border border-slate-800/70 bg-slate-900/60 p-4 text-xs text-slate-300">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="space-y-1">
            <p class="text-sm font-semibold text-slate-100">Generate schedule</p>
            <p>Creates preventive visits across the AMC period using linked contract services/year or lift fallback.</p>
          </div>
          {% set effective_services_per_year = payload.amc.services_per_year if payload.amc.services_per_year and payload.amc.services_per_year >= 1 else (lift.services_per_year or '') %}
          {% set has_stored_preferred_date = lift.preferred_service_date is not none %}
          {% set has_stored_preferred_day = lift.preferred_service_days and lift.preferred_service_days|length > 0 %}
          {% set can_override_preferred_dom = not has_stored_preferred_date and not has_stored_preferred_day %}
          <div class="flex items-center gap-2">
            <input type="number" name="services_per_year" min="1" max="12" step="1" value="{{ effective_services_per_year }}" class="w-24 rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-xs" placeholder="/yr" />
            <div id="schedulePreferredDayOverrideWrapper" class="{% if not can_override_preferred_dom %}hidden{% endif %}">
              <input type="number" name="preferred_day_of_month" min="1" max="30" step="1" class="w-32 rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-xs" placeholder="Day 1-30" {% if not can_override_preferred_dom %}disabled{% endif %} />
            </div>
            <button type="submit" formaction="{{ url_for('service_lift_generate_schedule', lift_id=lift.id) }}" formmethod="post" class="rounded-xl border border-emerald-400/40 bg-emerald-400/10 px-3 py-2 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-400/20">Generate schedule</button>
          </div>
        </div>
        <p id="schedulePreferredDayOverrideHint" data-can-override-preferred-dom="{{ 'true' if can_override_preferred_dom else 'false' }}" class="mt-2 text-[11px] text-slate-400 {% if not can_override_preferred_dom %}hidden{% endif %}">Preferred day of month (1–30)</p>
      </div>
      <div class="grid grid-cols-1 gap-3 text-xs font-semibold uppercase tracking-wide text-slate-400 md:grid-cols-2 xl:grid-cols-6">
        <div>Service date</div>
        <div>Route</div>
        <div>Status</div>
        <div>Service type</div><div class="xl:col-span-2">Service slip</div>
      </div>
      <div id="serviceScheduleList" class="space-y-3">
        {% set schedule_entries = payload.service_schedule if payload.service_schedule else [{'date_iso': '', 'route_value': '', 'status_key': 'scheduled', 'slip_url': '', 'slip_label': '', 'slip_display_label': '', 'slip_stored': '', 'has_slip': False, 'allow_overdue': False}] %}
        {% for visit in schedule_entries %}
          <div class="grid gap-3 service-row items-start md:grid-cols-2 xl:grid-cols-6" data-service-row data-allow-overdue="{{ 'true' if visit.allow_overdue else 'false' }}" data-status="{{ visit.status_key }}">
            <label class="space-y-1">
              <span class="sr-only">Service date</span>
              <input type="date" name="service_date" value="{{ visit.date_iso }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
            </label>
            <label class="space-y-1">
              <span class="sr-only">Route</span>
              <select name="service_route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
                <option value="">Default route</option>
                {% for route in service_routes %}
                  {% set option_value = route.state %}
                  {% set selected_route = visit.route_value or lift.route %}
                  <option value="{{ option_value }}" {% if selected_route and selected_route|lower == option_value|lower %}selected{% endif %}>{{ route.display_name }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="space-y-1">
              <span class="sr-only">Status</span>
              <select name="service_status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
                {% for value, label in service_visit_status_options %}
                  <option value="{{ value }}" {% if value == 'overdue' %}data-overdue-option="true" {% if not visit.allow_overdue and visit.status_key != 'overdue' %}disabled hidden{% endif %}{% endif %} {% if visit.status_key == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="space-y-1">
              <span class="sr-only">Service type</span>
              <select name="service_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
                <option value="">Select type</option>
                {% for value, label in service_type_options %}
                  <option value="{{ value }}" {% if visit.service_type == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <input type="hidden" name="service_details" value="{{ visit.details_json or '' }}" />
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3 xl:col-span-2">
              <input type="hidden" name="service_slip_existing" value="{{ visit.slip_stored or '' }}">
              <input type="hidden" name="service_slip_label" value="{{ visit.slip_label or '' }}">
              <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                {% if visit.has_slip and visit.slip_url %}
                  <a href="{{ visit.slip_url }}" target="_blank" rel="noopener" data-existing-slip class="inline-flex items-center gap-2 text-xs font-semibold text-emerald-200 hover:text-emerald-100">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 8.25v7.5a2.25 2.25 0 0 1-2.25 2.25h-13.5A2.25 2.25 0 0 1 3 15.75v-9A2.25 2.25 0 0 1 5.25 4.5h9l6.75 6.75" />
                    </svg>
                    <span>Current slip{% if visit.slip_display_label %}: {{ visit.slip_display_label }}{% endif %}</span>
                  </a>
                {% endif %}
                <label class="block service-slip-upload {% if visit.status_key != 'completed' %}hidden{% endif %}">
                  <span class="sr-only">Upload service slip</span>
                  <input type="file" name="service_slip_file" {% if visit.status_key != 'completed' %}disabled{% endif %} class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-slate-700 file:px-3 file:py-2 file:text-xs file:font-semibold file:text-slate-100 sm:w-auto" aria-label="Upload service slip" accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.avi,.mkv,.doc,.docx,.xls,.xlsx" />
                </label>
              </div>
              <button type="button" class="remove-service hidden rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70 sm:self-start">Remove</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <button type="button" data-add-service class="rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Add service</button>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save schedule</button>
    </div>
  </form>
</dialog>
<dialog id="breakdownSummaryModal" class="modal-dialog">
  <div class="w-full max-w-lg space-y-4 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Breakdown details</h2>
        <p class="text-xs text-slate-400">Status, notes and references for the selected breakdown.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <dl class="grid gap-4 sm:grid-cols-2">
      <div class="sm:col-span-2">
        <dt class="text-xs uppercase tracking-wide text-slate-400">Breakdown type</dt>
        <dd class="text-sm font-semibold text-slate-100" data-breakdown-type>—</dd>
      </div>
      <div>
        <dt class="text-xs uppercase tracking-wide text-slate-400">Date</dt>
        <dd class="text-sm text-slate-100" data-breakdown-date>—</dd>
      </div>
      <div>
        <dt class="text-xs uppercase tracking-wide text-slate-400">Status</dt>
        <dd>
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold border border-slate-700/70 bg-slate-800/60 text-slate-200" data-breakdown-status-badge>—</span>
        </dd>
      </div>
      <div>
        <dt class="text-xs uppercase tracking-wide text-slate-400">Reference</dt>
        <dd class="text-sm text-slate-100" data-breakdown-reference>—</dd>
      </div>
      <div>
        <dt class="text-xs uppercase tracking-wide text-slate-400">Reported by</dt>
        <dd class="text-sm text-slate-100" data-breakdown-reported-by>—</dd>
      </div>
      <div class="sm:col-span-2">
        <dt class="text-xs uppercase tracking-wide text-slate-400">Notes</dt>
        <dd class="rounded-xl border border-slate-800 bg-slate-900/70 p-3 text-sm text-slate-300" data-breakdown-description>No additional details provided.</dd>
      </div>
    </dl>
  </div>
</dialog>
<dialog id="liftContactsModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="w-full max-w-4xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit AMC contacts</h2>
        <p class="text-xs text-slate-400">List the stakeholders responsible for AMC coordination.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="amc_contacts" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="space-y-3">
      <div class="grid grid-cols-1 gap-3 md:grid-cols-4 font-semibold text-xs uppercase tracking-wide text-slate-400">
        <div>Name</div>
        <div>Designation</div>
        <div>Contact no.</div>
        <div>Email</div>
      </div>
      <div id="amcContactsList" class="space-y-3">
        {% set contacts = payload.amc.contacts if payload.amc.contacts else [{'name':'','designation':'','phone':'','email':''}] %}
        {% for contact in contacts %}
          <div class="grid grid-cols-1 gap-3 md:grid-cols-4 contact-row">
            <input name="contact_name" value="{{ contact.name if contact.name != '—' else '' }}" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Full name" />
            <input name="contact_designation" value="{{ contact.designation if contact.designation != '—' else '' }}" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Designation" />
            <input name="contact_phone" value="{{ contact.phone if contact.phone != '—' else '' }}" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Phone" />
            <div class="flex gap-3">
              <input name="contact_email" value="{{ contact.email if contact.email != '—' else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Email" />
              <button type="button" class="remove-contact hidden rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Remove</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <button type="button" data-add-contact class="rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Add contact</button>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save contacts</button>
    </div>
  </form>
</dialog>
<dialog id="liftAttachmentsModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_upload_file', lift_id=lift.id) }}" enctype="multipart/form-data" class="w-full max-w-xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Upload attachment</h2>
        <p class="text-xs text-slate-400">Share site photos, contracts or machine documentation.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Description</span>
      <textarea name="description" rows="2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Notes about this attachment (optional)"></textarea>
    </label>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Select file</span>
      <input type="file" name="attachment" class="w-full text-sm text-slate-300" />
    </label>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Upload file</button>
    </div>
  </form>
</dialog>
<dialog id="liftCommentsModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_add_comment', lift_id=lift.id) }}" class="w-full max-w-xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Add comment</h2>
        <p class="text-xs text-slate-400">Share a status update or observation for teammates.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Comment</span>
      <textarea name="body" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Share a status update or observation"></textarea>
    </label>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Post comment</button>
    </div>
  </form>
</dialog>
<dialog id="liftTimelineModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="w-full max-w-xl space-y-5 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Add timeline entry</h2>
        <p class="text-xs text-slate-400">Log significant service events or customer communications.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="form_section" value="timeline" />
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Event date</span>
      <input type="date" name="timeline_date" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
    </label>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Title</span>
      <input name="timeline_title" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. Preventive service completed" />
    </label>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Category</span>
      <select name="timeline_category" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
        <option value="Service">Service</option>
        <option value="Breakdown">Breakdown</option>
        <option value="AMC">AMC</option>
        <option value="Inspection">Inspection</option>
        <option value="Update" selected>Update</option>
      </select>
    </label>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Detail</span>
      <textarea name="timeline_detail" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Add context or next steps"></textarea>
    </label>
    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Add entry</button>
    </div>
  </form>
</dialog>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    function openModal(modal) {
      if (!modal) return;
      if (typeof modal.showModal === 'function') {
        modal.showModal();
      } else {
        modal.classList.add('open');
      }
    }

    function closeModal(modal) {
      if (!modal) return;
      if (typeof modal.close === 'function') {
        modal.close();
      } else {
        modal.classList.remove('open');
      }
    }

    function attachModalClosers(modal) {
      if (!modal) return;
      modal.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', () => closeModal(modal));
      });
      modal.addEventListener('cancel', (event) => {
        event.preventDefault();
        closeModal(modal);
      });
    }

    function setupModal(openSelector, modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      document.querySelectorAll(openSelector).forEach((trigger) => {
        trigger.addEventListener('click', () => openModal(modal));
      });
      attachModalClosers(modal);
    }

    setupModal('[data-modal-open="lift-summary"]', 'liftSummaryModal');
    setupModal('[data-modal-open="lift-specs"]', 'liftSpecsModal');
    setupModal('[data-modal-open="lift-amc"]', 'liftAmcModal');
    setupModal('[data-modal-open="lift-service-schedule"]', 'liftServiceScheduleModal');
    const markCompleteMode = {{ (request.args.get('mark_complete') == '1') | tojson }};
    if (markCompleteMode) {
      const scheduleModal = document.getElementById('liftServiceScheduleModal');
      openModal(scheduleModal);
    }
    setupModal('[data-modal-open="lift-contacts"]', 'liftContactsModal');
    setupModal('[data-modal-open="lift-attachments"]', 'liftAttachmentsModal');
    setupModal('[data-modal-open="lift-comments"]', 'liftCommentsModal');
    setupModal('[data-modal-open="lift-timeline"]', 'liftTimelineModal');

    const breakdownModal = document.getElementById('breakdownSummaryModal');
    if (breakdownModal) {
      attachModalClosers(breakdownModal);
      const breakdownFields = {
        type: breakdownModal.querySelector('[data-breakdown-type]'),
        date: breakdownModal.querySelector('[data-breakdown-date]'),
        reference: breakdownModal.querySelector('[data-breakdown-reference]'),
        reportedBy: breakdownModal.querySelector('[data-breakdown-reported-by]'),
        description: breakdownModal.querySelector('[data-breakdown-description]'),
      };
      const statusBadge = breakdownModal.querySelector('[data-breakdown-status-badge]');
      const badgeBaseClass = 'inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold';

      function getStatusBadgeClass(statusKey) {
        switch ((statusKey || '').toLowerCase()) {
          case 'fixed':
            return 'border border-emerald-400/40 bg-emerald-400/10 text-emerald-200';
          case 'in_progress':
          case 'in-progress':
            return 'border border-amber-400/40 bg-amber-400/10 text-amber-200';
          case 'open':
            return 'border border-rose-400/40 bg-rose-400/10 text-rose-200';
          case 'accounts_clearance':
            return 'border border-sky-400/40 bg-sky-400/10 text-sky-200';
          default:
            return 'border border-slate-700/70 bg-slate-800/60 text-slate-200';
        }
      }

      function setField(element, value, fallback) {
        if (!element) return;
        const trimmed = typeof value === 'string' ? value.trim() : value;
        element.textContent = trimmed ? trimmed : fallback;
      }

      function openBreakdownDetail(trigger) {
        if (!trigger) return;
        setField(breakdownFields.type, trigger.getAttribute('data-breakdown-type'), '—');
        setField(breakdownFields.date, trigger.getAttribute('data-breakdown-date'), '—');
        setField(breakdownFields.reference, trigger.getAttribute('data-breakdown-reference'), '—');
        setField(breakdownFields.reportedBy, trigger.getAttribute('data-breakdown-reported-by'), '—');
        setField(
          breakdownFields.description,
          trigger.getAttribute('data-breakdown-description'),
          'No additional details provided.'
        );
        if (statusBadge) {
          const statusKey = trigger.getAttribute('data-breakdown-status-key');
          const statusText = trigger.getAttribute('data-breakdown-status') || '—';
          statusBadge.className = `${badgeBaseClass} ${getStatusBadgeClass(statusKey)}`;
          statusBadge.textContent = statusText;
        }
        openModal(breakdownModal);
      }

      document.querySelectorAll('[data-breakdown-entry]').forEach((row) => {
        row.addEventListener('click', () => openBreakdownDetail(row));
        row.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openBreakdownDetail(row);
          }
        });
      });
    }

    const amcDurationMonths = {{ amc_duration_months | tojson }};
    const amcStartInput = document.getElementById('liftAmcStartDetail');
    const amcDurationInput = document.getElementById('liftAmcDurationDetail');
    const amcEndInput = document.getElementById('liftAmcEndDetail');

    function addMonths(date, months) {
      const result = new Date(date.getTime());
      const desiredMonth = result.getMonth() + months;
      result.setMonth(desiredMonth);
      if (result.getMonth() !== ((desiredMonth % 12) + 12) % 12) {
        result.setDate(0);
      }
      return result;
    }

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function updateAmcEnd() {
      if (!amcStartInput || !amcDurationInput || !amcEndInput) {
        return;
      }
      const startValue = amcStartInput.value;
      const durationKey = amcDurationInput.value;
      if (!startValue || !durationKey || !amcDurationMonths[durationKey]) {
        amcEndInput.value = '';
        return;
      }
      const startDate = new Date(`${startValue}T00:00:00`);
      if (Number.isNaN(startDate.getTime())) {
        amcEndInput.value = '';
        return;
      }
      const months = parseInt(amcDurationMonths[durationKey], 10) || 0;
      if (!months) {
        amcEndInput.value = '';
        return;
      }
      const computed = addMonths(startDate, months);
      computed.setDate(computed.getDate() - 1);
      amcEndInput.value = formatDateInput(computed);
    }

    if (amcStartInput && amcDurationInput) {
      amcStartInput.addEventListener('change', updateAmcEnd);
      amcDurationInput.addEventListener('change', updateAmcEnd);
      updateAmcEnd();
    }

    const preferredDateSelect = document.getElementById('liftPreferredServiceDateDetail');
    const preferredDateWrapper = document.getElementById('preferredServiceDateSpecificDetail');
    const preferredDateInput = preferredDateWrapper ? preferredDateWrapper.querySelector('input[name="preferred_service_date_day"]') : null;

    function togglePreferredDate() {
      if (!preferredDateSelect || !preferredDateWrapper) return;
      if (preferredDateSelect.value === 'monthly') {
        preferredDateWrapper.classList.remove('hidden');
      } else {
        preferredDateWrapper.classList.add('hidden');
        if (preferredDateInput) {
          preferredDateInput.value = '';
        }
      }
    }

    if (preferredDateSelect) {
      preferredDateSelect.addEventListener('change', togglePreferredDate);
      togglePreferredDate();
    }

    function enforcePreferredDays(select) {
      if (!select) return;
      const selectedValues = Array.from(select.selectedOptions).map((option) => option.value);
      if (selectedValues.includes('any') && selectedValues.length > 1) {
        Array.from(select.options).forEach((option) => {
          if (option.value !== 'any') {
            option.selected = false;
          }
        });
      }
    }

    const preferredDaysSelect = document.getElementById('liftPreferredServiceDaysDetail');
    if (preferredDaysSelect) {
      preferredDaysSelect.addEventListener('change', () => enforcePreferredDays(preferredDaysSelect));
      enforcePreferredDays(preferredDaysSelect);
    }

    const schedulePreferredDayOverrideWrapper = document.getElementById('schedulePreferredDayOverrideWrapper');
    const schedulePreferredDayOverrideHint = document.getElementById('schedulePreferredDayOverrideHint');
    const schedulePreferredDayOverrideInput = schedulePreferredDayOverrideWrapper
      ? schedulePreferredDayOverrideWrapper.querySelector('input[name="preferred_day_of_month"]')
      : null;

    function syncSchedulePreferredDayOverride() {
      if (!schedulePreferredDayOverrideHint) return;
      const canOverride = schedulePreferredDayOverrideHint.getAttribute('data-can-override-preferred-dom') === 'true';
      if (schedulePreferredDayOverrideWrapper) {
        schedulePreferredDayOverrideWrapper.classList.toggle('hidden', !canOverride);
      }
      if (schedulePreferredDayOverrideHint) {
        schedulePreferredDayOverrideHint.classList.toggle('hidden', !canOverride);
      }
      if (schedulePreferredDayOverrideInput) {
        schedulePreferredDayOverrideInput.disabled = !canOverride;
        if (!canOverride) {
          schedulePreferredDayOverrideInput.value = '';
        }
      }
    }

    syncSchedulePreferredDayOverride();

    const anyTimeDetail = document.getElementById('liftAnyTimeDetail');
    const preferredTimeDetail = document.getElementById('liftPreferredServiceTimeDetail');
    function syncAnyTimeDetail() {
      if (!anyTimeDetail || !preferredTimeDetail) return;
      if (anyTimeDetail.checked) {
        preferredTimeDetail.value = '';
        preferredTimeDetail.setAttribute('disabled', 'disabled');
      } else {
        preferredTimeDetail.removeAttribute('disabled');
      }
    }
    if (anyTimeDetail && preferredTimeDetail) {
      anyTimeDetail.addEventListener('change', syncAnyTimeDetail);
      preferredTimeDetail.addEventListener('input', () => {
        if (preferredTimeDetail.value) {
          anyTimeDetail.checked = false;
          syncAnyTimeDetail();
        }
      });
      syncAnyTimeDetail();
    }

    const scheduleStatusOptions = {{ service_visit_status_options | tojson }};
    const scheduleList = document.getElementById('serviceScheduleList');
    const addServiceButton = document.querySelector('[data-add-service]');
    const defaultRouteLabel = {{ (payload.route_display if payload.route_display != '—' else 'Default route') | tojson }};
    const serviceRouteOptions = [{% for route in service_routes %}[{{ route.state|tojson }}, {{ route.display_name|tojson }}],{% endfor %}];
    const serviceTypeOptions = {{ service_type_options | tojson }};
    const serviceRouteOptionsHtml = [`<option value="">${defaultRouteLabel}</option>`]
      .concat(serviceRouteOptions.map(([value, label]) => `<option value="${value}">${label}</option>`))
      .join('');
    const serviceTypeOptionsHtml = ['<option value="">Select type</option>']
      .concat(serviceTypeOptions.map(([value, label]) => `<option value="${value}">${label}</option>`))
      .join('');

    const addableStatusOptions = (scheduleStatusOptions || []).filter(([value]) => value !== 'overdue');
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    function getDefaultStatusValue(select) {
      if (!select) return '';
      const preferredOption = Array.from(select.options).find((option) => option.value && option.value !== 'overdue');
      if (preferredOption) {
        return preferredOption.value;
      }
      return select.options.length ? select.options[0].value : '';
    }

    function enforceOverdueAvailability(row, select) {
      const allowOverdue = row.getAttribute('data-allow-overdue') !== 'false';
      Array.from(select.options).forEach((option) => {
        if (option.value === 'overdue') {
          option.disabled = !allowOverdue;
          option.hidden = !allowOverdue && !option.selected;
        }
      });
      if (!allowOverdue && select.value === 'overdue') {
        const fallback = (addableStatusOptions[0] && addableStatusOptions[0][0])
          || (scheduleStatusOptions && scheduleStatusOptions[0] && scheduleStatusOptions[0][0])
          || '';
        if (fallback) {
          select.value = fallback;
          row.setAttribute('data-status', fallback);
        }
      }
    }

    function updateRowStatusBasedOnDate(row) {
      if (!row) return;
      const select = row.querySelector('select[name="service_status"]');
      if (!select) return;
      const dateInput = row.querySelector('input[name="service_date"]');
      const isCompleted = select.value === 'completed';
      let allowOverdue = false;
      if (dateInput && dateInput.value) {
        const visitDate = new Date(`${dateInput.value}T00:00:00`);
        if (!Number.isNaN(visitDate.getTime()) && visitDate < todayStart && !isCompleted) {
          allowOverdue = true;
        }
      }
      row.setAttribute('data-allow-overdue', allowOverdue ? 'true' : 'false');
      enforceOverdueAvailability(row, select);
      if (allowOverdue && !isCompleted) {
        if (select.value !== 'overdue') {
          select.value = 'overdue';
        }
      } else if (select.value === 'overdue') {
        const fallback = getDefaultStatusValue(select);
        if (fallback) {
          select.value = fallback;
        } else {
          select.value = '';
        }
      }
      row.setAttribute('data-status', select.value);
      toggleSlipInput(row);
      updateServiceRemoveButtons();
    }

    function toggleSlipInput(row) {
      const statusSelect = row.querySelector('select[name="service_status"]');
      const fileInput = row.querySelector('input[type="file"][name="service_slip_file"]');
      const uploadWrapper = row.querySelector('.service-slip-upload');
      if (!statusSelect || !fileInput || !uploadWrapper) return;
      const enabled = statusSelect.value === 'completed';
      fileInput.disabled = !enabled;
      uploadWrapper.classList.toggle('hidden', !enabled);
      if (!enabled) {
        fileInput.value = '';
      }
    }

    function updateServiceRemoveButtons() {
      if (!scheduleList) return;
      const rows = scheduleList.querySelectorAll('.service-row');
      rows.forEach((row) => {
        const removeButton = row.querySelector('.remove-service');
        if (!removeButton) return;
        const statusSelect = row.querySelector('select[name="service_status"]');
        const statusValue = statusSelect ? statusSelect.value : row.getAttribute('data-status');
        if (statusValue === 'completed') {
          removeButton.classList.add('hidden');
          removeButton.disabled = true;
        } else {
          removeButton.disabled = false;
          if (rows.length > 1) {
            removeButton.classList.remove('hidden');
          } else {
            removeButton.classList.add('hidden');
          }
        }
      });
    }

    function createServiceRow() {
      const wrapper = document.createElement('div');
      wrapper.className = 'grid gap-3 service-row items-start md:grid-cols-2 xl:grid-cols-6';
      wrapper.setAttribute('data-service-row', 'true');
      wrapper.setAttribute('data-allow-overdue', 'false');
      const optionSource = (scheduleStatusOptions && scheduleStatusOptions.length)
        ? scheduleStatusOptions
        : addableStatusOptions;
      const optionsHtml = (optionSource || [])
        .map(([value, label]) => {
          if (value === 'overdue') {
            return `<option value="${value}" data-overdue-option="true" disabled hidden>${label}</option>`;
          }
          return `<option value="${value}">${label}</option>`;
        })
        .join('');
      wrapper.innerHTML = `
        <label class="space-y-1">
          <span class="sr-only">Service date</span>
          <input type="date" name="service_date" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="sr-only">Route</span>
          <select name="service_route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
            ${serviceRouteOptionsHtml}
          </select>
        </label>
        <label class="space-y-1">
          <span class="sr-only">Status</span>
          <select name="service_status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
            ${optionsHtml}
          </select>
        </label>
        <label class="space-y-1">
          <span class="sr-only">Service type</span>
          <select name="service_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">${serviceTypeOptionsHtml}</select>
        </label>
        <input type="hidden" name="service_details" />
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3 xl:col-span-2">
          <input type="hidden" name="service_slip_existing" value="">
          <input type="hidden" name="service_slip_label" value="">
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <label class="block service-slip-upload hidden">
              <span class="sr-only">Upload service slip</span>
              <input type="file" name="service_slip_file" disabled class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-xs file:mr-3 file:rounded-lg file:border-0 file:bg-slate-700 file:px-3 file:py-2 file:text-xs file:font-semibold file:text-slate-100 sm:w-auto" aria-label="Upload service slip" accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.avi,.mkv,.doc,.docx,.xls,.xlsx" />
            </label>
          </div>
          <button type="button" class="remove-service hidden rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70 sm:self-start">Remove</button>
        </div>
      `;
      const select = wrapper.querySelector('select[name="service_status"]');
      const defaultValue = getDefaultStatusValue(select);
      if (select && defaultValue) {
        select.value = defaultValue;
      }
      wrapper.setAttribute('data-status', defaultValue || '');
      return wrapper;
    }

    function registerServiceRow(row) {
      if (!row) return;
      if (!row.getAttribute('data-service-row')) {
        row.setAttribute('data-service-row', 'true');
      }
      const statusSelect = row.querySelector('select[name="service_status"]');
      if (statusSelect) {
        enforceOverdueAvailability(row, statusSelect);
        if (!statusSelect.value) {
          const fallback = (addableStatusOptions[0] && addableStatusOptions[0][0])
            || (scheduleStatusOptions && scheduleStatusOptions[0] && scheduleStatusOptions[0][0])
            || '';
          if (fallback) {
            statusSelect.value = fallback;
          }
        }
        row.setAttribute('data-status', statusSelect.value);
        statusSelect.onchange = () => {
          enforceOverdueAvailability(row, statusSelect);
          row.setAttribute('data-status', statusSelect.value);
          updateRowStatusBasedOnDate(row);
          toggleSlipInput(row);
        };
      }
      const dateInput = row.querySelector('input[name="service_date"]');
      if (dateInput) {
        dateInput.addEventListener('change', () => {
          updateRowStatusBasedOnDate(row);
        });
      }
      const removeButton = row.querySelector('.remove-service');
      if (removeButton) {
        removeButton.onclick = () => {
          const currentRows = scheduleList ? scheduleList.querySelectorAll('.service-row') : [];
          if (currentRows.length > 1) {
            row.remove();
            refreshServiceRows();
          } else {
            row.querySelectorAll('input[type="date"], select[name="service_route"], input[name="service_details"], select[name="service_type"]').forEach((input) => {
              input.value = '';
            });
            if (statusSelect) {
              const fallback = (addableStatusOptions[0] && addableStatusOptions[0][0])
                || (scheduleStatusOptions && scheduleStatusOptions[0] && scheduleStatusOptions[0][0])
                || '';
              if (fallback) {
                statusSelect.value = fallback;
                row.setAttribute('data-status', fallback);
              }
            }
            row.querySelectorAll('input[type="hidden"]').forEach((hidden) => {
              hidden.value = '';
            });
            const fileInput = row.querySelector('input[type="file"][name="service_slip_file"]');
            if (fileInput) {
              fileInput.value = '';
            }
            const existingLink = row.querySelector('[data-existing-slip]');
            if (existingLink) {
              existingLink.remove();
            }
            updateServiceRemoveButtons();
          }
        };
      }
      updateRowStatusBasedOnDate(row);
    }

    function refreshServiceRows() {
      if (!scheduleList) return;
      const rows = scheduleList.querySelectorAll('.service-row');
      rows.forEach((row) => {
        registerServiceRow(row);
      });
      updateServiceRemoveButtons();
    }

    if (addServiceButton && scheduleList) {
      addServiceButton.addEventListener('click', () => {
        const row = createServiceRow();
        scheduleList.appendChild(row);
        refreshServiceRows();
      });
      refreshServiceRows();
    }

    const contactsList = document.getElementById('amcContactsList');
    const addContactButton = document.querySelector('[data-add-contact]');

    function createContactRow() {
      const wrapper = document.createElement('div');
      wrapper.className = 'grid grid-cols-1 gap-3 md:grid-cols-4 contact-row';
      wrapper.innerHTML = `
        <input name="contact_name" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Full name" />
        <input name="contact_designation" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Designation" />
        <input name="contact_phone" class="rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Phone" />
        <div class="flex gap-3">
          <input name="contact_email" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Email" />
          <button type="button" class="remove-contact hidden rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Remove</button>
        </div>
      `;
      return wrapper;
    }

    function refreshContactRemoveButtons() {
      if (!contactsList) return;
      const rows = contactsList.querySelectorAll('.contact-row');
      rows.forEach((row) => {
        const removeButton = row.querySelector('.remove-contact');
        if (!removeButton) return;
        if (rows.length > 1) {
          removeButton.classList.remove('hidden');
        } else {
          removeButton.classList.add('hidden');
        }
        removeButton.onclick = () => {
          if (contactsList.querySelectorAll('.contact-row').length > 1) {
            row.remove();
            refreshContactRemoveButtons();
          } else {
            row.querySelectorAll('input').forEach((input) => {
              input.value = '';
            });
          }
        };
      });
    }

    if (addContactButton && contactsList) {
      addContactButton.addEventListener('click', () => {
        contactsList.appendChild(createContactRow());
        refreshContactRemoveButtons();
      });
      refreshContactRemoveButtons();
    }
  });
</script>
{% endblock %}
