{% extends "base.html" %}
{% block title %}Eleva ERP – Customers – {{ customer.company_name }}{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400"><a href="{{ url_for('service_customers') }}" class="text-emerald-200 hover:text-emerald-100">Customers</a> · Profile</p>
      <h1 class="text-2xl font-semibold text-theme-primary">{{ customer.company_name }}</h1>
      <p class="text-sm text-slate-400">Customer code {{ customer.customer_code }}</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('service_lifts') }}?q={{ customer.customer_code }}" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">View lifts</a>
      {% if current_user.is_admin %}
        <form method="post" action="{{ url_for('service_customer_delete', customer_id=customer.id) }}" class="inline-flex" onsubmit="return confirm('Delete customer {{ customer.customer_code }} and all linked lifts? This action cannot be undone.');">
          {{ csrf_field() }}
          <input type="hidden" name="next" value="{{ url_for('service_customers') }}" />
          <button type="submit" class="rounded-xl border border-rose-500/50 bg-rose-500/10 px-3 py-2 text-xs font-semibold text-rose-200 transition hover:bg-rose-500/20">Delete customer</button>
        </form>
      {% endif %}
    </div>
  </header>

  <div class="grid gap-6 lg:grid-cols-[2fr,1.25fr]">
    <form method="post" action="{{ url_for('service_customer_update', customer_id=customer.id) }}" class="space-y-5 rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-sm text-slate-100">
      {{ csrf_field() }}
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-theme-primary">Customer details</h2>
          <p class="text-xs text-slate-400">Update category and contact information.</p>
        </div>
        <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save changes</button>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
          <input value="{{ customer.customer_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
          <p class="text-sm text-slate-500">Customer codes are auto-generated and locked.</p>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer name</span>
          <input name="company_name" value="{{ customer.company_name }}" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Contact person</span>
          <input name="contact_person" value="{{ customer.contact_person or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Email</span>
          <input type="email" name="email" value="{{ customer.email or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Phone</span>
          <input name="phone" value="{{ customer.phone or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Mobile</span>
          <input name="mobile" value="{{ customer.mobile or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Category</span>
          <select name="category" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
            <option value="">Select category</option>
            {% for option in ["Individual", "Company", "Proprietorship"] %}
              <option value="{{ option }}" {% if customer.sector and customer.sector|lower == option|lower %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Branch</span>
          {% set branch_value = customer.branch or '' %}
          {% set branch_value_lower = branch_value.lower() if branch_value else '' %}
          <select name="branch" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
            <option value="">Select branch</option>
            {% for branch in SERVICE_BRANCH_OPTIONS %}
              {% set branch_lower = branch.lower() %}
              <option value="{{ branch }}" {% if branch_value and branch_value_lower == branch_lower %}selected{% endif %}>{{ branch }}</option>
            {% endfor %}
            {% if branch_value and branch_value_lower not in SERVICE_BRANCH_OPTION_SET %}
              <option value="{{ branch_value }}" selected>{{ branch_value }}</option>
            {% endif %}
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">GST number</span>
          <input name="gst_no" value="{{ customer.gst_no or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
        </label>
      </div>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</span>
        <textarea name="notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">{{ customer.notes or '' }}</textarea>
      </label>
    </form>

    <section class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-sm text-slate-100">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold text-theme-primary">Account summary</h2>
          <p class="text-xs text-slate-400">Snapshot of linked lifts and billing details.</p>
        </div>
        <div class="text-right text-xs text-slate-400">
          <div>Created {{ customer.created_at.strftime('%d %b %Y') if customer.created_at else '—' }}</div>
          <div>Updated {{ customer.updated_at.strftime('%d %b %Y %H:%M') if customer.updated_at else '—' }}</div>
        </div>
      </div>
      <dl class="grid gap-4">
        <div class="flex justify-between">
          <dt class="text-slate-400">Email</dt>
          <dd class="font-semibold text-slate-200">{{ customer.email or '—' }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-slate-400">Phone</dt>
          <dd class="font-semibold text-slate-200">{{ customer.phone or '—' }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-slate-400">Mobile</dt>
          <dd class="font-semibold text-slate-200">{{ customer.mobile or '—' }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-slate-400">Category</dt>
          <dd class="font-semibold text-slate-200">{{ customer.sector or '—' }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-slate-400">Branch</dt>
          <dd class="font-semibold text-slate-200">{{ customer.branch or '—' }}</dd>
        </div>
        <div class="flex items-center justify-between gap-3">
          <dt class="text-slate-400">Linked lifts</dt>
          <dd>
            <button
              type="button"
              data-customer-lifts="{{ customer.id }}"
              data-customer-name="{{ customer.company_name }}"
              data-customer-open-count="{{ customer.open_lifts|length }}"
              class="inline-flex items-center gap-1 rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20"
            >
              {{ customer.open_lifts|length }} open · {{ lifts|length }} total
            </button>
          </dd>
        </div>
      </dl>
      {% set billing_has_address = customer.billing_address_line1 or customer.billing_address_line2 or customer.city or customer.state or customer.pincode or customer.country %}
      <div class="relative rounded-xl border border-slate-800/80 bg-slate-900/80 p-4 text-xs text-slate-300">
        <div class="flex items-start justify-between gap-2">
          <h3 class="text-sm font-semibold text-slate-100">Billing address</h3>
          <button type="button" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400/50 hover:text-emerald-200" data-address-edit="billing" aria-label="Edit billing address">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487a2.25 2.25 0 113.182 3.182L7.125 20.588a4.5 4.5 0 01-1.897 1.13l-2.005.572a.75.75 0 01-.927-.928l.572-2.004a4.5 4.5 0 011.13-1.898L16.862 4.487z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125L16.875 4.5" />
            </svg>
          </button>
        </div>
        {% if billing_has_address %}
          {% if customer.billing_address_line1 %}
            <p class="mt-2 text-slate-200">{{ customer.billing_address_line1 }}</p>
          {% endif %}
          {% if customer.billing_address_line2 %}
            <p class="text-slate-200">{{ customer.billing_address_line2 }}</p>
          {% endif %}
          {% if customer.city or customer.state or customer.pincode %}
            <p class="text-slate-200">{{ customer.city or '' }}{% if customer.city and customer.state %}, {% endif %}{{ customer.state or '' }}{% if customer.pincode %} {{ customer.pincode }}{% endif %}</p>
          {% endif %}
          {% if customer.country %}
            <p class="text-slate-200">{{ customer.country }}</p>
          {% endif %}
        {% else %}
          <p class="mt-2 text-slate-500">No billing address added yet.</p>
        {% endif %}
      </div>
      {% set office_has_address = customer.office_address_line1 or customer.office_address_line2 or customer.office_city or customer.office_state or customer.office_pincode or customer.office_country %}
      <div class="relative rounded-xl border border-slate-800/80 bg-slate-900/80 p-4 text-xs text-slate-300">
        <div class="flex items-start justify-between gap-2">
          <h3 class="text-sm font-semibold text-slate-100">Office address</h3>
          <button type="button" class="rounded-full border border-slate-700/70 p-2 text-slate-300 transition hover:border-emerald-400/50 hover:text-emerald-200" data-address-edit="office" aria-label="Edit office address">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487a2.25 2.25 0 113.182 3.182L7.125 20.588a4.5 4.5 0 01-1.897 1.13l-2.005.572a.75.75 0 01-.927-.928l.572-2.004a4.5 4.5 0 011.13-1.898L16.862 4.487z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125L16.875 4.5" />
            </svg>
          </button>
        </div>
        {% if office_has_address %}
          {% if customer.office_address_line1 %}
            <p class="mt-2 text-slate-200">{{ customer.office_address_line1 }}</p>
          {% endif %}
          {% if customer.office_address_line2 %}
            <p class="text-slate-200">{{ customer.office_address_line2 }}</p>
          {% endif %}
          {% if customer.office_city or customer.office_state or customer.office_pincode %}
            <p class="text-slate-200">{{ customer.office_city or '' }}{% if customer.office_city and customer.office_state %}, {% endif %}{{ customer.office_state or '' }}{% if customer.office_pincode %} {{ customer.office_pincode }}{% endif %}</p>
          {% endif %}
          {% if customer.office_country %}
            <p class="text-slate-200">{{ customer.office_country }}</p>
          {% endif %}
        {% else %}
          <p class="mt-2 text-slate-500">No office address added yet.</p>
        {% endif %}
      </div>
      <div class="rounded-xl border border-slate-800/80 bg-slate-900/80 p-4 text-xs text-slate-300">
        <h3 class="text-sm font-semibold text-slate-100">Notes</h3>
        <p class="mt-2 text-slate-200">{{ customer.notes or '—' }}</p>
      </div>
    </section>
  </div>

  <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-sm text-slate-100">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Comments</h2>
        <p class="text-xs text-slate-400">Log follow-ups and reference linked support tickets.</p>
      </div>
    </div>
    <div class="mt-4 space-y-3">
      {% if comments %}
        {% for comment in comments %}
          <article class="rounded-xl border border-slate-800/60 bg-slate-900/70 p-3">
            <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-400">
              <span>{{ comment.author.display_name if comment.author else 'System' }}</span>
              <span>{{ comment.created_at.strftime('%d %b %Y %H:%M') }}</span>
            </div>
            <p class="mt-2 leading-relaxed text-slate-200">{{ comment.body|urlize(target='_blank') }}</p>
          </article>
        {% endfor %}
      {% else %}
        <p class="text-sm text-slate-400">No comments yet. Use the form below to add one.</p>
      {% endif %}
    </div>
    <form method="post" action="{{ url_for('service_customer_add_comment', customer_id=customer.id) }}" class="mt-5 space-y-3">
      {{ csrf_field() }}
      <div>
        <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1" for="customerCommentBody">Add comment</label>
        <textarea id="customerCommentBody" name="body" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-100 focus:border-emerald-400 focus:outline-none" placeholder="Record a call summary or paste a ticket link" required></textarea>
      </div>
      <button class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">Post comment</button>
    </form>
  </section>

  <section class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-theme-primary">Linked lifts</h2>
      <a href="{{ url_for('service_lifts') }}?q={{ customer.customer_code }}" class="rounded-xl border border-slate-700/70 px-3 py-1 text-xs text-slate-200 hover:bg-slate-800/70">Manage lifts</a>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-800 text-sm">
          <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3 text-left">Lift code</th>
              <th class="px-4 py-3 text-left">Type</th>
              <th class="px-4 py-3 text-left">Route</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Install date</th>
              <th class="px-4 py-3 text-left">Last service</th>
              <th class="px-4 py-3 text-left">Next due</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/80 text-slate-200">
            {% for lift in lifts %}
              <tr class="hover:bg-slate-800/40">
                <td class="px-4 py-3 font-semibold text-theme-primary">
                <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="text-left font-semibold text-theme-primary transition hover:text-emerald-200">{{ lift.lift_code }}</a>
                </td>
                <td class="px-4 py-3">{{ lift.lift_type or '—' }}</td>
                <td class="px-4 py-3">{{ lift.route or '—' }}</td>
                <td class="px-4 py-3">{{ lift.status or '—' }}</td>
                <td class="px-4 py-3">{{ lift.install_date.strftime('%d %b %Y') if lift.install_date else '—' }}</td>
                <td class="px-4 py-3">{{ lift.last_service_date.strftime('%d %b %Y') if lift.last_service_date else '—' }}</td>
                <td class="px-4 py-3">{{ lift.next_service_due.strftime('%d %b %Y') if lift.next_service_due else '—' }}</td>
                <td class="px-4 py-3">
                  <div class="flex flex-wrap gap-2">
                    <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20">View</a>
                    <a href="{{ url_for('service_lift_edit', lift_id=lift.id) }}" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-200 transition hover:bg-slate-800/70">Edit</a>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="8" class="px-4 py-6 text-center text-sm text-slate-400">No lifts linked yet. Create a lift and assign it to this customer to see it here.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

<template id="customerLiftList-{{ customer.id }}">
  <div class="space-y-3">
    {% if customer.open_lifts %}
      <ul class="space-y-2">
        {% for lift in customer.open_lifts %}
          <li class="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-900/70 p-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <div class="text-sm font-semibold text-slate-100">{{ lift.lift_code }}</div>
              <div class="text-xs text-slate-400">
                {{ lift.city or '—' }}
                {% if lift.status %}
                  · {{ lift.status }}
                {% endif %}
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20">View</a>
              <a href="{{ url_for('service_lift_edit', lift_id=lift.id) }}" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-200 transition hover:bg-slate-800/70">Edit</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-slate-400">No open lifts linked to this customer.</p>
    {% endif %}
  </div>
</template>

<dialog id="customerLiftListModal" class="modal-dialog">
  <div class="w-full max-w-3xl space-y-4 rounded-2xl border border-slate-800 bg-slate-950/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary" data-customer-lift-title>Open lifts</h2>
        <p class="text-xs text-slate-400" data-customer-lift-count></p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <div data-customer-lift-list class="space-y-3"></div>
  </div>
</dialog>

<dialog id="billingAddressModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customer_update_address', customer_id=customer.id) }}" class="w-full max-w-xl space-y-4 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit billing address</h2>
        <p class="text-xs text-slate-400">Update the billing location used for invoices and statements.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="address_type" value="billing" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Address line 1</span>
        <input name="billing_address_line1" value="{{ customer.billing_address_line1 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Address line 2</span>
        <input name="billing_address_line2" value="{{ customer.billing_address_line2 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="city" value="{{ customer.city or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="state" value="{{ customer.state or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="pincode" value="{{ customer.pincode or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <div class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Country</span>
        <p class="w-full rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-3 py-2 text-sm text-slate-400">India (default)</p>
      </div>
    </div>
    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Cancel</button>
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save billing address</button>
    </div>
  </form>
</dialog>

<dialog id="officeAddressModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customer_update_address', customer_id=customer.id) }}" class="w-full max-w-xl space-y-4 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Edit office address</h2>
        <p class="text-xs text-slate-400">Capture the customer's registered or head office details.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="address_type" value="office" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Address line 1</span>
        <input name="office_address_line1" value="{{ customer.office_address_line1 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Address line 2</span>
        <input name="office_address_line2" value="{{ customer.office_address_line2 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="office_city" value="{{ customer.office_city or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="office_state" value="{{ customer.office_state or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="office_pincode" value="{{ customer.office_pincode or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <div class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Country</span>
        <p class="w-full rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-3 py-2 text-sm text-slate-400">India (default)</p>
      </div>
    </div>
    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Cancel</button>
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save office address</button>
    </div>
  </form>
</dialog>

<script>
  (function() {
    function setupDialog(triggerSelector, modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) {
        return;
      }

      function openModal() {
        if (typeof modal.showModal === 'function') {
          modal.showModal();
        } else {
          modal.classList.add('open');
        }
      }

      function closeModal() {
        if (typeof modal.close === 'function') {
          modal.close();
        } else {
          modal.classList.remove('open');
        }
      }

      document.querySelectorAll(triggerSelector).forEach((trigger) => {
        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          openModal();
        });
      });

      modal.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          closeModal();
        });
      });

      modal.addEventListener('cancel', (event) => {
        event.preventDefault();
        closeModal();
      });

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    setupDialog('[data-address-edit="billing"]', 'billingAddressModal');
    setupDialog('[data-address-edit="office"]', 'officeAddressModal');
  })();
</script>

<script>
  (function() {
    const modal = document.getElementById('customerLiftListModal');
    if (!modal) {
      return;
    }

    const listContainer = modal.querySelector('[data-customer-lift-list]');
    const titleNode = modal.querySelector('[data-customer-lift-title]');
    const countNode = modal.querySelector('[data-customer-lift-count]');

    function formatCountLabel(count) {
      if (count <= 0) {
        return 'No open lifts currently linked.';
      }
      return `${count} open lift${count === 1 ? '' : 's'} for this customer.`;
    }

    function closeModal() {
      if (typeof modal.close === 'function') {
        modal.close();
      } else {
        modal.classList.remove('open');
      }
    }

    function openModal(customerId, customerName, openCount) {
      if (!listContainer) {
        return;
      }
      const template = document.getElementById(`customerLiftList-${customerId}`);
      if (!template) {
        return;
      }

      listContainer.innerHTML = '';
      listContainer.appendChild(template.content.cloneNode(true));

      if (titleNode) {
        titleNode.textContent = `Open lifts – ${customerName}`;
      }
      if (countNode) {
        countNode.textContent = formatCountLabel(openCount);
      }

      if (typeof modal.showModal === 'function') {
        modal.showModal();
      } else {
        modal.classList.add('open');
      }
    }

    document.addEventListener('click', (event) => {
      const trigger = event.target.closest('[data-customer-lifts]');
      if (trigger) {
        event.preventDefault();
        const customerId = trigger.getAttribute('data-customer-lifts');
        const customerName = trigger.getAttribute('data-customer-name') || 'Customer';
        const openCount = parseInt(trigger.getAttribute('data-customer-open-count') || '0', 10);
        openModal(customerId, customerName, Number.isNaN(openCount) ? 0 : openCount);
        return;
      }

      const closeTrigger = event.target.closest('#customerLiftListModal [data-modal-close]');
      if (closeTrigger) {
        event.preventDefault();
        closeModal();
      }
    });

    modal.addEventListener('cancel', (event) => {
      event.preventDefault();
      closeModal();
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  })();
</script>

</div>
{% endblock %}
