{% extends "base.html" %}
{% block title %}Service Settings · Eleva ERP{% endblock %}
{% block content %}
{% set import_result = session.pop('import_result', none) %}
{% set active = request.args.get('tab', 'dropdowns') %}
{% set tabs = [
  {'id': 'dropdowns', 'label': 'Dropdowns & Routes'},
  {'id': 'contracts', 'label': 'Contract Settings'},
  {'id': 'pricing', 'label': 'Price Settings'}
] %}
<div class="min-h-screen bg-slate-950/70 text-slate-100">
  <div class="mx-auto max-w-6xl px-6 py-10 space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-1">
        <p class="text-xs uppercase tracking-wide text-emerald-300">Service</p>
        <h1 class="text-2xl font-bold text-slate-100">Service Settings</h1>
        <p class="text-sm text-slate-400">Control dropdown values and service routes used across the Service workspace.</p>
      </div>
      <a href="{{ url_for('service_home') }}" class="inline-flex items-center gap-2 rounded-xl border border-slate-700/70 bg-slate-900/70 px-4 py-2 text-sm text-slate-200 hover:bg-slate-800/70">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6.75 5.25 12l5.25 5.25M5.25 12h13.5" />
        </svg>
        <span>Back to Service</span>
      </a>
    </div>

    <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 shadow-lg shadow-black/20">
      <div class="flex flex-wrap gap-2 border-b border-slate-800/60 bg-slate-900/60 px-4 pt-4" role="tablist">
        {% for tab in tabs %}
          <button type="button"
                  class="tab-trigger relative rounded-xl px-4 py-2 text-sm font-medium transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/50 {{ 'bg-slate-800/70 text-slate-100' if tab.id == active else 'text-slate-400 hover:text-slate-200' }}"
                  data-tab-button="{{ tab.id }}"
                  aria-selected="{{ 'true' if tab.id == active else 'false' }}"
                  aria-controls="service-settings-panel-{{ tab.id }}"
                  id="service-settings-tab-{{ tab.id }}">
            {{ tab.label }}
          </button>
        {% endfor %}
      </div>

      <div class="space-y-6 p-6">
        <section id="service-settings-panel-dropdowns"
                 class="motion-panel space-y-6 {{ 'is-active' if active == 'dropdowns' else 'hidden' }}"
                 role="tabpanel"
                 aria-labelledby="service-settings-tab-dropdowns"
                 data-tab-panel="dropdowns">
    <section class="rounded-2xl border border-slate-800/60 bg-slate-900/50 p-6 space-y-6">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-base font-semibold text-slate-100">Service dropdown options</h2>
          <p class="text-sm text-slate-400">Control the selectable values for lift configuration fields across create and edit forms.</p>
        </div>
      </div>

      <div class="space-y-6">
        {% for category, group in service_dropdown_groups.items() %}
          <section id="dropdown-{{ category }}" class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-5" data-dropdown-section data-dropdown-category="{{ category }}">
            <button type="button" class="flex w-full items-center justify-between gap-3 text-left" data-dropdown-section-trigger aria-expanded="false">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">{{ group.label }}</h3>
                <p class="text-xs text-slate-400">Used in Service → Lifts when capturing lift details.</p>
              </div>
              <span class="flex h-8 w-8 items-center justify-center rounded-full border border-slate-700/70 bg-slate-800/60 text-base font-semibold text-emerald-200" data-dropdown-section-icon aria-hidden="true">+</span>
            </button>

            <div class="mt-4 space-y-4 hidden" data-dropdown-section-body>
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between rounded-lg border border-slate-800/70 bg-slate-900/70 px-3 py-2">
                <div class="space-y-1">
                  <a href="{{ url_for('service_settings_dropdown_template', category=category) }}" class="inline-flex items-center gap-2 rounded-lg border border-slate-700/70 bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-700/70">Export CSV</a>
                  <p class="text-[11px] text-slate-500">Exports current options so you can append and re-import.</p>
                </div>
                <form method="post" action="{{ url_for('service_settings_dropdown_import', category=category) }}" enctype="multipart/form-data" class="flex flex-wrap items-center gap-2">
                  {{ csrf_field() }}
                  <input type="file" name="import_file" accept=".csv" required class="block w-full max-w-xs rounded-lg border border-slate-700 bg-slate-900 px-2 py-1.5 text-xs text-slate-200 file:mr-2 file:rounded-md file:border-0 file:bg-slate-700 file:px-2 file:py-1 file:text-xs file:font-semibold file:text-slate-100" />
                  <button type="submit" class="rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-1.5 text-xs font-semibold text-emerald-100">Import</button>
                </form>
              </div>

              <form method="post" action="{{ url_for('service_settings_dropdown_add') }}" class="grid gap-3 sm:grid-cols-[minmax(0,1fr),120px,auto] sm:items-end">
                {{ csrf_field() }}
                <input type="hidden" name="category" value="{{ category }}" />
                <label class="space-y-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-300">Value</span>
                  <input name="value" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" data-add-value-input />
                </label>
                <label class="space-y-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-300">Sort order</span>
                  <input type="number" name="sort_order" placeholder="auto" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" data-add-sort-order-input />
                </label>
                <button type="submit" class="rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-2 text-xs font-semibold text-emerald-100">Add option</button>
              </form>

              <div>
                <p class="text-xs uppercase tracking-wide text-slate-300">Active options</p>
                <ul class="mt-2 space-y-2" data-service-dropdown-list data-category="{{ category }}" data-reorder-url="{{ url_for('service_settings_dropdown_reorder') }}">
                  {% for option in group.active %}
                    <li class="rounded-lg border border-slate-800/70 bg-slate-900/80 px-3 py-2 text-sm" data-service-dropdown-item data-option-id="{{ option.id }}" data-sort-order="{{ option.sort_order }}">
                      <div class="flex items-start justify-between gap-3" data-service-dropdown-view>
                        <div class="flex items-center gap-2">
                          <span class="text-slate-400" aria-hidden="true">☰</span>
                          <span>{{ option.value }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <button type="button" class="rounded-lg border border-slate-600/60 bg-slate-800 px-2 py-1 text-xs text-slate-200" data-service-dropdown-edit>Edit</button>
                          <form method="post" action="{{ url_for('service_settings_dropdown_toggle') }}">
                            {{ csrf_field() }}
                            <input type="hidden" name="category" value="{{ category }}" />
                            <input type="hidden" name="option_id" value="{{ option.id }}" />
                            <button type="submit" class="rounded-lg border border-amber-400/40 bg-amber-400/10 px-2 py-1 text-xs text-amber-200">Deactivate</button>
                          </form>
                        </div>
                      </div>
                      <form method="post" action="{{ url_for('service_settings_dropdown_update') }}" class="mt-2 hidden" data-service-dropdown-edit-form>
                        {{ csrf_field() }}
                        <input type="hidden" name="option_id" value="{{ option.id }}" />
                        <div class="grid gap-2 sm:grid-cols-[minmax(0,1fr),120px,auto,auto] sm:items-end">
                          <label class="space-y-1">
                            <span class="text-xs font-semibold uppercase tracking-wide text-slate-300">Value</span>
                            <input name="value" value="{{ option.value }}" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                          </label>
                          <label class="space-y-1">
                            <span class="text-xs font-semibold uppercase tracking-wide text-slate-300">Sort order</span>
                            <input type="number" name="sort_order" value="{{ option.sort_order }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" data-service-dropdown-sort-input />
                          </label>
                          <button type="submit" class="rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-2 text-xs font-semibold text-emerald-100">Save</button>
                          <button type="button" class="rounded-lg border border-slate-600/60 bg-slate-800 px-3 py-2 text-xs text-slate-200" data-service-dropdown-cancel>Cancel</button>
                        </div>
                      </form>
                    </li>
                  {% else %}
                    <li class="text-xs text-slate-400">No active options yet.</li>
                  {% endfor %}
                </ul>
                <div class="mt-2 hidden text-xs text-rose-300" data-service-dropdown-error></div>
              </div>

              {% if group.inactive %}
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Inactive options</p>
                  <ul class="mt-2 space-y-2">
                    {% for option in group.inactive %}
                      <li class="flex items-center justify-between gap-3 rounded-lg border border-slate-800/60 bg-slate-900/40 px-3 py-2 text-sm text-slate-300">
                        <span>{{ option.value }}</span>
                        <form method="post" action="{{ url_for('service_settings_dropdown_toggle') }}">
                          {{ csrf_field() }}
                          <input type="hidden" name="category" value="{{ category }}" />
                          <input type="hidden" name="option_id" value="{{ option.id }}" />
                          <button type="submit" class="rounded-lg border border-emerald-400/40 bg-emerald-400/10 px-2 py-1 text-xs text-emerald-200">Reactivate</button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </div>
          </section>
        {% endfor %}
      </div>

    </section>

    <section class="rounded-2xl border border-slate-800/60 bg-slate-900/50 p-6 space-y-6">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-base font-semibold text-slate-100">Service routes</h2>
          <p class="text-sm text-slate-400">Manage the list of states that service teams can assign to customers and lifts.</p>
        </div>
      </div>

      <form method="post" action="{{ url_for('settings_service_route_create') }}" class="grid gap-3 md:grid-cols-[minmax(0,1fr),minmax(0,1fr),minmax(0,1fr),auto] md:items-end">
        {{ csrf_field() }}
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Route name</span>
          <input name="route_name" required placeholder="e.g. Panaji Urban" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
          <p class="text-xs text-slate-300">Type a new service route name to map it to a branch.</p>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Branch</span>
          <select name="branch" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-1.5 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none">
            <option value="">Select branch</option>
            {% for branch in SERVICE_BRANCH_OPTIONS %}
              <option value="{{ branch }}">{{ branch }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Remark</span>
          <input name="remark" placeholder="Optional note for coded route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
        </label>
        <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Add route</button>
      </form>

      <div class="space-y-3">
        {% if service_routes %}
          {% for route in service_routes %}
            <div class="space-y-3 rounded-2xl border border-slate-800/60 bg-slate-900/60 p-4 text-sm text-slate-200">
              <form method="post" action="{{ url_for('settings_service_route_update', route_id=route.id) }}" class="grid gap-3 md:grid-cols-[minmax(0,1fr),minmax(0,1fr),minmax(0,1fr),auto] md:items-end">
                {{ csrf_field() }}
                <label class="space-y-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Route name</span>
                  <input name="route_name" value="{{ route.route_name }}" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
                </label>
                <label class="space-y-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Branch</span>
                  <select name="branch" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-1.5 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none">
                    <option value="">Select branch</option>
                    {% for branch in SERVICE_BRANCH_OPTIONS %}
                      <option value="{{ branch }}" {% if route.branch and route.branch.lower() == branch.lower() %}selected{% endif %}>{{ branch }}</option>
                    {% endfor %}
                  </select>
                </label>
                <label class="space-y-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Remark</span>
                  <input name="remark" value="{{ route.remark or '' }}" placeholder="Optional note" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
                </label>
                <div class="flex justify-end gap-2">
                  <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save</button>
                </div>
              </form>
              <div class="flex flex-wrap items-center justify-between gap-2 text-xs">
                <span class="text-slate-500">Created {{ route.created_at.strftime('%d %b %Y') if route.created_at else '—' }}</span>
                <form method="post" action="{{ url_for('settings_service_route_delete', route_id=route.id) }}" class="flex items-center">
                  {{ csrf_field() }}
                  <button type="submit" class="rounded-xl border border-red-500/40 bg-red-500/10 px-3 py-1.5 text-xs font-semibold text-red-200 hover:bg-red-500/20" onclick="return confirm('Remove this route?');">Remove</button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="rounded-xl border border-dashed border-slate-700/70 bg-slate-900/40 p-5 text-sm text-slate-400">
            No service routes defined yet. Add a route above to populate the dropdowns in Service → Customers and Lifts.
          </div>
        {% endif %}
      </div>
    </section>
        </section>

        <section id="service-settings-panel-contracts"
                 class="motion-panel space-y-6 {{ 'is-active' if active == 'contracts' else 'hidden' }}"
                 role="tabpanel"
                 aria-labelledby="service-settings-tab-contracts"
                 data-tab-panel="contracts">
          <section id="contract-settings" class="rounded-2xl border border-slate-800/60 bg-slate-900/50 p-6 space-y-4">
            <div>
              <h2 class="text-base font-semibold text-slate-100">Contract Settings</h2>
              <p class="text-sm text-slate-400">Maintain contract document template sections with simple rich text formatting.</p>
            </div>
            <form method="post" action="{{ url_for('service_contract_template_settings') }}" class="space-y-4">
              {{ csrf_field() }}
              {% for key, label, value in [("intro", "Intro pages format", contract_template.intro_html or ""), ("spec", "Contract & lift specs format", contract_template.spec_html or ""), ("terms", "Terms & Conditions format", contract_template.terms_html or "")] %}
                <div class="rounded-xl border border-slate-800/70 bg-slate-900/70 p-3 space-y-2">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-300">{{ label }}</p>
                  <div class="flex gap-2 text-xs">
                    <button type="button" data-editor-action="bold" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">Bold</button>
                    <button type="button" data-editor-action="italic" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">Italic</button>
                    <button type="button" data-editor-action="underline" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">Underline</button>
                    <button type="button" data-editor-action="insertUnorderedList" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">Bullets</button>
                    <button type="button" data-editor-action="formatBlock:h2" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">H2</button>
                    <button type="button" data-editor-action="formatBlock:p" data-editor-target="{{ key }}" class="rounded border border-slate-700 px-2 py-1">Paragraph</button>
                  </div>
                  <div contenteditable="true" data-editor="{{ key }}" class="min-h-[140px] rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-sm text-slate-100">{{ value|safe }}</div>
                  <textarea name="{{ key }}_html" data-editor-input="{{ key }}" class="hidden"></textarea>
                </div>
              {% endfor %}
              <div class="flex justify-end">
                <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100">Save Contract Templates</button>
              </div>
            </form>
          </section>
        </section>

        <section id="service-settings-panel-pricing"
                 class="motion-panel space-y-6 {{ 'is-active' if active == 'pricing' else 'hidden' }}"
                 role="tabpanel"
                 aria-labelledby="service-settings-tab-pricing"
                 data-tab-panel="pricing">
          <section id="price-settings" class="rounded-2xl border border-slate-800/60 bg-slate-900/50 p-6 space-y-4">
            <div>
              <h2 class="text-base font-semibold text-slate-100">Price Settings</h2>
              <p class="text-sm text-slate-400">Maintain standard contract pricing combinations for lift type, floors, duration and frequency.</p>
            </div>
            <form method="post" action="{{ url_for('service_contract_price_add') }}" class="grid gap-3 md:grid-cols-6">
              {{ csrf_field() }}
              <select name="lift_type_key" required class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs">
                <option value="">Lift type</option>
                {% for option in lift_type_options %}<option value="{{ option.value }}">{{ option.label }}</option>{% endfor %}
              </select>
              <select name="floors_value" required class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs">
                <option value="">Floors</option>
                {% for option in floors_options %}<option value="{{ option.value }}">{{ option.value }}</option>{% endfor %}
              </select>
              <select name="contract_type" required data-contract-type-select class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs">
                <option value="">Contract type</option>
                {% for value, label in contract_type_options %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
              </select>
              <select name="duration_years" required class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs">
                <option value="">Duration</option>
                {% for years in contract_duration_options %}<option value="{{ years }}">{{ years }} years</option>{% endfor %}
              </select>
              <select name="frequency_per_year" required data-frequency-select class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs"></select>
              <input name="price" type="number" min="0" step="0.01" required placeholder="Price" class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-2 text-xs" />
              <div class="md:col-span-6 flex justify-end"><button type="submit" class="rounded-lg border border-emerald-500/40 bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-100">Add price row</button></div>
            </form>
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs text-slate-200">
                <thead class="text-slate-400"><tr><th class="px-2 py-2 text-left">Lift Type</th><th class="px-2 py-2 text-left">Floors</th><th class="px-2 py-2 text-left">Type</th><th class="px-2 py-2 text-left">Duration</th><th class="px-2 py-2 text-left">Frequency</th><th class="px-2 py-2 text-left">Price</th><th class="px-2 py-2 text-left">Actions</th></tr></thead>
                <tbody>
                  {% for row in contract_prices %}
                    <tr class="border-t border-slate-800">
                      <td class="px-2 py-2">{{ row.lift_type_key }}</td><td class="px-2 py-2">{{ row.floors_value }}</td><td class="px-2 py-2">{{ row.contract_type }}</td><td class="px-2 py-2">{{ row.duration_years }}y</td><td class="px-2 py-2">{{ 'N/A' if row.frequency_per_year == 0 else row.frequency_per_year }}</td>
                      <td class="px-2 py-2">
                        <form method="post" action="{{ url_for('service_contract_price_update', price_id=row.id) }}" class="flex gap-2">{{ csrf_field() }}<input type="number" name="price" step="0.01" min="0" value="{{ '%.2f'|format(row.price or 0) }}" class="w-24 rounded border border-slate-700 bg-slate-900 px-2 py-1"><button class="rounded border border-slate-700 px-2">Edit</button></form>
                      </td>
                      <td class="px-2 py-2"><form method="post" action="{{ url_for('service_contract_price_toggle', price_id=row.id) }}">{{ csrf_field() }}<button class="rounded border px-2 py-1 {{ 'border-amber-500/50 text-amber-200' if row.is_active else 'border-emerald-500/50 text-emerald-200' }}">{{ 'Deactivate' if row.is_active else 'Activate' }}</button></form></td>
                    </tr>
                  {% else %}
                    <tr><td colspan="7" class="px-2 py-4 text-center text-slate-500">No price rows configured.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
        </section>
      </div>
    </div>
  </div>
</div>
{% if import_result %}
  <div id="import-summary-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/75 px-4" role="dialog" aria-modal="true" aria-labelledby="import-summary-title">
    <div class="w-full max-w-md rounded-2xl border border-slate-700 bg-slate-900 p-5 shadow-2xl" data-import-summary-panel>
      <div class="flex items-start justify-between gap-3">
        <h2 id="import-summary-title" class="text-lg font-semibold text-slate-100">Import Summary</h2>
        <button type="button" class="rounded-md border border-slate-600 bg-slate-800 px-2 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-700" data-import-summary-close>Close</button>
      </div>
      <div class="mt-4 space-y-2 text-sm text-slate-200">
        {% set added = import_result.get('added', 0) %}
        {% set duplicates = import_result.get('duplicates', 0) %}
        {% set errors = import_result.get('errors', 0) %}
        {% set rejected = duplicates + errors %}
        {% set error_lines = import_result.get('error_lines', []) %}

        {% if rejected == 0 %}
          <p>Import successful. {{ added }} added.</p>
        {% elif added == 0 and duplicates > 0 and errors == 0 %}
          <p>No new records added. {{ duplicates }} duplicates skipped.</p>
        {% else %}
          <p>{{ added }} added</p>
          <p>{{ rejected }} rejected</p>
          <p class="text-slate-300">Breakdown:</p>
          <ul class="list-disc space-y-1 pl-5 text-slate-300">
            <li>{{ duplicates }} duplicates found</li>
            <li>{{ errors }} errors</li>
          </ul>
          {% if error_lines %}
            <p>Errors found on line(s): {{ error_lines|join(', ') }}</p>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = Array.from(document.querySelectorAll('[data-tab-button]'));
      const panels = Array.from(document.querySelectorAll('[data-tab-panel]'));
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (buttons.length) {
        const activateTab = (id) => {
          buttons.forEach((button) => {
            const isActive = button.dataset.tabButton === id;
            button.setAttribute('aria-selected', isActive ? 'true' : 'false');
            button.classList.toggle('bg-slate-800/70', isActive);
            button.classList.toggle('text-slate-100', isActive);
            button.classList.toggle('text-slate-400', !isActive);
            button.classList.toggle('hover:text-slate-200', !isActive);
          });

          panels.forEach((panel) => {
            const isActive = panel.dataset.tabPanel === id;
            if (isActive) {
              panel.classList.remove('hidden');
              requestAnimationFrame(() => {
                panel.classList.add('is-active');
              });
            } else {
              panel.classList.remove('is-active');
              if (panel.classList.contains('hidden')) {
                return;
              }
              if (prefersReducedMotion) {
                panel.classList.add('hidden');
                return;
              }
              const handleTransition = (event) => {
                if (event.target !== panel || event.propertyName !== 'opacity') {
                  return;
                }
                if (panel.classList.contains('is-active')) {
                  return;
                }
                panel.classList.add('hidden');
              };
              panel.addEventListener('transitionend', handleTransition, { once: true });
            }
          });

          try {
            const url = new URL(window.location.href);
            url.searchParams.set('tab', id);
            window.history.replaceState({}, '', url);
          } catch (err) {
            // Ignore navigation updates if the browser does not support URL API.
          }
        };

        buttons.forEach((button) => {
          button.addEventListener('click', () => activateTab(button.dataset.tabButton));
        });

        const initialTab = new URLSearchParams(window.location.search).get('tab') || buttons[0].dataset.tabButton;
        activateTab(initialTab);
      }

      const importSummaryModal = document.getElementById('import-summary-modal');
      const closeImportSummaryModal = () => {
        if (!importSummaryModal) {
          return;
        }
        importSummaryModal.remove();
        document.removeEventListener('keydown', handleImportSummaryEsc);
      };
      const handleImportSummaryEsc = (event) => {
        if (event.key === 'Escape') {
          closeImportSummaryModal();
        }
      };
      if (importSummaryModal) {
        const panel = importSummaryModal.querySelector('[data-import-summary-panel]');
        const closeButton = importSummaryModal.querySelector('[data-import-summary-close]');
        if (closeButton) {
          closeButton.addEventListener('click', closeImportSummaryModal);
        }
        importSummaryModal.addEventListener('click', (event) => {
          if (panel && !panel.contains(event.target)) {
            closeImportSummaryModal();
          }
        });
        document.addEventListener('keydown', handleImportSummaryEsc);
      }

      const openCategory = {{ request.args.get('open', '')|tojson }};
      const shouldFocusValue = {{ (request.args.get('focus') == 'value')|tojson }};
      const dropdownSections = Array.from(document.querySelectorAll('[data-dropdown-section]'));
      dropdownSections.forEach((section) => {
        const trigger = section.querySelector('[data-dropdown-section-trigger]');
        const body = section.querySelector('[data-dropdown-section-body]');
        const icon = section.querySelector('[data-dropdown-section-icon]');
        const category = section.getAttribute('data-dropdown-category');
        if (!trigger || !body) {
          return;
        }

        const setExpanded = (expanded) => {
          trigger.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          body.classList.toggle('hidden', !expanded);
          if (icon) {
            icon.textContent = expanded ? '−' : '+';
          }
        };

        setExpanded(openCategory && category === openCategory);
        trigger.addEventListener('click', () => {
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          setExpanded(!isExpanded);
        });

        if (openCategory && category === openCategory) {
          const valueInput = section.querySelector('[data-add-value-input]');
          const sortOrderInput = section.querySelector('[data-add-sort-order-input]');
          if (sortOrderInput) {
            sortOrderInput.value = '';
          }
          if (valueInput && shouldFocusValue) {
            valueInput.value = '';
            window.requestAnimationFrame(() => {
              valueInput.focus();
            });
          }
        }
      });

      const dropdownLists = Array.from(document.querySelectorAll('[data-dropdown-list]'));
      const serviceDropdownLists = Array.from(document.querySelectorAll('[data-service-dropdown-list]'));
      [...dropdownLists, ...serviceDropdownLists].forEach((list) => {
        const reorderUrl = list.getAttribute('data-reorder-url');
        if (!reorderUrl) {
          return;
        }

        const isServiceList = list.hasAttribute('data-service-dropdown-list');
        const itemSelector = isServiceList ? '[data-service-dropdown-item]' : '[data-dropdown-item]';
        const inlineError = isServiceList ? list.parentElement?.querySelector('[data-service-dropdown-error]') : null;
        const renderInlineError = (message, responseText = '') => {
          if (!inlineError) {
            return;
          }
          const escapedMessage = String(message || 'Unknown error').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const snippet = String(responseText || '').slice(0, 200);
          inlineError.innerHTML = `${escapedMessage} <button type="button" class="ml-2 underline" data-service-dropdown-reload>Reload</button>`;
          inlineError.classList.remove('hidden');
          const reloadButton = inlineError.querySelector('[data-service-dropdown-reload]');
          if (reloadButton) {
            reloadButton.addEventListener('click', () => window.location.reload());
          }
          if (snippet) {
            console.error('Reorder response snippet:', snippet);
          }
        };
        const getOrder = () =>
          Array.from(list.querySelectorAll(itemSelector))
            .map((item) => item.getAttribute('data-option-id'))
            .filter((value) => value !== null && value !== undefined && value !== '');

        let dragItem = null;
        let lastOrder = getOrder();

        const persistOrder = () => {
          const currentOrder = getOrder();
          if (!currentOrder.length || JSON.stringify(currentOrder) === JSON.stringify(lastOrder)) {
            return;
          }
          if (inlineError) {
            inlineError.classList.add('hidden');
            inlineError.textContent = '';
          }
          lastOrder = currentOrder;
          const payload = isServiceList
            ? {
                category: list.getAttribute('data-category'),
                ordered_ids: currentOrder,
              }
            : { order: currentOrder };
          fetch(reorderUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
          })
            .then(async (response) => {
              const responseText = await response.text();
              let data = null;
              try {
                data = responseText ? JSON.parse(responseText) : null;
              } catch (parseError) {
                const snippet = String(responseText || '').slice(0, 200);
                if (snippet) {
                  console.error('Reorder response snippet:', snippet);
                }
                throw {
                  message: `Unable to save the new order right now (HTTP ${response.status}).`,
                  responseText,
                };
              }
              if (!response.ok || !data?.ok) {
                const backendError = data?.error ? ` (${data.error})` : '';
                throw {
                  message: `Reorder failed: HTTP ${response.status}${backendError}`,
                  responseText,
                };
              }
              return data;
            })
            .then(() => {
              if (!isServiceList) {
                return;
              }
              Array.from(list.querySelectorAll(itemSelector)).forEach((item, index) => {
                const nextSortOrder = index + 1;
                item.setAttribute('data-sort-order', String(nextSortOrder));
                const sortInput = item.querySelector('[data-service-dropdown-sort-input]');
                if (sortInput) {
                  sortInput.value = String(nextSortOrder);
                }
              });
            })
            .catch((error) => {
              console.error('Failed to reorder dropdown options', error);
              renderInlineError(
                error?.message || 'Unable to save the new order.',
                error?.responseText || '',
              );
            });
        };

        const attachDragEvents = (item) => {
          if (!item) {
            return;
          }
          item.setAttribute('draggable', 'true');
          item.addEventListener('dragstart', (event) => {
            dragItem = item;
            item.classList.add('opacity-60');
            if (event.dataTransfer) {
              event.dataTransfer.effectAllowed = 'move';
              const optionId = item.getAttribute('data-option-id') || '';
              event.dataTransfer.setData('text/plain', optionId);
            }
          });

          item.addEventListener('dragend', () => {
            item.classList.remove('opacity-60');
            dragItem = null;
            persistOrder();
          });

          item.addEventListener('dragover', (event) => {
            event.preventDefault();
            const target = event.currentTarget;
            if (!dragItem || dragItem === target || !target.parentElement) {
              return;
            }
            const children = Array.from(target.parentElement.querySelectorAll(itemSelector));
            const dragIndex = children.indexOf(dragItem);
            const targetIndex = children.indexOf(target);
            if (dragIndex < targetIndex) {
              target.after(dragItem);
            } else {
              target.before(dragItem);
            }
          });
        };

        list.querySelectorAll(itemSelector).forEach((item) => attachDragEvents(item));
      });

      document.querySelectorAll('[data-service-dropdown-item]').forEach((item) => {
        const view = item.querySelector('[data-service-dropdown-view]');
        const editForm = item.querySelector('[data-service-dropdown-edit-form]');
        const editButton = item.querySelector('[data-service-dropdown-edit]');
        const cancelButton = item.querySelector('[data-service-dropdown-cancel]');
        if (!view || !editForm || !editButton || !cancelButton) {
          return;
        }
        editButton.addEventListener('click', () => {
          const sortInput = editForm.querySelector('[data-service-dropdown-sort-input]');
          const latestSortOrder = item.getAttribute('data-sort-order');
          if (sortInput && latestSortOrder) {
            sortInput.value = latestSortOrder;
          }
          view.classList.add('hidden');
          editForm.classList.remove('hidden');
        });
        cancelButton.addEventListener('click', () => {
          editForm.classList.add('hidden');
          view.classList.remove('hidden');
        });
      });

      const editorActions = document.querySelectorAll('[data-editor-action]');
      editorActions.forEach((button) => {
        button.addEventListener('click', () => {
          const target = button.getAttribute('data-editor-target');
          const editor = document.querySelector(`[data-editor="${target}"]`);
          if (!editor) return;
          editor.focus();
          const actionRaw = button.getAttribute('data-editor-action') || '';
          if (actionRaw.startsWith('formatBlock:')) {
            document.execCommand('formatBlock', false, actionRaw.split(':')[1]);
          } else {
            document.execCommand(actionRaw, false, null);
          }
        });
      });

      document.querySelectorAll('form').forEach((form) => {
        form.addEventListener('submit', () => {
          form.querySelectorAll('[data-editor-input]').forEach((input) => {
            const key = input.getAttribute('data-editor-input');
            const editor = form.querySelector(`[data-editor="${key}"]`);
            if (editor) {
              input.value = editor.innerHTML;
            }
          });
        });
      });

      const contractTypeSelect = document.querySelector('[data-contract-type-select]');
      const frequencySelect = document.querySelector('[data-frequency-select]');
      const frequencyOptions = {{ contract_frequency_options|tojson }};
      const setFrequencyOptions = () => {
        if (!contractTypeSelect || !frequencySelect) return;
        const contractType = contractTypeSelect.value;
        const values = frequencyOptions[contractType] || [];
        frequencySelect.innerHTML = '';
        values.forEach((value) => {
          const option = document.createElement('option');
          option.value = String(value);
          option.textContent = value === 0 ? 'N/A' : `${value} / year`;
          frequencySelect.appendChild(option);
        });
        const hide = contractType === 'call_basis';
        const frequencyWrap = frequencySelect.parentElement;
        if (frequencyWrap) { frequencyWrap.style.display = hide ? 'none' : ''; }
      };
      if (contractTypeSelect && frequencySelect) {
        contractTypeSelect.addEventListener('change', setFrequencyOptions);
        setFrequencyOptions();
      }
    });
  </script>
{% endblock %}
