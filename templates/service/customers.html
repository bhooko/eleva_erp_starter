{% extends "base.html" %}
{% block title %}Eleva ERP – Customers{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-theme-primary">Customers</h1>
      <p class="text-sm text-slate-400">Manage every customer record, update account details and review linked lifts.</p>
    </div>
    <div class="flex gap-2">
      {% if current_user.is_admin %}
        <a
          href="{{ url_for('service_customers_export', q=search_query) }}"
          class="rounded-xl border border-slate-700/70 bg-slate-800/70 px-3 py-2 text-xs text-slate-300 transition hover:text-white"
        >
          Export customers
        </a>
      {% endif %}
      <button type="button" data-modal-open="customer-upload" class="rounded-xl border border-slate-700/70 bg-slate-800/70 px-3 py-2 text-xs text-slate-300 transition hover:text-white">Upload customers</button>
      <button type="button" data-modal-open="customer-create" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">Add customer</button>
    </div>
  </header>

  <form method="get" action="{{ url_for('service_customers') }}" class="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-900/60 p-4 sm:flex-row sm:items-center sm:justify-between">
    <label for="customerSearch" class="flex-1">
      <span class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Quick search</span>
      <input id="customerSearch" name="q" value="{{ search_query or '' }}" placeholder="Search by customer code, customer name or contact" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
    </label>
    <div class="flex gap-2 pt-1 sm:pt-6">
      <button type="submit" class="rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">Search</button>
      <a href="{{ url_for('service_customers') }}" class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Reset</a>
    </div>
  </form>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-800 text-sm">
        <thead class="bg-slate-900/90 text-[11px] uppercase tracking-wide text-slate-200">
          <tr>
            <th class="px-4 py-3 text-left">Customer Code</th>
            <th class="px-4 py-3 text-left">Customer Name</th>
            <th class="px-4 py-3 text-left">Contact Person</th>
            <th class="px-4 py-3 text-left">Branch</th>
            <th class="px-4 py-3 text-left">City</th>
            <th class="px-4 py-3 text-center">Linked Lifts</th>
            <th class="px-4 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800/80 text-slate-200">
          {% for customer in customers %}
            <tr class="hover:bg-slate-800/40">
              <td class="px-4 py-3 font-semibold text-theme-primary">{{ customer.customer_code }}</td>
              <td class="px-4 py-3">
                <a href="{{ url_for('service_customer_detail', customer_id=customer.id) }}" class="font-semibold text-emerald-200 hover:text-emerald-100">{{ customer.company_name }}</a>
                <div class="text-xs text-slate-400">{{ customer.email or '—' }}</div>
              </td>
              <td class="px-4 py-3">{{ customer.contact_person or '—' }}</td>
              <td class="px-4 py-3">{{ customer.branch or '—' }}</td>
              <td class="px-4 py-3">{{ customer.city or '—' }}</td>
              <td class="px-4 py-3 text-center">
                <button
                  type="button"
                  data-customer-lifts="{{ customer.id }}"
                  data-customer-name="{{ customer.company_name }}"
                  data-customer-open-count="{{ customer.open_lifts|length }}"
                  class="inline-flex min-w-[3rem] items-center justify-center rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20"
                >
                  {{ customer.lifts|length }}
                </button>
              </td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap items-center gap-2">
                  <a href="{{ url_for('service_customer_detail', customer_id=customer.id) }}" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-200 hover:bg-slate-800/70">Open</a>
                  {% if current_user.is_admin %}
                    <form method="post" action="{{ url_for('service_customer_delete', customer_id=customer.id) }}" class="inline-flex" onsubmit="return confirm('Delete customer {{ customer.customer_code }}? This action cannot be undone.');">
                      <input type="hidden" name="next" value="{{ request.full_path }}" />
                      <button type="submit" class="rounded-lg border border-rose-500/50 bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-200 transition hover:bg-rose-500/20">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7" class="px-4 py-6 text-center text-sm text-slate-400">No customers found. Use the <strong class="text-slate-200">Add customer</strong> button to create your first record.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% for customer in customers %}
  <template id="customerLiftList-{{ customer.id }}">
    <div class="space-y-3">
      {% if customer.open_lifts %}
        <ul class="space-y-2">
          {% for lift in customer.open_lifts %}
            <li class="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-900/70 p-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <div class="text-sm font-semibold text-slate-100">{{ lift.lift_code }}</div>
                <div class="text-xs text-slate-400">
                  {{ lift.city or '—' }}
                  {% if lift.status %}
                    · {{ lift.status }}
                  {% endif %}
                </div>
              </div>
              <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20">View</a>
                <a href="{{ url_for('service_lift_edit', lift_id=lift.id) }}" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-200 transition hover:bg-slate-800/70">Edit</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-slate-400">No open lifts linked to this customer.</p>
      {% endif %}
    </div>
  </template>
{% endfor %}

<dialog id="customerLiftListModal" class="modal-dialog">
  <div class="w-full max-w-3xl space-y-4 rounded-2xl border border-slate-800 bg-slate-950/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary" data-customer-lift-title>Open lifts</h2>
        <p class="text-xs text-slate-400" data-customer-lift-count></p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <div data-customer-lift-list class="space-y-3"></div>
  </div>
</dialog>

<dialog id="customerUploadModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customers_upload') }}" enctype="multipart/form-data" class="w-full max-w-2xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Bulk upload customers</h2>
        <p class="text-xs text-slate-400">Import customer master data before linking AMC lifts.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 transition hover:bg-slate-800/70">Close</button>
    </div>

    <div class="space-y-4 rounded-xl border border-slate-800/80 bg-slate-900/70 p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-sm font-semibold text-slate-100">Template</h3>
          <p class="text-xs text-slate-400">Includes an instructions sheet and sample row. Remove the sample before uploading.</p>
        </div>
        <a href="{{ url_for('service_customers_upload_template') }}" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20" target="_blank" rel="noopener">Download template</a>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-slate-100">Before you upload</h3>
        <ul class="mt-2 space-y-2 text-xs text-slate-400">
          <li>• Fill one customer per row and keep customer codes unique.</li>
          <li>• External customer ID helps link multiple lifts to the same customer.</li>
          <li>• Route must match an active service route, and branch must be Goa or Mumbai.</li>
          <li>• Leave optional cells blank to keep existing customer values unchanged.</li>
        </ul>
      </div>
    </div>

    <div class="space-y-2">
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400" for="customerUploadFile">Upload filled workbook</label>
      <input id="customerUploadFile" name="customer_upload_file" type="file" accept=".xlsx,.csv" required class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
      <p class="text-xs text-slate-300">Download the template and re-upload it as .xlsx or .csv.</p>
    </div>

    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 transition hover:bg-slate-800/70">Cancel</button>
      <button type="submit" class="rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 transition hover:bg-emerald-500/30">Upload workbook</button>
    </div>
  </form>
</dialog>

<dialog id="customerCreateModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customers_create') }}" class="w-full max-w-3xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Create customer</h2>
        <p class="text-xs text-slate-400">Capture billing details and contact information for a new customer.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
        <input value="{{ next_customer_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
        <p class="text-xs text-slate-300">Assigned automatically on save.</p>
      </label>
      <label class="space-y-1 md:col-span-1">
                <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer name</span>
        <input name="company_name" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Acme Pvt. Ltd." />
        <p class="text-xs text-slate-300">Suggestion: Company Name</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Contact person</span>
        <input name="contact_person" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Email</span>
        <input type="email" name="email" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Phone</span>
        <input name="phone" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Landline" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Mobile</span>
        <input name="mobile" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Primary contact" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">GST number</span>
        <input name="gst_no" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Category</span>
        <select name="category" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select category</option>
          {% for option in ["Individual", "Company", "Proprietorship"] %}
            <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Branch</span>
        {% set selected_branch = request.form.get('branch') %}
        {% set selected_branch_lower = selected_branch.lower() if selected_branch else '' %}
        <select name="branch" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select branch</option>
          {% for branch in SERVICE_BRANCH_OPTIONS %}
            {% set branch_lower = branch.lower() %}
            <option value="{{ branch }}" {% if selected_branch and selected_branch_lower == branch_lower %}selected{% endif %}>{{ branch }}</option>
          {% endfor %}
          {% if selected_branch and selected_branch_lower not in SERVICE_BRANCH_OPTION_SET %}
            <option value="{{ selected_branch }}" selected>{{ selected_branch }}</option>
          {% endif %}
        </select>
      </label>
    </div>
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1 md:col-span-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Billing address line 1</span>
        <input name="billing_address_line1" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1 md:col-span-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Billing address line 2</span>
        <input name="billing_address_line2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="city" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="state" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="pincode" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <div class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Country</span>
        <p class="w-full rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-3 py-2 text-sm text-slate-400">India (default)</p>
      </div>
    </div>
    <div class="grid gap-4 md:grid-cols-2">
      <div class="md:col-span-2">
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Office address</p>
      </div>
      <label class="space-y-1 md:col-span-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office address line 1</span>
        <input name="office_address_line1" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1 md:col-span-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office address line 2</span>
        <input name="office_address_line2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office city</span>
        <input name="office_city" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office state</span>
        <input name="office_state" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office pincode</span>
        <input name="office_pincode" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <div class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Office country</span>
        <p class="w-full rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-3 py-2 text-sm text-slate-400">India (default)</p>
      </div>
    </div>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</span>
      <textarea name="notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2"></textarea>
    </label>
    <div class="flex items-center justify-end gap-2">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Create customer</button>
    </div>
  </form>
</dialog>

<script>
  (function() {
    const modal = document.getElementById('customerLiftListModal');
    if (!modal) {
      return;
    }

    const listContainer = modal.querySelector('[data-customer-lift-list]');
    const titleNode = modal.querySelector('[data-customer-lift-title]');
    const countNode = modal.querySelector('[data-customer-lift-count]');

    function formatCountLabel(count) {
      if (count <= 0) {
        return 'No open lifts currently linked.';
      }
      return `${count} open lift${count === 1 ? '' : 's'} for this customer.`;
    }

    function closeModal() {
      if (typeof modal.close === 'function') {
        modal.close();
      } else {
        modal.classList.remove('open');
      }
    }

    function openModal(customerId, customerName, openCount) {
      if (!listContainer) {
        return;
      }
      const template = document.getElementById(`customerLiftList-${customerId}`);
      if (!template) {
        return;
      }

      listContainer.innerHTML = '';
      listContainer.appendChild(template.content.cloneNode(true));

      if (titleNode) {
        titleNode.textContent = `Open lifts – ${customerName}`;
      }
      if (countNode) {
        countNode.textContent = formatCountLabel(openCount);
      }

      if (typeof modal.showModal === 'function') {
        modal.showModal();
      } else {
        modal.classList.add('open');
      }
    }

    document.addEventListener('click', (event) => {
      const trigger = event.target.closest('[data-customer-lifts]');
      if (trigger) {
        event.preventDefault();
        const customerId = trigger.getAttribute('data-customer-lifts');
        const customerName = trigger.getAttribute('data-customer-name') || 'Customer';
        const openCount = parseInt(trigger.getAttribute('data-customer-open-count') || '0', 10);
        openModal(customerId, customerName, Number.isNaN(openCount) ? 0 : openCount);
        return;
      }

      const closeTrigger = event.target.closest('#customerLiftListModal [data-modal-close]');
      if (closeTrigger) {
        event.preventDefault();
        closeModal();
      }
    });

    modal.addEventListener('cancel', (event) => {
      event.preventDefault();
      closeModal();
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  })();
</script>

<script>
  (function() {
    function setupModal(openSelector, modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) {
        return;
      }
      document.querySelectorAll(openSelector).forEach((trigger) => {
        trigger.addEventListener('click', () => {
          if (typeof modal.showModal === 'function') {
            modal.showModal();
          } else {
            modal.classList.add('open');
          }
        });
      });
      modal.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
          if (typeof modal.close === 'function') {
            modal.close();
          } else {
            modal.classList.remove('open');
          }
        });
      });
    }

    setupModal('[data-modal-open="customer-create"]', 'customerCreateModal');
    setupModal('[data-modal-open="customer-upload"]', 'customerUploadModal');
  })();
</script>
{% endblock %}
