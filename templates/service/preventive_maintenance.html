{% extends "base.html" %}
{% block title %}Eleva ERP – Preventive Maintenance{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400">
        Service · Preventive maintenance &amp; AMC planning
      </p>
      <h1 class="text-2xl font-semibold text-theme-primary">
        Preventive Maintenance Planner
      </h1>
      <p class="text-sm text-slate-400">
        See overdue and upcoming AMC visits, balance technician workloads, and keep Eleva lifts happy.
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('service_overview') }}"
         class="rounded-xl border border-slate-700/70 bg-slate-900/60 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/80">
        &larr; Service overview
      </a>
      <a href="{{ url_for('service_lifts') }}"
         class="rounded-xl border border-slate-700/70 bg-slate-900/60 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/80">
        Manage lifts
      </a>
    </div>
  </header>

  <!-- Summary cards -->
  <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-[11px] uppercase tracking-wide text-slate-400">Overdue visits</p>
      <p class="mt-1 text-2xl font-semibold text-rose-300">{{ summary.overdue }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits that should have been done before {{ today.strftime("%d %b %Y") }}.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-[11px] uppercase tracking-wide text-slate-400">Due today</p>
      <p class="mt-1 text-2xl font-semibold text-amber-300">{{ summary.today }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits planned for today that are still open.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-[11px] uppercase tracking-wide text-slate-400">This week</p>
      <p class="mt-1 text-2xl font-semibold text-sky-300">{{ summary.week }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits coming up in the next 7 days.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-[11px] uppercase tracking-wide text-slate-400">Unscheduled lifts</p>
      <p class="mt-1 text-2xl font-semibold text-emerald-300">{{ summary.unscheduled }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Lifts without any upcoming AMC date yet.
      </p>
    </article>
  </section>

  {% macro visit_list(title, items, empty_text) %}
  <section class="space-y-2">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-slate-200">{{ title }}</h2>
      <p class="text-xs text-slate-500">
        {{ items|length }} visit{{ '' if items|length == 1 else 's' }}
      </p>
    </div>
    <div class="space-y-2">
      {% if items %}
        {% for visit in items %}
          <article class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-3 text-sm text-slate-200 transition hover:border-emerald-500/70 hover:bg-slate-900">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <p class="font-semibold text-slate-100">
                  {{ visit.site }} · {{ visit.lift }}
                </p>
                <p class="text-xs text-slate-400">
                  Visit on {{ visit.visit_display }} · Technician: {{ visit.technician or 'Unassigned' }}
                </p>
                <p class="text-xs text-slate-400">
                  Checklist: {{ visit.checklist or '—' }}
                </p>
                {% if visit.preference_warning %}
                  <p class="mt-1 flex items-center gap-2 text-[11px] text-amber-300">
                    <span class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-amber-400/60 bg-amber-400/10 text-[10px]">!</span>
                    {{ visit.preference_warning }}
                  </p>
                {% endif %}
              </div>
              {% if visit.lift_id %}
                <a href="{{ url_for('service_lift_detail', lift_id=visit.lift_id) }}"
                   class="mt-1 inline-flex items-center rounded-full bg-slate-800/80 px-3 py-1 text-xs text-slate-100 hover:bg-emerald-500/90 hover:text-slate-900 transition">
                  View lift
                </a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p class="rounded-2xl border border-dashed border-slate-700/70 bg-slate-900/40 px-4 py-3 text-xs text-slate-500">
          {{ empty_text }}
        </p>
      {% endif %}
    </div>
  </section>
  {% endmacro %}

  <section class="grid gap-6 lg:grid-cols-2">
    {{ visit_list("Overdue AMC visits", overdue, "No overdue preventive visits at the moment.") }}
    {{ visit_list("Upcoming AMC visits", upcoming, "No upcoming preventive visits scheduled yet.") }}
  </section>

  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-slate-200">Checklist templates (read-only preview)</h2>
      <p class="text-xs text-slate-500">{{ checklists|length }} template{{ '' if checklists|length == 1 else 's' }}</p>
    </div>
    <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-3">
      {% for checklist in checklists %}
        <article class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-4 text-sm text-slate-300">
          <h3 class="text-base font-semibold text-slate-200">{{ checklist.name }}</h3>
          <p class="mt-2 text-xs text-slate-400">
            {{ checklist.items }} items · {{ checklist.photo_rules }}
          </p>
        </article>
      {% else %}
        <p class="text-sm text-slate-400">
          No checklist templates defined yet.
        </p>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}
