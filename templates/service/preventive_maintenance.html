{% extends "base.html" %}
{% block title %}Eleva ERP – Preventive Maintenance{% endblock %}

{% block content %}
{% set current_sort = current_sort or "" %}
{% set current_order = current_order or "asc" %}
{% set sort_query_args = sort_query_args or {} %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400">
        Service · Preventive maintenance &amp; AMC planning
      </p>
      <h1 class="text-2xl font-semibold text-theme-primary">
        Preventive Maintenance Planner
      </h1>
      <p class="text-sm text-slate-400">
        See overdue and upcoming AMC visits, balance technician workloads, and keep Eleva lifts happy.
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('service_overview') }}"
         class="rounded-xl border border-slate-700/70 bg-slate-900/60 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/80">
        &larr; Service overview
      </a>
      <a href="{{ url_for('service_lifts') }}"
         class="rounded-xl border border-slate-700/70 bg-slate-900/60 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/80">
        Manage lifts
      </a>
    </div>
  </header>

  <!-- Summary cards -->
  <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-xs uppercase tracking-wide text-slate-400">Overdue visits</p>
      <p class="mt-1 text-2xl font-semibold text-rose-300">{{ summary.overdue }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits that should have been done before {{ today.strftime("%d %b %Y") }}.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-xs uppercase tracking-wide text-slate-400">Due today</p>
      <p class="mt-1 text-2xl font-semibold text-amber-300">{{ summary.today }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits planned for today that are still open.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-xs uppercase tracking-wide text-slate-400">This week</p>
      <p class="mt-1 text-2xl font-semibold text-sky-300">{{ summary.week }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Visits coming up in the next 7 days.
      </p>
    </article>

    <article class="rounded-2xl border border-slate-800/80 bg-slate-900/70 px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
      <p class="text-xs uppercase tracking-wide text-slate-400">Unscheduled lifts</p>
      <p class="mt-1 text-2xl font-semibold text-emerald-300">{{ summary.unscheduled }}</p>
      <p class="mt-1 text-xs text-slate-500">
        Lifts without any upcoming AMC date yet.
      </p>
    </article>
  </section>

  {% macro visit_list(title, items, empty_text, date_label) %}
  <section class="space-y-2">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-slate-200">{{ title }}</h2>
      <p class="text-xs text-slate-500">{{ items|length }} visit{{ '' if items|length == 1 else 's' }}</p>
    </div>
    {% if items %}
      <div class="overflow-x-auto rounded-2xl border border-slate-800/70 bg-slate-900/70">
        <table class="min-w-full divide-y divide-slate-800/70 text-sm">
          <thead class="bg-slate-900/90 text-xs uppercase tracking-wide text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='site', order='desc' if current_sort == 'site' and current_order == 'asc' else 'asc', **sort_query_args) }}">Site{% if current_sort == 'site' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='lift', order='desc' if current_sort == 'lift' and current_order == 'asc' else 'asc', **sort_query_args) }}">Lift{% if current_sort == 'lift' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='date', order='desc' if current_sort == 'date' and current_order == 'asc' else 'asc', **sort_query_args) }}">{{ date_label }}{% if current_sort == 'date' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='technician', order='desc' if current_sort == 'technician' and current_order == 'asc' else 'asc', **sort_query_args) }}">Technician{% if current_sort == 'technician' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='checklist', order='desc' if current_sort == 'checklist' and current_order == 'asc' else 'asc', **sort_query_args) }}">Checklist{% if current_sort == 'checklist' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              {% if date_label == 'Due date' %}
              <th class="px-3 py-2 text-left"><a class="hover:text-emerald-200" href="{{ url_for(request.endpoint, sort='overdue_days', order='desc' if current_sort == 'overdue_days' and current_order == 'asc' else 'asc', **sort_query_args) }}">Overdue days{% if current_sort == 'overdue_days' %} {{ '▲' if current_order == 'asc' else '▼' }}{% endif %}</a></th>
              {% endif %}
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/70 text-slate-200">
          {% for visit in items %}
            <tr class="hover:bg-slate-800/30">
              <td class="px-3 py-2">{{ visit.site }}</td>
              <td class="px-3 py-2">{{ visit.lift }}</td>
              <td class="px-3 py-2">{{ visit.visit_display or visit.due_display }}</td>
              <td class="px-3 py-2">{{ visit.technician }}</td>
              <td class="px-3 py-2">{{ visit.checklist }}</td>
              {% if date_label == 'Due date' %}<td class="px-3 py-2">{{ visit.days_overdue }}</td>{% endif %}
            </tr>
            {% if visit.preference_warning %}
            <tr><td colspan="{{ 6 if date_label == 'Due date' else 5 }}" class="px-3 pb-2 text-xs text-amber-300">{{ visit.preference_warning }}</td></tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="rounded-2xl border border-dashed border-slate-700/70 bg-slate-900/40 px-4 py-3 text-xs text-slate-500">{{ empty_text }}</p>
    {% endif %}
  </section>
{% endmacro %}

  <section class="grid gap-6 lg:grid-cols-2">
    {{ visit_list("Overdue AMC visits", overdue, "No overdue preventive visits at the moment.", "Due date") }}
    {{ visit_list("Upcoming AMC visits", upcoming, "No upcoming preventive visits scheduled yet.", "Visit date") }}
  </section>

  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-slate-200">Checklist templates (read-only preview)</h2>
      <p class="text-xs text-slate-500">{{ checklists|length }} template{{ '' if checklists|length == 1 else 's' }}</p>
    </div>
    <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-3">
      {% for checklist in checklists %}
        <article class="rounded-2xl border border-slate-800/70 bg-slate-900/70 p-4 text-sm text-slate-300">
          <h3 class="text-base font-semibold text-slate-200">{{ checklist.name }}</h3>
          <p class="mt-2 text-xs text-slate-400">
            {{ checklist.items }} items · {{ checklist.photo_rules }}
          </p>
        </article>
      {% else %}
        <p class="text-sm text-slate-400">
          No checklist templates defined yet.
        </p>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}
