{% extends "base.html" %}
{% block title %}Eleva ERP – Lifts{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-theme-primary">Lifts</h1>
      <p class="text-sm text-slate-400">Catalogue every lift with technical specifications, AMC status and service cadence.</p>
    </div>
    <div class="flex gap-2">
      {% if current_user.is_admin %}
        <a
          href="{{ url_for('service_lifts_export', q=search_query) }}"
          class="rounded-xl border border-slate-700/70 bg-slate-800/70 px-3 py-2 text-xs text-slate-300 transition hover:text-white"
        >
          Export lifts
        </a>
      {% endif %}
      <button type="button" data-modal-open="lift-upload" class="rounded-xl border border-slate-700/70 bg-slate-800/70 px-3 py-2 text-xs text-slate-300 transition hover:text-white">Upload AMC lifts</button>
      <button type="button" data-modal-open="lift-create" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">Add lift</button>
    </div>
  </header>

  <form method="get" action="{{ url_for('service_lifts') }}" class="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-900/60 p-4 sm:flex-row sm:items-center sm:justify-between">
    <label for="liftSearch" class="flex-1">
      <span class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Quick search</span>
      <input id="liftSearch" name="q" value="{{ search_query or '' }}" placeholder="Search by lift code, customer, city or status" class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
    </label>
    <div class="flex gap-2 pt-1 sm:pt-6">
      <button type="submit" class="rounded-xl border border-emerald-400/40 bg-emerald-400/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">Search</button>
      <a href="{{ url_for('service_lifts') }}" class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Reset</a>
    </div>
  </form>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-800 text-sm">
        <thead class="bg-slate-900/90 text-[11px] uppercase tracking-wide text-slate-200">
          <tr>
            <th class="px-4 py-3 text-left">Lift code</th>
            <th class="px-4 py-3 text-left">Customer</th>
            <th class="px-4 py-3 text-left">Type</th>
            <th class="px-4 py-3 text-left">Brand</th>
            <th class="px-4 py-3 text-left">Route</th>
            <th class="px-4 py-3 text-left">City</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">AMC status</th>
            <th class="px-4 py-3 text-left">Next due</th>
            <th class="px-4 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800/80 text-slate-200">
          {% for lift in lifts %}
            <tr class="hover:bg-slate-800/40">
              <td class="px-4 py-3 font-semibold text-theme-primary">
                <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="text-left font-semibold text-theme-primary transition hover:text-emerald-200">{{ lift.lift_code }}</a>
              </td>
              <td class="px-4 py-3">
                {% if lift.customer %}
                  <a href="{{ url_for('service_customer_detail', customer_id=lift.customer.id) }}" class="font-semibold text-emerald-200 hover:text-emerald-100">{{ lift.customer.company_name }}</a>
                  <div class="text-xs text-slate-400">{{ lift.customer.customer_code }}</div>
                {% else %}
                  <span class="text-xs text-slate-400">Unlinked</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">{{ lift.lift_type or '—' }}</td>
              <td class="px-4 py-3">{{ lift.lift_brand or '—' }}</td>
              <td class="px-4 py-3">{{ lift.route or '—' }}</td>
              <td class="px-4 py-3">{{ lift.city or '—' }}</td>
              <td class="px-4 py-3">{{ lift.status or '—' }}</td>
              <td class="px-4 py-3">
                {% set amc_status = lift.amc_status or 'Not set' %}
                {% set amc_status_lower = amc_status|lower %}
                {% set amc_badge_classes = {
                  'active': 'border border-emerald-500/40 bg-emerald-500/10 text-emerald-200',
                  'expired': 'border border-rose-500/40 bg-rose-500/10 text-rose-200',
                  'inactive': 'border border-rose-500/40 bg-rose-500/10 text-rose-200',
                  'none': 'border border-slate-700/70 bg-slate-800/70 text-slate-300',
                  'not set': 'border border-slate-700/70 bg-slate-800/70 text-slate-300'
                } %}
                {% set badge_class = amc_badge_classes.get(amc_status_lower, 'border border-slate-700/70 bg-slate-800/70 text-slate-300') %}
                <span class="inline-flex min-w-[6rem] justify-center rounded-lg px-2.5 py-1 text-xs font-semibold {{ badge_class }}">{{ amc_status }}</span>
              </td>
              <td class="px-4 py-3">{{ lift.next_service_due.strftime('%d %b %Y') if lift.next_service_due else '—' }}</td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <a href="{{ url_for('service_lift_detail', lift_id=lift.id) }}" class="rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20">View</a>
                  {% if current_user.is_admin %}
                    <form method="post" action="{{ url_for('service_lift_delete', lift_id=lift.id) }}" class="inline-flex" onsubmit="return confirm('Delete lift {{ lift.lift_code }}? This action cannot be undone.');">
                      {{ csrf_field() }}
                      <input type="hidden" name="next" value="{{ request.full_path }}" />
                      <button type="submit" class="rounded-lg border border-rose-500/50 bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-200 transition hover:bg-rose-500/20">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="10" class="px-4 py-6 text-center text-sm text-slate-400">No lifts available yet. Use the <strong class="text-slate-200">Add lift</strong> button to register a lift.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<dialog id="liftCreateModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_lifts_create') }}" class="w-full max-w-4xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Create lift</h2>
        <p class="text-xs text-slate-400">Add installation details and link the lift to a customer.</p>
      </div>
      <div class="flex gap-2">
        <button type="button" data-modal-open="customer-create-from-lift" class="rounded-xl border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">New customer</button>
        <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
      </div>
    </div>
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift code</span>
        <input value="{{ next_lift_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
        <p class="text-xs text-slate-300">Automatically generated when you save.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">External lift ID</span>
        <input name="external_lift_id" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label for="customer_display" class="space-y-1 md:col-span-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer</span>
        <input
          type="text"
          id="customer_display"
          list="customerList"
          placeholder="Select customer"
          autocomplete="off"
          class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2"
        />

        <datalist id="customerList">
          {% for c in customers %}
            <option value="{{ c.customer_code }} — {{ c.company_name }}"></option>
          {% endfor %}
        </datalist>

        <input type="hidden" name="customer_code" id="customer_code" />

        <script>
          const display = document.getElementById("customer_display");
          const hidden = document.getElementById("customer_code");

          display.addEventListener("change", () => {
            const value = display.value.trim();
            // Expected format: CODE — NAME
            const parts = value.split("—");
            if (parts.length >= 1) {
              hidden.value = parts[0].trim();
            }
          });
        </script>

        <p class="text-xs text-slate-500">Start typing to filter by customer code or company name, or use the "New customer" button to create one.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building / Villa No.</span>
        <input name="site_address_line1" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building Name, Road, Area</span>
        <input name="site_address_line2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="city" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="state" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="pincode" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Geo location</span>
        <input name="geo_location" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. 15.4969, 73.8278" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Route</span>
        <select name="route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select route</option>
          {% for route in service_routes %}
            <option value="{{ route.state }}">{{ route.display_name }}</option>
          {% endfor %}
        </select>
        {% if not service_routes %}
          <p class="text-xs text-slate-300">Add routes from Settings → Module Settings to see them here.</p>
        {% endif %}
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building floors</span>
        <input name="building_floors" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="G+4" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift type</span>
        {% set selected_lift_type = request.form.get('lift_type') or '' %}
        {% set lift_type_options = dropdown_options.get('lift_type', []) %}
        <select name="lift_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift type</option>
          {% for option in lift_type_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if selected_lift_type and selected_lift_type.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift brand</span>
        <input name="lift_brand" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. Schindler" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (persons)</span>
        {% set selected_capacity = request.form.get('capacity_persons') or '' %}
        {% set passenger_capacity_options = dropdown_options.get('passenger_capacity', []) %}
        <select name="capacity_persons" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select capacity</option>
          {% for option in passenger_capacity_options %}
            <option value="{{ option.value }}" {% if selected_capacity and selected_capacity == option.value %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (kg)</span>
        {% set selected_capacity_kg = request.form.get('capacity_kg') or '' %}
        {% set load_capacity_options = dropdown_options.get('load_capacity', []) %}
        <select name="capacity_kg" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select load</option>
          {% for option in load_capacity_options %}
            <option value="{{ option.value }}" {% if selected_capacity_kg and selected_capacity_kg == option.value %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Speed (m/s)</span>
        <input name="speed_mps" step="0.01" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine type</span>
        {% set selected_machine_type = request.form.get('machine_type') or '' %}
        {% set machine_type_options = dropdown_options.get('machine_type', []) %}
        <select name="machine_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select machine type</option>
          {% for option in machine_type_options %}
            <option value="{{ option.value }}" {% if selected_machine_type and selected_machine_type.lower() == option.value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine brand</span>
        <input name="machine_brand" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Controller brand</span>
        <input name="controller_brand" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door type</span>
        {% set selected_door_type = request.form.get('door_type') or '' %}
        {% set door_type_options = dropdown_options.get('door_type', []) %}
        <select name="door_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door type</option>
          {% for option in door_type_options %}
            <option value="{{ option.value }}" {% if selected_door_type and selected_door_type.lower() == option.value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door finish</span>
        {% set selected_door_finish = request.form.get('door_finish') or '' %}
        {% set door_finish_options = dropdown_options.get('door_finish', []) %}
        <select name="door_finish" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door finish</option>
          {% for option in door_finish_options %}
            <option value="{{ option.value }}" {% if selected_door_finish and selected_door_finish.lower() == option.value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Cabin finish</span>
        <input name="cabin_finish" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="SS / Glass" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Power supply</span>
        {% set selected_power_supply = request.form.get('power_supply') or '' %}
        {% set power_supply_options = dropdown_options.get('power_supply', []) %}
        <select name="power_supply" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select power supply</option>
          {% for option in power_supply_options %}
            <option value="{{ option.value }}" {% if selected_power_supply and selected_power_supply.lower() == option.value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Install date</span>
        <input type="date" name="install_date" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Warranty expiry</span>
        <input type="date" name="warranty_expiry" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC status</span>
        {% set selected_amc_status = request.form.get('amc_status') or '' %}
        <select name="amc_status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select AMC status</option>
          {% for option in AMC_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if selected_amc_status and selected_amc_status.lower() == option.lower() %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC start</span>
        <input type="date" name="amc_start" id="liftAmcStart" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC duration</span>
        {% set selected_amc_duration = request.form.get('amc_duration_key') or '' %}
        <select name="amc_duration_key" id="liftAmcDuration" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select duration</option>
          {% for value, label in amc_duration_choices %}
            {% if value %}
              <option value="{{ value }}" {% if selected_amc_duration and selected_amc_duration.lower() == value %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC end</span>
        <input type="date" name="amc_end" id="liftAmcEnd" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" readonly />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC contract</span>
        {% set selected_contract = request.form.get('amc_contract_id') or '' %}
        <select name="amc_contract_id" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">No contract linked</option>
          {% for contract in service_contracts %}
            <option value="{{ contract.id }}" {% if selected_contract and selected_contract.lower() == contract.id.lower() %}selected{% endif %}>{{ contract.id }} · {{ contract.type }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">QR code URL</span>
        <input type="url" name="qr_code_url" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift status</span>
        {% set selected_lift_status = request.form.get('status') or '' %}
        <select name="status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift status</option>
          {% for option in LIFT_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if selected_lift_status and selected_lift_status.lower() == option.lower() %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <div class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Last service date</span>
        <p class="w-full rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-3 py-2 text-sm text-slate-400">Automatically tracked after service visits.</p>
      </div>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service date</span>
        <select name="preferred_service_date" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">No preference</option>
          {% for day in range(1, 31) %}
            {% set day_value = "%02d" % day %}
            <option value="{{ day_value }}">{{ day_value }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-slate-300">Pick a day of the month (01-30).</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service days</span>
        {% set selected_days = request.form.getlist('preferred_service_days') %}
        <select name="preferred_service_days" id="liftPreferredServiceDaysCreate" multiple size="6" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          {% for value, label in service_day_options %}
            {% if value %}
              <option value="{{ value }}" {% if selected_days and value in selected_days %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <p class="text-xs text-slate-300">Hold Ctrl (Windows) or Command (Mac) to select multiple days. "Any day" clears other selections.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service time</span>
        <input type="time" name="preferred_service_time" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
    </div>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Service remarks</span>
      <textarea name="remarks" rows="2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Add quick remarks or reminders"></textarea>
    </label>
    <div class="flex items-center justify-end gap-2">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Create lift</button>
    </div>
  </form>
</dialog>

<dialog id="liftUploadModal" class="modal-dialog">
  <form id="liftUploadForm" method="post" action="{{ url_for('service_lifts_upload') }}" enctype="multipart/form-data" class="w-full max-w-2xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Bulk upload AMC lifts</h2>
        <p class="text-xs text-slate-400">Download the template, fill one lift per row and upload the same workbook.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 transition hover:bg-slate-800/70">Close</button>
    </div>

    <div class="space-y-4 rounded-xl border border-slate-800/80 bg-slate-900/70 p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-sm font-semibold text-slate-100">Template</h3>
          <p class="text-xs text-slate-400">Includes instructions and a sample row. Remove the sample before uploading.</p>
        </div>
        <a href="{{ url_for('service_lifts_upload_template') }}" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold text-emerald-200 transition hover:bg-emerald-500/20" target="_blank" rel="noopener">Download template</a>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-slate-100">Before you upload</h3>
        <ul class="mt-2 space-y-2 text-xs text-slate-400">
          <li>• Customer external ID or customer code/name is required for every row.</li>
          <li>• AMC start date, status and duration are mandatory.</li>
          <li>• Preferred service days can be comma separated (e.g. Monday,Wednesday).</li>
          <li>• Leave optional cells blank to keep existing lift details unchanged.</li>
        </ul>
      </div>

      <div class="grid gap-4 sm:grid-cols-2">
        <div>
          <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-400">Valid AMC statuses</h4>
          <ul class="mt-2 space-y-1 text-xs text-slate-300">
            {% for status in amc_status_options %}
              <li>{{ status }}</li>
            {% endfor %}
          </ul>
        </div>
        <div>
          <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC duration options</h4>
          <ul class="mt-2 space-y-1 text-xs text-slate-300">
            {% for key, label in amc_duration_choices %}
              {% if key %}
                <li>{{ label }} ({{ key }})</li>
              {% endif %}
            {% endfor %}
          </ul>
          <p class="mt-2 text-xs text-slate-300">Enter either the duration label (for example <span class="italic">1 year</span>) or the key shown in parentheses.</p>
        </div>
      </div>
    </div>

    <div class="space-y-2">
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400" for="amcLiftFile">Upload filled workbook</label>
      <input id="amcLiftFile" name="amc_lift_file" type="file" accept=".xlsx,.csv" required class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" />
      <p class="text-xs text-slate-300">Download the template and re-upload it as .xlsx or .csv.</p>
    </div>

    <div class="flex items-center justify-end gap-2">
      <button type="button" data-modal-close class="rounded-xl border border-slate-700/70 px-4 py-2 text-xs text-slate-300 transition hover:bg-slate-800/70">Cancel</button>
      <button type="submit" data-upload-button class="rounded-xl border border-emerald-400/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 transition hover:bg-emerald-500/30">Upload workbook</button>
    </div>
  </form>
</dialog>

<dialog id="customerFromLiftModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customers_create') }}" class="w-full max-w-3xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    {{ csrf_field() }}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Create customer</h2>
        <p class="text-xs text-slate-400">Quickly add a customer without leaving the lift workflow.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="next" value="{{ url_for('service_lifts') }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
        <input value="{{ next_customer_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
        <p class="text-xs text-slate-300">Automatically generated on save.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Company name</span>
        <input name="company_name" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Acme Pvt. Ltd." />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Contact person</span>
        <input name="contact_person" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Email</span>
        <input type="email" name="email" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Phone</span>
        <input name="phone" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Mobile</span>
        <input name="mobile" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Sector</span>
        <input name="sector" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Residential / Commercial" />
      </label>
    </div>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</span>
      <textarea name="notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2"></textarea>
    </label>
    <div class="flex items-center justify-end gap-2">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Create customer</button>
    </div>
  </form>
</dialog>

<script>
  (function() {
    function setupModal(openSelector, modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      document.querySelectorAll(openSelector).forEach((trigger) => {
        trigger.addEventListener('click', () => {
          if (typeof modal.showModal === 'function') {
            modal.showModal();
          } else {
            modal.classList.add('open');
          }
        });
      });
      modal.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
          if (typeof modal.close === 'function') {
            modal.close();
          } else {
            modal.classList.remove('open');
          }
        });
      });
    }
    setupModal('[data-modal-open="lift-create"]', 'liftCreateModal');
    setupModal('[data-modal-open="lift-upload"]', 'liftUploadModal');
    setupModal('[data-modal-open="customer-create-from-lift"]', 'customerFromLiftModal');

    const liftUploadForm = document.getElementById('liftUploadForm');
    if (liftUploadForm) {
      liftUploadForm.addEventListener('submit', () => {
        liftUploadForm.setAttribute('aria-busy', 'true');
        const submitButton = liftUploadForm.querySelector('[data-upload-button]');
        const closeButtons = liftUploadForm.querySelectorAll('[data-modal-close]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Uploading…';
          submitButton.classList.add('cursor-wait', 'opacity-70');
        }
        closeButtons.forEach((button) => {
          button.disabled = true;
          button.classList.add('opacity-50', 'cursor-not-allowed');
        });
      });
    }

    const amcDurationMonths = {{ amc_duration_months | tojson }};
    const amcStartInput = document.getElementById('liftAmcStart');
    const amcDurationSelect = document.getElementById('liftAmcDuration');
    const amcEndInput = document.getElementById('liftAmcEnd');

    function addMonths(date, months) {
      const result = new Date(date.getTime());
      const desiredMonth = result.getMonth() + months;
      result.setMonth(desiredMonth);
      if (result.getMonth() !== ((desiredMonth % 12) + 12) % 12) {
        result.setDate(0);
      }
      return result;
    }

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function updateAmcEndDate() {
      if (!amcStartInput || !amcDurationSelect || !amcEndInput) {
        return;
      }
      const startValue = amcStartInput.value;
      const durationKey = amcDurationSelect.value;
      if (!startValue || !durationKey || !amcDurationMonths[durationKey]) {
        amcEndInput.value = '';
        return;
      }
      const startDate = new Date(`${startValue}T00:00:00`);
      if (Number.isNaN(startDate.getTime())) {
        amcEndInput.value = '';
        return;
      }
      const months = parseInt(amcDurationMonths[durationKey], 10) || 0;
      if (!months) {
        amcEndInput.value = '';
        return;
      }
      const computed = addMonths(startDate, months);
      computed.setDate(computed.getDate() - 1);
      amcEndInput.value = formatDateInput(computed);
    }

    if (amcStartInput && amcDurationSelect) {
      amcStartInput.addEventListener('change', updateAmcEndDate);
      amcDurationSelect.addEventListener('change', updateAmcEndDate);
      updateAmcEndDate();
    }

    function enforcePreferredDays(select) {
      if (!select) {
        return;
      }
      const selectedValues = Array.from(select.selectedOptions).map((option) => option.value);
      if (selectedValues.includes('any') && selectedValues.length > 1) {
        Array.from(select.options).forEach((option) => {
          if (option.value !== 'any') {
            option.selected = false;
          }
        });
      }
    }

    const preferredDaysSelect = document.getElementById('liftPreferredServiceDaysCreate');
    if (preferredDaysSelect) {
      preferredDaysSelect.addEventListener('change', () => enforcePreferredDays(preferredDaysSelect));
      enforcePreferredDays(preferredDaysSelect);
    }
  })();
</script>
{% endblock %}
