{% extends "base.html" %}

{% block title %}{{ review_title }} · Eleva ERP{% endblock %}

{% block content %}
{% if upload_type == "customers" %}
  {% set back_url = url_for('service_customers') %}
{% elif upload_type == "lifts" %}
  {% set back_url = url_for('service_lifts') %}
  {% else %}
  {% set back_url = url_for('service_overview') %}
  {% endif %}
<div class="mx-auto max-w-5xl space-y-6 px-4 py-8">
  <div class="space-y-2">
    <a href="{{ back_url }}" class="text-xs text-slate-400 hover:text-slate-200">
      {% if upload_type == "lifts" %}
        &larr; Back to lifts
      {% elif upload_type == "customers" %}
        &larr; Back to customers
      {% else %}
        &larr; Back to service overview
      {% endif %}
    </a>
    <h1 class="text-2xl font-semibold text-slate-100">{{ review_title }}</h1>
    <p class="text-sm text-slate-400">Review the detected changes before they are applied to the database.</p>
  </div>

  <div class="rounded-2xl border border-slate-800/80 bg-slate-900/70 p-6 text-sm text-slate-200">
    <div class="grid gap-4 sm:grid-cols-3">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Workbook</p>
        <p class="mt-1 font-semibold text-slate-100">{{ original_filename }}</p>
      </div>
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Records detected</p>
        <p class="mt-1 font-semibold text-slate-100">{{ processed_rows }}</p>
      </div>
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Summary</p>
        <p class="mt-1 font-semibold text-emerald-300">{{ created_count }} new · {{ updated_count }} updates</p>
      </div>
    </div>
  </div>

  {% if row_errors %}
  <div class="rounded-2xl border border-rose-500/60 bg-rose-500/10 p-3 mb-4">
    <p class="text-xs font-semibold text-rose-200">
      Some rows could not be processed:
    </p>
    <ul class="mt-2 space-y-1 text-xs text-rose-100">
      {% for msg in row_errors %}
        <li class="flex gap-2">
          <span class="mt-0.5 inline-flex h-3 w-3 flex-shrink-0 items-center justify-center rounded-full border border-rose-400/80 text-[9px] leading-none">!</span>
          <span>{{ msg }}</span>
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if created_items %}
  <div class="space-y-3">
    <h2 class="text-lg font-semibold text-emerald-200">New records</h2>
    <div class="overflow-hidden rounded-2xl border border-slate-800/80">
      <table class="min-w-full divide-y divide-slate-800 bg-slate-900/60 text-sm">
        <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
          <tr>
            {% if upload_type == "customers" %}
            <th class="px-4 py-3 text-left">Customer code</th>
            <th class="px-4 py-3 text-left">Company</th>
            <th class="px-4 py-3 text-left">Route</th>
            <th class="px-4 py-3 text-left">Branch</th>
            {% else %}
            <th class="px-4 py-3 text-left">Lift code</th>
            <th class="px-4 py-3 text-left">Customer</th>
            <th class="px-4 py-3 text-left">AMC status</th>
            <th class="px-4 py-3 text-left">AMC period</th>
            {% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800/60">
          {% for item in created_items %}
          <tr>
            {% if upload_type == "customers" %}
            <td class="px-4 py-3 font-mono text-xs text-emerald-200">{{ item.customer_code }}</td>
            <td class="px-4 py-3">{{ item.company_name or "—" }}</td>
            <td class="px-4 py-3">{{ item.route or "—" }}</td>
            <td class="px-4 py-3">{{ item.branch or "—" }}</td>
            {% else %}
            <td class="px-4 py-3 font-mono text-xs text-emerald-200">{{ item.lift_code }}</td>
            <td class="px-4 py-3">{{ item.customer_code or "—" }}</td>
            <td class="px-4 py-3">{{ item.amc_status or "—" }}</td>
            <td class="px-4 py-3">{% if item.amc_start %}{{ item.amc_start }} → {{ item.amc_end or "—" }}{% else %}—{% endif %}</td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if created_count > created_items|length %}
    <p class="text-xs text-slate-400">Showing first {{ created_items|length }} new records. {{ created_count - created_items|length }} additional rows will be created on merge.</p>
    {% endif %}
  </div>
  {% endif %}

  {% if updated_items %}
  <div class="space-y-3">
    <h2 class="text-lg font-semibold text-amber-200">Updated records</h2>
    <div class="space-y-2 rounded-2xl border border-slate-800/80 bg-slate-900/60 p-4">
      {% for item in updated_items %}
      <div class="rounded-xl border border-slate-800/70 bg-slate-900/60 p-4">
        <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
          <div class="font-semibold text-slate-100">
            {% if upload_type == "customers" %}
              {{ item.customer_code }} · {{ item.company_name or "Customer" }}
            {% else %}
              {{ item.lift_code }} · {{ item.customer_code or "Customer" }}
            {% endif %}
          </div>
          {% if upload_type != "customers" %}
          <div class="text-xs text-slate-400">AMC {{ item.amc_status or "—" }} · {{ item.amc_start or "—" }} → {{ item.amc_end or "—" }}</div>
          {% endif %}
        </div>
        {% if item.changes %}
        <ul class="mt-3 space-y-1 text-xs text-slate-300">
          {% for change in item.changes %}
          <li>• {{ change.field }}: <span class="text-slate-400">{{ change.from or "—" }}</span> → <span class="text-emerald-200">{{ change.to or "—" }}</span></li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
      {% endfor %}
      {% if updated_count > updated_items|length %}
      <p class="text-xs text-slate-400">Showing first {{ updated_items|length }} updates. {{ updated_count - updated_items|length }} additional rows will be updated on merge.</p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-800/80 bg-slate-900/70 p-4">
    <p class="text-xs text-slate-400">Confirming will merge the data immediately. Discarding removes the staged file.</p>
    <div class="flex gap-3">
      <form method="post" action="{{ confirm_url }}">
        <input type="hidden" name="pending_token" value="{{ pending_token }}" />
        <input type="hidden" name="action" value="discard" />
        <button type="submit" class="rounded-xl border border-rose-500/50 px-4 py-2 text-xs font-semibold text-rose-200 transition hover:bg-rose-500/10">Discard upload</button>
      </form>
      <form method="post" action="{{ confirm_url }}">
        <input type="hidden" name="pending_token" value="{{ pending_token }}" />
        <input type="hidden" name="action" value="merge" />
        <button type="submit" class="rounded-xl border border-emerald-400/50 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 transition hover:bg-emerald-500/30">Merge data</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}
