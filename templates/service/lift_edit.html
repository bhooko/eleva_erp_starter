{% extends "base.html" %}
{% block title %}Eleva ERP – Lift {{ lift.lift_code }}{% endblock %}

{% block content %}
<div class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400"><a href="{{ url_for('service_lifts') }}" class="text-emerald-200 hover:text-emerald-100">Lifts</a> · Edit</p>
      <h1 class="text-2xl font-semibold text-theme-primary">Lift {{ lift.lift_code }}</h1>
      <p class="text-sm text-slate-400">{{ lift.lift_type or 'Type not set' }} · {{ lift.capacity_display or 'Capacity not set' }}</p>
    </div>
    <div class="flex gap-2">
      <a href="{{ url_for('service_lifts') }}" class="rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-300 hover:bg-slate-800/70">Back to lifts</a>
      <button type="button" data-modal-open="customer-create-from-lift" class="rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/20">New customer</button>
    </div>
  </header>

  <form method="post" action="{{ url_for('service_lift_update', lift_id=lift.id) }}" class="space-y-6 rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-sm text-slate-100">
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift code</span>
        <input value="{{ lift.lift_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
        <p class="text-[11px] text-slate-500">Lift codes are auto-generated and cannot be edited.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">External lift ID</span>
        <input name="external_lift_id" value="{{ lift.external_lift_id or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <div class="space-y-2 md:col-span-2">
        <div class="flex items-center justify-between">
          <label class="flex-1 space-y-1">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
            <input id="liftCustomerCode" name="customer_code" value="{{ lift.customer_code or '' }}" list="customerOptions" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" {% if lift.customer_code %}readonly{% endif %} />
          </label>
          <button type="button" data-action="enable-customer" class="ml-3 mt-6 rounded-xl border border-slate-700/70 px-3 py-2 text-xs text-slate-200 hover:bg-slate-800/70">Relink customer</button>
        </div>
        <datalist id="customerOptions">
          {% for customer in customers %}
            <option value="{{ customer.customer_code }}" label="{{ customer.company_name }}"></option>
          {% endfor %}
        </datalist>
        <p class="text-xs text-slate-500">Click "Relink customer" to search and assign a different customer.</p>
      </div>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building / Villa No.</span>
        <input name="site_address_line1" value="{{ lift.site_address_line1 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building Name, Road, Area</span>
        <input name="site_address_line2" value="{{ lift.site_address_line2 or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">City</span>
        <input name="city" value="{{ lift.city or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">State</span>
        <input name="state" value="{{ lift.state or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Pincode</span>
        <input name="pincode" value="{{ lift.pincode or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Geo location</span>
        <input name="geo_location" value="{{ lift.geo_location or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. 15.4969, 73.8278" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Route</span>
        <select name="route" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select route</option>
          {% for route in service_routes %}
            {% set option_value = route.state %}
            <option value="{{ option_value }}" {% if lift.route and lift.route|lower == option_value|lower %}selected{% endif %}>{{ route.display_name }}</option>
          {% endfor %}
        </select>
        {% if not service_routes %}
          <p class="text-[11px] text-slate-500">Add routes from Settings → Module Settings to see them here.</p>
        {% endif %}
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Building floors</span>
        <input name="building_floors" value="{{ lift.building_floors or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift type</span>
        {% set lift_type_value = lift.lift_type or '' %}
        {% set lift_type_options = dropdown_options.get('lift_type', []) %}
        <select name="lift_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift type</option>
          {% for option in lift_type_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if lift_type_value and lift_type_value.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift brand</span>
        <input name="lift_brand" value="{{ lift.lift_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="e.g. Schindler" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (persons)</span>
        {% set capacity_persons_value = lift.capacity_persons|string if lift.capacity_persons is not none else '' %}
        {% set passenger_capacity_options = dropdown_options.get('passenger_capacity', []) %}
        <select name="capacity_persons" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select capacity</option>
          {% for option in passenger_capacity_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if capacity_persons_value and capacity_persons_value == option_value %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Capacity (kg)</span>
        {% set capacity_kg_value = lift.capacity_kg|string if lift.capacity_kg is not none else '' %}
        {% set load_capacity_options = dropdown_options.get('load_capacity', []) %}
        <select name="capacity_kg" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select load</option>
          {% for option in load_capacity_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if capacity_kg_value and capacity_kg_value == option_value %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Speed (m/s)</span>
        <input name="speed_mps" step="0.01" value="{{ '%.2f'|format(lift.speed_mps) if lift.speed_mps is not none else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine type</span>
        {% set machine_type_value = lift.machine_type or '' %}
        {% set machine_type_options = dropdown_options.get('machine_type', []) %}
        <select name="machine_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select machine type</option>
          {% for option in machine_type_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if machine_type_value and machine_type_value.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Machine brand</span>
        <input name="machine_brand" value="{{ lift.machine_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Controller brand</span>
        <input name="controller_brand" value="{{ lift.controller_brand or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door type</span>
        {% set door_type_value = lift.door_type or '' %}
        {% set door_type_options = dropdown_options.get('door_type', []) %}
        <select name="door_type" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door type</option>
          {% for option in door_type_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if door_type_value and door_type_value.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Door finish</span>
        {% set door_finish_value = lift.door_finish or '' %}
        {% set door_finish_options = dropdown_options.get('door_finish', []) %}
        <select name="door_finish" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select door finish</option>
          {% for option in door_finish_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if door_finish_value and door_finish_value.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Cabin finish</span>
        <input name="cabin_finish" value="{{ lift.cabin_finish or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Power supply</span>
        {% set power_supply_value = lift.power_supply or '' %}
        {% set power_supply_options = dropdown_options.get('power_supply', []) %}
        <select name="power_supply" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select power supply</option>
          {% for option in power_supply_options %}
            {% set option_value = option.value %}
            <option value="{{ option_value }}" {% if power_supply_value and power_supply_value.lower() == option_value.lower() %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Install date</span>
        <input type="date" name="install_date" value="{{ lift.install_date.isoformat() if lift.install_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Warranty expiry</span>
        <input type="date" name="warranty_expiry" value="{{ lift.warranty_expiry.isoformat() if lift.warranty_expiry else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC status</span>
        {% set amc_status_value = lift.amc_status or '' %}
        <select name="amc_status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select AMC status</option>
          {% for option in AMC_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if amc_status_value and amc_status_value.lower() == option.lower() %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC start</span>
        <input type="date" name="amc_start" id="liftAmcStartEdit" value="{{ lift.amc_start.isoformat() if lift.amc_start else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC duration</span>
        {% set amc_duration_value = lift.amc_duration_key or '' %}
        <select name="amc_duration_key" id="liftAmcDurationEdit" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select duration</option>
          {% for value, label in amc_duration_choices %}
            {% if value %}
              <option value="{{ value }}" {% if amc_duration_value and amc_duration_value.lower() == value %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC end</span>
        <input type="date" name="amc_end" id="liftAmcEndEdit" value="{{ lift.amc_end.isoformat() if lift.amc_end else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" readonly />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">AMC contract</span>
        {% set selected_contract = lift.amc_contract_id or '' %}
        <select name="amc_contract_id" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">No contract linked</option>
          {% for contract in service_contracts %}
            <option value="{{ contract.id }}" {% if selected_contract and selected_contract.lower() == contract.id.lower() %}selected{% endif %}>{{ contract.id }} · {{ contract.type }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">QR code URL</span>
        <input type="url" name="qr_code_url" value="{{ lift.qr_code_url or '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Lift status</span>
        {% set lift_status_value = lift.status or '' %}
        <select name="status" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">Select lift status</option>
          {% for option in LIFT_STATUS_OPTIONS %}
            <option value="{{ option }}" {% if lift_status_value and lift_status_value.lower() == option.lower() %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Last service date</span>
        <input type="date" name="last_service_date" value="{{ lift.last_service_date.isoformat() if lift.last_service_date else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" readonly />
        <p class="text-[11px] text-slate-500">Auto-updated from completed service visits.</p>
      </label>
      {% if lift.preferred_service_date and lift.preferred_service_date.year == 2000 and lift.preferred_service_date.month == 1 %}
        {% set preferred_service_date_day = "%02d" % lift.preferred_service_date.day %}
      {% else %}
        {% set preferred_service_date_day = '' %}
      {% endif %}
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service date</span>
        <select name="preferred_service_date" id="liftPreferredServiceDateEdit" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          <option value="">No preference</option>
          {% for day in range(1, 31) %}
            {% set day_value = "%02d" % day %}
            <option value="{{ day_value }}" {% if preferred_service_date_day == day_value %}selected{% endif %}>{{ day_value }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service days</span>
        {% set selected_days = lift.preferred_service_days %}
        <select name="preferred_service_days" id="liftPreferredServiceDaysEdit" multiple size="5" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
          {% for value, label in service_day_options %}
            {% if value %}
              <option value="{{ value }}" {% if value in selected_days %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <p class="text-[11px] text-slate-500">Hold Ctrl (Windows) or Command (Mac) to select multiple days. "Any day" clears other selections.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred service time</span>
        <input type="time" name="preferred_service_time" value="{{ lift.preferred_service_time.strftime('%H:%M') if lift.preferred_service_time else '' }}" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
    </div>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Service remarks</span>
      <textarea name="remarks" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Add service reminders or highlights">{{ lift.remarks or '' }}</textarea>
    </label>
    <div class="flex items-center justify-end gap-2">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Save lift</button>
    </div>
  </form>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-theme-primary">Attachments</h2>
      </div>
      {% if attachments %}
        <ul class="space-y-3 text-sm text-slate-200">
          {% for attachment in attachments %}
            <li class="space-y-2 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
              <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                <a href="{{ url_for('static', filename=attachment.stored_path) }}" class="font-semibold text-emerald-200 hover:text-emerald-100" target="_blank" rel="noopener">{{ attachment.display_label }}</a>
                <span class="text-xs text-slate-400">{{ attachment.uploaded_display }}</span>
              </div>
              <div class="text-xs text-slate-400">
                {{ attachment.display_size }}
                {% if attachment.uploaded_by %}
                  · Uploaded by {{ attachment.uploaded_by.display_name }}
                {% endif %}
              </div>
              {% if attachment.description %}
                <p class="text-sm text-slate-300">{{ attachment.description }}</p>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No attachments uploaded yet.</p>
      {% endif %}
      <form method="post" action="{{ url_for('service_lift_upload_file', lift_id=lift.id) }}" enctype="multipart/form-data" class="space-y-3 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
        <input type="hidden" name="next" value="{{ request.full_path }}" />
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Category</span>
          <select name="category" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2">
            <option value="document">Document</option>
            <option value="media">Media</option>
            <option value="other" selected>Other</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Description</span>
          <textarea name="description" rows="2" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Notes about this attachment (optional)"></textarea>
        </label>
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Select file</span>
          <input type="file" name="attachment" class="w-full text-sm text-slate-300" />
        </label>
        <div class="flex items-center justify-end">
          <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Upload file</button>
        </div>
      </form>
    </div>

    <div class="space-y-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-theme-primary">Comments</h2>
      </div>
      {% if comments %}
        <ul class="space-y-3">
          {% for comment in comments %}
            <li class="space-y-2 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
              <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                <span class="text-sm font-semibold text-slate-100">{{ comment.author_name }}</span>
                <span class="text-xs text-slate-400">{{ comment.created_display }}</span>
              </div>
              <p class="text-sm text-slate-200 whitespace-pre-line">{{ comment.body }}</p>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="rounded-xl border border-dashed border-slate-800 bg-slate-900/40 p-4 text-sm text-slate-400">No comments recorded yet.</p>
      {% endif %}
      <form method="post" action="{{ url_for('service_lift_add_comment', lift_id=lift.id) }}" class="space-y-3 rounded-xl border border-slate-800/80 bg-slate-900/60 p-4">
        <input type="hidden" name="next" value="{{ request.full_path }}" />
        <label class="space-y-1">
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Add a comment</span>
          <textarea name="body" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Share a status update or observation"></textarea>
        </label>
        <div class="flex items-center justify-end">
          <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Post comment</button>
        </div>
      </form>
    </div>
  </section>
</div>

<dialog id="customerFromLiftModal" class="modal-dialog">
  <form method="post" action="{{ url_for('service_customers_create') }}" class="w-full max-w-3xl space-y-6 rounded-2xl border border-slate-800 bg-slate-900/95 p-6 text-sm text-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-theme-primary">Create customer</h2>
        <p class="text-xs text-slate-400">Add a new customer and then relink the lift.</p>
      </div>
      <button type="button" data-modal-close class="rounded-full border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:bg-slate-800/70">Close</button>
    </div>
    <input type="hidden" name="next" value="{{ request.full_path }}" />
    <div class="grid gap-4 md:grid-cols-2">
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Customer code</span>
        <input value="{{ next_customer_code }}" readonly class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2 text-slate-300" />
        <p class="text-[11px] text-slate-500">Automatically generated on save.</p>
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Company name</span>
        <input name="company_name" required class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Acme Pvt. Ltd." />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Contact person</span>
        <input name="contact_person" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Email</span>
        <input type="email" name="email" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Phone</span>
        <input name="phone" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Mobile</span>
        <input name="mobile" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" />
      </label>
      <label class="space-y-1">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Sector</span>
        <input name="sector" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2" placeholder="Residential / Commercial" />
      </label>
    </div>
    <label class="space-y-1">
      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</span>
      <textarea name="notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800/70 px-3 py-2"></textarea>
    </label>
    <div class="flex items-center justify-end gap-2">
      <button type="submit" class="rounded-xl border border-emerald-500/40 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-100 hover:bg-emerald-500/30">Create customer</button>
    </div>
  </form>
</dialog>

<script>
  (function() {
    const customerField = document.getElementById('liftCustomerCode');
    const enableButton = document.querySelector('[data-action="enable-customer"]');
    if (customerField && enableButton) {
      enableButton.addEventListener('click', () => {
        customerField.removeAttribute('readonly');
        customerField.focus();
      });
    }
    function setupModal(openSelector, modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      document.querySelectorAll(openSelector).forEach((trigger) => {
        trigger.addEventListener('click', () => {
          if (typeof modal.showModal === 'function') {
            modal.showModal();
          } else {
            modal.classList.add('open');
          }
        });
      });
      modal.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
          if (typeof modal.close === 'function') {
            modal.close();
          } else {
            modal.classList.remove('open');
          }
        });
      });
    }
    setupModal('[data-modal-open="customer-create-from-lift"]', 'customerFromLiftModal');

    const amcDurationMonths = {{ amc_duration_months | tojson }};
    const amcStartInput = document.getElementById('liftAmcStartEdit');
    const amcDurationInput = document.getElementById('liftAmcDurationEdit');
    const amcEndInput = document.getElementById('liftAmcEndEdit');

    function addMonths(date, months) {
      const result = new Date(date.getTime());
      const desiredMonth = result.getMonth() + months;
      const year = result.getFullYear();
      result.setMonth(desiredMonth);
      if (result.getMonth() !== ((desiredMonth % 12) + 12) % 12) {
        result.setDate(0);
      }
      return result;
    }

    function formatDateInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function updateAmcEnd() {
      if (!amcStartInput || !amcDurationInput || !amcEndInput) {
        return;
      }
      const startValue = amcStartInput.value;
      const durationKey = amcDurationInput.value;
      if (!startValue || !durationKey || !amcDurationMonths[durationKey]) {
        amcEndInput.value = '';
        return;
      }
      const startDate = new Date(startValue + 'T00:00:00');
      if (Number.isNaN(startDate.getTime())) {
        amcEndInput.value = '';
        return;
      }
      const months = parseInt(amcDurationMonths[durationKey], 10) || 0;
      if (!months) {
        amcEndInput.value = '';
        return;
      }
      const computed = addMonths(startDate, months);
      computed.setDate(computed.getDate() - 1);
      amcEndInput.value = formatDateInput(computed);
    }

    if (amcStartInput && amcDurationInput) {
      amcStartInput.addEventListener('change', updateAmcEnd);
      amcDurationInput.addEventListener('change', updateAmcEnd);
      updateAmcEnd();
    }

    function enforcePreferredDays(select) {
      if (!select) {
        return;
      }
      const selectedValues = Array.from(select.selectedOptions).map((option) => option.value);
      if (selectedValues.includes('any') && selectedValues.length > 1) {
        Array.from(select.options).forEach((option) => {
          if (option.value !== 'any') {
            option.selected = false;
          }
        });
      }
    }

    const preferredDaysSelect = document.getElementById('liftPreferredServiceDaysEdit');
    if (preferredDaysSelect) {
      preferredDaysSelect.addEventListener('change', () => enforcePreferredDays(preferredDaysSelect));
      enforcePreferredDays(preferredDaysSelect);
    }
  })();
</script>
{% endblock %}
