{% extends "base.html" %}
{% block title %}Purchase Order {{ po.po_number }} · Eleva ERP{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-xs uppercase text-slate-500">Purchase</p>
      <h1 class="text-2xl font-semibold">Purchase Order {{ po.po_number }}</h1>
      <div class="flex items-center gap-2">
        <p class="text-sm text-slate-600">Detailed view with linked BOM information.</p>
        <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">{{ (po.origin or 'ERP')|upper }}</span>
      </div>
      {% if po.bom %}
      <p class="mt-2 text-sm text-amber-700">
        Generated from BOM
        <a href="{{ url_for('generate_po_from_bom', bom_id=po.bom.id) }}" class="font-semibold text-amber-800 hover:underline">{{ po.bom.bom_name }}</a>
      </p>
      {% endif %}
    </div>
    <a href="{{ url_for('purchase_orders') }}" class="px-3 py-1.5 rounded-lg border text-sm">Back to list</a>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
      <div>
        <p class="text-xs uppercase text-slate-500">Vendor</p>
        <p class="text-base font-semibold">{{ po.vendor.name if po.vendor else 'Not set' }}</p>
        {% if po.vendor %}
        <p class="text-slate-500">{{ po.vendor.contact_person or '' }}</p>
        {% endif %}
      </div>
      <div>
        <p class="text-xs uppercase text-slate-500">Project / Site</p>
        <p class="text-base font-semibold">{{ po.project.name if po.project else 'General' }}</p>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-500">Status</p>
        <p class="px-2 py-1 inline-block rounded-full bg-slate-100 text-slate-800">{{ po.status|title }}</p>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-500">PO Date</p>
        <p class="text-base font-semibold">{{ po.po_date or po.order_date or '—' }}</p>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-500">Expected Delivery</p>
        <p class="text-base font-semibold">{{ po.expected_delivery or po.expected_delivery_date or '—' }}</p>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-500">Notes</p>
        <p class="text-base text-slate-700 whitespace-pre-line">{{ po.notes or '—' }}</p>
      </div>
    </div>
    {% if po.bom %}
    <div class="text-sm text-slate-700 bg-slate-50 border rounded-lg p-3">
      Generated from BOM <a href="{{ url_for('generate_po_from_bom', bom_id=po.bom.id) }}" class="text-orange-600 hover:underline">{{ po.bom.bom_name }}</a>.
    </div>
    {% endif %}
    {% if po_has_out_of_sync_lines %}
    <div class="text-sm border border-amber-300 bg-amber-50 text-amber-900 rounded-lg p-3">
      <span class="font-semibold">BOM specification updated. Re-apply BOM to sync.</span>
    </div>
    {% endif %}
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div>
        <p class="text-xs uppercase text-slate-500">Line items</p>
        <h2 class="text-lg font-semibold">{{ po.items|length }} item(s)</h2>
      </div>
      <div class="text-right text-sm">
        <div class="px-3 py-1 rounded-lg bg-slate-100 text-slate-700">
          Subtotal: {{ '%.2f'|format(po.subtotal_amount or 0) }}
        </div>
        <div class="mt-1 px-3 py-1 rounded-lg btn-primary btn-shimmer">
          Grand total: {{ '%.2f'|format(po.grand_total_amount or po.subtotal_amount or 0) }}
        </div>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-2 px-3">Part Name</th>
            <th class="py-2 px-3">Description</th>
            <th class="py-2 px-3">Qty</th>
            <th class="py-2 px-3">Unit</th>
            <th class="py-2 px-3">Unit Price</th>
            <th class="py-2 px-3">Currency</th>
            <th class="py-2 px-3">Total</th>
            <th class="py-2 px-3">BOM Sync</th>
            <th class="py-2 px-3">Spec Change</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for item in po.items %}
          <tr>
            <td class="py-2 px-3 font-semibold">
              <div>{{ item.part_name or item.item_code }}</div>
              {% if item.item_code %}
              <div class="text-xs text-slate-500">{{ item.item_code }}</div>
              {% endif %}
            </td>
            <td class="py-2 px-3">{{ item.description }}</td>
            <td class="py-2 px-3">{{ item.quantity_ordered }}</td>
            <td class="py-2 px-3">{{ item.unit }}</td>
            <td class="py-2 px-3">{{ item.unit_price if item.unit_price is not none else '—' }}</td>
            <td class="py-2 px-3">{{ item.currency or '—' }}</td>
            <td class="py-2 px-3">{{ item.total_amount if item.total_amount is not none else '—' }}</td>
            <td class="py-2 px-3">
              {% if item.is_out_of_sync %}
              <span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-800">Out of sync</span>
              {% else %}
              <span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-800">Synced</span>
              {% endif %}
            </td>
            <td class="py-2 px-3">
              {% set req = po_line_request_map.get(item.id) %}
              {% if req %}
              <div class="space-y-1">
                <span class="px-2 py-1 rounded-full text-xs {% if req.status == 'Pending' %}bg-amber-100 text-amber-800{% elif req.status == 'Approved' %}bg-emerald-100 text-emerald-800{% else %}bg-rose-100 text-rose-700{% endif %}">{{ req.status }}</span>
                <p class="text-xs text-slate-600">{{ req.reason }}</p>
                {% if req.suggested_alternative %}
                <p class="text-xs text-slate-500">Alt: {{ req.suggested_alternative }}</p>
                {% endif %}
              </div>
              {% endif %}
              {% if is_purchase_user and item.source_bom_line_id %}
              <button type="button" class="mt-1 px-2 py-1 rounded border border-amber-300 text-amber-800 text-xs hover:bg-amber-50" onclick="openSpecChangeModal('{{ item.id }}')">Request Spec Change</button>
              <div id="spec-change-modal-{{ item.id }}" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/60 px-4">
                <div class="w-full max-w-lg rounded-xl bg-white border border-slate-200 shadow-2xl p-4" onclick="event.stopPropagation()">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold">Request Spec Change</h3>
                    <button type="button" class="text-slate-500" onclick="closeSpecChangeModal('{{ item.id }}')">✕</button>
                  </div>
                  <form method="POST" action="{{ url_for('purchase_order_request_spec_change', po_id=po.id) }}" class="space-y-3">
                    {{ csrf_field() }}
                    <input type="hidden" name="po_line_id" value="{{ item.id }}" />
                    <label class="block space-y-1">
                      <span class="text-xs text-slate-600">Reason <span class="text-rose-600">*</span></span>
                      <textarea name="reason" rows="3" required class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Why the BOM specification cannot be sourced"></textarea>
                    </label>
                    <label class="block space-y-1">
                      <span class="text-xs text-slate-600">Suggested alternative (optional)</span>
                      <textarea name="suggested_alternative" rows="2" class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Alternate part/spec"></textarea>
                    </label>
                    <div class="flex justify-end gap-2">
                      <button type="button" class="px-3 py-1.5 rounded border" onclick="closeSpecChangeModal('{{ item.id }}')">Cancel</button>
                      <button type="submit" class="px-3 py-1.5 rounded btn-primary btn-shimmer">Submit Request</button>
                    </div>
                  </form>
                </div>
              </div>
              {% elif not req %}
              <span class="text-xs text-slate-400">—</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="9" class="py-3 px-3 text-slate-500">No items yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-3 items-start">
    <div class="lg:col-span-2 bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
      <div>
        <p class="text-xs uppercase text-slate-500">Vendor issues</p>
        <h2 class="text-lg font-semibold">Issues linked to this PO</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="py-2 px-3">Date</th>
              <th class="py-2 px-3">Issue Type</th>
              <th class="py-2 px-3">Part</th>
              <th class="py-2 px-3">Source</th>
              <th class="py-2 px-3">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for issue in vendor_issues %}
            <tr>
              <td class="py-2 px-3 text-xs text-slate-500">{{ issue.created_at.strftime('%d %b %Y') if issue.created_at else '—' }}</td>
              <td class="py-2 px-3 font-semibold text-slate-800">{{ issue.issue_type.replace('_', ' ') }}</td>
              <td class="py-2 px-3">{{ issue.product.name if issue.product else '—' }}</td>
              <td class="py-2 px-3">{{ issue.source.replace('_', ' ') }}</td>
              <td class="py-2 px-3">{{ issue.status }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="py-3 px-3 text-slate-500">No vendor issues logged for this PO.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
      <div>
        <p class="text-xs uppercase text-slate-500">Log vendor issue</p>
        <h2 class="text-lg font-semibold">Manual entry</h2>
      </div>
      {% if po.vendor %}
      <form method="POST" action="{{ url_for('purchase_order_issue_create', po_id=po.id) }}" class="space-y-3">
        {{ csrf_field() }}
        <label class="space-y-1 block">
          <span class="text-xs text-slate-600">Vendor</span>
          <input type="text" readonly value="{{ po.vendor.name }}" class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2" />
        </label>
        <label class="space-y-1 block">
          <span class="text-xs text-slate-600">Part (optional)</span>
          <select name="product_id" class="w-full rounded-lg border-slate-200 px-3 py-2">
            <option value="">—</option>
            {% for part in issue_products %}
            <option value="{{ part.id }}">{{ part.label }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1 block">
          <span class="text-xs text-slate-600">Issue type</span>
          <select name="issue_type" class="w-full rounded-lg border-slate-200 px-3 py-2">
            {% for issue_value, issue_label in issue_type_options %}
            <option value="{{ issue_value }}">{{ issue_label }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1 block">
          <span class="text-xs text-slate-600">Description</span>
          <textarea name="description" rows="3" class="w-full rounded-lg border-slate-200 px-3 py-2" placeholder="Describe the issue"></textarea>
        </label>
        <div class="flex justify-end">
          <button type="submit" class="px-4 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Log issue</button>
        </div>
      </form>
      {% else %}
      <p class="text-sm text-slate-500">Assign a vendor to this PO to log issues.</p>
      {% endif %}
    </div>
  </div>
</div>
<script>
  function openSpecChangeModal(itemId) {
    const modal = document.getElementById(`spec-change-modal-${itemId}`);
    if (!modal) return;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeSpecChangeModal(itemId) {
    const modal = document.getElementById(`spec-change-modal-${itemId}`);
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>
{% endblock %}
