{% extends "base.html" %}
{% block title %}Design · BOM Template · Eleva ERP{% endblock %}

{% block content %}
<div class="space-y-6">
  <div>
    <p class="text-sm uppercase text-slate-500">Design · BOM Templates</p>
    <h1 class="text-2xl font-semibold text-slate-100">{{ template.name }}</h1>
    <p class="text-sm text-slate-400 mt-1">Edit inputs, stages, sections, and BOM lines. Live validation is available under Test &amp; Validate.</p>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <form method="post" class="grid lg:grid-cols-4 gap-4">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="update_template" />
      <div class="lg:col-span-2">
        <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Template name</label>
        <input name="name" value="{{ template.name }}" class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" />
      </div>
      <div>
        <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Lift type</label>
        <select name="lift_type" class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2">
          {% for lift in LIFT_TYPES %}
            <option value="{{ lift }}" {% if template.lift_type == lift %}selected{% endif %}>{{ lift }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-end">
        <label class="flex items-center gap-2 text-sm text-slate-300">
          <input type="checkbox" name="is_active" value="1" {% if template.is_active %}checked{% endif %} />
          Active template
        </label>
      </div>
      <div class="lg:col-span-4">
        <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
        <textarea name="description" rows="2" class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2">{{ template.description or '' }}</textarea>
      </div>
      <div class="lg:col-span-4">
        <button class="px-4 py-2 rounded-xl bg-emerald-500/90 text-white font-semibold">Save Template</button>
      </div>
    </form>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-center gap-2 border-b border-slate-800 px-6 py-3">
      <button type="button" class="tab-btn px-3 py-2 rounded-lg text-sm bg-slate-800 text-slate-100" data-tab="inputs">Inputs</button>
      <button type="button" class="tab-btn px-3 py-2 rounded-lg text-sm text-slate-300" data-tab="structure">Structure</button>
      <button type="button" class="tab-btn px-3 py-2 rounded-lg text-sm text-slate-300" data-tab="test">Test &amp; Validate</button>
    </div>

    <div class="tab-panel p-6 space-y-6" data-panel="inputs">
      <div>
        <h2 class="text-lg font-semibold text-slate-100 mb-4">Input Sheet</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-xs uppercase tracking-wide text-slate-500">
                <th class="px-3 py-2">Input Key</th>
                <th class="px-3 py-2">Label</th>
                <th class="px-3 py-2">Unit</th>
                <th class="px-3 py-2">Default</th>
                <th class="px-3 py-2">Type</th>
                <th class="px-3 py-2">Required</th>
                <th class="px-3 py-2">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
              {% for input in template.inputs %}
              <tr>
                <td colspan="7" class="px-3 py-2">
                  <div class="grid lg:grid-cols-7 gap-2 items-center">
                    <form method="post" class="grid lg:grid-cols-6 gap-2 items-center lg:col-span-6">
                      {{ csrf_field() }}
                      <input type="hidden" name="action" value="update_input" />
                      <input type="hidden" name="input_id" value="{{ input.id }}" />
                      <input name="input_key" value="{{ input.input_key }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" />
                      <input name="label" value="{{ input.label }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" />
                      <input name="unit" value="{{ input.unit or '' }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" />
                      <input name="default_value" value="{{ input.default_value or '' }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" />
                      <select name="data_type" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1">
                        {% for dtype in BOM_INPUT_DATA_TYPES %}
                          <option value="{{ dtype }}" {% if input.data_type == dtype %}selected{% endif %}>{{ dtype }}</option>
                        {% endfor %}
                      </select>
                      <label class="flex items-center gap-2 text-xs text-slate-300">
                        <input type="checkbox" name="required" value="1" {% if input.required %}checked{% endif %} />
                        Required
                      </label>
                      <button class="px-3 py-1 rounded-lg bg-slate-800 text-slate-100 text-xs">Save</button>
                    </form>
                    <form method="post" class="flex items-center">
                      {{ csrf_field() }}
                      <input type="hidden" name="action" value="delete_input" />
                      <input type="hidden" name="input_id" value="{{ input.id }}" />
                      <button class="px-3 py-1 rounded-lg bg-rose-500/80 text-white text-xs">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="px-3 py-6 text-center text-slate-500">No inputs yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="border-t border-slate-800 pt-6">
        <h3 class="text-base font-semibold text-slate-100 mb-3">Add Input</h3>
        <form method="post" class="grid lg:grid-cols-6 gap-3">
          {{ csrf_field() }}
          <input type="hidden" name="action" value="add_input" />
          <input name="input_key" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" placeholder="travel_height" />
          <input name="label" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" placeholder="Travel height" />
          <input name="unit" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" placeholder="mm" />
          <input name="default_value" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" placeholder="Default value" />
          <select name="data_type" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2">
            {% for dtype in BOM_INPUT_DATA_TYPES %}
              <option value="{{ dtype }}">{{ dtype }}</option>
            {% endfor %}
          </select>
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input type="checkbox" name="required" value="1" />
            Required
          </label>
          <div class="lg:col-span-6">
            <button class="px-4 py-2 rounded-xl bg-emerald-500/90 text-white font-semibold">Add Input</button>
          </div>
        </form>
      </div>
    </div>

    <div class="tab-panel hidden p-6 space-y-6" data-panel="structure">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-100">Stages &amp; Sections</h2>
        <p class="text-xs text-slate-400">Drag to reorder, then save each row to persist the new display order.</p>
      </div>

      <div class="space-y-6">
        <div class="space-y-4" data-sortable>
          {% for stage in template.stages|sort(attribute='display_order') %}
          <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 space-y-4 sortable-item" draggable="true">
            <div class="flex flex-wrap items-center gap-3">
              <form method="post" class="flex flex-wrap items-center gap-2 flex-1">
                {{ csrf_field() }}
                <input type="hidden" name="action" value="update_stage" />
                <input type="hidden" name="stage_id" value="{{ stage.id }}" />
                <input name="stage_name" value="{{ stage.stage_name }}" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 flex-1 min-w-[200px]" />
                <input name="display_order" value="{{ stage.display_order }}" type="number" class="w-24 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 order-input" />
                <button class="px-3 py-2 rounded-xl bg-slate-800 text-slate-100 text-xs">Save</button>
              </form>
              <form method="post">
                {{ csrf_field() }}
                <input type="hidden" name="action" value="delete_stage" />
                <input type="hidden" name="stage_id" value="{{ stage.id }}" />
                <button class="px-3 py-2 rounded-xl bg-rose-500/80 text-white text-xs">Delete</button>
              </form>
            </div>

            <div class="space-y-3" data-sortable>
              {% for section in stage.sections|sort(attribute='display_order') %}
              <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 space-y-4 sortable-item" draggable="true">
                <div class="flex flex-wrap items-center gap-2">
                  <form method="post" class="flex flex-wrap items-center gap-2 flex-1">
                    {{ csrf_field() }}
                    <input type="hidden" name="action" value="update_section" />
                    <input type="hidden" name="section_id" value="{{ section.id }}" />
                    <input name="section_name" value="{{ section.section_name }}" class="rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 flex-1 min-w-[180px]" />
                    <input name="display_order" value="{{ section.display_order }}" type="number" class="w-24 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 order-input" />
                    <button class="px-3 py-2 rounded-xl bg-slate-800 text-slate-100 text-xs">Save</button>
                  </form>
                  <form method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="action" value="delete_section" />
                    <input type="hidden" name="section_id" value="{{ section.id }}" />
                    <button class="px-3 py-2 rounded-xl bg-rose-500/80 text-white text-xs">Delete</button>
                  </form>
                </div>

                <div class="space-y-3" data-sortable>
                  {% for line in section.lines|sort(attribute='display_order') %}
                  <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 space-y-3 sortable-item" draggable="true">
                    <form method="post" class="grid lg:grid-cols-6 gap-2">
                      {{ csrf_field() }}
                      <input type="hidden" name="action" value="update_line" />
                      <input type="hidden" name="line_id" value="{{ line.id }}" />
                      <input type="hidden" name="ref_key" value="{{ line.ref_key }}" />
                      <select name="part_class_id" data-section-id="{{ section.id }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1">
                        {% if line.part_class and not line.part_class.active %}
                          <option value="{{ line.part_class.id }}" selected>{{ line.part_class.name }} (Inactive)</option>
                        {% endif %}
                        {% for part in part_classes %}
                          <option value="{{ part.id }}" {% if line.part_class_id == part.id %}selected{% endif %}>{{ part.name }}</option>
                        {% endfor %}
                      </select>
                      <input name="unit" value="{{ line.unit }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" placeholder="unit" />
                      <input name="display_order" value="{{ line.display_order }}" type="number" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 order-input" />
                      <input name="specification_text" value="{{ line.specification_text or '' }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="Specification" />
                      <input name="include_if_expr" value="{{ line.include_if_expr or '' }}" class="expr-field rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="include_if_expr" />
                      <input name="qty_expr" value="{{ line.qty_expr }}" class="expr-field rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="qty_expr" />
                      <input name="override_if_expr" value="{{ line.override_if_expr or '' }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="override_if_expr" />
                      <input name="override_qty_expr" value="{{ line.override_qty_expr or '' }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="override_qty_expr" />
                      <div class="lg:col-span-6 flex flex-wrap gap-2">
                        <button class="px-3 py-1 rounded-lg bg-slate-800 text-slate-100 text-xs">Save</button>
                      </div>
                    </form>
                    <form method="post">
                      {{ csrf_field() }}
                      <input type="hidden" name="action" value="delete_line" />
                      <input type="hidden" name="line_id" value="{{ line.id }}" />
                      <button class="px-3 py-1 rounded-lg bg-rose-500/80 text-white text-xs">Delete</button>
                    </form>
                  </div>
                  {% else %}
                  <div class="text-xs text-slate-500">No lines yet.</div>
                  {% endfor %}
                </div>

                <form method="post" class="grid lg:grid-cols-6 gap-2">
                  {{ csrf_field() }}
                  <input type="hidden" name="action" value="add_line" />
                  <input type="hidden" name="section_id" value="{{ section.id }}" />
                  <input type="hidden" name="ref_key" />
                  <select name="part_class_id" data-section-id="{{ section.id }}" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1">
                    <option value="">Select part class</option>
                    {% for part in part_classes %}
                      <option value="{{ part.id }}">{{ part.name }}</option>
                    {% endfor %}
                  </select>
                  <input name="unit" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" placeholder="unit" />
                  <input name="display_order" type="number" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" placeholder="order" />
                  <input name="specification_text" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="Specification" />
                  <input name="include_if_expr" class="expr-field rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="include_if_expr" />
                  <input name="qty_expr" class="expr-field rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="qty_expr" />
                  <input name="override_if_expr" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="override_if_expr" />
                  <input name="override_qty_expr" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="override_qty_expr" />
                  <div class="lg:col-span-6">
                    <button class="px-3 py-2 rounded-xl bg-emerald-500/90 text-white text-xs font-semibold">Add Line</button>
                  </div>
                </form>
              </div>
              {% endfor %}
            </div>

            <form method="post" class="grid lg:grid-cols-4 gap-2">
              {{ csrf_field() }}
              <input type="hidden" name="action" value="add_section" />
              <input type="hidden" name="stage_id" value="{{ stage.id }}" />
              <input name="section_name" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="Section name" />
              <input name="display_order" type="number" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" placeholder="Order" />
              <button class="px-3 py-2 rounded-xl bg-emerald-500/90 text-white text-xs font-semibold">Add Section</button>
            </form>
          </div>
          {% else %}
          <div class="text-sm text-slate-500">No stages yet.</div>
          {% endfor %}
        </div>

        <form method="post" class="grid lg:grid-cols-4 gap-2">
          {{ csrf_field() }}
          <input type="hidden" name="action" value="add_stage" />
          <input name="stage_name" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1 lg:col-span-2" placeholder="Stage name" />
          <input name="display_order" type="number" class="rounded-lg border border-slate-700 bg-slate-900/70 px-2 py-1" placeholder="Order" />
          <button class="px-3 py-2 rounded-xl bg-emerald-500/90 text-white text-xs font-semibold">Add Stage</button>
        </form>
      </div>
    </div>

    <div class="tab-panel hidden p-6 space-y-6" data-panel="test" id="test-panel">
      <div>
        <h2 class="text-lg font-semibold text-slate-100 mb-2">Test &amp; Validate</h2>
        <p class="text-sm text-slate-400">Enter sample values to validate formulas. Errors do not block saving but will block BOM generation.</p>
      </div>

      <form method="post" class="grid lg:grid-cols-3 gap-3">
        {{ csrf_field() }}
        <input type="hidden" name="action" value="test_inputs" />
        {% for input in template.inputs %}
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">{{ input.label }}</label>
            <input name="test_input_{{ input.input_key }}" class="w-full rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2" placeholder="{{ input.input_key }}" />
            <p class="text-xs text-slate-500 mt-1">{{ input.unit or input.data_type }}</p>
          </div>
        {% endfor %}
        <div class="lg:col-span-3">
          <button class="px-4 py-2 rounded-xl bg-emerald-500/90 text-white font-semibold">Run Validation</button>
        </div>
      </form>

      {% if evaluation %}
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 space-y-4">
        <h3 class="text-base font-semibold text-slate-100">Validation Results</h3>
        {% if evaluation.errors %}
          <div class="rounded-lg border border-amber-500/40 bg-amber-500/10 p-3 text-amber-100 text-sm">
            <ul class="list-disc list-inside space-y-1">
              {% for error in evaluation.errors %}
                <li>{{ error.message }}</li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <p class="text-sm text-emerald-200">No template-level errors found.</p>
        {% endif %}
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-xs uppercase tracking-wide text-slate-500">
                <th class="px-3 py-2">Part Class</th>
                <th class="px-3 py-2">Final Qty</th>
                <th class="px-3 py-2">Errors</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
              {% for line in evaluation.lines %}
              <tr>
                <td class="px-3 py-2 text-slate-300">{{ line.line.part_class.name if line.line.part_class else '—' }}</td>
                <td class="px-3 py-2 text-slate-100">{{ "%.2f"|format(line.final_qty) }}</td>
                <td class="px-3 py-2">
                  {% if line.errors %}
                    <ul class="list-disc list-inside text-xs text-amber-200 space-y-1">
                      {% for error in line.errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <span class="text-xs text-emerald-200">OK</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div id="expr-helper" class="expr-helper hidden rounded-xl border border-slate-700 bg-slate-950/95 text-slate-200 shadow-xl">
  <div class="flex items-center justify-between border-b border-slate-800 px-3 py-2">
    <div class="text-xs uppercase tracking-wide text-slate-400">Insert Variable</div>
    <div class="text-[10px] text-slate-500">Esc to close</div>
  </div>
  <div class="p-3 space-y-3">
    <input id="expr-helper-search" type="text" class="w-full rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm" placeholder="Search inputs or line keys..." />
    <div class="flex flex-wrap gap-2">
      <button type="button" class="expr-fn-btn rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-xs" data-token="roundup(">roundup()</button>
      <button type="button" class="expr-fn-btn rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-xs" data-token="min(">min()</button>
      <button type="button" class="expr-fn-btn rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-xs" data-token="max(">max()</button>
    </div>
    <div class="expr-helper-scroll space-y-4">
      <div>
        <div class="text-xs uppercase tracking-wide text-slate-500 mb-2">Inputs</div>
        <div id="expr-helper-inputs" class="space-y-1"></div>
      </div>
      <div>
        <div class="text-xs uppercase tracking-wide text-slate-500 mb-2">Line Keys</div>
        <div id="expr-helper-lines" class="space-y-1"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .expr-helper {
    position: fixed;
    width: 340px;
    max-width: calc(100vw - 24px);
    max-height: 420px;
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease, top 0.1s ease, left 0.1s ease;
    z-index: 9999;
  }
  .expr-helper.is-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
  .expr-helper.is-measuring {
    opacity: 0;
    pointer-events: none;
  }
  .expr-helper-scroll {
    max-height: 280px;
    overflow: auto;
    padding-right: 4px;
  }
  .expr-helper-item {
    display: flex;
    align-items: center;
    gap: 8px;
    border-radius: 8px;
    padding: 6px 8px;
    border: 1px solid transparent;
  }
  .expr-helper-item.is-active {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.4);
  }
  .expr-helper-item button {
    border-radius: 6px;
  }
</style>

<script>
  window.BOM_INPUT_KEYS = {{ input_keys|tojson }};
  window.BOM_LINE_KEYS = {{ line_keys|tojson }};
  window.BOM_PART_CLASSES = {{ part_class_sections|tojson }};

  const templateId = {{ template.id }};
  const scrollStorageKey = `bomTemplateScroll:${templateId}`;
  const tabStorageKey = `bomTemplateTab:${templateId}`;
  let activeTab = sessionStorage.getItem(tabStorageKey) || 'inputs';

  const tabButtons = document.querySelectorAll('.tab-btn');
  const panels = document.querySelectorAll('.tab-panel');
  const setActiveTab = (target) => {
    activeTab = target;
    sessionStorage.setItem(tabStorageKey, target);
    tabButtons.forEach((b) => b.classList.remove('bg-slate-800', 'text-slate-100'));
    tabButtons.forEach((b) => b.classList.add('text-slate-300'));
    tabButtons.forEach((btn) => {
      if (btn.dataset.tab === target) {
        btn.classList.add('bg-slate-800', 'text-slate-100');
        btn.classList.remove('text-slate-300');
      }
    });
    panels.forEach((panel) => {
      panel.classList.toggle('hidden', panel.dataset.panel !== target);
    });
  };

  tabButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      setActiveTab(btn.dataset.tab);
    });
  });

  setActiveTab(activeTab);

  document.querySelectorAll('form').forEach((form) => {
    form.addEventListener('submit', () => {
      sessionStorage.setItem(scrollStorageKey, window.scrollY.toString());
      sessionStorage.setItem(tabStorageKey, activeTab);
    });
  });

  window.addEventListener('load', () => {
    const savedScroll = sessionStorage.getItem(scrollStorageKey);
    if (savedScroll) {
      window.scrollTo({ top: Number(savedScroll), left: 0, behavior: 'auto' });
      sessionStorage.removeItem(scrollStorageKey);
    }
  });

  const partClassSections = window.BOM_PART_CLASSES || [];
  const partClassSectionMap = partClassSections.reduce((acc, item) => {
    acc[String(item.id)] = (item.associated_sections || []).map((value) => String(value));
    return acc;
  }, {});

  const buildSectionAwarePartClasses = (select) => {
    const sectionId = select.dataset.sectionId;
    if (!sectionId) return;
    const partOptions = Array.from(select.options);
    const placeholderOptions = partOptions.filter((option) => option.value === '');
    const validOptions = partOptions.filter((option) => option.value !== '');
    const mappedOptions = validOptions.filter(
      (option) => String(option.value) in partClassSectionMap
    );
    const unmappedOptions = validOptions.filter(
      (option) => !(String(option.value) in partClassSectionMap)
    );
    const recommendedOptions = mappedOptions.filter((option) => {
      const sections = partClassSectionMap[String(option.value)] || [];
      return sections.includes(String(sectionId));
    });
    if (!recommendedOptions.length) {
      return;
    }
    const remainingOptions = mappedOptions.filter(
      (option) => !recommendedOptions.includes(option)
    );
    const allOptions = [...remainingOptions, ...unmappedOptions];
    select.innerHTML = '';
    placeholderOptions.forEach((option) => select.appendChild(option));
    const recommendedGroup = document.createElement('optgroup');
    recommendedGroup.label = 'Recommended for this section';
    recommendedOptions.forEach((option) => recommendedGroup.appendChild(option));
    const allGroup = document.createElement('optgroup');
    allGroup.label = 'All Part Classes';
    allOptions.forEach((option) => allGroup.appendChild(option));
    select.appendChild(recommendedGroup);
    select.appendChild(allGroup);
  };

  document.querySelectorAll('select[name="part_class_id"]').forEach((select) => {
    buildSectionAwarePartClasses(select);
  });

  document.querySelectorAll('[data-sortable]').forEach((container) => {
    let dragged = null;
    container.querySelectorAll('.sortable-item').forEach((item) => {
      item.addEventListener('dragstart', () => {
        dragged = item;
        item.classList.add('opacity-60');
      });
      item.addEventListener('dragend', () => {
        item.classList.remove('opacity-60');
      });
      item.addEventListener('dragover', (event) => {
        event.preventDefault();
      });
      item.addEventListener('drop', (event) => {
        event.preventDefault();
        if (!dragged || dragged === item) return;
        const items = Array.from(container.querySelectorAll('.sortable-item'));
        const draggedIndex = items.indexOf(dragged);
        const targetIndex = items.indexOf(item);
        if (draggedIndex < targetIndex) {
          item.after(dragged);
        } else {
          item.before(dragged);
        }
        Array.from(container.children).forEach((child, idx) => {
          if (!child.classList.contains('sortable-item')) {
            return;
          }
          const input = child.querySelector('.order-input');
          if (input) {
            input.value = (idx + 1) * 10;
          }
        });
      });
    });
  });

  const helper = document.getElementById('expr-helper');
  const helperSearch = document.getElementById('expr-helper-search');
  const helperInputs = document.getElementById('expr-helper-inputs');
  const helperLines = document.getElementById('expr-helper-lines');
  const helperFnButtons = helper.querySelectorAll('.expr-fn-btn');
  const inputKeys = window.BOM_INPUT_KEYS || [];
  const lineKeys = window.BOM_LINE_KEYS || [];
  let activeField = null;
  let activeIndex = -1;
  let visibleItems = [];
  let pendingPositionFrame = null;
  let activeScrollParent = null;
  let activeScrollParentHandler = null;

  const buildInputLabel = (item) => {
    const label = (item.label || '').trim();
    return label ? `${item.key} — ${label}` : item.key;
  };

  const buildLineLabel = (item) => {
    const details = [
      item.specification_text,
      item.unit,
      item.part_class,
      item.section,
      item.stage,
    ]
      .map((value) => (value || '').trim())
      .filter(Boolean);
    return details.length ? `${item.ref_key} — ${details.join(' · ')}` : item.ref_key;
  };

  const buildFilterText = (item, type) => {
    if (type === 'input') {
      return `${item.key} ${item.label || ''}`.toLowerCase();
    }
    return [
      item.ref_key,
      item.specification_text,
      item.unit,
      item.part_class,
      item.section,
      item.stage,
    ]
      .join(' ')
      .toLowerCase();
  };

  const renderHelperLists = () => {
    const term = (helperSearch.value || '').trim().toLowerCase();
    const filteredInputs = inputKeys.filter((item) =>
      buildFilterText(item, 'input').includes(term),
    );
    const filteredLines = lineKeys.filter((item) =>
      buildFilterText(item, 'line').includes(term),
    );

    const combined = [
      ...filteredInputs.map((item) => ({
        type: 'input',
        key: item.key,
        id: `input:${item.key}`,
        label: buildInputLabel(item),
      })),
      ...filteredLines.map((item) => ({
        type: 'line',
        key: item.ref_key,
        id: `line:${item.ref_key}`,
        label: buildLineLabel(item),
      })),
    ];

    helperInputs.innerHTML = filteredInputs.length
      ? filteredInputs
          .map((item) => {
            const label = buildInputLabel(item);
            return `
              <div class="expr-helper-item" data-key="${item.key}" data-id="input:${item.key}" data-type="input">
                <button type="button" class="flex-1 text-left text-sm text-slate-100" data-token="${item.key}">
                  ${label}
                </button>
                <button type="button" class="text-xs text-slate-400 hover:text-slate-200" data-copy="${item.key}">Copy</button>
              </div>
            `;
          })
          .join('')
      : '<div class="text-xs text-slate-500">No inputs found.</div>';

    helperLines.innerHTML = filteredLines.length
      ? filteredLines
          .map((item) => {
            const label = buildLineLabel(item);
            return `
              <div class="expr-helper-item" data-key="${item.ref_key}" data-id="line:${item.ref_key}" data-type="line">
                <button type="button" class="flex-1 text-left text-sm text-slate-100" data-token="${item.ref_key}">
                  ${label}
                </button>
                <button type="button" class="text-xs text-slate-400 hover:text-slate-200" data-copy="${item.ref_key}">Copy</button>
              </div>
            `;
          })
          .join('')
      : '<div class="text-xs text-slate-500">No line keys found.</div>';

    visibleItems = combined;
    activeIndex = visibleItems.length ? 0 : -1;
    syncActiveHighlight();
  };

  const syncActiveHighlight = () => {
    helper.querySelectorAll('.expr-helper-item').forEach((item) => {
      item.classList.remove('is-active');
    });
    if (activeIndex < 0 || activeIndex >= visibleItems.length) {
      return;
    }
    const target = visibleItems[activeIndex];
    const targetEl = helper.querySelector(
      `.expr-helper-item[data-id="${CSS.escape(target.id)}"]`,
    );
    if (targetEl) {
      targetEl.classList.add('is-active');
      targetEl.scrollIntoView({ block: 'nearest' });
    }
  };

  const insertToken = (token) => {
    if (!activeField) return;
    const start = activeField.selectionStart ?? activeField.value.length;
    const end = activeField.selectionEnd ?? activeField.value.length;
    const value = activeField.value || '';
    activeField.value = value.slice(0, start) + token + value.slice(end);
    const cursorPosition = start + token.length;
    activeField.setSelectionRange(cursorPosition, cursorPosition);
    activeField.dispatchEvent(new Event('input', { bubbles: true }));
    activeField.focus();
  };

  const copyToken = async (token) => {
    try {
      await navigator.clipboard.writeText(token);
    } catch (error) {
      const temp = document.createElement('textarea');
      temp.value = token;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);
    }
  };

  const findScrollableParent = (element) => {
    let current = element?.parentElement;
    while (current && current !== document.body) {
      const style = window.getComputedStyle(current);
      const overflowY = style.overflowY;
      const overflowX = style.overflowX;
      const canScrollY = ['auto', 'scroll', 'overlay'].includes(overflowY);
      const canScrollX = ['auto', 'scroll', 'overlay'].includes(overflowX);
      if ((canScrollY && current.scrollHeight > current.clientHeight) ||
          (canScrollX && current.scrollWidth > current.clientWidth)) {
        return current;
      }
      current = current.parentElement;
    }
    return null;
  };

  const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

  const positionHelper = (field = activeField) => {
    if (!field || helper.classList.contains('hidden')) return;
    const rect = field.getBoundingClientRect();
    helper.style.top = '0px';
    helper.style.left = '0px';
    const helperRect = helper.getBoundingClientRect();
    let left = rect.right + 8;
    let top = rect.top;
    if (left + helperRect.width > window.innerWidth - 8) {
      left = rect.left - helperRect.width - 8;
    }
    if (top + helperRect.height > window.innerHeight - 8) {
      top = window.innerHeight - helperRect.height - 8;
    }
    const maxLeft = window.innerWidth - helperRect.width - 8;
    const maxTop = window.innerHeight - helperRect.height - 8;
    helper.style.left = `${clamp(left, 8, maxLeft)}px`;
    helper.style.top = `${clamp(top, 8, maxTop)}px`;
  };

  const openHelper = (field) => {
    activeField = field;
    helper.classList.remove('hidden');
    helper.classList.add('is-open');
    helper.classList.add('is-measuring');
    helperSearch.value = '';
    renderHelperLists();
    if (activeScrollParent && activeScrollParentHandler) {
      activeScrollParent.removeEventListener('scroll', activeScrollParentHandler);
    }
    activeScrollParent = findScrollableParent(field);
    if (activeScrollParent) {
      activeScrollParentHandler = () => schedulePosition();
      activeScrollParent.addEventListener('scroll', activeScrollParentHandler, {
        passive: true,
      });
    } else {
      activeScrollParentHandler = null;
    }
    requestAnimationFrame(() => {
      positionHelper(field);
      helper.classList.remove('is-measuring');
    });
  };

  const closeHelper = () => {
    helper.classList.remove('is-open');
    activeField = null;
    if (activeScrollParent && activeScrollParentHandler) {
      activeScrollParent.removeEventListener('scroll', activeScrollParentHandler);
    }
    activeScrollParent = null;
    activeScrollParentHandler = null;
    window.setTimeout(() => {
      if (!helper.classList.contains('is-open')) {
        helper.classList.add('hidden');
      }
    }, 160);
  };

  const schedulePosition = () => {
    if (!activeField) return;
    if (pendingPositionFrame) {
      cancelAnimationFrame(pendingPositionFrame);
    }
    pendingPositionFrame = requestAnimationFrame(positionHelper);
  };

  document.addEventListener('focusin', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (!target.classList.contains('expr-field')) return;
    openHelper(target);
  });

  document.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (helper.contains(target)) {
      const token = target.dataset.token;
      const copyValue = target.dataset.copy;
      if (token) {
        insertToken(token);
      }
      if (copyValue) {
        copyToken(copyValue);
      }
      return;
    }
    if (target.classList.contains('expr-field')) {
      return;
    }
    closeHelper();
  });

  document.addEventListener('keydown', (event) => {
    if (!activeField || helper.classList.contains('hidden')) return;
    if (event.key === 'Escape') {
      event.preventDefault();
      closeHelper();
      activeField.blur();
      return;
    }
    if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
      if (!visibleItems.length) return;
      event.preventDefault();
      if (event.key === 'ArrowDown') {
        activeIndex = (activeIndex + 1) % visibleItems.length;
      } else {
        activeIndex = (activeIndex - 1 + visibleItems.length) % visibleItems.length;
      }
      syncActiveHighlight();
      return;
    }
    if (event.key === 'Enter') {
      if (activeIndex < 0 || activeIndex >= visibleItems.length) return;
      event.preventDefault();
      insertToken(visibleItems[activeIndex].key);
    }
  });

  helperSearch.addEventListener('input', () => {
    renderHelperLists();
  });

  helperFnButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const token = btn.dataset.token;
      if (token) {
        insertToken(token);
      }
    });
  });

  window.addEventListener('scroll', schedulePosition, true);
  window.addEventListener('resize', schedulePosition);
</script>
{% endblock %}
