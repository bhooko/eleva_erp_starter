{% extends "base.html" %}
{% block title %}Purchase ¬∑ Parts{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Inventory</p>
      <h1 class="text-2xl font-semibold">Parts</h1>
      <p class="text-sm text-slate-600">Manage part master data and sync updates from Odoo exports.</p>
    </div>
    <div class="flex items-center gap-3">
      <label for="upload-products" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">Upload Parts (Odoo)</label>
    </div>
  </div>

  <div class="relative">
    <input type="checkbox" id="upload-products" class="hidden peer" />
    <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('upload-products').checked=false;"></div>
    <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
        <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
          <div>
            <p class="text-xs text-slate-500 uppercase">Part import</p>
            <h2 class="text-lg font-semibold">Upload Parts (Odoo)</h2>
          </div>
          <button class="text-slate-500" type="button" onclick="document.getElementById('upload-products').checked=false;">‚úï</button>
        </div>
        <form method="POST" action="{{ url_for('products_upload') }}" enctype="multipart/form-data" class="p-5 space-y-4">
          {{ csrf_field() }}
          <p class="text-sm text-slate-600">Upload the <span class="font-semibold">Odoo Products.xlsx</span> export (.xlsx or .csv). The sheet must include columns: Name, Sales Price, Cost, Unit of Measure, Purchase Unit, Quantity On Hand.</p>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Upload file</span>
            <input type="file" name="product_upload_file" accept=".xlsx,.csv" required class="w-full rounded-lg border-slate-200" />
          </label>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('upload-products').checked=false;">Cancel</button>
            <button type="submit" class="px-5 py-2 rounded-lg bg-slate-900 text-white shadow hover:shadow-lg hover:scale-[1.02] transition">Upload Parts</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <label class="relative w-full md:max-w-sm">
      <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">üîç</span>
      <input
        id="parts-search"
        type="search"
        placeholder="Search parts by name, unit, or pricing"
        class="w-full rounded-xl border border-slate-200 pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/50"
      />
    </label>
    <p class="text-xs text-slate-500">Type to filter results; click a column header to sort.</p>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
    <table id="parts-table" class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="0">
            <span class="inline-flex items-center gap-1">Name <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="1">
            <span class="inline-flex items-center gap-1">Sales Price <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="2">
            <span class="inline-flex items-center gap-1">Cost <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="3">
            <span class="inline-flex items-center gap-1">UoM <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="4">
            <span class="inline-flex items-center gap-1">Purchase UoM <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="5">
            <span class="inline-flex items-center gap-1">Qty on Hand <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="6">
            <span class="inline-flex items-center gap-1">Forecast Qty <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="7">
            <span class="inline-flex items-center gap-1">Favorite <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for product in products %}
        <tr>
          <td class="py-3 px-4 font-semibold text-slate-800">{{ product.name }}</td>
          <td class="py-3 px-4">{{ (product.sale_price or 0) | round(2) }}</td>
          <td class="py-3 px-4">{{ (product.cost or 0) | round(2) }}</td>
          <td class="py-3 px-4">{{ product.uom or '‚Äî' }}</td>
          <td class="py-3 px-4">{{ product.purchase_uom or '‚Äî' }}</td>
          <td class="py-3 px-4">{{ (product.qty_on_hand or 0) | round(2) }}</td>
          <td class="py-3 px-4">{{ (product.forecast_qty or 0) | round(2) }}</td>
          <td class="py-3 px-4">
            {% if product.is_favorite %}
            <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 text-amber-700 px-2 py-1 text-xs font-semibold">‚òÖ Favorite</span>
            {% else %}
            <span class="text-slate-500">‚Äî</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="8" class="py-4 px-4 text-slate-500">No parts have been added yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    function levenshtein(a, b) {
      if (a === b) return 0;
      if (!a.length) return b.length;
      if (!b.length) return a.length;

      const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
      for (let j = 0; j <= a.length; j += 1) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= b.length; i += 1) {
        for (let j = 1; j <= a.length; j += 1) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1,
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }

    function normalizeSortValue(value) {
      const numeric = parseFloat((value || "").replace(/,/g, ""));
      return Number.isNaN(numeric) ? (value || "").toLowerCase() : numeric;
    }

    function setupInteractiveTable(tableId, searchId) {
      const table = document.getElementById(tableId);
      const searchInput = document.getElementById(searchId);
      if (!table) return;
      const tbody = table.querySelector("tbody");
      const headers = Array.from(table.querySelectorAll("th[data-sort-index]"));

      let sortState = { key: null, direction: 1 };

      function computeMatchScore(text, query) {
        if (!query) return 0;
        if (text === query) return 0;
        if (text.startsWith(query)) return 1;
        if (text.includes(query)) {
          return 2 + text.indexOf(query) / Math.max(text.length, 1);
        }
        const distance = levenshtein(text, query);
        return 3 + distance / Math.max(query.length, text.length, 1);
      }

      function applyIndicators() {
        headers.forEach((th) => {
          const indicator = th.querySelector(".sort-indicator");
          if (!indicator) return;
          const idx = Number(th.dataset.sortIndex);
          if (sortState.key === idx) {
            indicator.textContent = sortState.direction === 1 ? "‚ñ≤" : "‚ñº";
          } else {
            indicator.textContent = "‚áÖ";
          }
        });
      }

      function getCellValue(row, index) {
        const cell = row.cells[index];
        return cell ? (cell.dataset.sortValue || cell.textContent.trim()) : "";
      }

      function applySort(columnIndex = sortState.key, direction = sortState.direction) {
        const query = (searchInput?.value || "").trim();
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (row) => row.style.display !== "none",
        );

        const sorted = rows.sort((a, b) => {
          if (columnIndex === null && query) {
            return (
              parseFloat(a.dataset.score) - parseFloat(b.dataset.score)
            ) || a.innerText.localeCompare(b.innerText);
          }

          const aVal = normalizeSortValue(getCellValue(a, columnIndex));
          const bVal = normalizeSortValue(getCellValue(b, columnIndex));

          if (typeof aVal === "number" && typeof bVal === "number") {
            const numericOrder = (aVal - bVal) * direction;
            if (numericOrder !== 0) return numericOrder;
            return a.innerText.localeCompare(b.innerText);
          }

          const textOrder = aVal.toString().localeCompare(bVal.toString()) * direction;
          if (textOrder !== 0) return textOrder;
          return parseFloat(a.dataset.score) - parseFloat(b.dataset.score);
        });

        sorted.forEach((row) => tbody.appendChild(row));
      }

      function refresh() {
        const query = (searchInput?.value || "").trim().toLowerCase();
        Array.from(tbody.querySelectorAll("tr")).forEach((row) => {
          const cellTexts = Array.from(row.cells).map((cell) =>
            cell.textContent.trim().toLowerCase(),
          );
          const combined = cellTexts.join(" ");
          if (!query) {
            row.dataset.score = "0";
            row.style.display = "";
            return;
          }

          const scores = cellTexts.map((text) => computeMatchScore(text, query));
          const bestScore = Math.min(...scores);
          const related = combined.includes(query) || bestScore < 3.8;

          row.style.display = related ? "" : "none";
          row.dataset.score = related ? String(bestScore) : "9999";
        });
        applySort();
        applyIndicators();
      }

      headers.forEach((th) => {
        th.addEventListener("click", () => {
          const col = Number(th.dataset.sortIndex);
          sortState = {
            key: col,
            direction: sortState.key === col ? sortState.direction * -1 : 1,
          };
          applySort(sortState.key, sortState.direction);
          applyIndicators();
        });
      });

      searchInput?.addEventListener("input", refresh);
      refresh();
    }

    setupInteractiveTable("parts-table", "parts-search");
  })();
</script>
{% endblock %}
