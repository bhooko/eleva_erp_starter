{% extends "base.html" %}
{% block title %}Purchase ¬∑ Parts{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Inventory</p>
      <h1 class="text-2xl font-semibold">Parts</h1>
      <p class="text-sm text-slate-600">Manage part master data and sync updates from Odoo exports.</p>
    </div>
    <div class="flex items-center gap-3">
      <label for="upload-products" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">Upload Parts (Odoo)</label>
    </div>
  </div>

  <div class="relative">
    <input type="checkbox" id="upload-products" class="hidden peer" />
    <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('upload-products').checked=false;"></div>
    <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
        <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
          <div>
            <p class="text-xs text-slate-500 uppercase">Part import</p>
            <h2 class="text-lg font-semibold">Upload Parts (Odoo)</h2>
          </div>
          <button class="text-slate-500" type="button" onclick="document.getElementById('upload-products').checked=false;">‚úï</button>
        </div>
        <form method="POST" action="{{ url_for('products_upload') }}" enctype="multipart/form-data" class="p-5 space-y-4">
          {{ csrf_field() }}
          <p class="text-sm text-slate-600">Upload the <span class="font-semibold">Odoo Products.xlsx</span> export (.xlsx or .csv). The sheet must include columns: Name, Sales Price, Cost, Unit of Measure, Purchase Unit, Quantity On Hand.</p>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Upload file</span>
            <input type="file" name="product_upload_file" accept=".xlsx,.csv" required class="w-full rounded-lg border-slate-200" />
          </label>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('upload-products').checked=false;">Cancel</button>
            <button type="submit" class="px-5 py-2 rounded-lg bg-slate-900 text-white shadow hover:shadow-lg hover:scale-[1.02] transition">Upload Parts</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <label class="relative w-full md:flex-1">
      <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">üîç</span>
      <input
        id="parts-search"
        type="search"
        placeholder="Search parts by name, unit, or pricing"
        class="w-full rounded-xl border border-slate-200 pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/50"
      />
    </label>
    <p class="text-xs text-slate-500">Type to filter results; click a column header to sort.</p>
  </div>

  <div class="grid gap-6 lg:grid-cols-[7fr_5fr] items-start">
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
      <table id="parts-table" class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="0">
              <span class="inline-flex items-center gap-1">Name <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="1">
              <span class="inline-flex items-center gap-1">Sales Price <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="2">
              <span class="inline-flex items-center gap-1">Cost <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="3">
              <span class="inline-flex items-center gap-1">UoM <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="4">
              <span class="inline-flex items-center gap-1">Purchase UoM <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="5">
              <span class="inline-flex items-center gap-1">Qty on Hand <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="6">
              <span class="inline-flex items-center gap-1">Forecast Qty <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
            <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="7">
              <span class="inline-flex items-center gap-1">Favorite <span class="sort-indicator text-xs">‚áÖ</span></span>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for product in products %}
          <tr data-product-id="{{ product.id }}" class="hover:bg-amber-50/60 transition">
            <td class="py-3 px-4 font-semibold text-slate-800">{{ product.name }}</td>
            <td class="py-3 px-4">{{ (product.sale_price or 0) | round(2) }}</td>
            <td class="py-3 px-4">{{ (product.cost or 0) | round(2) }}</td>
            <td class="py-3 px-4">{{ product.uom or '‚Äî' }}</td>
            <td class="py-3 px-4">{{ product.purchase_uom or '‚Äî' }}</td>
            <td class="py-3 px-4">{{ (product.qty_on_hand or 0) | round(2) }}</td>
            <td class="py-3 px-4">{{ (product.forecast_qty or 0) | round(2) }}</td>
            <td class="py-3 px-4">
              {% if product.is_favorite %}
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 text-amber-700 px-2 py-1 text-xs font-semibold">‚òÖ Favorite</span>
              {% else %}
              <span class="text-slate-500">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8" class="py-4 px-4 text-slate-500">No parts have been added yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/90 text-slate-50 shadow-lg p-6 sticky top-6">
      <div id="part-detail-empty" class="text-center py-10 space-y-2">
        <p class="text-lg font-semibold text-slate-100">Select a part</p>
        <p class="text-sm text-slate-400">Click any row to view or edit specifications, vendors, and notes.</p>
      </div>
      <form id="part-detail-form" class="hidden space-y-5" method="POST" data-update-url-template="{{ url_for('purchase_parts_update', product_id=0) }}">
        {{ csrf_field() }}
        <div class="flex items-start justify-between gap-3">
          <div class="space-y-1">
            <p class="text-xs uppercase tracking-wide text-amber-200">Part overview</p>
            <h3 id="part-title" class="text-xl font-semibold text-white">‚Äî</h3>
            <p id="part-meta" class="text-sm text-slate-300">‚Äî</p>
          </div>
          <div class="text-right space-y-1">
            <span id="part-status-pill" class="inline-flex items-center rounded-full bg-emerald-500/15 text-emerald-200 text-xs font-semibold px-3 py-1">Active</span>
            <div class="text-xs text-slate-400">Primary vendor</div>
            <div id="primary-vendor-chip" class="text-sm font-semibold text-white">‚Äî</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Name</span>
            <input name="name" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">UoM</span>
            <input name="uom" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Sales Price</span>
            <input name="sale_price" type="number" step="0.01" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Cost</span>
            <input name="cost" type="number" step="0.01" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Purchase UoM</span>
            <input name="purchase_uom" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Qty on Hand</span>
            <input name="qty_on_hand" type="number" step="0.01" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Forecast Qty</span>
            <input name="forecast_qty" type="number" step="0.01" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </label>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Primary vendor</span>
            <select name="primary_vendor" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400">
              <option value="">No primary vendor</option>
              {% for vendor in vendors %}
              <option value="{{ vendor.name }}">{{ vendor.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Linked vendors</span>
            <textarea name="linked_vendors" rows="2" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="Comma separated list"></textarea>
          </label>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Specifications</span>
            <textarea name="specifications" rows="3" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400"></textarea>
          </label>
          <label class="space-y-1 block">
            <span class="text-xs text-slate-400">Other details</span>
            <textarea name="notes" rows="3" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-400"></textarea>
          </label>
        </div>

        <div class="space-y-3">
          <div class="flex flex-wrap items-center gap-4 text-sm">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="is_favorite" class="rounded border-slate-700 bg-slate-800" />
              <span class="text-slate-200">Mark as favorite</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="is_active" class="rounded border-slate-700 bg-slate-800" />
              <span class="text-slate-200">Active</span>
            </label>
          </div>
          <div>
            <p class="text-xs text-slate-400 mb-1">Linked vendors</p>
            <div id="linked-vendors-list" class="flex flex-wrap gap-2 text-xs"></div>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <p class="text-xs text-slate-400">Update specifications, vendors, and stock numbers, then save your changes.</p>
          <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-amber-400 text-slate-900 font-semibold rounded-lg shadow hover:shadow-lg hover:scale-[1.01] transition">
            Save changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    function levenshtein(a, b) {
      if (a === b) return 0;
      if (!a.length) return b.length;
      if (!b.length) return a.length;

      const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
      for (let j = 0; j <= a.length; j += 1) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= b.length; i += 1) {
        for (let j = 1; j <= a.length; j += 1) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1,
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }

    function normalizeSortValue(value) {
      const numeric = parseFloat((value || "").replace(/,/g, ""));
      return Number.isNaN(numeric) ? (value || "").toLowerCase() : numeric;
    }

    function setupInteractiveTable(tableId, searchId) {
      const table = document.getElementById(tableId);
      const searchInput = document.getElementById(searchId);
      if (!table) return;
      const tbody = table.querySelector("tbody");
      const headers = Array.from(table.querySelectorAll("th[data-sort-index]"));

      const params = new URLSearchParams(window.location.search);
      const initialItemCode = params.get("item_code");
      if (initialItemCode && searchInput) {
        searchInput.value = initialItemCode;
      }

      let sortState = { key: null, direction: 1 };

      function computeTokenScore(text, token) {
        if (!token) return 0;
        if (text === token) return 0;
        if (text.startsWith(token)) return 0.05;
        if (text.includes(token)) return 0.1 + text.indexOf(token) / Math.max(text.length, 1);

        const distance = levenshtein(text, token);
        return distance / Math.max(token.length, text.length, 1);
      }

      function applyIndicators() {
        headers.forEach((th) => {
          const indicator = th.querySelector(".sort-indicator");
          if (!indicator) return;
          const idx = Number(th.dataset.sortIndex);
          if (sortState.key === idx) {
            indicator.textContent = sortState.direction === 1 ? "‚ñ≤" : "‚ñº";
          } else {
            indicator.textContent = "‚áÖ";
          }
        });
      }

      function getCellValue(row, index) {
        const cell = row.cells[index];
        return cell ? (cell.dataset.sortValue || cell.textContent.trim()) : "";
      }

      function applySort(columnIndex = sortState.key, direction = sortState.direction) {
        const query = (searchInput?.value || "").trim();
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (row) => row.style.display !== "none",
        );

        const sorted = rows.sort((a, b) => {
          if (columnIndex === null && query) {
            return (
              parseFloat(a.dataset.score) - parseFloat(b.dataset.score)
            ) || a.innerText.localeCompare(b.innerText);
          }

          const aVal = normalizeSortValue(getCellValue(a, columnIndex));
          const bVal = normalizeSortValue(getCellValue(b, columnIndex));

          if (typeof aVal === "number" && typeof bVal === "number") {
            const numericOrder = (aVal - bVal) * direction;
            if (numericOrder !== 0) return numericOrder;
            return a.innerText.localeCompare(b.innerText);
          }

          const textOrder = aVal.toString().localeCompare(bVal.toString()) * direction;
          if (textOrder !== 0) return textOrder;
          return parseFloat(a.dataset.score) - parseFloat(b.dataset.score);
        });

        sorted.forEach((row) => tbody.appendChild(row));
      }

      function refresh() {
        const query = (searchInput?.value || "").trim().toLowerCase();
        const tokens = query.split(/\s+/).filter(Boolean);

        Array.from(tbody.querySelectorAll("tr")).forEach((row) => {
          const cellTexts = Array.from(row.cells).map((cell) =>
            cell.textContent.trim().toLowerCase(),
          );

          if (!tokens.length) {
            row.dataset.score = "0";
            row.style.display = "";
            return;
          }

          const tokenScores = tokens.map((token) => {
            const cellScores = cellTexts.map((text) =>
              computeTokenScore(text, token),
            );
            return Math.min(...cellScores);
          });

          const averageScore =
            tokenScores.reduce((sum, score) => sum + score, 0) /
            tokenScores.length;

          const related = tokenScores.every((score) => score <= 0.75);

          row.style.display = related ? "" : "none";
          row.dataset.score = related ? String(averageScore) : "9999";
        });
        applySort();
        applyIndicators();
      }

      headers.forEach((th) => {
        th.addEventListener("click", () => {
          const col = Number(th.dataset.sortIndex);
          sortState = {
            key: col,
            direction: sortState.key === col ? sortState.direction * -1 : 1,
          };
          applySort(sortState.key, sortState.direction);
          applyIndicators();
        });
      });

      searchInput?.addEventListener("input", refresh);
      refresh();
    }

    setupInteractiveTable("parts-table", "parts-search");

    const productsDataset = {{ products_payload | default([], true) | tojson }};
    const detailForm = document.getElementById("part-detail-form");
    const emptyState = document.getElementById("part-detail-empty");
    const linkedVendorsList = document.getElementById("linked-vendors-list");
    const primaryVendorChip = document.getElementById("primary-vendor-chip");
    const partTitle = document.getElementById("part-title");
    const partMeta = document.getElementById("part-meta");
    const statusPill = document.getElementById("part-status-pill");
    const productMap = new Map(productsDataset.map((item) => [String(item.id), item]));
    const updateUrlTemplate = detailForm?.dataset.updateUrlTemplate || "";

    function setFieldValue(name, value) {
      if (!detailForm) return;
      const field = detailForm.querySelector(`[name="${name}"]`);
      if (!field) return;
      if (field.type === "checkbox") {
        field.checked = Boolean(value);
      } else if (field.tagName === "SELECT") {
        const optionExists = Array.from(field.options).some((opt) => opt.value === (value || ""));
        if (!optionExists && value) {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          field.appendChild(option);
        }
        field.value = value || "";
      } else {
        field.value = value ?? "";
      }
    }

    function formatStockMeta(product) {
      const meta = [];
      if (product.uom) meta.push(product.uom);
      if (product.purchase_uom) meta.push(`Purchase UoM: ${product.purchase_uom}`);
      meta.push(`On hand: ${(product.qty_on_hand ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}`);
      meta.push(`Forecast: ${(product.forecast_qty ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}`);
      return meta.join(" ‚Ä¢ ");
    }

    function renderLinkedVendors(vendorsText) {
      if (!linkedVendorsList) return;
      linkedVendorsList.innerHTML = "";
      const names = (vendorsText || "")
        .split(",")
        .map((name) => name.trim())
        .filter(Boolean);

      if (!names.length) {
        const empty = document.createElement("span");
        empty.className = "text-slate-400";
        empty.textContent = "No linked vendors";
        linkedVendorsList.appendChild(empty);
        return;
      }

      names.forEach((name) => {
        const chip = document.createElement("span");
        chip.className = "inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-1 text-amber-100";
        chip.textContent = name;
        linkedVendorsList.appendChild(chip);
      });
    }

    function updateStatusPill(isActive, isFavorite) {
      if (!statusPill) return;
      statusPill.textContent = isActive ? "Active" : "Inactive";
      statusPill.className = `inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${
        isActive ? "bg-emerald-500/15 text-emerald-200" : "bg-slate-700 text-slate-200"
      } ${isFavorite ? "ring-2 ring-amber-300" : ""}`;
    }

    function showProductDetail(productId) {
      if (!detailForm || !emptyState) return;
      const product = productMap.get(String(productId));
      if (!product) return;

      emptyState.classList.add("hidden");
      detailForm.classList.remove("hidden");
      detailForm.action = updateUrlTemplate.replace("/0/update", `/${product.id}/update`);

      partTitle.textContent = product.name || "‚Äî";
      partMeta.textContent = formatStockMeta(product);
      updateStatusPill(product.is_active, product.is_favorite);

      const primaryVendor = product.primary_vendor || "No primary vendor selected";
      if (primaryVendorChip) {
        primaryVendorChip.textContent = primaryVendor;
        primaryVendorChip.className = `inline-flex items-center px-3 py-1 rounded-full text-sm ${
          product.primary_vendor ? "bg-amber-500/20 text-amber-100" : "bg-slate-800 text-slate-200"
        }`;
      }

      setFieldValue("name", product.name);
      setFieldValue("uom", product.uom);
      setFieldValue("sale_price", product.sale_price ?? "");
      setFieldValue("cost", product.cost ?? "");
      setFieldValue("purchase_uom", product.purchase_uom);
      setFieldValue("qty_on_hand", product.qty_on_hand ?? "");
      setFieldValue("forecast_qty", product.forecast_qty ?? "");
      setFieldValue("primary_vendor", product.primary_vendor);
      setFieldValue("linked_vendors", product.linked_vendors);
      setFieldValue("specifications", product.specifications);
      setFieldValue("notes", product.notes);
      setFieldValue("is_favorite", product.is_favorite);
      setFieldValue("is_active", product.is_active);

      renderLinkedVendors(product.linked_vendors);

      document.querySelectorAll("#parts-table tbody tr").forEach((row) => {
        row.classList.toggle(
          "outline outline-amber-300/80 outline-2",
          row.dataset.productId === String(productId),
        );
      });
    }

    document.querySelectorAll("#parts-table tbody tr").forEach((row) => {
      row.classList.add("cursor-pointer");
      row.addEventListener("click", () => {
        showProductDetail(row.dataset.productId);
      });
    });
  })();
</script>
{% endblock %}
