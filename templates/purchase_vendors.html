{% extends "base.html" %}
{% block title %}Purchase ¬∑ Vendors{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase text-slate-500">Purchase</p>
      <h1 class="text-2xl font-semibold">Vendors</h1>
      <p class="text-sm text-slate-600">Keep track of approved vendors for purchasing.</p>
    </div>
    <div class="flex items-center gap-3">
      <label for="upload-vendors" class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">Upload Vendors (Odoo)</label>
      <label for="new-vendor" class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">+ Add Vendor</label>
    </div>
  </div>

  <div class="relative">
    <input type="checkbox" id="upload-vendors" class="hidden peer" />
    <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('upload-vendors').checked=false;"></div>
    <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
        <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
          <div>
            <p class="text-xs text-slate-500 uppercase">Vendor import</p>
            <h2 class="text-lg font-semibold">Upload Vendors (Odoo)</h2>
          </div>
          <button class="text-slate-500" type="button" onclick="document.getElementById('upload-vendors').checked=false;">‚úï</button>
        </div>
        <form method="POST" action="{{ url_for('purchase_vendors_upload') }}" enctype="multipart/form-data" class="p-5 space-y-4">
          {{ csrf_field() }}
          <p class="text-sm text-slate-600">Upload the <span class="font-semibold">Odoo Vendors.xlsx</span> export (.xlsx or .csv). The sheet must include columns: Complete Name, Activities, City, Country, Email, Phone, Salesperson.</p>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Upload file</span>
            <input type="file" name="vendor_upload_file" accept=".xlsx,.csv" required class="w-full rounded-lg border-slate-200" />
          </label>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('upload-vendors').checked=false;">Cancel</button>
            <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Upload Vendors</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <input type="checkbox" id="new-vendor" class="hidden peer" />
  <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('new-vendor').checked=false;"></div>
  <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
      <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
        <div>
          <p class="text-xs text-slate-500 uppercase">Vendor registry</p>
          <h2 class="text-lg font-semibold">Add vendor</h2>
        </div>
        <button class="text-slate-500" onclick="document.getElementById('new-vendor').checked=false;">‚úï</button>
      </div>
      <form method="POST" class="p-5 space-y-4">
        {{ csrf_field() }}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Vendor name</span>
            <input type="text" name="name" class="w-full rounded-lg border-slate-200" required />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Contact person</span>
            <input type="text" name="contact_person" class="w-full rounded-lg border-slate-200" />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Phone</span>
            <input type="text" name="phone" class="w-full rounded-lg border-slate-200" />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Email</span>
            <input type="email" name="email" class="w-full rounded-lg border-slate-200" />
          </label>
        </div>
        <label class="space-y-1 block">
          <span class="text-sm text-slate-600">Address</span>
          <textarea name="address" rows="2" class="w-full rounded-lg border-slate-200"></textarea>
        </label>
        <label class="space-y-1 block">
          <span class="text-sm text-slate-600">Notes</span>
          <textarea name="notes" rows="2" class="w-full rounded-lg border-slate-200"></textarea>
        </label>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('new-vendor').checked=false;">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Save Vendor</button>
        </div>
      </form>
    </div>
  </div>

  <input type="checkbox" id="edit-vendor" class="hidden peer" />
  <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('edit-vendor').checked=false;"></div>
  <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
      <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
        <div>
          <p class="text-xs text-slate-500 uppercase">Vendor registry</p>
          <h2 class="text-lg font-semibold">Edit vendor</h2>
        </div>
        <button class="text-slate-500" type="button" onclick="document.getElementById('edit-vendor').checked=false;">‚úï</button>
      </div>
      <form method="POST" id="editVendorForm" class="p-5 space-y-4">
        {{ csrf_field() }}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Vendor name</span>
            <input type="text" name="name" id="editVendorName" class="w-full rounded-lg border-slate-200" required />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Contact person</span>
            <input type="text" name="contact_person" id="editVendorContact" class="w-full rounded-lg border-slate-200" />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Phone</span>
            <input type="text" name="phone" id="editVendorPhone" class="w-full rounded-lg border-slate-200" />
          </label>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Email</span>
            <input type="email" name="email" id="editVendorEmail" class="w-full rounded-lg border-slate-200" />
          </label>
        </div>
        <label class="space-y-1 block">
          <span class="text-sm text-slate-600">Address</span>
          <textarea name="address" id="editVendorAddress" rows="2" class="w-full rounded-lg border-slate-200"></textarea>
        </label>
        <label class="space-y-1 block">
          <span class="text-sm text-slate-600">Notes</span>
          <textarea name="notes" id="editVendorNotes" rows="2" class="w-full rounded-lg border-slate-200"></textarea>
        </label>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('edit-vendor').checked=false;">Cancel</button>
          <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Update Vendor</button>
        </div>
      </form>
    </div>
  </div>

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <label class="relative w-full md:max-w-sm">
      <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">üîç</span>
      <input
        id="vendors-search"
        type="search"
        placeholder="Search vendors by name or address"
        class="w-full rounded-xl border border-slate-200 pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500/60"
      />
    </label>
    <p class="text-xs text-slate-500">Filter vendors and click a column heading to sort.</p>
  </div>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
    <table id="vendors-table" class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="0">
            <span class="inline-flex items-center gap-1">Vendor <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 cursor-pointer select-none" data-sort-index="1">
            <span class="inline-flex items-center gap-1">Address <span class="sort-indicator text-xs">‚áÖ</span></span>
          </th>
          <th class="py-3 px-4 text-center">Edit</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for vendor in vendors %}
        <tr>
          <td class="py-3 px-4 font-semibold text-slate-800">
            <a href="{{ url_for('purchase_vendor_detail', vendor_id=vendor.id) }}" class="clickable-text">{{ vendor.name }}</a>
          </td>
          <td class="py-3 px-4">{{ vendor.address or '‚Äî' }}</td>
          <td class="py-3 px-4 text-center">
            <button
              type="button"
              class="vendor-edit-button inline-flex items-center justify-center h-8 w-8 rounded-full border border-slate-200 text-slate-600 hover:text-slate-900 hover:border-slate-300 hover:bg-slate-50 transition"
              data-id="{{ vendor.id }}"
              data-name="{{ vendor.name|e }}"
              data-address="{{ vendor.address|default('', true)|e }}"
              data-contact="{{ vendor.contact_person|default('', true)|e }}"
              data-phone="{{ vendor.phone|default('', true)|e }}"
              data-email="{{ vendor.email|default('', true)|e }}"
              data-notes="{{ vendor.notes|default('', true)|e }}"
              data-edit-url="{{ url_for('purchase_vendor_edit', vendor_id=vendor.id) }}"
              aria-label="Edit vendor"
            >
              ‚úé
            </button>
          </td>
        </tr>
        {% else %}
        <tr data-empty-row="true"><td colspan="3" class="py-4 px-4 text-slate-500">No vendors have been added yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    function levenshtein(a, b) {
      if (a === b) return 0;
      if (!a.length) return b.length;
      if (!b.length) return a.length;

      const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
      for (let j = 0; j <= a.length; j += 1) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= b.length; i += 1) {
        for (let j = 1; j <= a.length; j += 1) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1,
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }

    function normalizeSortValue(value) {
      const numeric = parseFloat((value || "").replace(/,/g, ""));
      return Number.isNaN(numeric) ? (value || "").toLowerCase() : numeric;
    }

    function setupInteractiveTable(tableId, searchId) {
      const table = document.getElementById(tableId);
      const searchInput = document.getElementById(searchId);
      if (!table) return;
      const tbody = table.querySelector("tbody");
      const headers = Array.from(table.querySelectorAll("th[data-sort-index]"));
      const searchableIndexes = [0, 1];

      let sortState = { key: null, direction: 1 };

      function computeMatchScore(text, query) {
        if (!query) return 0;
        if (text === query) return 0;
        if (text.startsWith(query)) return 1;
        if (text.includes(query)) {
          return 2 + text.indexOf(query) / Math.max(text.length, 1);
        }
        const distance = levenshtein(text, query);
        return 3 + distance / Math.max(query.length, text.length, 1);
      }

      function applyIndicators() {
        headers.forEach((th) => {
          const indicator = th.querySelector(".sort-indicator");
          if (!indicator) return;
          const idx = Number(th.dataset.sortIndex);
          if (sortState.key === idx) {
            indicator.textContent = sortState.direction === 1 ? "‚ñ≤" : "‚ñº";
          } else {
            indicator.textContent = "‚áÖ";
          }
        });
      }

      function getCellValue(row, index) {
        const cell = row.cells[index];
        return cell ? (cell.dataset.sortValue || cell.textContent.trim()) : "";
      }

      function applySort(columnIndex = sortState.key, direction = sortState.direction) {
        const query = (searchInput?.value || "").trim();
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (row) => row.style.display !== "none" && !row.dataset.emptyRow,
        );

        const sorted = rows.sort((a, b) => {
          if (columnIndex === null && query) {
            return (
              parseFloat(a.dataset.score) - parseFloat(b.dataset.score)
            ) || a.innerText.localeCompare(b.innerText);
          }

          const aVal = normalizeSortValue(getCellValue(a, columnIndex));
          const bVal = normalizeSortValue(getCellValue(b, columnIndex));

          if (typeof aVal === "number" && typeof bVal === "number") {
            const numericOrder = (aVal - bVal) * direction;
            if (numericOrder !== 0) return numericOrder;
            return a.innerText.localeCompare(b.innerText);
          }

          const textOrder = aVal.toString().localeCompare(bVal.toString()) * direction;
          if (textOrder !== 0) return textOrder;
          return parseFloat(a.dataset.score) - parseFloat(b.dataset.score);
        });

        sorted.forEach((row) => tbody.appendChild(row));
      }

      function refresh() {
        const query = (searchInput?.value || "").trim().toLowerCase();
        Array.from(tbody.querySelectorAll("tr")).forEach((row) => {
          if (row.dataset.emptyRow) {
            row.dataset.score = "9999";
            row.style.display = query ? "none" : "";
            return;
          }

          const cellTexts = searchableIndexes.map((index) => {
            const cell = row.cells[index];
            return cell ? cell.textContent.trim().toLowerCase() : "";
          });
          const combined = cellTexts.join(" ");
          if (!query) {
            row.dataset.score = "0";
            row.style.display = "";
            return;
          }

          const scores = cellTexts.map((text) => computeMatchScore(text, query));
          const bestScore = Math.min(...scores);
          const related = combined.includes(query) || bestScore < 3.8;

          row.style.display = related ? "" : "none";
          row.dataset.score = related ? String(bestScore) : "9999";
        });
        applySort();
        applyIndicators();
      }

      headers.forEach((th) => {
        th.addEventListener("click", () => {
          const col = Number(th.dataset.sortIndex);
          sortState = {
            key: col,
            direction: sortState.key === col ? sortState.direction * -1 : 1,
          };
          applySort(sortState.key, sortState.direction);
          applyIndicators();
        });
      });

      searchInput?.addEventListener("input", refresh);
      refresh();
    }

    setupInteractiveTable("vendors-table", "vendors-search");

    const editToggle = document.getElementById("edit-vendor");
    const editForm = document.getElementById("editVendorForm");
    const editName = document.getElementById("editVendorName");
    const editContact = document.getElementById("editVendorContact");
    const editPhone = document.getElementById("editVendorPhone");
    const editEmail = document.getElementById("editVendorEmail");
    const editAddress = document.getElementById("editVendorAddress");
    const editNotes = document.getElementById("editVendorNotes");

    if (editToggle && editForm && editName) {
      document.querySelectorAll(".vendor-edit-button").forEach((button) => {
        button.addEventListener("click", () => {
          const vendorId = button.dataset.id;
          editForm.action =
            button.dataset.editUrl || `/purchase/vendors/${vendorId}/edit`;
          editName.value = button.dataset.name || "";
          if (editContact) editContact.value = button.dataset.contact || "";
          if (editPhone) editPhone.value = button.dataset.phone || "";
          if (editEmail) editEmail.value = button.dataset.email || "";
          if (editAddress) editAddress.value = button.dataset.address || "";
          if (editNotes) editNotes.value = button.dataset.notes || "";
          editToggle.checked = true;
        });
      });
    }
  })();
</script>
{% endblock %}
