{% extends "base.html" %}
{% block title %}Eleva ERP – QC Task Detail{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Task – {{ work.display_title }}</h2>
        <p class="text-sm text-slate-400">Form template: {{ work.template.name if work.template else '—' }}</p>
        {% if work.description %}
          <p class="text-xs text-slate-400 mt-1">{{ work.description }}</p>
        {% endif %}
      </div>
      <div class="ml-auto flex gap-2">
        {% if work.status == 'Open' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='start') }}">
            {{ csrf_field() }}
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Mark In Progress</button>
          </form>
        {% elif work.status == 'In Progress' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='close') }}">
            {{ csrf_field() }}
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Mark Complete</button>
          </form>
        {% elif work.status == 'Blocked' %}
          <span class="px-3 py-1.5 rounded-xl bg-amber-500/20 text-amber-100 border border-amber-400/40">Waiting on dependency</span>
        {% elif work.status == 'Closed' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='reopen') }}">
            {{ csrf_field() }}
            <button class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600">Reopen</button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4 text-sm">
      <div class="space-y-1">
        <p class="text-slate-300"><span class="text-slate-400">Client:</span> {{ work.client_name or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Address:</span> {{ work.address or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Stage:</span> {{ work.stage or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Template step:</span> {{ work.template_task.name if work.template_task else '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Milestone:</span> {{ work.milestone or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Project:</span>
          {% if work.project %}
            <a href="{{ url_for('project_detail', project_id=work.project.id) }}" class="text-emerald-300 hover:text-emerald-200">{{ work.project.name }}</a>
          {% else %}
            —
          {% endif %}
        </p>
        <p class="text-slate-300"><span class="text-slate-400">Dependencies:</span>
          {% set dependencies = work.dependencies %}
          {% if dependencies %}
            {% for dependency in dependencies %}
              <a href="{{ url_for('qc_work_detail', work_id=dependency.id) }}" class="text-amber-300 hover:text-amber-200">{{ dependency.display_title }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            None
          {% endif %}
        </p>
      </div>
      <div class="space-y-1">
        <p class="text-slate-300"><span class="text-slate-400">Status:</span> {{ work.status }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Planned start:</span> {{ work.planned_start_date.strftime('%Y-%m-%d') if work.planned_start_date else '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Planned duration:</span>
          {% if work.planned_duration_days is not none %}
            {{ work.planned_duration_days }} day{{ '' if work.planned_duration_days == 1 else 's' }}
          {% else %}
            —
          {% endif %}
        </p>
        <p class="text-slate-300"><span class="text-slate-400">Due:</span>
          {% if work.due_date %}
            {{ work.due_date.strftime('%Y-%m-%d') }}
          {% elif work.planned_due_date %}
            {{ work.planned_due_date.strftime('%Y-%m-%d') }}
          {% else %}
            —
          {% endif %}
        </p>
        <p class="text-slate-300"><span class="text-slate-400">Assigned to:</span> {{ work.assignee.display_name if work.assignee else 'Unassigned' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Created:</span> {{ work.created_at.strftime('%Y-%m-%d') }}</p>
      </div>
    </div>

    <form method="post" action="{{ url_for('qc_work_assign', work_id=work.id) }}" class="mt-4 flex flex-wrap items-center gap-3 text-sm">
      {{ csrf_field() }}
      <label class="text-slate-400" for="assigned_to">Update assignment</label>
      <select id="assigned_to" name="assigned_to" class="px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700">
        <option value="">Unassigned</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if work.assigned_to == u.id %}selected{% endif %}>{{ u.display_name }}</option>
        {% endfor %}
      </select>
      <button class="px-3 py-1.5 rounded-xl bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60">Save</button>
    </form>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2" role="tablist" aria-label="Task collaboration tabs">
        <button type="button" class="px-3 py-1.5 rounded-xl border border-emerald-500/60 bg-emerald-500/10 text-xs text-emerald-200" data-tab-button data-tab="discussion">Discussion ({{ comments|length }})</button>
        <button type="button" class="px-3 py-1.5 rounded-xl border border-slate-700 bg-slate-900/70 text-xs text-slate-200 hover:text-emerald-200" data-tab-button data-tab="attachments">Attachments ({{ attachments|length }})</button>
        <button type="button" class="px-3 py-1.5 rounded-xl border border-slate-700 bg-slate-900/70 text-xs text-slate-200 hover:text-emerald-200" data-tab-button data-tab="submissions">Submissions ({{ submissions|length }})</button>
        <button type="button" class="px-3 py-1.5 rounded-xl border border-slate-700 bg-slate-900/70 text-xs text-slate-200 hover:text-emerald-200" data-tab-button data-tab="activity">Activity ({{ logs|length }})</button>
      </div>
      <a href="{{ url_for('forms_fill', form_id=work.template_id, work_id=work.id) }}" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm" data-tab-action="submissions">+ New Submission</a>
    </div>

    <div class="mt-6 space-y-6">
      <div data-tab-panel="discussion" class="motion-panel is-active">
        <form method="post" action="{{ url_for('qc_work_comment', work_id=work.id) }}" enctype="multipart/form-data" class="space-y-3">
          {{ csrf_field() }}
          <textarea name="body" rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="Add an update, note or instruction..."></textarea>
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <input type="file" name="attachments" multiple class="text-xs text-slate-400" />
            <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Post update</button>
          </div>
        </form>

        <div class="mt-6 space-y-4">
          {% for c in comments %}
            <div class="border border-slate-800 rounded-2xl bg-slate-950/40 p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-100">{{ c.author.username if c.author else 'Unknown' }}</div>
                <div class="text-xs text-slate-400">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
              {% if c.body %}
                <p class="text-sm text-slate-200 mt-2 whitespace-pre-line">{{ c.body }}</p>
              {% endif %}
              {% if c.attachments %}
                <div class="mt-3">
                  <p class="text-xs uppercase text-slate-500 mb-1">Attachments</p>
                  <div class="flex flex-wrap gap-2">
                    {% for attachment in c.attachments %}
                      {% set rel = attachment.web_path if attachment.web_path is defined else (attachment.path.split('static/', 1)[1] if 'static/' in attachment.path else attachment.path) %}
                      <a href="{{ url_for('static', filename=rel) }}" target="_blank" class="px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 text-xs text-slate-200 hover:bg-slate-700/60">
                        {{ attachment.name }}
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% else %}
            <p class="text-sm text-slate-400">No updates yet. Start the conversation above.</p>
          {% endfor %}
        </div>
      </div>

      <div data-tab-panel="attachments" class="motion-panel hidden">
        {% if attachments %}
          <ul class="space-y-3">
            {% for item in attachments %}
              <li class="flex flex-wrap items-start justify-between gap-3 rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
                <div class="space-y-1">
                  <div class="text-sm font-semibold text-slate-100">{{ item.name }}</div>
                  <div class="text-xs text-slate-400">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }} · {{ item.author }}</div>
                  {% if item.body %}
                    <p class="text-xs text-slate-300">{{ item.body }}</p>
                  {% endif %}
                </div>
                {% if item.web_path %}
                  <a href="{{ url_for('static', filename=item.web_path) }}" target="_blank" class="px-3 py-1.5 rounded-xl border border-slate-700 text-xs text-slate-200 hover:bg-slate-800/60">Open</a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-sm text-slate-400">No attachments have been shared yet.</p>
        {% endif %}
      </div>

      <div data-tab-panel="submissions" class="motion-panel hidden">
        {% if submissions|length == 0 %}
          <p class="text-slate-400 text-sm">No submissions yet.</p>
        {% else %}
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-400">
                <tr>
                  <th class="text-left py-2 pr-3">Submitted by</th>
                  <th class="text-left py-2 pr-3">Date</th>
                  <th class="text-left py-2 pr-3">Attachments</th>
                  <th class="text-left py-2">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                {% for s in submissions %}
                  <tr>
                    <td class="py-2 pr-3">{{ s.user.username if s.user else '—' }}</td>
                    <td class="py-2 pr-3">{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="py-2 pr-3">{{ s.photo_count }} photos / {{ s.video_count }} videos</td>
                    <td class="py-2">
                      <a href="{{ url_for('submission_view', sub_id=s.id) }}" class="px-3 py-1.5 rounded-xl bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60">View</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>

      <div data-tab-panel="activity" class="motion-panel hidden">
        {% if logs|length == 0 %}
          <p class="text-slate-400 text-sm">No activity recorded yet.</p>
        {% else %}
          <ul class="space-y-4 text-sm">
            {% for log in logs %}
              <li class="border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
                <div class="flex items-center justify-between">
                  {% if log.action == 'status_changed' %}
                    <span class="font-semibold text-slate-100">Status changed to {{ log.to_status or log.details.to_status or 'Updated' }}</span>
                  {% else %}
                    <span class="font-semibold text-slate-100">{{ log.action.replace('_', ' ')|title }}</span>
                  {% endif %}
                  <span class="text-xs text-slate-400">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                <div class="text-xs text-slate-400 mt-1">
                  {% if log.actor %}
                    {% set actor_name = log.actor.display_name or log.actor.username %}
                    {% set role_label = 'Admin' if log.actor.is_admin else 'User' %}
                    by {{ role_label }} · {{ actor_name }}
                  {% else %}
                    System
                  {% endif %}
                </div>
                {% if log.action == 'status_changed' %}
                  <p class="mt-2 text-sm text-slate-200">From {{ log.from_status or 'Unknown' }} to {{ log.to_status or 'Unknown' }}.</p>
                {% elif log.action == 'comment_added' %}
                  {% if log.details.body %}
                    <p class="mt-2 text-sm text-slate-200 whitespace-pre-line">{{ log.details.body }}</p>
                  {% endif %}
                  {% if log.details.attachments %}
                    <p class="mt-2 text-xs text-slate-400">Attachments: {{ log.details.attachments|join(', ') }}</p>
                  {% endif %}
                {% elif log.details %}
                  <ul class="mt-2 space-y-1 text-xs text-slate-300">
                    {% for key, value in log.details.items() %}
                      <li><span class="text-slate-500 uppercase tracking-wide">{{ key }}:</span> {{ value }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const tabButtons = document.querySelectorAll('[data-tab-button]');
      const tabPanels = document.querySelectorAll('[data-tab-panel]');
      const submissionShortcut = document.querySelector('[data-tab-action="submissions"]');
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      const activateTab = (target) => {
        tabButtons.forEach((btn) => {
          const isActive = btn.getAttribute('data-tab') === target;
          btn.classList.toggle('border-emerald-500/60', isActive);
          btn.classList.toggle('bg-emerald-500/10', isActive);
          btn.classList.toggle('text-emerald-200', isActive);
          btn.classList.toggle('border-slate-700', !isActive);
          btn.classList.toggle('bg-slate-900/70', !isActive);
          btn.classList.toggle('text-slate-200', !isActive);
        });
        tabPanels.forEach((panel) => {
          const isActive = panel.getAttribute('data-tab-panel') === target;
          if (isActive) {
            panel.classList.remove('hidden');
            requestAnimationFrame(() => {
              panel.classList.add('is-active');
            });
          } else {
            panel.classList.remove('is-active');
            if (panel.classList.contains('hidden')) {
              return;
            }
            if (prefersReducedMotion) {
              panel.classList.add('hidden');
              return;
            }
            const handleTransition = (event) => {
              if (event.target !== panel || event.propertyName !== 'opacity') {
                return;
              }
              if (panel.classList.contains('is-active')) {
                return;
              }
              panel.classList.add('hidden');
            };
            panel.addEventListener('transitionend', handleTransition, { once: true });
          }
        });
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          activateTab(btn.getAttribute('data-tab'));
        });
      });

      if (submissionShortcut) {
        submissionShortcut.addEventListener('click', (event) => {
          if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
            return;
          }
          event.preventDefault();
          activateTab('submissions');
          const href = submissionShortcut.getAttribute('href');
          if (href) {
            window.location.href = href;
          }
        });
      }

      // Default to discussion tab on load.
      activateTab('discussion');
    })();
  </script>
{% endblock %}
