{% extends "base.html" %}
{% block title %}Eleva ERP – QC Task Detail{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">Task – {{ work.display_title }}</h2>
        <p class="text-sm text-slate-400">Form template: {{ work.template.name if work.template else '—' }}</p>
        {% if work.description %}
          <p class="text-xs text-slate-400 mt-1">{{ work.description }}</p>
        {% endif %}
      </div>
      <div class="ml-auto flex gap-2">
        {% if work.status == 'Open' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='start') }}">
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Start Task</button>
          </form>
        {% elif work.status == 'In Progress' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='close') }}">
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Mark Complete</button>
          </form>
        {% elif work.status == 'Blocked' %}
          <span class="px-3 py-1.5 rounded-xl bg-amber-500/20 text-amber-100 border border-amber-400/40">Waiting on dependency</span>
        {% elif work.status == 'Closed' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='reopen') }}">
            <button class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600">Reopen</button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4 text-sm">
      <div class="space-y-1">
        <p class="text-slate-300"><span class="text-slate-400">Client:</span> {{ work.client_name or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Address:</span> {{ work.address or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Stage:</span> {{ work.stage or '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Template step:</span> {{ work.template_task.name if work.template_task else '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Project:</span>
          {% if work.project %}
            <a href="{{ url_for('project_detail', project_id=work.project.id) }}" class="text-emerald-300 hover:text-emerald-200">
              {{ work.project.name }}
            </a>
          {% else %}
            —
          {% endif %}
        </p>
        <p class="text-slate-300"><span class="text-slate-400">Dependency:</span>
          {% if work.dependency %}
            <a href="{{ url_for('qc_work_detail', work_id=work.dependency.id) }}" class="text-amber-300 hover:text-amber-200">{{ work.dependency.display_title }}</a>
          {% else %}
            None
          {% endif %}
        </p>
      </div>
      <div class="space-y-1">
        <p class="text-slate-300"><span class="text-slate-400">Status:</span> {{ work.status }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Due:</span> {{ work.due_date.strftime('%Y-%m-%d') if work.due_date else '—' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Assigned to:</span> {{ work.assignee.display_name if work.assignee else 'Unassigned' }}</p>
        <p class="text-slate-300"><span class="text-slate-400">Created:</span> {{ work.created_at.strftime('%Y-%m-%d') }}</p>
      </div>
    </div>

    <form method="post" action="{{ url_for('qc_work_assign', work_id=work.id) }}" class="mt-4 flex flex-wrap items-center gap-3 text-sm">
      <label class="text-slate-400" for="assigned_to">Update assignment</label>
      <select id="assigned_to" name="assigned_to" class="px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700">
        <option value="">Unassigned</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if work.assigned_to == u.id %}selected{% endif %}>{{ u.display_name }}</option>
        {% endfor %}
      </select>
      <button class="px-3 py-1.5 rounded-xl bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60">Save</button>
    </form>
  </div>

  <div class="grid lg:grid-cols-[2fr_1fr] gap-6">
    <div class="space-y-6">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold text-slate-100">Discussion</h3>
          <span class="text-xs text-slate-400">{{ comments|length }} entries</span>
        </div>
        <form method="post" action="{{ url_for('qc_work_comment', work_id=work.id) }}" enctype="multipart/form-data" class="space-y-3">
          <textarea name="body" rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700" placeholder="Add an update, note or instruction..."></textarea>
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <input type="file" name="attachments" multiple class="text-xs text-slate-400" />
            <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Post update</button>
          </div>
        </form>

        <div class="mt-6 space-y-4">
          {% for c in comments %}
            <div class="border border-slate-800 rounded-2xl bg-slate-950/40 p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-100">{{ c.author.username if c.author else 'Unknown' }}</div>
                <div class="text-xs text-slate-400">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
              {% if c.body %}
                <p class="text-sm text-slate-200 mt-2 whitespace-pre-line">{{ c.body }}</p>
              {% endif %}
              {% if c.attachments %}
                <div class="mt-3">
                  <p class="text-xs uppercase text-slate-500 mb-1">Attachments</p>
                  <div class="flex flex-wrap gap-2">
                    {% for attachment in c.attachments %}
                      {% set rel = attachment.web_path if attachment.web_path is defined else (attachment.path.split('static/', 1)[1] if 'static/' in attachment.path else attachment.path) %}
                      <a href="{{ url_for('static', filename=rel) }}" target="_blank"
                         class="px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 text-xs text-slate-200 hover:bg-slate-700/60">
                        {{ attachment.name }}
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% else %}
            <p class="text-sm text-slate-400">No updates yet. Start the conversation above.</p>
          {% endfor %}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold text-slate-100">Submissions</h3>
          <a href="{{ url_for('forms_fill', form_id=work.template_id, work_id=work.id) }}" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">+ New Submission</a>
        </div>
        {% if submissions|length == 0 %}
          <p class="text-slate-400 text-sm">No submissions yet.</p>
        {% else %}
          <table class="w-full text-sm">
            <thead class="text-slate-400">
              <tr>
                <th class="text-left py-2 pr-3">Submitted by</th>
                <th class="text-left py-2 pr-3">Date</th>
                <th class="text-left py-2 pr-3">Attachments</th>
                <th class="text-left py-2">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
              {% for s in submissions %}
                <tr>
                  <td class="py-2 pr-3">{{ s.user.username if s.user else '—' }}</td>
                  <td class="py-2 pr-3">{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td class="py-2 pr-3">{{ s.photo_count }} photos / {{ s.video_count }} videos</td>
                  <td class="py-2">
                    <a href="{{ url_for('submission_view', sub_id=s.id) }}" class="px-3 py-1.5 rounded-xl bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60">View</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
      <h3 class="text-base font-semibold text-slate-100 mb-4">Activity Log</h3>
      {% if logs|length == 0 %}
        <p class="text-slate-400 text-sm">No activity recorded yet.</p>
      {% else %}
        <ul class="space-y-4 text-sm">
          {% for log in logs %}
            <li class="border border-slate-800 rounded-xl p-3 bg-slate-950/40">
              <div class="flex items-center justify-between">
                <span class="font-semibold text-slate-100">{{ log.action.replace('_', ' ')|title }}</span>
                <span class="text-xs text-slate-400">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
              </div>
              <div class="text-xs text-slate-400 mt-1">
                {% if log.actor %}by {{ log.actor.username }}{% else %}system{% endif %}
              </div>
              {% if log.details %}
                <ul class="mt-2 space-y-1 text-xs text-slate-300">
                  {% for key, value in log.details.items() %}
                    <li><span class="text-slate-500 uppercase tracking-wide">{{ key }}:</span> {{ value }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
