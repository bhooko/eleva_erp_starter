{% extends "base.html" %}
{% block title %}Eleva ERP – QC Work Detail{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-5">
    <div class="flex flex-wrap items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Work – {{ work.site_name }}</h2>
      <div class="flex gap-2">
        {% if work.status == 'Open' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='start') }}">
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Start Work</button>
          </form>
        {% elif work.status == 'In Progress' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='close') }}">
            <button class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-500">Mark Complete</button>
          </form>
        {% elif work.status == 'Closed' %}
          <form method="post" action="{{ url_for('qc_work_status', work_id=work.id, action='reopen') }}">
            <button class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600">Reopen</button>
          </form>
        {% endif %}
      </div>
    </div>

    <p class="text-sm text-slate-300 mb-2">
      Client: <strong>{{ work.client_name or '—' }}</strong> <br>
      Address: {{ work.address or '—' }}
    </p>

    <div class="flex flex-wrap items-center gap-3 text-sm">
      <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Stage: {{ work.stage or work.template.stage or '—' }}</span>
      <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Lift Type: {{ work.lift_type or work.template.lift_type or '—' }}</span>
      <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Template: {{ work.template.name }}</span>
      <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Status: {{ work.status }}</span>
      <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Created: {{ work.created_at.strftime('%Y-%m-%d') }}</span>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-base font-semibold">Submissions for this Work</h3>
      <a href="{{ url_for('forms_fill', form_id=work.template_id, work_id=work.id) }}"
         class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">+ New Submission</a>
    </div>

    {% if submissions|length == 0 %}
      <p class="text-slate-400 text-sm">No submissions yet.</p>
    {% else %}
      <table class="w-full text-sm">
        <thead class="text-slate-400">
          <tr>
            <th class="text-left py-2 pr-3">Submitted by</th>
            <th class="text-left py-2 pr-3">Date</th>
            <th class="text-left py-2 pr-3">Photos</th>
            <th class="text-left py-2 pr-3">Videos</th>
            <th class="text-left py-2">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800">
          {% for s in submissions %}
          <tr>
            <td class="py-2 pr-3">{{ s.user.username if s.user else '—' }}</td>
            <td class="py-2 pr-3">{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="py-2 pr-3">{{ (s.photos_json|length) if s.photos_json else 0 }}</td>
            <td class="py-2 pr-3">{{ (s.videos_json|length) if s.videos_json else 0 }}</td>
            <td class="py-2">
              <a href="{{ url_for('submission_view', sub_id=s.id) }}"
                 class="px-3 py-1.5 rounded-xl bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</div>
{% endblock %}
