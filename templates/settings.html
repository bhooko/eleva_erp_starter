{% extends "base.html" %}

{% block title %}Settings ¬∑ Eleva ERP{% endblock %}

{% block content %}
{% set active = active_tab or 'admin' %}
{% set tabs = [
  {"id": "admin", "label": "Admin", "description": "Manage workspace-level tools and controls."},
  {"id": "account", "label": "Account", "description": "Personalise your experience and manage your profile."},
  {"id": "display", "label": "Display", "description": "Switch colour schemes and tune visual comfort."},
  {"id": "modules", "label": "Module Settings", "description": "Configure workspace modules without touching code."}
] %}

<div class="space-y-6">
  <div>
    <h2 class="text-xl font-semibold text-slate-100">Settings</h2>
    <p class="mt-2 text-sm text-slate-400">Tailor how you and your team work in Eleva. Use the tabs below to switch between different areas.</p>
  </div>

  <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 shadow-lg shadow-black/20">
    <div class="flex flex-wrap gap-2 border-b border-slate-800/60 bg-slate-900/60 px-4 pt-4" role="tablist">
      {% for tab in tabs %}
        <button type="button"
                class="tab-trigger relative rounded-xl px-4 py-2 text-sm font-medium transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/50 {{ 'bg-slate-800/70 text-slate-100' if tab.id == active else 'text-slate-400 hover:text-slate-200' }}"
                data-tab-button="{{ tab.id }}"
                aria-selected="{{ 'true' if tab.id == active else 'false' }}"
                aria-controls="settings-panel-{{ tab.id }}"
                id="settings-tab-{{ tab.id }}">
          {{ tab.label }}
        </button>
      {% endfor %}
    </div>

    <div class="space-y-8 p-6">
      <section id="settings-panel-admin"
               class="motion-panel space-y-5 {{ 'is-active' if active == 'admin' else 'hidden' }}"
               role="tabpanel"
               aria-labelledby="settings-tab-admin"
               data-tab-panel="admin">
        <header>
          <h3 class="text-lg font-semibold text-slate-100">Admin tools</h3>
          <p class="mt-1 text-sm text-slate-400">Manage users, departments and positions without leaving settings.</p>
        </header>

        {% if current_user.is_admin %}
          {% include "partials/admin_panel.html" %}
        {% else %}
          <div class="rounded-xl border border-slate-800/60 bg-slate-900/40 p-5">
            <h4 class="text-base font-semibold text-slate-100">Admin access required</h4>
            <p class="mt-2 text-sm text-slate-400">You don't currently have permission to open the admin area. Please reach out to an administrator if you believe this is a mistake.</p>
          </div>
        {% endif %}
      </section>

      

      <section id="settings-panel-account"
               class="motion-panel space-y-5 {{ 'is-active' if active == 'account' else 'hidden' }}"
               role="tabpanel"
               aria-labelledby="settings-tab-account"
               data-tab-panel="account">
        <header>
          <h3 class="text-lg font-semibold text-slate-100">Account</h3>
          <p class="mt-1 text-sm text-slate-400">Review and update your personal details right from this tab.</p>
        </header>

        {% set show_profile_back_link = False %}
        {% include "partials/account_panel.html" %}
      </section>

      <section id="settings-panel-display"
                     class="motion-panel space-y-5 {{ 'is-active' if active == 'display' else 'hidden' }}"
                     role="tabpanel"
                     aria-labelledby="settings-tab-display"
                     data-tab-panel="display">
              <header>
                <h3 class="text-lg font-semibold text-slate-100">Display</h3>
                <p class="mt-1 text-sm text-slate-400">Switch between Eleva's curated colour schemes. Your choice is saved locally and applied instantly.</p>
              </header>

              <p class="text-sm text-slate-300 font-medium" data-theme-status>Active theme: Warm Modern</p>

              {% set theme_options = [
                {
                  'value': 'eleva-signature',
                  'name': 'Eleva Signature',
                  'emoji': '‚ú®',
                  'summary': 'Deep charcoal base with Eleva blue and cyan highlights. Ideal when you want crisp contrast with confident accents.',
                  'showcase': ['#0F141A', '#007AFF', '#39C0ED', '#00C58E'],
                  'swatches': [
                    {'label': 'Base', 'value': '#0F141A', 'background': '#0F141A'},
                    {'label': 'Primary Accent', 'value': '#007AFF', 'background': '#007AFF'},
                    {'label': 'Secondary Accent', 'value': '#39C0ED', 'background': '#39C0ED'},
                    {'label': 'Success', 'value': '#00C58E', 'background': '#00C58E'},
                    {'label': 'Warning', 'value': '#FBBF24', 'background': '#FBBF24'},
                    {'label': 'Error', 'value': '#F87171', 'background': '#F87171'},
                    {'label': 'Card Background', 'value': '#1C2128', 'background': '#1C2128'},
                    {'label': 'Text Primary', 'value': '#E5E7EB', 'background': '#E5E7EB'},
                    {'label': 'Text Secondary', 'value': '#9CA3AF', 'background': '#9CA3AF'},
                    {'label': 'Border', 'value': '#2D333B', 'background': '#2D333B'}
                  ]
                },
                {
                  'value': 'metallic-elevate',
                  'name': 'Metallic Elevate',
                  'emoji': '‚öôÔ∏è',
                  'summary': 'Graphite neutrals with brushed steel tones and electric blue energy. Great for a sleek, high-contrast workspace.',
                  'showcase': ['#121212', '#A9B1B7', '#3B82F6', '#00E0E0'],
                  'swatches': [
                    {'label': 'Base', 'value': '#121212', 'background': '#121212'},
                    {'label': 'Primary Accent', 'value': '#A9B1B7', 'background': '#A9B1B7'},
                    {'label': 'Secondary Accent', 'value': '#3B82F6', 'background': '#3B82F6'},
                    {'label': 'Highlight Gradient', 'value': '#3B82F6 ‚Üí #00C6FF', 'background': 'linear-gradient(90deg, #3B82F6, #00C6FF)'},
                    {'label': 'Hover / Focus', 'value': '#00E0E0', 'background': '#00E0E0'},
                    {'label': 'Success', 'value': '#14B8A6', 'background': '#14B8A6'},
                    {'label': 'Error', 'value': '#EF4444', 'background': '#EF4444'},
                    {'label': 'Text Primary', 'value': '#F5F6F7', 'background': '#F5F6F7'},
                    {'label': 'Text Muted', 'value': '#9CA3AF', 'background': '#9CA3AF'}
                  ]
                },
                {
                  'value': 'warm-modern',
                  'name': 'Warm Modern',
                  'emoji': 'üåá',
                  'summary': 'Midnight navy foundation with burnt orange and gold accents. Balanced warmth for a friendly yet professional feel.',
                  'showcase': ['#111827', '#FB923C', '#FACC15', '#374151'],
                  'swatches': [
                    {'label': 'Base', 'value': '#111827', 'background': '#111827'},
                    {'label': 'Primary Accent', 'value': '#FB923C', 'background': '#FB923C'},
                    {'label': 'Secondary Accent', 'value': '#FACC15', 'background': '#FACC15'},
                    {'label': 'Neutral Grey', 'value': '#374151', 'background': '#374151'},
                    {'label': 'Text Primary', 'value': '#F9FAFB', 'background': '#F9FAFB'},
                    {'label': 'Text Secondary', 'value': '#D1D5DB', 'background': '#D1D5DB'},
                    {'label': 'Card Background', 'value': '#1F2937', 'background': '#1F2937'}
                  ]
                },
                {
                  'value': 'india',
                  'name': 'India',
                  'emoji': 'üáÆüá≥',
                  'summary': 'Saffron, white and India green with navy highlights inspired by the tricolour.',
                  'usage_tip': 'Saffron for top bars, white for cards, green for CTAs and navy for icons or typography.',
                  'showcase': ['#FF9933', '#FFFFFF', '#138808', '#000080'],
                  'swatches': [
                    {'label': 'Primary', 'value': '#FF9933', 'background': '#FF9933'},
                    {'label': 'Secondary', 'value': '#FFFFFF', 'background': '#FFFFFF'},
                    {'label': 'Accent', 'value': '#138808', 'background': '#138808'},
                    {'label': 'Highlight', 'value': '#000080', 'background': '#000080'},
                    {'label': 'Usage Tip', 'value': 'Saffron headers ¬∑ White surfaces ¬∑ Green CTAs ¬∑ Navy icons', 'background': 'linear-gradient(90deg, #FF9933 0%, #FFFFFF 25%, #138808 60%, #000080 100%)'}
                  ]
                }
              ] %}

              <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3" role="radiogroup" aria-label="Colour scheme options">
                {% for option in theme_options %}
                  <label class="group relative block rounded-2xl border border-slate-800/60 bg-slate-950/40 p-5 transition-colors card-hover-lift fade-in-up"
                         data-theme-option="{{ option.value }}"
                         data-theme-name="{{ option.name }}"
                         role="radio"
                         aria-checked="false"
                         tabindex="0"
                         style="--fade-delay: {{ loop.index0 * 80 }}ms;">
                    <input type="radio" name="theme_preference" value="{{ option.value }}" class="sr-only" data-theme-radio>
                    <span class="absolute right-5 top-5 hidden text-xs font-semibold text-emerald-200" data-theme-active-badge>Active</span>
                    <div class="flex items-start justify-between gap-4">
                      <div class="space-y-1">
                        <div class="flex items-center gap-2 text-sm font-semibold text-slate-200" data-theme-title>
                          <span>{{ option.emoji }}</span>
                          <span>{{ option.name }}</span>
                        </div>
                        <p class="text-sm text-slate-300 leading-relaxed">{{ option.summary }}</p>
                        {% if option.usage_tip %}
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-300">Usage tip</p>
                          <p class="text-sm text-slate-300 leading-relaxed">{{ option.usage_tip }}</p>
                        {% endif %}
                      </div>
                      <div class="flex flex-wrap justify-end gap-2">
                        {% for color in option.showcase %}
                          <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-800/70"
                                style="background: {{ color }};">
                            <span class="sr-only">Preview swatch {{ color }}</span>
                          </span>
                        {% endfor %}
                      </div>
                    </div>
                    <dl class="mt-4 grid grid-cols-2 gap-2 text-xs text-slate-400">
                      {% for swatch in option.swatches %}
                        <div class="rounded-xl border border-slate-800/60 bg-slate-900/40 p-2">
                          <div class="mb-1 flex items-center gap-2">
                            <span class="inline-block h-3.5 w-3.5 rounded-full border border-slate-800/70" style="background: {{ swatch.background }};"></span>
                            <dt class="font-medium text-slate-200">{{ swatch.label }}</dt>
                          </div>
                          <dd class="text-xs uppercase tracking-wide text-slate-300">{{ swatch.value }}</dd>
                        </div>
                      {% endfor %}
                    </dl>
                  </label>
                {% endfor %}
              </div>

              <p class="text-xs text-slate-300">Themes adjust interface colours, accents, stage gradients and button treatments without affecting your data.</p>
            </section>

            <section id="settings-panel-modules"
               class="motion-panel space-y-5 {{ 'is-active' if active == 'modules' else 'hidden' }}"
               role="tabpanel"
               aria-labelledby="settings-tab-modules"
               data-tab-panel="modules">
        <header>
          <h3 class="text-lg font-semibold text-slate-100">Module Settings</h3>
          <p class="mt-1 text-sm text-slate-400">Fine-tune module level controls. Updates here apply instantly for everyone.</p>
        </header>

        <div class="grid gap-6 lg:grid-cols-2">
          <section class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-6 space-y-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-wide text-emerald-300">Service</p>
                <h4 class="text-base font-semibold text-slate-100">Service Settings</h4>
                <p class="text-sm text-slate-400">Manage lift dropdown options and service routes directly from the Service workspace.</p>
              </div>
              <span class="rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">Moved</span>
            </div>
            <ul class="list-disc space-y-1 pl-5 text-sm text-slate-300">
              <li>Lift dropdown values and reorder controls</li>
              <li>Service route creation and branch mapping</li>
            </ul>
            <div class="flex justify-end">
              <a href="{{ url_for('service_settings') }}" class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/40 bg-emerald-500/15 px-4 py-2 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/25">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                </svg>
                <span>Open Service Settings</span>
              </a>
            </div>
          </section>

          <section class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-6 space-y-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-wide text-amber-300">Customer Support</p>
                <h4 class="text-base font-semibold text-slate-100">CS configuration</h4>
                <p class="text-sm text-slate-400">Categories, channels and SLA presets now live alongside other CS controls.</p>
              </div>
              <span class="rounded-full bg-amber-500/15 px-3 py-1 text-xs font-semibold text-amber-200">Moved</span>
            </div>
            <ul class="list-disc space-y-1 pl-5 text-sm text-slate-300">
              <li>Support categories and descriptions</li>
              <li>Inbound channel toggles and SLA timers</li>
            </ul>
            <div class="flex justify-end">
              <a href="{{ url_for('customer_support_settings', tab='configuration') }}" class="inline-flex items-center gap-2 rounded-xl border border-amber-500/40 bg-amber-500/15 px-4 py-2 text-sm font-semibold text-amber-100 hover:bg-amber-500/25">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                </svg>
                <span>Open CS Settings</span>
              </a>
            </div>
          </section>
        </div>

      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% include "partials/admin_panel_scripts.html" %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const buttons = Array.from(document.querySelectorAll('[data-tab-button]'));
      const panels = Array.from(document.querySelectorAll('[data-tab-panel]'));
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!buttons.length) {
        return;
      }

      function activateTab(id) {
        buttons.forEach((button) => {
          const isActive = button.dataset.tabButton === id;
          button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          button.classList.toggle('bg-slate-800/70', isActive);
          button.classList.toggle('text-slate-100', isActive);
          button.classList.toggle('text-slate-400', !isActive);
          button.classList.toggle('hover:text-slate-200', !isActive);
        });

        panels.forEach((panel) => {
          const isActive = panel.dataset.tabPanel === id;
          if (isActive) {
            panel.classList.remove('hidden');
            requestAnimationFrame(() => {
              panel.classList.add('is-active');
            });
          } else {
            panel.classList.remove('is-active');
            if (panel.classList.contains('hidden')) {
              return;
            }
            if (prefersReducedMotion) {
              panel.classList.add('hidden');
              return;
            }
            const handleTransition = (event) => {
              if (event.target !== panel || event.propertyName !== 'opacity') {
                return;
              }
              if (panel.classList.contains('is-active')) {
                return;
              }
              panel.classList.add('hidden');
            };
            panel.addEventListener('transitionend', handleTransition, { once: true });
          }
        });

        try {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', id);
          window.history.replaceState({}, '', url);
        } catch (err) {
          // Ignore navigation updates if the browser does not support URL API.
        }
      }

      buttons.forEach((button) => {
        button.addEventListener('click', () => activateTab(button.dataset.tabButton));
      });

      const themeCards = Array.from(document.querySelectorAll('[data-theme-option]'));
      const themeRadios = Array.from(document.querySelectorAll('[data-theme-radio]'));
      const themeStatus = document.querySelector('[data-theme-status]');

      const addCategoryTrigger = document.querySelector('[data-add-category-trigger]');
      const addCategoryForm = document.querySelector('[data-add-category-form]');
      const addCategoryCancel = document.querySelector('[data-cancel-add-category]');
      const categoryList = document.querySelector('[data-category-list]');

      const refreshCategoryReorderState = () => {
        if (!categoryList) {
          return;
        }
        const items = Array.from(categoryList.querySelectorAll('[data-category-item]'));
        items.forEach((item, index) => {
          const up = item.querySelector('[data-move-category="up"]');
          const down = item.querySelector('[data-move-category="down"]');
          if (up) {
            up.disabled = index === 0;
            up.classList.toggle('opacity-50', index === 0);
            up.setAttribute('aria-disabled', index === 0 ? 'true' : 'false');
          }
          if (down) {
            down.disabled = index === items.length - 1;
            down.classList.toggle('opacity-50', index === items.length - 1);
            down.setAttribute('aria-disabled', index === items.length - 1 ? 'true' : 'false');
          }
          const reorderGroup = item.querySelector('[role="group"][aria-label^="Reorder"]');
          if (reorderGroup) {
            const label = item.querySelector('[data-category-label]')?.textContent?.trim() || 'category';
            reorderGroup.setAttribute('aria-label', `Reorder ${label}`);
          }
        });
      };

      const attachCategoryControls = (item) => {
        if (!item) {
          return;
        }
        const buttons = item.querySelectorAll('[data-move-category]');
        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            if (!categoryList) {
              return;
            }
            const direction = button.dataset.moveCategory;
            const sibling = direction === 'up' ? item.previousElementSibling : item.nextElementSibling;
            if (!sibling || !sibling.matches('[data-category-item]')) {
              return;
            }
            if (direction === 'up') {
              categoryList.insertBefore(item, sibling);
            } else {
              categoryList.insertBefore(sibling, item);
            }
            refreshCategoryReorderState();
          });
        });
      };

      if (categoryList) {
        const existingItems = categoryList.querySelectorAll('[data-category-item]');
        existingItems.forEach((item) => attachCategoryControls(item));
        refreshCategoryReorderState();
      }

      if (addCategoryTrigger && addCategoryForm && categoryList) {
        const labelInput = addCategoryForm.querySelector('[data-new-category-label]');
        const descriptionInput = addCategoryForm.querySelector('[data-new-category-description]');
        const firstResponseInput = addCategoryForm.querySelector('[data-new-category-first-response]');
        const resolutionInput = addCategoryForm.querySelector('[data-new-category-resolution]');

        const toggleCategoryForm = (show) => {
          const shouldShow = typeof show === 'boolean' ? show : addCategoryForm.classList.contains('hidden');
          addCategoryForm.classList.toggle('hidden', !shouldShow);
          if (shouldShow && labelInput) {
            requestAnimationFrame(() => labelInput.focus());
          }
        };

        addCategoryTrigger.addEventListener('click', () => toggleCategoryForm(true));

        if (addCategoryCancel) {
          addCategoryCancel.addEventListener('click', () => {
            addCategoryForm.reset();
            toggleCategoryForm(false);
          });
        }

        addCategoryForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const label = labelInput ? labelInput.value.trim() : '';
          const description = descriptionInput ? descriptionInput.value.trim() : '';
          const firstResponse = firstResponseInput ? parseInt(firstResponseInput.value, 10) || 0 : 0;
          const resolution = resolutionInput ? parseInt(resolutionInput.value, 10) || 0 : 0;

          if (!label) {
            if (labelInput) {
              labelInput.focus();
            }
            return;
          }

          const card = document.createElement('div');
          card.className = 'rounded-xl border border-slate-800/70 bg-slate-900/70 p-3';
          card.setAttribute('data-category-item', '');
          card.innerHTML = `
            <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
              <div>
                <div class="text-sm font-semibold text-slate-100" data-category-label></div>
                <p class="text-xs text-slate-400" data-category-description></p>
              </div>
              <div class="flex flex-wrap justify-end gap-2">
                <div class="flex items-center gap-1" role="group" aria-label="Reorder">
                  <button type="button" class="rounded-lg border border-slate-700/70 px-2 py-1 text-xs text-slate-400 hover:border-emerald-400/50 hover:text-emerald-200" data-move-category="up" aria-label="Move up">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                    </svg>
                  </button>
                  <button type="button" class="rounded-lg border border-slate-700/70 px-2 py-1 text-xs text-slate-400 hover:border-emerald-400/50 hover:text-emerald-200" data-move-category="down" aria-label="Move down">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                  </button>
                </div>
                <button type="button" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:border-emerald-400/50">Rename</button>
                <button type="button" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:border-rose-400/50">Archive</button>
              </div>
            </div>
            <div class="mt-3 grid gap-3 sm:grid-cols-2">
              <label class="flex items-center justify-between gap-3 rounded-lg border border-slate-800/60 bg-slate-900/60 px-3 py-2 text-xs text-slate-400">
                <span>First response (hours)</span>
                <input type="number" min="0" class="w-20 rounded-lg border border-slate-700 bg-slate-800 px-2 py-1 text-right text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" value="0" data-category-first-response>
              </label>
              <label class="flex items-center justify-between gap-3 rounded-lg border border-slate-800/60 bg-slate-900/60 px-3 py-2 text-xs text-slate-400">
                <span>Resolution (hours)</span>
                <input type="number" min="0" class="w-20 rounded-lg border border-slate-700 bg-slate-800 px-2 py-1 text-right text-sm text-slate-100 focus:border-emerald-400 focus:outline-none" value="0" data-category-resolution>
              </label>
            </div>
            <div class="mt-3 flex justify-end gap-2">
              <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-emerald-400/40 bg-emerald-400/20 px-3 py-1.5 text-xs font-semibold text-emerald-100 hover:bg-emerald-400/30">Save timings</button>
              <button type="button" class="rounded-lg border border-slate-700/70 px-3 py-1 text-xs text-slate-300 hover:border-slate-500/60">Reset</button>
            </div>
          `;

          const labelTarget = card.querySelector('[data-category-label]');
          const descriptionTarget = card.querySelector('[data-category-description]');
          const firstResponseField = card.querySelector('[data-category-first-response]');
          const resolutionField = card.querySelector('[data-category-resolution]');

          if (labelTarget) {
            labelTarget.textContent = label;
          }
          if (descriptionTarget) {
            descriptionTarget.textContent = description || 'Newly created support queue.';
          }
          if (firstResponseField) {
            firstResponseField.value = firstResponse;
          }
          if (resolutionField) {
            resolutionField.value = resolution;
          }

          categoryList.appendChild(card);
          attachCategoryControls(card);
          refreshCategoryReorderState();

          addCategoryForm.reset();
          toggleCategoryForm(false);
        });
      }

      const addChannelTrigger = document.querySelector('[data-add-channel-trigger]');
      const addChannelForm = document.querySelector('[data-add-channel-form]');
      const addChannelCancel = document.querySelector('[data-cancel-add-channel]');
      const channelList = document.querySelector('[data-channel-list]');

      if (addChannelTrigger && addChannelForm && channelList) {
        const labelInput = addChannelForm.querySelector('[data-new-channel-label]');
        const iconInput = addChannelForm.querySelector('[data-new-channel-icon]');

        const toggleChannelForm = (show) => {
          const shouldShow = typeof show === 'boolean' ? show : addChannelForm.classList.contains('hidden');
          addChannelForm.classList.toggle('hidden', !shouldShow);
          if (shouldShow && labelInput) {
            requestAnimationFrame(() => labelInput.focus());
          }
        };

        addChannelTrigger.addEventListener('click', () => toggleChannelForm(true));

        if (addChannelCancel) {
          addChannelCancel.addEventListener('click', () => {
            addChannelForm.reset();
            toggleChannelForm(false);
          });
        }

        addChannelForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const label = labelInput ? labelInput.value.trim() : '';
          const icon = iconInput ? iconInput.value.trim() || 'üÜï' : 'üÜï';

          if (!label) {
            if (labelInput) {
              labelInput.focus();
            }
            return;
          }

          const channelTag = document.createElement('label');
          channelTag.className = 'flex cursor-pointer items-center gap-3 rounded-xl border border-dashed border-emerald-400/40 bg-slate-900/70 px-3 py-2 text-sm text-slate-200 hover:border-emerald-400/60';

          const iconSpan = document.createElement('span');
          iconSpan.className = 'text-lg';
          iconSpan.textContent = icon;

          const labelSpan = document.createElement('span');
          labelSpan.textContent = label;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true;
          checkbox.className = 'ml-auto h-4 w-4 rounded border border-slate-600 bg-slate-950 text-emerald-400 focus:ring-emerald-400';

          channelTag.append(iconSpan, labelSpan, checkbox);

          channelList.appendChild(channelTag);

          addChannelForm.reset();
          toggleChannelForm(false);
        });
      }

      if (themeCards.length && themeRadios.length) {
        const themeNames = new Map(themeCards.map((card) => [card.dataset.themeOption, card.dataset.themeName]));

        const getThemeLabel = (theme) => {
          const activeCard = themeCards.find((card) => card.dataset.themeOption === theme);
          if (activeCard) {
            const titleEl = activeCard.querySelector('[data-theme-title] span:last-child') || activeCard.querySelector('[data-theme-title]');
            const cardTitle = titleEl && titleEl.textContent ? titleEl.textContent.trim() : '';
            if (cardTitle) {
              return cardTitle;
            }
          }
          return themeNames.get(theme) || 'Warm Modern';
        };

        const updateThemeUI = (theme) => {
          themeCards.forEach((card) => {
            const isActive = card.dataset.themeOption === theme;
            card.classList.toggle('border-emerald-400/60', isActive);
            card.classList.toggle('bg-emerald-500/10', isActive);
            card.classList.toggle('shadow-lg', isActive);
            const badge = card.querySelector('[data-theme-active-badge]');
            if (badge) {
              badge.classList.toggle('hidden', !isActive);
            }
            card.setAttribute('aria-checked', isActive ? 'true' : 'false');
          });

          themeRadios.forEach((radio) => {
            radio.checked = radio.value === theme;
          });

          if (themeStatus) {
            const label = getThemeLabel(theme);
            themeStatus.textContent = `Active theme: ${label}`;
          }
        };

        const getCurrentTheme = () => {
          if (document.documentElement.dataset.theme) {
            return document.documentElement.dataset.theme;
          }
          if (window.elevaTheme && typeof window.elevaTheme.getTheme === 'function') {
            return window.elevaTheme.getTheme();
          }
          try {
            return localStorage.getItem('eleva:theme') || 'warm-modern';
          } catch (error) {
            return 'warm-modern';
          }
        };

        const initialTheme = getCurrentTheme();
        updateThemeUI(initialTheme);

        themeRadios.forEach((radio) => {
          radio.addEventListener('change', () => {
            if (!radio.checked) {
              return;
            }
            const selectedTheme = radio.value;
            if (window.elevaTheme && typeof window.elevaTheme.setTheme === 'function') {
              window.elevaTheme.setTheme(selectedTheme);
            }
            updateThemeUI(selectedTheme);
          });
        });

        themeCards.forEach((card) => {
          card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              const radio = card.querySelector('input[type="radio"]');
              if (!radio) {
                return;
              }
              radio.checked = true;
              radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        });
      }

      const dropdownSections = Array.from(document.querySelectorAll('[data-dropdown-section]'));
      dropdownSections.forEach((section) => {
        const trigger = section.querySelector('[data-dropdown-section-trigger]');
        const body = section.querySelector('[data-dropdown-section-body]');
        const icon = section.querySelector('[data-dropdown-section-icon]');
        if (!trigger || !body) {
          return;
        }

        const setExpanded = (expanded) => {
          trigger.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          body.classList.toggle('hidden', !expanded);
          if (icon) {
            icon.textContent = expanded ? '‚àí' : '+';
          }
        };

        setExpanded(false);

        trigger.addEventListener('click', () => {
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          setExpanded(!isExpanded);
        });
      });

      const dropdownLists = Array.from(document.querySelectorAll('[data-dropdown-list]'));
      dropdownLists.forEach((list) => {
        const reorderUrl = list.getAttribute('data-reorder-url');
        if (!reorderUrl) {
          return;
        }

        const getOrder = () =>
          Array.from(list.querySelectorAll('[data-dropdown-item]'))
            .map((item) => item.getAttribute('data-option-id'))
            .filter((value) => value !== null && value !== undefined && value !== '');

        let dragItem = null;
        let lastOrder = getOrder();

        const persistOrder = () => {
          const currentOrder = getOrder();
          if (!currentOrder.length || JSON.stringify(currentOrder) === JSON.stringify(lastOrder)) {
            return;
          }
          lastOrder = currentOrder;
          fetch(reorderUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ order: currentOrder }),
          }).catch((error) => {
            console.error('Failed to reorder dropdown options', error);
          });
        };

        const attachDragEvents = (item) => {
          if (!item) {
            return;
          }
          item.setAttribute('draggable', 'true');
          item.addEventListener('dragstart', (event) => {
            dragItem = item;
            item.classList.add('opacity-60');
            if (event.dataTransfer) {
              event.dataTransfer.effectAllowed = 'move';
              const optionId = item.getAttribute('data-option-id') || '';
              event.dataTransfer.setData('text/plain', optionId);
            }
          });
          item.addEventListener('dragend', () => {
            item.classList.remove('opacity-60');
            persistOrder();
            dragItem = null;
          });
        };

        const items = Array.from(list.querySelectorAll('[data-dropdown-item]'));
        items.forEach((item) => attachDragEvents(item));

        list.addEventListener('dragover', (event) => {
          if (!dragItem) {
            return;
          }
          event.preventDefault();
          const target = event.target.closest('[data-dropdown-item]');
          if (!target || target === dragItem) {
            return;
          }
          const rect = target.getBoundingClientRect();
          const before = event.clientY < rect.top + rect.height / 2;
          const referenceNode = before ? target : target.nextElementSibling;
          list.insertBefore(dragItem, referenceNode);
        });

        list.addEventListener('drop', (event) => {
          if (dragItem) {
            event.preventDefault();
            persistOrder();
            dragItem = null;
          }
        });
      });
    });
  </script>
{% endblock %}
