{% extends "base.html" %}
{% block title %}Design · Drawing History{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <p class="text-sm uppercase text-slate-500">Design</p>
      <h1 class="text-2xl font-semibold">Drawing Site Repository</h1>
      <p class="text-sm text-slate-600">Latest drawings by site/lift with quick access to history and BOM.</p>
    </div>
    <label for="upload-drawing-history" class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">Upload Drawing History (Excel)</label>
  </div>

  <div class="relative">
    <input type="checkbox" id="upload-drawing-history" class="hidden peer" />
    <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('upload-drawing-history').checked=false;"></div>
    <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
        <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
          <div>
            <p class="text-xs text-slate-500 uppercase">Drawing history import</p>
            <h2 class="text-lg font-semibold">Upload Drawing History</h2>
          </div>
          <button class="text-slate-500" type="button" onclick="document.getElementById('upload-drawing-history').checked=false;">✕</button>
        </div>
        <form method="POST" action="{{ url_for('design_drawing_history_upload') }}" enctype="multipart/form-data" class="p-5 space-y-4">
          {{ csrf_field() }}
          <p class="text-sm text-slate-600">Upload the <span class="font-semibold">Drawing History</span> sheet (.xlsx or .csv). Required columns: {{ required_headers|join(', ') if required_headers else 'Project No., CLIENT NAME, SITE LOCATION, DRG NUMBER, DRG BY, REV. NO., DRG APPROVAL, LIFT TYPE, SHAFT INNER DIMS (Actual), CAR INNER DIMS, NO. OF PASS. (Actual), NO. OF PASS. (Quoted), FLR. LEVEL, LANDING DOOR OPENING, NO. OF SIDES OF STRUCT.' }}.</p>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Upload file</span>
            <input type="file" name="drawing_history_file" accept=".xlsx,.csv" required class="w-full rounded-lg border-slate-200" />
          </label>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('upload-drawing-history').checked=false;">Cancel</button>
            <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <form method="GET" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Project No.</span>
        <input type="text" name="project_no" value="{{ filters.project_no }}" class="w-full rounded-lg border-slate-200" placeholder="Search project" />
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Client Name</span>
        <input type="text" name="client_name" value="{{ filters.client_name }}" class="w-full rounded-lg border-slate-200" placeholder="Search client" />
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Site Location</span>
        <input type="text" name="site_location" value="{{ filters.site_location }}" class="w-full rounded-lg border-slate-200" placeholder="City / address" />
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Lift Type</span>
        <select name="lift_type" class="w-full rounded-lg border-slate-200">
          <option value="">All types</option>
          {% for option in lift_type_options %}
          <option value="{{ option }}" {% if filters.lift_type == option %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Approval Status</span>
        <select name="approval_status" class="w-full rounded-lg border-slate-200">
          {% set statuses = ['all','Approved','Pending','Rejected'] %}
          {% for status in statuses %}
          <option value="{{ status }}" {% if filters.approval_status|lower == status|lower %}selected{% endif %}>{{ status.title() if status!='all' else 'All statuses' }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <div class="flex items-center justify-end gap-3 pt-2">
      <a href="{{ url_for('design_drawing_history') }}" class="px-4 py-2 rounded-lg border">Reset</a>
      <button type="submit" class="px-5 py-2 rounded-lg bg-slate-900 text-white shadow hover:shadow-lg hover:scale-[1.02] transition">Apply Filters</button>
    </div>
  </form>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b">
      <div>
        <p class="text-xs uppercase text-slate-500">Sites / Lifts</p>
        <p class="text-sm text-slate-700">{{ total_records }} record(s) found</p>
      </div>
      <p class="text-xs text-slate-500">Click a row to open the drawing site detail.</p>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-3 px-4">Project No.</th>
            <th class="py-3 px-4">Client</th>
            <th class="py-3 px-4">Site Location</th>
            <th class="py-3 px-4">Lift Type</th>
            <th class="py-3 px-4">Lift Identifier</th>
            <th class="py-3 px-4">Latest Drawing No.</th>
            <th class="py-3 px-4">Latest Revision</th>
            <th class="py-3 px-4">Approval Status</th>
            <th class="py-3 px-4">Last Updated</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for site in sites %}
          <tr class="hover:bg-orange-50 transition" onclick="window.location='{{ url_for('design_drawing_site_detail', site_id=site.id) }}'">
            <td class="py-3 px-4 font-semibold text-slate-800">{{ site.project_no or '—' }}</td>
            <td class="py-3 px-4">{{ site.client_name or '—' }}</td>
            <td class="py-3 px-4">{{ site.site_location or '—' }}</td>
            <td class="py-3 px-4">{{ site.lift_type or '—' }}</td>
            <td class="py-3 px-4">{{ site.lift_identifier or '—' }}</td>
            <td class="py-3 px-4"><span class="clickable-text">{{ site.latest_drawing_number or '—' }}</span></td>
            <td class="py-3 px-4">{{ site.latest_revision or '—' }}</td>
            <td class="py-3 px-4">
              {% if site.approval_status %}
              <span class="px-2 py-1 rounded-full text-xs {{ 'bg-emerald-100 text-emerald-700' if site.approval_status|lower == 'approved' else ('bg-amber-100 text-amber-700' if site.approval_status|lower == 'pending' else 'bg-red-100 text-red-700') }}">{{ site.approval_status }}</span>
              {% else %}
              —
              {% endif %}
            </td>
            <td class="py-3 px-4">{{ site.last_updated|format_india_datetime('%d %b %Y, %I:%M %p') if site.last_updated else '—' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="9" class="py-4 px-4 text-slate-500">No drawing site records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="flex items-center justify-between text-sm text-slate-600">
    <p>Showing {{ sites|length }} of {{ total_records }} records</p>
    <div class="flex items-center gap-2">
      {% set prev_page = page - 1 %}
      {% set next_page = page + 1 %}
      <a href="{{ url_for('design_drawing_history', page=prev_page if page>1 else 1, project_no=filters.project_no, client_name=filters.client_name, site_location=filters.site_location, lift_type=filters.lift_type, approval_status=filters.approval_status) }}" class="px-3 py-1 rounded-lg border {{ 'opacity-50 pointer-events-none' if page <=1 else '' }}">Prev</a>
      <span>Page {{ page }} of {{ total_pages }}</span>
      <a href="{{ url_for('design_drawing_history', page=next_page if page < total_pages else total_pages, project_no=filters.project_no, client_name=filters.client_name, site_location=filters.site_location, lift_type=filters.lift_type, approval_status=filters.approval_status) }}" class="px-3 py-1 rounded-lg border {{ 'opacity-50 pointer-events-none' if page >= total_pages else '' }}">Next</a>
    </div>
  </div>
</div>
{% endblock %}
