{% extends "base.html" %}
{% block title %}Design · Drawing History{% endblock %}
{% block content %}
<div class="px-6 py-6 space-y-6 overflow-y-auto h-full">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <p class="text-sm uppercase text-slate-500">Design</p>
      <h1 class="text-2xl font-semibold">Drawing History Archive</h1>
      <p class="text-sm text-slate-600">Approved and finalized drawings are archived here automatically.</p>
    </div>
    <label for="upload-drawing-history" class="inline-flex items-center gap-2 px-4 py-2 btn-primary btn-shimmer rounded-xl shadow hover:shadow-lg hover:scale-[1.02] transition cursor-pointer">Upload Drawing History (Excel)</label>
  </div>

  <div class="relative">
    <input type="checkbox" id="upload-drawing-history" class="hidden peer" />
    <div class="fixed inset-0 z-40 hidden peer-checked:block bg-slate-900/60 backdrop-blur" onclick="document.getElementById('upload-drawing-history').checked=false;"></div>
    <div class="fixed inset-0 z-50 hidden peer-checked:flex items-center justify-center pointer-events-none peer-checked:pointer-events-auto">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform transition-all peer-checked:scale-100 scale-95">
        <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b">
          <div>
            <p class="text-xs text-slate-500 uppercase">Drawing history import</p>
            <h2 class="text-lg font-semibold">Upload Drawing History</h2>
          </div>
          <button class="text-slate-500" type="button" onclick="document.getElementById('upload-drawing-history').checked=false;">✕</button>
        </div>
        <form method="POST" action="{{ url_for('design_drawing_history_upload') }}" enctype="multipart/form-data" class="p-5 space-y-4">
          {{ csrf_field() }}
          <p class="text-sm text-slate-600">Required columns: {{ required_headers|join(', ') }}.</p>
          <label class="space-y-1 block">
            <span class="text-sm text-slate-600">Upload file</span>
            <input type="file" name="drawing_history_file" accept=".xlsx,.csv" required class="w-full rounded-lg border-slate-200" />
          </label>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" class="px-4 py-2 rounded-lg border" onclick="document.getElementById('upload-drawing-history').checked=false;">Cancel</button>
            <button type="submit" class="px-5 py-2 rounded-lg btn-primary btn-shimmer shadow hover:shadow-lg hover:scale-[1.02] transition">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <form method="GET" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Project No.</span>
        <input type="text" name="project_no" value="{{ filters.project_no }}" class="w-full rounded-lg border-slate-200" placeholder="Search project" />
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Client Name</span>
        <input type="text" name="client_name" value="{{ filters.client_name }}" class="w-full rounded-lg border-slate-200" placeholder="Search client" />
      </label>
      <label class="space-y-1 block">
        <span class="text-xs uppercase text-slate-500">Site Location</span>
        <input type="text" name="site_location" value="{{ filters.site_location }}" class="w-full rounded-lg border-slate-200" placeholder="City / address" />
      </label>
    </div>
    <div class="flex items-center justify-end gap-3 pt-2">
      <a href="{{ url_for('design_drawing_history') }}" class="px-4 py-2 rounded-lg border">Reset</a>
      <button type="submit" class="px-5 py-2 rounded-lg bg-slate-900 text-white shadow hover:shadow-lg hover:scale-[1.02] transition">Apply Filters</button>
    </div>
  </form>

  <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b">
      <div>
        <p class="text-xs uppercase text-slate-500">Archived drawings</p>
        <p class="text-sm text-slate-700">{{ total_records }} archived site(s)</p>
      </div>
      <p class="text-xs text-slate-500">Click a row to open version timeline.</p>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-3 px-4">Project No.</th>
            <th class="py-3 px-4">Client</th>
            <th class="py-3 px-4">Site</th>
            <th class="py-3 px-4">Lift ID</th>
            <th class="py-3 px-4">Latest Drawing</th>
            <th class="py-3 px-4">Status</th>
            <th class="py-3 px-4">Updated</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for site in sites %}
          <tr class="hover:bg-orange-50 transition cursor-pointer" onclick="window.location='{{ url_for('design_drawing_history_detail', site_id=site.id) }}'">
            <td class="py-3 px-4 font-semibold text-slate-800">{{ site.project_no or '—' }}</td>
            <td class="py-3 px-4">{{ site.client_name or '—' }}</td>
            <td class="py-3 px-4">{{ site.site_location or '—' }}</td>
            <td class="py-3 px-4">{{ site.lift_identifier or '—' }}</td>
            <td class="py-3 px-4">{{ site.latest_drawing_number or '—' }} {% if site.latest_revision %}<span class="text-slate-500">(Rev {{ site.latest_revision }})</span>{% endif %}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 rounded-full text-xs {{ 'bg-emerald-100 text-emerald-700' if site.approval_status|lower == 'approved' else 'bg-indigo-100 text-indigo-700' }}">{{ site.approval_status or '—' }}</span>
            </td>
            <td class="py-3 px-4">{{ site.last_updated|format_india_datetime('%d %b %Y, %I:%M %p') if site.last_updated else '—' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="py-4 px-4 text-slate-500">No archived drawing records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
