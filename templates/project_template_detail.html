{% extends "base.html" %}
{% block title %}Eleva ERP – Template {{ template.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
  <style>
    .task-dragging {
      transform: scale(1.02) translateY(-2px);
      box-shadow: 0 22px 45px -18px rgba(16, 185, 129, 0.45);
      border-color: rgba(16, 185, 129, 0.6);
      background: rgba(15, 23, 42, 0.85);
    }

    .task-dragging * {
      pointer-events: none !important;
    }

    .task-drop-target {
      outline: 2px dashed rgba(148, 163, 184, 0.35);
      outline-offset: 8px;
    }
  </style>
  {% set task_type_styles = {
    'general': 'bg-slate-800 text-slate-100 border border-slate-700',
    'qc': 'bg-purple-500/20 text-purple-100 border border-purple-400/50',
    'design': 'bg-orange-500/20 text-orange-100 border border-orange-400/50',
    'srt': 'bg-sky-500/20 text-sky-100 border border-sky-400/50',
    'milestone': 'bg-amber-500/20 text-amber-900 border border-amber-400/70',
    'sales': 'bg-teal-500/20 text-teal-100 border border-teal-400/50',
    'custom': 'bg-indigo-500/20 text-indigo-100 border border-indigo-400/50'
  } %}
  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-start gap-6 justify-between">
      <form id="template-meta-form"
            method="post"
            action="{{ url_for('project_template_update', template_id=template.id) }}"
            data-original-name="{{ template.name }}"
            data-original-description="{{ template.description or '' }}"
            class="flex-1 min-w-[260px] space-y-3">
        {{ csrf_field() }}
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Template name</label>
          <input name="template_name"
                 value="{{ template.name }}"
                 required
                 class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
          <textarea name="template_description"
                    rows="3"
                    class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none"
                    placeholder="Add helpful context for this template">{{ template.description or '' }}</textarea>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm text-white" data-skip-warning="true">Save template</button>
          <button type="button" id="template-meta-cancel" class="px-4 py-2 rounded-xl bg-slate-800/60 border border-slate-700/60 text-sm text-slate-200 hover:bg-slate-700/60" data-skip-warning="true">Reset</button>
        </div>
      </form>
      <div class="flex flex-col items-end gap-3 text-xs text-slate-400 min-w-[220px]">
        <div class="text-right">
          <div class="text-sm font-semibold text-slate-100">Template info</div>
          <div class="mt-1">Default task form: <span class="text-emerald-300">{{ DEFAULT_TASK_FORM_NAME }}</span></div>
          <div class="mt-1">Created {{ template.created_at|format_india_datetime('%Y-%m-%d %H:%M') }}</div>
          {% if template.creator %}
            <div class="mt-1">By {{ template.creator.display_name }}</div>
          {% endif %}
          <div class="mt-2">Assign this template from a project detail page.</div>
        </div>
        <button type="button"
                data-save-task-template
                data-skip-warning="true"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-700/60 bg-slate-800/60 text-xs uppercase tracking-wide text-slate-200 hover:bg-slate-700/60">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm0 2.5L19.5 8H17V5.5zM5 19V5h10v5h4v9H5z" />
          </svg>
          <span>Save as Task Template</span>
        </button>
      </div>
    </div>
  </div>

  <div id="task-template-modal" class="fixed inset-0 hidden z-40 items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4">
    <div class="relative w-full max-w-md rounded-2xl border border-slate-800 bg-slate-900/90 p-6 shadow-2xl">
      <button type="button" class="absolute top-4 right-4 text-slate-400 hover:text-slate-100" data-close-task-template data-skip-warning="true" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4l-6.3 6.3-1.42-1.42L9.17 12 2.87 5.71 4.29 4.3l6.3 6.29 6.29-6.3z" />
        </svg>
      </button>
      <h3 class="text-base font-semibold text-slate-100 mb-4">Save as Task Template</h3>
      <form method="post" action="{{ url_for('project_template_save_as_task_template', template_id=template.id) }}" class="space-y-4">
        {{ csrf_field() }}
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Task template name</label>
          <input name="task_template_name" value="{{ template.name }}" required class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
          <textarea name="task_template_description" rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="Optional notes for when to use this task template">{{ template.description or '' }}</textarea>
        </div>
        <div class="flex items-center gap-3">
          <button class="flex-1 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm text-white" data-skip-warning="true">Save task template</button>
          <button type="button" class="px-4 py-2 rounded-xl bg-slate-800/60 border border-slate-700/60 text-sm text-slate-200 hover:bg-slate-700/60" data-close-task-template data-skip-warning="true">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="grid xl:grid-cols-[3fr_2fr] gap-6">
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base font-semibold text-slate-100">Task Blueprint</h3>
        <span class="text-xs text-slate-400 uppercase tracking-wide">{{ tasks|length }} task{{ '' if tasks|length == 1 else 's' }}</span>
      </div>
      <div id="task-reorder-feedback" class="hidden mb-3 text-xs rounded-xl border px-3 py-2"></div>
      {% if tasks %}
        <div id="task-blueprint-list"
             class="space-y-3"
            data-reorder-url="{{ url_for('project_template_task_reorder', template_id=template.id) }}">
          {% for task in tasks %}
            {% set task_payload = {
              'task_type': task.task_type or '',
              'module': task.module or '',
              'task_subtype': task.task_subtype or '',
              'id': task.id,
              'name': task.name,
              'description': task.description or '',
              'order_index': task.order_index,
              'dependency_ids': task.dependency_ids,
              'default_assignee_id': task.default_assignee_id,
              'form_template_id': task.form_template_id,
              'start_mode': task.start_mode or 'immediate',
              'start_date': task.planned_start_date.isoformat() if task.planned_start_date else '',
              'duration_days': task.duration_days,
              'milestone': task.milestone or ''
            } %}
            {% set module_value = (task.module or task.task_type or 'general').lower() %}
            {% set subtype_value = (task.task_subtype or 'general').lower() %}
            {% set badge_label = PROJECT_TEMPLATE_BADGES.get((module_value, subtype_value), TASK_TYPE_LABELS.get(module_value, TASK_TYPE_LABELS['custom'])) %}
            {% set type_style = task_type_styles.get(module_value, task_type_styles['custom']) %}
            {% set dependencies = task.dependencies %}
            {% set dependency_count = dependencies|length %}
            {% set duration_label = task.duration_days is not none and (task.duration_days|string + ' day' + ('s' if task.duration_days != 1 else '')) or 'No duration set' %}
            <div class="rounded-2xl border border-slate-800/60 bg-slate-950/40 p-4 transition-transform duration-150"
                 draggable="true"
                 data-task-item
                 data-task-id="{{ task.id }}">
              <div class="flex flex-col gap-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex items-start gap-3">
                    <button type="button" class="mt-1 cursor-move text-slate-500 hover:text-slate-300" title="Drag to reorder">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10h2V8H7v2zm0 6h2v-2H7v2zm4-6h2V8h-2v2zm0 6h2v-2h-2v2zm4-6h2V8h-2v2zm0 6h2v-2h-2v2z" />
                      </svg>
                    </button>
                    <div class="space-y-2">
                      <div class="flex flex-wrap items-center gap-2">
                        <div class="text-sm font-semibold text-slate-100">{{ task.name }}</div>
                        <span class="px-2 py-0.5 rounded-lg text-[11px] uppercase tracking-wide {{ type_style }}">{{ badge_label }}</span>
                      </div>
                      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-300">
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-800/60 border border-slate-700/60" data-order-label>Order {{ task.order_index }}</span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-800/40 border border-slate-700/40">Duration: {{ duration_label }}</span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-800/40 border border-slate-700/40">{{ dependency_count }} dependenc{{ 'y' if dependency_count == 1 else 'ies' }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button type="button"
                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl border border-slate-700/60 bg-slate-800/60 text-xs uppercase tracking-wide text-slate-200 hover:bg-slate-700/60"
                            data-edit-task='{{ task_payload|tojson }}'>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 17.17V21h3.83L18.74 10.09l-3.83-3.83L4 17.17zm15.71-8.29c.39-.39.39-1.02 0-1.41l-2.59-2.59a.995.995 0 0 0-1.41 0l-1.83 1.83 3.83 3.83 2-2z" />
                      </svg>
                      Edit
                    </button>
                    <button type="button"
                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl border border-slate-700/60 bg-slate-800/60 text-xs uppercase tracking-wide text-slate-200 hover:bg-slate-700/60"
                            data-toggle-details="task-details-{{ task.id }}"
                            aria-expanded="false"
                            aria-controls="task-details-{{ task.id }}">
                      <span>Details</span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-chevron>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
                      </svg>
                    </button>
                    <form method="post"
                          action="{{ url_for('project_template_task_delete', template_id=template.id, task_id=task.id) }}"
                          class="inline"
                          onsubmit="return confirm('Delete task {{ task.name }}? This will remove its dependency links.');">
                      {{ csrf_field() }}
                      <button type="submit"
                              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl border border-rose-500/40 bg-rose-500/10 text-xs uppercase tracking-wide text-rose-100 hover:bg-rose-500/20 active:scale-95 transition"
                              data-skip-warning="true">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z" />
                        </svg>
                        Delete
                      </button>
                    </form>
                  </div>
                </div>
                <div id="task-details-{{ task.id }}" class="hidden rounded-xl border border-slate-800 bg-slate-900/70 p-3 text-sm text-slate-300 space-y-2" data-task-details>
                  {% if task.description %}
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Description</div>
                      <p class="mt-1 text-slate-200">{{ task.description }}</p>
                    </div>
                  {% endif %}
                  <div class="grid sm:grid-cols-2 gap-3">
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Default assignee</div>
                      <p class="mt-1">{{ task.default_assignee.display_name if task.default_assignee else 'Unassigned' }}</p>
                    </div>
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Form template</div>
                      <p class="mt-1">{{ task.form_template.name if task.form_template else DEFAULT_TASK_FORM_NAME }}</p>
                    </div>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Start behaviour</div>
                      {% set start_labels = {'immediate': 'Immediate', 'after_previous': 'After previous', 'scheduled': 'Scheduled'} %}
                      <p class="mt-1">{{ start_labels.get(task.start_mode or 'immediate', 'Immediate') }}</p>
                      {% if task.planned_start_date %}
                        <p class="text-xs text-slate-400">Planned start: {{ task.planned_start_date.strftime('%Y-%m-%d') }}</p>
                      {% endif %}
                    </div>
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Timeline</div>
                      <p class="mt-1">{{ duration_label }}</p>
                      {% if task.planned_due_date %}
                        <p class="text-xs text-slate-400">Planned due: {{ task.planned_due_date.strftime('%Y-%m-%d') }}</p>
                      {% endif %}
                    </div>
                  </div>
                  {% if task.milestone %}
                    <div>
                      <div class="text-xs uppercase tracking-wide text-slate-500">Milestone</div>
                      <p class="mt-1">{{ task.milestone }}</p>
                    </div>
                  {% endif %}
                  <div>
                    <div class="text-xs uppercase tracking-wide text-slate-500">Dependencies</div>
                    {% if dependencies %}
                      <div class="mt-2 flex flex-wrap gap-2">
                        {% for dependency in dependencies %}
                          <span class="inline-flex items-center px-2 py-1 rounded-lg bg-amber-500/15 border border-amber-400/40 text-amber-100">{{ dependency.name }}</span>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="mt-1 text-slate-400">No dependencies</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-slate-400">No tasks yet. Add the first blueprint task using the form on the right.</p>
      {% endif %}
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
      <h3 id="task-form-title" class="text-base font-semibold text-slate-100 mb-4">Add Task to Template</h3>
      <form id="template-task-form"
            method="post"
            class="space-y-4"
            action="{{ url_for('project_template_detail', template_id=template.id) }}"
            data-create-action="{{ url_for('project_template_detail', template_id=template.id) }}"
            data-edit-url-template="{{ url_for('project_template_task_edit', template_id=template.id, task_id=0).replace('/0/edit', '/{id}/edit') }}"
            data-default-order="{{ tasks|length + 1 }}">
        {{ csrf_field() }}
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Module</label>
          <select name="module" data-template-module class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            {% for value, label in PROJECT_TEMPLATE_TASK_MODULES %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Subtype</label>
          <select name="task_subtype" data-template-subtype class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            {% for value, label in PROJECT_TEMPLATE_TASK_SUBTYPES.get('general', []) %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Task name</label>
          <input name="name" required class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. Kick-off meeting" />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
          <textarea name="description" rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="Optional context or acceptance criteria"></textarea>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Order</label>
            <input type="number" name="order_index" value="{{ tasks|length + 1 }}" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Dependencies</label>
            <select name="depends_on_ids" multiple size="4" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none min-h-[120px]">
              {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.name }}</option>
              {% endfor %}
            </select>
            <p class="mt-1 text-sm text-slate-500">Leave unselected if the task is independent. Hold Ctrl/Cmd to pick multiple dependencies.</p>
          </div>
        </div>
        <div>
          <span class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Start behaviour</span>
          <div class="flex flex-wrap gap-3 text-xs">
              <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 cursor-pointer">
                <input type="radio" name="start_mode" value="immediate" class="accent-emerald-500" checked>
                <span>Immediate</span>
              </label>
              <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 cursor-pointer">
                <input type="radio" name="start_mode" value="scheduled" class="accent-emerald-500">
                <span>Scheduled</span>
              </label>
              <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 cursor-pointer">
                <input type="radio" name="start_mode" value="after_previous" class="accent-emerald-500">
                <span>After previous</span>
              </label>
            </div>
          </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div id="scheduled-start-wrapper" class="opacity-60 pointer-events-none transition">
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Start date</label>
            <input type="date" name="start_date" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Duration (days)</label>
            <input type="number" name="duration_days" min="0" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. 3" />
          </div>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Milestone</label>
          <input name="milestone" list="milestone-options" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. Production Milestone" />
          <datalist id="milestone-options">
            {% for option in TASK_MILESTONES %}
              <option value="{{ option }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Default assignee</label>
          <select name="default_assignee_id" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            <option value="">Unassigned</option>
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Form template</label>
          <select name="form_template_id" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            <option value="">Use {{ DEFAULT_TASK_FORM_NAME }}</option>
            {% for form in forms %}
              <option value="{{ form.id }}">{{ form.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center gap-3">
          <button data-role="submit" class="flex-1 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm text-white">Add template task</button>
          <button type="button" id="cancel-task-edit" class="hidden px-4 py-2 rounded-xl bg-slate-800/60 border border-slate-700/60 text-sm text-slate-200 hover:bg-slate-700/60">Cancel edit</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const list = document.getElementById('task-blueprint-list');
      const feedback = document.getElementById('task-reorder-feedback');
      const metaForm = document.getElementById('template-meta-form');
      const openModalButton = document.querySelector('[data-save-task-template]');
      const modal = document.getElementById('task-template-modal');
      const closeModalButtons = document.querySelectorAll('[data-close-task-template]');
      const csrfToken = '{{ csrf_token() }}';
      let draggingItem = null;
      let metaDirty = false;
      let taskDirty = false;

      function hasUnsavedChanges() {
        return metaDirty || taskDirty;
      }

      function showFeedback(message, type) {
        if (!feedback) return;
        feedback.textContent = message;
        feedback.classList.remove('hidden');
        feedback.classList.remove('bg-emerald-500/10', 'border-emerald-400/60', 'text-emerald-200', 'bg-rose-500/10', 'border-rose-400/60', 'text-rose-200');
        if (type === 'success') {
          feedback.classList.add('bg-emerald-500/10', 'border-emerald-400/60', 'text-emerald-200');
        } else {
          feedback.classList.add('bg-rose-500/10', 'border-rose-400/60', 'text-rose-200');
        }
        clearTimeout(showFeedback._timer);
        showFeedback._timer = setTimeout(() => feedback.classList.add('hidden'), 4000);
      }

      function syncOrderLabels(container) {
        const items = container.querySelectorAll('[data-task-item]');
        items.forEach((item, index) => {
          const label = item.querySelector('[data-order-label]');
          if (label) {
            label.textContent = `Order ${index + 1}`;
          }
        });
      }

      async function persistOrder(container) {
        if (!container) return;
        const url = container.dataset.reorderUrl;
        if (!url) return;
        const orderedIds = Array.from(container.querySelectorAll('[data-task-item]')).map((item) => Number(item.dataset.taskId));
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ ordered_ids: orderedIds })
          });
          if (!response.ok) {
            const data = await response.json().catch(() => ({ message: 'Unable to save order.' }));
            showFeedback(data.message || 'Unable to save order.', 'error');
            return;
          }
          showFeedback('Task order saved.', 'success');
        } catch (error) {
          console.error(error);
          showFeedback('Network error while saving order.', 'error');
        }
      }

      window.addEventListener('beforeunload', (event) => {
        if (hasUnsavedChanges()) {
          event.preventDefault();
          event.returnValue = '';
        }
      });

      document.querySelectorAll('a[href]').forEach((link) => {
        if (link.dataset.skipWarning === 'true') return;
        link.addEventListener('click', (event) => {
          if (!hasUnsavedChanges()) return;
          if (!confirm('You have unsaved changes. Leave without saving?')) {
            event.preventDefault();
          }
        });
      });

      if (openModalButton && modal) {
        const openModal = () => {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          document.body.classList.add('overflow-hidden');
        };
        const closeModal = () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.classList.remove('overflow-hidden');
        };
        openModalButton.addEventListener('click', openModal);
        closeModalButtons.forEach((button) => {
          button.addEventListener('click', closeModal);
        });
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });
      }

      if (metaForm) {
        const nameInput = metaForm.querySelector('input[name="template_name"]');
        const descriptionInput = metaForm.querySelector('textarea[name="template_description"]');
        const originalValues = {
          name: (metaForm.dataset.originalName || '').trim(),
          description: (metaForm.dataset.originalDescription || '').trim()
        };

        function evaluateMetaDirty() {
          const currentName = nameInput ? nameInput.value.trim() : '';
          const currentDescription = descriptionInput ? descriptionInput.value.trim() : '';
          metaDirty = currentName !== originalValues.name || currentDescription !== originalValues.description;
        }

        if (nameInput) {
          nameInput.addEventListener('input', evaluateMetaDirty);
        }
        if (descriptionInput) {
          descriptionInput.addEventListener('input', evaluateMetaDirty);
        }
        evaluateMetaDirty();

        metaForm.addEventListener('submit', () => {
          metaDirty = false;
          if (nameInput) {
            originalValues.name = nameInput.value.trim();
          }
          if (descriptionInput) {
            originalValues.description = descriptionInput.value.trim();
          }
        });

        const metaReset = document.getElementById('template-meta-cancel');
        if (metaReset) {
          metaReset.addEventListener('click', () => {
            if (nameInput) nameInput.value = originalValues.name;
            if (descriptionInput) descriptionInput.value = originalValues.description;
            metaDirty = false;
          });
        }
      }

      if (list) {
        list.addEventListener('dragstart', (event) => {
          const item = event.target.closest('[data-task-item]');
          if (!item) return;
          draggingItem = item;
          item.classList.add('task-dragging');
          item.classList.add('opacity-90');
          event.dataTransfer.effectAllowed = 'move';
        });

        list.addEventListener('dragend', () => {
          if (draggingItem) {
            draggingItem.classList.remove('task-dragging', 'opacity-90');
            draggingItem = null;
          }
          list.querySelectorAll('.task-drop-target').forEach((el) => el.classList.remove('task-drop-target'));
        });

        list.addEventListener('dragover', (event) => {
          if (!draggingItem) return;
          event.preventDefault();
          const target = event.target.closest('[data-task-item]');
          if (!target || target === draggingItem) {
            list.querySelectorAll('.task-drop-target').forEach((el) => el.classList.remove('task-drop-target'));
            return;
          }
          list.querySelectorAll('.task-drop-target').forEach((el) => el.classList.remove('task-drop-target'));
          target.classList.add('task-drop-target');
          const rect = target.getBoundingClientRect();
          const offset = event.clientY - rect.top;
          if (offset > rect.height / 2) {
            target.after(draggingItem);
          } else {
            target.before(draggingItem);
          }
          syncOrderLabels(list);
        });

        list.addEventListener('drop', (event) => {
          if (!draggingItem) return;
          event.preventDefault();
          draggingItem.classList.remove('task-dragging', 'opacity-90');
          draggingItem = null;
          list.querySelectorAll('.task-drop-target').forEach((el) => el.classList.remove('task-drop-target'));
          syncOrderLabels(list);
          persistOrder(list);
        });

        list.addEventListener('click', (event) => {
          const toggleButton = event.target.closest('[data-toggle-details]');
          if (!toggleButton) return;
          const targetId = toggleButton.getAttribute('data-toggle-details');
          if (!targetId) return;
          const target = document.getElementById(targetId);
          if (!target) return;
          const isHidden = target.classList.contains('hidden');
          if (isHidden) {
            target.classList.remove('hidden');
            toggleButton.setAttribute('aria-expanded', 'true');
          } else {
            target.classList.add('hidden');
            toggleButton.setAttribute('aria-expanded', 'false');
          }
          const chevron = toggleButton.querySelector('[data-chevron]');
          if (chevron) {
            chevron.classList.toggle('rotate-180', isHidden);
          }
        });
      }

      const form = document.getElementById('template-task-form');
      if (!form) return;

      const scheduledWrapper = document.getElementById('scheduled-start-wrapper');
      const submitButton = form.querySelector('[data-role="submit"]');
      const cancelButton = document.getElementById('cancel-task-edit');
      const formTitle = document.getElementById('task-form-title');
      const createAction = form.dataset.createAction;
      const editTemplate = form.dataset.editUrlTemplate;
      const defaultOrder = form.dataset.defaultOrder;
      const dependencySelect = form.querySelector('select[name="depends_on_ids"]');
      const moduleSelect = form.querySelector('[data-template-module]');
      const subtypeSelect = form.querySelector('[data-template-subtype]');
      const subtypeMap = {{ PROJECT_TEMPLATE_TASK_SUBTYPES|tojson }};
      let editingTaskId = null;

      function updateScheduledVisibility() {
        const selected = form.querySelector('input[name="start_mode"]:checked');
        if (!selected || !scheduledWrapper) return;
        const startDateField = form.querySelector('input[name="start_date"]');
        if (selected.value === 'scheduled') {
          scheduledWrapper.classList.remove('opacity-60', 'pointer-events-none');
        } else {
          if (startDateField) {
            startDateField.value = '';
          }
          scheduledWrapper.classList.add('opacity-60', 'pointer-events-none');
        }
      }

      form.querySelectorAll('input[name="start_mode"]').forEach((radio) => {
        radio.addEventListener('change', updateScheduledVisibility);
      });
      updateScheduledVisibility();

      function clearDependencySelection() {
        if (!dependencySelect) return;
        Array.from(dependencySelect.options).forEach((option) => {
          option.selected = false;
        });
      }

      function updateDependencyOptions(currentTaskId) {
        if (!dependencySelect) return;
        Array.from(dependencySelect.options).forEach((option) => {
          const optionId = Number(option.value);
          const isCurrent = currentTaskId && optionId === Number(currentTaskId);
          option.disabled = Boolean(isCurrent);
          if (isCurrent) {
            option.selected = false;
          }
        });
      }

      function resetForm() {
        form.reset();
        form.action = createAction;
        if (formTitle) formTitle.textContent = 'Add Task to Template';
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Add template task';
        }
        if (cancelButton) cancelButton.classList.add('hidden');
        const orderInput = form.querySelector('input[name="order_index"]');
        if (orderInput) {
          orderInput.value = defaultOrder || orderInput.getAttribute('value') || '';
        }
        if (moduleSelect) {
          const defaultOption = moduleSelect.querySelector('option');
          moduleSelect.value = defaultOption ? defaultOption.value : '';
          updateSubtypeOptions();
        }
        if (scheduledWrapper) {
          scheduledWrapper.classList.add('opacity-60', 'pointer-events-none');
        }
        if (list && editingTaskId) {
          const previouslyEditing = list.querySelector('[data-task-item].ring-emerald-400');
          if (previouslyEditing) previouslyEditing.classList.remove('ring-emerald-400', 'ring-2');
        }
        if (dependencySelect) {
          clearDependencySelection();
          updateDependencyOptions(null);
        }
        editingTaskId = null;
        taskDirty = false;
        updateScheduledVisibility();
      }

      if (cancelButton) {
        cancelButton.addEventListener('click', resetForm);
      }

      form.addEventListener('input', () => {
        taskDirty = true;
      });
      form.addEventListener('change', () => {
        taskDirty = true;
      });

      if (list) {
        list.addEventListener('click', (event) => {
          const editButton = event.target.closest('[data-edit-task]');
          if (!editButton) return;
          const payload = editButton.dataset.editTask;
          if (!payload) return;
          try {
            const data = JSON.parse(payload);
            editingTaskId = data.id;
            form.action = editTemplate.replace('{id}', data.id);
            if (formTitle) formTitle.textContent = 'Edit Task';
            if (submitButton) submitButton.textContent = 'Save changes';
            if (cancelButton) cancelButton.classList.remove('hidden');

            form.querySelector('input[name="name"]').value = data.name || '';
            form.querySelector('textarea[name="description"]').value = data.description || '';
            const orderInput = form.querySelector('input[name="order_index"]');
            if (orderInput) orderInput.value = data.order_index || '';

            if (dependencySelect) {
              updateDependencyOptions(data.id);
              const selectedDependencies = Array.isArray(data.dependency_ids) ? data.dependency_ids.map(Number) : [];
              const selectedSet = new Set(selectedDependencies);
              Array.from(dependencySelect.options).forEach((option) => {
                option.selected = selectedSet.has(Number(option.value));
              });
            }
            const assigneeSelect = form.querySelector('select[name="default_assignee_id"]');
            if (assigneeSelect) assigneeSelect.value = data.default_assignee_id ? String(data.default_assignee_id) : '';
            const formSelect = form.querySelector('select[name="form_template_id"]');
            if (formSelect) formSelect.value = data.form_template_id ? String(data.form_template_id) : '';
            if (moduleSelect) {
              moduleSelect.value = data.module || data.task_type || moduleSelect.querySelector('option')?.value || 'general';
              updateSubtypeOptions();
              if (subtypeSelect) {
                subtypeSelect.value = data.task_subtype || subtypeSelect.querySelector('option')?.value || '';
              }
            }

            const startModeInput = form.querySelector(`input[name="start_mode"][value="${data.start_mode || 'immediate'}"]`);
            if (startModeInput) startModeInput.checked = true;
            const startDateField = form.querySelector('input[name="start_date"]');
            if (startDateField) startDateField.value = data.start_date || '';
            const durationField = form.querySelector('input[name="duration_days"]');
            if (durationField) {
              durationField.value = data.duration_days !== null && data.duration_days !== undefined ? data.duration_days : '';
            }
            const milestoneField = form.querySelector('input[name="milestone"]');
            if (milestoneField) milestoneField.value = data.milestone || '';

            updateScheduledVisibility();
            taskDirty = false;

            if (list) {
              list.querySelectorAll('[data-task-item]').forEach((item) => {
                item.classList.remove('ring-emerald-400', 'ring-2');
              });
              const active = list.querySelector(`[data-task-item][data-task-id="${data.id}"]`);
              if (active) {
                active.classList.add('ring-emerald-400', 'ring-2');
              }
            }
          } catch (error) {
            console.error(error);
          }
        });
      }

      form.addEventListener('submit', () => {
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = form.action === createAction ? 'Adding…' : 'Saving…';
        }
        taskDirty = false;
      });

      function updateSubtypeOptions() {
        if (!subtypeSelect || !moduleSelect) return;
        const moduleValue = moduleSelect.value || 'general';
        const options = subtypeMap[moduleValue] || subtypeMap.general || [];
        subtypeSelect.innerHTML = '';
        options.forEach(([value, label]) => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = label;
          subtypeSelect.appendChild(option);
        });
      }

      if (moduleSelect) {
        moduleSelect.addEventListener('change', () => {
          updateSubtypeOptions();
          taskDirty = true;
        });
        updateSubtypeOptions();
      }
    })();
  </script>
{% endblock %}
