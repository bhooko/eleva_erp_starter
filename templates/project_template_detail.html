{% extends "base.html" %}
{% block title %}Eleva ERP – Template {{ template.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
    <div class="flex flex-wrap items-start gap-4 justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-100">{{ template.name }}</h2>
        {% if template.description %}
          <p class="text-sm text-slate-400 mt-1">{{ template.description }}</p>
        {% else %}
          <p class="text-sm text-slate-500 mt-1">No description yet. Add one by editing this template in the database.</p>
        {% endif %}
        <p class="text-xs text-slate-500 mt-2">Created {{ template.created_at.strftime('%Y-%m-%d %H:%M') }}{% if template.creator %} by {{ template.creator.display_name }}{% endif %}</p>
      </div>
      <div class="text-right text-xs text-slate-400">
        <div>Default task form: <span class="text-emerald-300">{{ DEFAULT_TASK_FORM_NAME }}</span></div>
        <div class="mt-1">Assign this template from a project detail page.</div>
      </div>
    </div>
  </div>

  <div class="grid xl:grid-cols-[3fr_2fr] gap-6">
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base font-semibold text-slate-100">Task Blueprint</h3>
        <span class="text-xs text-slate-400 uppercase tracking-wide">{{ tasks|length }} task{{ '' if tasks|length == 1 else 's' }}</span>
      </div>
      <div id="task-reorder-feedback" class="hidden mb-3 text-xs rounded-xl border px-3 py-2"></div>
      {% if tasks %}
        <div id="task-blueprint-list"
             class="space-y-3"
             data-reorder-url="{{ url_for('project_template_task_reorder', template_id=template.id) }}">
          {% for task in tasks %}
            {% set task_payload = {
              'id': task.id,
              'name': task.name,
              'description': task.description or '',
              'order_index': task.order_index,
              'depends_on_id': task.depends_on_id,
              'default_assignee_id': task.default_assignee_id,
              'form_template_id': task.form_template_id,
              'start_mode': task.start_mode or 'immediate',
              'start_date': task.planned_start_date.isoformat() if task.planned_start_date else '',
              'duration_days': task.duration_days,
              'milestone': task.milestone or ''
            } %}
            <div class="rounded-2xl border border-slate-800/60 bg-slate-950/40 p-4 transition-transform duration-150"
                 draggable="true"
                 data-task-item
                 data-task-id="{{ task.id }}">
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-start gap-3">
                  <button type="button" class="mt-1 cursor-move text-slate-500 hover:text-slate-300" title="Drag to reorder">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7 10h2V8H7v2zm0 6h2v-2H7v2zm4-6h2V8h-2v2zm0 6h2v-2h-2v2zm4-6h2V8h-2v2zm0 6h2v-2h-2v2z" />
                    </svg>
                  </button>
                  <div>
                    <div class="text-sm font-semibold text-slate-100">{{ task.name }}</div>
                    {% if task.description %}
                      <p class="text-xs text-slate-400 mt-1">{{ task.description }}</p>
                    {% endif %}
                    <div class="mt-2 grid gap-1 text-[11px] text-slate-400">
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60">{{ task.form_template.name if task.form_template else DEFAULT_TASK_FORM_NAME }}</span>
                        {% if task.default_assignee %}
                          <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60">Default: {{ task.default_assignee.display_name }}</span>
                        {% else %}
                          <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60">Unassigned by default</span>
                        {% endif %}
                        {% if task.milestone %}
                          <span class="px-2 py-0.5 rounded-lg bg-indigo-500/20 border border-indigo-500/40 text-indigo-200">Milestone: {{ task.milestone }}</span>
                        {% endif %}
                      </div>
                      <div class="flex flex-wrap items-center gap-2">
                        {% if task.depends_on %}
                          <span class="px-2 py-0.5 rounded-lg bg-amber-500/20 border border-amber-500/50 text-amber-200">Depends on {{ task.depends_on.name }}</span>
                        {% else %}
                          <span class="px-2 py-0.5 rounded-lg bg-emerald-500/10 border border-emerald-400/40 text-emerald-200">Independent</span>
                        {% endif %}
                        {% if task.start_mode == 'scheduled' or task.planned_start_date %}
                          <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60 text-slate-200">Starts {{ task.planned_start_date.strftime('%Y-%m-%d') if task.planned_start_date else 'when scheduled' }}</span>
                        {% else %}
                          <span class="px-2 py-0.5 rounded-lg bg-emerald-500/10 border border-emerald-400/40 text-emerald-200">Starts immediately</span>
                        {% endif %}
                        {% if task.duration_days is not none %}
                          <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60 text-slate-200">Duration: {{ task.duration_days }} day{{ '' if task.duration_days == 1 else 's' }}</span>
                        {% endif %}
                        {% if task.planned_due_date %}
                          <span class="px-2 py-0.5 rounded-lg bg-slate-800/60 border border-slate-700/60 text-slate-200">Due {{ task.planned_due_date.strftime('%Y-%m-%d') }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <span data-order-label class="px-3 py-1 rounded-xl bg-slate-800 text-xs text-slate-300 uppercase tracking-wide">Order {{ task.order_index }}</span>
                  <button type="button"
                          class="inline-flex items-center gap-1 px-3 py-1.5 rounded-xl border border-slate-700/60 bg-slate-800/60 text-[11px] uppercase tracking-wide text-slate-200 hover:bg-slate-700/60"
                          data-edit-task='{{ task_payload|tojson }}'>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M4 17.17V21h3.83L18.74 10.09l-3.83-3.83L4 17.17zm15.71-8.29c.39-.39.39-1.02 0-1.41l-2.59-2.59a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.83 3.83 2-2z" />
                    </svg>
                    Edit
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-slate-400">No tasks yet. Add the first blueprint task using the form on the right.</p>
      {% endif %}
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-inner shadow-black/20">
      <h3 id="task-form-title" class="text-base font-semibold text-slate-100 mb-4">Add Task to Template</h3>
      <form id="template-task-form"
            method="post"
            class="space-y-4"
            action="{{ url_for('project_template_detail', template_id=template.id) }}"
            data-create-action="{{ url_for('project_template_detail', template_id=template.id) }}"
            data-edit-url-template="{{ url_for('project_template_task_edit', template_id=template.id, task_id=0).replace('/0/edit', '/{id}/edit') }}"
            data-default-order="{{ tasks|length + 1 }}">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Task name</label>
          <input name="name" required class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. Kick-off meeting" />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Description</label>
          <textarea name="description" rows="3" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="Optional context or acceptance criteria"></textarea>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Order</label>
            <input type="number" name="order_index" value="{{ tasks|length + 1 }}" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Depends on</label>
            <select name="depends_on_id" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
              <option value="">Independent</option>
              {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div>
          <span class="block text-xs uppercase tracking-wide text-slate-400 mb-2">Start behaviour</span>
          <div class="flex flex-wrap gap-3 text-xs">
            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 cursor-pointer">
              <input type="radio" name="start_mode" value="immediate" class="accent-emerald-500" checked>
              <span>Starts immediately</span>
            </label>
            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-slate-800/60 border border-slate-700/60 cursor-pointer">
              <input type="radio" name="start_mode" value="scheduled" class="accent-emerald-500">
              <span>Scheduled start</span>
            </label>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div id="scheduled-start-wrapper" class="opacity-60 pointer-events-none transition">
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Start date</label>
            <input type="date" name="start_date" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Duration (days)</label>
            <input type="number" name="duration_days" min="0" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. 3" />
          </div>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Milestone</label>
          <input name="milestone" list="milestone-options" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none" placeholder="e.g. Production Milestone" />
          <datalist id="milestone-options">
            {% for option in TASK_MILESTONES %}
              <option value="{{ option }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Default assignee</label>
          <select name="default_assignee_id" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            <option value="">Unassigned</option>
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-400 mb-1">Form template</label>
          <select name="form_template_id" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:border-emerald-400 focus:outline-none">
            <option value="">Use {{ DEFAULT_TASK_FORM_NAME }}</option>
            {% for form in forms %}
              <option value="{{ form.id }}">{{ form.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center gap-3">
          <button data-role="submit" class="flex-1 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-sm text-white">Add template task</button>
          <button type="button" id="cancel-task-edit" class="hidden px-4 py-2 rounded-xl bg-slate-800/60 border border-slate-700/60 text-sm text-slate-200 hover:bg-slate-700/60">Cancel edit</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const list = document.getElementById('task-blueprint-list');
      const feedback = document.getElementById('task-reorder-feedback');
      let draggingItem = null;

      function showFeedback(message, type) {
        if (!feedback) return;
        feedback.textContent = message;
        feedback.classList.remove('hidden');
        feedback.classList.remove('bg-emerald-500/10', 'border-emerald-400/60', 'text-emerald-200', 'bg-rose-500/10', 'border-rose-400/60', 'text-rose-200');
        if (type === 'success') {
          feedback.classList.add('bg-emerald-500/10', 'border-emerald-400/60', 'text-emerald-200');
        } else {
          feedback.classList.add('bg-rose-500/10', 'border-rose-400/60', 'text-rose-200');
        }
        clearTimeout(showFeedback._timer);
        showFeedback._timer = setTimeout(() => feedback.classList.add('hidden'), 4000);
      }

      function syncOrderLabels(container) {
        const items = container.querySelectorAll('[data-task-item]');
        items.forEach((item, index) => {
          const label = item.querySelector('[data-order-label]');
          if (label) {
            label.textContent = `Order ${index + 1}`;
          }
        });
      }

      async function persistOrder(container) {
        if (!container) return;
        const url = container.dataset.reorderUrl;
        if (!url) return;
        const orderedIds = Array.from(container.querySelectorAll('[data-task-item]')).map((item) => Number(item.dataset.taskId));
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ordered_ids: orderedIds })
          });
          if (!response.ok) {
            const data = await response.json().catch(() => ({ message: 'Unable to save order.' }));
            showFeedback(data.message || 'Unable to save order.', 'error');
            return;
          }
          showFeedback('Task order saved.', 'success');
        } catch (error) {
          console.error(error);
          showFeedback('Network error while saving order.', 'error');
        }
      }

      if (list) {
        list.addEventListener('dragstart', (event) => {
          const item = event.target.closest('[data-task-item]');
          if (!item) return;
          draggingItem = item;
          item.classList.add('opacity-70');
          event.dataTransfer.effectAllowed = 'move';
        });

        list.addEventListener('dragend', () => {
          if (draggingItem) {
            draggingItem.classList.remove('opacity-70');
            draggingItem = null;
          }
        });

        list.addEventListener('dragover', (event) => {
          if (!draggingItem) return;
          event.preventDefault();
          const afterElement = event.target.closest('[data-task-item]');
          if (!afterElement || afterElement === draggingItem) {
            return;
          }
          const rect = afterElement.getBoundingClientRect();
          const offset = event.clientY - rect.top;
          if (offset > rect.height / 2) {
            afterElement.after(draggingItem);
          } else {
            afterElement.before(draggingItem);
          }
          syncOrderLabels(list);
        });

        list.addEventListener('drop', (event) => {
          if (!draggingItem) return;
          event.preventDefault();
          draggingItem.classList.remove('opacity-70');
          draggingItem = null;
          syncOrderLabels(list);
          persistOrder(list);
        });
      }

      const form = document.getElementById('template-task-form');
      if (!form) return;

      const scheduledWrapper = document.getElementById('scheduled-start-wrapper');
      const submitButton = form.querySelector('[data-role="submit"]');
      const cancelButton = document.getElementById('cancel-task-edit');
      const formTitle = document.getElementById('task-form-title');
      const createAction = form.dataset.createAction;
      const editTemplate = form.dataset.editUrlTemplate;
      const defaultOrder = form.dataset.defaultOrder;
      let editingTaskId = null;

      function updateScheduledVisibility() {
        const selected = form.querySelector('input[name="start_mode"]:checked');
        if (!selected || !scheduledWrapper) return;
        if (selected.value === 'scheduled') {
          scheduledWrapper.classList.remove('opacity-60');
          scheduledWrapper.classList.remove('pointer-events-none');
        } else {
          const startDateField = form.querySelector('input[name="start_date"]');
          if (startDateField) {
            startDateField.value = '';
          }
          scheduledWrapper.classList.add('opacity-60');
          scheduledWrapper.classList.add('pointer-events-none');
        }
      }

      form.querySelectorAll('input[name="start_mode"]').forEach((radio) => {
        radio.addEventListener('change', updateScheduledVisibility);
      });
      updateScheduledVisibility();

      function resetForm() {
        form.reset();
        form.action = createAction;
        if (formTitle) formTitle.textContent = 'Add Task to Template';
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Add template task';
        }
        if (cancelButton) cancelButton.classList.add('hidden');
        const orderInput = form.querySelector('input[name="order_index"]');
        if (orderInput) {
          orderInput.value = defaultOrder || orderInput.getAttribute('value') || '';
        }
        if (scheduledWrapper) {
          scheduledWrapper.classList.add('opacity-60');
          scheduledWrapper.classList.add('pointer-events-none');
        }
        if (list && editingTaskId) {
          const previouslyEditing = list.querySelector('[data-task-item].ring-emerald-400');
          if (previouslyEditing) previouslyEditing.classList.remove('ring-emerald-400', 'ring-2');
        }
        editingTaskId = null;
        updateScheduledVisibility();
      }

      if (cancelButton) {
        cancelButton.addEventListener('click', resetForm);
      }

      if (list) {
        list.addEventListener('click', (event) => {
          const editButton = event.target.closest('[data-edit-task]');
          if (!editButton) return;
          const payload = editButton.dataset.editTask;
          if (!payload) return;
          try {
            const data = JSON.parse(payload);
            editingTaskId = data.id;
            form.action = editTemplate.replace('{id}', data.id);
            if (formTitle) formTitle.textContent = 'Edit Task';
            if (submitButton) submitButton.textContent = 'Save changes';
            if (cancelButton) cancelButton.classList.remove('hidden');

            form.querySelector('input[name="name"]').value = data.name || '';
            form.querySelector('textarea[name="description"]').value = data.description || '';
            const orderInput = form.querySelector('input[name="order_index"]');
            if (orderInput) orderInput.value = data.order_index || '';

            const dependsSelect = form.querySelector('select[name="depends_on_id"]');
            if (dependsSelect) dependsSelect.value = data.depends_on_id ? String(data.depends_on_id) : '';
            const assigneeSelect = form.querySelector('select[name="default_assignee_id"]');
            if (assigneeSelect) assigneeSelect.value = data.default_assignee_id ? String(data.default_assignee_id) : '';
            const formSelect = form.querySelector('select[name="form_template_id"]');
            if (formSelect) formSelect.value = data.form_template_id ? String(data.form_template_id) : '';

            const startModeInput = form.querySelector(`input[name="start_mode"][value="${data.start_mode || 'immediate'}"]`);
            if (startModeInput) startModeInput.checked = true;
            const startDateField = form.querySelector('input[name="start_date"]');
            if (startDateField) startDateField.value = data.start_date || '';
            const durationField = form.querySelector('input[name="duration_days"]');
            if (durationField) {
              durationField.value = data.duration_days !== null && data.duration_days !== undefined ? data.duration_days : '';
            }
            const milestoneField = form.querySelector('input[name="milestone"]');
            if (milestoneField) milestoneField.value = data.milestone || '';

            updateScheduledVisibility();

            if (list) {
              list.querySelectorAll('[data-task-item]').forEach((item) => {
                item.classList.remove('ring-emerald-400', 'ring-2');
              });
              const active = list.querySelector(`[data-task-item][data-task-id="${data.id}"]`);
              if (active) {
                active.classList.add('ring-emerald-400', 'ring-2');
              }
            }
          } catch (error) {
            console.error(error);
          }
        });
      }

      form.addEventListener('submit', () => {
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = form.action === createAction ? 'Adding…' : 'Saving…';
        }
      });
    })();
  </script>
{% endblock %}
