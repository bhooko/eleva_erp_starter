<div class="space-y-10">
  <div class="flex justify-end">
    <button type="button"
            class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 text-sm font-semibold"
            data-add-user-toggle
            data-label-open="Close"
            data-label-closed="+ Add user"
            aria-controls="create-user-section"
            aria-expanded="false">
      + Add user
    </button>
  </div>
  <section id="create-user-section"
           class="hidden rounded-2xl bg-slate-900/60 border border-slate-800 shadow-inner shadow-black/20 p-6 space-y-6">
    <header class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h2 class="text-xl font-semibold text-slate-100">Create User</h2>
        <p class="text-sm text-slate-400">Provision a new account and optionally assign a department, position, and role.</p>
      </div>
      <button type="button"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-200 hover:bg-slate-800/80"
              data-add-user-toggle
              data-label-open="Close"
              data-label-closed="Close"
              aria-controls="create-user-section"
              aria-expanded="false">
        Close
      </button>
    </header>
    <form method="post" action="{{ url_for('admin_users_create') }}" class="grid gap-4 md:grid-cols-2">
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-username">Username</label>
        <input id="create-username" name="username" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" placeholder="jane.doe" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-password">Password</label>
        <input id="create-password" name="password" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" placeholder="Temporary password" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-first-name">First name</label>
        <input id="create-first-name" name="first_name" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-last-name">Last name</label>
        <input id="create-last-name" name="last_name" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-email">Email</label>
        <input id="create-email" name="email" type="email" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-mobile">Mobile number</label>
        <input id="create-mobile" name="mobile_number" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-role">Role</label>
        <input id="create-role" name="role" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" placeholder="Admin / Supervisor / ..." />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300" for="create-department">Department</label>
        <select id="create-department" name="department_id" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
          <option value="">No department</option>
          {% for dept in department_options %}
            <option value="{{ dept.id }}">{{ dept.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="space-y-1 md:col-span-2">
        <label class="text-sm text-slate-300" for="create-position">Position</label>
        <select id="create-position" name="position_id" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
          <option value="">No position</option>
          {% for pos in position_options %}
            <option value="{{ pos.id }}">{{ pos.display_label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-2 flex items-center justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-slate-200">
          <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" checked />
          Active immediately
        </label>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 text-sm font-semibold">Create user</button>
      </div>
    </form>
  </section>


  <section class="elev-card fade-in p-6 space-y-6" id="users">
    <header class="section-header flex flex-wrap items-center justify-between gap-3 -mx-6 -mt-6 px-6 py-4 rounded-t-[20px]">
      <div>
        <h2 class="text-xl font-semibold text-slate-100">Existing Users</h2>
        <p class="text-sm text-slate-400">Update profile information, reset credentials, or deactivate accounts.</p>
      </div>
      <span class="text-xs text-slate-500 uppercase tracking-wide">{{ users|length }} users</span>
    </header>
    {% if users %}
      <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/30">
        <table class="table-enhanced min-w-full divide-y divide-slate-800 text-sm">
          <thead class="bg-slate-900/70 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Name</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Username</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Role</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Department</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Position</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Status</th>
              <th scope="col" class="px-4 py-3 text-right font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800 bg-slate-950/40">
            {% for user in users %}
              <tr class="transition-colors">
                <td class="px-4 py-3 font-medium text-slate-100">
                  {{ user.display_name or user.username }}
                  <div class="text-xs text-slate-400">
                    {{ user.email or 'No email provided' }}
                  </div>
                </td>
                <td class="px-4 py-3 text-slate-200">{{ user.username }}</td>
                <td class="px-4 py-3 text-slate-300">{{ user.role or 'â€”' }}</td>
                <td class="px-4 py-3 text-slate-300">
                  {% if user.position and user.position.department %}
                    {{ user.position.department.full_name }}
                  {% elif user.department %}
                    {{ user.department }}
                  {% else %}
                    <span class="text-slate-500">No department assigned</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-slate-300">
                  {% if user.position %}
                    {{ user.position.display_label }}
                  {% else %}
                    <span class="text-slate-500">No position</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center rounded-lg border px-2 py-1 text-xs {{ 'border-emerald-400/40 bg-emerald-500/20 text-emerald-200' if user.is_active else 'border-rose-400/40 bg-rose-500/20 text-rose-100' }}">{{ 'Active' if user.is_active else 'Inactive' }}</span>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="flex justify-end gap-2">
                    <button type="button"
                            class="inline-flex items-center rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800"
                            data-modal-target="user-modal-{{ user.id }}">
                      View
                    </button>
                    <button type="submit"
                            form="user-reset-{{ user.id }}"
                            class="inline-flex items-center rounded-lg border border-amber-400/50 bg-amber-500/10 px-3 py-1.5 text-xs font-semibold text-amber-200 hover:bg-amber-500/20">
                      Sign out
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-300">No users found.</div>
    {% endif %}
  </section>

    {% for user in users %}
      <form id="user-reset-{{ user.id }}" method="post" action="{{ url_for('admin_users_update', user_id=user.id) }}"><input type="hidden" name="action" value="reset_sessions" /></form>
    {% endfor %}

    {% for user in users %}
      <div id="user-modal-{{ user.id }}" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-slate-950/70 px-4 py-6 backdrop-blur-sm md:px-0" data-modal aria-hidden="true">
        <div class="mx-auto w-full max-w-3xl overflow-hidden rounded-2xl border border-slate-700 bg-slate-900/95 shadow-2xl shadow-black/40">
          <div class="flex items-center justify-between border-b border-slate-800 px-6 py-4">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">{{ user.display_name or user.username }}</h3>
              <p class="text-xs text-slate-400">Username: {{ user.username }}</p>
            </div>
            <button type="button"
                    class="rounded-full border border-slate-700 bg-slate-800/60 px-2 py-1 text-lg leading-none text-slate-300 hover:bg-slate-700"
                    data-modal-close
                    aria-label="Close user details">&times;</button>
          </div>
          <div class="px-6 py-5 space-y-5">
            <form id="user-{{ user.id }}" method="post" action="{{ url_for('admin_users_update', user_id=user.id) }}" class="space-y-4">
              <div class="grid gap-3 md:grid-cols-2">
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Username</label>
                  <input name="username" type="text" value="{{ user.username }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" data-modal-autofocus />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">New password</label>
                  <input name="password" type="text" placeholder="Leave blank to keep current" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">First name</label>
                  <input name="first_name" type="text" value="{{ user.first_name or '' }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Last name</label>
                  <input name="last_name" type="text" value="{{ user.last_name or '' }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Email</label>
                  <input name="email" type="email" value="{{ user.email or '' }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Mobile number</label>
                  <input name="mobile_number" type="text" value="{{ user.mobile_number or '' }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Role</label>
                  <input name="role" type="text" value="{{ user.role or '' }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-slate-400">Department</label>
                  <select name="department_id" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                    <option value="">No department</option>
                    {% for dept in department_options %}
                      <option value="{{ dept.id }}" {% if dept.id == (user.position.department.id if user.position and user.position.department else None) or dept.name == user.department %}selected{% endif %}>{{ dept.full_name }}</option>
                    {% endfor %}
                  </select>
                </div>
              <div class="md:col-span-2 space-y-1">
                <label class="text-xs text-slate-400">Position</label>
                <select name="position_id" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                  <option value="">No position</option>
                  {% for pos in position_options %}
                    <option value="{{ pos.id }}" {% if user.position_id == pos.id %}selected{% endif %}>{{ pos.display_label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-4">
              <div>
                <h4 class="text-sm font-semibold text-slate-100">Module permissions</h4>
                <p class="text-xs text-slate-400">Choose where {{ user.display_name or user.username }} appears in the app and which areas they can be assigned work in.</p>
              </div>
              <div class="space-y-4">
                {% for module in workspace_modules %}
                  {% set module_perm = user.get_module_permission_settings(module.key) %}
                  <div class="flex flex-col gap-3 rounded-xl border border-slate-800/60 bg-slate-900/70 p-4 md:flex-row md:items-center md:justify-between">
                    <div>
                      <div class="text-sm font-semibold text-slate-100">{{ module.label }}</div>
                      <p class="text-xs text-slate-400">{{ module.description }}</p>
                    </div>
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                      <label class="inline-flex items-center gap-2 text-xs text-slate-300">
                        <input type="checkbox"
                               id="user-{{ user.id }}-module-{{ module.key }}-visibility"
                               name="module_{{ module.key }}_visibility"
                               value="1"
                               class="rounded border-slate-700 bg-slate-900"
                               {% if module_perm.visibility %}checked{% endif %}>
                        <span>{{ module.visibility_label }}</span>
                      </label>
                      <label class="inline-flex items-center gap-2 text-xs text-slate-300">
                        <input type="checkbox"
                               id="user-{{ user.id }}-module-{{ module.key }}-assignment"
                               name="module_{{ module.key }}_assignment"
                               value="1"
                               class="rounded border-slate-700 bg-slate-900"
                               {% if module_perm.assignment %}checked{% endif %}>
                        <span>{{ module.assignment_label }}</span>
                      </label>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <p class="text-[11px] text-slate-500">Admins always retain full visibility and assignment access across modules.</p>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-3">
              <label class="inline-flex items-center gap-2 text-sm text-slate-200">
                <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" {% if user.is_active %}checked{% endif %} />
                Active
              </label>
                <div class="flex flex-wrap gap-2">
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-3 py-2 text-sm font-semibold">Save changes</button>
                </div>
              </div>
            </form>
            <form method="post" action="{{ url_for('admin_users_update', user_id=user.id) }}" class="flex justify-end">
              <input type="hidden" name="action" value="reset_sessions" />
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-800/80">Sign out all devices</button>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  <section class="elev-card fade-in p-6 space-y-6" id="departments">
    <header class="section-header flex flex-wrap items-start justify-between gap-3 -mx-6 -mt-6 px-6 py-4 rounded-t-[20px]">
      <div>
        <h2 class="text-xl font-semibold text-slate-100">Departments</h2>
        <p class="text-sm text-slate-400">Outline the structure of your organisation and nest departments as needed.</p>
      </div>
      <button type="button"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-800"
              data-section-toggle
              data-section-target="departments-content"
              data-label-expanded="Collapse"
              data-label-collapsed="Expand"
              aria-controls="departments-content"
              aria-expanded="true">
        Collapse
      </button>
    </header>
    <div id="departments-content" class="space-y-6" data-section-content>
    <form method="post" action="{{ url_for('admin_departments_create') }}" class="grid gap-4 md:grid-cols-2">
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Name</label>
        <input name="name" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" placeholder="Manufacturing" />
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Branch</label>
        <select name="branch" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
          {% for branch in department_branches %}
            <option value="{{ branch }}">{{ branch }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Parent department</label>
        <select name="parent_id" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
          <option value="">Top level</option>
          {% for dept in department_options %}
            <option value="{{ dept.id }}">{{ dept.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-2 space-y-1">
        <label class="text-sm text-slate-300">Description</label>
        <textarea name="description" rows="2" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2"></textarea>
      </div>
      <div class="md:col-span-2 flex items-center justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-slate-200">
          <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" checked />
          Active
        </label>
        <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 text-sm font-semibold">Add department</button>
      </div>
    </form>
    <div class="space-y-4">
      {% if departments %}
        <div class="overflow-x-auto rounded-2xl border border-slate-800">
          <table class="min-w-full divide-y divide-slate-800 text-sm">
            <thead class="bg-slate-900/70 text-xs uppercase tracking-wide text-slate-400">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Name</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Branch</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Parent</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Status</th>
                <th scope="col" class="px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800 bg-slate-950/40">
              {% for dept in departments %}
                <tr class="transition hover:bg-slate-900/40">
                  <td class="px-4 py-3 font-medium text-slate-100">{{ dept.name }}</td>
                  <td class="px-4 py-3 text-slate-200">{{ dept.branch }}</td>
                  <td class="px-4 py-3 text-slate-300">
                    {% if dept.parent %}
                      {{ dept.parent.full_name }}
                    {% else %}
                      <span class="text-slate-500">Top level</span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3">
                    <span class="inline-flex items-center rounded-lg border px-2 py-1 text-xs {{ 'border-emerald-400/40 bg-emerald-500/20 text-emerald-200' if dept.active else 'border-rose-400/40 bg-rose-500/20 text-rose-100' }}">{{ 'Active' if dept.active else 'Inactive' }}</span>
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800" data-panel-target="department-panel-{{ dept.id }}" aria-controls="department-panel-{{ dept.id }}" aria-expanded="false">View</button>
                      <button type="submit" form="delete-department-{{ dept.id }}" class="inline-flex items-center rounded-lg border border-rose-500/60 bg-rose-500/10 px-3 py-1.5 text-xs font-semibold text-rose-200 hover:bg-rose-500/20">Delete</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-300">No departments defined yet.</div>
      {% endif %}
    </div>

    {% for dept in departments %}
      <form id="delete-department-{{ dept.id }}" method="post" action="{{ url_for('admin_departments_delete', department_id=dept.id) }}" data-confirm="Are you sure you want to delete the '{{ dept.name }}' department?"></form>
    {% endfor %}

    {% for dept in departments %}
      <div id="department-panel-{{ dept.id }}" class="hidden rounded-2xl border border-slate-800 bg-slate-950/60 p-6 shadow-inner shadow-black/10" data-panel data-panel-group="departments">
        <div class="flex flex-wrap items-start justify-between gap-3 border-b border-slate-800 pb-4">
          <div>
            <h3 class="text-lg font-semibold text-slate-100">{{ dept.full_name }}</h3>
            <p class="text-xs text-slate-400">Branch: {{ dept.branch }}</p>
          </div>
          <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800" data-panel-close="department-panel-{{ dept.id }}">Close</button>
        </div>
        <div class="mt-4 space-y-4 text-sm text-slate-200">
          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <h4 class="text-xs uppercase tracking-wide text-slate-400">Parent</h4>
              <p>{{ dept.parent.full_name if dept.parent else 'Top level' }}</p>
            </div>
            <div>
              <h4 class="text-xs uppercase tracking-wide text-slate-400">Status</h4>
              <p>{{ 'Active' if dept.active else 'Inactive' }}</p>
            </div>
            {% if dept.description %}
              <div class="md:col-span-2">
                <h4 class="text-xs uppercase tracking-wide text-slate-400">Description</h4>
                <p>{{ dept.description }}</p>
              </div>
            {% endif %}
          </div>
          <form id="department-{{ dept.id }}" method="post" action="{{ url_for('admin_departments_update', department_id=dept.id) }}" class="space-y-4">
            <div class="grid gap-3 md:grid-cols-2">
              <div class="space-y-1">
                <label class="text-xs text-slate-400">Name</label>
                <input name="name" type="text" value="{{ dept.name }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" data-panel-autofocus />
              </div>
              <div class="space-y-1">
                <label class="text-xs text-slate-400">Branch</label>
                <select name="branch" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                  {% for branch in department_branches %}
                    <option value="{{ branch }}" {% if branch == dept.branch %}selected{% endif %}>{{ branch }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-xs text-slate-400">Parent</label>
                <select name="parent_id" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                  <option value="">Top level</option>
                  {% for option in department_options %}
                    {% if option.id != dept.id %}
                      <option value="{{ option.id }}" {% if option.id == (dept.parent.id if dept.parent else None) %}selected{% endif %}>{{ option.full_name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="md:col-span-2 space-y-1">
                <label class="text-xs text-slate-400">Description</label>
                <textarea name="description" rows="2" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">{{ dept.description or '' }}</textarea>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <label class="inline-flex items-center gap-2 text-sm text-slate-200">
                <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" {% if dept.active %}checked{% endif %} />
                Active
              </label>
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold hover:bg-emerald-500">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    {% endfor %}
    </div>
  </section>


  <section class="elev-card fade-in p-6 space-y-6" id="positions">
    <header class="section-header flex flex-wrap items-start justify-between gap-3 -mx-6 -mt-6 px-6 py-4 rounded-t-[20px]">
      <div>
        <h2 class="text-xl font-semibold text-slate-100">Positions</h2>
        <p class="text-sm text-slate-400">Define roles within departments and connect reporting lines.</p>
      </div>
      <button type="button"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-800"
              data-section-toggle
              data-section-target="positions-content"
              data-label-expanded="Collapse"
              data-label-collapsed="Expand"
              aria-controls="positions-content"
              aria-expanded="true">
        Collapse
      </button>
    </header>
    <div id="positions-content" class="space-y-6" data-section-content>
      <div class="flex justify-end">
        <button type="button"
                class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/20 transition hover:shadow-emerald-500/30 hover:bg-emerald-500"
                data-form-toggle
                data-target="positions-create-panel"
                data-open-label="+ New position"
                data-close-label="Hide form"
                data-initial-state="open"
                aria-controls="positions-create-panel"
                aria-expanded="true">
          + New position
        </button>
      </div>
      <div id="positions-create-panel" class="hidden collapsible-card space-y-4">
        <form method="post" action="{{ url_for('admin_positions_create') }}" class="grid gap-4 md:grid-cols-2">
          <div class="space-y-1">
            <label class="text-sm text-slate-300">Title</label>
            <input name="title" type="text" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2" placeholder="Installation Manager" />
          </div>
          <div class="space-y-1">
            <label class="text-sm text-slate-300">Department</label>
            <select name="department_id" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
              <option value="">No department</option>
              {% for dept in department_options %}
                <option value="{{ dept.id }}">{{ dept.full_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="md:col-span-2 space-y-1">
            <label class="text-sm text-slate-300">Reports to</label>
            <select name="reports_to_id" class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-3 py-2">
              <option value="">No direct manager</option>
              {% for pos in position_options %}
                <option value="{{ pos.id }}">{{ pos.display_label }}</option>
              {% endfor %}
            </select>
            <p class="text-xs text-slate-500">Tip: Department heads should report to the Management team.</p>
          </div>
          <div class="md:col-span-2 flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" checked />
              Active
            </label>
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 text-sm font-semibold">Add position</button>
          </div>
        </form>
      </div>
      <div class="space-y-4">
      {% if positions %}
        <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/30">
          <table class="table-enhanced min-w-full divide-y divide-slate-800 text-sm">
            <thead class="bg-slate-900/70 text-xs uppercase tracking-wide text-slate-400">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Title</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Department</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Reports to</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Status</th>
                <th scope="col" class="px-4 py-3 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800 bg-slate-950/40">
              {% for pos in positions %}
                <tr class="transition-colors">
                  <td class="px-4 py-3 font-medium text-slate-100">{{ pos.title }}</td>
                  <td class="px-4 py-3 text-slate-300">
                    {% if pos.department %}
                      {{ pos.department.full_name }}
                    {% else %}
                      <span class="text-slate-500">No department</span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3 text-slate-300">
                    {% if pos.reports_to %}
                      {{ pos.reports_to.display_label }}
                    {% else %}
                      <span class="text-slate-500">No direct manager</span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3">
                    <span class="inline-flex items-center rounded-lg border px-2 py-1 text-xs {{ 'border-emerald-400/40 bg-emerald-500/20 text-emerald-200' if pos.active else 'border-rose-400/40 bg-rose-500/20 text-rose-100' }}">{{ 'Active' if pos.active else 'Inactive' }}</span>
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800" data-panel-target="position-panel-{{ pos.id }}" aria-controls="position-panel-{{ pos.id }}" aria-expanded="false">View</button>
                      <button type="submit" form="delete-position-{{ pos.id }}" class="inline-flex items-center rounded-lg border border-rose-500/60 bg-rose-500/10 px-3 py-1.5 text-xs font-semibold text-rose-200 hover:bg-rose-500/20">Delete</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-300">No positions defined yet.</div>
      {% endif %}
      </div>

    {% for pos in positions %}
      <form id="delete-position-{{ pos.id }}" method="post" action="{{ url_for('admin_positions_delete', position_id=pos.id) }}" data-confirm="Are you sure you want to delete the '{{ pos.title }}' position?"></form>
    {% endfor %}

    {% for pos in positions %}
      <div id="position-panel-{{ pos.id }}" class="hidden rounded-2xl border border-slate-800 bg-slate-950/60 p-6 shadow-inner shadow-black/10" data-panel data-panel-group="positions">
        <div class="flex flex-wrap items-start justify-between gap-3 border-b border-slate-800 pb-4">
          <div>
            <h3 class="text-lg font-semibold text-slate-100">{{ pos.display_label }}</h3>
            {% if pos.reports_to %}
              <p class="text-xs text-slate-400">Reports to: {{ pos.reports_to.display_label }}</p>
            {% else %}
              <p class="text-xs text-slate-400">No direct manager</p>
            {% endif %}
          </div>
          <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800" data-panel-close="position-panel-{{ pos.id }}">Close</button>
        </div>
        <form id="position-{{ pos.id }}" method="post" action="{{ url_for('admin_positions_update', position_id=pos.id) }}" class="mt-4 space-y-4">
          <div class="grid gap-3 md:grid-cols-2">
            <div class="space-y-1">
              <label class="text-xs text-slate-400">Title</label>
              <input name="title" type="text" value="{{ pos.title }}" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm" data-panel-autofocus />
            </div>
            <div class="space-y-1">
              <label class="text-xs text-slate-400">Department</label>
              <select name="department_id" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                <option value="">No department</option>
                {% for dept in department_options %}
                  <option value="{{ dept.id }}" {% if pos.department_id == dept.id %}selected{% endif %}>{{ dept.full_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="md:col-span-2 space-y-1">
              <label class="text-xs text-slate-400">Reports to</label>
              <select name="reports_to_id" class="w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm">
                <option value="">No direct manager</option>
                {% for option in position_options %}
                  {% if option.id != pos.id %}
                    <option value="{{ option.id }}" {% if pos.reports_to_id == option.id %}selected{% endif %}>{{ option.display_label }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              <p class="text-xs text-slate-500">Tip: Department heads should report to the Management team.</p>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-slate-200">
              <input type="checkbox" name="active" value="1" class="rounded border-slate-700 bg-slate-900" {% if pos.active %}checked{% endif %} />
              Active
            </label>
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 px-3 py-2 text-sm font-semibold">Save position</button>
          </div>
        </form>
      </div>
    {% endfor %}
    </div>
  </section>


</div>
